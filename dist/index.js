"use strict";var fc=Object.defineProperty;var Ai=r=>{throw TypeError(r)};var vc=(r,e,t)=>e in r?fc(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var w=(r,e,t)=>vc(r,typeof e!="symbol"?e+"":e,t),la=(r,e,t)=>e.has(r)||Ai("Cannot "+t);var N=(r,e,t)=>(la(r,e,"read from private field"),t?t.call(r):e.get(r)),Le=(r,e,t)=>e.has(r)?Ai("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),qe=(r,e,t,s)=>(la(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t),Dt=(r,e,t)=>(la(r,e,"access private method"),t);const Va=require("siyuan"),_a=!1;var Xa=Array.isArray,pc=Array.prototype.indexOf,ea=Array.from,yc=Object.defineProperty,Fr=Object.getOwnPropertyDescriptor,Oo=Object.getOwnPropertyDescriptors,mc=Object.prototype,gc=Array.prototype,Za=Object.getPrototypeOf,Ci=Object.isExtensible;function bc(r){for(var e=0;e<r.length;e++)r[e]()}function No(){var r,e,t=new Promise((s,n)=>{r=s,e=n});return{promise:t,resolve:r,reject:e}}function qo(r,e){if(Array.isArray(r))return r;if(!(Symbol.iterator in r))return Array.from(r);const t=[];for(const s of r)if(t.push(s),t.length===e)break;return t}const Ct=2,Bn=4,ta=8,Ro=1<<24,Fs=16,zs=32,Tr=64,Ja=128,os=512,Nt=1024,Ft=2048,Ps=4096,Vt=8192,Os=16384,ei=32768,Wr=65536,Ii=1<<17,Lo=1<<18,Zr=1<<19,_c=1<<20,Is=1<<25,_r=32768,ka=1<<21,ti=1<<22,Zs=1<<23,Ns=Symbol("$state"),kc=Symbol("legacy props"),wc=Symbol(""),Rr=new class extends Error{constructor(){super(...arguments);w(this,"name","StaleReactionError");w(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function si(r){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Tc(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Sc(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Dc(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function xc(r){throw new Error("https://svelte.dev/e/effect_orphan")}function Ec(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Ac(r){throw new Error("https://svelte.dev/e/props_invalid_value")}function Cc(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Ic(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Mc(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Oc(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const Nc=1,qc=2,Fo=4,Rc=8,Lc=16,Fc=1,zc=4,Pc=8,Bc=16,Uc=1,jc=2,xt=Symbol(),Yc="http://www.w3.org/1999/xhtml";function Hc(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Wc(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function zo(r){return r===this.v}function Po(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function Bo(r){return!Po(r,this.v)}let Kc=!1,yt=null;function Kr(r){yt=r}function Uo(r){return Yo().get(r)}function Gc(r,e){return Yo().set(r,e),e}function nt(r,e=!1,t){yt={p:yt,i:!1,c:null,e:null,s:r,x:null,l:null}}function at(r){var e=yt,t=e.e;if(t!==null){e.e=null;for(var s of t)ll(s)}return e.i=!0,yt=e.p,{}}function jo(){return!0}function Yo(r){return yt===null&&si(),yt.c??(yt.c=new Map($c(yt)||void 0))}function $c(r){let e=r.p;for(;e!==null;){const t=e.c;if(t!==null)return t;e=e.p}return null}let lr=[];function Ho(){var r=lr;lr=[],bc(r)}function Jr(r){if(lr.length===0&&!ln){var e=lr;queueMicrotask(()=>{e===lr&&Ho()})}lr.push(r)}function Qc(){for(;lr.length>0;)Ho()}function Wo(r){var e=We;if(e===null)return Ne.f|=Zs,r;if(e.f&ei)Gr(r,e);else{if(!(e.f&Ja))throw r;e.b.error(r)}}function Gr(r,e){for(;e!==null;){if(e.f&Ja)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r}const Vc=-7169;function _t(r,e){r.f=r.f&Vc|e}function ri(r){r.f&os||r.deps===null?_t(r,Nt):_t(r,Ps)}function Ko(r){if(r!==null)for(const e of r)!(e.f&Ct)||!(e.f&_r)||(e.f^=_r,Ko(e.deps))}function Go(r,e,t){r.f&Ft?e.add(r):r.f&Ps&&t.add(r),Ko(r.deps),_t(r,Nt)}const Cn=new Set;let Oe=null,on=null,Et=null,ns=[],sa=null,wa=!1,ln=!1;var Pr,Br,dr,hr,gn,Ur,jr,ls,Ta,Sa,$o,Qo;const Xn=class Xn{constructor(){Le(this,ls);w(this,"committed",!1);w(this,"current",new Map);w(this,"previous",new Map);Le(this,Pr,new Set);Le(this,Br,new Set);Le(this,dr,0);Le(this,hr,0);Le(this,gn,null);Le(this,Ur,new Set);Le(this,jr,new Set);w(this,"skipped_effects",new Set);w(this,"is_fork",!1)}is_deferred(){return this.is_fork||N(this,hr)>0}process(e){var n;ns=[],on=null,this.apply();var t=[],s=[];for(const a of e)Dt(this,ls,Ta).call(this,a,t,s);this.is_fork||Dt(this,ls,$o).call(this),this.is_deferred()?(Dt(this,ls,Sa).call(this,s),Dt(this,ls,Sa).call(this,t)):(on=this,Oe=null,Mi(s),Mi(t),on=null,(n=N(this,gn))==null||n.resolve()),Et=null}capture(e,t){t!==xt&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Zs||(this.current.set(e,e.v),Et==null||Et.set(e,e.v))}activate(){Oe=this,this.apply()}deactivate(){Oe===this&&(Oe=null,Et=null)}flush(){if(this.activate(),ns.length>0){if(Vo(),Oe!==null&&Oe!==this)return}else N(this,dr)===0&&this.process([]);this.deactivate()}discard(){for(const e of N(this,Br))e(this);N(this,Br).clear()}increment(e){qe(this,dr,N(this,dr)+1),e&&qe(this,hr,N(this,hr)+1)}decrement(e){qe(this,dr,N(this,dr)-1),e&&qe(this,hr,N(this,hr)-1),this.revive()}revive(){for(const e of N(this,Ur))N(this,jr).delete(e),_t(e,Ft),Rs(e);for(const e of N(this,jr))_t(e,Ps),Rs(e);this.flush()}oncommit(e){N(this,Pr).add(e)}ondiscard(e){N(this,Br).add(e)}settled(){return(N(this,gn)??qe(this,gn,No())).promise}static ensure(){if(Oe===null){const e=Oe=new Xn;Cn.add(Oe),ln||Xn.enqueue(()=>{Oe===e&&e.flush()})}return Oe}static enqueue(e){Jr(e)}apply(){}};Pr=new WeakMap,Br=new WeakMap,dr=new WeakMap,hr=new WeakMap,gn=new WeakMap,Ur=new WeakMap,jr=new WeakMap,ls=new WeakSet,Ta=function(e,t,s){e.f^=Nt;for(var n=e.first,a=null;n!==null;){var o=n.f,l=(o&(zs|Tr))!==0,c=l&&(o&Nt)!==0,u=c||(o&Vt)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){l?n.f^=Nt:a!==null&&o&(Bn|ta|Ro)?a.b.defer_effect(n):o&Bn?t.push(n):Tn(n)&&(o&Fs&&N(this,Ur).add(n),fn(n));var h=n.first;if(h!==null){n=h;continue}}var p=n.parent;for(n=n.next;n===null&&p!==null;)p===a&&(a=null),n=p.next,p=p.parent}},Sa=function(e){for(var t=0;t<e.length;t+=1)Go(e[t],N(this,Ur),N(this,jr))},$o=function(){if(N(this,hr)===0){for(const e of N(this,Pr))e();N(this,Pr).clear()}N(this,dr)===0&&Dt(this,ls,Qo).call(this)},Qo=function(){var n;if(Cn.size>1){this.previous.clear();var e=Et,t=!0;for(const a of Cn){if(a===this){t=!1;continue}const o=[];for(const[c,u]of this.current){if(a.current.has(c))if(t&&u!==a.current.get(c))a.current.set(c,u);else continue;o.push(c)}if(o.length===0)continue;const l=[...a.current.keys()].filter(c=>!this.current.has(c));if(l.length>0){var s=ns;ns=[];const c=new Set,u=new Map;for(const h of o)Xo(h,l,c,u);if(ns.length>0){Oe=a,a.apply();for(const h of ns)Dt(n=a,ls,Ta).call(n,h,[],[]);a.deactivate()}ns=s}}Oe=null,Et=e}this.committed=!0,Cn.delete(this)};let Ms=Xn;function Xc(r){var e=ln;ln=!0;try{for(var t;;){if(Qc(),ns.length===0&&(Oe==null||Oe.flush(),ns.length===0))return sa=null,t;Vo()}}finally{ln=e}}function Vo(){var r=gr;wa=!0;var e=null;try{var t=0;for(jn(!0);ns.length>0;){var s=Ms.ensure();if(t++>1e3){var n,a;Zc()}s.process(ns),Js.clear()}}finally{wa=!1,jn(r),sa=null}}function Zc(){try{Ec()}catch(r){Gr(r,sa)}}let us=null;function Mi(r){var e=r.length;if(e!==0){for(var t=0;t<e;){var s=r[t++];if(!(s.f&(Os|Vt))&&Tn(s)&&(us=new Set,fn(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?hl(s):s.fn=null),(us==null?void 0:us.size)>0)){Js.clear();for(const n of us){if(n.f&(Os|Vt))continue;const a=[n];let o=n.parent;for(;o!==null;)us.has(o)&&(us.delete(o),a.push(o)),o=o.parent;for(let l=a.length-1;l>=0;l--){const c=a[l];c.f&(Os|Vt)||fn(c)}}us.clear()}}us=null}}function Xo(r,e,t,s){if(!t.has(r)&&(t.add(r),r.reactions!==null))for(const n of r.reactions){const a=n.f;a&Ct?Xo(n,e,t,s):a&(ti|Fs)&&!(a&Ft)&&Zo(n,e,s)&&(_t(n,Ft),Rs(n))}}function Zo(r,e,t){const s=t.get(r);if(s!==void 0)return s;if(r.deps!==null)for(const n of r.deps){if(e.includes(n))return!0;if(n.f&Ct&&Zo(n,e,t))return t.set(n,!0),!0}return t.set(r,!1),!1}function Rs(r){for(var e=sa=r;e.parent!==null;){e=e.parent;var t=e.f;if(wa&&e===We&&t&Fs&&!(t&Lo))return;if(t&(Tr|zs)){if(!(t&Nt))return;e.f^=Nt}}ns.push(e)}function Jc(r){let e=0,t=kr(0),s;return()=>{ii()&&(i(t),wn(()=>(e===0&&(s=sr(()=>r(()=>cn(t)))),e+=1,()=>{Jr(()=>{e-=1,e===0&&(s==null||s(),s=void 0,cn(t))})})))}}var eu=Wr|Zr|Ja;function tu(r,e,t){new su(r,e,t)}var ss,Qa,bs,fr,_s,rs,Ut,ks,Cs,Ks,vr,Gs,pr,Yr,Hr,$s,Zn,bt,ru,nu,Da,Rn,Ln,xa;class su{constructor(e,t,s){Le(this,bt);w(this,"parent");w(this,"is_pending",!1);Le(this,ss);Le(this,Qa,null);Le(this,bs);Le(this,fr);Le(this,_s);Le(this,rs,null);Le(this,Ut,null);Le(this,ks,null);Le(this,Cs,null);Le(this,Ks,null);Le(this,vr,0);Le(this,Gs,0);Le(this,pr,!1);Le(this,Yr,new Set);Le(this,Hr,new Set);Le(this,$s,null);Le(this,Zn,Jc(()=>(qe(this,$s,kr(N(this,vr))),()=>{qe(this,$s,null)})));qe(this,ss,e),qe(this,bs,t),qe(this,fr,s),this.parent=We.b,this.is_pending=!!N(this,bs).pending,qe(this,_s,ci(()=>{We.b=this;{var n=Dt(this,bt,Da).call(this);try{qe(this,rs,as(()=>s(n)))}catch(a){this.error(a)}N(this,Gs)>0?Dt(this,bt,Ln).call(this):this.is_pending=!1}return()=>{var a;(a=N(this,Ks))==null||a.remove()}},eu))}defer_effect(e){Go(e,N(this,Yr),N(this,Hr))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!N(this,bs).pending}update_pending_count(e){Dt(this,bt,xa).call(this,e),qe(this,vr,N(this,vr)+e),N(this,$s)&&$r(N(this,$s),N(this,vr))}get_effect_pending(){return N(this,Zn).call(this),i(N(this,$s))}error(e){var t=N(this,bs).onerror;let s=N(this,bs).failed;if(N(this,pr)||!t&&!s)throw e;N(this,rs)&&(Yt(N(this,rs)),qe(this,rs,null)),N(this,Ut)&&(Yt(N(this,Ut)),qe(this,Ut,null)),N(this,ks)&&(Yt(N(this,ks)),qe(this,ks,null));var n=!1,a=!1;const o=()=>{if(n){Wc();return}n=!0,a&&Oc(),Ms.ensure(),qe(this,vr,0),N(this,ks)!==null&&mr(N(this,ks),()=>{qe(this,ks,null)}),this.is_pending=this.has_pending_snippet(),qe(this,rs,Dt(this,bt,Rn).call(this,()=>(qe(this,pr,!1),as(()=>N(this,fr).call(this,N(this,ss)))))),N(this,Gs)>0?Dt(this,bt,Ln).call(this):this.is_pending=!1};var l=Ne;try{jt(null),a=!0,t==null||t(e,o),a=!1}catch(c){Gr(c,N(this,_s)&&N(this,_s).parent)}finally{jt(l)}s&&Jr(()=>{qe(this,ks,Dt(this,bt,Rn).call(this,()=>{Ms.ensure(),qe(this,pr,!0);try{return as(()=>{s(N(this,ss),()=>e,()=>o)})}catch(c){return Gr(c,N(this,_s).parent),null}finally{qe(this,pr,!1)}}))})}}ss=new WeakMap,Qa=new WeakMap,bs=new WeakMap,fr=new WeakMap,_s=new WeakMap,rs=new WeakMap,Ut=new WeakMap,ks=new WeakMap,Cs=new WeakMap,Ks=new WeakMap,vr=new WeakMap,Gs=new WeakMap,pr=new WeakMap,Yr=new WeakMap,Hr=new WeakMap,$s=new WeakMap,Zn=new WeakMap,bt=new WeakSet,ru=function(){try{qe(this,rs,as(()=>N(this,fr).call(this,N(this,ss))))}catch(e){this.error(e)}},nu=function(){const e=N(this,bs).pending;e&&(qe(this,Ut,as(()=>e(N(this,ss)))),Ms.enqueue(()=>{var t=Dt(this,bt,Da).call(this);qe(this,rs,Dt(this,bt,Rn).call(this,()=>(Ms.ensure(),as(()=>N(this,fr).call(this,t))))),N(this,Gs)>0?Dt(this,bt,Ln).call(this):(mr(N(this,Ut),()=>{qe(this,Ut,null)}),this.is_pending=!1)}))},Da=function(){var e=N(this,ss);return this.is_pending&&(qe(this,Ks,qs()),N(this,ss).before(N(this,Ks)),e=N(this,Ks)),e},Rn=function(e){var t=We,s=Ne,n=yt;Ss(N(this,_s)),jt(N(this,_s)),Kr(N(this,_s).ctx);try{return e()}catch(a){return Wo(a),null}finally{Ss(t),jt(s),Kr(n)}},Ln=function(){const e=N(this,bs).pending;N(this,rs)!==null&&(qe(this,Cs,document.createDocumentFragment()),N(this,Cs).append(N(this,Ks)),pl(N(this,rs),N(this,Cs))),N(this,Ut)===null&&qe(this,Ut,as(()=>e(N(this,ss))))},xa=function(e){var t;if(!this.has_pending_snippet()){this.parent&&Dt(t=this.parent,bt,xa).call(t,e);return}if(qe(this,Gs,N(this,Gs)+e),N(this,Gs)===0){this.is_pending=!1;for(const s of N(this,Yr))_t(s,Ft),Rs(s);for(const s of N(this,Hr))_t(s,Ps),Rs(s);N(this,Yr).clear(),N(this,Hr).clear(),N(this,Ut)&&mr(N(this,Ut),()=>{qe(this,Ut,null)}),N(this,Cs)&&(N(this,ss).before(N(this,Cs)),qe(this,Cs,null))}};function au(r,e,t,s){const n=ra;if(t.length===0&&r.length===0){s(e.map(n));return}var a=Oe,o=We,l=iu();function c(){Promise.all(t.map(u=>ou(u))).then(u=>{l();try{s([...e.map(n),...u])}catch(h){o.f&Os||Gr(h,o)}a==null||a.deactivate(),Un()}).catch(u=>{Gr(u,o)})}r.length>0?Promise.all(r).then(()=>{l();try{return c()}finally{a==null||a.deactivate(),Un()}}):c()}function iu(){var r=We,e=Ne,t=yt,s=Oe;return function(a=!0){Ss(r),jt(e),Kr(t),a&&(s==null||s.activate())}}function Un(){Ss(null),jt(null),Kr(null)}function ra(r){var e=Ct|Ft,t=Ne!==null&&Ne.f&Ct?Ne:null;return We!==null&&(We.f|=Zr),{ctx:yt,deps:null,effects:null,equals:zo,f:e,fn:r,reactions:null,rv:0,v:xt,wv:0,parent:t??We,ac:null}}function ou(r,e,t){let s=We;s===null&&Tc();var n=s.b,a=void 0,o=kr(xt),l=!Ne,c=new Map;return gu(()=>{var m;var u=No();a=u.promise;try{Promise.resolve(r()).then(u.resolve,u.reject).then(()=>{h===Oe&&h.committed&&h.deactivate(),Un()})}catch(k){u.reject(k),Un()}var h=Oe;if(l){var p=n.is_rendered();n.update_pending_count(1),h.increment(p),(m=c.get(h))==null||m.reject(Rr),c.delete(h),c.set(h,u)}const v=(k,g=void 0)=>{if(h.activate(),g)g!==Rr&&(o.f|=Zs,$r(o,g));else{o.f&Zs&&(o.f^=Zs),$r(o,k);for(const[y,_]of c){if(c.delete(y),y===h)break;_.reject(Rr)}}l&&(n.update_pending_count(-1),h.decrement(p))};u.promise.then(v,k=>v(null,k||"unknown"))}),oi(()=>{for(const u of c.values())u.reject(Rr)}),new Promise(u=>{function h(p){function v(){p===a?u(o):h(a)}p.then(v,v)}h(a)})}function Q(r){const e=ra(r);return yl(e),e}function Jo(r){const e=ra(r);return e.equals=Bo,e}function el(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)Yt(e[t])}}function lu(r){for(var e=r.parent;e!==null;){if(!(e.f&Ct))return e.f&Os?null:e;e=e.parent}return null}function ni(r){var e,t=We;Ss(lu(r));try{r.f&=~_r,el(r),e=_l(r)}finally{Ss(t)}return e}function tl(r){var e=ni(r);if(!r.equals(e)&&(r.wv=gl(),(!(Oe!=null&&Oe.is_fork)||r.deps===null)&&(r.v=e,r.deps===null))){_t(r,Nt);return}tr||(Et!==null?(ii()||Oe!=null&&Oe.is_fork)&&Et.set(r,e):ri(r))}let Ea=new Set;const Js=new Map;let sl=!1;function kr(r,e){var t={f:0,v:r,reactions:null,equals:zo,rv:0,wv:0};return t}function G(r,e){const t=kr(r);return yl(t),t}function cu(r,e=!1,t=!0){const s=kr(r);return e||(s.equals=Bo),s}function b(r,e,t=!1){Ne!==null&&(!fs||Ne.f&Ii)&&jo()&&Ne.f&(Ct|Fs|ti|Ii)&&!(Lt!=null&&Lt.includes(r))&&Mc();let s=t?De(e):e;return $r(r,s)}function $r(r,e){if(!r.equals(e)){var t=r.v;tr?Js.set(r,e):Js.set(r,t),r.v=e;var s=Ms.ensure();if(s.capture(r,t),r.f&Ct){const n=r;r.f&Ft&&ni(n),ri(n)}r.wv=gl(),rl(r,Ft),We!==null&&We.f&Nt&&!(We.f&(zs|Tr))&&(ts===null?_u([r]):ts.push(r)),!s.is_fork&&Ea.size>0&&!sl&&uu()}return e}function uu(){sl=!1;var r=gr;jn(!0);const e=Array.from(Ea);try{for(const t of e)t.f&Nt&&_t(t,Ps),Tn(t)&&fn(t)}finally{jn(r)}Ea.clear()}function Oi(r,e=1){var t=i(r),s=e===1?t++:t--;return b(r,t),s}function cn(r){b(r,r.v+1)}function rl(r,e){var t=r.reactions;if(t!==null)for(var s=t.length,n=0;n<s;n++){var a=t[n],o=a.f,l=(o&Ft)===0;if(l&&_t(a,e),o&Ct){var c=a;Et==null||Et.delete(c),o&_r||(o&os&&(a.f|=_r),rl(c,Ps))}else l&&(o&Fs&&us!==null&&us.add(a),Rs(a))}}function De(r){if(typeof r!="object"||r===null||Ns in r)return r;const e=Za(r);if(e!==mc&&e!==gc)return r;var t=new Map,s=Xa(r),n=G(0),a=br,o=l=>{if(br===a)return l();var c=Ne,u=br;jt(null),Fi(a);var h=l();return jt(c),Fi(u),h};return s&&t.set("length",G(r.length)),new Proxy(r,{defineProperty(l,c,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&Cc();var h=t.get(c);return h===void 0?h=o(()=>{var p=G(u.value);return t.set(c,p),p}):b(h,u.value,!0),!0},deleteProperty(l,c){var u=t.get(c);if(u===void 0){if(c in l){const h=o(()=>G(xt));t.set(c,h),cn(n)}}else b(u,xt),cn(n);return!0},get(l,c,u){var m;if(c===Ns)return r;var h=t.get(c),p=c in l;if(h===void 0&&(!p||(m=Fr(l,c))!=null&&m.writable)&&(h=o(()=>{var k=De(p?l[c]:xt),g=G(k);return g}),t.set(c,h)),h!==void 0){var v=i(h);return v===xt?void 0:v}return Reflect.get(l,c,u)},getOwnPropertyDescriptor(l,c){var u=Reflect.getOwnPropertyDescriptor(l,c);if(u&&"value"in u){var h=t.get(c);h&&(u.value=i(h))}else if(u===void 0){var p=t.get(c),v=p==null?void 0:p.v;if(p!==void 0&&v!==xt)return{enumerable:!0,configurable:!0,value:v,writable:!0}}return u},has(l,c){var v;if(c===Ns)return!0;var u=t.get(c),h=u!==void 0&&u.v!==xt||Reflect.has(l,c);if(u!==void 0||We!==null&&(!h||(v=Fr(l,c))!=null&&v.writable)){u===void 0&&(u=o(()=>{var m=h?De(l[c]):xt,k=G(m);return k}),t.set(c,u));var p=i(u);if(p===xt)return!1}return h},set(l,c,u,h){var x;var p=t.get(c),v=c in l;if(s&&c==="length")for(var m=u;m<p.v;m+=1){var k=t.get(m+"");k!==void 0?b(k,xt):m in l&&(k=o(()=>G(xt)),t.set(m+"",k))}if(p===void 0)(!v||(x=Fr(l,c))!=null&&x.writable)&&(p=o(()=>G(void 0)),b(p,De(u)),t.set(c,p));else{v=p.v!==xt;var g=o(()=>De(u));b(p,g)}var y=Reflect.getOwnPropertyDescriptor(l,c);if(y!=null&&y.set&&y.set.call(h,u),!v){if(s&&typeof c=="string"){var _=t.get("length"),D=Number(c);Number.isInteger(D)&&D>=_.v&&b(_,D+1)}cn(n)}return!0},ownKeys(l){i(n);var c=Reflect.ownKeys(l).filter(p=>{var v=t.get(p);return v===void 0||v.v!==xt});for(var[u,h]of t)h.v!==xt&&!(u in l)&&c.push(u);return c},setPrototypeOf(){Ic()}})}function Ni(r){try{if(r!==null&&typeof r=="object"&&Ns in r)return r[Ns]}catch{}return r}function du(r,e){return Object.is(Ni(r),Ni(e))}var qi,nl,al,il;function hu(){if(qi===void 0){qi=window,nl=/Firefox/.test(navigator.userAgent);var r=Element.prototype,e=Node.prototype,t=Text.prototype;al=Fr(e,"firstChild").get,il=Fr(e,"nextSibling").get,Ci(r)&&(r.__click=void 0,r.__className=void 0,r.__attributes=null,r.__style=void 0,r.__e=void 0),Ci(t)&&(t.__t=void 0)}}function qs(r=""){return document.createTextNode(r)}function Qs(r){return al.call(r)}function kn(r){return il.call(r)}function d(r,e){return Qs(r)}function $e(r,e=!1){{var t=Qs(r);return t instanceof Comment&&t.data===""?kn(t):t}}function f(r,e=1,t=!1){let s=r;for(;e--;)s=kn(s);return s}function fu(r){r.textContent=""}function ol(){return!1}let Ri=!1;function vu(){Ri||(Ri=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{var e;if(!r.defaultPrevented)for(const t of r.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function na(r){var e=Ne,t=We;jt(null),Ss(null);try{return r()}finally{jt(e),Ss(t)}}function ai(r,e,t,s=t){r.addEventListener(e,()=>na(t));const n=r.__on_r;n?r.__on_r=()=>{n(),s(!0)}:r.__on_r=()=>s(!0),vu()}function pu(r){We===null&&(Ne===null&&xc(),Dc()),tr&&Sc()}function yu(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function Bs(r,e,t){var s=We;s!==null&&s.f&Vt&&(r|=Vt);var n={ctx:yt,deps:null,nodes:null,f:r|Ft|os,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{fn(n),n.f|=ei}catch(l){throw Yt(n),l}else e!==null&&Rs(n);var a=n;if(t&&a.deps===null&&a.teardown===null&&a.nodes===null&&a.first===a.last&&!(a.f&Zr)&&(a=a.first,r&Fs&&r&Wr&&a!==null&&(a.f|=Wr)),a!==null&&(a.parent=s,s!==null&&yu(a,s),Ne!==null&&Ne.f&Ct&&!(r&Tr))){var o=Ne;(o.effects??(o.effects=[])).push(a)}return n}function ii(){return Ne!==null&&!fs}function oi(r){const e=Bs(ta,null,!1);return _t(e,Nt),e.teardown=r,e}function gt(r){pu();var e=We.f,t=!Ne&&(e&zs)!==0&&(e&ei)===0;if(t){var s=yt;(s.e??(s.e=[])).push(r)}else return ll(r)}function ll(r){return Bs(Bn|_c,r,!1)}function mu(r){Ms.ensure();const e=Bs(Tr|Zr,r,!0);return(t={})=>new Promise(s=>{t.outro?mr(e,()=>{Yt(e),s(void 0)}):(Yt(e),s(void 0))})}function li(r){return Bs(Bn,r,!1)}function gu(r){return Bs(ti|Zr,r,!0)}function wn(r,e=0){return Bs(ta|e,r,!0)}function j(r,e=[],t=[],s=[]){au(s,e,t,n=>{Bs(ta,()=>r(...n.map(i)),!0)})}function ci(r,e=0){var t=Bs(Fs|e,r,!0);return t}function as(r){return Bs(zs|Zr,r,!0)}function cl(r){var e=r.teardown;if(e!==null){const t=tr,s=Ne;Li(!0),jt(null);try{e.call(null)}finally{Li(t),jt(s)}}}function ul(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){const n=t.ac;n!==null&&na(()=>{n.abort(Rr)});var s=t.next;t.f&Tr?t.parent=null:Yt(t,e),t=s}}function bu(r){for(var e=r.first;e!==null;){var t=e.next;e.f&zs||Yt(e),e=t}}function Yt(r,e=!0){var t=!1;(e||r.f&Lo)&&r.nodes!==null&&r.nodes.end!==null&&(dl(r.nodes.start,r.nodes.end),t=!0),ul(r,e&&!t),Yn(r,0),_t(r,Os);var s=r.nodes&&r.nodes.t;if(s!==null)for(const a of s)a.stop();cl(r);var n=r.parent;n!==null&&n.first!==null&&hl(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes=r.ac=null}function dl(r,e){for(;r!==null;){var t=r===e?null:kn(r);r.remove(),r=t}}function hl(r){var e=r.parent,t=r.prev,s=r.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===r&&(e.first=s),e.last===r&&(e.last=t))}function mr(r,e,t=!0){var s=[];fl(r,s,!0);var n=()=>{t&&Yt(r),e&&e()},a=s.length;if(a>0){var o=()=>--a||n();for(var l of s)l.out(o)}else n()}function fl(r,e,t){if(!(r.f&Vt)){r.f^=Vt;var s=r.nodes&&r.nodes.t;if(s!==null)for(const l of s)(l.is_global||t)&&e.push(l);for(var n=r.first;n!==null;){var a=n.next,o=(n.f&Wr)!==0||(n.f&zs)!==0&&(r.f&Fs)!==0;fl(n,e,o?t:!1),n=a}}}function ui(r){vl(r,!0)}function vl(r,e){if(r.f&Vt){r.f^=Vt,r.f&Nt||(_t(r,Ft),Rs(r));for(var t=r.first;t!==null;){var s=t.next,n=(t.f&Wr)!==0||(t.f&zs)!==0;vl(t,n?e:!1),t=s}var a=r.nodes&&r.nodes.t;if(a!==null)for(const o of a)(o.is_global||e)&&o.in()}}function pl(r,e){if(r.nodes)for(var t=r.nodes.start,s=r.nodes.end;t!==null;){var n=t===s?null:kn(t);e.append(t),t=n}}let gr=!1;function jn(r){gr=r}let tr=!1;function Li(r){tr=r}let Ne=null,fs=!1;function jt(r){Ne=r}let We=null;function Ss(r){We=r}let Lt=null;function yl(r){Ne!==null&&(Lt===null?Lt=[r]:Lt.push(r))}let qt=null,Gt=0,ts=null;function _u(r){ts=r}let ml=1,hn=0,br=hn;function Fi(r){br=r}function gl(){return++ml}function Tn(r){var e=r.f;if(e&Ft)return!0;if(e&Ct&&(r.f&=~_r),e&Ps){for(var t=r.deps,s=t.length,n=0;n<s;n++){var a=t[n];if(Tn(a)&&tl(a),a.wv>r.wv)return!0}e&os&&Et===null&&_t(r,Nt)}return!1}function bl(r,e,t=!0){var s=r.reactions;if(s!==null&&!(Lt!=null&&Lt.includes(r)))for(var n=0;n<s.length;n++){var a=s[n];a.f&Ct?bl(a,e,!1):e===a&&(t?_t(a,Ft):a.f&Nt&&_t(a,Ps),Rs(a))}}function _l(r){var k;var e=qt,t=Gt,s=ts,n=Ne,a=Lt,o=yt,l=fs,c=br,u=r.f;qt=null,Gt=0,ts=null,Ne=u&(zs|Tr)?null:r,Lt=null,Kr(r.ctx),fs=!1,br=++hn,r.ac!==null&&(na(()=>{r.ac.abort(Rr)}),r.ac=null);try{r.f|=ka;var h=r.fn,p=h(),v=r.deps;if(qt!==null){var m;if(Yn(r,Gt),v!==null&&Gt>0)for(v.length=Gt+qt.length,m=0;m<qt.length;m++)v[Gt+m]=qt[m];else r.deps=v=qt;if(ii()&&r.f&os)for(m=Gt;m<v.length;m++)((k=v[m]).reactions??(k.reactions=[])).push(r)}else v!==null&&Gt<v.length&&(Yn(r,Gt),v.length=Gt);if(jo()&&ts!==null&&!fs&&v!==null&&!(r.f&(Ct|Ps|Ft)))for(m=0;m<ts.length;m++)bl(ts[m],r);return n!==null&&n!==r&&(hn++,ts!==null&&(s===null?s=ts:s.push(...ts))),r.f&Zs&&(r.f^=Zs),p}catch(g){return Wo(g)}finally{r.f^=ka,qt=e,Gt=t,ts=s,Ne=n,Lt=a,Kr(o),fs=l,br=c}}function ku(r,e){let t=e.reactions;if(t!==null){var s=pc.call(t,r);if(s!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[s]=t[n],t.pop())}}if(t===null&&e.f&Ct&&(qt===null||!qt.includes(e))){var a=e;a.f&os&&(a.f^=os,a.f&=~_r),ri(a),el(a),Yn(a,0)}}function Yn(r,e){var t=r.deps;if(t!==null)for(var s=e;s<t.length;s++)ku(r,t[s])}function fn(r){var e=r.f;if(!(e&Os)){_t(r,Nt);var t=We,s=gr;We=r,gr=!0;try{e&(Fs|Ro)?bu(r):ul(r),cl(r);var n=_l(r);r.teardown=typeof n=="function"?n:null,r.wv=ml;var a;_a&&Kc&&r.f&Ft&&r.deps}finally{gr=s,We=t}}}async function kl(){await Promise.resolve(),Xc()}function i(r){var e=r.f,t=(e&Ct)!==0;if(Ne!==null&&!fs){var s=We!==null&&(We.f&Os)!==0;if(!s&&!(Lt!=null&&Lt.includes(r))){var n=Ne.deps;if(Ne.f&ka)r.rv<hn&&(r.rv=hn,qt===null&&n!==null&&n[Gt]===r?Gt++:qt===null?qt=[r]:qt.includes(r)||qt.push(r));else{(Ne.deps??(Ne.deps=[])).push(r);var a=r.reactions;a===null?r.reactions=[Ne]:a.includes(Ne)||a.push(Ne)}}}if(tr&&Js.has(r))return Js.get(r);if(t){var o=r;if(tr){var l=o.v;return(!(o.f&Nt)&&o.reactions!==null||Tl(o))&&(l=ni(o)),Js.set(o,l),l}var c=(o.f&os)===0&&!fs&&Ne!==null&&(gr||(Ne.f&os)!==0),u=o.deps===null;Tn(o)&&(c&&(o.f|=os),tl(o)),c&&!u&&wl(o)}if(Et!=null&&Et.has(r))return Et.get(r);if(r.f&Zs)throw r.v;return r.v}function wl(r){if(r.deps!==null){r.f|=os;for(const e of r.deps)(e.reactions??(e.reactions=[])).push(r),e.f&Ct&&!(e.f&os)&&wl(e)}}function Tl(r){if(r.v===xt)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(Js.has(e)||e.f&Ct&&Tl(e))return!0;return!1}function sr(r){var e=fs;try{return fs=!0,r()}finally{fs=e}}function wu(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(Ns in r)Aa(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&Ns in t&&Aa(t)}}}function Aa(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let s in r)try{Aa(r[s],e)}catch{}const t=Za(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const s=Oo(t);for(let n in s){const a=s[n].get;if(a)try{a.call(r)}catch{}}}}}const Tu=["touchstart","touchmove"];function Su(r){return Tu.includes(r)}const Sl=new Set,Ca=new Set;function Du(r,e,t,s={}){function n(a){if(s.capture||rn.call(e,a),!a.cancelBubble)return na(()=>t==null?void 0:t.call(this,a))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?Jr(()=>{e.addEventListener(r,n,s)}):e.addEventListener(r,n,s),n}function At(r,e,t,s,n){var a={capture:s,passive:n},o=Du(r,e,t,a);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&oi(()=>{e.removeEventListener(r,o,a)})}function ft(r){for(var e=0;e<r.length;e++)Sl.add(r[e]);for(var t of Ca)t(r)}let zi=null;function rn(r){var y;var e=this,t=e.ownerDocument,s=r.type,n=((y=r.composedPath)==null?void 0:y.call(r))||[],a=n[0]||r.target;zi=r;var o=0,l=zi===r&&r.__root;if(l){var c=n.indexOf(l);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var u=n.indexOf(e);if(u===-1)return;c<=u&&(o=c)}if(a=n[o]||r.target,a!==e){yc(r,"currentTarget",{configurable:!0,get(){return a||t}});var h=Ne,p=We;jt(null),Ss(null);try{for(var v,m=[];a!==null;){var k=a.assignedSlot||a.parentNode||a.host||null;try{var g=a["__"+s];g!=null&&(!a.disabled||r.target===a)&&g.call(a,r)}catch(_){v?m.push(_):v=_}if(r.cancelBubble||k===e||k===null)break;a=k}if(v){for(let _ of m)queueMicrotask(()=>{throw _});throw v}}finally{r.__root=e,delete r.currentTarget,jt(h),Ss(p)}}}function Dl(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function vn(r,e){var t=We;t.nodes===null&&(t.nodes={start:r,end:e,a:null,t:null})}function A(r,e){var t=(e&Uc)!==0,s=(e&jc)!==0,n,a=!r.startsWith("<!>");return()=>{n===void 0&&(n=Dl(a?r:"<!>"+r),t||(n=Qs(n)));var o=s||nl?document.importNode(n,!0):n.cloneNode(!0);if(t){var l=Qs(o),c=o.lastChild;vn(l,c)}else vn(o,o);return o}}function ca(r=""){{var e=qs(r+"");return vn(e,e),e}}function lt(){var r=document.createDocumentFragment(),e=document.createComment(""),t=qs();return r.append(e,t),vn(e,t),r}function T(r,e){r!==null&&r.before(e)}function M(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??(r.__t=r.nodeValue))&&(r.__t=t,r.nodeValue=t+"")}function In(r,e){return xu(r,e)}const Ir=new Map;function xu(r,{target:e,anchor:t,props:s={},events:n,context:a,intro:o=!0}){hu();var l=new Set,c=p=>{for(var v=0;v<p.length;v++){var m=p[v];if(!l.has(m)){l.add(m);var k=Su(m);e.addEventListener(m,rn,{passive:k});var g=Ir.get(m);g===void 0?(document.addEventListener(m,rn,{passive:k}),Ir.set(m,1)):Ir.set(m,g+1)}}};c(ea(Sl)),Ca.add(c);var u=void 0,h=mu(()=>{var p=t??e.appendChild(qs());return tu(p,{pending:()=>{}},v=>{if(a){nt({});var m=yt;m.c=a}n&&(s.$$events=n),u=r(v,s)||{},a&&at()}),()=>{var k;for(var v of l){e.removeEventListener(v,rn);var m=Ir.get(v);--m===0?(document.removeEventListener(v,rn),Ir.delete(v)):Ir.set(v,m)}Ca.delete(c),p!==t&&((k=p.parentNode)==null||k.removeChild(p))}});return Ia.set(u,h),u}let Ia=new WeakMap;function Mn(r,e){const t=Ia.get(r);return t?(Ia.delete(r),t(e)):Promise.resolve()}var ds,ws,$t,yr,bn,_n,Jn;class Eu{constructor(e,t=!0){w(this,"anchor");Le(this,ds,new Map);Le(this,ws,new Map);Le(this,$t,new Map);Le(this,yr,new Set);Le(this,bn,!0);Le(this,_n,()=>{var e=Oe;if(N(this,ds).has(e)){var t=N(this,ds).get(e),s=N(this,ws).get(t);if(s)ui(s),N(this,yr).delete(t);else{var n=N(this,$t).get(t);n&&(N(this,ws).set(t,n.effect),N(this,$t).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[a,o]of N(this,ds)){if(N(this,ds).delete(a),a===e)break;const l=N(this,$t).get(o);l&&(Yt(l.effect),N(this,$t).delete(o))}for(const[a,o]of N(this,ws)){if(a===t||N(this,yr).has(a))continue;const l=()=>{if(Array.from(N(this,ds).values()).includes(a)){var u=document.createDocumentFragment();pl(o,u),u.append(qs()),N(this,$t).set(a,{effect:o,fragment:u})}else Yt(o);N(this,yr).delete(a),N(this,ws).delete(a)};N(this,bn)||!s?(N(this,yr).add(a),mr(o,l,!1)):l()}}});Le(this,Jn,e=>{N(this,ds).delete(e);const t=Array.from(N(this,ds).values());for(const[s,n]of N(this,$t))t.includes(s)||(Yt(n.effect),N(this,$t).delete(s))});this.anchor=e,qe(this,bn,t)}ensure(e,t){var s=Oe,n=ol();if(t&&!N(this,ws).has(e)&&!N(this,$t).has(e))if(n){var a=document.createDocumentFragment(),o=qs();a.append(o),N(this,$t).set(e,{effect:as(()=>t(o)),fragment:a})}else N(this,ws).set(e,as(()=>t(this.anchor)));if(N(this,ds).set(s,e),n){for(const[l,c]of N(this,ws))l===e?s.skipped_effects.delete(c):s.skipped_effects.add(c);for(const[l,c]of N(this,$t))l===e?s.skipped_effects.delete(c.effect):s.skipped_effects.add(c.effect);s.oncommit(N(this,_n)),s.ondiscard(N(this,Jn))}else N(this,_n).call(this)}}ds=new WeakMap,ws=new WeakMap,$t=new WeakMap,yr=new WeakMap,bn=new WeakMap,_n=new WeakMap,Jn=new WeakMap;function H(r,e,t=!1){var s=new Eu(r),n=t?Wr:0;function a(o,l){s.ensure(o,l)}ci(()=>{var o=!1;e((l,c=!0)=>{o=!0,a(c,l)}),o||a(!1,null)},n)}function rt(r,e){return e}function Au(r,e,t){for(var s=[],n=e.length,a,o=e.length,l=0;l<n;l++){let p=e[l];mr(p,()=>{if(a){if(a.pending.delete(p),a.done.add(p),a.pending.size===0){var v=r.outrogroups;Ma(ea(a.done)),v.delete(a),v.size===0&&(r.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=s.length===0&&t!==null;if(c){var u=t,h=u.parentNode;fu(h),h.append(u),r.items.clear()}Ma(e,!c)}else a={pending:new Set(e),done:new Set},(r.outrogroups??(r.outrogroups=new Set)).add(a)}function Ma(r,e=!0){for(var t=0;t<r.length;t++)Yt(r[t],e)}var Pi;function Fe(r,e,t,s,n,a=null){var o=r,l=new Map,c=(e&Fo)!==0;if(c){var u=r;o=u.appendChild(qs())}var h=null,p=Jo(()=>{var _=t();return Xa(_)?_:_==null?[]:ea(_)}),v,m=!0;function k(){y.fallback=h,Cu(y,v,o,e,s),h!==null&&(v.length===0?h.f&Is?(h.f^=Is,nn(h,null,o)):ui(h):mr(h,()=>{h=null}))}var g=ci(()=>{v=i(p);for(var _=v.length,D=new Set,x=Oe,E=ol(),O=0;O<_;O+=1){var z=v[O],q=s(z,O),K=m?null:l.get(q);K?(K.v&&$r(K.v,z),K.i&&$r(K.i,O),E&&x.skipped_effects.delete(K.e)):(K=Iu(l,m?o:Pi??(Pi=qs()),z,q,O,n,e,t),m||(K.e.f|=Is),l.set(q,K)),D.add(q)}if(_===0&&a&&!h&&(m?h=as(()=>a(o)):(h=as(()=>a(Pi??(Pi=qs()))),h.f|=Is)),!m)if(E){for(const[Y,J]of l)D.has(Y)||x.skipped_effects.add(J.e);x.oncommit(k),x.ondiscard(()=>{})}else k();i(p)}),y={effect:g,items:l,outrogroups:null,fallback:h};m=!1}function Cu(r,e,t,s,n){var J,ne,te,oe,pe,W,F,C,U;var a=(s&Rc)!==0,o=e.length,l=r.items,c=r.effect.first,u,h=null,p,v=[],m=[],k,g,y,_;if(a)for(_=0;_<o;_+=1)k=e[_],g=n(k,_),y=l.get(g).e,y.f&Is||((ne=(J=y.nodes)==null?void 0:J.a)==null||ne.measure(),(p??(p=new Set)).add(y));for(_=0;_<o;_+=1){if(k=e[_],g=n(k,_),y=l.get(g).e,r.outrogroups!==null)for(const re of r.outrogroups)re.pending.delete(y),re.done.delete(y);if(y.f&Is)if(y.f^=Is,y===c)nn(y,null,t);else{var D=h?h.next:c;y===r.effect.last&&(r.effect.last=y.prev),y.prev&&(y.prev.next=y.next),y.next&&(y.next.prev=y.prev),Ys(r,h,y),Ys(r,y,D),nn(y,D,t),h=y,v=[],m=[],c=h.next;continue}if(y.f&Vt&&(ui(y),a&&((oe=(te=y.nodes)==null?void 0:te.a)==null||oe.unfix(),(p??(p=new Set)).delete(y))),y!==c){if(u!==void 0&&u.has(y)){if(v.length<m.length){var x=m[0],E;h=x.prev;var O=v[0],z=v[v.length-1];for(E=0;E<v.length;E+=1)nn(v[E],x,t);for(E=0;E<m.length;E+=1)u.delete(m[E]);Ys(r,O.prev,z.next),Ys(r,h,O),Ys(r,z,x),c=x,h=z,_-=1,v=[],m=[]}else u.delete(y),nn(y,c,t),Ys(r,y.prev,y.next),Ys(r,y,h===null?r.effect.first:h.next),Ys(r,h,y),h=y;continue}for(v=[],m=[];c!==null&&c!==y;)(u??(u=new Set)).add(c),m.push(c),c=c.next;if(c===null)continue}y.f&Is||v.push(y),h=y,c=y.next}if(r.outrogroups!==null){for(const re of r.outrogroups)re.pending.size===0&&(Ma(ea(re.done)),(pe=r.outrogroups)==null||pe.delete(re));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||u!==void 0){var q=[];if(u!==void 0)for(y of u)y.f&Vt||q.push(y);for(;c!==null;)!(c.f&Vt)&&c!==r.fallback&&q.push(c),c=c.next;var K=q.length;if(K>0){var Y=s&Fo&&o===0?t:null;if(a){for(_=0;_<K;_+=1)(F=(W=q[_].nodes)==null?void 0:W.a)==null||F.measure();for(_=0;_<K;_+=1)(U=(C=q[_].nodes)==null?void 0:C.a)==null||U.fix()}Au(r,q,Y)}}a&&Jr(()=>{var re,ee;if(p!==void 0)for(y of p)(ee=(re=y.nodes)==null?void 0:re.a)==null||ee.apply()})}function Iu(r,e,t,s,n,a,o,l){var c=o&Nc?o&Lc?kr(t):cu(t,!1,!1):null,u=o&qc?kr(n):null;return{v:c,i:u,e:as(()=>(a(e,c??t,u??n,l),()=>{r.delete(s)}))}}function nn(r,e,t){if(r.nodes)for(var s=r.nodes.start,n=r.nodes.end,a=e&&!(e.f&Is)?e.nodes.start:t;s!==null;){var o=kn(s);if(a.before(s),s===n)return;s=o}}function Ys(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function Mu(r,e,t=!1,s=!1,n=!1){var a=r,o="";j(()=>{var l=We;if(o!==(o=e()??"")&&(l.nodes!==null&&(dl(l.nodes.start,l.nodes.end),l.nodes=null),o!=="")){var c=o+"";t?c=`<svg>${c}</svg>`:s&&(c=`<math>${c}</math>`);var u=Dl(c);if((t||s)&&(u=Qs(u)),vn(Qs(u),u.lastChild),t||s)for(;Qs(u);)a.before(Qs(u));else a.before(u)}})}function Ou(r,e,t){li(()=>{var s=sr(()=>e(r,t==null?void 0:t())||{});if(t&&(s!=null&&s.update)){var n=!1,a={};wn(()=>{var o=t();wu(o),n&&Po(a,o)&&(a=o,s.update(o))}),n=!0}if(s!=null&&s.destroy)return()=>s.destroy()})}function xl(r){var e,t,s="";if(typeof r=="string"||typeof r=="number")s+=r;else if(typeof r=="object")if(Array.isArray(r)){var n=r.length;for(e=0;e<n;e++)r[e]&&(t=xl(r[e]))&&(s&&(s+=" "),s+=t)}else for(t in r)r[t]&&(s&&(s+=" "),s+=t);return s}function Nu(){for(var r,e,t=0,s="",n=arguments.length;t<n;t++)(r=arguments[t])&&(e=xl(r))&&(s&&(s+=" "),s+=e);return s}function qu(r){return typeof r=="object"?Nu(r):r??""}const Bi=[...` 	
\r\f \v\uFEFF`];function Ru(r,e,t){var s=r==null?"":""+r;if(e&&(s=s?s+" "+e:e),t){for(var n in t)if(t[n])s=s?s+" "+n:n;else if(s.length)for(var a=n.length,o=0;(o=s.indexOf(n,o))>=0;){var l=o+a;(o===0||Bi.includes(s[o-1]))&&(l===s.length||Bi.includes(s[l]))?s=(o===0?"":s.substring(0,o))+s.substring(l+1):o=l}}return s===""?null:s}function Lu(r,e){return r==null?null:String(r)}function Ge(r,e,t,s,n,a){var o=r.__className;if(o!==t||o===void 0){var l=Ru(t,s,a);l==null?r.removeAttribute("class"):r.className=l,r.__className=t}else if(a&&n!==a)for(var c in a){var u=!!a[c];(n==null||u!==!!n[c])&&r.classList.toggle(c,u)}return a}function vs(r,e,t,s){var n=r.__style;if(n!==e){var a=Lu(e);a==null?r.removeAttribute("style"):r.style.cssText=a,r.__style=e}return s}function El(r,e,t=!1){if(r.multiple){if(e==null)return;if(!Xa(e))return Hc();for(var s of r.options)s.selected=e.includes(un(s));return}for(s of r.options){var n=un(s);if(du(n,e)){s.selected=!0;return}}(!t||e!==void 0)&&(r.selectedIndex=-1)}function Fu(r){var e=new MutationObserver(()=>{El(r,r.__value)});e.observe(r,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),oi(()=>{e.disconnect()})}function zu(r,e,t=e){var s=new WeakSet,n=!0;ai(r,"change",a=>{var o=a?"[selected]":":checked",l;if(r.multiple)l=[].map.call(r.querySelectorAll(o),un);else{var c=r.querySelector(o)??r.querySelector("option:not([disabled])");l=c&&un(c)}t(l),Oe!==null&&s.add(Oe)}),li(()=>{var a=e();if(r===document.activeElement){var o=on??Oe;if(s.has(o))return}if(El(r,a,n),n&&a===void 0){var l=r.querySelector(":checked");l!==null&&(a=un(l),t(a))}r.__value=a,n=!1}),Fu(r)}function un(r){return"__value"in r?r.__value:r.value}const Pu=Symbol("is custom element"),Bu=Symbol("is html");function di(r,e){var t=hi(r);t.value===(t.value=e??void 0)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e??"")}function zr(r,e){var t=hi(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function Me(r,e,t,s){var n=hi(r);n[e]!==(n[e]=t)&&(e==="loading"&&(r[wc]=t),t==null?r.removeAttribute(e):typeof t!="string"&&Uu(r).includes(e)?r[e]=t:r.setAttribute(e,t))}function hi(r){return r.__attributes??(r.__attributes={[Pu]:r.nodeName.includes("-"),[Bu]:r.namespaceURI===Yc})}var Ui=new Map;function Uu(r){var e=r.getAttribute("is")||r.nodeName,t=Ui.get(e);if(t)return t;Ui.set(e,t=[]);for(var s,n=r,a=Element.prototype;a!==n;){s=Oo(n);for(var o in s)s[o].set&&t.push(o);n=Za(n)}return t}function dt(r,e,t=e){var s=new WeakSet;ai(r,"input",async n=>{var a=n?r.defaultValue:r.value;if(a=ua(r)?da(a):a,t(a),Oe!==null&&s.add(Oe),await kl(),a!==(a=e())){var o=r.selectionStart,l=r.selectionEnd,c=r.value.length;if(r.value=a??"",l!==null){var u=r.value.length;o===l&&l===c&&u>c?(r.selectionStart=u,r.selectionEnd=u):(r.selectionStart=o,r.selectionEnd=Math.min(l,u))}}}),sr(e)==null&&r.value&&(t(ua(r)?da(r.value):r.value),Oe!==null&&s.add(Oe)),wn(()=>{var n=e();if(r===document.activeElement){var a=on??Oe;if(s.has(a))return}ua(r)&&n===da(r.value)||r.type==="date"&&!n&&!r.value||n!==r.value&&(r.value=n??"")})}function Oa(r,e,t=e){ai(r,"change",s=>{var n=s?r.defaultChecked:r.checked;t(n)}),sr(e)==null&&t(r.checked),wn(()=>{var s=e();r.checked=!!s})}function ua(r){var e=r.type;return e==="number"||e==="range"}function da(r){return r===""?null:+r}function ji(r,e){return r===e||(r==null?void 0:r[Ns])===e}function ps(r={},e,t,s){return li(()=>{var n,a;return wn(()=>{n=a,a=(s==null?void 0:s())||[],sr(()=>{r!==t(...a)&&(e(r,...a),n&&ji(t(...n),r)&&e(null,...n))})}),()=>{Jr(()=>{a&&ji(t(...a),r)&&e(null,...a)})}}),r}let On=!1;function ju(r){var e=On;try{return On=!1,[r(),On]}finally{On=e}}function Ls(r,e,t,s){var D;var n=(t&Pc)!==0,a=(t&Bc)!==0,o=s,l=!0,c=()=>(l&&(l=!1,o=a?sr(s):s),o),u;if(n){var h=Ns in r||kc in r;u=((D=Fr(r,e))==null?void 0:D.set)??(h&&e in r?x=>r[e]=x:void 0)}var p,v=!1;n?[p,v]=ju(()=>r[e]):p=r[e],p===void 0&&s!==void 0&&(p=c(),u&&(Ac(),u(p)));var m;if(m=()=>{var x=r[e];return x===void 0?c():(l=!0,x)},!(t&zc))return m;if(u){var k=r.$$legacy;return function(x,E){return arguments.length>0?((!E||k||v)&&u(E?m():x),x):m()}}var g=!1,y=(t&Fc?ra:Jo)(()=>(g=!1,m()));n&&i(y);var _=We;return function(x,E){if(arguments.length>0){const O=E?i(y):n?De(x):x;return b(y,O),g=!0,o!==void 0&&(o=O),x}return tr&&g||_.f&Os?y.v:i(y)}}function Sn(r){yt===null&&si(),gt(()=>{const e=sr(r);if(typeof e=="function")return e})}function Yu(r){yt===null&&si(),Sn(()=>()=>sr(r))}const Hu="5";var Mo;typeof window<"u"&&((Mo=window.__svelte??(window.__svelte={})).v??(Mo.v=new Set)).add(Hu);function Wu(){return{type:"daily",interval:1,time:"09:00"}}function Al(r){return!r||!r.type||!r.interval||r.interval<1?!1:r.type==="weekly"?Array.isArray(r.weekdays)&&r.weekdays.length>0&&r.weekdays.every(e=>e>=0&&e<=6):r.type==="monthly"?r.dayOfMonth>=1&&r.dayOfMonth<=31:r.type==="yearly"?r.month>=0&&r.month<=11&&r.dayOfMonth>=1&&r.dayOfMonth<=31:!0}const cr="recurring-tasks-active",Fn="recurring-tasks-archive",Yi="recurring-tasks",Hi="recurring-tasks.json.bak",Wi="n8n-event-settings",Ki="n8n-event-queue",Ku="notification-state",Gu="recurring-tasks-dock",Gi="scheduler-emitted-occurrences",Hs=4,Na={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},fi=60*1e3,$u=30*1e3,ha=2e3,$i="shehab-note-recurring-plugin",Qi="1.0.0",Qu=60*60*1e3,Vu=3,Vi=10,fa=1e3,zn=100,Xi=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],Xu=[{label:"+1 day",minutes:60*24},{label:"+3 days",minutes:60*24*3},{label:"+1 week",minutes:60*24*7}],Zu={lowest:"#94a3b8",low:"#64748b",normal:"#3b82f6",medium:"#f59e0b",high:"#f97316",highest:"#ef4444"},Ju=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Zi="last-run-timestamp",Ji="custom-recurring-task-id",eo="custom-recurring-task-due",to="custom-recurring-task-enabled",Nn=3,so=[1e3,5e3,3e4],ed=1e4,vi={dueSoonScoreMax:100,dueSoonScoreMin:0,dueDateWeight:10,overdueBaseScore:110,overduePenaltyWeight:15,noDueDateScore:0,priorityMultipliers:{lowest:.8,low:1,normal:1.1,medium:1.2,high:1.5,highest:2},maxUrgency:200,minUrgency:0},Cl=24*60*60*1e3,td=(r,e,t)=>Math.min(t,Math.max(e,r)),ro=r=>new Date(r.getFullYear(),r.getMonth(),r.getDate()),sd=(r,e)=>{const t=ro(r),s=ro(e);return Math.round((s.getTime()-t.getTime())/Cl)},rd=(r,e)=>e.priorityMultipliers[r]??1;function pi(r,e={}){return nd(r,e).score}function nd(r,e={}){const t=e.now??new Date,s=e.settings??vi;if(!yi(r))return{score:0,breakdown:{priorityContribution:0,dueDateContribution:0,overdueContribution:0}};const n=Qr(r.priority)??"normal",a=rd(n,s);if(!r.dueAt){const k=s.noDueDateScore,g=k*a;return{score:va(g,s),breakdown:{priorityContribution:g-k,dueDateContribution:k,overdueContribution:0}}}const o=new Date(r.dueAt);if(Number.isNaN(o.getTime())){const k=s.noDueDateScore,g=k*a;return{score:va(g,s),breakdown:{priorityContribution:g-k,dueDateContribution:k,overdueContribution:0}}}const l=o.getTime()<t.getTime(),c=sd(t,o),u=l?Math.max(1,Math.ceil((t.getTime()-o.getTime())/Cl)):0,h=l?0:td(s.dueSoonScoreMax-c*s.dueDateWeight,s.dueSoonScoreMin,s.dueSoonScoreMax),p=l?s.overdueBaseScore+u*s.overduePenaltyWeight:0,v=h+p,m=v*a;return{score:va(m,s),breakdown:{priorityContribution:m-v,dueDateContribution:h,overdueContribution:p}}}function va(r,e){const t=e.maxUrgency!==void 0?Math.min(e.maxUrgency,r):r;return Math.round(Math.max(e.minUrgency,t))}function Il(r,e,t){const s=new Date().toISOString(),n=t||new Date;return{id:Ml(),name:r,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:Hs,createdAt:s,updatedAt:s}}const ad=["lowest","low","normal","medium","high","highest"];function Qr(r){if(!r)return;const e=r.toLowerCase();if(e==="urgent")return"highest";if(e==="none")return"normal";if(ad.includes(e))return e}function Ml(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Ol(r,e={}){const t=new Date().toISOString();return{...{...r,id:Ml(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function id(r){var s;const e=new Date,t=e.toISOString();if(r.completionCount=(r.completionCount||0)+1,r.currentStreak=(r.currentStreak||0)+1,r.bestStreak=Math.max(r.bestStreak||0,r.currentStreak),r.recentCompletions||(r.recentCompletions=[]),r.recentCompletions.push(t),r.recentCompletions.length>Vi&&(r.recentCompletions=r.recentCompletions.slice(-Vi)),(s=r.smartRecurrence)!=null&&s.enabled){r.completionHistory||(r.completionHistory=[]);const n=new Date(r.dueAt),a=Math.round((e.getTime()-n.getTime())/(1e3*60)),o={scheduledFor:r.dueAt,completedAt:t,delayMinutes:a,dayOfWeek:e.getDay(),context:{tags:r.tags||[],relatedBlocks:r.linkedBlockId?[r.linkedBlockId]:[]}};r.completionHistory.push(o),r.completionHistory.length>100&&(r.completionHistory=r.completionHistory.slice(-100))}r.snoozeCount=0,r.lastCompletedAt=t,r.updatedAt=t}function Nl(r){r.missCount=(r.missCount||0)+1,r.currentStreak=0,r.updatedAt=new Date().toISOString()}function ql(r){const e=r.completionCount||0,t=r.missCount||0,s=e+t;if(s===0)return 100;let a=e/s*70;const o=r.currentStreak||0,l=Math.min(30,o*3);return a+=l,Math.round(Math.min(100,a))}function od(r,e){const t=new Set([...r.blockedBy??[],...r.dependsOn??[]]);return t.size===0?!1:e.filter(n=>t.has(n.id)).some(n=>yi(n))}function ld(r,e){return e.some(t=>t.id===r.id||!new Set([...t.blockedBy??[],...t.dependsOn??[]]).has(r.id)?!1:yi(t))}function yi(r){return r.status?r.status==="todo":r.enabled}function ur(r){const{message:e,type:t="info",duration:s=3e3,actionLabel:n,onAction:a,showCountdown:o=!1}=r,l=document.createElement("div");l.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const c=document.createElement("span");c.textContent=e,l.appendChild(c);let u=null;if(n&&a){const p=document.createElement("button");p.type="button";let v=Math.max(1,Math.ceil(s/1e3));p.textContent=o?`${n} (${v}s)`:n,p.className="recurring-tasks-toast__action",p.addEventListener("click",()=>{a(),u!==null&&window.clearInterval(u),l.parentElement&&l.parentElement.removeChild(l)}),l.appendChild(p),o&&s>0&&(u=window.setInterval(()=>{v=Math.max(0,v-1),p.textContent=`${n} (${v}s)`,v<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(l.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:cd(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(l);const h=()=>{u!==null&&window.clearInterval(u),l.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{l.parentElement&&l.parentElement.removeChild(l)},300)};s>0&&setTimeout(()=>{h()},s)}function cd(r){switch(r){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const $={success:(r,e)=>ur({message:r,type:"success",duration:e}),error:(r,e)=>ur({message:r,type:"error",duration:e}),warning:(r,e)=>ur({message:r,type:"warning",duration:e}),info:(r,e)=>ur({message:r,type:"info",duration:e})};if(typeof document<"u"){const r=document.createElement("style");r.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(r)}class ud{constructor(){w(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(n=>n(t))}clear(){this.handlers.clear()}}const Ye=new ud;function qn(r,e){const t=r.findIndex(n=>n.id===e.id);if(t===-1)return[...r,e];const s=[...r];return s[t]=e,s}function no(r,e){const t=r.filter(s=>s.id!==e);return t.length===r.length?r:t}function pa(r,e,t){let s=!1;const n=r.map(a=>a.id!==e?a:(s=!0,t(a)));return s?n:r}function dd(r,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),r.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const mi=Symbol("urgency-settings"),hd=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function aa(r,e,t){const s={timestamp:new Date().toISOString()},n=`[${r.toUpperCase()}] [${s.timestamp}]`;r==="error"?console.error(n,e,t||""):r==="warn"?console.warn(n,e,t||""):r==="debug"&&hd?console.debug(n,e,t||""):r==="info"&&console.log(n,e,t||"")}function Rl(r,e){aa("debug",r,e)}function he(r,e){aa("info",r,e)}function st(r,e){aa("warn",r,e)}function Te(r,e){aa("error",r,e)}async function fd(r){return new Promise(e=>{try{Va.fetchPost("/api/block/getBlockInfo",{id:r},t=>{var n,a,o;const s=((n=t==null?void 0:t.data)==null?void 0:n.content)??((a=t==null?void 0:t.data)==null?void 0:a.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){st("Failed to fetch block preview",t),e(null)}})}async function vd(r){return new Promise(e=>{try{Va.fetchPost("/api/block/getBlockHTML",{id:r},t=>{var n;const s=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(s?s.trim():null)})}catch(t){st("Failed to fetch block embed",t),e(null)}})}function qa(r){const[e,t]=r.split(":").map(Number);return{hours:e,minutes:t}}function pd(r){const e=r.getHours().toString().padStart(2,"0"),t=r.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function yd(r){return r.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Ra(r){return r.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function gi(r){const e=new Date;return r.getDate()===e.getDate()&&r.getMonth()===e.getMonth()&&r.getFullYear()===e.getFullYear()}function md(r){return r<new Date}function gd(r){return md(r)&&!gi(r)}function pn(r,e){const t=new Date(r);return t.setDate(t.getDate()+e),t}function ao(r,e){return pn(r,e*7)}function io(r,e,t){const s=new Date(r);s.setHours(e,t,0,0);const n=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:n}}function La(r){const e=new Date(r);return e.setHours(0,0,0,0),e}function bd(r){const e=new Date(r);return e.setHours(23,59,59,999),e}function _d(r,e){const s=Math.abs(e.getTime()-r.getTime());return Math.floor(s/864e5)}function kd(r,e){const t=[];for(let s=0;s<e;s++)t.push(pn(r,s));return t}var wd=A('<span class="task-card__streak svelte-yjw1ud"> </span>'),Td=A('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">✏️</button>'),Sd=A('<span class="task-card__relative svelte-yjw1ud"> </span>'),Dd=A('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),xd=A('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),Ed=A('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),Ad=A('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),Cd=A('<button class="task-card__snooze-chip"> </button>'),Id=A('<button class="task-card__snooze-option" role="menuitem"> </button>'),Md=A('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),Od=A('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <div class="task-card__urgency svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Urgency:</span> <span class="task-card__value svelte-yjw1ud"> </span></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">🕒 Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">🕒 Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">⏭️ Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">✅ Done</button></div></div>');function en(r,e){nt(e,!0);const t=Q(()=>new Date(e.task.dueAt)),s=Q(()=>gd(i(t))),n=Q(()=>gi(i(t))),a=Q(()=>i(s)?_d(new Date(e.task.dueAt),new Date):0),o=Q(()=>i(s)?"task-card--overdue":i(n)?"task-card--today":""),l=Q(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+i(a)*.05)})`:""),c=Q(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+i(a)*.08)})`:""),u=Q(()=>()=>{const se=Qr(e.task.priority)||"normal";return Zu[se]}),h=Q(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(i(t)):""),p=Q(()=>(e.task.currentStreak||0)>0),v=Q(()=>()=>"🔥"),m=Q(()=>ql(e.task)),k=Q(()=>i(m)>=80?"health--good":i(m)>=50?"health--fair":"health--poor"),g=Uo(mi),y=Q(()=>pi(e.task,{settings:g}));let _=G(!1),D=G(-1),x=[],E=G(!1),O=G(null),z=G(null),q=G(!1);const K=Q(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}…`:e.task.linkedBlockId:""),Y=Q(()=>()=>{if(!i(O))return"";const se=i(O).replace(/\s+/g," ").trim();return se.length>220?`${se.slice(0,220)}…`:se}),J=Q(()=>()=>Xi.filter(se=>[15,60,120].includes(se.minutes))),ne=Q(()=>()=>`snooze-menu-${e.task.id}`);gt(()=>{b(O,e.task.linkedBlockContent??null,!0),b(z,null),b(q,!1)});function te(){e.onDone(e.task)}function oe(){e.onDelay(e.task)}function pe(){e.onEdit&&e.onEdit(e.task)}function W(){e.onSkip(e.task)}async function F(){b(_,!i(_)),i(_)&&(await kl(),b(D,-1),x=[])}function C(se){const we=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:se}});window.dispatchEvent(we),b(_,!1),b(D,-1)}function U(se){var je,et,ke,Ie;const we=i(J);se.key==="ArrowDown"?(se.preventDefault(),b(D,Math.min(i(D)+1,we.length-1),!0),(je=x[i(D)])==null||je.focus()):se.key==="ArrowUp"?(se.preventDefault(),b(D,Math.max(i(D)-1,0),!0),(et=x[i(D)])==null||et.focus()):se.key==="Escape"?(b(_,!1),b(D,-1)):se.key==="Home"?(se.preventDefault(),b(D,0),(ke=x[0])==null||ke.focus()):se.key==="End"&&(se.preventDefault(),b(D,we.length-1),(Ie=x[i(D)])==null||Ie.focus())}function re(se){if(se.key==="Escape"&&i(_)){b(_,!1);return}(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),F())}async function ee(){if(b(E,!0),!e.task.linkedBlockId||i(q)||i(z))return;b(q,!0);const[se,we]=await Promise.all([vd(e.task.linkedBlockId),fd(e.task.linkedBlockId)]);b(z,se,!0),b(O,we,!0),b(q,!1)}function ye(){b(E,!1)}const de=Q(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,we=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[we]||we)}`);var ue=Od();ue.__keydown=se=>{se.key==="Escape"&&i(_)&&b(_,!1)};var xe=d(ue),_e=d(xe),Re=d(_e),le=f(Re,2),P=d(le),S=f(le,2);{var L=se=>{var we=wd(),je=d(we);j(et=>{Me(we,"title",`${e.task.currentStreak??""} day streak`),M(je,`${et??""} ${e.task.currentStreak??""}`)},[()=>i(v)()]),T(se,we)};H(S,se=>{i(p)&&se(L)})}var V=f(_e,2);{var ae=se=>{var we=Td();we.__click=pe,T(se,we)};H(V,se=>{e.onEdit&&se(ae)})}var I=f(xe,2),R=d(I),X=f(d(R),2),fe=d(X),me=f(X,2);{var ge=se=>{var we=Sd(),je=d(we);j(et=>M(je,et),[()=>i(h)()]),T(se,we)};H(me,se=>{e.timezoneHandler&&se(ge)})}var Ee=f(R,2),Ae=f(d(Ee),2),He=d(Ae),Ve=f(Ee,2);{var Ke=se=>{var we=Dd(),je=f(d(we),2),et=d(je);j(ke=>M(et,ke),[()=>Ra(new Date(e.task.lastCompletedAt))]),T(se,we)};H(Ve,se=>{e.task.lastCompletedAt&&se(Ke)})}var Xe=f(Ve,2);{var it=se=>{var we=Ad(),je=d(we),et=d(je),ke=f(je,2);{var Ie=ze=>{var pt=Ed(),Pt=d(pt);{var Tt=St=>{var Bt=ca("Loading preview…");T(St,Bt)},Ht=St=>{var Bt=lt(),js=$e(Bt);{var Wt=Kt=>{var B=xd(),ve=d(B);Mu(ve,()=>i(z)),T(Kt,B)},cs=Kt=>{var B=lt(),ve=$e(B);{var tt=Jt=>{var Sr=ca();j(()=>M(Sr,i(Y))),T(Jt,Sr)},Zt=Jt=>{var Sr=ca("No preview available.");T(Jt,Sr)};H(ve,Jt=>{i(O)?Jt(tt):Jt(Zt,!1)},!0)}T(Kt,B)};H(js,Kt=>{i(z)?Kt(Wt):Kt(cs,!1)},!0)}T(St,Bt)};H(Pt,St=>{i(q)?St(Tt):St(Ht,!1)})}T(ze,pt)};H(ke,ze=>{i(E)&&ze(Ie)})}j(()=>{Me(je,"title",`Linked block: ${e.task.linkedBlockId}`),M(et,`📝 Block ${i(K)??""}`)}),At("mouseenter",je,ee),At("mouseleave",je,ye),At("focus",je,ee),At("blur",je,ye),T(se,we)};H(Xe,se=>{e.task.linkedBlockId&&se(it)})}var Ce=f(I,2),ct=d(Ce),Ue=f(Ce,2),Ze=d(Ue),Je=d(Ze);Je.__click=F,Je.__keydown=re;var kt=f(Je,2),wt=d(kt);Fe(wt,17,()=>i(J),rt,(se,we)=>{var je=Cd();je.__click=()=>C(i(we).minutes);var et=d(je);j(()=>{Me(je,"aria-label",`Snooze for ${i(we).label}`),M(et,i(we).label)}),T(se,je)});var zt=f(wt,2);zt.__click=oe;var ie=f(kt,2);{var ce=se=>{var we=Md();we.__keydown=U,Fe(we,21,()=>Xi,rt,(je,et,ke)=>{var Ie=Id();Ie.__click=()=>C(i(et).minutes),Me(Ie,"tabindex",ke===0?0:-1);var ze=d(Ie);ps(Ie,(pt,Pt)=>x[Pt]=pt,pt=>x==null?void 0:x[pt],()=>[ke]),j(()=>M(ze,i(et).label)),T(je,Ie)}),j(()=>Me(we,"id",i(ne))),T(se,we)};H(ie,se=>{i(_)&&se(ce)})}var Se=f(Ze,2);Se.__click=oe;var ot=f(Se,2);ot.__click=W;var xs=f(ot,2);xs.__click=te,j((se,we)=>{Ge(ue,1,`task-card ${i(o)??""}`,"svelte-yjw1ud"),vs(ue,`--overdue-tint: ${i(l)??""}; --overdue-border: ${i(c)??""};`),Me(ue,"aria-label",se),Me(ue,"data-task-id",e.task.id),vs(Re,`background-color: ${i(u)??""}`),Me(Re,"title",`Priority:  ${(e.task.priority||"normal")??""}`),M(P,e.task.name),M(fe,we),Me(Ee,"title",`Urgency score: ${i(y)??""}`),M(He,i(y)),Ge(Ce,1,`task-card__health ${i(k)??""}`,"svelte-yjw1ud"),Me(Ce,"title",`Task health:  ${i(m)??""}%`),vs(ct,`width: ${i(m)??""}%`),Me(Je,"aria-expanded",i(_)),Me(Je,"aria-controls",i(ne))},[()=>i(de)(),()=>Ra(i(t))]),T(r,ue),at()}ft(["keydown","click"]);var Nd=A(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">🎉 No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),qd=A('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),Rd=A('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function Ld(r,e){nt(e,!0);const t=Q(()=>[...e.tasks].sort((g,y)=>new Date(g.dueAt).getTime()-new Date(y.dueAt).getTime()));let s=G(0),n=De([]);gt(()=>{i(s)>=i(t).length&&b(s,Math.max(0,i(t).length-1),!0)});function a(g){var _;if(i(t).length===0)return;const y=Math.max(0,Math.min(g,i(t).length-1));b(s,y,!0),(_=n[y])==null||_.focus()}function o(g,y){g.key==="ArrowDown"?(g.preventDefault(),a(y+1)):g.key==="ArrowUp"?(g.preventDefault(),a(y-1)):g.key==="Home"?(g.preventDefault(),a(0)):g.key==="End"&&(g.preventDefault(),a(i(t).length-1))}var l=Rd(),c=d(l),u=f(d(c),2),h=d(u),p=f(c,2),v=d(p);{var m=g=>{var y=Nd();T(g,y)},k=g=>{var y=lt(),_=$e(y);Fe(_,19,()=>i(t),D=>D.id,(D,x,E)=>{var O=qd();O.__keydown=q=>o(q,i(E));var z=d(O);en(z,{get task(){return i(x)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),ps(O,(q,K)=>n[K]=q,q=>n==null?void 0:n[q],()=>[i(E)]),j(()=>Me(O,"tabindex",i(E)===i(s)?0:-1)),At("focus",O,()=>b(s,i(E),!0)),T(D,O)}),T(g,y)};H(v,g=>{i(t).length===0?g(m):g(k,!1)})}j(()=>M(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),T(r,l),at()}ft(["keydown"]);var Fd=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),zd=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),Pd=A('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">✏️</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">📄</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">🗑️</button></div></td></tr>'),Bd=A('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ud=A('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),jd=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Yd=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Hd=A('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">🔍</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Wd(r,e){nt(e,!0);let t=G(null),s=G(!1),n=G(""),a=G(""),o=G(De(new Set)),l=G(0),c=De([]),u=G(null);const h=Q(()=>[...e.tasks].sort((I,R)=>new Date(I.dueAt).getTime()-new Date(R.dueAt).getTime())),p=Q(()=>()=>{const I=i(a).trim().toLowerCase();return I?i(h).filter(R=>{var fe;return[R.name,R.description,R.category,R.linkedBlockContent,(fe=R.tags)==null?void 0:fe.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(I)}):i(h)}),v=Q(()=>i(p).map(I=>I.id)),m=Q(()=>i(o).size>0),k=Q(()=>i(p).length>0&&i(p).every(I=>i(o).has(I.id))),g=Q(()=>i(p).some(I=>i(o).has(I.id))&&!i(k));gt(()=>{const I=new Set([...i(o)].filter(R=>e.tasks.some(X=>X.id===R)));I.size!==i(o).size&&b(o,I,!0)}),gt(()=>{i(u)&&(i(u).indeterminate=i(g))}),gt(()=>{i(l)>=i(p).length&&b(l,Math.max(0,i(p).length-1),!0)}),gt(()=>{const I=window.setTimeout(()=>{b(a,i(n),!0)},300);return()=>{window.clearTimeout(I)}});function y(I){b(t,I,!0)}function _(){i(t)&&(e.onDelete(i(t)),b(t,null))}function D(){b(t,null)}function x(I){const R=new Set(i(o));R.has(I)?R.delete(I):R.add(I),b(o,R,!0)}function E(){const I=new Set(i(o));i(k)?i(v).forEach(R=>I.delete(R)):i(v).forEach(R=>I.add(R)),b(o,I,!0)}function O(I){var X;if(i(p).length===0)return;const R=Math.max(0,Math.min(I,i(p).length-1));b(l,R,!0),(X=c[R])==null||X.focus()}function z(I,R){I.key==="ArrowDown"?(I.preventDefault(),O(R+1)):I.key==="ArrowUp"?(I.preventDefault(),O(R-1)):I.key==="Home"?(I.preventDefault(),O(0)):I.key==="End"&&(I.preventDefault(),O(i(p).length-1))}function q(){if(i(o).size===0){b(s,!1);return}e.onBulkDelete([...i(o)]),b(o,new Set,!0),b(s,!1)}function K(){b(s,!1)}function Y(I){const{type:R,interval:X}=I.frequency,fe=R==="daily"?"day":R==="weekly"?"week":R==="monthly"?"month":"year",me=X===1?`Every ${fe}`:`Every ${X} ${fe}s`;if(R==="weekly")return`${me} on ${I.frequency.weekdays.map(ge=>Ju[ge]??ge).join(", ")}`;if(R==="monthly")return`${me} on day ${I.frequency.dayOfMonth}`;if(R==="yearly"){const ge=J[I.frequency.month]??`Month ${I.frequency.month+1}`;return`${me} on ${ge} ${I.frequency.dayOfMonth}`}return me}const J=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var ne=Hd(),te=$e(ne),oe=d(te),pe=f(d(oe),2),W=d(pe),F=f(d(W),2),C=f(W,2);C.__click=function(...I){var R;(R=e.onCreate)==null||R.apply(this,I)};var U=f(oe,2),re=d(U),ee=d(re),ye=d(ee),de=f(ee,2),ue=d(de);ue.__click=()=>e.onBulkEnable([...i(o)]);var xe=f(ue,2);xe.__click=()=>e.onBulkDisable([...i(o)]);var _e=f(xe,2);_e.__click=()=>b(s,!0);var Re=f(re,2);{var le=I=>{var R=Fd();T(I,R)},P=I=>{var R=Ud(),X=d(R);{var fe=ge=>{var Ee=zd(),Ae=d(Ee),He=d(Ae);j(Ve=>M(He,`No tasks match "${Ve??""}".`),[()=>i(a).trim()]),T(ge,Ee)},me=ge=>{var Ee=Bd(),Ae=d(Ee),He=d(Ae),Ve=d(He),Ke=d(Ve);Ke.__click=E,ps(Ke,it=>b(u,it),()=>i(u));var Xe=f(Ae);Fe(Xe,23,()=>i(p),it=>it.id,(it,Ce,ct)=>{var Ue=Pd();Ue.__keydown=ze=>z(ze,i(ct));var Ze=d(Ue),Je=d(Ze);Je.__click=()=>x(i(Ce).id);var kt=f(Ze),wt=d(kt),zt=f(kt),ie=d(zt),ce=f(zt),Se=d(ce),ot=f(ce),xs=d(ot),se=d(xs);se.__change=()=>e.onToggleEnabled(i(Ce));var we=f(ot),je=d(we),et=d(je);et.__click=()=>e.onEdit(i(Ce));var ke=f(et,2);ke.__click=()=>e.onDuplicate(i(Ce));var Ie=f(ke,2);Ie.__click=()=>y(i(Ce)),ps(Ue,(ze,pt)=>c[pt]=ze,ze=>c==null?void 0:c[ze],()=>[i(ct)]),j((ze,pt,Pt,Tt)=>{Ge(Ue,1,qu(i(Ce).enabled?"":"disabled"),"svelte-i091qn"),Me(Ue,"tabindex",i(ct)===i(l)?0:-1),Me(Ue,"aria-selected",ze),Me(Je,"aria-label",`Select ${i(Ce).name}`),zr(Je,pt),M(wt,i(Ce).name),M(ie,Pt),M(Se,Tt),zr(se,i(Ce).enabled)},[()=>i(o).has(i(Ce).id),()=>i(o).has(i(Ce).id),()=>Ra(new Date(i(Ce).dueAt)),()=>Y(i(Ce))]),At("focus",Ue,()=>b(l,i(ct),!0)),T(it,Ue)}),j(()=>{zr(Ke,i(k)),Ke.disabled=i(p).length===0}),T(ge,Ee)};H(X,ge=>{i(p).length===0?ge(fe):ge(me,!1)})}T(I,R)};H(Re,I=>{i(h).length===0?I(le):I(P,!1)})}var S=f(te,2);{var L=I=>{var R=jd(),X=d(R),fe=f(d(X),2),me=d(fe),ge=f(fe,2),Ee=d(ge);Ee.__click=D;var Ae=f(Ee,2);Ae.__click=_,j(()=>M(me,`Are you sure you want to delete "${i(t).name??""}"? This action cannot be undone.`)),T(I,R)};H(S,I=>{i(t)&&I(L)})}var V=f(S,2);{var ae=I=>{var R=Yd(),X=d(R),fe=f(d(X),2),me=d(fe),ge=f(fe,2),Ee=d(ge);Ee.__click=K;var Ae=f(Ee,2);Ae.__click=q,j(()=>M(me,`Are you sure you want to delete ${i(o).size??""} task${i(o).size===1?"":"s"}? This action cannot be undone.`)),T(I,R)};H(V,I=>{i(s)&&I(ae)})}j(()=>{F.disabled=i(h).length===0,M(ye,`${i(o).size??""} selected`),ue.disabled=!i(m),xe.disabled=!i(m),_e.disabled=!i(m)}),dt(F,()=>i(n),I=>b(n,I)),T(r,ne),at()}ft(["click","keydown","change"]);var Kd=A('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Gd=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),$d=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Qd=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Vd=A('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Xd=A('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Zd=A('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Jd=A('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function eh(r,e){nt(e,!0);let t=Ls(e,"days",3,30);function s(_){const{frequency:D}=_;if(D.type==="weekly"){const x=[...D.weekdays].sort((E,O)=>E-O).join(",");return`weekly:${D.interval}:${D.time??""}:${x}`}return D.type==="monthly"?`monthly:${D.interval}:${D.time??""}:${D.dayOfMonth}`:D.type==="yearly"?`yearly:${D.interval}:${D.time??""}:${D.month}:${D.dayOfMonth}`:`daily:${D.interval}:${D.time??""}`}function n(_,D){const x=_.map(E=>`${E.id}:${E.enabled}:${E.dueAt}:${s(E)}`).join("|");return`${D}:${x}`}function a(_,D){const x=La(new Date),E=bd(pn(x,D-1)),O=24*60*60*1e3,q=kd(x,D).map(K=>({date:K,tasks:[]}));for(const K of _.filter(Y=>Y.enabled)){const Y=new Date(K.dueAt),J=e.recurrenceEngine.getOccurrencesInRange(x,E,K.frequency,Y);for(const ne of J){const te=La(ne),oe=Math.floor((te.getTime()-x.getTime())/O);oe>=0&&oe<D&&q[oe].tasks.push({task:K,occurrence:ne})}}for(const K of q)K.tasks.sort((Y,J)=>Y.occurrence.getTime()-J.occurrence.getTime());return q}const o=(()=>{let _="",D=[];return{get(x,E){const O=n(x,E);return O===_||(_=O,D=a(x,E)),D}}})(),l=Q(()=>o.get(e.tasks,t())),c=Q(()=>i(l).some(_=>_.tasks.length>0));var u=Jd(),h=d(u),p=f(d(h),2),v=d(p),m=f(h,2),k=d(m);{var g=_=>{var D=Kd(),x=d(D),E=d(x);j(()=>M(E,`No tasks scheduled in the next ${t()??""} days.`)),T(_,D)},y=_=>{var D=Zd();Fe(D,21,()=>i(l),x=>x.date.toISOString(),(x,E)=>{var O=lt(),z=$e(O);{var q=K=>{var Y=Xd(),J=d(Y),ne=d(J),te=d(ne),oe=f(ne,2),pe=d(oe),W=f(J,2);Fe(W,21,()=>i(E).tasks,({task:F,occurrence:C})=>F.id+C.toISOString(),(F,C)=>{let U=()=>i(C).task,re=()=>i(C).occurrence;var ee=Vd(),ye=d(ee),de=d(ye),ue=f(ye,2),xe=d(ue),_e=d(xe),Re=f(xe,2),le=d(Re);{var P=I=>{var R=Gd(),X=d(R);j(()=>M(X,`🔗 ${U().linkedBlockId??""}`)),T(I,R)};H(le,I=>{U().linkedBlockId&&I(P)})}var S=f(le,2);{var L=I=>{var R=$d(),X=d(R);j(()=>M(X,`⚡ ${U().priority??""}`)),T(I,R)};H(S,I=>{U().priority&&I(L)})}var V=f(S,2);{var ae=I=>{var R=Qd(),X=d(R);j(fe=>M(X,`🏷️ ${fe??""}`),[()=>U().tags.join(", ")]),T(I,R)};H(V,I=>{var R;(R=U().tags)!=null&&R.length&&I(ae)})}j(I=>{M(de,I),M(_e,U().name)},[()=>pd(re())]),T(F,ee)}),j((F,C)=>{M(te,F),M(pe,C)},[()=>yd(i(E).date),()=>i(E).date.toLocaleDateString(void 0,{weekday:"short"})]),T(K,Y)};H(z,K=>{i(E).tasks.length>0&&K(q)})}T(x,O)}),T(_,D)};H(k,_=>{i(c)?_(y,!1):_(g)})}j(()=>M(v,`Next ${t()??""} days`)),T(r,u),at()}var th=A('<span class="leaderboard-item__badge svelte-1ptoc1q">🏆 Best</span>'),sh=A('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),rh=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">🔥 Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),nh=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),ah=A('<h4 class="subsection-title svelte-1ptoc1q">✅ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),ih=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),oh=A('<h4 class="subsection-title svelte-1ptoc1q">⚠️ Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),lh=A('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">✅</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),ch=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),uh=A('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function dh(r,e){nt(e,!0);const t=Q(()=>()=>{let F=0,C=0;for(const ee of e.tasks)F+=ee.completionCount||0,C+=ee.missCount||0;const U=F+C,re=U>0?F/U*100:100;return{totalCompletions:F,totalMisses:C,completionRate:Math.round(re)}}),s=Q(()=>()=>[...e.tasks].filter(F=>(F.currentStreak||0)>0).sort((F,C)=>(C.currentStreak||0)-(F.currentStreak||0)).slice(0,10)),n=Q(()=>()=>[...e.tasks].map(F=>({task:F,health:ql(F)})).sort((F,C)=>F.health-C.health)),a=Q(()=>()=>i(n)().slice(-5).reverse()),o=Q(()=>()=>i(n)().slice(0,5)),l=Q(()=>()=>{const F=[];for(const C of e.tasks)if(C.recentCompletions&&C.recentCompletions.length>0)for(const U of C.recentCompletions)F.push({task:C,completedAt:U});return F.sort((C,U)=>new Date(U.completedAt).getTime()-new Date(C.completedAt).getTime()).slice(0,10)});function c(F){return new Date(F).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(F){return F>=80?"#10b981":F>=60?"#3b82f6":F>=40?"#f59e0b":"#ef4444"}var h=uh(),p=f(d(h),2),v=d(p),m=f(d(v),2),k=d(m),g=d(k),y=d(g),_=f(k,2),D=d(_),x=d(D),E=f(_,2),O=d(E),z=d(O),q=f(v,2);{var K=F=>{var C=rh(),U=f(d(C),2);Fe(U,21,()=>i(s)(),rt,(re,ee,ye)=>{var de=sh(),ue=d(de);ue.textContent=`#${ye+1}`;var xe=f(ue,2),_e=d(xe),Re=f(xe,2),le=d(Re),P=f(le);{var S=L=>{var V=th();T(L,V)};H(P,L=>{i(ee).bestStreak&&i(ee).currentStreak===i(ee).bestStreak&&L(S)})}j(()=>{M(_e,i(ee).name),M(le,`${i(ee).currentStreak??""} day${i(ee).currentStreak!==1?"s":""} `)}),T(re,de)}),T(F,C)};H(q,F=>{i(s)().length>0&&F(K)})}var Y=f(q,2),J=f(d(Y),2);{var ne=F=>{var C=ah(),U=f($e(C),2);Fe(U,21,()=>i(a)(),rt,(re,ee)=>{let ye=()=>i(ee).task,de=()=>i(ee).health;var ue=nh(),xe=d(ue),_e=d(xe),Re=f(xe,2),le=d(Re),P=f(le,2),S=d(P);j(L=>{M(_e,ye().name),vs(le,`width: ${de()??""}%; background-color: ${L??""}`),M(S,`${de()??""}/100`)},[()=>u(de())]),T(re,ue)}),T(F,C)};H(J,F=>{i(a)().length>0&&F(ne)})}var te=f(J,2);{var oe=F=>{var C=oh(),U=f($e(C),2);Fe(U,21,()=>i(o)(),rt,(re,ee)=>{let ye=()=>i(ee).task,de=()=>i(ee).health;var ue=ih(),xe=d(ue),_e=d(xe),Re=f(xe,2),le=d(Re),P=f(le,2),S=d(P);j(L=>{M(_e,ye().name),vs(le,`width: ${de()??""}%; background-color: ${L??""}`),M(S,`${de()??""}/100`)},[()=>u(de())]),T(re,ue)}),T(F,C)};H(te,F=>{i(o)().length>0&&i(o)()[0].health<80&&F(oe)})}var pe=f(Y,2);{var W=F=>{var C=ch(),U=f(d(C),2);Fe(U,21,()=>i(l)(),rt,(re,ee)=>{let ye=()=>i(ee).task,de=()=>i(ee).completedAt;var ue=lh(),xe=f(d(ue),2),_e=d(xe),Re=d(_e),le=f(_e,2),P=d(le);j(S=>{M(Re,ye().name),M(P,S)},[()=>c(de())]),T(re,ue)}),T(F,C)};H(pe,F=>{i(l)().length>0&&F(W)})}j((F,C,U)=>{M(y,F),M(x,C),M(z,`${U??""}%`)},[()=>i(t)().totalCompletions,()=>i(t)().totalMisses,()=>i(t)().completionRate]),T(r,h),at()}var hh=A('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">📥 No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),fh=A('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),vh=A('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function ph(r,e){nt(e,!0);const t=Q(()=>e.tasks.filter(g=>g.status!=="done"&&g.status!=="cancelled"&&!g.dueAt&&!g.scheduledAt&&!g.startAt).sort((g,y)=>new Date(y.createdAt).getTime()-new Date(g.createdAt).getTime()));let s=G(0),n=De([]);gt(()=>{i(s)>=i(t).length&&b(s,Math.max(0,i(t).length-1),!0)});function a(g){var _;if(i(t).length===0)return;const y=Math.max(0,Math.min(g,i(t).length-1));b(s,y,!0),(_=n[y])==null||_.focus()}function o(g,y){g.key==="ArrowDown"?(g.preventDefault(),a(y+1)):g.key==="ArrowUp"?(g.preventDefault(),a(y-1)):g.key==="Enter"&&e.onEdit?(g.preventDefault(),e.onEdit(i(t)[y])):g.key===" "&&e.onDone&&(g.preventDefault(),e.onDone(i(t)[y]))}var l=vh(),c=d(l),u=f(d(c),2),h=d(u),p=f(c,2),v=d(p);{var m=g=>{var y=hh();T(g,y)},k=g=>{var y=lt(),_=$e(y);Fe(_,19,()=>i(t),D=>D.id,(D,x,E)=>{var O=fh();O.__keydown=q=>o(q,i(E));var z=d(O);en(z,{get task(){return i(x)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ps(O,(q,K)=>n[K]=q,q=>n==null?void 0:n[q],()=>[i(E)]),j(()=>Me(O,"tabindex",i(E)===i(s)?0:-1)),At("focus",O,()=>b(s,i(E),!0)),T(D,O)}),T(g,y)};H(v,g=>{i(t).length===0?g(m):g(k,!1)})}j(()=>M(h,`${i(t).length??""} task${i(t).length!==1?"s":""} without dates`)),T(r,l),at()}ft(["keydown"]);var yh=A('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),mh=A('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),gh=A('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),bh=A('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function _h(r,e){nt(e,!0);let t=Ls(e,"daysAhead",3,7);const s=new Date;s.setHours(0,0,0,0);const n=new Date(s);n.setDate(n.getDate()+t());const a=Q(()=>e.tasks.filter(x=>{if(x.status==="done"||x.status==="cancelled"||!x.dueAt)return!1;const E=new Date(x.dueAt);return E.setHours(0,0,0,0),E>s&&E<=n}).sort((x,E)=>new Date(x.dueAt).getTime()-new Date(E.dueAt).getTime())),o=Q(()=>()=>{const x=new Map;return i(a).forEach(E=>{const O=new Date(E.dueAt);O.setHours(0,0,0,0);const z=O.toISOString().split("T")[0];x.has(z)||x.set(z,[]),x.get(z).push(E)}),x});function l(x){const E=new Date(x),O=Math.floor((E.getTime()-s.getTime())/(1e3*60*60*24)),z=E.toLocaleDateString("en-US",{weekday:"long"}),q=E.toLocaleDateString("en-US",{month:"short",day:"numeric"});return O===1?`Tomorrow - ${z}, ${q}`:`${z}, ${q} (in ${O} days)`}let c=G(0),u=De([]);gt(()=>{i(c)>=i(a).length&&b(c,Math.max(0,i(a).length-1),!0)});function h(x,E){x.key==="ArrowDown"?(x.preventDefault(),b(c,Math.min(i(c)+1,i(a).length-1),!0)):x.key==="ArrowUp"?(x.preventDefault(),b(c,Math.max(i(c)-1,0),!0)):x.key==="Enter"&&e.onEdit?(x.preventDefault(),e.onEdit(i(a)[E])):x.key===" "&&e.onDone&&(x.preventDefault(),e.onDone(i(a)[E]))}var p=bh(),v=d(p),m=f(d(v),2),k=d(m),g=f(v,2),y=d(g);{var _=x=>{var E=yh(),O=d(E),z=d(O);j(()=>M(z,`📅 No tasks scheduled for the next ${t()??""} days`)),T(x,E)},D=x=>{var E=lt(),O=$e(E);Fe(O,17,()=>[...i(o).entries()],rt,(z,q)=>{var K=Q(()=>qo(i(q),2));let Y=()=>i(K)[0],J=()=>i(K)[1];var ne=gh(),te=d(ne),oe=d(te),pe=f(te,2);Fe(pe,19,J,W=>W.id,(W,F)=>{const C=Q(()=>i(a).indexOf(i(F)));var U=mh();U.__keydown=ee=>h(ee,i(C));var re=d(U);en(re,{get task(){return i(F)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ps(U,(ee,ye)=>u[ye]=ee,ee=>u==null?void 0:u[ee],()=>[i(C)]),j(()=>Me(U,"tabindex",i(C)===i(c)?0:-1)),At("focus",U,()=>b(c,i(C),!0)),T(W,U)}),j(W=>M(oe,W),[()=>l(Y())]),T(z,ne)}),T(x,E)};H(y,x=>{i(a).length===0?x(_):x(D,!1)})}j(()=>M(k,`${i(a).length??""} task${i(a).length!==1?"s":""} in the next ${t()??""} days`)),T(r,p),at()}ft(["keydown"]);var kh=A('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">✅ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),wh=A('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),Th=A('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),Sh=A('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">← Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next →</button></div>'),Dh=A("<!> <!>",1),xh=A('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function Eh(r,e){nt(e,!0);let t=Ls(e,"daysBack",3,30),s=G(0);const n=50,a=new Date;a.setDate(a.getDate()-t()),a.setHours(0,0,0,0);const o=Q(()=>e.tasks.filter(q=>q.status!=="done"||!q.doneAt?!1:new Date(q.doneAt)>=a).sort((q,K)=>new Date(K.doneAt).getTime()-new Date(q.doneAt).getTime())),l=Q(()=>Math.ceil(i(o).length/n)),c=Q(()=>i(o).slice(i(s)*n,(i(s)+1)*n));gt(()=>{i(s)>=i(l)&&i(l)>0&&b(s,i(l)-1)});function u(){i(s)<i(l)-1&&Oi(s)}function h(){i(s)>0&&Oi(s,-1)}function p(q){const K=new Date(q),Y=new Date,J=Y.getTime()-K.getTime(),ne=Math.floor(J/(1e3*60*60*24));return ne===0?"Today":ne===1?"Yesterday":ne<7?`${ne} days ago`:K.toLocaleDateString("en-US",{month:"short",day:"numeric",year:K.getFullYear()!==Y.getFullYear()?"numeric":void 0})}let v=G(0),m=De([]);gt(()=>{i(v)>=i(c).length&&b(v,Math.max(0,i(c).length-1),!0)});function k(q,K){q.key==="ArrowDown"?(q.preventDefault(),b(v,Math.min(i(v)+1,i(c).length-1),!0)):q.key==="ArrowUp"?(q.preventDefault(),b(v,Math.max(i(v)-1,0),!0)):q.key==="Enter"&&e.onEdit&&(q.preventDefault(),e.onEdit(i(c)[K]))}var g=xh(),y=d(g),_=f(d(y),2),D=d(_),x=f(y,2),E=d(x);{var O=q=>{var K=kh();T(q,K)},z=q=>{var K=Dh(),Y=$e(K);Fe(Y,19,()=>i(c),te=>te.id,(te,oe,pe)=>{var W=Th();W.__keydown=de=>k(de,i(pe));var F=d(W),C=d(F),U=d(C),re=f(C,2);{var ee=de=>{var ue=wh();ue.__click=()=>e.onUncomplete(i(oe)),T(de,ue)};H(re,de=>{e.onUncomplete&&de(ee)})}var ye=f(F,2);en(ye,{get task(){return i(oe)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),ps(W,(de,ue)=>m[ue]=de,de=>m==null?void 0:m[de],()=>[i(pe)]),j(de=>{Me(W,"tabindex",i(pe)===i(v)?0:-1),M(U,`Completed ${de??""}`)},[()=>p(i(oe).doneAt)]),At("focus",W,()=>b(v,i(pe),!0)),T(te,W)});var J=f(Y,2);{var ne=te=>{var oe=Sh(),pe=d(oe);pe.__click=h;var W=f(pe,2),F=d(W),C=f(W,2);C.__click=u,j(()=>{pe.disabled=i(s)===0,M(F,`Page ${i(s)+1} of ${i(l)??""}`),C.disabled=i(s)>=i(l)-1}),T(te,oe)};H(J,te=>{i(l)>1&&te(ne)})}T(q,K)};H(E,q=>{i(o).length===0?q(O):q(z,!1)})}j(()=>M(D,`${i(o).length??""} completed task${i(o).length!==1?"s":""} in the last ${t()??""} days`)),T(r,g),at()}ft(["keydown","click"]);var Ah=A('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">📁 No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),Ch=A('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),Ih=A('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),Mh=A('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),Oh=A('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function Nh(r,e){nt(e,!0);const t=Q(()=>()=>{const Y=new Map;return e.tasks.filter(ne=>ne.status!=="done"&&ne.status!=="cancelled").forEach(ne=>{const te=ne.linkedBlockPath||"Uncategorized";Y.has(te)||Y.set(te,[]),Y.get(te).push(ne)}),Y.forEach(ne=>{ne.sort((te,oe)=>!te.dueAt&&!oe.dueAt?0:te.dueAt?oe.dueAt?new Date(te.dueAt).getTime()-new Date(oe.dueAt).getTime():-1:1)}),new Map([...Y.entries()].sort(([ne],[te])=>ne.localeCompare(te)))}),s=Q(()=>[...i(t).values()].reduce((Y,J)=>Y+J.length,0));let n=G(De(new Set([...i(t).keys()])));function a(Y){const J=new Set(i(n));J.has(Y)?J.delete(Y):J.add(Y),b(n,J,!0)}function o(){b(n,new Set([...i(t).keys()]),!0)}function l(){b(n,new Set,!0)}let c=G(0),u=De([]);const h=Q(()=>()=>{const Y=[];return i(t).forEach((J,ne)=>{i(n).has(ne)&&Y.push(...J)}),Y});gt(()=>{i(c)>=i(h).length&&b(c,Math.max(0,i(h).length-1),!0)});function p(Y,J){Y.key==="ArrowDown"?(Y.preventDefault(),b(c,Math.min(i(c)+1,i(h).length-1),!0)):Y.key==="ArrowUp"?(Y.preventDefault(),b(c,Math.max(i(c)-1,0),!0)):Y.key==="Enter"&&e.onEdit?(Y.preventDefault(),e.onEdit(i(h)[J])):Y.key===" "&&e.onDone&&(Y.preventDefault(),e.onDone(i(h)[J]))}function v(Y){const J=Y.split("/");return J[J.length-1]||Y}var m=Oh(),k=d(m),g=d(k),y=f(d(g),2),_=d(y),D=f(g,2),x=d(D);x.__click=o;var E=f(x,2);E.__click=l;var O=f(k,2),z=d(O);{var q=Y=>{var J=Ah();T(Y,J)},K=Y=>{var J=lt(),ne=$e(J);Fe(ne,17,()=>[...i(t).entries()],rt,(te,oe)=>{var pe=Q(()=>qo(i(oe),2));let W=()=>i(pe)[0],F=()=>i(pe)[1];var C=Mh(),U=d(C);U.__click=()=>a(W());var re=d(U),ee=d(re),ye=f(re,2),de=d(ye),ue=f(ye,2),xe=d(ue),_e=f(U,2);{var Re=le=>{var P=Ih();Fe(P,23,F,S=>S.id,(S,L)=>{const V=Q(()=>i(h).indexOf(i(L)));var ae=Ch();ae.__keydown=R=>p(R,i(V));var I=d(ae);en(I,{get task(){return i(L)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ps(ae,(R,X)=>u[X]=R,R=>u==null?void 0:u[R],()=>[i(V)]),j(()=>Me(ae,"tabindex",i(V)===i(c)?0:-1)),At("focus",ae,()=>b(c,i(V),!0)),T(S,ae)}),j(S=>Me(P,"aria-label",S),[()=>`Tasks for ${v(W())}`]),T(le,P)};H(_e,le=>{i(n).has(W())&&le(Re)})}j((le,P)=>{M(ee,le),Me(ye,"title",W()),M(de,P),M(xe,F().length)},[()=>i(n).has(W())?"▼":"▶",()=>v(W())]),T(te,C)}),T(Y,J)};H(z,Y=>{i(t).size===0?Y(q):Y(K,!1)})}j(()=>M(_,`${i(s)??""} task${i(s)!==1?"s":""} in ${i(t).size??""} project${i(t).size!==1?"s":""}`)),T(r,m),at()}ft(["click","keydown"]);class es extends Error{constructor(e,t,s,n){super(e),this.line=t,this.column=s,this.suggestion=n,this.name="QuerySyntaxError"}}class Mr extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var ut=(r=>(r.TODO="TODO",r.IN_PROGRESS="IN_PROGRESS",r.DONE="DONE",r.CANCELLED="CANCELLED",r.NON_TASK="NON_TASK",r.EMPTY="EMPTY",r))(ut||{});const gs=class gs{constructor(e){w(this,"symbol");w(this,"name");w(this,"nextStatusSymbol");w(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};w(gs,"TODO",new gs({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),w(gs,"DONE",new gs({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),w(gs,"IN_PROGRESS",new gs({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),w(gs,"CANCELLED",new gs({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let As=gs;class qh{static parse(e,t=new Date){const s=e.trim().toLowerCase(),n=e;if(!s)return{date:null,isValid:!1,error:"Empty date string",original:n};if(s.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const m=new Date(s);if(!isNaN(m.getTime()))return{date:m,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),s==="today")return{date:o,isValid:!0,original:n};if(s==="tomorrow"){const m=new Date(o);return m.setDate(m.getDate()+1),{date:m,isValid:!0,original:n}}if(s==="yesterday"){const m=new Date(o);return m.setDate(m.getDate()-1),{date:m,isValid:!0,original:n}}const l=s.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(l){const m=parseInt(l[1]),k=l[2],g=new Date(o);return k.startsWith("day")?g.setDate(g.getDate()+m):k.startsWith("week")?g.setDate(g.getDate()+m*7):k.startsWith("month")&&g.setMonth(g.getMonth()+m),{date:g,isValid:!0,original:n}}const c=s.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(c){const m=parseInt(c[1]),k=c[2],g=new Date(o);return k.startsWith("day")?g.setDate(g.getDate()-m):k.startsWith("week")?g.setDate(g.getDate()-m*7):k.startsWith("month")&&g.setMonth(g.getMonth()-m),{date:g,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=s.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const m=h[1],k=u.indexOf(h[2]),g=o.getDay();let y=k-g;m==="next"?y<=0&&(y+=7):y>=0&&(y-=7);const _=new Date(o);return _.setDate(_.getDate()+y),{date:_,isValid:!0,original:n}}const p=s.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(p){const m=u.indexOf(p[1]),k=o.getDay();let g=m-k;g<0&&(g+=7);const y=new Date(o);return y.setDate(y.getDate()+g),{date:y,isValid:!0,original:n}}const v=s.match(/^(this|next|last)\s+(week|month)$/);if(v){const m=v[1],k=v[2],g=new Date(o);if(k==="week"){const y=g.getDay(),_=y===0?-6:1-y;g.setDate(g.getDate()+_),m==="next"?g.setDate(g.getDate()+7):m==="last"&&g.setDate(g.getDate()-7)}else k==="month"&&(g.setDate(1),m==="next"?g.setMonth(g.getMonth()+1):m==="last"&&g.setMonth(g.getMonth()-1));return{date:g,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class er{constructor(){w(this,"input","");w(this,"position",0);w(this,"line",1);w(this,"column",1);w(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const s={filters:[]},n=this.input.split(`
`).map(a=>a.trim()).filter(a=>a.length>0);for(let a=0;a<n.length;a++){this.line=a+1,this.column=1;const o=n[a];if(o.startsWith("sort by "))s.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))s.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))s.limit=this.parseLimitInstruction(o);else if(/^explain$/i.test(o))s.explain=!0;else{const l=this.parseFilterInstruction(o);l&&s.filters.push(l)}}return s}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof es?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(/\s+(and|AND)\s+/i.test(e))return this.parseAndFilter(e);if(/\s+(or|OR)\s+/i.test(e))return this.parseOrFilter(e);if(/^(not|NOT)\s+/i.test(e))return this.parseNotFilter(e);if(e.startsWith("status.type is ")){const s=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(s)}}if(e.startsWith("status.name includes ")){const s=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(s)}}if(e.startsWith("status.symbol is ")){const s=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(s)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("urgency is ")){const s=e.substring(11).trim();return{type:"urgency",operator:"is",value:this.parseNumericValue(s,"urgency")}}if(e.startsWith("urgency above ")){const s=e.substring(14).trim();return{type:"urgency",operator:"above",value:this.parseNumericValue(s,"urgency")}}if(e.startsWith("urgency below ")){const s=e.substring(14).trim();return{type:"urgency",operator:"below",value:this.parseNumericValue(s,"urgency")}}if(e.startsWith("tag includes ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e.startsWith("tag does not include ")){const s=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(s),negate:!0}}if(e.startsWith("tags include ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const s=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(s)}}if(e.startsWith("path does not include ")){const s=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(s),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};if(e.startsWith("description includes ")){const s=e.substring(21).trim();return{type:"description",operator:"includes",value:this.unquote(s)}}if(e.startsWith("description does not include ")){const s=e.substring(29).trim();return{type:"description",operator:"does not include",value:this.unquote(s)}}if(e.startsWith("description regex ")){const s=e.substring(18).trim();return{type:"description",operator:"regex",value:this.unquote(s)}}if(e.startsWith("heading includes ")){const s=e.substring(17).trim();return{type:"heading",operator:"includes",value:this.unquote(s)}}if(e.startsWith("heading does not include ")){const s=e.substring(25).trim();return{type:"heading",operator:"does not include",value:this.unquote(s)}}throw new es(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const s of t){if(e===`has ${s} date`)return{type:"date",operator:"has",value:{field:s}};if(e===`no ${s} date`)return{type:"date",operator:"has",value:{field:s},negate:!0};const n=["before","after","on","on or before","on or after"];for(const a of n){const o=`${s} ${a} `;if(e.startsWith(o)){const l=e.substring(o.length).trim(),c=qh.parse(l,this.referenceDate);if(!c.isValid||!c.date)throw new es(`Invalid date value: "${l}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:a,value:{field:s,date:c.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new es(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new es(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new es(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return ut.TODO;case"IN_PROGRESS":return ut.IN_PROGRESS;case"DONE":return ut.DONE;case"CANCELLED":return ut.CANCELLED;case"NON_TASK":return ut.NON_TASK;default:throw new es(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}parseNumericValue(e,t){const s=Number(e);if(Number.isNaN(s))throw new es(`Invalid ${t} value: "${e}"`,this.line,this.column,`Use a numeric ${t} value (e.g., "${t} above 75")`);return s}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}parseAndFilter(e){const s=e.split(/\s+(and|AND)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(s.length===0)throw new es("Empty AND expression",this.line,this.column,"AND must have filters on both sides");if(s.length===1)return s[0];let n=s[0];for(let a=1;a<s.length;a++)n={type:"boolean",operator:"AND",value:null,left:n,right:s[a]};return n}parseOrFilter(e){const s=e.split(/\s+(or|OR)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(s.length===0)throw new es("Empty OR expression",this.line,this.column,"OR must have filters on both sides");if(s.length===1)return s[0];let n=s[0];for(let a=1;a<s.length;a++)n={type:"boolean",operator:"OR",value:null,left:n,right:s[a]};return n}parseNotFilter(e){const t=e.replace(/^NOT\s+/i,"").trim();if(!t)throw new es("Empty NOT expression",this.line,this.column,"NOT must have a filter after it");const s=this.parseFilterInstruction(t);if(!s)throw new es("Invalid filter after NOT",this.line,this.column,"NOT must be followed by a valid filter");return{type:"boolean",operator:"NOT",value:null,inner:s}}}class vt{}const ar=class ar{constructor(){w(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return ar.instance||(ar.instance=new ar),ar.instance}addDefaultStatuses(){this.add(As.TODO),this.add(As.IN_PROGRESS),this.add(As.DONE),this.add(As.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new As({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:As.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};w(ar,"instance",null);let ys=ar;class Rh extends vt{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=ys.getInstance(),s=e.statusSymbol||" ",a=t.get(s).type===this.statusType;return this.negate?!a:a}}class Lh extends vt{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=ys.getInstance(),s=e.statusSymbol||" ",a=t.get(s).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!a:a}}class Fh extends vt{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const s=(e.statusSymbol||" ")===this.symbol;return this.negate?!s:s}}class zh extends vt{matches(e){const t=ys.getInstance(),s=e.statusSymbol||" ";return t.get(s).type===ut.DONE}}class Ph extends vt{matches(e){const t=ys.getInstance(),s=e.statusSymbol||" ";return t.get(s).type!==ut.DONE}}class Bh extends vt{constructor(e,t,s){super(),this.field=e,this.comparator=t,this.targetDate=s}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const s=new Date(this.targetDate);s.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<s;case"after":return n>s;case"on":return n.getTime()===s.getTime();case"on or before":return n<=s;case"on or after":return n>=s;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class Uh extends vt{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const oo={lowest:0,low:1,normal:2,medium:3,high:4,highest:5};function jh(r){return Qr(r)??"normal"}function Yh(r){return r==="urgent"?"highest":r==="none"?"normal":r}class Hh extends vt{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=jh(e.priority),s=oo[t],n=oo[Yh(this.level)];switch(this.operator){case"is":return s===n;case"above":return s>n;case"below":return s<n;default:return!1}}}class Wh extends vt{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],s=this.tag.toLowerCase(),n=t.some(a=>a.toLowerCase().includes(s));return this.negate?!n:n}}class Kh extends vt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class Gh extends vt{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const s=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!s:s}}class $h extends vt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const s=e.blockedBy&&e.blockedBy.length>0;return this.negate?!s:!!s}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Qh extends vt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Vh extends vt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class Xh extends vt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Zh extends vt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class Jh extends vt{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class ef extends vt{constructor(e,t,s=!1){super(),this.operator=e,this.pattern=t,this.caseSensitive=s}matches(e){const t=e.name||"",s=e.description||"",n=`${t} ${s}`.trim();switch(this.operator){case"includes":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"does not include":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return!(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"regex":try{const a=this.caseSensitive?"":"i";return new RegExp(this.pattern,a).test(n)}catch{return!1}}}}class tf extends vt{constructor(e,t){super(),this.operator=e,this.pattern=t}matches(e){const s=(e.heading||"").toLowerCase().includes(this.pattern.toLowerCase());return this.operator==="includes"?s:!s}}class sf extends vt{constructor(e,t,s,n){super(),this.comparator=e,this.threshold=t,this.referenceDate=s,this.settings=n}matches(e){const t=pi(e,{now:this.referenceDate,settings:this.settings});switch(this.comparator){case"above":return t>this.threshold;case"below":return t<this.threshold;case"is":return t===this.threshold;default:return!1}}}class rr{group(e){const t=new Map;for(const s of e){const n=this.getGroupKey(s);this.addToGroup(t,n,s)}return t}addToGroup(e,t,s){e.has(t)||e.set(t,[]),e.get(t).push(s)}}class rf extends rr{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.dueAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Overdue":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class nf extends rr{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.scheduledAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Past":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class af extends rr{getGroupKey(e){const t=ys.getInstance(),s=e.statusSymbol||" ";return t.get(s).type}}class of extends rr{getGroupKey(e){const t=ys.getInstance(),s=e.statusSymbol||" ";return t.get(s).name}}class lf extends rr{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class cf extends rr{getGroupKey(e){return e.path||""||"No path"}}class uf extends rr{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const s=t.lastIndexOf("/");return s===-1?"Root":t.substring(0,s)||"Root"}}class df extends rr{group(e){const t=new Map;for(const s of e){const n=s.tags||[];if(n.length===0)this.addToGroup(t,"No tags",s);else for(const a of n)this.addToGroup(t,a,s)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}function Ll(r){const e=[];if(r.filters.length>0){e.push("**Filters:**");for(const t of r.filters)e.push(`- ${Nr(t)}`)}else e.push("**Filters:** None (showing all tasks)");if(r.sort){const t=r.sort.reverse?"descending":"ascending";e.push(`
**Sort:** By ${r.sort.field} (${t})`)}return r.group&&e.push(`
**Group:** By ${r.group.field}`),r.limit!==void 0&&r.limit>0&&e.push(`
**Limit:** First ${r.limit} tasks`),e.join(`
`)}function Nr(r){const e=r.negate?"NOT ":"";switch(r.type){case"status":return`${e}Status ${r.operator} "${r.value}"`;case"date":return`${e}${r.value.field} ${r.value.comparator} ${r.value.date}`;case"priority":return`${e}Priority ${r.operator} ${r.value}`;case"urgency":return`${e}Urgency ${r.operator} ${r.value}`;case"tag":return r.operator==="includes"?`${e}Tag includes "${r.value}"`:r.operator==="has"?`${e}Has tags`:`${e}Tag ${r.operator} "${r.value}"`;case"path":return`${e}Path ${r.operator} "${r.value}"`;case"dependency":return r.value==="blocked"?`${e}Is blocked by another task`:r.value==="blocking"?`${e}Is blocking another task`:`${e}Dependency ${r.operator} ${r.value}`;case"recurrence":return`${e}Recurrence ${r.operator} ${r.value}`;case"boolean":return r.operator==="and"?`(${Nr(r.left)} AND ${Nr(r.right)})`:r.operator==="or"?`(${Nr(r.left)} OR ${Nr(r.right)})`:r.operator==="not"?`(NOT ${Nr(r.inner)})`:"Unknown boolean filter";case"done":return r.value?`${e}Done`:`${e}Not done`;case"description":return`${e}Description ${r.operator} "${r.value}"`;default:return`${e}Unknown filter`}}class Fl{constructor(e,t={}){w(this,"dependencyGraph",null);w(this,"globalFilterAST",null);w(this,"urgencySettings");this.taskIndex=e,this.urgencySettings=t.urgencySettings??vi}setDependencyGraph(e){this.dependencyGraph=e}setGlobalFilter(e){if(!e){this.globalFilterAST=null;return}try{const t=new er;this.globalFilterAST=t.parse(e)}catch(t){console.error("Failed to parse global filter:",t),this.globalFilterAST=null}}execute(e){const t=performance.now(),s=new Date;try{const n=e.explain?this.generateExplanation(e):void 0;let a=this.taskIndex.getAllTasks();const o=a.length;this.globalFilterAST&&this.globalFilterAST.filters.length>0&&(a=this.applyFilters(a,this.globalFilterAST.filters,s)),e.filters.length>0&&(a=this.applyFilters(a,e.filters,s)),e.sort&&(a=this.applySort(a,e.sort,s)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let l;e.group&&(l=this.applyGrouping(a,e.group));const u=performance.now()-t;return{tasks:a,groups:l,totalCount:o,executionTimeMs:u,explanation:n}}catch(n){throw new Mr(`Failed to execute query: ${n instanceof Error?n.message:String(n)}`,n instanceof Error?n:void 0)}}executeString(e){const s=new er().parse(e);return this.execute(s)}validateQuery(e){try{return{valid:!0,parsedFilters:new er().parse(e).filters.map(n=>`${n.type}:${n.operator}`)}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}applyFilters(e,t,s){let n=e;for(const a of t){const o=this.createFilter(a,s);n=n.filter(l=>o.matches(l))}return n}createFilter(e,t){switch(e.type){case"done":return e.value?new zh:new Ph;case"status":if(e.operator==="type-is")return new Rh(e.value,e.negate);if(e.operator==="name-includes")return new Lh(e.value,e.negate);if(e.operator==="symbol-is")return new Fh(e.value,e.negate);throw new Mr(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new Uh(e.value.field,e.negate):new Bh(e.value.field,e.operator,e.value.date);case"priority":return new Hh(e.operator,e.value);case"urgency":return new sf(e.operator,e.value,t,this.urgencySettings);case"tag":return e.operator==="has"?new Kh(!e.value):new Wh(e.value,e.negate);case"path":return new Gh(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new $h(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Qh(this.dependencyGraph,!e.value);throw new Mr(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Vh(!e.value);case"description":return new ef(e.operator,e.value,e.negate);case"heading":return new tf(e.operator,e.value);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new Xh(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="OR"&&e.left&&e.right)return new Zh(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="NOT"&&e.inner)return new Jh(this.createFilter(e.inner,t));throw new Mr(`Invalid boolean operator: ${e.operator}`);default:throw new Mr(`Unknown filter type: ${e.type}`)}}applySort(e,t,s){const n=[...e];return n.sort((a,o)=>{let l=0;switch(t.field){case"due":l=this.compareDates(a.dueAt,o.dueAt);break;case"scheduled":l=this.compareDates(a.scheduledAt,o.scheduledAt);break;case"start":l=this.compareDates(a.startAt,o.startAt);break;case"created":l=this.compareDates(a.createdAt,o.createdAt);break;case"done":l=this.compareDates(a.doneAt,o.doneAt);break;case"priority":l=this.comparePriorities(a.priority,o.priority);break;case"urgency":l=this.getUrgencyScore(o,s)-this.getUrgencyScore(a,s);break;case"status.type":l=this.compareStatusTypes(a,o);break;case"description":l=(a.description||"").localeCompare(o.description||"");break;case"heading":l=(a.heading||"").localeCompare(o.heading||"");break;case"path":l=(a.path||"").localeCompare(o.path||"");break;default:l=a.name.localeCompare(o.name)}return t.reverse?-l:l}),n}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const s={lowest:0,low:1,normal:2,medium:3,high:4,highest:5},n=s[Qr(e)||"normal"]||2,a=s[Qr(t)||"normal"]||2;return n-a}compareStatusTypes(e,t){const s=n=>{const a=n.statusSymbol||" ";return a===" "?0:a==="/"?1:a==="x"?2:a==="-"?3:0};return s(e)-s(t)}getUrgencyScore(e,t){return pi(e,{now:t,settings:this.urgencySettings})}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new rf;case"scheduled":return new nf;case"status.type":return new af;case"status.name":return new of;case"priority":return new lf;case"path":return new cf;case"folder":return new uf;case"tags":return new df;default:throw new Mr(`Unknown grouping field: ${e}`)}}generateExplanation(e){return Ll(e)}}class zl{constructor(e){w(this,"parser");this.parser=e??new er}compose(e,t){const{query:s,ignoreGlobal:n}=this.stripIgnoreDirective(e),a=this.parser.parse(s);return!n&&t&&t.filters.length>0?{ast:{...a,filters:[...t.filters,...a.filters]},ignoredGlobal:!1}:{ast:a,ignoredGlobal:n}}stripIgnoreDirective(e){const t=e.split(`
`),s=[];let n=!1;for(const a of t){if(/^ignore global query$/i.test(a.trim())){n=!0;continue}s.push(a)}return{query:s.join(`
`),ignoreGlobal:n}}}const Hn={enabled:!1,query:""},ir=class ir{constructor(e=Hn){w(this,"config");w(this,"ast",null);w(this,"error",null);this.config=e,this.parse()}static getInstance(){return ir.instance||(ir.instance=new ir),ir.instance}initialize(e){this.config=e,this.parse()}updateConfig(e){this.config=e,this.parse()}getConfig(){return this.config}isEnabled(){return this.config.enabled&&this.config.query.trim().length>0}getAST(){return this.ast}getError(){return this.error}parse(){if(!this.isEnabled()){this.ast=null,this.error=null;return}try{const e=new er;this.ast=e.parse(this.config.query),this.error=null}catch(e){this.ast=null,this.error=e instanceof Error?e.message:String(e)}}};w(ir,"instance",null);let Vr=ir;var hf=A('<button class="search-tab__btn svelte-1yjlv38"> </button>'),ff=A('<div class="search-tab__error svelte-1yjlv38"> </div>'),vf=A('<div class="search-tab__stats svelte-1yjlv38"> </div>'),pf=A('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),yf=A('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),mf=A('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),gf=A('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">🔍 No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),bf=A('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),_f=A(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function kf(r,e){nt(e,!0);let t=G(""),s=G(De([])),n=G(""),a=G(0),o=G(De([])),l=G(!1),c=G(!1);const u=["not done","priority is high","due before tomorrow","not done AND priority above medium","is blocked","description includes meeting","tag includes #work","is recurring","priority is high OR priority is medium","NOT is blocked","not done AND priority is high AND description includes priority","sort by priority","sort by urgency","urgency above 80","group by priority"],h={getAllTasks:()=>e.tasks},p=Uo(mi),v=new Fl(h,{urgencySettings:p}),m=new zl(new er);function k(){if(!i(t).trim()){b(s,[],!0),b(n,"");return}b(c,!0),b(n,"");try{const P=Vr.getInstance();if(P.isEnabled()&&P.getError())throw new Error(`Global query error: ${P.getError()}`);const S=m.compose(i(t),P.getAST()).ast,L=v.execute(S);if(b(s,L.tasks,!0),b(a,L.executionTimeMs,!0),!i(o).includes(i(t))){b(o,[i(t),...i(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(i(o)))}catch{}}}catch(P){b(n,P instanceof Error?P.message:String(P),!0),b(s,[],!0),$.error(`Query error: ${i(n)}`)}finally{b(c,!1)}}function g(){try{const P=localStorage.getItem("query-history");P&&b(o,JSON.parse(P),!0)}catch{}}function y(P){b(t,P,!0),k()}function _(P){b(t,P,!0),b(l,!1),k()}function D(){b(o,[],!0);try{localStorage.removeItem("query-history")}catch{}b(l,!1)}function x(P){P.key==="Enter"&&!P.shiftKey&&(P.preventDefault(),k())}gt(()=>{g()});let E=G(0),O=De([]);gt(()=>{i(E)>=i(s).length&&b(E,Math.max(0,i(s).length-1),!0)});function z(P,S){P.key==="ArrowDown"?(P.preventDefault(),b(E,Math.min(i(E)+1,i(s).length-1),!0)):P.key==="ArrowUp"?(P.preventDefault(),b(E,Math.max(i(E)-1,0),!0)):P.key==="Enter"&&e.onEdit?(P.preventDefault(),e.onEdit(i(s)[S])):P.key===" "&&e.onDone&&(P.preventDefault(),e.onDone(i(s)[S]))}var q=_f(),K=f(d(q),2),Y=d(K),J=d(Y);J.__keydown=x;var ne=f(J,2),te=d(ne);te.__click=k;var oe=d(te),pe=f(te,2);{var W=P=>{var S=hf();S.__click=()=>b(l,!i(l));var L=d(S);j(()=>M(L,`History (${i(o).length??""})`)),T(P,S)};H(pe,P=>{i(o).length>0&&P(W)})}var F=f(Y,2);{var C=P=>{var S=ff(),L=d(S);j(()=>M(L,`⚠️ ${i(n)??""}`)),T(P,S)};H(F,P=>{i(n)&&P(C)})}var U=f(F,2);{var re=P=>{var S=vf(),L=d(S);j(V=>M(L,`Found ${i(s).length??""} task${i(s).length!==1?"s":""} in ${V??""}ms`),[()=>i(a).toFixed(2)]),T(P,S)};H(U,P=>{i(a)>0&&!i(n)&&P(re)})}var ee=f(K,2);{var ye=P=>{var S=yf(),L=d(S),V=f(d(L),2);V.__click=D;var ae=f(L,2);Fe(ae,21,()=>i(o),rt,(I,R)=>{var X=pf(),fe=d(X);fe.__click=()=>_(i(R));var me=d(fe);j(()=>M(me,i(R))),T(I,X)}),T(P,S)};H(ee,P=>{i(l)&&i(o).length>0&&P(ye)})}var de=f(ee,2),ue=f(d(de),2);Fe(ue,21,()=>u,rt,(P,S)=>{var L=mf();L.__click=()=>y(i(S));var V=d(L),ae=d(V);j(()=>M(ae,i(S))),T(P,L)});var xe=f(de,2),_e=d(xe);{var Re=P=>{var S=gf();T(P,S)},le=P=>{var S=lt(),L=$e(S);{var V=ae=>{var I=lt(),R=$e(I);Fe(R,19,()=>i(s),X=>X.id,(X,fe,me)=>{var ge=bf();ge.__keydown=Ae=>z(Ae,i(me));var Ee=d(ge);en(Ee,{get task(){return i(fe)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ps(ge,(Ae,He)=>O[He]=Ae,Ae=>O==null?void 0:O[Ae],()=>[i(me)]),j(()=>Me(ge,"tabindex",i(me)===i(E)?0:-1)),At("focus",ge,()=>b(E,i(me),!0)),T(X,ge)}),T(ae,I)};H(L,ae=>{i(s).length>0&&ae(V)},!0)}T(P,S)};H(_e,P=>{i(s).length===0&&i(t).trim()&&!i(n)?P(Re):P(le,!1)})}j(()=>{te.disabled=i(c),M(oe,i(c)?"Searching...":"Search")}),dt(J,()=>i(t),P=>b(t,P)),T(r,q),at()}ft(["keydown","click"]);class wf{analyzeCompletionPatterns(e){if(!e.completionHistory||e.completionHistory.length===0)return this.getDefaultInsight();const t=e.completionHistory,s=new lo,n=this.calculateAverageDelay(t),a=s.calculateOptimalTime(t),o=s.findWeekdayPatterns(t),l=Array.from(o.keys()).filter(m=>{const k=o.get(m);return k&&k.confidence>.5}),c=this.calculateConsistencyScore(t),u=(e.completionCount||0)+(e.missCount||0),h=u>0?(e.missCount||0)/u*100:0,p=this.generateSuggestion(n,a,l,c),v=this.calculateConfidence(t.length,c,a.confidence);return{averageCompletionDelay:n,preferredTimeOfDay:a.hour,preferredDayOfWeek:l,completionConsistency:c,missedTaskFrequency:h,suggestedAdjustment:p,confidence:v}}suggestScheduleOptimization(e){const t=this.analyzeCompletionPatterns(e);if(t.confidence<.5||!e.completionHistory||e.completionHistory.length<10)return null;const s=e.frequency,n={...s};let a="",o="";if(Math.abs(t.averageCompletionDelay)>60&&(a=`You typically complete this task around ${t.preferredTimeOfDay}:00, `,a+=t.averageCompletionDelay>0?`${Math.round(t.averageCompletionDelay/60)} hours later than scheduled.`:`${Math.round(Math.abs(t.averageCompletionDelay)/60)} hours earlier than scheduled.`,o="Better alignment with your natural completion patterns"),s.type==="weekly"&&t.preferredDayOfWeek.length>0){const l=s.weekdays||[],c=t.preferredDayOfWeek;JSON.stringify(l.sort())!==JSON.stringify(c.sort())&&(n.weekdays=c,a+=` Consider scheduling for ${this.formatWeekdays(c)} based on completion patterns.`,o="Higher completion rate on preferred days")}return a?{currentSchedule:{frequency:s,time:this.extractTimeFromDueAt(e.dueAt)},suggestedSchedule:{frequency:n,time:t.preferredTimeOfDay!==void 0?`${t.preferredTimeOfDay.toString().padStart(2,"0")}:00`:void 0},reason:a,confidence:t.confidence,expectedImprovement:o}:null}autoAdjustSchedule(e,t=.7){var a;if(!((a=e.smartRecurrence)!=null&&a.autoAdjust))return!1;const s=this.suggestScheduleOptimization(e);if(!s||s.confidence<t)return!1;if(e.frequency=s.suggestedSchedule.frequency,s.suggestedSchedule.time){const o=new Date(e.dueAt),[l,c]=s.suggestedSchedule.time.split(":").map(Number);o.setHours(l,c||0,0,0),e.dueAt=o.toISOString()}e.learningMetrics||(e.learningMetrics={averageDelayMinutes:0,optimalHour:0,consistencyScore:0,lastLearningUpdate:new Date().toISOString()});const n=this.analyzeCompletionPatterns(e);return e.learningMetrics.averageDelayMinutes=n.averageCompletionDelay,e.learningMetrics.optimalHour=n.preferredTimeOfDay,e.learningMetrics.consistencyScore=n.completionConsistency,e.learningMetrics.lastLearningUpdate=new Date().toISOString(),!0}detectAnomalies(e){const t=[];if(!e.completionHistory||e.completionHistory.length<5)return t;const n=new lo().detectSkipPatterns(e);n.isAnomalous&&t.push({type:"consistently_skipped",severity:"high",description:n.reason,affectedPeriod:{start:e.createdAt,end:new Date().toISOString()},suggestion:"Consider adjusting the recurrence frequency or disabling this task"});const a=this.detectCompletionDrift(e.completionHistory);return a.isDrifting&&t.push({type:"completion_drift",severity:a.severity,description:`Completion times are drifting ${a.direction} by an average of ${a.averageDriftMinutes} minutes`,affectedPeriod:{start:e.completionHistory[0].completedAt,end:e.completionHistory[e.completionHistory.length-1].completedAt},suggestion:"Consider adjusting the scheduled time to match your natural completion pattern"}),t}getDefaultInsight(){return{averageCompletionDelay:0,preferredTimeOfDay:9,preferredDayOfWeek:[],completionConsistency:0,missedTaskFrequency:0,suggestedAdjustment:"Not enough data to generate insights (need at least 10 completions)",confidence:0}}calculateAverageDelay(e){if(e.length===0)return 0;const t=e.reduce((s,n)=>s+n.delayMinutes,0);return Math.round(t/e.length)}calculateConsistencyScore(e){if(e.length<2)return 0;const t=this.calculateAverageDelay(e),s=e.reduce((o,l)=>{const c=l.delayMinutes-t;return o+c*c},0)/e.length,n=Math.sqrt(s),a=Math.max(0,1-n/240);return Math.round(a*100)/100}generateSuggestion(e,t,s,n){if(n<.3)return"Completion patterns are inconsistent. Try to complete tasks at similar times.";const a=[];if(Math.abs(e)>60){const o=Math.round(Math.abs(e)/60);e>0?a.push(`Consider scheduling ${o} hour(s) later (around ${t.hour}:00)`):a.push(`Consider scheduling ${o} hour(s) earlier (around ${t.hour}:00)`)}return s.length>0&&t.confidence>.6&&a.push(`Best completion rate on ${this.formatWeekdays(s)}`),a.length>0?a.join(". "):"Maintaining good completion consistency!"}calculateConfidence(e,t,s){const a=Math.min(1,e/30)*.4+t*.3+s*.3;return Math.round(a*100)/100}extractTimeFromDueAt(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}formatWeekdays(e){const t=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];return e.map(s=>t[s]).join(", ")}detectCompletionDrift(e){if(e.length<10)return{isDrifting:!1,direction:"later",averageDriftMinutes:0,severity:"low"};const s=e.slice(-10).map(p=>p.delayMinutes);let n=0,a=0,o=0,l=0;const c=s.length;for(let p=0;p<c;p++)n+=p,a+=s[p],o+=p*s[p],l+=p*p;const u=(c*o-n*a)/(c*l-n*n),h=Math.abs(u);if(h>5){const p=h>30?"high":h>15?"medium":"low";return{isDrifting:!0,direction:u>0?"later":"earlier",averageDriftMinutes:Math.round(h),severity:p}}return{isDrifting:!1,direction:"later",averageDriftMinutes:0,severity:"low"}}}class lo{calculateOptimalTime(e){if(e.length===0)return{hour:9,confidence:0,sampleSize:0};const t=new Map;for(const o of e){const l=new Date(o.completedAt).getHours();t.set(l,(t.get(l)||0)+1)}let s=9,n=0;for(const[o,l]of t.entries())l>n&&(n=l,s=o);const a=n/e.length;return{hour:s,confidence:Math.round(a*100)/100,sampleSize:e.length}}findWeekdayPatterns(e){const t=new Map,s=new Map;for(const n of e){const a=n.dayOfWeek;s.has(a)||s.set(a,[]),s.get(a).push(n)}for(const[n,a]of s.entries()){const o=this.calculateOptimalTime(a);a.length>=2&&t.set(n,o)}return t}detectSkipPatterns(e){const t=(e.completionCount||0)+(e.missCount||0),s=t>0?(e.missCount||0)/t:0;return s>.5&&t>=10?{isAnomalous:!0,reason:`Task is skipped ${Math.round(s*100)}% of the time (${e.missCount} out of ${t})`}:(e.missCount||0)>=5&&e.currentStreak===0?{isAnomalous:!0,reason:"Task has been skipped multiple times recently"}:{isAnomalous:!1,reason:""}}}var Tf=A('<div class="empty-state svelte-14xzl1l"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="svelte-14xzl1l"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg> <h3 class="svelte-14xzl1l">No Smart Tasks Yet</h3> <p>Enable smart recurrence on your tasks and complete them at least 5 times to see insights.</p></div>'),Sf=A('<div class="suggestion-box svelte-14xzl1l"><div class="suggestion-icon svelte-14xzl1l">💡</div> <p class="svelte-14xzl1l"> </p></div>'),Df=A('<div class="schedule-suggestion svelte-14xzl1l"><h4 class="svelte-14xzl1l">Suggested Schedule Adjustment</h4> <div class="schedule-comparison svelte-14xzl1l"><div class="schedule-column svelte-14xzl1l"><span class="schedule-label svelte-14xzl1l">Current</span> <span class="schedule-value svelte-14xzl1l"> </span></div> <div class="schedule-arrow svelte-14xzl1l">→</div> <div class="schedule-column svelte-14xzl1l"><span class="schedule-label svelte-14xzl1l">Suggested</span> <span class="schedule-value svelte-14xzl1l"> </span></div></div> <p class="suggestion-reason svelte-14xzl1l"> </p> <p class="suggestion-improvement svelte-14xzl1l"> </p> <button class="apply-btn svelte-14xzl1l">Apply Suggestion</button></div>'),xf=A('<div class="anomaly-card svelte-14xzl1l"><div class="anomaly-header svelte-14xzl1l"><span class="anomaly-type svelte-14xzl1l"> </span> <span class="anomaly-severity svelte-14xzl1l"> </span></div> <p class="anomaly-description svelte-14xzl1l"> </p> <p class="anomaly-suggestion svelte-14xzl1l"> </p></div>'),Ef=A('<div class="anomalies-section svelte-14xzl1l"><h4 class="svelte-14xzl1l">⚠️ Detected Issues</h4> <!></div>'),Af=A('<span class="history-label svelte-14xzl1l"> </span>'),Cf=A('<div class="history-summary svelte-14xzl1l"><span class="history-label svelte-14xzl1l"> </span> <!></div>'),If=A('<div class="insight-card svelte-14xzl1l"><div class="insight-header svelte-14xzl1l"><h3 class="svelte-14xzl1l"> </h3> <div class="confidence-badge svelte-14xzl1l"> </div></div> <div class="insight-stats svelte-14xzl1l"><div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Consistency</span> <span class="stat-value svelte-14xzl1l"> </span></div> <div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Avg Delay</span> <span class="stat-value svelte-14xzl1l"> </span></div> <div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Preferred Time</span> <span class="stat-value svelte-14xzl1l"> </span></div> <div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Completion Rate</span> <span class="stat-value svelte-14xzl1l"> </span></div></div> <!> <!> <!> <!></div>'),Mf=A('<div class="insights-list svelte-14xzl1l"></div>'),Of=A('<div class="insights-tab svelte-14xzl1l"><div class="insights-header svelte-14xzl1l"><h2 class="svelte-14xzl1l">Smart Insights</h2> <p class="svelte-14xzl1l">Learn from your task completion patterns to optimize your schedule</p></div> <!></div>');function Nf(r,e){nt(e,!0);const t=new wf,s=Q(()=>e.tasks.filter(y=>{var _;return((_=y.smartRecurrence)==null?void 0:_.enabled)&&y.completionHistory&&y.completionHistory.length>=5})),n=Q(()=>i(s).map(y=>({task:y,insight:t.analyzeCompletionPatterns(y),suggestion:t.suggestScheduleOptimization(y),anomalies:t.detectAnomalies(y)}))),a=Q(()=>i(n).sort((y,_)=>_.insight.confidence-y.insight.confidence));function o(y,_){var D;(D=e.onApplySuggestion)==null||D.call(e,y,_)}function l(y){if(Math.abs(y)<60)return`${Math.abs(y)} minutes`;const _=Math.abs(Math.round(y/60));return`${_} hour${_!==1?"s":""}`}function c(y){const _=y>=12?"PM":"AM";return`${y>12?y-12:y===0?12:y}:00 ${_}`}function u(y){return y>=.8?"Excellent":y>=.6?"Good":y>=.4?"Fair":"Inconsistent"}function h(y){return y>=.8?"#4caf50":y>=.6?"#2196f3":y>=.4?"#ff9800":"#f44336"}function p(y){switch(y){case"low":return"#ff9800";case"medium":return"#ff5722";case"high":return"#f44336"}}var v=Of(),m=f(d(v),2);{var k=y=>{var _=Tf();T(y,_)},g=y=>{var _=Mf();Fe(_,21,()=>i(a),rt,(D,x)=>{let E=()=>i(x).task,O=()=>i(x).insight,z=()=>i(x).suggestion,q=()=>i(x).anomalies;var K=If(),Y=d(K),J=d(Y),ne=d(J),te=f(J,2),oe=d(te),pe=f(Y,2),W=d(pe),F=f(d(W),2),C=d(F),U=f(W,2),re=f(d(U),2),ee=d(re),ye=f(U,2),de=f(d(ye),2),ue=d(de),xe=f(ye,2),_e=f(d(xe),2),Re=d(_e),le=f(pe,2);{var P=X=>{var fe=Sf(),me=f(d(fe),2),ge=d(me);j(()=>M(ge,O().suggestedAdjustment)),T(X,fe)};H(le,X=>{O().suggestedAdjustment&&X(P)})}var S=f(le,2);{var L=X=>{var fe=Df(),me=f(d(fe),2),ge=d(me),Ee=f(d(ge),2),Ae=d(Ee),He=f(ge,4),Ve=f(d(He),2),Ke=d(Ve),Xe=f(me,2),it=d(Xe),Ce=f(Xe,2),ct=d(Ce),Ue=f(Ce,2);Ue.__click=()=>o(E(),z()),j(()=>{M(Ae,z().currentSchedule.time||"Not set"),M(Ke,z().suggestedSchedule.time||"Not set"),M(it,z().reason),M(ct,`Expected: ${z().expectedImprovement??""}`)}),T(X,fe)};H(S,X=>{z()&&X(L)})}var V=f(S,2);{var ae=X=>{var fe=Ef(),me=f(d(fe),2);Fe(me,17,q,rt,(ge,Ee)=>{var Ae=xf(),He=d(Ae),Ve=d(He),Ke=d(Ve),Xe=f(Ve,2),it=d(Xe),Ce=f(He,2),ct=d(Ce),Ue=f(Ce,2),Ze=d(Ue);j((Je,kt,wt)=>{vs(Ae,`border-left-color: ${Je??""}`),M(Ke,kt),vs(Xe,`background-color: ${wt??""}`),M(it,i(Ee).severity),M(ct,i(Ee).description),M(Ze,`💡 ${i(Ee).suggestion??""}`)},[()=>p(i(Ee).severity),()=>i(Ee).type.replace(/_/g," "),()=>p(i(Ee).severity)]),T(ge,Ae)}),T(X,fe)};H(V,X=>{q().length>0&&X(ae)})}var I=f(V,2);{var R=X=>{var fe=Cf(),me=d(fe),ge=d(me),Ee=f(me,2);{var Ae=He=>{var Ve=Af(),Ke=d(Ve);j(Xe=>M(Ke,`Last updated: ${Xe??""}`),[()=>new Date(E().learningMetrics.lastLearningUpdate).toLocaleDateString()]),T(He,Ve)};H(Ee,He=>{E().learningMetrics&&He(Ae)})}j(()=>M(ge,`📊 ${E().completionHistory.length??""} completions tracked`)),T(X,fe)};H(I,X=>{E().completionHistory&&E().completionHistory.length>0&&X(R)})}j((X,fe,me,ge,Ee,Ae,He)=>{M(ne,E().name),vs(te,`background-color: ${X??""}`),M(oe,`${fe??""}% confidence`),vs(F,`color: ${me??""}`),M(C,ge),M(ee,`${O().averageCompletionDelay>0?"+":""}${Ee??""}`),M(ue,Ae),M(Re,`${He??""}%`)},[()=>h(O().confidence),()=>Math.round(O().confidence*100),()=>h(O().completionConsistency),()=>u(O().completionConsistency),()=>l(O().averageCompletionDelay),()=>c(O().preferredTimeOfDay),()=>Math.round(100-O().missedTaskFrequency)]),T(D,K)}),T(y,_)};H(m,y=>{i(s).length===0?y(k):y(g,!1)})}T(r,v),at()}ft(["click"]);class Fa{static parse(e){const t=e,s=e.trim().toLowerCase().replace(/\s+/g," ");if(!s)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=s.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let a=n[1],o;const l=a.match(/^(.+?)\s+when\s+done$/),c=a.match(/^(.+?)\s+when\s+due$/);if(l?(a=l[1],o=!0):c&&(a=c[1],o=!1),a==="weekday"||a==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(a==="weekend"||a==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=this.parseOrdinalWeekdayPattern(a);if(u.matched)return u.error||u.ordinal===void 0||u.weekday===void 0?{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:u.error||"Invalid ordinal weekday pattern"}:{frequency:{type:"monthly",interval:1,dayOfMonth:1,whenDone:o,rruleString:this.buildOrdinalRRuleString(u.weekday,u.ordinal),naturalLanguage:t},raw:t,isValid:!0};const h=a.match(/^(\d+\s+)?days?$/);if(h)return{frequency:{type:"daily",interval:h[1]?parseInt(h[1]):1,whenDone:o},raw:t,isValid:!0};const p=a.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(p){const k=p[1]?parseInt(p[1]):1,g=p[2];if(!g)return{frequency:{type:"weekly",interval:k,weekdays:[1],whenDone:o},raw:t,isValid:!0};const y=this.parseDayNames(g);return y.length===0?{frequency:{type:"weekly",interval:k,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:k,weekdays:y,whenDone:o},raw:t,isValid:!0}}const v=a.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(v){const k=v[1]?parseInt(v[1]):1,g=v[2]?parseInt(v[2]):1;return g<1||g>31?{frequency:{type:"monthly",interval:k,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:k,dayOfMonth:g,whenDone:o},raw:t,isValid:!0}}const m=a.match(/^(\d+\s+)?years?$/);return m?{frequency:{type:"yearly",interval:m[1]?parseInt(m[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=this.stringifyOrdinalWeekday(e.rruleString);if(t)return e.whenDone?`${t} when done`:t;const s=e.interval;let n;switch(e.type){case"daily":n=s===1?"every day":`every ${s} days`;break;case"weekly":{const a=s===1?"week":`${s} weeks`;if(e.weekdays.length===0)n=`every ${a}`;else{const o=e.weekdays.map(l=>this.getDayName(l)).join(", ");n=`every ${a} on ${o}`}break}case"monthly":{const a=s===1?"month":`${s} months`,o=this.getDaySuffix(e.dayOfMonth);n=`every ${a} on the ${e.dayOfMonth}${o}`;break}case"yearly":{n=`every ${s===1?"year":`${s} years`}`;break}default:n="every day"}return e.whenDone?`${n} when done`:n}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},s=e.split(",").map(a=>a.trim().toLowerCase()),n=[];for(const a of s)a in t&&n.push(t[a]);return n}static parseOrdinalWeekdayPattern(e){const t=e.split(" ");if(t.length<2)return{matched:!1};const s=this.parseOrdinalToken(t[0]);if(!s.matched)return{matched:!1};if(s.error)return{matched:!0,error:s.error};const n=this.parseSingleDay(t[1]);return n===null?{matched:!0,error:"Invalid weekday name"}:t.length===2?{matched:!0,ordinal:s.value,weekday:n}:t.length===5&&t[2]==="of"&&t[3]==="the"&&t[4]==="month"?{matched:!0,ordinal:s.value,weekday:n}:{matched:!0,error:"Ordinal weekday pattern must be 'every <ordinal> <weekday>' optionally followed by 'of the month'"}}static parseOrdinalToken(e){const t={first:1,second:2,third:3,fourth:4,last:-1};if(e in t)return{matched:!0,value:t[e]};const s=e.match(/^(\d+)(st|nd|rd|th)$/);if(!s)return{matched:!1};const n=parseInt(s[1],10);return n>=1&&n<=4?{matched:!0,value:n}:{matched:!0,error:"Ordinal weekday must be first, second, third, fourth, or last"}}static parseSingleDay(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6};return e in t?t[e]:null}static stringifyOrdinalWeekday(e){if(!e)return null;const t=this.parseRRuleString(e);if(!t||t.FREQ!=="MONTHLY"||!t.BYDAY||!t.BYSETPOS)return null;const s=this.fromRRuleWeekday(t.BYDAY);if(s===null)return null;const n=Number.parseInt(t.BYSETPOS,10);if(!Number.isFinite(n))return null;const a=this.ordinalWord(n);return a?`every ${a} ${this.getDayName(s)}`:null}static ordinalWord(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";case 4:return"fourth";case-1:return"last";default:return null}}static buildOrdinalRRuleString(e,t){return`RRULE:FREQ=MONTHLY;BYDAY=${this.toRRuleWeekday(e)};BYSETPOS=${t}`}static toRRuleWeekday(e){return["MO","TU","WE","TH","FR","SA","SU"][e]||"MO"}static fromRRuleWeekday(e){const s=["MO","TU","WE","TH","FR","SA","SU"].indexOf(e);return s>=0?s:null}static parseRRuleString(e){const t=e.trim().toUpperCase(),s=t.startsWith("RRULE:")?t.slice(6):t;if(!s)return null;const n=s.split(";"),a={};for(const o of n){if(!o)continue;const[l,c]=o.split("=");if(!l||!c)return null;a[l]=c}return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var qf=A('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),Rf=A('<div class="priority-selector svelte-1w15n9q"></div>');function Lf(r,e){nt(e,!0);let t=Ls(e,"value",15,"normal");const s=[{value:"highest",label:"Highest",emoji:"🔺",color:"var(--b3-theme-error, #ef4444)"},{value:"high",label:"High",emoji:"⏫",color:"#f97316"},{value:"medium",label:"Medium",emoji:"🔼",color:"#f59e0b"},{value:"normal",label:"Normal",emoji:"🟡",color:"#eab308"},{value:"low",label:"Low",emoji:"🔽",color:"#22c55e"},{value:"lowest",label:"Lowest",emoji:"⏬",color:"#64748b"}];function n(o){t(o),e.onchange(o)}var a=Rf();Fe(a,21,()=>s,rt,(o,l)=>{var c=qf();let u;var h=d(c);h.__change=()=>n(i(l).value);var p=f(h,2),v=d(p),m=f(p,2),k=d(m);j(()=>{u=Ge(c,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===i(l).value}),vs(c,`--priority-color: ${i(l).color??""}`),di(h,i(l).value),zr(h,t()===i(l).value),M(v,i(l).emoji),M(k,i(l).label)}),T(o,c)}),T(r,a),at()}ft(["change"]);var Ff=A('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),zf=A('<div class="status-selector svelte-v9ezc0"></div>');function Pf(r,e){nt(e,!0);let t=Ls(e,"value",15,"todo");const s=[{value:"todo",label:"Todo",icon:"○",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"✓",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"✕",color:"#999"}];function n(o){t(o),e.onchange(o)}var a=zf();Fe(a,21,()=>s,rt,(o,l)=>{var c=Ff();let u;var h=d(c);h.__change=()=>n(i(l).value);var p=f(h,2),v=d(p),m=f(p,2),k=d(m);j(()=>{u=Ge(c,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===i(l).value}),vs(c,`--status-color: ${i(l).color??""}`),di(h,i(l).value),zr(h,t()===i(l).value),M(v,i(l).icon),M(k,i(l).label)}),T(o,c)}),T(r,a),at()}ft(["change"]);var Bf=A('<div class="recurrence-input__valid svelte-787fjp">✓ Valid recurrence pattern</div>'),Uf=A('<div class="recurrence-input__error svelte-787fjp"> </div>'),jf=A('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),Yf=A('<li class="svelte-787fjp"> </li>'),Hf=A('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),Wf=A('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function Kf(r,e){nt(e,!0);let t=Ls(e,"value",15,""),s=Ls(e,"showPreview",3,!0);const n=Q(()=>Fa.parse(t())),a=Q(()=>i(n).isValid),o=Q(()=>i(n).error);function l(_,D=3){const x=[],E=new Date;for(let O=0;O<D;O++){const z=new Date(E);switch(_.type){case"daily":z.setDate(E.getDate()+O*_.interval);break;case"weekly":z.setDate(E.getDate()+O*_.interval*7);break;case"monthly":z.setMonth(E.getMonth()+O*_.interval);break;case"yearly":z.setFullYear(E.getFullYear()+O*_.interval);break}x.push(z.toLocaleDateString())}return x}const c=Q(()=>i(a)&&s()?l(i(n).frequency):[]);function u(_){const x=_.target.value;t(x);const E=Fa.parse(x);e.onchange(x,E.isValid?E.frequency:null,E.isValid)}var h=Wf(),p=d(h);let v;p.__input=u;var m=f(p,2);{var k=_=>{var D=jf(),x=d(D);{var E=z=>{var q=Bf();T(z,q)},O=z=>{var q=Uf(),K=d(q);j(()=>M(K,`⚠ ${(i(o)||"Invalid recurrence pattern")??""}`)),T(z,q)};H(x,z=>{i(a)?z(E):z(O,!1)})}T(_,D)};H(m,_=>{t().length>0&&_(k)})}var g=f(m,2);{var y=_=>{var D=Hf(),x=f(d(D),2);Fe(x,21,()=>i(c),rt,(E,O)=>{var z=Yf(),q=d(z);j(()=>M(q,i(O))),T(E,z)}),T(_,D)};H(g,_=>{i(a)&&s()&&i(c).length>0&&_(y)})}j(()=>{v=Ge(p,1,"recurrence-input__field svelte-787fjp",null,v,{valid:i(a),invalid:!i(a)&&t().length>0}),Me(p,"aria-invalid",!i(a)&&t().length>0)}),dt(p,t),T(r,h),at()}ft(["input"]);var Gf=A('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">✕</button></div>'),$f=A('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),Qf=A('<span class="dependency-picker__option-check svelte-10ls0lk">✓</span>'),Vf=A('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Xf=A('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),Zf=A('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function co(r,e){nt(e,!0);let t=Ls(e,"selected",31,()=>De([])),s=Ls(e,"label",3,"Select tasks"),n=G(""),a=G(!1);const o=Q(()=>e.repository.getAllTasks().filter(z=>z.id!==e.excludeId)),l=Q(()=>i(n).trim()?i(o).filter(z=>z.name.toLowerCase().includes(i(n).toLowerCase())):i(o)),c=Q(()=>i(o).filter(z=>t().includes(z.id)));function u(z){if(!t().includes(z)){const q=[...t(),z];t(q),e.onchange(q)}b(n,""),b(a,!1)}function h(z){const q=t().filter(K=>K!==z);t(q),e.onchange(q)}function p(){b(a,!0)}function v(){setTimeout(()=>{b(a,!1)},200)}var m=Zf(),k=d(m),g=d(k),y=f(k,2);{var _=z=>{var q=$f();Fe(q,21,()=>i(c),K=>K.id,(K,Y)=>{var J=Gf(),ne=d(J),te=d(ne),oe=f(ne,2);oe.__click=()=>h(i(Y).id),j(()=>{M(te,i(Y).name),Me(oe,"aria-label",`Remove ${i(Y).name??""}`)}),T(K,J)}),T(z,q)};H(y,z=>{i(c).length>0&&z(_)})}var D=f(y,2),x=d(D),E=f(x,2);{var O=z=>{var q=Xf();Fe(q,21,()=>i(l).slice(0,10),K=>K.id,(K,Y)=>{var J=Vf();let ne;J.__click=()=>u(i(Y).id);var te=d(J),oe=d(te),pe=f(te,2);{var W=F=>{var C=Qf();T(F,C)};H(pe,F=>{t().includes(i(Y).id)&&F(W)})}j((F,C)=>{ne=Ge(J,1,"dependency-picker__option svelte-10ls0lk",null,ne,F),J.disabled=C,M(oe,i(Y).name)},[()=>({selected:t().includes(i(Y).id)}),()=>t().includes(i(Y).id)]),T(K,J)}),T(z,q)};H(E,z=>{i(a)&&i(l).length>0&&z(O)})}j(()=>M(g,s())),At("focus",x,p),At("blur",x,v),dt(x,()=>i(n),z=>b(n,z)),T(r,m),at()}ft(["click"]);var Jf=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),ev=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),tv=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),sv=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),rv=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),nv=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),av=A('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">✕</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">💡 Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">⌘/Ctrl+Enter</kbd> to save</div></div></div>');function Pl(r,e){var Ie,ze,pt,Pt,Tt,Ht,St,Bt,js,Wt,cs,Kt;nt(e,!0);const t="every day",s="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",a=!e.task;let o=G(De(((Ie=e.task)==null?void 0:Ie.name)||"")),l=G(De(((ze=e.task)==null?void 0:ze.description)||"")),c=G(De(((pt=e.task)==null?void 0:pt.priority)||"normal")),u=G(De(((Pt=e.task)==null?void 0:Pt.status)||"todo")),h=G(De((Tt=e.task)!=null&&Tt.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),p=G(De((Ht=e.task)!=null&&Ht.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),v=G(De((St=e.task)!=null&&St.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),m=G(De(((Bt=e.task)==null?void 0:Bt.recurrenceText)||((js=e.task)!=null&&js.frequency?Fa.stringify(e.task.frequency):t))),k=G(De(((Wt=e.task)==null?void 0:Wt.frequency)||null)),g=G(!0),y=G(De(((cs=e.task)==null?void 0:cs.blockedBy)||[])),_=G(De(((Kt=e.task)==null?void 0:Kt.dependsOn)||[])),D=G(De({name:!1,dueAt:!1,recurrence:!1})),x=G(!1),E=G(null);const O=Q(()=>i(D).name&&!i(o).trim()?"Task name is required":""),z=Q(()=>i(D).dueAt?i(h)?Number.isNaN(new Date(i(h)).getTime())?"Invalid due date":"":"Due date is required":""),q=Q(()=>i(D).recurrence&&!i(g)?"Invalid recurrence pattern":""),K=Q(()=>!!(i(O)||i(z)||i(q)));Sn(()=>{requestAnimationFrame(()=>{var B;(B=i(E))==null||B.focus()})});function Y(B,ve,tt){b(m,B,!0),b(k,ve,!0),b(g,tt,!0),i(D).recurrence=!0}function J(B){b(c,B,!0)}function ne(B){b(u,B,!0)}function te(B){b(y,B,!0)}function oe(B){b(_,B,!0)}async function pe(){if(b(D,{name:!0,dueAt:!0,recurrence:!0},!0),i(K)){$.warning("Please fix validation errors");return}if(!i(k)){$.error("Invalid recurrence pattern");return}b(x,!0);try{let B;a?B=Il(i(o).trim(),i(k),new Date(i(h))):(B={...e.task},B.name=i(o).trim(),B.frequency=i(k),B.dueAt=new Date(i(h)).toISOString()),B.description=i(l).trim()||void 0,B.priority=i(c),B.status=i(u),B.recurrenceText=i(m),B.scheduledAt=i(p)?new Date(i(p)).toISOString():void 0,B.startAt=i(v)?new Date(i(v)).toISOString():void 0,B.blockedBy=i(y).length>0?i(y):void 0,B.dependsOn=i(_).length>0?i(_):void 0,B.updatedAt=new Date().toISOString(),i(u)==="done"&&!B.lastCompletedAt&&(B.lastCompletedAt=new Date().toISOString()),i(u)==="cancelled"&&!B.cancelledAt&&(B.cancelledAt=new Date().toISOString()),await e.repository.saveTask(B),e.onSave&&e.onSave(B),$.success(`Task "${B.name}" ${a?"created":"updated"}`),Ye.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(B){$.error(`Failed to save task: ${B}`)}finally{b(x,!1)}}function W(B){B.key==="Escape"&&e.onClose(),(B.metaKey||B.ctrlKey)&&B.key==="Enter"&&(B.preventDefault(),pe())}function F(B){return B?new Date(B).toLocaleString():"—"}var C=av();C.__keydown=W;var U=d(C),re=d(U),ee=d(re),ye=d(ee),de=f(ee,2);de.__click=function(...B){var ve;(ve=e.onClose)==null||ve.apply(this,B)};var ue=f(re,2),xe=d(ue),_e=f(d(xe),2);_e.__input=()=>i(D).name=!0,ps(_e,B=>b(E,B),()=>i(E));var Re=f(_e,2);{var le=B=>{var ve=Jf(),tt=d(ve);j(()=>M(tt,i(O))),T(B,ve)};H(Re,B=>{i(O)&&B(le)})}var P=f(xe,2),S=f(d(P),2),L=f(P,2),V=f(d(L),2);Lf(V,{get value(){return i(c)},onchange:J});var ae=f(L,2),I=f(d(ae),2);Pf(I,{get value(){return i(u)},onchange:ne});var R=f(ae,2),X=f(d(R),2);X.__input=()=>i(D).dueAt=!0;var fe=f(X,2);{var me=B=>{var ve=ev(),tt=d(ve);j(()=>M(tt,i(z))),T(B,ve)};H(fe,B=>{i(z)&&B(me)})}var ge=f(R,2),Ee=f(d(ge),2),Ae=f(ge,2),He=f(d(Ae),2),Ve=f(Ae,2),Ke=f(d(Ve),2);Kf(Ke,{get value(){return i(m)},onchange:Y,showPreview:!0});var Xe=f(Ke,2);{var it=B=>{var ve=tv(),tt=d(ve);j(()=>M(tt,i(q))),T(B,ve)};H(Xe,B=>{i(q)&&B(it)})}var Ce=f(Ve,2),ct=d(Ce);{let B=Q(()=>{var ve;return(ve=e.task)==null?void 0:ve.id});co(ct,{get repository(){return e.repository},get selected(){return i(y)},get excludeId(){return i(B)},onchange:te,label:s})}var Ue=f(Ce,2),Ze=d(Ue);{let B=Q(()=>{var ve;return(ve=e.task)==null?void 0:ve.id});co(Ze,{get repository(){return e.repository},get selected(){return i(_)},get excludeId(){return i(B)},onchange:oe,label:n})}var Je=f(Ue,2),kt=d(Je),wt=f(d(kt),2),zt=d(wt),ie=f(kt,2);{var ce=B=>{var ve=sv(),tt=f(d(ve),2),Zt=d(tt);j(Jt=>M(Zt,Jt),[()=>F(e.task.lastCompletedAt)]),T(B,ve)};H(ie,B=>{var ve;(ve=e.task)!=null&&ve.lastCompletedAt&&B(ce)})}var Se=f(ie,2);{var ot=B=>{var ve=rv(),tt=f(d(ve),2),Zt=d(tt);j(Jt=>M(Zt,Jt),[()=>F(e.task.cancelledAt)]),T(B,ve)};H(Se,B=>{var ve;(ve=e.task)!=null&&ve.cancelledAt&&B(ot)})}var xs=f(Se,2);{var se=B=>{var ve=nv(),tt=f(d(ve),2),Zt=d(tt);j(()=>M(Zt,e.task.linkedBlockId)),T(B,ve)};H(xs,B=>{var ve;(ve=e.task)!=null&&ve.linkedBlockId&&B(se)})}var we=f(ue,2),je=d(we);je.__click=function(...B){var ve;(ve=e.onClose)==null||ve.apply(this,B)};var et=f(je,2);et.__click=pe;var ke=d(et);j(B=>{M(ye,a?"Create Task":"Edit Task"),Me(_e,"aria-invalid",!!i(O)),Me(X,"aria-invalid",!!i(z)),M(zt,B),et.disabled=i(x),M(ke,i(x)?"Saving...":a?"Create Task":"Save Changes")},[()=>{var B;return F((B=e.task)==null?void 0:B.createdAt)}]),At("blur",_e,()=>i(D).name=!0),dt(_e,()=>i(o),B=>b(o,B)),dt(S,()=>i(l),B=>b(l,B)),At("blur",X,()=>i(D).dueAt=!0),dt(X,()=>i(h),B=>b(h,B)),dt(Ee,()=>i(p),B=>b(p,B)),dt(He,()=>i(v),B=>b(v,B)),T(r,C),at()}ft(["keydown","click","input"]);class iv{constructor(e){w(this,"config");w(this,"compiledExcludeFolders",[]);w(this,"compiledExcludeNotebooks",[]);w(this,"compiledExcludeTags",[]);w(this,"compiledExcludeFilePatterns",[]);w(this,"statusRegistry",ys.getInstance());this.config=e,this.compileExclusions()}evaluate(e,t){if(!this.config.enabled)return!0;if(!this.passesExclusions(e,t))return!1;if(this.config.mode==="all")return!0;const s=this.config.rules.filter(l=>l.enabled);if(s.length===0)return!0;const n=s.map(l=>this.evaluateRule(l,e,t)),a=n.every(l=>l),o=n.some(l=>l);return this.config.mode==="include"?a:!o}updateConfig(e){this.config=e,this.compileExclusions()}getConfig(){return this.config}evaluateRule(e,t,s){switch(e.type){case"tag":const n=this.extractTags(t),a=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${a}$`);return n.some(c=>o.test(c));case"regex":try{const c=e.pattern.match(/^\/(.+)\/([gimsuy]*)$/);let u;return c?u=new RegExp(c[1],c[2]):u=new RegExp(e.pattern),u.test(t)}catch{return!1}case"path":return s?this.normalizePath(s).includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}evaluateTask(e){if(!this.config.enabled)return!0;const t=e.linkedBlockContent??e.name??"",s=e.path;if(!this.passesExclusions(t,s,e.statusSymbol,e.tags))return!1;if(this.config.mode==="all")return!0;const n=this.config.rules.filter(c=>c.enabled);if(n.length===0)return!0;const a=n.map(c=>this.evaluateRule(c,t,s)),o=a.every(c=>c),l=a.some(c=>c);return this.config.mode==="include"?o:!l}extractTags(e){return e.match(/#[\w/-]+/g)||[]}passesExclusions(e,t,s,n){const a=t?this.normalizePath(t):void 0,o=n??this.extractTags(e);if(a&&(this.compiledExcludeFolders.some(l=>l.test(a))||this.compiledExcludeNotebooks.some(l=>l.test(a))||this.compiledExcludeFilePatterns.some(l=>l.test(a)))||o.length>0&&this.compiledExcludeTags.length>0&&o.some(l=>this.compiledExcludeTags.some(c=>c.test(l))))return!1;if(this.config.excludeStatusTypes.length>0){const l=this.resolveStatusType(s,e);if(l&&this.config.excludeStatusTypes.includes(l))return!1}return!0}resolveStatusType(e,t){const s=e??this.extractStatusSymbol(t??"");return s?this.statusRegistry.get(s).type:null}extractStatusSymbol(e){const t=e.match(/^\s*-\s*\[(.)\]/);return t?t[1]:null}compileExclusions(){this.compiledExcludeFolders=this.config.excludeFolders.map(e=>this.compilePathPattern(e)),this.compiledExcludeNotebooks=this.config.excludeNotebooks.map(e=>this.compilePathPattern(e)),this.compiledExcludeFilePatterns=this.config.excludeFilePatterns.map(e=>this.compilePathPattern(e)),this.compiledExcludeTags=this.config.excludeTags.map(e=>this.compileTagPattern(e))}compileTagPattern(e){const t=e.trim();if(!t)return/^$/;const s=t.replace(/\*/g,".*");return new RegExp(`^${s}$`,"i")}compilePathPattern(e){const t=e.trim();if(!t)return/^$/;const s=t.match(/^\/(.+)\/([gimsuy]*)$/);if(s)try{return new RegExp(s[1],s[2])}catch{return/^$/}return this.globToRegExp(t)}globToRegExp(e){let s=this.normalizePath(e).replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*\*/g,"::DOUBLE_STAR::").replace(/\*/g,"[^/]*").replace(/::DOUBLE_STAR::/g,".*");return s.startsWith(".*")||(s=`.*${s}`),new RegExp(s)}normalizePath(e){return e.replace(/\\/g,"/")}}const yn={enabled:!1,mode:"all",rules:[],excludeFolders:[],excludeNotebooks:[],excludeTags:[],excludeFilePatterns:[],excludeStatusTypes:[]},or=class or{constructor(){w(this,"engine");this.engine=new iv(yn)}static getInstance(){return or.instance||(or.instance=new or),or.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}shouldIncludeTask(e){return this.engine.evaluateTask(e)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(yn)}};w(or,"instance",null);let Wn=or;var ov=A("<span> </span>"),lv=A("<span>Preview unavailable</span>"),cv=A('<button class="pill svelte-b8rwae" type="button"> </button>'),uv=A('<button class="pill svelte-b8rwae" type="button"> </button>'),dv=A('<button class="pill svelte-b8rwae" type="button"> </button>'),hv=A('<button class="pill svelte-b8rwae" type="button"> </button>'),fv=A('<label class="status-toggle svelte-b8rwae"><input type="checkbox"/> <span> </span></label>'),vv=A("<div> </div>"),pv=A('<pre class="query-explanation svelte-b8rwae"> </pre>'),yv=A('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Filtering &amp; Query</h3> <p class="description svelte-b8rwae">Apply a hard exclusion filter before indexing, plus a default query fragment applied to every query.</p> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Filter (Hard Exclusions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Filter</span></label></div> <div class="preview svelte-b8rwae"><!></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Folders</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/archive/**"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Notebooks</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="Personal"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Tags</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="#log"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude File Patterns (glob or /regex/)</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/templates/** or /daily/.+\\.md/"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Status Types</label> <div class="status-toggle-list svelte-b8rwae"></div></div> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Filter</button></section> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Query (Default Conditions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Query</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Global Query DSL</label> <textarea class="settings__input svelte-b8rwae" rows="4" placeholder="not done\\nnot blocked\\ndue before next 30 days"></textarea></div> <div class="query-actions svelte-b8rwae"><button class="add-btn svelte-b8rwae" type="button">Save Global Query</button> <button class="add-btn svelte-b8rwae" type="button">Validate / Explain</button> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Query</button></div> <!> <!> <p class="hint svelte-b8rwae">Use <code>ignore global query</code> on a local query line to bypass the global query for that block.</p></section></div>');function mv(r,e){nt(e,!0);const t=Wn.getInstance(),s=Vr.getInstance();let n=G(De(e.settingsService.get().globalFilter??yn)),a=G(De(e.settingsService.get().globalQuery??Hn)),o=G(""),l=G(""),c=G(""),u=G(""),h=G(null),p=G(null),v=G(null);const m=Object.values(ut);gt(()=>{E()});function k(ie){return Array.from(new Set(ie.map(ce=>ce.trim()).filter(Boolean)))}function g(ie,ce){const Se=ce.trim();Se&&(b(n,{...i(n),[ie]:k([...i(n)[ie],Se])},!0),D())}function y(ie,ce){b(n,{...i(n),[ie]:i(n)[ie].filter(Se=>Se!==ce)},!0),D()}function _(ie){const ce=new Set(i(n).excludeStatusTypes);ce.has(ie)?ce.delete(ie):ce.add(ie),b(n,{...i(n),excludeStatusTypes:Array.from(ce)},!0),D()}async function D(){t.updateConfig(i(n)),await e.settingsService.update({globalFilter:i(n)}),Ye.emit("task:settings",{source:"global-filter"}),E()}async function x(){s.updateConfig(i(a)),await e.settingsService.update({globalQuery:i(a)}),Ye.emit("task:settings",{source:"global-query"})}function E(){if(!e.repository){b(h,null);return}const ie=e.repository.getAllTasks();b(h,ie.filter(ce=>!t.shouldIncludeTask(ce)).length,!0)}async function O(){b(n,{...yn},!0),await D(),$.success("Global filter reset to defaults")}async function z(){b(a,{...Hn},!0),b(p,null),b(v,null),await x(),$.success("Global query reset to defaults")}function q(){const ie=new er;try{const ce=ie.parse(i(a).query||"");b(p,{valid:!0,message:"Global query is valid."},!0),b(v,Ll(ce),!0)}catch(ce){const Se=ce instanceof Error?ce.message:String(ce);b(p,{valid:!1,message:Se},!0),b(v,null)}}var K=yv(),Y=f(d(K),4),J=d(Y),ne=f(d(J),2),te=d(ne);te.__change=D;var oe=f(J,2),pe=d(oe);{var W=ie=>{var ce=ov(),Se=d(ce);j(()=>M(Se,`Preview: ${i(h)??""} tasks excluded (from current index)`)),T(ie,ce)},F=ie=>{var ce=lv();T(ie,ce)};H(pe,ie=>{i(h)!==null?ie(W):ie(F,!1)})}var C=f(oe,2),U=f(d(C),2);Fe(U,21,()=>i(n).excludeFolders,rt,(ie,ce)=>{var Se=cv();Se.__click=()=>y("excludeFolders",i(ce));var ot=d(Se);j(()=>M(ot,`${i(ce)??""} ✕`)),T(ie,Se)});var re=f(U,2),ee=d(re),ye=f(ee,2);ye.__click=()=>{g("excludeFolders",i(o)),b(o,"")};var de=f(C,2),ue=f(d(de),2);Fe(ue,21,()=>i(n).excludeNotebooks,rt,(ie,ce)=>{var Se=uv();Se.__click=()=>y("excludeNotebooks",i(ce));var ot=d(Se);j(()=>M(ot,`${i(ce)??""} ✕`)),T(ie,Se)});var xe=f(ue,2),_e=d(xe),Re=f(_e,2);Re.__click=()=>{g("excludeNotebooks",i(l)),b(l,"")};var le=f(de,2),P=f(d(le),2);Fe(P,21,()=>i(n).excludeTags,rt,(ie,ce)=>{var Se=dv();Se.__click=()=>y("excludeTags",i(ce));var ot=d(Se);j(()=>M(ot,`${i(ce)??""} ✕`)),T(ie,Se)});var S=f(P,2),L=d(S),V=f(L,2);V.__click=()=>{g("excludeTags",i(c)),b(c,"")};var ae=f(le,2),I=f(d(ae),2);Fe(I,21,()=>i(n).excludeFilePatterns,rt,(ie,ce)=>{var Se=hv();Se.__click=()=>y("excludeFilePatterns",i(ce));var ot=d(Se);j(()=>M(ot,`${i(ce)??""} ✕`)),T(ie,Se)});var R=f(I,2),X=d(R),fe=f(X,2);fe.__click=()=>{g("excludeFilePatterns",i(u)),b(u,"")};var me=f(ae,2),ge=f(d(me),2);Fe(ge,21,()=>m,rt,(ie,ce)=>{var Se=fv(),ot=d(Se);ot.__change=()=>_(i(ce));var xs=f(ot,2),se=d(xs);j(we=>{zr(ot,we),M(se,i(ce))},[()=>i(n).excludeStatusTypes.includes(i(ce))]),T(ie,Se)});var Ee=f(me,2);Ee.__click=O;var Ae=f(Y,2),He=d(Ae),Ve=f(d(He),2),Ke=d(Ve);Ke.__change=x;var Xe=f(He,2),it=f(d(Xe),2),Ce=f(Xe,2),ct=d(Ce);ct.__click=x;var Ue=f(ct,2);Ue.__click=q;var Ze=f(Ue,2);Ze.__click=z;var Je=f(Ce,2);{var kt=ie=>{var ce=vv(),Se=d(ce);j(()=>{Ge(ce,1,`validation ${i(p).valid?"success":"error"}`,"svelte-b8rwae"),M(Se,i(p).message)}),T(ie,ce)};H(Je,ie=>{i(p)&&ie(kt)})}var wt=f(Je,2);{var zt=ie=>{var ce=pv(),Se=d(ce);j(()=>M(Se,i(v))),T(ie,ce)};H(wt,ie=>{i(v)&&ie(zt)})}Oa(te,()=>i(n).enabled,ie=>i(n).enabled=ie),dt(ee,()=>i(o),ie=>b(o,ie)),dt(_e,()=>i(l),ie=>b(l,ie)),dt(L,()=>i(c),ie=>b(c,ie)),dt(X,()=>i(u),ie=>b(u,ie)),Oa(Ke,()=>i(a).enabled,ie=>i(a).enabled=ie),dt(it,()=>i(a).query,ie=>i(a).query=ie),T(r,K),at()}ft(["change","click"]);var gv=A('<button class="delete-btn svelte-1qw3eru">Delete</button>'),bv=A('<span class="default-badge svelte-1qw3eru">Default</span>'),_v=A('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),kv=A('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function wv(r,e){nt(e,!0);let t=ys.getInstance(),s=G(De([])),n=G(""),a=G(""),o=G(De(ut.TODO)),l=G("x");function c(){b(s,t.getAll(),!0)}function u(){if(!i(n).trim()||!i(a).trim()){$.error("Symbol and name are required");return}if(i(n).length!==1){$.error("Symbol must be a single character");return}const le={symbol:i(n),name:i(a),type:i(o),nextStatusSymbol:i(l)},P=new As(le);t.register(P),c(),v(),$.success(`Status "${i(a)}" added`)}function h(le){if([" ","x","/","-"].includes(le)){$.error("Cannot delete default status");return}t.unregister(le),c(),$.success("Status deleted")}function p(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),c(),$.success("Statuses reset to defaults"))}function v(){b(n,""),b(a,""),b(o,ut.TODO,!0),b(l,"x")}gt(()=>{c()});var m=kv(),k=f(d(m),4),g=d(k),y=d(g),_=f(d(y));Fe(_,21,()=>i(s),rt,(le,P)=>{var S=_v(),L=d(S),V=d(L),ae=d(V),I=f(L),R=d(I),X=f(I),fe=d(X),me=d(fe),ge=f(X),Ee=d(ge),Ae=d(Ee),He=f(ge),Ve=d(He),Ke=d(Ve),Xe=f(He),it=d(Xe);{var Ce=Ue=>{var Ze=gv();Ze.__click=()=>h(i(P).symbol),T(Ue,Ze)},ct=Ue=>{var Ze=bv();T(Ue,Ze)};H(it,Ue=>{[" ","x","/","-"].includes(i(P).symbol)?Ue(ct,!1):Ue(Ce)})}j(()=>{M(ae,`[${i(P).symbol??""}]`),M(R,i(P).name),M(me,i(P).type),M(Ae,`[${i(P).nextStatusSymbol??""}]`),M(Ke,`- [${i(P).symbol??""}] Task example`)}),T(le,S)});var D=f(k,2),x=f(d(D),2),E=d(x),O=d(E),z=f(d(O),2),q=f(O,2),K=f(d(q),2),Y=f(q,2),J=f(d(Y),2),ne=d(J),te={},oe=f(ne),pe={},W=f(oe),F={},C=f(W),U={},re=f(C),ee={},ye=f(Y,2),de=f(d(ye),2),ue=f(ye,2),xe=f(d(ue),2);xe.__click=u;var _e=f(D,2),Re=d(_e);Re.__click=p,j(()=>{te!==(te=ut.TODO)&&(ne.value=(ne.__value=ut.TODO)??""),pe!==(pe=ut.IN_PROGRESS)&&(oe.value=(oe.__value=ut.IN_PROGRESS)??""),F!==(F=ut.DONE)&&(W.value=(W.__value=ut.DONE)??""),U!==(U=ut.CANCELLED)&&(C.value=(C.__value=ut.CANCELLED)??""),ee!==(ee=ut.NON_TASK)&&(re.value=(re.__value=ut.NON_TASK)??"")}),dt(z,()=>i(n),le=>b(n,le)),dt(K,()=>i(a),le=>b(a,le)),zu(J,()=>i(o),le=>b(o,le)),dt(de,()=>i(l),le=>b(l,le)),T(r,m),at()}ft(["click"]);var Tv=A('<button class="settings__close-btn svelte-1ke3hir">✕</button>'),Sv=A("<div> </div>"),Dv=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),xv=A('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Ev=A('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"><input class="settings__shortcut-input svelte-1ke3hir" type="text" placeholder="Unassigned"/> <div class="settings__shortcut-actions svelte-1ke3hir"><button class="settings__shortcut-btn svelte-1ke3hir" type="button">Save</button> <button class="settings__shortcut-btn settings__shortcut-btn--ghost svelte-1ke3hir" type="button">Reset</button></div> <div class="settings__shortcut-default svelte-1ke3hir"> </div></div></div>'),Av=A(`<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div> <button class="settings__shortcut-reset-all svelte-1ke3hir" type="button">Reset all shortcuts</button> <p class="settings__shortcut-note svelte-1ke3hir">Tip: You can also customize these in SiYuan's native shortcut settings.</p></section>`),Cv=A('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),Iv=A('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filtering & Query</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function Mv(r,e){nt(e,!0);let t=G(De(Na)),s=G(null),n=De({}),a=G("general"),o=G(De([])),l=G(De({}));function c(){if(!e.shortcutManager){b(o,[],!0),b(l,{},!0);return}b(o,e.shortcutManager.getShortcutDisplay(),!0),b(l,i(o).reduce((W,F)=>(W[F.id]=F.currentHotkey||"",W),{}),!0)}function u(W,F){b(l,{...i(l),[W]:F},!0)}async function h(W){if(!e.shortcutManager)return;const F=await e.shortcutManager.updateShortcut(W,i(l)[W]??"");if(!F.success){$.error(F.message||"Failed to update shortcut.");return}$.success("Shortcut updated."),c()}async function p(W){e.shortcutManager&&(await e.shortcutManager.resetShortcut(W),$.success("Shortcut reset."),c())}async function v(){e.shortcutManager&&(await e.shortcutManager.resetAllShortcuts(),$.success("Shortcuts reset to defaults."),c())}gt(()=>{b(t,e.eventService.getConfig(),!0)}),gt(()=>{c()});async function m(){try{await e.eventService.saveConfig(i(t)),$.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(W){$.error("Failed to save settings: "+W)}}async function k(){b(s,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const W=await e.eventService.testConnection();n.n8n={success:W.success,message:W.success?"Test successful!":W.message||"Test failed. Check configuration."}}catch(W){n.n8n={success:!1,message:"Error: "+(W instanceof Error?W.message:String(W))}}finally{b(s,null)}}var g=Iv(),y=d(g),_=f(d(y),2);{var D=W=>{var F=Tv();F.__click=function(...C){var U;(U=e.onClose)==null||U.apply(this,C)},T(W,F)};H(_,W=>{e.onClose&&W(D)})}var x=f(y,2),E=d(x),O=d(E);O.__click=()=>b(a,"general");var z=f(O,2);z.__click=()=>b(a,"filter");var q=f(z,2);q.__click=()=>b(a,"statuses");var K=f(q,2);K.__click=()=>b(a,"shortcuts");var Y=f(E,2),J=d(Y);{var ne=W=>{var F=Dv(),C=d(F),U=f(d(C),2),re=d(U),ee=f(C,2),ye=f(d(ee),2),de=f(ee,2),ue=f(d(de),2),xe=f(de,2);xe.__click=k;var _e=d(xe),Re=f(xe,2);{var le=P=>{var S=Sv(),L=d(S);j(()=>{Ge(S,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),M(L,n.n8n.message)}),T(P,S)};H(Re,P=>{n.n8n&&P(le)})}j(()=>{ye.disabled=!i(t).n8n.enabled,ue.disabled=!i(t).n8n.enabled,xe.disabled=!i(t).n8n.enabled||i(s)==="n8n",M(_e,i(s)==="n8n"?"Testing...":"Test Connection")}),Oa(re,()=>i(t).n8n.enabled,P=>i(t).n8n.enabled=P),dt(ye,()=>i(t).n8n.webhookUrl,P=>i(t).n8n.webhookUrl=P),dt(ue,()=>i(t).n8n.sharedSecret,P=>i(t).n8n.sharedSecret=P),T(W,F)},te=W=>{var F=lt(),C=$e(F);{var U=ee=>{mv(ee,{get settingsService(){return e.settingsService},get repository(){return e.repository}})},re=ee=>{var ye=lt(),de=$e(ye);{var ue=_e=>{wv(_e,{})},xe=_e=>{var Re=lt(),le=$e(Re);{var P=S=>{var L=Av(),V=f(d(L),2);Fe(V,21,()=>i(o),rt,(I,R)=>{var X=Ev(),fe=d(X),me=d(fe),ge=d(me),Ee=f(me,2),Ae=d(Ee),He=f(Ee,2);{var Ve=Je=>{var kt=xv(),wt=d(kt);j(()=>M(wt,i(R).context)),T(Je,kt)};H(He,Je=>{i(R).context&&Je(Ve)})}var Ke=f(fe,2),Xe=d(Ke);Xe.__input=Je=>u(i(R).id,Je.currentTarget.value);var it=f(Xe,2),Ce=d(it);Ce.__click=()=>h(i(R).id);var ct=f(Ce,2);ct.__click=()=>p(i(R).id);var Ue=f(it,2),Ze=d(Ue);j(()=>{M(ge,i(R).label),M(Ae,i(R).description),di(Xe,i(l)[i(R).id]??""),M(Ze,`Default: ${(i(R).defaultHotkey||"Unassigned")??""}`)}),T(I,X)});var ae=f(V,2);ae.__click=v,T(S,L)};H(le,S=>{i(a)==="shortcuts"&&S(P)},!0)}T(_e,Re)};H(de,_e=>{i(a)==="statuses"?_e(ue):_e(xe,!1)},!0)}T(ee,ye)};H(C,ee=>{i(a)==="filter"?ee(U):ee(re,!1)},!0)}T(W,F)};H(J,W=>{i(a)==="general"?W(ne):W(te,!1)})}var oe=f(x,2);{var pe=W=>{var F=Cv(),C=d(F);C.__click=m,T(W,F)};H(oe,W=>{i(a)==="general"&&W(pe)})}j(()=>{Ge(O,1,`settings__nav-btn ${i(a)==="general"?"active":""}`,"svelte-1ke3hir"),Ge(z,1,`settings__nav-btn ${i(a)==="filter"?"active":""}`,"svelte-1ke3hir"),Ge(q,1,`settings__nav-btn ${i(a)==="statuses"?"active":""}`,"svelte-1ke3hir"),Ge(K,1,`settings__nav-btn ${i(a)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),T(r,g),at()}ft(["click","input"]);var Ov=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Nv=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),qv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Rv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Lv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Fv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),zv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Pv=A('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>Blocking</button> <button>High Priority</button></div>'),Bv=A('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">📥 Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">📋 Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">📅 Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">✅ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">📁 Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">🔍 Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">📝 All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button> <button id="dashboard-tab-insights" role="tab" aria-controls="dashboard-panel">💡 Insights</button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),Uv=A('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">⚙️ Settings</button></div></div> <!></div>');function jv(r,e){nt(e,!0),Gc(mi,e.settingsService.get().urgency);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let n=G("today"),a=G(!1),o=G(!1),l=G(void 0),c=G(De(new Set)),u=G(De([])),h=Q(()=>dd(i(u))),p=G(!1);const v=Q(()=>["inbox","today","upcoming","done","projects","search","all","insights"].includes(i(n))?`dashboard-tab-${i(n)}`:void 0),m=Q(()=>()=>{let S=i(u);if(i(c).has("notDone")&&(S=S.filter(L=>L.status!=="done"&&L.status!=="cancelled")),i(c).has("dueToday")){const L=new Date;L.setHours(0,0,0,0);const V=new Date(L);V.setDate(V.getDate()+1),S=S.filter(ae=>{if(!ae.dueAt)return!1;const I=new Date(ae.dueAt);return I>=L&&I<V})}if(i(c).has("overdue")){const L=new Date;L.setHours(0,0,0,0),S=S.filter(V=>!V.dueAt||V.status==="done"||V.status==="cancelled"?!1:new Date(V.dueAt)<L)}return i(c).has("inProgress")&&(S=S.filter(L=>L.status==="todo"&&L.statusSymbol&&L.statusSymbol!==" ")),i(c).has("blocked")&&(S=S.filter(L=>od(L,i(u)))),i(c).has("blocking")&&(S=S.filter(L=>ld(L,i(u)))),i(c).has("highPriority")&&(S=S.filter(L=>{const V=Qr(L.priority)||"normal";return V==="high"||V==="highest"})),S}),k=Q(()=>i(u).filter(S=>S.status!=="done"&&S.status!=="cancelled"&&!S.dueAt&&!S.scheduledAt&&!S.startAt).length),g=Q(()=>()=>{const S=new Date;S.setHours(0,0,0,0);const L=new Date(S);return L.setDate(L.getDate()+7),i(u).filter(V=>{if(V.status==="done"||V.status==="cancelled"||!V.dueAt)return!1;const ae=new Date(V.dueAt);return ae.setHours(0,0,0,0),ae>S&&ae<=L}).length}),y=Q(()=>()=>{const S=new Date;return S.setDate(S.getDate()-30),S.setHours(0,0,0,0),i(u).filter(L=>L.status!=="done"||!L.doneAt?!1:new Date(L.doneAt)>=S).length}),_=Q(()=>i(u).filter(S=>S.status!=="done"&&S.status!=="cancelled").length);function D(S="initial"){b(p,!0),b(u,e.repository.getAllTasks().map(L=>({...L})),!0),b(p,!1),S!=="initial"&&$.info("Task list reloaded")}D();const x=()=>D("reload");Sn(()=>{window.addEventListener("recurring-task-refresh",x)}),Yu(()=>{window.removeEventListener("recurring-task-refresh",x)});async function E(S){Ye.emit("task: complete",{taskId:S.id})}async function O(S){const L=i(u),V=pa(i(u),S.id,ae=>{const I={...ae},R=new Date(I.dueAt),X=t.tomorrow();return X.setHours(R.getHours(),R.getMinutes(),0,0),I.dueAt=X.toISOString(),I.snoozeCount=(I.snoozeCount||0)+1,I.updatedAt=new Date().toISOString(),I});b(u,V,!0),$.info(`Task "${S.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",S),await e.scheduler.delayToTomorrow(S.id)}catch(ae){b(u,L,!0),$.error("Failed to delay task:  "+ae),D("external")}}async function z(S){var V;if(!((V=S.name)!=null&&V.trim())){$.error("Task name is required");return}if(!Al(S.frequency)){$.error("Invalid frequency configuration");return}const L={...S};b(u,qn(i(u),L),!0),b(a,!1),b(l,void 0),$.success(`Task "${S.name}" saved successfully`),e.repository.saveTask(L).catch(ae=>{$.error("Failed to save task: "+ae),D("external")})}async function q(S){const L=i(u);b(u,no(i(u),S.id),!0);const V=window.setTimeout(async()=>{try{await e.repository.deleteTask(S.id)}catch(ae){b(u,L,!0),$.error("Failed to delete task: "+ae),D("external")}},5e3);ur({message:`Task "${S.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(V),b(u,L,!0),$.info(`Restored "${S.name}"`)},showCountdown:!0})}async function K(S){const L=S.name.endsWith(" (copy)")?`${S.name} ${new Date().toLocaleDateString()}`:`${S.name} (copy)`,V=Ol(S,{name:L});b(u,qn(i(u),V),!0),$.success(`Duplicated "${S.name}"`),e.repository.saveTask(V).catch(ae=>{b(u,no(i(u),V.id),!0),$.error("Failed to duplicate task: "+ae),D("external")})}async function Y(S){const L=!S.enabled,V={...S,enabled:L},ae=pa(i(u),S.id,()=>V);b(u,ae,!0),$.info(`Task ${L?"enabled":"disabled"}`),e.repository.saveTask(V).catch(I=>{$.error("Failed to update task: "+I),D("external")})}async function J(S,L){if(S.length===0)return;const V=i(u),ae=new Set(S),I=i(u).map(R=>ae.has(R.id)?{...R,enabled:L}:R);b(u,I,!0),$.info(`${L?"Enabled":"Disabled"} ${S.length} task${S.length===1?"":"s"}`);try{const R=I.filter(X=>ae.has(X.id));await Promise.all(R.map(X=>e.repository.saveTask(X)))}catch(R){b(u,V,!0),$.error(`Failed to ${L?"enable":"disable"} tasks: ${R}`),D("external")}}async function ne(S){if(S.length===0)return;const L=i(u),V=new Set(S),ae=i(u).filter(R=>V.has(R.id));b(u,i(u).filter(R=>!V.has(R.id)),!0);const I=window.setTimeout(async()=>{try{await Promise.all(ae.map(R=>e.repository.deleteTask(R.id)))}catch(R){b(u,L,!0),$.error("Failed to delete tasks: "+R),D("external")}},5e3);ur({message:`${ae.length} task${ae.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(I),b(u,L,!0),$.info("Bulk delete undone")},showCountdown:!0})}function te(S){b(l,S,!0),b(a,!0)}function oe(){b(l,void 0),b(a,!0)}function pe(){b(a,!1),b(l,void 0)}function W(){b(o,!0)}function F(){b(o,!1)}async function C(S){const L=i(u),V=pa(i(u),S.id,ae=>{const I={...ae};Nl(I);const R=s.calculateNext(new Date(I.dueAt),I.frequency);return I.dueAt=R.toISOString(),I});b(u,V,!0),$.info(`Task "${S.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",S),await e.scheduler.skipTaskOccurrence(S.id)}catch(ae){b(u,L,!0),$.error("Failed to skip task: "+ae),D("external")}}function U(S){const L=new Set(i(c));L.has(S)?L.delete(S):L.add(S),b(c,L,!0)}async function re(S){const L={...S,status:"todo",doneAt:void 0};b(u,qn(i(u),L),!0),$.success(`Task "${S.name}" marked as not done`),e.repository.saveTask(L).catch(V=>{$.error("Failed to update task: "+V),D("external")})}var ee=Uv(),ye=d(ee),de=f(d(ye),2),ue=d(de);ue.__click=()=>D("reload");var xe=d(ue),_e=f(ue,2);_e.__click=W;var Re=f(ye,2);{var le=S=>{var L=Ov(),V=d(L);Mv(V,{get eventService(){return e.eventService},get shortcutManager(){return e.shortcutManager},get settingsService(){return e.settingsService},get repository(){return e.repository},onClose:F}),T(S,L)},P=S=>{var L=lt(),V=$e(L);{var ae=R=>{var X=Nv(),fe=d(X);Pl(fe,{get task(){return i(l)},get repository(){return e.repository},onSave:z,onClose:pe}),T(R,X)},I=R=>{var X=Bv(),fe=$e(X),me=d(fe);me.__click=()=>b(n,"inbox");var ge=f(d(me));{var Ee=ke=>{var Ie=qv(),ze=d(Ie);j(()=>M(ze,i(k))),T(ke,Ie)};H(ge,ke=>{i(k)>0&&ke(Ee)})}var Ae=f(me,2);Ae.__click=()=>b(n,"today");var He=f(d(Ae));{var Ve=ke=>{var Ie=Rv(),ze=d(Ie);j(()=>M(ze,i(h).length)),T(ke,Ie)};H(He,ke=>{i(h).length>0&&ke(Ve)})}var Ke=f(Ae,2);Ke.__click=()=>b(n,"upcoming");var Xe=f(d(Ke));{var it=ke=>{var Ie=Lv(),ze=d(Ie);j(()=>M(ze,i(g))),T(ke,Ie)};H(Xe,ke=>{i(g)>0&&ke(it)})}var Ce=f(Ke,2);Ce.__click=()=>b(n,"done");var ct=f(d(Ce));{var Ue=ke=>{var Ie=Fv(),ze=d(Ie);j(()=>M(ze,i(y))),T(ke,Ie)};H(ct,ke=>{i(y)>0&&ke(Ue)})}var Ze=f(Ce,2);Ze.__click=()=>b(n,"projects");var Je=f(d(Ze));{var kt=ke=>{var Ie=zv(),ze=d(Ie);j(()=>M(ze,i(_))),T(ke,Ie)};H(Je,ke=>{i(_)>0&&ke(kt)})}var wt=f(Ze,2);wt.__click=()=>b(n,"search");var zt=f(wt,2);zt.__click=()=>b(n,"all");var ie=f(d(zt)),ce=d(ie),Se=f(zt,2);Se.__click=()=>b(n,"insights");var ot=f(fe,2);{var xs=ke=>{var Ie=Pv(),ze=f(d(Ie),2);ze.__click=()=>U("notDone");var pt=f(ze,2);pt.__click=()=>U("dueToday");var Pt=f(pt,2);Pt.__click=()=>U("overdue");var Tt=f(Pt,2);Tt.__click=()=>U("inProgress");var Ht=f(Tt,2);Ht.__click=()=>U("blocked");var St=f(Ht,2);St.__click=()=>U("blocking");var Bt=f(St,2);Bt.__click=()=>U("highPriority"),j((js,Wt,cs,Kt,B,ve,tt)=>{Ge(ze,1,`dashboard__filter-btn ${js??""}`,"svelte-1y1a8hs"),Ge(pt,1,`dashboard__filter-btn ${Wt??""}`,"svelte-1y1a8hs"),Ge(Pt,1,`dashboard__filter-btn ${cs??""}`,"svelte-1y1a8hs"),Ge(Tt,1,`dashboard__filter-btn ${Kt??""}`,"svelte-1y1a8hs"),Ge(Ht,1,`dashboard__filter-btn ${B??""}`,"svelte-1y1a8hs"),Ge(St,1,`dashboard__filter-btn ${ve??""}`,"svelte-1y1a8hs"),Ge(Bt,1,`dashboard__filter-btn ${tt??""}`,"svelte-1y1a8hs")},[()=>i(c).has("notDone")?"active":"",()=>i(c).has("dueToday")?"active":"",()=>i(c).has("overdue")?"active":"",()=>i(c).has("inProgress")?"active":"",()=>i(c).has("blocked")?"active":"",()=>i(c).has("blocking")?"active":"",()=>i(c).has("highPriority")?"active":""]),T(ke,Ie)};H(ot,ke=>{i(n)!=="search"&&i(n)!=="timeline"&&i(n)!=="analytics"&&i(n)!=="insights"&&ke(xs)})}var se=f(ot,2),we=d(se);{var je=ke=>{{let Ie=Q(()=>i(c).size>0?i(m):i(u));ph(ke,{get tasks(){return i(Ie)},onEdit:te,onDone:E,onDelete:q})}},et=ke=>{var Ie=lt(),ze=$e(Ie);{var pt=Tt=>{{let Ht=Q(()=>i(c).size>0?i(m).filter(St=>i(h).some(Bt=>Bt.id===St.id)):i(h));Ld(Tt,{get tasks(){return i(Ht)},onDone:E,onDelay:O,onSkip:C,onEdit:te,get timezoneHandler(){return t}})}},Pt=Tt=>{var Ht=lt(),St=$e(Ht);{var Bt=Wt=>{{let cs=Q(()=>i(c).size>0?i(m):i(u));_h(Wt,{get tasks(){return i(cs)},onEdit:te,onDone:E,onDelete:q})}},js=Wt=>{var cs=lt(),Kt=$e(cs);{var B=tt=>{{let Zt=Q(()=>i(c).size>0?i(m):i(u));Eh(tt,{get tasks(){return i(Zt)},onEdit:te,onDelete:q,onUncomplete:re})}},ve=tt=>{var Zt=lt(),Jt=$e(Zt);{var Sr=Dr=>{{let Dn=Q(()=>i(c).size>0?i(m):i(u));Nh(Dr,{get tasks(){return i(Dn)},onEdit:te,onDone:E,onDelete:q})}},Xl=Dr=>{var Dn=lt(),Zl=$e(Dn);{var Jl=xr=>{kf(xr,{get tasks(){return i(u)},onEdit:te,onDone:E,onDelete:q})},ec=xr=>{var Si=lt(),tc=$e(Si);{var sc=Er=>{{let xn=Q(()=>i(c).size>0?i(m):i(u));Wd(Er,{get tasks(){return i(xn)},onEdit:te,onDelete:q,onDuplicate:K,onToggleEnabled:Y,onBulkEnable:sn=>J(sn,!0),onBulkDisable:sn=>J(sn,!1),onBulkDelete:ne,onCreate:oe})}},rc=Er=>{var xn=lt(),sn=$e(xn);{var nc=Ar=>{eh(Ar,{get tasks(){return i(u)},get recurrenceEngine(){return s}})},ac=Ar=>{var Di=lt(),ic=$e(Di);{var oc=Cr=>{dh(Cr,{get tasks(){return i(u)}})},lc=Cr=>{var xi=lt(),cc=$e(xi);{var uc=ia=>{Nf(ia,{get tasks(){return i(u)},onApplySuggestion:async(En,oa)=>{const Ei={...En,frequency:oa.suggestedSchedule.frequency,dueAt:oa.suggestedSchedule.time?(()=>{const An=new Date(En.dueAt),[dc,hc]=oa.suggestedSchedule.time.split(":").map(Number);return An.setHours(dc,hc||0,0,0),An.toISOString()})():En.dueAt,updatedAt:new Date().toISOString()};b(u,qn(i(u),Ei),!0),$.success(`Schedule updated for "${En.name}"`);try{await e.repository.saveTask(Ei)}catch(An){$.error("Failed to save schedule update: "+An),D("external")}}})};H(cc,ia=>{i(n)==="insights"&&ia(uc)},!0)}T(Cr,xi)};H(ic,Cr=>{i(n)==="analytics"?Cr(oc):Cr(lc,!1)},!0)}T(Ar,Di)};H(sn,Ar=>{i(n)==="timeline"?Ar(nc):Ar(ac,!1)},!0)}T(Er,xn)};H(tc,Er=>{i(n)==="all"?Er(sc):Er(rc,!1)},!0)}T(xr,Si)};H(Zl,xr=>{i(n)==="search"?xr(Jl):xr(ec,!1)},!0)}T(Dr,Dn)};H(Jt,Dr=>{i(n)==="projects"?Dr(Sr):Dr(Xl,!1)},!0)}T(tt,Zt)};H(Kt,tt=>{i(n)==="done"?tt(B):tt(ve,!1)},!0)}T(Wt,cs)};H(St,Wt=>{i(n)==="upcoming"?Wt(Bt):Wt(js,!1)},!0)}T(Tt,Ht)};H(ze,Tt=>{i(n)==="today"?Tt(pt):Tt(Pt,!1)},!0)}T(ke,Ie)};H(we,ke=>{i(n)==="inbox"?ke(je):ke(et,!1)})}j(()=>{Ge(me,1,`dashboard__tab ${i(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),Me(me,"aria-selected",i(n)==="inbox"),Ge(Ae,1,`dashboard__tab ${i(n)==="today"?"active":""}`,"svelte-1y1a8hs"),Me(Ae,"aria-selected",i(n)==="today"),Ge(Ke,1,`dashboard__tab ${i(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),Me(Ke,"aria-selected",i(n)==="upcoming"),Ge(Ce,1,`dashboard__tab ${i(n)==="done"?"active":""}`,"svelte-1y1a8hs"),Me(Ce,"aria-selected",i(n)==="done"),Ge(Ze,1,`dashboard__tab ${i(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),Me(Ze,"aria-selected",i(n)==="projects"),Ge(wt,1,`dashboard__tab ${i(n)==="search"?"active":""}`,"svelte-1y1a8hs"),Me(wt,"aria-selected",i(n)==="search"),Ge(zt,1,`dashboard__tab ${i(n)==="all"?"active":""}`,"svelte-1y1a8hs"),Me(zt,"aria-selected",i(n)==="all"),M(ce,i(u).length),Ge(Se,1,`dashboard__tab ${i(n)==="insights"?"active":""}`,"svelte-1y1a8hs"),Me(Se,"aria-selected",i(n)==="insights"),Me(se,"aria-labelledby",i(v))}),T(R,X)};H(V,R=>{i(a)?R(ae):R(I,!1)},!0)}T(S,L)};H(Re,S=>{i(o)?S(le):S(P,!1)})}j(()=>{ue.disabled=i(p),M(xe,i(p)?"⟳":"↻")}),T(r,ee),at()}ft(["click"]);var Yv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Hv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Wv=A('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),Kv=A('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),Gv=A('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">✕</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ⌘/Ctrl + Enter to save.</p></div></div>');function $v(r,e){var F;nt(e,!0);let t=G(De(((F=e.prefill)==null?void 0:F.suggestedName)??"")),s=G(De(new Date().toISOString().slice(0,16))),n=G(De({name:!1,dueAt:!1})),a=G(!1),o=G(null);const l=Q(()=>i(n).name&&!i(t).trim()?"Task name is required.":""),c=Q(()=>i(n).dueAt?i(s)?Number.isNaN(new Date(i(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=Q(()=>!!(i(l)||i(c)));Sn(()=>{var C;if((C=e.prefill)!=null&&C.suggestedTime){const U=new Date,[re,ee]=e.prefill.suggestedTime.split(":").map(Number);U.setHours(re,ee,0,0),b(s,U.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var U;(U=i(o))==null||U.focus()})});async function h(){var ee,ye;if(b(n,{name:!0,dueAt:!0},!0),i(u)){$.warning("Please fill out the required fields.");return}const C=Wu(),U=i(s).slice(11,16);if(C.time=U,!Al(C)){$.error("Invalid frequency configuration.");return}const re=Il(i(t).trim(),C,new Date(i(s)));re.linkedBlockId=((ee=e.prefill)==null?void 0:ee.linkedBlockId)||void 0,re.linkedBlockContent=((ye=e.prefill)==null?void 0:ye.linkedBlockContent)||void 0,b(a,!0);try{await e.repository.saveTask(re),$.success(`Task "${re.name}" created`),Ye.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(de){$.error("Failed to create task: "+de)}finally{b(a,!1)}}function p(C){C.key==="Escape"&&e.onClose(),(C.metaKey||C.ctrlKey)&&C.key==="Enter"&&(C.preventDefault(),h())}var v=Gv();v.__keydown=p;var m=d(v),k=d(m),g=f(d(k),2);g.__click=function(...C){var U;(U=e.onClose)==null||U.apply(this,C)};var y=f(k,2),_=f(d(y),2);_.__input=()=>i(n).name=!0,ps(_,C=>b(o,C),()=>i(o));var D=f(_,2);{var x=C=>{var U=Yv(),re=d(U);j(()=>M(re,i(l))),T(C,U)};H(D,C=>{i(l)&&C(x)})}var E=f(y,2),O=f(d(E),2);O.__input=()=>i(n).dueAt=!0;var z=f(O,2);{var q=C=>{var U=Hv(),re=d(U);j(()=>M(re,i(c))),T(C,U)};H(z,C=>{i(c)&&C(q)})}var K=f(E,2);{var Y=C=>{var U=Wv(),re=f(d(U)),ee=d(re);j(()=>M(ee,e.prefill.linkedBlockId)),T(C,U)};H(K,C=>{var U;(U=e.prefill)!=null&&U.linkedBlockId&&C(Y)})}var J=f(K,2),ne=d(J);ne.__click=function(...C){var U;(U=e.onClose)==null||U.apply(this,C)};var te=f(ne,2);{var oe=C=>{var U=Kv();U.__click=function(...re){var ee;(ee=e.onAdvanced)==null||ee.apply(this,re)},T(C,U)};H(te,C=>{e.onAdvanced&&C(oe)})}var pe=f(te,2);pe.__click=h;var W=d(pe);j(()=>{Me(_,"aria-invalid",!!i(l)),Me(O,"aria-invalid",!!i(c)),pe.disabled=i(a),M(W,i(a)?"Saving…":"Create Task")}),At("blur",_,()=>i(n).name=!0),dt(_,()=>i(t),C=>b(t,C)),At("blur",O,()=>i(n).dueAt=!0),dt(O,()=>i(s),C=>b(s,C)),T(r,v),at()}ft(["keydown","click","input"]);var Qv=A('<button class="postpone-card__option svelte-tkdeu6" type="button" role="listitem"> </button>'),Vv=A('<div class="postpone-overlay svelte-tkdeu6" role="dialog" aria-modal="true" aria-labelledby="postpone-title"><div class="postpone-card svelte-tkdeu6" role="document"><div class="postpone-card__header svelte-tkdeu6"><h2 id="postpone-title" class="svelte-tkdeu6">Postpone task</h2> <button class="postpone-card__close svelte-tkdeu6" type="button" aria-label="Close">✕</button></div> <p class="postpone-card__summary svelte-tkdeu6">Choose a new due offset for <strong> </strong>.</p> <div class="postpone-card__options svelte-tkdeu6" role="list"></div> <div class="postpone-card__actions svelte-tkdeu6"><button class="postpone-card__cancel svelte-tkdeu6" type="button">Cancel</button></div></div></div>');function Xv(r,e){nt(e,!0);let t=G(null);function s(g,y){y&&b(t,g,!0)}Sn(()=>{requestAnimationFrame(()=>{var g;(g=i(t))==null||g.focus()})});function n(g){g.key==="Escape"&&e.onClose()}var a=Vv();a.__keydown=n;var o=d(a),l=d(o),c=f(d(l),2);c.__click=function(...g){var y;(y=e.onClose)==null||y.apply(this,g)};var u=f(l,2),h=f(d(u)),p=d(h),v=f(u,2);Fe(v,21,()=>Xu,rt,(g,y,_)=>{var D=Qv();D.__click=()=>e.onSelect(i(y).minutes);var x=d(D);Ou(D,(E,O)=>s==null?void 0:s(E,O),()=>_===0),j(()=>M(x,i(y).label)),T(g,D)});var m=f(v,2),k=d(m);k.__click=function(...g){var y;(y=e.onClose)==null||y.apply(this,g)},j(()=>M(p,e.taskName)),T(r,a),at()}ft(["keydown","click"]);class Zv{constructor(e){w(this,"plugin");this.plugin=e}getCurrentVersion(){return Hs}async createBackup(e,t){try{const s=await this.plugin.loadData(e);if(s){const n=new Date().toISOString().replace(/[:.]/g,"-"),a=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${a}-${n}`;return await this.plugin.saveData(o,s),he(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(s){throw Te("Failed to create backup",s),s}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return he("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Hs};const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0)return he("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Hs};let n=!1,a,o,l=0;for(let c=0;c<s.length;c++){const u=s[c],h=u.version||0;h<Hs&&(n||(o=h,a=await this.createBackup(e,h),n=!0),s[c]=this.migrateTask(u,h),l++,he(`Migrated task ${u.id} from v${h} to v${Hs}`))}if(n){const c=Array.isArray(t)?s:{...t,tasks:s};return await this.plugin.saveData(e,c),he(`Migration complete: ${l} tasks migrated`),{migrated:!0,tasksAffected:l,fromVersion:o,toVersion:Hs,backupKey:a}}else return he("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:Hs}}catch(t){throw Te("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),t<4&&(s={...s,version:4,onCompletion:s.onCompletion||"keep",dependsOn:s.dependsOn||[],blockedBy:s.blockedBy||[]}),s}}class Jv{constructor(e,t=50){w(this,"pendingState",null);w(this,"writeInProgress",!1);w(this,"scheduledTimer",null);w(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){Te("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return Te("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const za={},ep=Object.freeze(Object.defineProperty({__proto__:null,default:za},Symbol.toStringTag,{value:"Module"})),uo=new Set;function Pn(r){const e=`${r.feature}:${r.capability}:${r.message}`;uo.has(e)||(uo.add(e),st(r.message,{feature:r.feature,capability:r.capability,cause:r.cause}))}class Bl extends Error{constructor(t,s,n){super(n);w(this,"capability");w(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class Ul extends Error{constructor(t,s,n,a){super(n);w(this,"capability");w(this,"feature");w(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=a}}class tp{constructor(e=globalThis){w(this,"supportedCapabilities");w(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,n;return typeof((n=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(n){throw new Ul("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new Bl("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const sp=".tmp";class rp{constructor(e,t){w(this,"plugin");w(this,"apiAdapter");w(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(cr);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){Te("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),he(`Saved ${e.tasks.length} active tasks`)}catch(t){throw Te("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(cr,e);return}const s=this.resolveStoragePath(cr);if(!s){await this.plugin.saveData(cr,e);return}const n=za.dirname(s);await t.mkdir(n,{recursive:!0});const a=`${s}${sp}`,o=JSON.stringify(e),l=await t.open(a,"w");try{await l.writeFile(o,"utf8"),await l.sync()}finally{await l.close()}try{await t.rename(a,s)}catch{await t.rm(s,{force:!0}),await t.rename(a,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>ep);return this.fsPromises=e.promises,this.fsPromises}catch(e){return st("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Pn({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):za.join(t,"storage",`p${s}`,`${e}.json`)}}const ho=1,fo=1e3;class np{constructor(e){w(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[n,a]of s.entries())await this.appendTasksToYear(t,n,a);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),n=[];for(const l of s){const c=await this.loadChunk(l.key);if(c)for(const u of c.tasks)this.matchesQuery(u,e)&&n.push(u)}const a=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(a,a+o)}async loadIndex(){try{const e=await this.plugin.loadData(Fn);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??ho,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){Te("Failed to load archive index",e)}return{version:ho,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Fn,e)}catch(t){throw Te("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Fn}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){Te("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw Te("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const n=this.getCompletionTimestamp(s),a=new Date(n).getFullYear(),o=t.get(a);o?o.push(s):t.set(a,[s])}return t}async appendTasksToYear(e,t,s){let n=[...s];for(;n.length>0;){const a=this.findOrCreateChunk(e,t),o=await this.loadChunk(a.key)||{tasks:[]},l=fo-o.tasks.length,c=n.slice(0,l);o.tasks.push(...c),n=n.slice(c.length);const u=this.updateChunkMeta(a,c);a.count=u.count,a.start=u.start,a.end=u.end,await this.saveChunk(a.key,o),e.totalCount+=c.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(l=>l.year===t).sort((l,c)=>l.sequence-c.sequence).at(-1);if(n&&n.count<fo)return n;const a=n?n.sequence+1:1,o={key:this.buildChunkKey(t,a),year:t,sequence:a,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,n=e.end;for(const a of t){const o=this.getCompletionTimestamp(a);(!s||o<s)&&(s=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:s,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(a=>{const o=a.start?new Date(a.start).getTime():null,l=a.end?new Date(a.end).getTime():null;return!(s&&l&&l<s||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),n=new Date(s).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class ap{constructor(e,t=new tp){w(this,"plugin");w(this,"activeTasks");w(this,"blockIndex",new Map);w(this,"taskBlockIndex",new Map);w(this,"dueIndex",new Map);w(this,"activeStore");w(this,"archiveStore");w(this,"persistence");w(this,"blockAttrSyncEnabled",!0);w(this,"blockApi");w(this,"apiAdapter");w(this,"syncRetryQueue",new Map);w(this,"retryProcessorInterval");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new rp(e,t),this.archiveStore=new np(e),this.persistence=new Jv(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),he(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex(),this.startSyncRetryProcessor()}async loadActiveTasks(e=1e3,t){const s=await this.activeStore.loadActive(),n=Array.from(s.values()),a=n.length;if(a===0)return[];const o=[];for(let l=0;l<a;l+=e){const c=n.slice(l,Math.min(l+e,a));o.push(...c),t&&t(o.length,a),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));he(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);he(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[n]of this.dueIndex)n<=t&&s.push(...this.getTasksForDueKey(n));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const n of t){const a=this.activeTasks.get(n);if(!a){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!a.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(a.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}s.push(a)}return s}removeStaleDueIndexEntry(e,t,s){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),st("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id);if(t&&e.version!==void 0&&t.version!==void 0&&e.version<t.version)throw new Error(`Concurrent modification detected for task "${e.name}". Please refresh and try again.`);e.version=(e.version??0)+1;const s=this.activeTasks.get(e.id),n=this.taskBlockIndex.get(e.id);n&&n!==e.linkedBlockId&&(this.blockIndex.delete(n),this.taskBlockIndex.delete(e.id)),s&&s.enabled&&(s.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(s),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrsWithRetry(e),n&&n!==e.linkedBlockId&&await this.clearBlockAttrs(n)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Ji]:e.id,[eo]:e.dueAt,[to]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Ji]:"",[eo]:"",[to]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Pn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof Bl||s instanceof Ul?Pn({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Pn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const n=new Date(s.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(cr);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(Yi);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(Hi,t),he(`Created legacy backup at ${Hi}`);const n=s.filter(l=>!l.enabled&&l.lastCompletedAt),a=s.filter(l=>!n.includes(l)),o=new Map(a.map(l=>[l.id,l]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),he("Legacy storage migration complete",{activeCount:a.length,archivedCount:n.length,legacyKey:Yi,activeKey:cr,archiveIndexKey:Fn})}async syncTaskToBlockAttrsWithRetry(e){try{await this.syncTaskToBlockAttrs(e),this.syncRetryQueue.delete(e.id)}catch(t){const s=this.syncRetryQueue.get(e.id)||{task:e,attempts:0,nextRetry:Date.now()};s.attempts<Nn?(s.attempts++,s.nextRetry=Date.now()+so[s.attempts-1],s.task=e,this.syncRetryQueue.set(e.id,s),st(`Block sync failed for task ${e.id}, added to retry queue`,{taskId:e.id,attempts:s.attempts,nextRetry:new Date(s.nextRetry).toISOString(),error:t instanceof Error?t.message:String(t)})):(Te(`Block sync failed for task ${e.id} after ${Nn} attempts`,{taskId:e.id,error:t instanceof Error?t.message:String(t)}),this.syncRetryQueue.delete(e.id))}}startSyncRetryProcessor(){this.retryProcessorInterval&&clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=setInterval(async()=>{const e=Date.now(),t=[];for(const[s,n]of this.syncRetryQueue.entries())n.nextRetry<=e&&t.push({id:s,entry:n});for(const{id:s,entry:n}of t)try{await this.syncTaskToBlockAttrs(n.task),this.syncRetryQueue.delete(s),he(`Block sync retry succeeded for task ${s}`,{taskId:s,attempts:n.attempts})}catch(a){n.attempts<Nn?(n.attempts++,n.nextRetry=Date.now()+so[n.attempts-1],this.syncRetryQueue.set(s,n),st(`Block sync retry failed for task ${s}`,{taskId:s,attempts:n.attempts,nextRetry:new Date(n.nextRetry).toISOString(),error:a instanceof Error?a.message:String(a)})):(Te(`Block sync retry exhausted for task ${s} after ${Nn} attempts`,{taskId:s,error:a instanceof Error?a.message:String(a)}),this.syncRetryQueue.delete(s))}},ed)}stopSyncRetryProcessor(){this.retryProcessorInterval&&(clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=void 0)}}class ip{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}var Pa=["MO","TU","WE","TH","FR","SA","SU"],Rt=function(){function r(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return r.fromStr=function(e){return new r(Pa.indexOf(e))},r.prototype.nth=function(e){return this.n===e?this:new r(this.weekday,e)},r.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},r.prototype.toString=function(){var e=Pa[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},r.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},r}(),ht=function(r){return r!=null},ms=function(r){return typeof r=="number"},vo=function(r){return typeof r=="string"&&Pa.includes(r)},Qt=Array.isArray,Ds=function(r,e){e===void 0&&(e=r),arguments.length===1&&(e=r,r=0);for(var t=[],s=r;s<e;s++)t.push(s);return t},Pe=function(r,e){var t=0,s=[];if(Qt(r))for(;t<e;t++)s[t]=[].concat(r);else for(;t<e;t++)s[t]=r;return s},op=function(r){return Qt(r)?r:[r]};function Or(r,e,t){t===void 0&&(t=" ");var s=String(r);return e=e>>0,s.length>e?String(s):(e=e-s.length,e>t.length&&(t+=Pe(t,e/t.length)),t.slice(0,e)+String(s))}var lp=function(r,e,t){var s=r.split(e);return t?s.slice(0,t).concat([s.slice(t).join(e)]):s},is=function(r,e){var t=r%e;return t*e<0?t+e:t},ya=function(r,e){return{div:Math.floor(r/e),mod:is(r,e)}},Ts=function(r){return!ht(r)||r.length===0},mt=function(r){return!Ts(r)},Qe=function(r,e){return mt(r)&&r.indexOf(e)!==-1},wr=function(r,e,t,s,n,a){return s===void 0&&(s=0),n===void 0&&(n=0),a===void 0&&(a=0),new Date(Date.UTC(r,e-1,t,s,n,a))},cp=[31,28,31,30,31,30,31,31,30,31,30,31],jl=1e3*60*60*24,Yl=9999,Hl=wr(1970,1,1),up=[6,0,1,2,3,4,5],dn=function(r){return r%4===0&&r%100!==0||r%400===0},Wl=function(r){return r instanceof Date},an=function(r){return Wl(r)&&!isNaN(r.getTime())},dp=function(r,e){var t=r.getTime(),s=e.getTime(),n=t-s;return Math.round(n/jl)},Ba=function(r){return dp(r,Hl)},Kl=function(r){return new Date(Hl.getTime()+r*jl)},hp=function(r){var e=r.getUTCMonth();return e===1&&dn(r.getUTCFullYear())?29:cp[e]},Xr=function(r){return up[r.getUTCDay()]},po=function(r,e){var t=wr(r,e+1,1);return[Xr(t),hp(t)]},Gl=function(r,e){return e=e||r,new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Ua=function(r){var e=new Date(r.getTime());return e},yo=function(r){for(var e=[],t=0;t<r.length;t++)e.push(Ua(r[t]));return e},mn=function(r){r.sort(function(e,t){return e.getTime()-t.getTime()})},bi=function(r,e){e===void 0&&(e=!0);var t=new Date(r);return[Or(t.getUTCFullYear().toString(),4,"0"),Or(t.getUTCMonth()+1,2,"0"),Or(t.getUTCDate(),2,"0"),"T",Or(t.getUTCHours(),2,"0"),Or(t.getUTCMinutes(),2,"0"),Or(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},_i=function(r){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(r);if(!t)throw new Error("Invalid UNTIL value: ".concat(r));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},mo=function(r,e){var t=r.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},fp=function(r,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,s=new Date(mo(r,t)),n=new Date(mo(r,e??"UTC")),a=n.getTime()-s.getTime();return new Date(r.getTime()-a)},Lr=function(){function r(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return r.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,s=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(s)return!1}else if(this.method==="before"){if(s)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},r.prototype.add=function(e){return this._result.push(e),!0},r.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},r.prototype.clone=function(){return new r(this.method,this.args)},r}(),ja=function(r,e){return ja=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])},ja(r,e)};function ki(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");ja(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var Xt=function(){return Xt=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},Xt.apply(this,arguments)};function Z(r,e,t){if(t||arguments.length===2)for(var s=0,n=e.length,a;s<n;s++)(a||!(s in e))&&(a||(a=Array.prototype.slice.call(e,0,s)),a[s]=e[s]);return r.concat(a||Array.prototype.slice.call(e))}var go=function(r){ki(e,r);function e(t,s,n){var a=r.call(this,t,s)||this;return a.iterator=n,a}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Lr),Kn={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},bo=function(r,e){return r.indexOf(e)!==-1},vp=function(r){return r.toString()},pp=function(r,e,t){return"".concat(e," ").concat(t,", ").concat(r)},Us=function(){function r(e,t,s,n){if(t===void 0&&(t=vp),s===void 0&&(s=Kn),n===void 0&&(n=pp),this.text=[],this.language=s||Kn,this.gettext=t,this.dateFormatter=n,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var a=[].concat(this.options.bymonthday),o=[].concat(this.options.bynmonthday);a.sort(function(h,p){return h-p}),o.sort(function(h,p){return p-h}),this.bymonthday=a.concat(o),this.bymonthday.length||(this.bymonthday=null)}if(ht(this.origOptions.byweekday)){var l=Qt(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],c=String(l);this.byweekday={allWeeks:l.filter(function(h){return!h.n}),someWeeks:l.filter(function(h){return!!h.n}),isWeekdays:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")===-1&&c.indexOf("SU")===-1,isEveryDay:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")!==-1&&c.indexOf("SU")!==-1};var u=function(h,p){return h.weekday-p.weekday};this.byweekday.allWeeks.sort(u),this.byweekday.someWeeks.sort(u),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return r.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in r.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var s in e.origOptions){if(bo(["dtstart","tzid","wkst","freq"],s))return!0;if(!bo(r.IMPLEMENTED[e.options.freq],s))return!1}return t},r.prototype.isFullyConvertible=function(){return r.isFullyConvertible(this.rrule)},r.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in r.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[be.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},r.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},r.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},r.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},r.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},r.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},r.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},r.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},r.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},r.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},r.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},r.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,s=this.gettext;if(e===-1)return s("last");var n=Math.abs(e);switch(n){case 1:case 21:case 31:t=n+s("st");break;case 2:case 22:t=n+s("nd");break;case 3:case 23:t=n+s("rd");break;default:t=n+s("th")}return e<0?t+" "+s("last"):t},r.prototype.monthtext=function(e){return this.language.monthNames[e-1]},r.prototype.weekdaytext=function(e){var t=ms(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},r.prototype.plural=function(e){return e%100!==1},r.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},r.prototype.list=function(e,t,s,n){var a=this;n===void 0&&(n=","),Qt(e)||(e=[e]);var o=function(c,u,h){for(var p="",v=0;v<c.length;v++)v!==0&&(v===c.length-1?p+=" "+h+" ":p+=u+" "),p+=c[v];return p};t=t||function(c){return c.toString()};var l=function(c){return t&&t.call(a,c)};return s?o(e.map(l),n,s):e.map(l).join(n+" ")},r}(),yp=function(){function r(e){this.done=!0,this.rules=e}return r.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},r.prototype.isDone=function(){return this.done&&this.symbol===null},r.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var s=void 0;e=null;for(var n in this.rules){s=this.rules[n];var a=s.exec(this.text);a&&(e===null||a[0].length>e[0].length)&&(e=a,t=n)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},r.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},r.prototype.acceptNumber=function(){return this.accept("number")},r.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},r}();function $l(r,e){e===void 0&&(e=Kn);var t={},s=new yp(e.tokens);if(!s.start(r))return null;return n(),t;function n(){s.expect("every");var v=s.acceptNumber();if(v&&(t.interval=parseInt(v[0],10)),s.isDone())throw new Error("Unexpected end");switch(s.symbol){case"day(s)":t.freq=be.DAILY,s.nextSymbol()&&(o(),p());break;case"weekday(s)":t.freq=be.WEEKLY,t.byweekday=[be.MO,be.TU,be.WE,be.TH,be.FR],s.nextSymbol(),o(),p();break;case"week(s)":t.freq=be.WEEKLY,s.nextSymbol()&&(a(),o(),p());break;case"hour(s)":t.freq=be.HOURLY,s.nextSymbol()&&(a(),p());break;case"minute(s)":t.freq=be.MINUTELY,s.nextSymbol()&&(a(),p());break;case"month(s)":t.freq=be.MONTHLY,s.nextSymbol()&&(a(),p());break;case"year(s)":t.freq=be.YEARLY,s.nextSymbol()&&(a(),p());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=be.WEEKLY;var m=s.symbol.substr(0,2).toUpperCase();if(t.byweekday=[be[m]],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");var k=c();if(!k)throw new Error("Unexpected symbol "+s.symbol+", expected weekday");t.byweekday.push(be[k]),s.nextSymbol()}o(),h(),p();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=be.YEARLY,t.bymonth=[l()],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");var g=l();if(!g)throw new Error("Unexpected symbol "+s.symbol+", expected month");t.bymonth.push(g),s.nextSymbol()}a(),p();break;default:throw new Error("Unknown symbol")}}function a(){var v=s.accept("on"),m=s.accept("the");if(v||m)do{var k=u(),g=c(),y=l();if(k)g?(s.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(be[g].nth(k))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(k),s.accept("day(s)"));else if(g)s.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(be[g]);else if(s.symbol==="weekday(s)")s.nextSymbol(),t.byweekday||(t.byweekday=[be.MO,be.TU,be.WE,be.TH,be.FR]);else if(s.symbol==="week(s)"){s.nextSymbol();var _=s.acceptNumber();if(!_)throw new Error("Unexpected symbol "+s.symbol+", expected week number");for(t.byweekno=[parseInt(_[0],10)];s.accept("comma");){if(_=s.acceptNumber(),!_)throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");t.byweekno.push(parseInt(_[0],10))}}else if(y)s.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(y);else return}while(s.accept("comma")||s.accept("the")||s.accept("on"))}function o(){var v=s.accept("at");if(v)do{var m=s.acceptNumber();if(!m)throw new Error("Unexpected symbol "+s.symbol+", expected hour");for(t.byhour=[parseInt(m[0],10)];s.accept("comma");){if(m=s.acceptNumber(),!m)throw new Error("Unexpected symbol "+s.symbol+"; expected hour");t.byhour.push(parseInt(m[0],10))}}while(s.accept("comma")||s.accept("at"))}function l(){switch(s.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function c(){switch(s.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return s.symbol.substr(0,2).toUpperCase();default:return!1}}function u(){switch(s.symbol){case"last":return s.nextSymbol(),-1;case"first":return s.nextSymbol(),1;case"second":return s.nextSymbol(),s.accept("last")?-2:2;case"third":return s.nextSymbol(),s.accept("last")?-3:3;case"nth":var v=parseInt(s.value[1],10);if(v<-366||v>366)throw new Error("Nth out of range: "+v);return s.nextSymbol(),s.accept("last")?-v:v;default:return!1}}function h(){s.accept("on"),s.accept("the");var v=u();if(v)for(t.bymonthday=[v],s.nextSymbol();s.accept("comma");){if(v=u(),!v)throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");t.bymonthday.push(v),s.nextSymbol()}}function p(){if(s.symbol==="until"){var v=Date.parse(s.text);if(!v)throw new Error("Cannot parse until date:"+s.text);t.until=new Date(v)}else s.accept("for")&&(t.count=parseInt(s.value[0],10),s.expect("number"))}}var Be;(function(r){r[r.YEARLY=0]="YEARLY",r[r.MONTHLY=1]="MONTHLY",r[r.WEEKLY=2]="WEEKLY",r[r.DAILY=3]="DAILY",r[r.HOURLY=4]="HOURLY",r[r.MINUTELY=5]="MINUTELY",r[r.SECONDLY=6]="SECONDLY"})(Be||(Be={}));function wi(r){return r<Be.HOURLY}var mp=function(r,e){return e===void 0&&(e=Kn),new be($l(r,e)||void 0)},tn=["count","until","interval","byweekday","bymonthday","bymonth"];Us.IMPLEMENTED=[];Us.IMPLEMENTED[Be.HOURLY]=tn;Us.IMPLEMENTED[Be.MINUTELY]=tn;Us.IMPLEMENTED[Be.DAILY]=["byhour"].concat(tn);Us.IMPLEMENTED[Be.WEEKLY]=tn;Us.IMPLEMENTED[Be.MONTHLY]=tn;Us.IMPLEMENTED[Be.YEARLY]=["byweekno","byyearday"].concat(tn);var gp=function(r,e,t,s){return new Us(r,e,t,s).toString()},bp=Us.isFullyConvertible,Gn=function(){function r(e,t,s,n){this.hour=e,this.minute=t,this.second=s,this.millisecond=n||0}return r.prototype.getHours=function(){return this.hour},r.prototype.getMinutes=function(){return this.minute},r.prototype.getSeconds=function(){return this.second},r.prototype.getMilliseconds=function(){return this.millisecond},r.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},r}(),_p=function(r){ki(e,r);function e(t,s,n,a,o,l,c){var u=r.call(this,a,o,l,c)||this;return u.year=t,u.month=s,u.day=n,u}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return Xr(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var s=Math.floor(this.month/12),n=is(this.month,12);this.month=n,this.year+=s,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,s){s>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-s))+t*7:this.day+=-(this.getWeekday()-s)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,s,n){for(s&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var a=ya(this.hour,24),o=a.div,l=a.mod;if(o&&(this.hour=l,this.addDaily(o)),Ts(n)||Qe(n,this.hour))break}},e.prototype.addMinutes=function(t,s,n,a){for(s&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var o=ya(this.minute,60),l=o.div,c=o.mod;if(l&&(this.minute=c,this.addHours(l,!1,n)),(Ts(n)||Qe(n,this.hour))&&(Ts(a)||Qe(a,this.minute)))break}},e.prototype.addSeconds=function(t,s,n,a,o){for(s&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var l=ya(this.second,60),c=l.div,u=l.mod;if(c&&(this.second=u,this.addMinutes(c,!1,n,a)),(Ts(n)||Qe(n,this.hour))&&(Ts(a)||Qe(a,this.minute))&&(Ts(o)||Qe(o,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=po(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>Yl))return;t=po(this.year,this.month-1)[1]}}},e.prototype.add=function(t,s){var n=t.freq,a=t.interval,o=t.wkst,l=t.byhour,c=t.byminute,u=t.bysecond;switch(n){case Be.YEARLY:return this.addYears(a);case Be.MONTHLY:return this.addMonths(a);case Be.WEEKLY:return this.addWeekly(a,o);case Be.DAILY:return this.addDaily(a);case Be.HOURLY:return this.addHours(a,s,l);case Be.MINUTELY:return this.addMinutes(a,s,l,c);case Be.SECONDLY:return this.addSeconds(a,s,l,c,u)}},e}(Gn);function Ql(r){for(var e=[],t=Object.keys(r),s=0,n=t;s<n.length;s++){var a=n[s];Qe(Vp,a)||e.push(a),Wl(r[a])&&!an(r[a])&&e.push(a)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return Xt({},r)}function kp(r){var e=Xt(Xt({},Ti),Ql(r));if(ht(e.byeaster)&&(e.freq=be.YEARLY),!(ht(e.freq)&&be.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(r.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),ht(e.wkst)?ms(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=be.MO.weekday,ht(e.bysetpos)){ms(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var s=e.bysetpos[t];if(s===0||!(s>=-366&&s<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||mt(e.byweekno)||mt(e.byyearday)||e.bymonthday||mt(e.bymonthday)||ht(e.byweekday)||ht(e.byeaster)))switch(e.freq){case be.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case be.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case be.WEEKLY:e.byweekday=[Xr(e.dtstart)];break}if(ht(e.bymonth)&&!Qt(e.bymonth)&&(e.bymonth=[e.bymonth]),ht(e.byyearday)&&!Qt(e.byyearday)&&ms(e.byyearday)&&(e.byyearday=[e.byyearday]),!ht(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(Qt(e.bymonthday)){for(var n=[],a=[],t=0;t<e.bymonthday.length;t++){var s=e.bymonthday[t];s>0?n.push(s):s<0&&a.push(s)}e.bymonthday=n,e.bynmonthday=a}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(ht(e.byweekno)&&!Qt(e.byweekno)&&(e.byweekno=[e.byweekno]),!ht(e.byweekday))e.bynweekday=null;else if(ms(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(vo(e.byweekday))e.byweekday=[Rt.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof Rt)!e.byweekday.n||e.freq>be.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var o=[],l=[],t=0;t<e.byweekday.length;t++){var c=e.byweekday[t];if(ms(c)){o.push(c);continue}else if(vo(c)){o.push(Rt.fromStr(c).weekday);continue}!c.n||e.freq>be.MONTHLY?o.push(c.weekday):l.push([c.weekday,c.n])}e.byweekday=mt(o)?o:null,e.bynweekday=mt(l)?l:null}return ht(e.byhour)?ms(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<be.HOURLY?[e.dtstart.getUTCHours()]:null,ht(e.byminute)?ms(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<be.MINUTELY?[e.dtstart.getUTCMinutes()]:null,ht(e.bysecond)?ms(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<be.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function wp(r){var e=r.dtstart.getTime()%1e3;if(!wi(r.freq))return[];var t=[];return r.byhour.forEach(function(s){r.byminute.forEach(function(n){r.bysecond.forEach(function(a){t.push(new Gn(s,n,a,e))})})}),t}function Ya(r){var e=r.split(`
`).map(Tp).filter(function(t){return t!==null});return Xt(Xt({},e[0]),e[1])}function $n(r){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(r);if(!t)return e;var s=t[1],n=t[2];return s&&(e.tzid=s),e.dtstart=_i(n),e}function Tp(r){if(r=r.replace(/^\s+|\s+$/,""),!r.length)return null;var e=/^([A-Z]+?)[:;]/.exec(r.toUpperCase());if(!e)return _o(r);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return _o(r);case"DTSTART":return $n(r);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(r))}}function _o(r){var e=r.replace(/^RRULE:/i,""),t=$n(e),s=r.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return s.forEach(function(n){var a=n.split("="),o=a[0],l=a[1];switch(o.toUpperCase()){case"FREQ":t.freq=Be[l.toUpperCase()];break;case"WKST":t.wkst=hs[l.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var c=Sp(l),u=o.toLowerCase();t[u]=c;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=Dp(l);break;case"DTSTART":case"TZID":var h=$n(r);t.tzid=h.tzid,t.dtstart=h.dtstart;break;case"UNTIL":t.until=_i(l);break;case"BYEASTER":t.byeaster=Number(l);break;default:throw new Error("Unknown RRULE property '"+o+"'")}}),t}function Sp(r){if(r.indexOf(",")!==-1){var e=r.split(",");return e.map(ko)}return ko(r)}function ko(r){return/^[+-]?\d+$/.test(r)?Number(r):r}function Dp(r){var e=r.split(",");return e.map(function(t){if(t.length===2)return hs[t];var s=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!s||s.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var n=Number(s[1]),a=s[2],o=hs[a].weekday;return new Rt(o,n)})}var Qn=function(){function r(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(r.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),r.prototype.toString=function(){var e=bi(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},r.prototype.getTime=function(){return this.date.getTime()},r.prototype.rezonedDate=function(){return this.isUTC?this.date:fp(this.date,this.tzid)},r}();function Ha(r){for(var e=[],t="",s=Object.keys(r),n=Object.keys(Ti),a=0;a<s.length;a++)if(s[a]!=="tzid"&&Qe(n,s[a])){var o=s[a].toUpperCase(),l=r[s[a]],c="";if(!(!ht(l)||Qt(l)&&!l.length)){switch(o){case"FREQ":c=be.FREQUENCIES[r.freq];break;case"WKST":ms(l)?c=new Rt(l).toString():c=l.toString();break;case"BYWEEKDAY":o="BYDAY",c=op(l).map(function(m){return m instanceof Rt?m:Qt(m)?new Rt(m[0],m[1]):new Rt(m)}).toString();break;case"DTSTART":t=xp(l,r.tzid);break;case"UNTIL":c=bi(l,!r.tzid);break;default:if(Qt(l)){for(var u=[],h=0;h<l.length;h++)u[h]=String(l[h]);c=u.toString()}else c=String(l)}c&&e.push([o,c])}}var p=e.map(function(m){var k=m[0],g=m[1];return"".concat(k,"=").concat(g.toString())}).join(";"),v="";return p!==""&&(v="RRULE:".concat(p)),[t,v].filter(function(m){return!!m}).join(`
`)}function xp(r,e){return r?"DTSTART"+new Qn(new Date(r),e).toString():""}function Ep(r,e){return Array.isArray(r)?!Array.isArray(e)||r.length!==e.length?!1:r.every(function(t,s){return t.getTime()===e[s].getTime()}):r instanceof Date?e instanceof Date&&r.getTime()===e.getTime():r===e}var Ap=function(){function r(){this.all=!1,this.before=[],this.after=[],this.between=[]}return r.prototype._cacheAdd=function(e,t,s){t&&(t=t instanceof Date?Ua(t):yo(t)),e==="all"?this.all=t:(s._value=t,this[e].push(s))},r.prototype._cacheGet=function(e,t){var s=!1,n=t?Object.keys(t):[],a=function(h){for(var p=0;p<n.length;p++){var v=n[p];if(!Ep(t[v],h[v]))return!0}return!1},o=this[e];if(e==="all")s=this.all;else if(Qt(o))for(var l=0;l<o.length;l++){var c=o[l];if(!(n.length&&a(c))){s=c._value;break}}if(!s&&this.all){for(var u=new Lr(e,t),l=0;l<this.all.length&&u.accept(this.all[l]);l++);s=u.getValue(),this._cacheAdd(e,s,t)}return Qt(s)?yo(s):s instanceof Date?Ua(s):s},r}(),Cp=Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z([],Pe(1,31),!0),Pe(2,28),!0),Pe(3,31),!0),Pe(4,30),!0),Pe(5,31),!0),Pe(6,30),!0),Pe(7,31),!0),Pe(8,31),!0),Pe(9,30),!0),Pe(10,31),!0),Pe(11,30),!0),Pe(12,31),!0),Pe(1,7),!0),Ip=Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z([],Pe(1,31),!0),Pe(2,29),!0),Pe(3,31),!0),Pe(4,30),!0),Pe(5,31),!0),Pe(6,30),!0),Pe(7,31),!0),Pe(8,31),!0),Pe(9,30),!0),Pe(10,31),!0),Pe(11,30),!0),Pe(12,31),!0),Pe(1,7),!0),Mp=Ds(1,29),Op=Ds(1,30),Vs=Ds(1,31),Mt=Ds(1,32),Np=Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z([],Mt,!0),Op,!0),Mt,!0),Vs,!0),Mt,!0),Vs,!0),Mt,!0),Mt,!0),Vs,!0),Mt,!0),Vs,!0),Mt,!0),Mt.slice(0,7),!0),qp=Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z([],Mt,!0),Mp,!0),Mt,!0),Vs,!0),Mt,!0),Vs,!0),Mt,!0),Mt,!0),Vs,!0),Mt,!0),Vs,!0),Mt,!0),Mt.slice(0,7),!0),Rp=Ds(-28,0),Lp=Ds(-29,0),Xs=Ds(-30,0),Ot=Ds(-31,0),Fp=Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z([],Ot,!0),Lp,!0),Ot,!0),Xs,!0),Ot,!0),Xs,!0),Ot,!0),Ot,!0),Xs,!0),Ot,!0),Xs,!0),Ot,!0),Ot.slice(0,7),!0),zp=Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z(Z([],Ot,!0),Rp,!0),Ot,!0),Xs,!0),Ot,!0),Xs,!0),Ot,!0),Ot,!0),Xs,!0),Ot,!0),Xs,!0),Ot,!0),Ot.slice(0,7),!0),Pp=[0,31,60,91,121,152,182,213,244,274,305,335,366],Bp=[0,31,59,90,120,151,181,212,243,273,304,334,365],wo=function(){for(var r=[],e=0;e<55;e++)r=r.concat(Ds(7));return r}();function Up(r,e){var t=wr(r,1,1),s=dn(r)?366:365,n=dn(r+1)?366:365,a=Ba(t),o=Xr(t),l=Xt(Xt({yearlen:s,nextyearlen:n,yearordinal:a,yearweekday:o},jp(r)),{wnomask:null});if(Ts(e.byweekno))return l;l.wnomask=Pe(0,s+7);var c,u,h=c=is(7-o+e.wkst,7);h>=4?(h=0,u=l.yearlen+is(o-e.wkst,7)):u=s-h;for(var p=Math.floor(u/7),v=is(u,7),m=Math.floor(p+v/4),k=0;k<e.byweekno.length;k++){var g=e.byweekno[k];if(g<0&&(g+=m+1),g>0&&g<=m){var y=void 0;g>1?(y=h+(g-1)*7,h!==c&&(y-=7-c)):y=h;for(var _=0;_<7&&(l.wnomask[y]=1,y++,l.wdaymask[y]!==e.wkst);_++);}}if(Qe(e.byweekno,1)){var y=h+m*7;if(h!==c&&(y-=7-c),y<s)for(var k=0;k<7&&(l.wnomask[y]=1,y+=1,l.wdaymask[y]!==e.wkst);k++);}if(h){var D=void 0;if(Qe(e.byweekno,-1))D=-1;else{var x=Xr(wr(r-1,1,1)),E=is(7-x.valueOf()+e.wkst,7),O=dn(r-1)?366:365,z=void 0;E>=4?(E=0,z=O+is(x-e.wkst,7)):z=s-h,D=Math.floor(52+is(z,7)/4)}if(Qe(e.byweekno,D))for(var y=0;y<h;y++)l.wnomask[y]=1}return l}function jp(r){var e=dn(r)?366:365,t=wr(r,1,1),s=Xr(t);return e===365?{mmask:Cp,mdaymask:qp,nmdaymask:zp,wdaymask:wo.slice(s),mrange:Bp}:{mmask:Ip,mdaymask:Np,nmdaymask:Fp,wdaymask:wo.slice(s),mrange:Pp}}function Yp(r,e,t,s,n,a){var o={lastyear:r,lastmonth:e,nwdaymask:[]},l=[];if(a.freq===be.YEARLY)if(Ts(a.bymonth))l=[[0,t]];else for(var c=0;c<a.bymonth.length;c++)e=a.bymonth[c],l.push(s.slice(e-1,e+1));else a.freq===be.MONTHLY&&(l=[s.slice(e-1,e+1)]);if(Ts(l))return o;o.nwdaymask=Pe(0,t);for(var c=0;c<l.length;c++)for(var u=l[c],h=u[0],p=u[1]-1,v=0;v<a.bynweekday.length;v++){var m=void 0,k=a.bynweekday[v],g=k[0],y=k[1];y<0?(m=p+(y+1)*7,m-=is(n[m]-g,7)):(m=h+(y-1)*7,m+=is(7-n[m]+g,7)),h<=m&&m<=p&&(o.nwdaymask[m]=1)}return o}function Hp(r,e){e===void 0&&(e=0);var t=r%19,s=Math.floor(r/100),n=r%100,a=Math.floor(s/4),o=s%4,l=Math.floor((s+8)/25),c=Math.floor((s-l+1)/3),u=Math.floor(19*t+s-a-c+15)%30,h=Math.floor(n/4),p=n%4,v=Math.floor(32+2*o+2*h-u-p)%7,m=Math.floor((t+11*u+22*v)/451),k=Math.floor((u+v-7*m+114)/31),g=(u+v-7*m+114)%31+1,y=Date.UTC(r,k-1,g+e),_=Date.UTC(r,0,1);return[Math.ceil((y-_)/(1e3*60*60*24))]}var Wp=function(){function r(e){this.options=e}return r.prototype.rebuild=function(e,t){var s=this.options;if(e!==this.lastyear&&(this.yearinfo=Up(e,s)),mt(s.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var n=this.yearinfo,a=n.yearlen,o=n.mrange,l=n.wdaymask;this.monthinfo=Yp(e,t,a,o,l,s)}ht(s.byeaster)&&(this.eastermask=Hp(e,s.byeaster))},Object.defineProperty(r.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),r.prototype.ydayset=function(){return[Ds(this.yearlen),0,this.yearlen]},r.prototype.mdayset=function(e,t){for(var s=this.mrange[t-1],n=this.mrange[t],a=Pe(null,this.yearlen),o=s;o<n;o++)a[o]=o;return[a,s,n]},r.prototype.wdayset=function(e,t,s){for(var n=Pe(null,this.yearlen+7),a=Ba(wr(e,t,s))-this.yearordinal,o=a,l=0;l<7&&(n[a]=a,++a,this.wdaymask[a]!==this.options.wkst);l++);return[n,o,a]},r.prototype.ddayset=function(e,t,s){var n=Pe(null,this.yearlen),a=Ba(wr(e,t,s))-this.yearordinal;return n[a]=a,[n,a,a+1]},r.prototype.htimeset=function(e,t,s,n){var a=this,o=[];return this.options.byminute.forEach(function(l){o=o.concat(a.mtimeset(e,l,s,n))}),mn(o),o},r.prototype.mtimeset=function(e,t,s,n){var a=this.options.bysecond.map(function(o){return new Gn(e,t,o,n)});return mn(a),a},r.prototype.stimeset=function(e,t,s,n){return[new Gn(e,t,s,n)]},r.prototype.getdayset=function(e){switch(e){case Be.YEARLY:return this.ydayset.bind(this);case Be.MONTHLY:return this.mdayset.bind(this);case Be.WEEKLY:return this.wdayset.bind(this);case Be.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},r.prototype.gettimeset=function(e){switch(e){case Be.HOURLY:return this.htimeset.bind(this);case Be.MINUTELY:return this.mtimeset.bind(this);case Be.SECONDLY:return this.stimeset.bind(this)}},r}();function Kp(r,e,t,s,n,a){for(var o=[],l=0;l<r.length;l++){var c=void 0,u=void 0,h=r[l];h<0?(c=Math.floor(h/e.length),u=is(h,e.length)):(c=Math.floor((h-1)/e.length),u=is(h-1,e.length));for(var p=[],v=t;v<s;v++){var m=a[v];ht(m)&&p.push(m)}var k=void 0;c<0?k=p.slice(c)[0]:k=p[c];var g=e[u],y=Kl(n.yearordinal+k),_=Gl(y,g);Qe(o,_)||o.push(_)}return mn(o),o}function Vl(r,e){var t=e.dtstart,s=e.freq,n=e.interval,a=e.until,o=e.bysetpos,l=e.count;if(l===0||n===0)return Es(r);var c=_p.fromDate(t),u=new Wp(e);u.rebuild(c.year,c.month);for(var h=Qp(u,c,e);;){var p=u.getdayset(s)(c.year,c.month,c.day),v=p[0],m=p[1],k=p[2],g=$p(v,m,k,u,e);if(mt(o))for(var y=Kp(o,h,m,k,u,v),_=0;_<y.length;_++){var D=y[_];if(a&&D>a)return Es(r);if(D>=t){var x=To(D,e);if(!r.accept(x)||l&&(--l,!l))return Es(r)}}else for(var _=m;_<k;_++){var E=v[_];if(ht(E))for(var O=Kl(u.yearordinal+E),z=0;z<h.length;z++){var q=h[z],D=Gl(O,q);if(a&&D>a)return Es(r);if(D>=t){var x=To(D,e);if(!r.accept(x)||l&&(--l,!l))return Es(r)}}}if(e.interval===0||(c.add(e,g),c.year>Yl))return Es(r);wi(s)||(h=u.gettimeset(s)(c.hour,c.minute,c.second,0)),u.rebuild(c.year,c.month)}}function Gp(r,e,t){var s=t.bymonth,n=t.byweekno,a=t.byweekday,o=t.byeaster,l=t.bymonthday,c=t.bynmonthday,u=t.byyearday;return mt(s)&&!Qe(s,r.mmask[e])||mt(n)&&!r.wnomask[e]||mt(a)&&!Qe(a,r.wdaymask[e])||mt(r.nwdaymask)&&!r.nwdaymask[e]||o!==null&&!Qe(r.eastermask,e)||(mt(l)||mt(c))&&!Qe(l,r.mdaymask[e])&&!Qe(c,r.nmdaymask[e])||mt(u)&&(e<r.yearlen&&!Qe(u,e+1)&&!Qe(u,-r.yearlen+e)||e>=r.yearlen&&!Qe(u,e+1-r.yearlen)&&!Qe(u,-r.nextyearlen+e-r.yearlen))}function To(r,e){return new Qn(r,e.tzid).rezonedDate()}function Es(r){return r.getValue()}function $p(r,e,t,s,n){for(var a=!1,o=e;o<t;o++){var l=r[o];a=Gp(s,l,n),a&&(r[l]=null)}return a}function Qp(r,e,t){var s=t.freq,n=t.byhour,a=t.byminute,o=t.bysecond;return wi(s)?wp(t):s>=be.HOURLY&&mt(n)&&!Qe(n,e.hour)||s>=be.MINUTELY&&mt(a)&&!Qe(a,e.minute)||s>=be.SECONDLY&&mt(o)&&!Qe(o,e.second)?[]:r.gettimeset(s)(e.hour,e.minute,e.second,e.millisecond)}var hs={MO:new Rt(0),TU:new Rt(1),WE:new Rt(2),TH:new Rt(3),FR:new Rt(4),SA:new Rt(5),SU:new Rt(6)},Ti={freq:Be.YEARLY,dtstart:null,interval:1,wkst:hs.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},Vp=Object.keys(Ti),be=function(){function r(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new Ap,this.origOptions=Ql(e);var s=kp(e).parsedOptions;this.options=s}return r.parseText=function(e,t){return $l(e,t)},r.fromText=function(e,t){return mp(e,t)},r.fromString=function(e){return new r(r.parseString(e)||void 0)},r.prototype._iter=function(e){return Vl(e,this.options)},r.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},r.prototype._cacheAdd=function(e,t,s){if(this._cache)return this._cache._cacheAdd(e,t,s)},r.prototype.all=function(e){if(e)return this._iter(new go("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Lr("all",{})),this._cacheAdd("all",t)),t},r.prototype.between=function(e,t,s,n){if(s===void 0&&(s=!1),!an(e)||!an(t))throw new Error("Invalid date passed in to RRule.between");var a={before:t,after:e,inc:s};if(n)return this._iter(new go("between",a,n));var o=this._cacheGet("between",a);return o===!1&&(o=this._iter(new Lr("between",a)),this._cacheAdd("between",o,a)),o},r.prototype.before=function(e,t){if(t===void 0&&(t=!1),!an(e))throw new Error("Invalid date passed in to RRule.before");var s={dt:e,inc:t},n=this._cacheGet("before",s);return n===!1&&(n=this._iter(new Lr("before",s)),this._cacheAdd("before",n,s)),n},r.prototype.after=function(e,t){if(t===void 0&&(t=!1),!an(e))throw new Error("Invalid date passed in to RRule.after");var s={dt:e,inc:t},n=this._cacheGet("after",s);return n===!1&&(n=this._iter(new Lr("after",s)),this._cacheAdd("after",n,s)),n},r.prototype.count=function(){return this.all().length},r.prototype.toString=function(){return Ha(this.origOptions)},r.prototype.toText=function(e,t,s){return gp(this,e,t,s)},r.prototype.isFullyConvertibleToText=function(){return bp(this)},r.prototype.clone=function(){return new r(this.origOptions)},r.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],r.YEARLY=Be.YEARLY,r.MONTHLY=Be.MONTHLY,r.WEEKLY=Be.WEEKLY,r.DAILY=Be.DAILY,r.HOURLY=Be.HOURLY,r.MINUTELY=Be.MINUTELY,r.SECONDLY=Be.SECONDLY,r.MO=hs.MO,r.TU=hs.TU,r.WE=hs.WE,r.TH=hs.TH,r.FR=hs.FR,r.SA=hs.SA,r.SU=hs.SU,r.parseString=Ya,r.optionsToString=Ha,r}();function Xp(r,e,t,s,n,a){var o={},l=r.accept;function c(v,m){t.forEach(function(k){k.between(v,m,!0).forEach(function(g){o[Number(g)]=!0})})}n.forEach(function(v){var m=new Qn(v,a).rezonedDate();o[Number(m)]=!0}),r.accept=function(v){var m=Number(v);return isNaN(m)?l.call(this,v):!o[m]&&(c(new Date(m-1),new Date(m+1)),!o[m])?(o[m]=!0,l.call(this,v)):!0},r.method==="between"&&(c(r.args.after,r.args.before),r.accept=function(v){var m=Number(v);return o[m]?!0:(o[m]=!0,l.call(this,v))});for(var u=0;u<s.length;u++){var h=new Qn(s[u],a).rezonedDate();if(!r.accept(new Date(h.getTime())))break}e.forEach(function(v){Vl(r,v.options)});var p=r._result;switch(mn(p),r.method){case"all":case"between":return p;case"before":return p.length&&p[p.length-1]||null;case"after":default:return p.length&&p[0]||null}}var So={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function Zp(r,e){var t=[],s=[],n=[],a=[],o=$n(r),l=o.dtstart,c=o.tzid,u=ry(r,e.unfold);return u.forEach(function(h){var p;if(h){var v=sy(h),m=v.name,k=v.parms,g=v.value;switch(m.toUpperCase()){case"RRULE":if(k.length)throw new Error("unsupported RRULE parm: ".concat(k.join(",")));t.push(Ya(h));break;case"RDATE":var y=(p=/RDATE(?:;TZID=([^:=]+))?/i.exec(h))!==null&&p!==void 0?p:[],_=y[1];_&&!c&&(c=_),s=s.concat(Do(g,k));break;case"EXRULE":if(k.length)throw new Error("unsupported EXRULE parm: ".concat(k.join(",")));n.push(Ya(g));break;case"EXDATE":a=a.concat(Do(g,k));break;case"DTSTART":break;default:throw new Error("unsupported property: "+m)}}}),{dtstart:l,tzid:c,rrulevals:t,rdatevals:s,exrulevals:n,exdatevals:a}}function Jp(r,e){var t=Zp(r,e),s=t.rrulevals,n=t.rdatevals,a=t.exrulevals,o=t.exdatevals,l=t.dtstart,c=t.tzid,u=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||s.length>1||n.length||a.length||o.length){var h=new ay(u);return h.dtstart(l),h.tzid(c||void 0),s.forEach(function(v){h.rrule(new be(ma(v,l,c),u))}),n.forEach(function(v){h.rdate(v)}),a.forEach(function(v){h.exrule(new be(ma(v,l,c),u))}),o.forEach(function(v){h.exdate(v)}),e.compatible&&e.dtstart&&h.rdate(l),h}var p=s[0]||{};return new be(ma(p,p.dtstart||e.dtstart||l,p.tzid||e.tzid||c),u)}function Wa(r,e){return e===void 0&&(e={}),Jp(r,ey(e))}function ma(r,e,t){return Xt(Xt({},r),{dtstart:e,tzid:t})}function ey(r){var e=[],t=Object.keys(r),s=Object.keys(So);if(t.forEach(function(n){Qe(s,n)||e.push(n)}),e.length)throw new Error("Invalid options: "+e.join(", "));return Xt(Xt({},So),r)}function ty(r){if(r.indexOf(":")===-1)return{name:"RRULE",value:r};var e=lp(r,":",1),t=e[0],s=e[1];return{name:t,value:s}}function sy(r){var e=ty(r),t=e.name,s=e.value,n=t.split(";");if(!n)throw new Error("empty property name");return{name:n[0].toUpperCase(),parms:n.slice(1),value:s}}function ry(r,e){if(e===void 0&&(e=!1),r=r&&r.trim(),!r)throw new Error("Invalid empty string");if(!e)return r.split(/\s/);for(var t=r.split(`
`),s=0;s<t.length;){var n=t[s]=t[s].replace(/\s+$/g,"");n?s>0&&n[0]===" "?(t[s-1]+=n.slice(1),t.splice(s,1)):s+=1:t.splice(s,1)}return t}function ny(r){r.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function Do(r,e){return ny(e),r.split(",").map(function(t){return _i(t)})}function xo(r){var e=this;return function(t){if(t!==void 0&&(e["_".concat(r)]=t),e["_".concat(r)]!==void 0)return e["_".concat(r)];for(var s=0;s<e._rrule.length;s++){var n=e._rrule[s].origOptions[r];if(n)return n}}}var ay=function(r){ki(e,r);function e(t){t===void 0&&(t=!1);var s=r.call(this,{},t)||this;return s.dtstart=xo.apply(s,["dtstart"]),s.tzid=xo.apply(s,["tzid"]),s._rrule=[],s._rdate=[],s._exrule=[],s._exdate=[],s}return e.prototype._iter=function(t){return Xp(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){Eo(t,this._rrule)},e.prototype.exrule=function(t){Eo(t,this._exrule)},e.prototype.rdate=function(t){Ao(t,this._rdate)},e.prototype.exdate=function(t){Ao(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return Wa(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return Wa(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(Ha({dtstart:this._dtstart}))),this._rrule.forEach(function(s){t=t.concat(s.toString().split(`
`))}),this._exrule.forEach(function(s){t=t.concat(s.toString().split(`
`).map(function(n){return n.replace(/^RRULE:/,"EXRULE:")}).filter(function(n){return!/^DTSTART/.test(n)}))}),this._rdate.length&&t.push(Co("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(Co("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(s){return t.rrule(s.clone())}),this._exrule.forEach(function(s){return t.exrule(s.clone())}),this._rdate.forEach(function(s){return t.rdate(new Date(s.getTime()))}),this._exdate.forEach(function(s){return t.exdate(new Date(s.getTime()))}),t},e}(be);function Eo(r,e){if(!(r instanceof be))throw new TypeError(String(r)+" is not RRule instance");Qe(e.map(String),String(r))||e.push(r)}function Ao(r,e){if(!(r instanceof Date))throw new TypeError(String(r)+" is not Date instance");Qe(e.map(Number),Number(r))||(e.push(r),mn(e))}function Co(r,e,t){var s=!t||t.toUpperCase()==="UTC",n=s?"".concat(r,":"):"".concat(r,";TZID=").concat(t,":"),a=e.map(function(o){return bi(o.valueOf(),s)}).join(",");return"".concat(n).concat(a)}function iy(){return Intl.DateTimeFormat().resolvedOptions().timeZone}class oy{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,n)=>s-n)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t,s){if(s!=null&&s.timezone||iy(),t.rruleString)return this.calculateNextWithRRule(e,t,s);const a=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,{type:o,time:l}=t,c=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(a,c);break;case"weekly":u=this.calculateNextWeekly(a,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(a,c,this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;case"yearly":u=this.calculateNextYearly(a,c,this.normalizeMonth(t.month,a.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(l){const{hours:h,minutes:p}=qa(l);if(Number.isFinite(h)&&Number.isFinite(p)){const{date:v,shifted:m}=io(u,h,p);m&&st("DST shift detected while applying recurrence time",{requestedTime:l,original:u.toISOString(),adjusted:v.toISOString()}),u=v}}return u}calculateNextWithRRule(e,t,s){try{const a=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,l=Wa(t.rruleString).after(a,!1);if(!l){st("RRule returned no next occurrence, falling back to legacy logic",{rruleString:t.rruleString,baseDate:a.toISOString()});const{rruleString:u,naturalLanguage:h,...p}=t;return this.calculateNext(a,p,s)}let c=l;if(t.time){const{hours:u,minutes:h}=qa(t.time);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:p,shifted:v}=io(c,u,h);v&&st("DST shift detected while applying recurrence time",{requestedTime:t.time,original:c.toISOString(),adjusted:p.toISOString()}),c=p}}return c}catch(n){Te("Failed to parse rrule, falling back to legacy logic",{error:n instanceof Error?n.message:String(n),rruleString:t.rruleString});const{rruleString:a,naturalLanguage:o,...l}=t;return this.calculateNext(e,l,s)}}calculateNextDaily(e,t){return pn(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return ao(e,t);const n=this.getMondayIndex(e),a=Math.min(fa,t*14);for(let o=1;o<=a;o++){if(Math.floor((n+o)/7)%t!==0)continue;const c=pn(e,o),u=this.getMondayIndex(c);if(s.includes(u))return c}return st("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),ao(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const n=s??e.getDate(),a=e.getFullYear(),l=e.getMonth()+t,c=a+Math.floor(l/12),u=(l%12+12)%12,h=new Date(c,u+1,0).getDate(),p=Math.min(n,h),v=new Date(e);return v.setFullYear(c,u,p),v}calculateNextYearly(e,t,s,n){const a=n??e.getDate(),o=e.getFullYear()+t,l=new Date(o,s+1,0).getDate(),c=Math.min(a,l),u=new Date(e);return u.setFullYear(o,s,c),u}getOccurrencesInRange(e,t,s,n){const a=[];let o=new Date(n),l=0;for(;o<=t&&l<fa;)o>=e&&a.push(new Date(o)),o=this.calculateNext(o,s),l++;return a}getMissedOccurrences(e,t,s,n){const a=[];let o=new Date(n),l=0;for(;o<=e&&l<fa;)o=this.calculateNext(o,s),l++;let c=0;for(;o<t&&c<zn;)a.push(new Date(o)),o=this.calculateNext(o,s),c++;return c>=zn&&st("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:n.toISOString(),cap:zn}),a}}class ly{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:n}=qa(t);if(!Number.isFinite(s)||!Number.isFinite(n))return new Date(e);const a=new Date(e);return a.setHours(s,n,0,0),a}isSameLocalDay(e,t){const s=new Date(e),n=new Date(t);return s.getFullYear()===n.getFullYear()&&s.getMonth()===n.getMonth()&&s.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),n=Math.trunc(s/(1e3*60)),a=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(a)<24?a>0?`in ${a}h`:`${-a}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class cy{constructor(e){w(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return he(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return st(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return st("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),he(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return st("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(s){return Te("Failed to execute onCompletion action",{taskId:e.id,action:t,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return st("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return Te("Failed to check for nested items",{blockId:e,error:t}),!0}}}class uy{constructor(e,t){w(this,"intervalMs");w(this,"timeoutId",null);w(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:fi,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class dy{constructor(e,t=fi,s){w(this,"storage");w(this,"recurrenceEngine");w(this,"onCompletionHandler");w(this,"emittedDue",new Set);w(this,"emittedMissed",new Set);w(this,"timezoneHandler");w(this,"isChecking",!1);w(this,"lastCheckStartTime",0);w(this,"plugin",null);w(this,"listeners",{"task:due":new Set,"task:overdue":new Set});w(this,"MAX_EMITTED_ENTRIES",1e3);w(this,"EMITTED_RETENTION_DAYS",30);w(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);w(this,"persistTimeoutId",null);w(this,"emittedStateReady",null);w(this,"timer");this.storage=e,this.recurrenceEngine=new oy,this.onCompletionHandler=new cy(s),this.timezoneHandler=new ly,this.plugin=s||null,this.timer=new uy(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),he("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),he("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)st("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const n=new Date(s.dueAt),a=n<=e;if(a){const l=this.buildOccurrenceKey(s.id,n,"hour");this.emittedDue.has(l)||(this.emitEvent("task:due",{taskId:s.id,dueAt:n,context:"today",task:s}),this.registerEmittedKey("due",l),he(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(a&&e.getTime()-n.getTime()>=Qu&&(!o||o<n)){const l=this.buildOccurrenceKey(s.id,n,"hour");this.emittedMissed.has(l)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:n,context:"overdue",task:s}),this.registerEmittedKey("missed",l),st(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),s=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=s.set,(t.didTrim||s.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,s){const n=s.getTime(),a=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=a.filter(({time:u})=>u===null||u>=n),l=o.length!==a.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),l=!0);const c=new Set(o.map(({entry:u})=>u));return l&&he(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${c.size}`),{set:c,didTrim:l}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const s=e.slice(t+1);if(!s)return null;const n=s.length===13?`${s}:00:00.000Z`:s,a=new Date(n);return Number.isNaN(a.getTime())?null:a.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const s=new Date;t.doneAt=s.toISOString(),id(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const a=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,a);if(o.success||Te(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:a,error:o.error}),o.warnings)for(const u of o.warnings)st(u,{taskId:t.id});const l=new Date(t.dueAt),c=this.recurrenceEngine.calculateNext(l,t.frequency,{completionDate:s,whenDone:t.whenDone});t.dueAt=c.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),he(`Task "${t.name}" completed and rescheduled to ${c.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const n=new Date(s.dueAt),a=new Date(n.getTime()+t*60*1e3);s.dueAt=a.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),he(`Task "${s.name}" delayed by ${t} minutes to ${a.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),he(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Nl(t);const s=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),he(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),he("First run detected, no recovery needed");return}he(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const a of n){const o=this.buildOccurrenceKey(s.id,a,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:a,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(n){Te(`Failed to recover task ${s.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),he("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let n=s,a=0;for(;n<t&&a<zn;)n=this.recurrenceEngine.calculateNext(n,e.frequency),a++;n>s&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),he(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Zi);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){Te("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Zi,{timestamp:e.toISOString()})}catch(t){Te("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const n of s)try{const a=n(t);a instanceof Promise&&a.catch(o=>{Te(`Scheduler listener error for ${e}:`,o)})}catch(a){Te(`Scheduler listener error for ${e}:`,a)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Vu,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Gi),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),he("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){Te("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Gi,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){Te("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const hy=7,fy=2e3;class vy{constructor(e,t){w(this,"plugin");w(this,"storageKey");w(this,"notifications",new Map);w(this,"escalations",new Map);w(this,"lastCleanup",new Date);w(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),he(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){Te("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Rl("Saved notification state")}catch(e){Te("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>fy&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-hy*24*60*60*1e3);let n=0;for(const[a,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(a),n++);n>0&&(he(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function py(r){return{id:r.id,name:r.name,dueAt:r.dueAt,frequency:r.frequency,linkedBlockId:r.linkedBlockId,linkedBlockContent:r.linkedBlockContent,priority:r.priority,tags:r.tags,notificationChannels:r.notificationChannels,completionCount:r.completionCount,missCount:r.missCount,currentStreak:r.currentStreak,bestStreak:r.bestStreak}}const yy=30*1e3,my=30*60*1e3,nr=500;class gy{constructor(e,t={}){w(this,"plugin");w(this,"config");w(this,"queue",[]);w(this,"dedupeKeys",new Set);w(this,"flushIntervalId",null);w(this,"fetcher");w(this,"notificationState");w(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...Na},this.notificationState=t.notificationState??new vy(this.plugin,Ku)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(Wi);e&&(this.config={...Na,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(Wi,e)}async loadQueue(){try{const e=await this.plugin.loadData(Ki);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>nr){const s=this.queue.length-nr;this.queue=this.queue.slice(-nr),console.warn(`Event queue trimmed to ${nr} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-ha);await this.plugin.saveData(Ki,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},$u))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const a=this.buildPayload(e,t,n,1,s);await this.sendPayload(a)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(a)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:$i,version:Qi,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){s.push(n);continue}const a={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(a))this.markDelivered(a.delivery.dedupeKey),t=!0;else{const l=n.attempt+1,c=this.getRetryDelay(l);s.push({...n,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,n,a=0){const o=new Date,l=new Date(t.dueAt),c=o.getTime()-l.getTime();return{event:e,source:$i,version:Qi,occurredAt:o.toISOString(),task:py(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:c>0?c:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:a,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:n}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>ha){const t=Array.from(this.dedupeKeys).slice(-ha);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=nr){const s=this.queue.length-nr+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${nr}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=yy*Math.pow(2,e-1);return Math.min(t,my)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,n=s.encode(t),a=s.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),l=await crypto.subtle.sign("HMAC",o,a);return Array.from(new Uint8Array(l)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const a={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return n&&(a["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(a["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),a}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),n=await this.buildHeaders(e),a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:s});if(!a.ok)return console.error("n8n webhook failed:",a.statusText),!1;if(t){const o=await a.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const It={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:yn,globalQuery:Hn,urgency:vi,smartRecurrence:{enabled:!0,autoAdjust:!1,minCompletionsForLearning:10,confidenceThreshold:.7},naturalLanguage:{enabled:!0,showConfidenceScore:!0,provideExamples:!0},crossNoteDependencies:{enabled:!0,checkInterval:5,notifyWhenMet:!0}};function Io(r){var e,t,s,n,a;return{dates:{...It.dates,...r.dates},recurrence:{...It.recurrence,...r.recurrence},dependencies:{...It.dependencies,...r.dependencies},filenameDate:{...It.filenameDate,...r.filenameDate},globalFilter:{...It.globalFilter,...r.globalFilter,excludeFolders:((e=r.globalFilter)==null?void 0:e.excludeFolders)??It.globalFilter.excludeFolders,excludeNotebooks:((t=r.globalFilter)==null?void 0:t.excludeNotebooks)??It.globalFilter.excludeNotebooks,excludeTags:((s=r.globalFilter)==null?void 0:s.excludeTags)??It.globalFilter.excludeTags,excludeFilePatterns:((n=r.globalFilter)==null?void 0:n.excludeFilePatterns)??It.globalFilter.excludeFilePatterns,excludeStatusTypes:((a=r.globalFilter)==null?void 0:a.excludeStatusTypes)??It.globalFilter.excludeStatusTypes},globalQuery:{...It.globalQuery,...r.globalQuery},urgency:{...It.urgency,...r.urgency},smartRecurrence:{...It.smartRecurrence,...r.smartRecurrence},naturalLanguage:{...It.naturalLanguage,...r.naturalLanguage},crossNoteDependencies:{...It.crossNoteDependencies,...r.crossNoteDependencies}}}const ga="plugin-settings";class by{constructor(e){w(this,"plugin");w(this,"settings");this.plugin=e,this.settings=It}async load(){try{const e=await this.plugin.loadData(ga);e&&typeof e=="object"&&(this.settings=Io(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(ga,e),Ye.emit("task:refresh",void 0)}get(){return this.settings}async update(e){this.settings=Io(e),await this.plugin.saveData(ga,this.settings),Ye.emit("task:refresh",void 0)}}const Ws=class Ws{constructor(e){w(this,"plugin");w(this,"isInitialized",!1);w(this,"storage");w(this,"repository");w(this,"scheduler");w(this,"eventService");w(this,"settingsService");this.plugin=e}static getInstance(e){if(!Ws.instance){if(!e)return null;Ws.instance=new Ws(e)}return Ws.instance}async initialize(){if(this.isInitialized){st("TaskManager already initialized");return}he("Initializing TaskManager"),this.settingsService=new by(this.plugin),await this.settingsService.load();const e=this.settingsService.get();Wn.getInstance().initialize(e.globalFilter),Vr.getInstance().initialize(e.globalQuery),this.storage=new ap(this.plugin),await this.storage.init(),this.repository=new ip(this.storage),this.eventService=new gy(this.plugin),await this.eventService.init(),this.scheduler=new dy(this.storage,fi,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,he("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),he("TaskManager started")}async destroy(){he("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,Ws.instance=null,he("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};w(Ws,"instance",null);let Vn=Ws;function _y(r){let t=`- [${r.status==="done"?"x":" "}] ${r.name}`;if(r.dueAt){const s=new Date(r.dueAt);t+=` 📅 ${s.toISOString().split("T")[0]}`}return r.frequency&&(t+=` 🔁 every ${r.frequency.interval} ${r.frequency.type}${r.frequency.interval>1?"s":""}`),t}class ky{constructor(e,t,s,n){this.storage=e,this.recurrenceEngine=t,this.settings=s,this.siyuanApi=n}async onComplete(e,t){try{const s=[],n=this.addCompletionDate(e,t);let a;return e.frequency&&(a=await this.generateNextInstance(n,t),a&&(await this.placeNextInstance(n,a)||s.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(a))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(st("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(n),s.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(n),{success:!0,nextTask:a,warnings:s.length>0?s:void 0}}catch(s){return Te("Failed to handle task completion",{taskId:e.id,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}addCompletionDate(e,t){const s={...e},n=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(s.doneAt=n,s.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(s.cancelledAt=n,s.doneAt=void 0),s}async generateNextInstance(e,t){if(e.frequency)try{const s=new Date(e.dueAt),n=this.recurrenceEngine.calculateNext(s,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),a=Ol(e,{dueAt:n.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(a.scheduledAt=void 0),a}catch(s){Te("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:s});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return st("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return st("SiYuan API not available, cannot place next instance"),!1;const s=this.settings.recurrence.newTaskPosition,n=_y(t);try{let a;return s==="above"&&this.siyuanApi.insertBlockAbove?a=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,n):s==="below"&&this.siyuanApi.insertBlockBelow&&(a=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,n)),a!=null&&a.id?(t.linkedBlockId=a.id,t.linkedBlockContent=n,!0):!1}catch(a){return Te("Failed to place next instance in document",{taskId:e.id,placement:s,error:a}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const s=await this.siyuanApi.getChildBlocks({id:e});return s&&s.length>0}catch(s){return Te("Failed to check for nested items",{blockId:e,error:s}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),he("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(s){Te("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:s})}else he("Task deleted from storage only (no linked block)",{taskId:e.id})}}class wy{constructor(e,t,s,n){w(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=s,this.siyuanApi=n,t&&s&&(this.completionHandler=new ky(e,t,s(),n))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,s;try{const n=this.repository.getTask(e);if(!n){$.error("Task not found");return}const a=ys.getInstance(),o=n.statusSymbol||" ",l=a.getNextSymbol(o),c={...n,statusSymbol:l},u=a.getStatus(l);if(u.type==="DONE"){if(c.status="done",n.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(c,new Date);h.success?(h.nextTask?(he("Next recurrence created",{taskId:c.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),$.success("Task completed - next occurrence scheduled")):$.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(p=>$.warning(p))):$.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!c.doneAt&&(c.doneAt=new Date().toISOString()),await this.repository.saveTask(c),$.success(`Task status updated to ${u.name}`);Ye.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(c.status="cancelled",(s=this.settings)!=null&&s.dates.autoAddCancelled&&!c.cancelledAt&&(c.cancelledAt=new Date().toISOString()),await this.repository.saveTask(c),Ye.emit("task:updated",{taskId:e}),$.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(c.status="todo",await this.repository.saveTask(c),Ye.emit("task:updated",{taskId:e}),$.success(`Task status updated to ${u.name}`))}catch(n){Te("Failed to toggle task status",n),$.error("Failed to toggle status")}}async completeTask(e){var t;try{const s=this.repository.getTask(e);if(!s){$.error("Task not found");return}const n={...s,status:"done"};if(s.frequency&&this.completionHandler){const a=await this.completionHandler.onComplete(n,new Date);a.success?(a.nextTask?(he("Next recurrence created",{taskId:n.id,nextTaskId:a.nextTask.id,nextDue:a.nextTask.dueAt}),$.success(`Task "${s.name}" completed - next occurrence scheduled`)):$.success(`Task "${s.name}" completed`),a.warnings&&a.warnings.forEach(o=>$.warning(o))):$.error(`Failed to complete task: ${a.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),$.success(`Task "${s.name}" completed`);Ye.emit("task:complete",{taskId:e})}catch(s){Te("Failed to complete task",s),$.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){$.error("Task not found");return}const n=this.repository.getAllTasks().filter(a=>{var o,l;return((o=a.blockedBy)==null?void 0:o.includes(e))||((l=a.dependsOn)==null?void 0:l.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),Ye.emit("task:deleted",{taskId:e}),$.success(`Task "${t.name}" deleted`)}catch(t){Te("Failed to delete task",t),$.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){$.error("Task not found");return}const s=new Date;s.setHours(12,0,0,0);const n={...t,scheduledAt:s.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),Ye.emit("task:updated",{taskId:e}),$.success("Task rescheduled to today")}catch(t){Te("Failed to reschedule task",t),$.error("Failed to reschedule task")}}async deferTask(e,t){try{const s=this.repository.getTask(e);if(!s){$.error("Task not found");return}const n={...s,updatedAt:new Date().toISOString()};if(s.dueAt){const a=new Date(s.dueAt);a.setDate(a.getDate()+t),n.dueAt=a.toISOString()}if(s.scheduledAt){const a=new Date(s.scheduledAt);a.setDate(a.getDate()+t),n.scheduledAt=a.toISOString()}await this.repository.saveTask(n),Ye.emit("task:updated",{taskId:e}),$.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(s){Te("Failed to defer task",s),$.error("Failed to defer task")}}}class Ty{constructor(e,t,s){w(this,"plugin");w(this,"storageKey");w(this,"settings");w(this,"defaults");this.plugin=e,this.storageKey=t,this.defaults={...s},this.settings={...s}}async load(){try{const e=await this.plugin.loadData(this.storageKey);e&&(this.settings={...this.defaults,...e})}catch(e){console.error(`Failed to load settings from ${this.storageKey}:`,e),this.settings={...this.defaults}}return this.settings}async save(e){e&&(this.settings=e);try{await this.plugin.saveData(this.storageKey,this.settings)}catch(t){throw console.error(`Failed to save settings to ${this.storageKey}:`,t),t}}get(){return{...this.settings}}async set(e,t){this.settings[e]=t,await this.save()}async reset(){this.settings={...this.defaults},await this.save()}has(e){return e in this.settings}getValue(e){return this.settings[e]}}const qr=[{id:"quickAddTask",langKey:"quickAddTask",label:"Quick add recurring task",description:"Open the quick add dialog with focus on the task title.",defaultHotkey:"Ctrl+Shift+T",context:"Global / Editor"},{id:"markTaskDone",langKey:"markTaskDone",label:"Mark task as done",description:"Complete the focused task and trigger recurrence.",defaultHotkey:"Ctrl+Enter",context:"Task focus / Task block"},{id:"postponeTask",langKey:"postponeTask",label:"Postpone task",description:"Open the snooze selector for the focused task.",defaultHotkey:"Ctrl+Shift+P",context:"Task focus"},{id:"openRecurringTasksDock",langKey:"openRecurringTasksDock",label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",defaultHotkey:"Ctrl+Shift+O",context:"Global"},{id:"createRecurringTask",langKey:"createRecurringTask",label:"Create recurring task from selection",description:"Create a recurring task based on the current editor block.",defaultHotkey:"Ctrl+Shift+R",context:"Editor"},{id:"quickCompleteNextTask",langKey:"quickCompleteNextTask",label:"Quick complete next task",description:"Marks the most overdue task as complete.",defaultHotkey:"Ctrl+Shift+D",context:"Global"},{id:"toggleTaskStatus",langKey:"toggleTaskStatus",label:"Toggle task status",description:"Cycle the status of the focused task.",defaultHotkey:"Ctrl+Shift+X",context:"Task focus"},{id:"openTaskEditor",langKey:"openTaskEditor",label:"Open task editor",description:"Open the full task editor modal.",defaultHotkey:"Ctrl+Shift+E",context:"Global"}],ba=qr.reduce((r,e)=>(r[e.id]=e.defaultHotkey,r),{});function Ka(r,e){Ye.emit("task:snooze",{taskId:r,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:r,minutes:e}})),he(`Snoozing task ${r} for ${e} minutes`)}function Sy(r){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=La(t),n=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));Ye.emit("task:snooze",{taskId:r,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:r,minutes:n}})),he(`Snoozing task ${r} to tomorrow`)}function Dy(r){r.eventBus.on("click-blockicon",({detail:e})=>{var o,l,c;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],n=s==null?void 0:s.getAttribute("data-node-id");if(!n)return;const a=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=r.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Ye.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Ga(a),suggestedTime:$a(a)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Ga(a),suggestedTime:$a(a)}}))}});try{const u=Vn.getInstance();if(u&&u.isReady()){const p=u.getRepository().getTaskByBlockId(n);if(p){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((l=r.i18n)==null?void 0:l.completeTask)||"Complete Task",click:()=>{Ye.emit("task:complete",{taskId:p.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:p.id}}))}});const v=[{label:"15 minutes",click:()=>Ka(p.id,15)},{label:"1 hour",click:()=>Ka(p.id,60)},{label:"Tomorrow",click:()=>Sy(p.id)}];e.menu.addItem({icon:"iconClock",label:((c=r.i18n)==null?void 0:c.snoozeTask)||"Snooze Task",submenu:v})}}}catch{Rl("TaskManager not available for quick actions")}}),he("Registered block context menu")}function Ga(r){const e=r.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function $a(r){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=r.match(e);if(t){let n=parseInt(t[1],10);const a=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${a}`}return null}const xy="recurring-task-shortcuts",Ey=350;class Ay{constructor(e,t,s,n,a){w(this,"settingsStore");w(this,"settings",{...ba});w(this,"taskCommands");w(this,"cooldownTimers",new Map);this.plugin=e,this.repository=t,this.handlers=a,this.settingsStore=new Ty(e,xy,ba),this.taskCommands=new wy(t,s,n,void 0)}async initialize(){this.settings=await this.settingsStore.load()}registerShortcuts(){qr.forEach(e=>{const t=this.settings[e.id]||e.defaultHotkey;this.plugin.addCommand({langKey:e.langKey,hotkey:t,callback:()=>{this.handleShortcut(e.id)}})}),he("Registered shortcut commands",{shortcuts:qr.map(e=>({id:e.id,hotkey:this.settings[e.id]}))})}getShortcutDisplay(){return qr.map(e=>({id:e.id,label:e.label,description:e.description,context:e.context,currentHotkey:this.settings[e.id]||"",defaultHotkey:e.defaultHotkey}))}async updateShortcut(e,t){const s=t.trim(),n=this.findDuplicateHotkey(e,s);return n?{success:!1,message:`Hotkey already assigned to "${n.label}".`}:(this.settings={...this.settings,[e]:s},await this.settingsStore.save(this.settings),this.registerShortcuts(),{success:!0})}async resetShortcut(e){const t=this.getDefinition(e);t&&(this.settings={...this.settings,[e]:t.defaultHotkey},await this.settingsStore.save(this.settings),this.registerShortcuts())}async resetAllShortcuts(){this.settings={...ba},await this.settingsStore.save(this.settings),this.registerShortcuts()}destroy(){this.cooldownTimers.forEach(e=>globalThis.clearTimeout(e)),this.cooldownTimers.clear()}async handleShortcut(e){if(!this.shouldIgnoreShortcut(e))switch(e){case"quickAddTask":this.guardCooldown(e,Ey,()=>{this.handlers.createTask(this.buildCreatePayload("shortcut"))});break;case"createRecurringTask":this.handlers.createTask(this.buildCreatePayload("shortcut"));break;case"openRecurringTasksDock":this.handlers.openDock();break;case"markTaskDone":{const t=this.resolveTaskId();if(!t)return;await this.handlers.completeTask(t);break}case"postponeTask":{const t=this.resolveTaskId();if(!t)return;this.handlers.postponeTask(t);break}case"quickCompleteNextTask":await this.quickCompleteNextTask();break;case"toggleTaskStatus":{const t=this.resolveTaskId();if(!t)return;await this.taskCommands.toggleStatus(t);break}case"openTaskEditor":this.handlers.openTaskEditor();break}}guardCooldown(e,t,s){if(this.cooldownTimers.has(e))return;s();const n=globalThis.setTimeout(()=>{this.cooldownTimers.delete(e)},t);this.cooldownTimers.set(e,n)}shouldIgnoreShortcut(e){const t=document.activeElement;if(!t)return!1;const s=t.tagName.toLowerCase();return["input","textarea","select"].includes(s)?!0:t.isContentEditable?!this.isEditorAllowedShortcut(e):!1}isEditorAllowedShortcut(e){return e==="quickAddTask"||e==="createRecurringTask"}resolveTaskId(){const e=this.getFocusedTaskId();if(e)return e;const t=this.getSelectedBlockContext();if(!t)return null;const s=this.repository.getTaskByBlockId(t.blockId);return(s==null?void 0:s.id)??null}getFocusedTaskId(){const e=document.activeElement;if(!e)return null;const t=e.closest("[data-task-id]");return(t==null?void 0:t.dataset.taskId)??null}getSelectedBlockContext(){const e=window.getSelection(),t=e==null?void 0:e.anchorNode;if(!t)return null;const s=t instanceof HTMLElement?t:t.parentElement;if(!s)return null;const n=s.closest("[data-node-id]");if(!n)return null;const a=n.getAttribute("data-node-id");return a?{blockId:a,blockContent:n.textContent||""}:null}buildCreatePayload(e){const t=this.getSelectedBlockContext();return t?{source:e,linkedBlockId:t.blockId,linkedBlockContent:t.blockContent,suggestedName:Ga(t.blockContent),suggestedTime:$a(t.blockContent)}:{source:e}}async quickCompleteNextTask(){try{const e=this.repository.getTodayAndOverdueTasks();if(e.length===0)return;const t=e[0];await this.taskCommands.completeTask(t.id)}catch(e){Te("Failed to quick complete task",e),$.error("Failed to complete task")}}getDefinition(e){return qr.find(t=>t.id===e)}findDuplicateHotkey(e,t){if(!t)return null;const s=t.toLowerCase(),n=qr.find(a=>a.id===e?!1:(this.settings[a.id]||"").toLowerCase()===s);return n?{id:n.id,label:n.label,description:n.description,context:n.context,currentHotkey:this.settings[n.id],defaultHotkey:n.defaultHotkey}:null}}async function Cy(r,e,t,s,n){const a=new Ay(r,e,s,n,t);return await a.initialize(),a.registerShortcuts(),a}class Iy{constructor(e,t){w(this,"plugin");w(this,"repository");w(this,"topbarElement",null);w(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),he("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),he("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const n=new Date(s.dueAt);return n<new Date&&!gi(n)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){Ye.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class My{constructor(e="tasks"){w(this,"codeLanguage");w(this,"cachedCodeBlocks",new WeakMap);w(this,"cachedAttributeBlocks",new WeakMap);this.codeLanguage=e.toLowerCase()}parse(e){const t=[];let s=this.cachedCodeBlocks.get(e);s||(s=e.querySelectorAll('[data-type="NodeCodeBlock"]'),this.cachedCodeBlocks.set(e,s)),s.forEach(a=>{var h;if((a.dataset.subtype||a.getAttribute("data-subtype")||"").toLowerCase()!==this.codeLanguage)return;const l=a.querySelector("code")||a.querySelector("textarea")||a.querySelector(".hljs")||a,c=((h=l==null?void 0:l.textContent)==null?void 0:h.trim())??"";if(!c)return;const u=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:u,query:c,element:a,source:"code"})});let n=this.cachedAttributeBlocks.get(e);return n||(n=e.querySelectorAll("[data-node-id]"),this.cachedAttributeBlocks.set(e,n)),n.forEach(a=>{if(a.classList.contains("rt-inline-query")||a.getAttribute("data-type")==="NodeCodeBlock")return;const o=this.parseAttributes(a);if(!o.query)return;const l=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:l,query:o.query,view:o.view,element:a,source:"attribute"})}),t}parseAttributes(e){var a;const t=e.getAttribute("custom-task-query")||e.getAttribute("data-attr-custom-task-query")||e.dataset.customTaskQuery||e.dataset.attrCustomTaskQuery,s=e.getAttribute("custom-task-view")||e.getAttribute("data-attr-custom-task-view")||e.dataset.customTaskView||e.dataset.attrCustomTaskView;if(t)return{query:t.trim(),view:s};const n=e.getAttribute("data-attrs");if(!n)return{};try{const o=JSON.parse(n),l=(a=o["custom-task-query"])==null?void 0:a.trim(),c=o["custom-task-view"];return{query:l,view:c}}catch{return{}}}}class Oy{constructor(e=6e4,t=100){w(this,"cache",new Map);w(this,"metrics",{hits:0,misses:0,evictions:0});w(this,"maxSize");this.ttlMs=e,this.maxSize=t}buildKey(e,t){return`${e}::${t}`}get(e){const t=this.cache.get(e);return t?this.ttlMs>0&&Date.now()-t.updatedAt>this.ttlMs?(this.cache.delete(e),this.metrics.misses++,null):(t.lastAccessedAt=Date.now(),this.cache.delete(e),this.cache.set(e,t),this.metrics.hits++,t):(this.metrics.misses++,null)}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictLRU();const s=Date.now();this.cache.set(e,{result:t,updatedAt:s,lastAccessedAt:s})}clear(){this.cache.clear()}evictLRU(){const e=this.cache.keys().next().value;e&&(this.cache.delete(e),this.metrics.evictions++)}getMetrics(){return{hits:this.metrics.hits,misses:this.metrics.misses,size:this.cache.size,evictions:this.metrics.evictions}}resetMetrics(){this.metrics.hits=0,this.metrics.misses=0,this.metrics.evictions=0}}class Ny{render(e,t){if(e.innerHTML="",e.classList.add("rt-inline-query"),e.dataset.query=t.query,e.dataset.view=t.view,e.setAttribute("role","region"),e.setAttribute("aria-label","Task query results"),t.isIndexing){e.appendChild(this.renderLoadingState());return}if(t.error){e.appendChild(this.renderErrorState(t.error));return}if(!t.result){e.appendChild(this.renderState("No results yet."));return}const s=t.result.tasks,n=s.length;if(n===0||s.length===0){e.appendChild(this.renderEmptyState());return}const a=document.createElement("div");a.className="rt-inline-query__header",a.textContent=`Inline Tasks · ${n}`,e.appendChild(a);const o=t.view||"list",l=t.result.groups;if(l&&l.size>0?l.forEach((c,u)=>{const h=this.renderGroupSection(u,c,o,t);e.appendChild(h)}):e.appendChild(this.renderTaskCollection(s,o,t)),typeof t.maxItems=="number"&&typeof t.renderedCount=="number"&&t.renderedCount<n){const c=document.createElement("div");c.className="rt-inline-query__footer";const u=document.createElement("button");u.type="button",u.className="rt-inline-query__more",u.dataset.rtAction="more",u.textContent=`Show more (${t.renderedCount}/${n})`,c.appendChild(u),e.appendChild(c)}}renderGroupSection(e,t,s,n){const a=document.createElement("section");a.className="rt-inline-query__group";const o=document.createElement("div");return o.className="rt-inline-query__group-title",o.textContent=e||"Untitled",a.appendChild(o),a.appendChild(this.renderTaskCollection(t,s,n)),a}renderTaskCollection(e,t,s){return t==="table"?this.renderTable(e,s):this.renderList(e,s)}renderList(e,t){const s=document.createElement("ul");s.className="rt-inline-query__list",s.setAttribute("role","list"),s.setAttribute("aria-label","Tasks");const n=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(o=>{const l=document.createElement("li");l.className="rt-inline-query__item",l.dataset.taskId=o.id;const c=document.createElement("button");c.type="button",c.className="rt-inline-query__checkbox",c.dataset.rtAction="toggle",c.setAttribute("aria-pressed",String(o.status==="done"));const u=o.status==="done"?`Mark incomplete: ${o.name.replace(/"/g,"'")}`:`Mark complete: ${o.name.replace(/"/g,"'")}`;c.setAttribute("aria-label",u),c.textContent=o.status==="done"?"☑":"☐";const h=document.createElement("span");h.className="rt-inline-query__title",h.textContent=o.name,o.status==="done"&&h.classList.add("rt-inline-query__title--done");const p=document.createElement("span");p.className="rt-inline-query__meta",p.textContent=this.formatTaskMeta(o);const v=this.renderSource(o),m=document.createElement("button");m.type="button",m.className="rt-inline-query__edit",m.dataset.rtAction="edit",m.setAttribute("aria-label",`Edit task: ${o.name.replace(/"/g,"'")}`),m.textContent="Edit",l.appendChild(c),l.appendChild(h),l.appendChild(p),v&&l.appendChild(v),l.appendChild(m),n.appendChild(l)}),s.appendChild(n),s}renderTable(e,t){const s=document.createElement("table");s.className="rt-inline-query__table",s.setAttribute("role","table"),s.setAttribute("aria-label","Tasks table");const n=document.createElement("thead"),a=document.createElement("tr");["Status","Task","Dates","Priority","Source",""].forEach(u=>{const h=document.createElement("th");h.textContent=u,a.appendChild(h)}),n.appendChild(a),s.appendChild(n);const o=document.createElement("tbody"),l=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(u=>{const h=document.createElement("tr");h.dataset.taskId=u.id;const p=document.createElement("td"),v=document.createElement("button");v.type="button",v.className="rt-inline-query__checkbox",v.dataset.rtAction="toggle",v.setAttribute("aria-pressed",String(u.status==="done"));const m=u.status==="done"?`Mark incomplete: ${u.name.replace(/"/g,"'")}`:`Mark complete: ${u.name.replace(/"/g,"'")}`;v.setAttribute("aria-label",m),v.textContent=u.status==="done"?"☑":"☐",p.appendChild(v);const k=document.createElement("td");k.textContent=u.name,u.status==="done"&&k.classList.add("rt-inline-query__title--done");const g=document.createElement("td");g.textContent=this.formatTaskDates(u);const y=document.createElement("td");y.textContent=u.priority??"—";const _=document.createElement("td"),D=this.renderSource(u);D?_.appendChild(D):_.textContent="—";const x=document.createElement("td"),E=document.createElement("button");E.type="button",E.className="rt-inline-query__edit",E.dataset.rtAction="edit",E.setAttribute("aria-label",`Edit task: ${u.name.replace(/"/g,"'")}`),E.textContent="Edit",x.appendChild(E),h.appendChild(p),h.appendChild(k),h.appendChild(g),h.appendChild(y),h.appendChild(_),h.appendChild(x),l.appendChild(h)}),o.appendChild(l),s.appendChild(o),s}getRenderedTasks(e,t){return t.maxItems?e.slice(0,t.maxItems):e}formatTaskDates(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),t.length>0?t.join(" · "):"—"}formatTaskMeta(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),e.priority&&t.push(`Priority ${e.priority}`),t.length>0?t.join(" · "):"No dates"}formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString()}catch{return e}}renderSource(e){if(!e.linkedBlockId&&!e.path)return null;const t=document.createElement("a");return t.className="rt-inline-query__source",t.dataset.rtAction="jump",t.dataset.blockId=e.linkedBlockId??"",e.linkedBlockId&&(t.href=`siyuan://blocks/${e.linkedBlockId}`),t.textContent=this.formatSourceLabel(e),t.title=e.path??e.linkedBlockId??"",t}formatSourceLabel(e){if(e.path){const t=e.path.split("/");return t[t.length-1]||e.path}return e.linkedBlockId?"Block":"Source"}renderState(e,t="info"){const s=document.createElement("div");return s.className=`rt-inline-query__state rt-inline-query__state--${t}`,s.textContent=e,s}renderLoadingState(){const e=document.createElement("div");e.className="rt-inline-query__loading",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Loading tasks");const t=document.createElement("div");t.className="rt-inline-query__spinner";const s=document.createElement("div");return s.className="rt-inline-query__loading-text",s.textContent="Building index…",e.appendChild(t),e.appendChild(s),e}renderErrorState(e){const t=document.createElement("div");t.className="rt-inline-query__state rt-inline-query__state--error",t.setAttribute("role","alert");const s=document.createElement("div");s.className="rt-inline-query__error-icon",s.textContent="⚠";const n=document.createElement("div");n.className="rt-inline-query__error-message",n.textContent=e;const a=document.createElement("div");return a.className="rt-inline-query__error-hint",a.textContent="Check your query syntax and try again.",t.appendChild(s),t.appendChild(n),t.appendChild(a),t}renderEmptyState(){const e=document.createElement("div");e.className="rt-inline-query__state rt-inline-query__state--empty";const t=document.createElement("div");t.className="rt-inline-query__empty-icon",t.textContent="📋";const s=document.createElement("div");s.className="rt-inline-query__empty-message",s.textContent="No tasks match this query";const n=document.createElement("div");return n.className="rt-inline-query__empty-hint",n.textContent="Try adjusting your filters or create a new task.",e.appendChild(t),e.appendChild(s),e.appendChild(n),e}}class qy{constructor(e){w(this,"parser",new My);w(this,"renderer",new Ny);w(this,"cache",new Oy);w(this,"queryComposer",new zl(new er));w(this,"blocks",new Map);w(this,"refreshTimer");w(this,"indexReady",!1);w(this,"unsubs",[]);w(this,"debounceMs");w(this,"pageSize");this.options=e,this.debounceMs=e.debounceMs??300,this.pageSize=e.pageSize??50}mount(){var n,a,o,l;this.refreshAll();const{plugin:e}=this.options,t=()=>this.scheduleRefresh(),s=()=>this.scheduleRefresh();try{const c=(a=(n=e.eventBus).on)==null?void 0:a.call(n,"loaded-protyle",t),u=(l=(o=e.eventBus).on)==null?void 0:l.call(o,"switch-protyle",s);typeof c=="function"&&this.unsubs.push(c),typeof u=="function"&&this.unsubs.push(u)}catch(c){st("Inline query controller failed to bind protyle events",c)}this.unsubs.push(Ye.on("task:refresh",()=>{this.cache.clear(),this.scheduleRefresh()})),this.unsubs.push(Ye.on("task:settings",()=>{this.cache.clear(),this.scheduleRefresh()}))}destroy(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.blocks.forEach(({container:e})=>e.remove()),this.blocks.clear(),this.unsubs.forEach(e=>e()),this.unsubs=[]}scheduleRefresh(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.refreshTimer=globalThis.setTimeout(()=>{this.refreshAll()},this.debounceMs)}refreshAll(){const e=this.getProtyleRoots();if(e.length===0)return;const t=new Set;e.forEach(s=>{this.parser.parse(s).forEach(a=>{t.add(a.id);const o=this.getOrCreateBlockState(a);this.renderBlock(o)})}),Array.from(this.blocks.keys()).forEach(s=>{if(!t.has(s)){const n=this.blocks.get(s);n==null||n.container.remove(),this.blocks.delete(s)}}),this.indexReady=!0}renderBlock(e){const{block:t}=e,s=t.view??"list";if(!this.indexReady){this.renderer.render(e.container,{query:t.query,view:s,isIndexing:!0});return}let n,a;try{a=this.executeQuery(t.query)}catch(l){n=l instanceof Error?l.message:String(l)}const o=a?Math.min(e.renderLimit,a.tasks.length):0;this.renderer.render(e.container,{query:t.query,view:s,result:a,error:n,maxItems:e.renderLimit,renderedCount:o})}executeQuery(e){const t=this.options.settingsService.get(),s=this.buildSettingsHash(t),n=this.cache.buildKey(e,s),a=this.cache.get(n);if(a)return a.result;const o={getAllTasks:()=>this.options.repository.getAllTasks()},l=new Fl(o,{urgencySettings:t.urgency}),c=Vr.getInstance();if(c.isEnabled()&&c.getError())throw new Error(`Global query error: ${c.getError()}`);const u=this.queryComposer.compose(e,c.getAST()).ast,h=l.execute(u);return this.cache.set(n,h),h}buildSettingsHash(e){try{return JSON.stringify(e)}catch{return String(Date.now())}}getOrCreateBlockState(e){const t=this.blocks.get(e.id);if(t)return t.block=e,t;const s=document.createElement("div");s.dataset.rtInlineQuery=e.id,s.className="rt-inline-query",e.element.insertAdjacentElement("afterend",s),s.addEventListener("click",a=>this.handleContainerClick(a));const n={block:e,container:s,renderLimit:this.pageSize};return this.blocks.set(e.id,n),n}handleContainerClick(e){const t=e.target;if(!t)return;const s=t.closest("[data-rt-action]");if(!s)return;const n=s.dataset.rtAction,a=t.closest(".rt-inline-query");if(!a)return;const o=a.dataset.rtInlineQuery;if(!o)return;const l=this.blocks.get(o);if(!l)return;if(n==="more"){l.renderLimit+=this.pageSize,this.renderBlock(l);return}const c=t.closest("[data-task-id]"),u=c==null?void 0:c.dataset.taskId;if(u){if(n==="toggle"){this.options.onToggleTask(u);return}if(n==="edit"){const h=this.options.repository.getTask(u);h&&this.options.onEditTask(h)}}}getProtyleRoots(){return Array.from(document.querySelectorAll(".protyle-wysiwyg"))}}class Ry extends Va.Plugin{constructor(){super(...arguments);w(this,"taskManager");w(this,"repository");w(this,"scheduler");w(this,"eventService");w(this,"migrationManager");w(this,"topbarMenu");w(this,"settingsService");w(this,"dashboardComponent",null);w(this,"dockEl");w(this,"quickAddComponent",null);w(this,"quickAddContainer",null);w(this,"taskEditorComponent",null);w(this,"taskEditorContainer",null);w(this,"postponeComponent",null);w(this,"postponeContainer",null);w(this,"pendingCompletionTimeouts",new Map);w(this,"shortcutManager",null);w(this,"inlineQueryController",null);w(this,"handleCreateTaskEvent",t=>{try{const s=t;he("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){Te("Failed to handle create task event",s),$.error("Failed to open task creator.")}});w(this,"handleSettingsEvent",t=>{try{he("Settings event received",t.detail),this.openDock()}catch(s){Te("Failed to handle settings event",s),$.error("Failed to open settings.")}});w(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:n}=s.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(s){Te("Failed to complete task",s),$.error("Failed to complete task.")}});w(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:n,minutes:a}=s.detail??{};if(!n||typeof a!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,a)}catch(s){Te("Failed to snooze task",s),$.error("Failed to snooze task.")}})}async onload(){he("Loading Recurring Tasks Plugin"),this.migrationManager=new Zv(this);try{await this.migrationManager.migrate(cr)}catch(n){Te("Migration failed, continuing with existing data",n)}const t=Vn.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const s=this.taskManager.getSettingsService();this.settingsService=s;try{await this.taskManager.start()}catch(n){Te("Failed to start TaskManager",n)}this.shortcutManager=await Cy(this,this.repository,{createTask:n=>this.dispatchCreateTask(n),completeTask:n=>Ye.emit("task:complete",{taskId:n}),postponeTask:n=>this.openPostponePicker(n),openDock:()=>this.openDock(),openTaskEditor:()=>this.openTaskEditor()},this.scheduler.getRecurrenceEngine(),()=>s.get()),Dy(this),this.topbarMenu=new Iy(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:Gu,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),this.inlineQueryController=new qy({plugin:this,repository:this.repository,settingsService:this.settingsService,onEditTask:n=>this.openTaskEditor(n),onToggleTask:n=>Ye.emit("task:complete",{taskId:n})}),this.inlineQueryController.mount(),he("Recurring Tasks Plugin loaded successfully")}async onunload(){he("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.closePostponePicker(),this.removeEventListeners(),this.shortcutManager&&(this.shortcutManager.destroy(),this.shortcutManager=null),this.inlineQueryController&&(this.inlineQueryController.destroy(),this.inlineQueryController=null)}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=In(jv,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService,shortcutManager:this.shortcutManager,settingsService:this.settingsService}}))}destroyDashboard(){this.dashboardComponent&&(Mn(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Ye.on("task:create",t=>{he("Create task event received",t),this.openQuickAdd(t)}),Ye.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Ye.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Ye.on("task:settings",()=>{this.openDock()}),Ye.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){Te("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Ye.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){$.info(`Completion already pending for "${s.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),Ye.emit("task:refresh",void 0),he(`Task completed: ${s.name}`)}catch(o){Te("Failed to finalize task completion",o),$.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const a=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),$.info(`Undo: "${s.name}" restored`))};ur({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:a,showCountdown:!0})}}async handleSnoozeTask(t,s){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),he(`Task snoozed: ${n.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=In($v,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}openPostponePicker(t){const s=this.repository.getTask(t);if(!s){$.error("Task not found");return}this.postponeComponent&&this.closePostponePicker(),this.postponeContainer=document.createElement("div"),document.body.appendChild(this.postponeContainer),this.postponeComponent=In(Xv,{target:this.postponeContainer,props:{taskName:s.name,onClose:()=>this.closePostponePicker(),onSelect:n=>{Ka(t,n),this.closePostponePicker()}}})}closePostponePicker(){this.postponeComponent&&(Mn(this.postponeComponent),this.postponeComponent=null),this.postponeContainer&&(this.postponeContainer.remove(),this.postponeContainer=null)}dispatchCreateTask(t){Ye.emit("task:create",t),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:t}))}closeQuickAdd(){this.quickAddComponent&&(Mn(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=In(Pl,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(Mn(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=Ry;

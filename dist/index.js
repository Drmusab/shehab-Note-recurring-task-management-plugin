"use strict";var qu=Object.defineProperty;var bo=s=>{throw TypeError(s)};var Fu=(s,e,t)=>e in s?qu(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var y=(s,e,t)=>Fu(s,typeof e!="symbol"?e+"":e,t),za=(s,e,t)=>e.has(s)||bo("Cannot "+t);var N=(s,e,t)=>(za(s,e,"read from private field"),t?t.call(s):e.get(s)),qe=(s,e,t)=>e.has(s)?bo("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Re=(s,e,t,n)=>(za(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t),Ct=(s,e,t)=>(za(s,e,"access private method"),t);const Fi=require("siyuan"),si=!1;var Li=Array.isArray,Lu=Array.prototype.indexOf,Ea=Array.from,Uu=Object.defineProperty,er=Object.getOwnPropertyDescriptor,jl=Object.getOwnPropertyDescriptors,zu=Object.prototype,Bu=Array.prototype,Ui=Object.getPrototypeOf,_o=Object.isExtensible;function Yu(s){for(var e=0;e<s.length;e++)s[e]()}function Hl(){var s,e,t=new Promise((n,r)=>{s=n,e=r});return{promise:t,resolve:s,reject:e}}function $l(s,e){if(Array.isArray(s))return s;if(!(Symbol.iterator in s))return Array.from(s);const t=[];for(const n of s)if(t.push(n),t.length===e)break;return t}const Nt=2,ua=4,xa=8,Wl=1<<24,Wn=16,Gn=32,Fs=64,zi=128,gn=512,qt=1024,zt=2048,Kn=4096,nn=8192,Bn=16384,Bi=32768,lr=65536,ko=1<<17,Gl=1<<18,pr=1<<19,ju=1<<20,Un=1<<25,Rs=32768,ri=1<<21,Yi=1<<22,ls=1<<23,Yn=Symbol("$state"),Hu=Symbol("legacy props"),$u=Symbol(""),Xs=new class extends Error{constructor(){super(...arguments);y(this,"name","StaleReactionError");y(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function ji(s){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Wu(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Gu(s){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Ku(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Vu(s){throw new Error("https://svelte.dev/e/effect_orphan")}function Qu(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Zu(s){throw new Error("https://svelte.dev/e/props_invalid_value")}function Xu(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Ju(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function ed(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function td(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const nd=1,sd=2,Kl=4,rd=8,ad=16,id=1,od=4,ld=8,cd=16,ud=1,dd=2,It=Symbol(),hd="http://www.w3.org/1999/xhtml";function fd(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function vd(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Vl(s){return s===this.v}function Ql(s,e){return s!=s?e==e:s!==e||s!==null&&typeof s=="object"||typeof s=="function"}function Zl(s){return!Ql(s,this.v)}let gd=!1,_t=null;function cr(s){_t=s}function Xl(s){return ec().get(s)}function pd(s,e){return ec().set(s,e),e}function ot(s,e=!1,t){_t={p:_t,i:!1,c:null,e:null,s,x:null,l:null}}function lt(s){var e=_t,t=e.e;if(t!==null){e.e=null;for(var n of t)bc(n)}return e.i=!0,_t=e.p,{}}function Jl(){return!0}function ec(s){return _t===null&&ji(),_t.c??(_t.c=new Map(md(_t)||void 0))}function md(s){let e=s.p;for(;e!==null;){const t=e.c;if(t!==null)return t;e=e.p}return null}let ks=[];function tc(){var s=ks;ks=[],Yu(s)}function mr(s){if(ks.length===0&&!xr){var e=ks;queueMicrotask(()=>{e===ks&&tc()})}ks.push(s)}function yd(){for(;ks.length>0;)tc()}function nc(s){var e=We;if(e===null)return Ne.f|=ls,s;if(e.f&Bi)ur(s,e);else{if(!(e.f&zi))throw s;e.b.error(s)}}function ur(s,e){for(;e!==null;){if(e.f&zi)try{e.b.error(s);return}catch(t){s=t}e=e.parent}throw s}const bd=-7169;function St(s,e){s.f=s.f&bd|e}function Hi(s){s.f&gn||s.deps===null?St(s,qt):St(s,Kn)}function sc(s){if(s!==null)for(const e of s)!(e.f&Nt)||!(e.f&Rs)||(e.f^=Rs,sc(e.deps))}function rc(s,e,t){s.f&zt?e.add(s):s.f&Kn&&t.add(s),sc(s.deps),St(s,qt)}const Vr=new Set;let Oe=null,Er=null,Mt=null,hn=[],Aa=null,ai=!1,xr=!1;var nr,sr,Ss,Ds,qr,rr,ar,pn,ii,oi,ac,ic;const Ta=class Ta{constructor(){qe(this,pn);y(this,"committed",!1);y(this,"current",new Map);y(this,"previous",new Map);qe(this,nr,new Set);qe(this,sr,new Set);qe(this,Ss,0);qe(this,Ds,0);qe(this,qr,null);qe(this,rr,new Set);qe(this,ar,new Set);y(this,"skipped_effects",new Set);y(this,"is_fork",!1)}is_deferred(){return this.is_fork||N(this,Ds)>0}process(e){var r;hn=[],Er=null,this.apply();var t=[],n=[];for(const a of e)Ct(this,pn,ii).call(this,a,t,n);this.is_fork||Ct(this,pn,ac).call(this),this.is_deferred()?(Ct(this,pn,oi).call(this,n),Ct(this,pn,oi).call(this,t)):(Er=this,Oe=null,wo(n),wo(t),Er=null,(r=N(this,qr))==null||r.resolve()),Mt=null}capture(e,t){t!==It&&!this.previous.has(e)&&this.previous.set(e,t),e.f&ls||(this.current.set(e,e.v),Mt==null||Mt.set(e,e.v))}activate(){Oe=this,this.apply()}deactivate(){Oe===this&&(Oe=null,Mt=null)}flush(){if(this.activate(),hn.length>0){if(oc(),Oe!==null&&Oe!==this)return}else N(this,Ss)===0&&this.process([]);this.deactivate()}discard(){for(const e of N(this,sr))e(this);N(this,sr).clear()}increment(e){Re(this,Ss,N(this,Ss)+1),e&&Re(this,Ds,N(this,Ds)+1)}decrement(e){Re(this,Ss,N(this,Ss)-1),e&&Re(this,Ds,N(this,Ds)-1),this.revive()}revive(){for(const e of N(this,rr))N(this,ar).delete(e),St(e,zt),Hn(e);for(const e of N(this,ar))St(e,Kn),Hn(e);this.flush()}oncommit(e){N(this,nr).add(e)}ondiscard(e){N(this,sr).add(e)}settled(){return(N(this,qr)??Re(this,qr,Hl())).promise}static ensure(){if(Oe===null){const e=Oe=new Ta;Vr.add(Oe),xr||Ta.enqueue(()=>{Oe===e&&e.flush()})}return Oe}static enqueue(e){mr(e)}apply(){}};nr=new WeakMap,sr=new WeakMap,Ss=new WeakMap,Ds=new WeakMap,qr=new WeakMap,rr=new WeakMap,ar=new WeakMap,pn=new WeakSet,ii=function(e,t,n){e.f^=qt;for(var r=e.first,a=null;r!==null;){var i=r.f,l=(i&(Gn|Fs))!==0,c=l&&(i&qt)!==0,u=c||(i&nn)!==0||this.skipped_effects.has(r);if(!u&&r.fn!==null){l?r.f^=qt:a!==null&&i&(ua|xa|Wl)?a.b.defer_effect(r):i&ua?t.push(r):Br(r)&&(i&Wn&&N(this,rr).add(r),Or(r));var h=r.first;if(h!==null){r=h;continue}}var v=r.parent;for(r=r.next;r===null&&v!==null;)v===a&&(a=null),r=v.next,v=v.parent}},oi=function(e){for(var t=0;t<e.length;t+=1)rc(e[t],N(this,rr),N(this,ar))},ac=function(){if(N(this,Ds)===0){for(const e of N(this,nr))e();N(this,nr).clear()}N(this,Ss)===0&&Ct(this,pn,ic).call(this)},ic=function(){var r;if(Vr.size>1){this.previous.clear();var e=Mt,t=!0;for(const a of Vr){if(a===this){t=!1;continue}const i=[];for(const[c,u]of this.current){if(a.current.has(c))if(t&&u!==a.current.get(c))a.current.set(c,u);else continue;i.push(c)}if(i.length===0)continue;const l=[...a.current.keys()].filter(c=>!this.current.has(c));if(l.length>0){var n=hn;hn=[];const c=new Set,u=new Map;for(const h of i)lc(h,l,c,u);if(hn.length>0){Oe=a,a.apply();for(const h of hn)Ct(r=a,pn,ii).call(r,h,[],[]);a.deactivate()}hn=n}}Oe=null,Mt=e}this.committed=!0,Vr.delete(this)};let zn=Ta;function _d(s){var e=xr;xr=!0;try{for(var t;;){if(yd(),hn.length===0&&(Oe==null||Oe.flush(),hn.length===0))return Aa=null,t;oc()}}finally{xr=e}}function oc(){var s=Ms;ai=!0;var e=null;try{var t=0;for(ha(!0);hn.length>0;){var n=zn.ensure();if(t++>1e3){var r,a;kd()}n.process(hn),cs.clear()}}finally{ai=!1,ha(s),Aa=null}}function kd(){try{Qu()}catch(s){ur(s,Aa)}}let yn=null;function wo(s){var e=s.length;if(e!==0){for(var t=0;t<e;){var n=s[t++];if(!(n.f&(Bn|nn))&&Br(n)&&(yn=new Set,Or(n),n.deps===null&&n.first===null&&n.nodes===null&&(n.teardown===null&&n.ac===null?Tc(n):n.fn=null),(yn==null?void 0:yn.size)>0)){cs.clear();for(const r of yn){if(r.f&(Bn|nn))continue;const a=[r];let i=r.parent;for(;i!==null;)yn.has(i)&&(yn.delete(i),a.push(i)),i=i.parent;for(let l=a.length-1;l>=0;l--){const c=a[l];c.f&(Bn|nn)||Or(c)}}yn.clear()}}yn=null}}function lc(s,e,t,n){if(!t.has(s)&&(t.add(s),s.reactions!==null))for(const r of s.reactions){const a=r.f;a&Nt?lc(r,e,t,n):a&(Yi|Wn)&&!(a&zt)&&cc(r,e,n)&&(St(r,zt),Hn(r))}}function cc(s,e,t){const n=t.get(s);if(n!==void 0)return n;if(s.deps!==null)for(const r of s.deps){if(e.includes(r))return!0;if(r.f&Nt&&cc(r,e,t))return t.set(r,!0),!0}return t.set(s,!1),!1}function Hn(s){for(var e=Aa=s;e.parent!==null;){e=e.parent;var t=e.f;if(ai&&e===We&&t&Wn&&!(t&Gl))return;if(t&(Fs|Gn)){if(!(t&qt))return;e.f^=qt}}hn.push(e)}function wd(s){let e=0,t=Ps(0),n;return()=>{Gi()&&(o(t),zr(()=>(e===0&&(n=fs(()=>s(()=>Ar(t)))),e+=1,()=>{mr(()=>{e-=1,e===0&&(n==null||n(),n=void 0,Ar(t))})})))}}var Td=lr|pr|zi;function Sd(s,e,t){new Dd(s,e,t)}var cn,qi,xn,Es,An,un,$t,Cn,Ln,ns,xs,ss,As,ir,or,rs,Sa,Tt,Ed,xd,li,ra,aa,ci;class Dd{constructor(e,t,n){qe(this,Tt);y(this,"parent");y(this,"is_pending",!1);qe(this,cn);qe(this,qi,null);qe(this,xn);qe(this,Es);qe(this,An);qe(this,un,null);qe(this,$t,null);qe(this,Cn,null);qe(this,Ln,null);qe(this,ns,null);qe(this,xs,0);qe(this,ss,0);qe(this,As,!1);qe(this,ir,new Set);qe(this,or,new Set);qe(this,rs,null);qe(this,Sa,wd(()=>(Re(this,rs,Ps(N(this,xs))),()=>{Re(this,rs,null)})));Re(this,cn,e),Re(this,xn,t),Re(this,Es,n),this.parent=We.b,this.is_pending=!!N(this,xn).pending,Re(this,An,Qi(()=>{We.b=this;{var r=Ct(this,Tt,li).call(this);try{Re(this,un,fn(()=>n(r)))}catch(a){this.error(a)}N(this,ss)>0?Ct(this,Tt,aa).call(this):this.is_pending=!1}return()=>{var a;(a=N(this,ns))==null||a.remove()}},Td))}defer_effect(e){rc(e,N(this,ir),N(this,or))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!N(this,xn).pending}update_pending_count(e){Ct(this,Tt,ci).call(this,e),Re(this,xs,N(this,xs)+e),N(this,rs)&&dr(N(this,rs),N(this,xs))}get_effect_pending(){return N(this,Sa).call(this),o(N(this,rs))}error(e){var t=N(this,xn).onerror;let n=N(this,xn).failed;if(N(this,As)||!t&&!n)throw e;N(this,un)&&(Kt(N(this,un)),Re(this,un,null)),N(this,$t)&&(Kt(N(this,$t)),Re(this,$t,null)),N(this,Cn)&&(Kt(N(this,Cn)),Re(this,Cn,null));var r=!1,a=!1;const i=()=>{if(r){vd();return}r=!0,a&&td(),zn.ensure(),Re(this,xs,0),N(this,Cn)!==null&&Is(N(this,Cn),()=>{Re(this,Cn,null)}),this.is_pending=this.has_pending_snippet(),Re(this,un,Ct(this,Tt,ra).call(this,()=>(Re(this,As,!1),fn(()=>N(this,Es).call(this,N(this,cn)))))),N(this,ss)>0?Ct(this,Tt,aa).call(this):this.is_pending=!1};var l=Ne;try{Gt(null),a=!0,t==null||t(e,i),a=!1}catch(c){ur(c,N(this,An)&&N(this,An).parent)}finally{Gt(l)}n&&mr(()=>{Re(this,Cn,Ct(this,Tt,ra).call(this,()=>{zn.ensure(),Re(this,As,!0);try{return fn(()=>{n(N(this,cn),()=>e,()=>i)})}catch(c){return ur(c,N(this,An).parent),null}finally{Re(this,As,!1)}}))})}}cn=new WeakMap,qi=new WeakMap,xn=new WeakMap,Es=new WeakMap,An=new WeakMap,un=new WeakMap,$t=new WeakMap,Cn=new WeakMap,Ln=new WeakMap,ns=new WeakMap,xs=new WeakMap,ss=new WeakMap,As=new WeakMap,ir=new WeakMap,or=new WeakMap,rs=new WeakMap,Sa=new WeakMap,Tt=new WeakSet,Ed=function(){try{Re(this,un,fn(()=>N(this,Es).call(this,N(this,cn))))}catch(e){this.error(e)}},xd=function(){const e=N(this,xn).pending;e&&(Re(this,$t,fn(()=>e(N(this,cn)))),zn.enqueue(()=>{var t=Ct(this,Tt,li).call(this);Re(this,un,Ct(this,Tt,ra).call(this,()=>(zn.ensure(),fn(()=>N(this,Es).call(this,t))))),N(this,ss)>0?Ct(this,Tt,aa).call(this):(Is(N(this,$t),()=>{Re(this,$t,null)}),this.is_pending=!1)}))},li=function(){var e=N(this,cn);return this.is_pending&&(Re(this,ns,jn()),N(this,cn).before(N(this,ns)),e=N(this,ns)),e},ra=function(e){var t=We,n=Ne,r=_t;On(N(this,An)),Gt(N(this,An)),cr(N(this,An).ctx);try{return e()}catch(a){return nc(a),null}finally{On(t),Gt(n),cr(r)}},aa=function(){const e=N(this,xn).pending;N(this,un)!==null&&(Re(this,Ln,document.createDocumentFragment()),N(this,Ln).append(N(this,ns)),Ec(N(this,un),N(this,Ln))),N(this,$t)===null&&Re(this,$t,fn(()=>e(N(this,cn))))},ci=function(e){var t;if(!this.has_pending_snippet()){this.parent&&Ct(t=this.parent,Tt,ci).call(t,e);return}if(Re(this,ss,N(this,ss)+e),N(this,ss)===0){this.is_pending=!1;for(const n of N(this,ir))St(n,zt),Hn(n);for(const n of N(this,or))St(n,Kn),Hn(n);N(this,ir).clear(),N(this,or).clear(),N(this,$t)&&Is(N(this,$t),()=>{Re(this,$t,null)}),N(this,Ln)&&(N(this,cn).before(N(this,Ln)),Re(this,Ln,null))}};function Ad(s,e,t,n){const r=Ca;if(t.length===0&&s.length===0){n(e.map(r));return}var a=Oe,i=We,l=Cd();function c(){Promise.all(t.map(u=>Id(u))).then(u=>{l();try{n([...e.map(r),...u])}catch(h){i.f&Bn||ur(h,i)}a==null||a.deactivate(),da()}).catch(u=>{ur(u,i)})}s.length>0?Promise.all(s).then(()=>{l();try{return c()}finally{a==null||a.deactivate(),da()}}):c()}function Cd(){var s=We,e=Ne,t=_t,n=Oe;return function(a=!0){On(s),Gt(e),cr(t),a&&(n==null||n.activate())}}function da(){On(null),Gt(null),cr(null)}function Ca(s){var e=Nt|zt,t=Ne!==null&&Ne.f&Nt?Ne:null;return We!==null&&(We.f|=pr),{ctx:_t,deps:null,effects:null,equals:Vl,f:e,fn:s,reactions:null,rv:0,v:It,wv:0,parent:t??We,ac:null}}function Id(s,e,t){let n=We;n===null&&Wu();var r=n.b,a=void 0,i=Ps(It),l=!Ne,c=new Map;return Bd(()=>{var m;var u=Hl();a=u.promise;try{Promise.resolve(s()).then(u.resolve,u.reject).then(()=>{h===Oe&&h.committed&&h.deactivate(),da()})}catch(k){u.reject(k),da()}var h=Oe;if(l){var v=r.is_rendered();r.update_pending_count(1),h.increment(v),(m=c.get(h))==null||m.reject(Xs),c.delete(h),c.set(h,u)}const p=(k,_=void 0)=>{if(h.activate(),_)_!==Xs&&(i.f|=ls,dr(i,_));else{i.f&ls&&(i.f^=ls),dr(i,k);for(const[g,w]of c){if(c.delete(g),g===h)break;w.reject(Xs)}}l&&(r.update_pending_count(-1),h.decrement(v))};u.promise.then(p,k=>p(null,k||"unknown"))}),Ki(()=>{for(const u of c.values())u.reject(Xs)}),new Promise(u=>{function h(v){function p(){v===a?u(i):h(a)}v.then(p,p)}h(a)})}function V(s){const e=Ca(s);return xc(e),e}function uc(s){const e=Ca(s);return e.equals=Zl,e}function dc(s){var e=s.effects;if(e!==null){s.effects=null;for(var t=0;t<e.length;t+=1)Kt(e[t])}}function Md(s){for(var e=s.parent;e!==null;){if(!(e.f&Nt))return e.f&Bn?null:e;e=e.parent}return null}function $i(s){var e,t=We;On(Md(s));try{s.f&=~Rs,dc(s),e=Mc(s)}finally{On(t)}return e}function hc(s){var e=$i(s);if(!s.equals(e)&&(s.wv=Cc(),(!(Oe!=null&&Oe.is_fork)||s.deps===null)&&(s.v=e,s.deps===null))){St(s,qt);return}hs||(Mt!==null?(Gi()||Oe!=null&&Oe.is_fork)&&Mt.set(s,e):Hi(s))}let ui=new Set;const cs=new Map;let fc=!1;function Ps(s,e){var t={f:0,v:s,reactions:null,equals:Vl,rv:0,wv:0};return t}function G(s,e){const t=Ps(s);return xc(t),t}function Od(s,e=!1,t=!0){const n=Ps(s);return e||(n.equals=Zl),n}function b(s,e,t=!1){Ne!==null&&(!kn||Ne.f&ko)&&Jl()&&Ne.f&(Nt|Wn|Yi|ko)&&!(Ut!=null&&Ut.includes(s))&&ed();let n=t?De(e):e;return dr(s,n)}function dr(s,e){if(!s.equals(e)){var t=s.v;hs?cs.set(s,e):cs.set(s,t),s.v=e;var n=zn.ensure();if(n.capture(s,t),s.f&Nt){const r=s;s.f&zt&&$i(r),Hi(r)}s.wv=Cc(),vc(s,zt),We!==null&&We.f&qt&&!(We.f&(Gn|Fs))&&(ln===null?jd([s]):ln.push(s)),!n.is_fork&&ui.size>0&&!fc&&Nd()}return e}function Nd(){fc=!1;var s=Ms;ha(!0);const e=Array.from(ui);try{for(const t of e)t.f&qt&&St(t,Kn),Br(t)&&Or(t)}finally{ha(s)}ui.clear()}function To(s,e=1){var t=o(s),n=e===1?t++:t--;return b(s,t),n}function Ar(s){b(s,s.v+1)}function vc(s,e){var t=s.reactions;if(t!==null)for(var n=t.length,r=0;r<n;r++){var a=t[r],i=a.f,l=(i&zt)===0;if(l&&St(a,e),i&Nt){var c=a;Mt==null||Mt.delete(c),i&Rs||(i&gn&&(a.f|=Rs),vc(c,Kn))}else l&&(i&Wn&&yn!==null&&yn.add(a),Hn(a))}}function De(s){if(typeof s!="object"||s===null||Yn in s)return s;const e=Ui(s);if(e!==zu&&e!==Bu)return s;var t=new Map,n=Li(s),r=G(0),a=Os,i=l=>{if(Os===a)return l();var c=Ne,u=Os;Gt(null),Ao(a);var h=l();return Gt(c),Ao(u),h};return n&&t.set("length",G(s.length)),new Proxy(s,{defineProperty(l,c,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&Xu();var h=t.get(c);return h===void 0?h=i(()=>{var v=G(u.value);return t.set(c,v),v}):b(h,u.value,!0),!0},deleteProperty(l,c){var u=t.get(c);if(u===void 0){if(c in l){const h=i(()=>G(It));t.set(c,h),Ar(r)}}else b(u,It),Ar(r);return!0},get(l,c,u){var m;if(c===Yn)return s;var h=t.get(c),v=c in l;if(h===void 0&&(!v||(m=er(l,c))!=null&&m.writable)&&(h=i(()=>{var k=De(v?l[c]:It),_=G(k);return _}),t.set(c,h)),h!==void 0){var p=o(h);return p===It?void 0:p}return Reflect.get(l,c,u)},getOwnPropertyDescriptor(l,c){var u=Reflect.getOwnPropertyDescriptor(l,c);if(u&&"value"in u){var h=t.get(c);h&&(u.value=o(h))}else if(u===void 0){var v=t.get(c),p=v==null?void 0:v.v;if(v!==void 0&&p!==It)return{enumerable:!0,configurable:!0,value:p,writable:!0}}return u},has(l,c){var p;if(c===Yn)return!0;var u=t.get(c),h=u!==void 0&&u.v!==It||Reflect.has(l,c);if(u!==void 0||We!==null&&(!h||(p=er(l,c))!=null&&p.writable)){u===void 0&&(u=i(()=>{var m=h?De(l[c]):It,k=G(m);return k}),t.set(c,u));var v=o(u);if(v===It)return!1}return h},set(l,c,u,h){var E;var v=t.get(c),p=c in l;if(n&&c==="length")for(var m=u;m<v.v;m+=1){var k=t.get(m+"");k!==void 0?b(k,It):m in l&&(k=i(()=>G(It)),t.set(m+"",k))}if(v===void 0)(!p||(E=er(l,c))!=null&&E.writable)&&(v=i(()=>G(void 0)),b(v,De(u)),t.set(c,v));else{p=v.v!==It;var _=i(()=>De(u));b(v,_)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g!=null&&g.set&&g.set.call(h,u),!p){if(n&&typeof c=="string"){var w=t.get("length"),S=Number(c);Number.isInteger(S)&&S>=w.v&&b(w,S+1)}Ar(r)}return!0},ownKeys(l){o(r);var c=Reflect.ownKeys(l).filter(v=>{var p=t.get(v);return p===void 0||p.v!==It});for(var[u,h]of t)h.v!==It&&!(u in l)&&c.push(u);return c},setPrototypeOf(){Ju()}})}function So(s){try{if(s!==null&&typeof s=="object"&&Yn in s)return s[Yn]}catch{}return s}function Rd(s,e){return Object.is(So(s),So(e))}var Do,gc,pc,mc;function Pd(){if(Do===void 0){Do=window,gc=/Firefox/.test(navigator.userAgent);var s=Element.prototype,e=Node.prototype,t=Text.prototype;pc=er(e,"firstChild").get,mc=er(e,"nextSibling").get,_o(s)&&(s.__click=void 0,s.__className=void 0,s.__attributes=null,s.__style=void 0,s.__e=void 0),_o(t)&&(t.__t=void 0)}}function jn(s=""){return document.createTextNode(s)}function as(s){return pc.call(s)}function Ur(s){return mc.call(s)}function d(s,e){return as(s)}function Ve(s,e=!1){{var t=as(s);return t instanceof Comment&&t.data===""?Ur(t):t}}function f(s,e=1,t=!1){let n=s;for(;e--;)n=Ur(n);return n}function qd(s){s.textContent=""}function yc(){return!1}let Eo=!1;function Fd(){Eo||(Eo=!0,document.addEventListener("reset",s=>{Promise.resolve().then(()=>{var e;if(!s.defaultPrevented)for(const t of s.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Ia(s){var e=Ne,t=We;Gt(null),On(null);try{return s()}finally{Gt(e),On(t)}}function Wi(s,e,t,n=t){s.addEventListener(e,()=>Ia(t));const r=s.__on_r;r?s.__on_r=()=>{r(),n(!0)}:s.__on_r=()=>n(!0),Fd()}function Ld(s){We===null&&(Ne===null&&Vu(),Ku()),hs&&Gu()}function Ud(s,e){var t=e.last;t===null?e.last=e.first=s:(t.next=s,s.prev=t,e.last=s)}function Vn(s,e,t){var n=We;n!==null&&n.f&nn&&(s|=nn);var r={ctx:_t,deps:null,nodes:null,f:s|zt|gn,first:null,fn:e,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{Or(r),r.f|=Bi}catch(l){throw Kt(r),l}else e!==null&&Hn(r);var a=r;if(t&&a.deps===null&&a.teardown===null&&a.nodes===null&&a.first===a.last&&!(a.f&pr)&&(a=a.first,s&Wn&&s&lr&&a!==null&&(a.f|=lr)),a!==null&&(a.parent=n,n!==null&&Ud(a,n),Ne!==null&&Ne.f&Nt&&!(s&Fs))){var i=Ne;(i.effects??(i.effects=[])).push(a)}return r}function Gi(){return Ne!==null&&!kn}function Ki(s){const e=Vn(xa,null,!1);return St(e,qt),e.teardown=s,e}function wt(s){Ld();var e=We.f,t=!Ne&&(e&Gn)!==0&&(e&Bi)===0;if(t){var n=_t;(n.e??(n.e=[])).push(s)}else return bc(s)}function bc(s){return Vn(ua|ju,s,!1)}function zd(s){zn.ensure();const e=Vn(Fs|pr,s,!0);return(t={})=>new Promise(n=>{t.outro?Is(e,()=>{Kt(e),n(void 0)}):(Kt(e),n(void 0))})}function Vi(s){return Vn(ua,s,!1)}function Bd(s){return Vn(Yi|pr,s,!0)}function zr(s,e=0){return Vn(xa|e,s,!0)}function Y(s,e=[],t=[],n=[]){Ad(n,e,t,r=>{Vn(xa,()=>s(...r.map(o)),!0)})}function Qi(s,e=0){var t=Vn(Wn|e,s,!0);return t}function fn(s){return Vn(Gn|pr,s,!0)}function _c(s){var e=s.teardown;if(e!==null){const t=hs,n=Ne;xo(!0),Gt(null);try{e.call(null)}finally{xo(t),Gt(n)}}}function kc(s,e=!1){var t=s.first;for(s.first=s.last=null;t!==null;){const r=t.ac;r!==null&&Ia(()=>{r.abort(Xs)});var n=t.next;t.f&Fs?t.parent=null:Kt(t,e),t=n}}function Yd(s){for(var e=s.first;e!==null;){var t=e.next;e.f&Gn||Kt(e),e=t}}function Kt(s,e=!0){var t=!1;(e||s.f&Gl)&&s.nodes!==null&&s.nodes.end!==null&&(wc(s.nodes.start,s.nodes.end),t=!0),kc(s,e&&!t),fa(s,0),St(s,Bn);var n=s.nodes&&s.nodes.t;if(n!==null)for(const a of n)a.stop();_c(s);var r=s.parent;r!==null&&r.first!==null&&Tc(s),s.next=s.prev=s.teardown=s.ctx=s.deps=s.fn=s.nodes=s.ac=null}function wc(s,e){for(;s!==null;){var t=s===e?null:Ur(s);s.remove(),s=t}}function Tc(s){var e=s.parent,t=s.prev,n=s.next;t!==null&&(t.next=n),n!==null&&(n.prev=t),e!==null&&(e.first===s&&(e.first=n),e.last===s&&(e.last=t))}function Is(s,e,t=!0){var n=[];Sc(s,n,!0);var r=()=>{t&&Kt(s),e&&e()},a=n.length;if(a>0){var i=()=>--a||r();for(var l of n)l.out(i)}else r()}function Sc(s,e,t){if(!(s.f&nn)){s.f^=nn;var n=s.nodes&&s.nodes.t;if(n!==null)for(const l of n)(l.is_global||t)&&e.push(l);for(var r=s.first;r!==null;){var a=r.next,i=(r.f&lr)!==0||(r.f&Gn)!==0&&(s.f&Wn)!==0;Sc(r,e,i?t:!1),r=a}}}function Zi(s){Dc(s,!0)}function Dc(s,e){if(s.f&nn){s.f^=nn,s.f&qt||(St(s,zt),Hn(s));for(var t=s.first;t!==null;){var n=t.next,r=(t.f&lr)!==0||(t.f&Gn)!==0;Dc(t,r?e:!1),t=n}var a=s.nodes&&s.nodes.t;if(a!==null)for(const i of a)(i.is_global||e)&&i.in()}}function Ec(s,e){if(s.nodes)for(var t=s.nodes.start,n=s.nodes.end;t!==null;){var r=t===n?null:Ur(t);e.append(t),t=r}}let Ms=!1;function ha(s){Ms=s}let hs=!1;function xo(s){hs=s}let Ne=null,kn=!1;function Gt(s){Ne=s}let We=null;function On(s){We=s}let Ut=null;function xc(s){Ne!==null&&(Ut===null?Ut=[s]:Ut.push(s))}let Ft=null,Jt=0,ln=null;function jd(s){ln=s}let Ac=1,Mr=0,Os=Mr;function Ao(s){Os=s}function Cc(){return++Ac}function Br(s){var e=s.f;if(e&zt)return!0;if(e&Nt&&(s.f&=~Rs),e&Kn){for(var t=s.deps,n=t.length,r=0;r<n;r++){var a=t[r];if(Br(a)&&hc(a),a.wv>s.wv)return!0}e&gn&&Mt===null&&St(s,qt)}return!1}function Ic(s,e,t=!0){var n=s.reactions;if(n!==null&&!(Ut!=null&&Ut.includes(s)))for(var r=0;r<n.length;r++){var a=n[r];a.f&Nt?Ic(a,e,!1):e===a&&(t?St(a,zt):a.f&qt&&St(a,Kn),Hn(a))}}function Mc(s){var k;var e=Ft,t=Jt,n=ln,r=Ne,a=Ut,i=_t,l=kn,c=Os,u=s.f;Ft=null,Jt=0,ln=null,Ne=u&(Gn|Fs)?null:s,Ut=null,cr(s.ctx),kn=!1,Os=++Mr,s.ac!==null&&(Ia(()=>{s.ac.abort(Xs)}),s.ac=null);try{s.f|=ri;var h=s.fn,v=h(),p=s.deps;if(Ft!==null){var m;if(fa(s,Jt),p!==null&&Jt>0)for(p.length=Jt+Ft.length,m=0;m<Ft.length;m++)p[Jt+m]=Ft[m];else s.deps=p=Ft;if(Gi()&&s.f&gn)for(m=Jt;m<p.length;m++)((k=p[m]).reactions??(k.reactions=[])).push(s)}else p!==null&&Jt<p.length&&(fa(s,Jt),p.length=Jt);if(Jl()&&ln!==null&&!kn&&p!==null&&!(s.f&(Nt|Kn|zt)))for(m=0;m<ln.length;m++)Ic(ln[m],s);return r!==null&&r!==s&&(Mr++,ln!==null&&(n===null?n=ln:n.push(...ln))),s.f&ls&&(s.f^=ls),v}catch(_){return nc(_)}finally{s.f^=ri,Ft=e,Jt=t,ln=n,Ne=r,Ut=a,cr(i),kn=l,Os=c}}function Hd(s,e){let t=e.reactions;if(t!==null){var n=Lu.call(t,s);if(n!==-1){var r=t.length-1;r===0?t=e.reactions=null:(t[n]=t[r],t.pop())}}if(t===null&&e.f&Nt&&(Ft===null||!Ft.includes(e))){var a=e;a.f&gn&&(a.f^=gn,a.f&=~Rs),Hi(a),dc(a),fa(a,0)}}function fa(s,e){var t=s.deps;if(t!==null)for(var n=e;n<t.length;n++)Hd(s,t[n])}function Or(s){var e=s.f;if(!(e&Bn)){St(s,qt);var t=We,n=Ms;We=s,Ms=!0;try{e&(Wn|Wl)?Yd(s):kc(s),_c(s);var r=Mc(s);s.teardown=typeof r=="function"?r:null,s.wv=Ac;var a;si&&gd&&s.f&zt&&s.deps}finally{Ms=n,We=t}}}async function Oc(){await Promise.resolve(),_d()}function o(s){var e=s.f,t=(e&Nt)!==0;if(Ne!==null&&!kn){var n=We!==null&&(We.f&Bn)!==0;if(!n&&!(Ut!=null&&Ut.includes(s))){var r=Ne.deps;if(Ne.f&ri)s.rv<Mr&&(s.rv=Mr,Ft===null&&r!==null&&r[Jt]===s?Jt++:Ft===null?Ft=[s]:Ft.includes(s)||Ft.push(s));else{(Ne.deps??(Ne.deps=[])).push(s);var a=s.reactions;a===null?s.reactions=[Ne]:a.includes(Ne)||a.push(Ne)}}}if(hs&&cs.has(s))return cs.get(s);if(t){var i=s;if(hs){var l=i.v;return(!(i.f&qt)&&i.reactions!==null||Rc(i))&&(l=$i(i)),cs.set(i,l),l}var c=(i.f&gn)===0&&!kn&&Ne!==null&&(Ms||(Ne.f&gn)!==0),u=i.deps===null;Br(i)&&(c&&(i.f|=gn),hc(i)),c&&!u&&Nc(i)}if(Mt!=null&&Mt.has(s))return Mt.get(s);if(s.f&ls)throw s.v;return s.v}function Nc(s){if(s.deps!==null){s.f|=gn;for(const e of s.deps)(e.reactions??(e.reactions=[])).push(s),e.f&Nt&&!(e.f&gn)&&Nc(e)}}function Rc(s){if(s.v===It)return!0;if(s.deps===null)return!1;for(const e of s.deps)if(cs.has(e)||e.f&Nt&&Rc(e))return!0;return!1}function fs(s){var e=kn;try{return kn=!0,s()}finally{kn=e}}function $d(s){if(!(typeof s!="object"||!s||s instanceof EventTarget)){if(Yn in s)di(s);else if(!Array.isArray(s))for(let e in s){const t=s[e];typeof t=="object"&&t&&Yn in t&&di(t)}}}function di(s,e=new Set){if(typeof s=="object"&&s!==null&&!(s instanceof EventTarget)&&!e.has(s)){e.add(s),s instanceof Date&&s.getTime();for(let n in s)try{di(s[n],e)}catch{}const t=Ui(s);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const n=jl(t);for(let r in n){const a=n[r].get;if(a)try{a.call(s)}catch{}}}}}const Wd=["touchstart","touchmove"];function Gd(s){return Wd.includes(s)}const Pc=new Set,hi=new Set;function Kd(s,e,t,n={}){function r(a){if(n.capture||Tr.call(e,a),!a.cancelBubble)return Ia(()=>t==null?void 0:t.call(this,a))}return s.startsWith("pointer")||s.startsWith("touch")||s==="wheel"?mr(()=>{e.addEventListener(s,r,n)}):e.addEventListener(s,r,n),r}function Ot(s,e,t,n,r){var a={capture:n,passive:r},i=Kd(s,e,t,a);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Ki(()=>{e.removeEventListener(s,i,a)})}function mt(s){for(var e=0;e<s.length;e++)Pc.add(s[e]);for(var t of hi)t(s)}let Co=null;function Tr(s){var g;var e=this,t=e.ownerDocument,n=s.type,r=((g=s.composedPath)==null?void 0:g.call(s))||[],a=r[0]||s.target;Co=s;var i=0,l=Co===s&&s.__root;if(l){var c=r.indexOf(l);if(c!==-1&&(e===document||e===window)){s.__root=e;return}var u=r.indexOf(e);if(u===-1)return;c<=u&&(i=c)}if(a=r[i]||s.target,a!==e){Uu(s,"currentTarget",{configurable:!0,get(){return a||t}});var h=Ne,v=We;Gt(null),On(null);try{for(var p,m=[];a!==null;){var k=a.assignedSlot||a.parentNode||a.host||null;try{var _=a["__"+n];_!=null&&(!a.disabled||s.target===a)&&_.call(a,s)}catch(w){p?m.push(w):p=w}if(s.cancelBubble||k===e||k===null)break;a=k}if(p){for(let w of m)queueMicrotask(()=>{throw w});throw p}}finally{s.__root=e,delete s.currentTarget,Gt(h),On(v)}}}function qc(s){var e=document.createElement("template");return e.innerHTML=s.replaceAll("<!>","<!---->"),e.content}function Nr(s,e){var t=We;t.nodes===null&&(t.nodes={start:s,end:e,a:null,t:null})}function A(s,e){var t=(e&ud)!==0,n=(e&dd)!==0,r,a=!s.startsWith("<!>");return()=>{r===void 0&&(r=qc(a?s:"<!>"+s),t||(r=as(r)));var i=n||gc?document.importNode(r,!0):r.cloneNode(!0);if(t){var l=as(i),c=i.lastChild;Nr(l,c)}else Nr(i,i);return i}}function Ba(s=""){{var e=jn(s+"");return Nr(e,e),e}}function ht(){var s=document.createDocumentFragment(),e=document.createComment(""),t=jn();return s.append(e,t),Nr(e,t),s}function T(s,e){s!==null&&s.before(e)}function M(s,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(s.__t??(s.__t=s.nodeValue))&&(s.__t=t,s.nodeValue=t+"")}function Qr(s,e){return Vd(s,e)}const $s=new Map;function Vd(s,{target:e,anchor:t,props:n={},events:r,context:a,intro:i=!0}){Pd();var l=new Set,c=v=>{for(var p=0;p<v.length;p++){var m=v[p];if(!l.has(m)){l.add(m);var k=Gd(m);e.addEventListener(m,Tr,{passive:k});var _=$s.get(m);_===void 0?(document.addEventListener(m,Tr,{passive:k}),$s.set(m,1)):$s.set(m,_+1)}}};c(Ea(Pc)),hi.add(c);var u=void 0,h=zd(()=>{var v=t??e.appendChild(jn());return Sd(v,{pending:()=>{}},p=>{if(a){ot({});var m=_t;m.c=a}r&&(n.$$events=r),u=s(p,n)||{},a&&lt()}),()=>{var k;for(var p of l){e.removeEventListener(p,Tr);var m=$s.get(p);--m===0?(document.removeEventListener(p,Tr),$s.delete(p)):$s.set(p,m)}hi.delete(c),v!==t&&((k=v.parentNode)==null||k.removeChild(v))}});return fi.set(u,h),u}let fi=new WeakMap;function Zr(s,e){const t=fi.get(s);return t?(fi.delete(s),t(e)):Promise.resolve()}var bn,In,en,Cs,Fr,Lr,Da;class Qd{constructor(e,t=!0){y(this,"anchor");qe(this,bn,new Map);qe(this,In,new Map);qe(this,en,new Map);qe(this,Cs,new Set);qe(this,Fr,!0);qe(this,Lr,()=>{var e=Oe;if(N(this,bn).has(e)){var t=N(this,bn).get(e),n=N(this,In).get(t);if(n)Zi(n),N(this,Cs).delete(t);else{var r=N(this,en).get(t);r&&(N(this,In).set(t,r.effect),N(this,en).delete(t),r.fragment.lastChild.remove(),this.anchor.before(r.fragment),n=r.effect)}for(const[a,i]of N(this,bn)){if(N(this,bn).delete(a),a===e)break;const l=N(this,en).get(i);l&&(Kt(l.effect),N(this,en).delete(i))}for(const[a,i]of N(this,In)){if(a===t||N(this,Cs).has(a))continue;const l=()=>{if(Array.from(N(this,bn).values()).includes(a)){var u=document.createDocumentFragment();Ec(i,u),u.append(jn()),N(this,en).set(a,{effect:i,fragment:u})}else Kt(i);N(this,Cs).delete(a),N(this,In).delete(a)};N(this,Fr)||!n?(N(this,Cs).add(a),Is(i,l,!1)):l()}}});qe(this,Da,e=>{N(this,bn).delete(e);const t=Array.from(N(this,bn).values());for(const[n,r]of N(this,en))t.includes(n)||(Kt(r.effect),N(this,en).delete(n))});this.anchor=e,Re(this,Fr,t)}ensure(e,t){var n=Oe,r=yc();if(t&&!N(this,In).has(e)&&!N(this,en).has(e))if(r){var a=document.createDocumentFragment(),i=jn();a.append(i),N(this,en).set(e,{effect:fn(()=>t(i)),fragment:a})}else N(this,In).set(e,fn(()=>t(this.anchor)));if(N(this,bn).set(n,e),r){for(const[l,c]of N(this,In))l===e?n.skipped_effects.delete(c):n.skipped_effects.add(c);for(const[l,c]of N(this,en))l===e?n.skipped_effects.delete(c.effect):n.skipped_effects.add(c.effect);n.oncommit(N(this,Lr)),n.ondiscard(N(this,Da))}else N(this,Lr).call(this)}}bn=new WeakMap,In=new WeakMap,en=new WeakMap,Cs=new WeakMap,Fr=new WeakMap,Lr=new WeakMap,Da=new WeakMap;function H(s,e,t=!1){var n=new Qd(s),r=t?lr:0;function a(i,l){n.ensure(i,l)}Qi(()=>{var i=!1;e((l,c=!0)=>{i=!0,a(c,l)}),i||a(!1,null)},r)}function it(s,e){return e}function Zd(s,e,t){for(var n=[],r=e.length,a,i=e.length,l=0;l<r;l++){let v=e[l];Is(v,()=>{if(a){if(a.pending.delete(v),a.done.add(v),a.pending.size===0){var p=s.outrogroups;vi(Ea(a.done)),p.delete(a),p.size===0&&(s.outrogroups=null)}}else i-=1},!1)}if(i===0){var c=n.length===0&&t!==null;if(c){var u=t,h=u.parentNode;qd(h),h.append(u),s.items.clear()}vi(e,!c)}else a={pending:new Set(e),done:new Set},(s.outrogroups??(s.outrogroups=new Set)).add(a)}function vi(s,e=!0){for(var t=0;t<s.length;t++)Kt(s[t],e)}var Io;function Fe(s,e,t,n,r,a=null){var i=s,l=new Map,c=(e&Kl)!==0;if(c){var u=s;i=u.appendChild(jn())}var h=null,v=uc(()=>{var w=t();return Li(w)?w:w==null?[]:Ea(w)}),p,m=!0;function k(){g.fallback=h,Xd(g,p,i,e,n),h!==null&&(p.length===0?h.f&Un?(h.f^=Un,Sr(h,null,i)):Zi(h):Is(h,()=>{h=null}))}var _=Qi(()=>{p=o(v);for(var w=p.length,S=new Set,E=Oe,x=yc(),O=0;O<w;O+=1){var L=p[O],R=n(L,O),W=m?null:l.get(R);W?(W.v&&dr(W.v,L),W.i&&dr(W.i,O),x&&E.skipped_effects.delete(W.e)):(W=Jd(l,m?i:Io??(Io=jn()),L,R,O,r,e,t),m||(W.e.f|=Un),l.set(R,W)),S.add(R)}if(w===0&&a&&!h&&(m?h=fn(()=>a(i)):(h=fn(()=>a(Io??(Io=jn()))),h.f|=Un)),!m)if(x){for(const[j,J]of l)S.has(j)||E.skipped_effects.add(J.e);E.oncommit(k),E.ondiscard(()=>{})}else k();o(v)}),g={effect:_,items:l,outrogroups:null,fallback:h};m=!1}function Xd(s,e,t,n,r){var J,re,te,oe,ge,$,F,C,B;var a=(n&rd)!==0,i=e.length,l=s.items,c=s.effect.first,u,h=null,v,p=[],m=[],k,_,g,w;if(a)for(w=0;w<i;w+=1)k=e[w],_=r(k,w),g=l.get(_).e,g.f&Un||((re=(J=g.nodes)==null?void 0:J.a)==null||re.measure(),(v??(v=new Set)).add(g));for(w=0;w<i;w+=1){if(k=e[w],_=r(k,w),g=l.get(_).e,s.outrogroups!==null)for(const se of s.outrogroups)se.pending.delete(g),se.done.delete(g);if(g.f&Un)if(g.f^=Un,g===c)Sr(g,null,t);else{var S=h?h.next:c;g===s.effect.last&&(s.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),Xn(s,h,g),Xn(s,g,S),Sr(g,S,t),h=g,p=[],m=[],c=h.next;continue}if(g.f&nn&&(Zi(g),a&&((oe=(te=g.nodes)==null?void 0:te.a)==null||oe.unfix(),(v??(v=new Set)).delete(g))),g!==c){if(u!==void 0&&u.has(g)){if(p.length<m.length){var E=m[0],x;h=E.prev;var O=p[0],L=p[p.length-1];for(x=0;x<p.length;x+=1)Sr(p[x],E,t);for(x=0;x<m.length;x+=1)u.delete(m[x]);Xn(s,O.prev,L.next),Xn(s,h,O),Xn(s,L,E),c=E,h=L,w-=1,p=[],m=[]}else u.delete(g),Sr(g,c,t),Xn(s,g.prev,g.next),Xn(s,g,h===null?s.effect.first:h.next),Xn(s,h,g),h=g;continue}for(p=[],m=[];c!==null&&c!==g;)(u??(u=new Set)).add(c),m.push(c),c=c.next;if(c===null)continue}g.f&Un||p.push(g),h=g,c=g.next}if(s.outrogroups!==null){for(const se of s.outrogroups)se.pending.size===0&&(vi(Ea(se.done)),(ge=s.outrogroups)==null||ge.delete(se));s.outrogroups.size===0&&(s.outrogroups=null)}if(c!==null||u!==void 0){var R=[];if(u!==void 0)for(g of u)g.f&nn||R.push(g);for(;c!==null;)!(c.f&nn)&&c!==s.fallback&&R.push(c),c=c.next;var W=R.length;if(W>0){var j=n&Kl&&i===0?t:null;if(a){for(w=0;w<W;w+=1)(F=($=R[w].nodes)==null?void 0:$.a)==null||F.measure();for(w=0;w<W;w+=1)(B=(C=R[w].nodes)==null?void 0:C.a)==null||B.fix()}Zd(s,R,j)}}a&&mr(()=>{var se,ee;if(v!==void 0)for(g of v)(ee=(se=g.nodes)==null?void 0:se.a)==null||ee.apply()})}function Jd(s,e,t,n,r,a,i,l){var c=i&nd?i&ad?Ps(t):Od(t,!1,!1):null,u=i&sd?Ps(r):null;return{v:c,i:u,e:fn(()=>(a(e,c??t,u??r,l),()=>{s.delete(n)}))}}function Sr(s,e,t){if(s.nodes)for(var n=s.nodes.start,r=s.nodes.end,a=e&&!(e.f&Un)?e.nodes.start:t;n!==null;){var i=Ur(n);if(a.before(n),n===r)return;n=i}}function Xn(s,e,t){e===null?s.effect.first=t:e.next=t,t===null?s.effect.last=e:t.prev=e}function eh(s,e,t=!1,n=!1,r=!1){var a=s,i="";Y(()=>{var l=We;if(i!==(i=e()??"")&&(l.nodes!==null&&(wc(l.nodes.start,l.nodes.end),l.nodes=null),i!=="")){var c=i+"";t?c=`<svg>${c}</svg>`:n&&(c=`<math>${c}</math>`);var u=qc(c);if((t||n)&&(u=as(u)),Nr(as(u),u.lastChild),t||n)for(;as(u);)a.before(as(u));else a.before(u)}})}function th(s,e,t){Vi(()=>{var n=fs(()=>e(s,t==null?void 0:t())||{});if(t&&(n!=null&&n.update)){var r=!1,a={};zr(()=>{var i=t();$d(i),r&&Ql(a,i)&&(a=i,n.update(i))}),r=!0}if(n!=null&&n.destroy)return()=>n.destroy()})}function Fc(s){var e,t,n="";if(typeof s=="string"||typeof s=="number")n+=s;else if(typeof s=="object")if(Array.isArray(s)){var r=s.length;for(e=0;e<r;e++)s[e]&&(t=Fc(s[e]))&&(n&&(n+=" "),n+=t)}else for(t in s)s[t]&&(n&&(n+=" "),n+=t);return n}function nh(){for(var s,e,t=0,n="",r=arguments.length;t<r;t++)(s=arguments[t])&&(e=Fc(s))&&(n&&(n+=" "),n+=e);return n}function sh(s){return typeof s=="object"?nh(s):s??""}const Mo=[...` 	
\r\f \v\uFEFF`];function rh(s,e,t){var n=s==null?"":""+s;if(e&&(n=n?n+" "+e:e),t){for(var r in t)if(t[r])n=n?n+" "+r:r;else if(n.length)for(var a=r.length,i=0;(i=n.indexOf(r,i))>=0;){var l=i+a;(i===0||Mo.includes(n[i-1]))&&(l===n.length||Mo.includes(n[l]))?n=(i===0?"":n.substring(0,i))+n.substring(l+1):i=l}}return n===""?null:n}function ah(s,e){return s==null?null:String(s)}function Ke(s,e,t,n,r,a){var i=s.__className;if(i!==t||i===void 0){var l=rh(t,n,a);l==null?s.removeAttribute("class"):s.className=l,s.__className=t}else if(a&&r!==a)for(var c in a){var u=!!a[c];(r==null||u!==!!r[c])&&s.classList.toggle(c,u)}return a}function wn(s,e,t,n){var r=s.__style;if(r!==e){var a=ah(e);a==null?s.removeAttribute("style"):s.style.cssText=a,s.__style=e}return n}function Lc(s,e,t=!1){if(s.multiple){if(e==null)return;if(!Li(e))return fd();for(var n of s.options)n.selected=e.includes(Cr(n));return}for(n of s.options){var r=Cr(n);if(Rd(r,e)){n.selected=!0;return}}(!t||e!==void 0)&&(s.selectedIndex=-1)}function ih(s){var e=new MutationObserver(()=>{Lc(s,s.__value)});e.observe(s,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Ki(()=>{e.disconnect()})}function oh(s,e,t=e){var n=new WeakSet,r=!0;Wi(s,"change",a=>{var i=a?"[selected]":":checked",l;if(s.multiple)l=[].map.call(s.querySelectorAll(i),Cr);else{var c=s.querySelector(i)??s.querySelector("option:not([disabled])");l=c&&Cr(c)}t(l),Oe!==null&&n.add(Oe)}),Vi(()=>{var a=e();if(s===document.activeElement){var i=Er??Oe;if(n.has(i))return}if(Lc(s,a,r),r&&a===void 0){var l=s.querySelector(":checked");l!==null&&(a=Cr(l),t(a))}s.__value=a,r=!1}),ih(s)}function Cr(s){return"__value"in s?s.__value:s.value}const lh=Symbol("is custom element"),ch=Symbol("is html");function Xi(s,e){var t=Ji(s);t.value===(t.value=e??void 0)||s.value===e&&(e!==0||s.nodeName!=="PROGRESS")||(s.value=e??"")}function tr(s,e){var t=Ji(s);t.checked!==(t.checked=e??void 0)&&(s.checked=e)}function Me(s,e,t,n){var r=Ji(s);r[e]!==(r[e]=t)&&(e==="loading"&&(s[$u]=t),t==null?s.removeAttribute(e):typeof t!="string"&&uh(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function Ji(s){return s.__attributes??(s.__attributes={[lh]:s.nodeName.includes("-"),[ch]:s.namespaceURI===hd})}var Oo=new Map;function uh(s){var e=s.getAttribute("is")||s.nodeName,t=Oo.get(e);if(t)return t;Oo.set(e,t=[]);for(var n,r=s,a=Element.prototype;a!==r;){n=jl(r);for(var i in n)n[i].set&&t.push(i);r=Ui(r)}return t}function gt(s,e,t=e){var n=new WeakSet;Wi(s,"input",async r=>{var a=r?s.defaultValue:s.value;if(a=Ya(s)?ja(a):a,t(a),Oe!==null&&n.add(Oe),await Oc(),a!==(a=e())){var i=s.selectionStart,l=s.selectionEnd,c=s.value.length;if(s.value=a??"",l!==null){var u=s.value.length;i===l&&l===c&&u>c?(s.selectionStart=u,s.selectionEnd=u):(s.selectionStart=i,s.selectionEnd=Math.min(l,u))}}}),fs(e)==null&&s.value&&(t(Ya(s)?ja(s.value):s.value),Oe!==null&&n.add(Oe)),zr(()=>{var r=e();if(s===document.activeElement){var a=Er??Oe;if(n.has(a))return}Ya(s)&&r===ja(s.value)||s.type==="date"&&!r&&!s.value||r!==s.value&&(s.value=r??"")})}function gi(s,e,t=e){Wi(s,"change",n=>{var r=n?s.defaultChecked:s.checked;t(r)}),fs(e)==null&&t(s.checked),zr(()=>{var n=e();s.checked=!!n})}function Ya(s){var e=s.type;return e==="number"||e==="range"}function ja(s){return s===""?null:+s}function No(s,e){return s===e||(s==null?void 0:s[Yn])===e}function Tn(s={},e,t,n){return Vi(()=>{var r,a;return zr(()=>{r=a,a=(n==null?void 0:n())||[],fs(()=>{s!==t(...a)&&(e(s,...a),r&&No(t(...r),s)&&e(null,...r))})}),()=>{mr(()=>{a&&No(t(...a),s)&&e(null,...a)})}}),s}let Xr=!1;function dh(s){var e=Xr;try{return Xr=!1,[s(),Xr]}finally{Xr=e}}function $n(s,e,t,n){var S;var r=(t&ld)!==0,a=(t&cd)!==0,i=n,l=!0,c=()=>(l&&(l=!1,i=a?fs(n):n),i),u;if(r){var h=Yn in s||Hu in s;u=((S=er(s,e))==null?void 0:S.set)??(h&&e in s?E=>s[e]=E:void 0)}var v,p=!1;r?[v,p]=dh(()=>s[e]):v=s[e],v===void 0&&n!==void 0&&(v=c(),u&&(Zu(),u(v)));var m;if(m=()=>{var E=s[e];return E===void 0?c():(l=!0,E)},!(t&od))return m;if(u){var k=s.$$legacy;return function(E,x){return arguments.length>0?((!x||k||p)&&u(x?m():E),E):m()}}var _=!1,g=(t&id?Ca:uc)(()=>(_=!1,m()));r&&o(g);var w=We;return function(E,x){if(arguments.length>0){const O=x?o(g):r?De(E):E;return b(g,O),_=!0,i!==void 0&&(i=O),E}return hs&&_||w.f&Bn?g.v:o(g)}}function Yr(s){_t===null&&ji(),wt(()=>{const e=fs(s);if(typeof e=="function")return e})}function hh(s){_t===null&&ji(),Yr(()=>()=>fs(s))}const fh="5";var Yl;typeof window<"u"&&((Yl=window.__svelte??(window.__svelte={})).v??(Yl.v=new Set)).add(fh);function vh(){return{type:"daily",interval:1,time:"09:00"}}function Uc(s){return!s||!s.type||!s.interval||s.interval<1?!1:s.type==="weekly"?Array.isArray(s.weekdays)&&s.weekdays.length>0&&s.weekdays.every(e=>e>=0&&e<=6):s.type==="monthly"?s.dayOfMonth>=1&&s.dayOfMonth<=31:s.type==="yearly"?s.month>=0&&s.month<=11&&s.dayOfMonth>=1&&s.dayOfMonth<=31:!0}const ws="recurring-tasks-active",ia="recurring-tasks-archive",Ro="recurring-tasks",Po="recurring-tasks.json.bak",qo="n8n-event-settings",Fo="n8n-event-queue",gh="notification-state",ph="recurring-tasks-dock",Lo="scheduler-emitted-occurrences",es=4,pi={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},eo=60*1e3,mh=30*1e3,Ha=2e3,Uo="shehab-note-recurring-plugin",zo="1.0.0",yh=60*60*1e3,bh=3,Bo=10,$a=1e3,oa=100,Yo=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],_h=[{label:"+1 day",minutes:60*24},{label:"+3 days",minutes:60*24*3},{label:"+1 week",minutes:60*24*7}],kh={lowest:"#94a3b8",low:"#64748b",normal:"#3b82f6",medium:"#f59e0b",high:"#f97316",highest:"#ef4444"},wh=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],jo="last-run-timestamp",Ho="custom-recurring-task-id",$o="custom-recurring-task-due",Wo="custom-recurring-task-enabled",Jr=3,Go=[1e3,5e3,3e4],Th=1e4,to={dueSoonScoreMax:100,dueSoonScoreMin:0,dueDateWeight:10,overdueBaseScore:110,overduePenaltyWeight:15,noDueDateScore:0,priorityMultipliers:{lowest:.8,low:1,normal:1.1,medium:1.2,high:1.5,highest:2},maxUrgency:200,minUrgency:0},zc=24*60*60*1e3,Sh=(s,e,t)=>Math.min(t,Math.max(e,s)),Ko=s=>new Date(s.getFullYear(),s.getMonth(),s.getDate()),Dh=(s,e)=>{const t=Ko(s),n=Ko(e);return Math.round((n.getTime()-t.getTime())/zc)},Eh=(s,e)=>e.priorityMultipliers[s]??1;function no(s,e={}){return xh(s,e).score}function xh(s,e={}){const t=e.now??new Date,n=e.settings??to;if(!so(s))return{score:0,breakdown:{priorityContribution:0,dueDateContribution:0,overdueContribution:0}};const r=hr(s.priority)??"normal",a=Eh(r,n);if(!s.dueAt){const k=n.noDueDateScore,_=k*a;return{score:Wa(_,n),breakdown:{priorityContribution:_-k,dueDateContribution:k,overdueContribution:0}}}const i=new Date(s.dueAt);if(Number.isNaN(i.getTime())){const k=n.noDueDateScore,_=k*a;return{score:Wa(_,n),breakdown:{priorityContribution:_-k,dueDateContribution:k,overdueContribution:0}}}const l=i.getTime()<t.getTime(),c=Dh(t,i),u=l?Math.max(1,Math.ceil((t.getTime()-i.getTime())/zc)):0,h=l?0:Sh(n.dueSoonScoreMax-c*n.dueDateWeight,n.dueSoonScoreMin,n.dueSoonScoreMax),v=l?n.overdueBaseScore+u*n.overduePenaltyWeight:0,p=h+v,m=p*a;return{score:Wa(m,n),breakdown:{priorityContribution:m-p,dueDateContribution:h,overdueContribution:v}}}function Wa(s,e){const t=e.maxUrgency!==void 0?Math.min(e.maxUrgency,s):s;return Math.round(Math.max(e.minUrgency,t))}function Bc(s,e,t){const n=new Date().toISOString(),r=t||new Date;return{id:Yc(),name:s,lastCompletedAt:void 0,dueAt:r.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:es,createdAt:n,updatedAt:n}}const Ah=["lowest","low","normal","medium","high","highest"];function hr(s){if(!s)return;const e=s.toLowerCase();if(e==="urgent")return"highest";if(e==="none")return"normal";if(Ah.includes(e))return e}function Yc(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function jc(s,e={}){const t=new Date().toISOString();return{...{...s,id:Yc(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Ch(s){var n;const e=new Date,t=e.toISOString();if(s.completionCount=(s.completionCount||0)+1,s.currentStreak=(s.currentStreak||0)+1,s.bestStreak=Math.max(s.bestStreak||0,s.currentStreak),s.recentCompletions||(s.recentCompletions=[]),s.recentCompletions.push(t),s.recentCompletions.length>Bo&&(s.recentCompletions=s.recentCompletions.slice(-Bo)),(n=s.smartRecurrence)!=null&&n.enabled){s.completionHistory||(s.completionHistory=[]);const r=new Date(s.dueAt),a=Math.round((e.getTime()-r.getTime())/(1e3*60)),i={scheduledFor:s.dueAt,completedAt:t,delayMinutes:a,dayOfWeek:e.getDay(),context:{tags:s.tags||[],relatedBlocks:s.linkedBlockId?[s.linkedBlockId]:[]}};s.completionHistory.push(i),s.completionHistory.length>100&&(s.completionHistory=s.completionHistory.slice(-100))}s.snoozeCount=0,s.lastCompletedAt=t,s.updatedAt=t}function Hc(s){s.missCount=(s.missCount||0)+1,s.currentStreak=0,s.updatedAt=new Date().toISOString()}function $c(s){const e=s.completionCount||0,t=s.missCount||0,n=e+t;if(n===0)return 100;let a=e/n*70;const i=s.currentStreak||0,l=Math.min(30,i*3);return a+=l,Math.round(Math.min(100,a))}function Ih(s,e){const t=new Set([...s.blockedBy??[],...s.dependsOn??[]]);return t.size===0?!1:e.filter(r=>t.has(r.id)).some(r=>so(r))}function Mh(s,e){return e.some(t=>t.id===s.id||!new Set([...t.blockedBy??[],...t.dependsOn??[]]).has(s.id)?!1:so(t))}function so(s){return s.status?s.status==="todo":s.enabled}function Ts(s){const{message:e,type:t="info",duration:n=3e3,actionLabel:r,onAction:a,showCountdown:i=!1}=s,l=document.createElement("div");l.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const c=document.createElement("span");c.textContent=e,l.appendChild(c);let u=null;if(r&&a){const v=document.createElement("button");v.type="button";let p=Math.max(1,Math.ceil(n/1e3));v.textContent=i?`${r} (${p}s)`:r,v.className="recurring-tasks-toast__action",v.addEventListener("click",()=>{a(),u!==null&&window.clearInterval(u),l.parentElement&&l.parentElement.removeChild(l)}),l.appendChild(v),i&&n>0&&(u=window.setInterval(()=>{p=Math.max(0,p-1),v.textContent=`${r} (${p}s)`,p<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(l.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:Oh(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(l);const h=()=>{u!==null&&window.clearInterval(u),l.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{l.parentElement&&l.parentElement.removeChild(l)},300)};n>0&&setTimeout(()=>{h()},n)}function Oh(s){switch(s){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const K={success:(s,e)=>Ts({message:s,type:"success",duration:e}),error:(s,e)=>Ts({message:s,type:"error",duration:e}),warning:(s,e)=>Ts({message:s,type:"warning",duration:e}),info:(s,e)=>Ts({message:s,type:"info",duration:e})};if(typeof document<"u"){const s=document.createElement("style");s.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(s)}class Nh{constructor(){y(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var n;return(n=this.handlers.get(e))==null?void 0:n.delete(t)}}emit(e,t){var n;(n=this.handlers.get(e))==null||n.forEach(r=>r(t))}clear(){this.handlers.clear()}}const He=new Nh;function ea(s,e){const t=s.findIndex(r=>r.id===e.id);if(t===-1)return[...s,e];const n=[...s];return n[t]=e,n}function Vo(s,e){const t=s.filter(n=>n.id!==e);return t.length===s.length?s:t}function Ga(s,e,t){let n=!1;const r=s.map(a=>a.id!==e?a:(n=!0,t(a)));return n?r:s}function Rh(s,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),s.filter(n=>n.enabled?new Date(n.dueAt)<=t:!1)}const ro=Symbol("urgency-settings"),Ph=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function Ma(s,e,t){const n={timestamp:new Date().toISOString()},r=`[${s.toUpperCase()}] [${n.timestamp}]`;s==="error"?console.error(r,e,t||""):s==="warn"?console.warn(r,e,t||""):s==="debug"&&Ph?console.debug(r,e,t||""):s==="info"&&console.log(r,e,t||"")}function Wc(s,e){Ma("debug",s,e)}function he(s,e){Ma("info",s,e)}function at(s,e){Ma("warn",s,e)}function Te(s,e){Ma("error",s,e)}async function qh(s){return new Promise(e=>{try{Fi.fetchPost("/api/block/getBlockInfo",{id:s},t=>{var r,a,i;const n=((r=t==null?void 0:t.data)==null?void 0:r.content)??((a=t==null?void 0:t.data)==null?void 0:a.markdown)??((i=t==null?void 0:t.data)==null?void 0:i.name)??null;e(n?n.trim():null)})}catch(t){at("Failed to fetch block preview",t),e(null)}})}async function Fh(s){return new Promise(e=>{try{Fi.fetchPost("/api/block/getBlockHTML",{id:s},t=>{var r;const n=((r=t==null?void 0:t.data)==null?void 0:r.html)??null;e(n?n.trim():null)})}catch(t){at("Failed to fetch block embed",t),e(null)}})}function mi(s){const[e,t]=s.split(":").map(Number);return{hours:e,minutes:t}}function Lh(s){const e=s.getHours().toString().padStart(2,"0"),t=s.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function Uh(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function yi(s){return s.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function ao(s){const e=new Date;return s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()}function zh(s){return s<new Date}function Bh(s){return zh(s)&&!ao(s)}function us(s,e){const t=new Date(s);return t.setDate(t.getDate()+e),t}function Qo(s,e){return us(s,e*7)}function Ka(s,e,t){const n=new Date(s);return n.setHours(e,t,0,0),n}function Zo(s,e,t){const n=new Date(s);n.setHours(e,t,0,0);const r=n.getHours()!==e||n.getMinutes()!==t;return{date:n,shifted:r}}function bi(s){const e=new Date(s);return e.setHours(0,0,0,0),e}function Yh(s){const e=new Date(s);return e.setHours(23,59,59,999),e}function jh(s,e){const n=Math.abs(e.getTime()-s.getTime());return Math.floor(n/864e5)}function Hh(s,e){const t=[];for(let n=0;n<e;n++)t.push(us(s,n));return t}var $h=A('<span class="task-card__streak svelte-yjw1ud"> </span>'),Wh=A('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">✏️</button>'),Gh=A('<span class="task-card__relative svelte-yjw1ud"> </span>'),Kh=A('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),Vh=A('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),Qh=A('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),Zh=A('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),Xh=A('<button class="task-card__snooze-chip"> </button>'),Jh=A('<button class="task-card__snooze-option" role="menuitem"> </button>'),ef=A('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),tf=A('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <div class="task-card__urgency svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Urgency:</span> <span class="task-card__value svelte-yjw1ud"> </span></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">🕒 Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">🕒 Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">⏭️ Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">✅ Done</button></div></div>');function yr(s,e){ot(e,!0);const t=V(()=>new Date(e.task.dueAt)),n=V(()=>Bh(o(t))),r=V(()=>ao(o(t))),a=V(()=>o(n)?jh(new Date(e.task.dueAt),new Date):0),i=V(()=>o(n)?"task-card--overdue":o(r)?"task-card--today":""),l=V(()=>()=>o(n)?`rgba(244, 67, 54, ${Math.min(.45,.12+o(a)*.05)})`:""),c=V(()=>()=>o(n)?`rgba(244, 67, 54, ${Math.min(.8,.3+o(a)*.08)})`:""),u=V(()=>()=>{const ne=hr(e.task.priority)||"normal";return kh[ne]}),h=V(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(o(t)):""),v=V(()=>(e.task.currentStreak||0)>0),p=V(()=>()=>"🔥"),m=V(()=>$c(e.task)),k=V(()=>o(m)>=80?"health--good":o(m)>=50?"health--fair":"health--poor"),_=Xl(ro),g=V(()=>no(e.task,{settings:_}));let w=G(!1),S=G(-1),E=[],x=G(!1),O=G(null),L=G(null),R=G(!1);const W=V(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}…`:e.task.linkedBlockId:""),j=V(()=>()=>{if(!o(O))return"";const ne=o(O).replace(/\s+/g," ").trim();return ne.length>220?`${ne.slice(0,220)}…`:ne}),J=V(()=>()=>Yo.filter(ne=>[15,60,120].includes(ne.minutes))),re=V(()=>()=>`snooze-menu-${e.task.id}`);wt(()=>{b(O,e.task.linkedBlockContent??null,!0),b(L,null),b(R,!1)});function te(){e.onDone(e.task)}function oe(){e.onDelay(e.task)}function ge(){e.onEdit&&e.onEdit(e.task)}function $(){e.onSkip(e.task)}async function F(){b(w,!o(w)),o(w)&&(await Oc(),b(S,-1),E=[])}function C(ne){const we=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ne}});window.dispatchEvent(we),b(w,!1),b(S,-1)}function B(ne){var Ye,nt,ke,Ie;const we=o(J);ne.key==="ArrowDown"?(ne.preventDefault(),b(S,Math.min(o(S)+1,we.length-1),!0),(Ye=E[o(S)])==null||Ye.focus()):ne.key==="ArrowUp"?(ne.preventDefault(),b(S,Math.max(o(S)-1,0),!0),(nt=E[o(S)])==null||nt.focus()):ne.key==="Escape"?(b(w,!1),b(S,-1)):ne.key==="Home"?(ne.preventDefault(),b(S,0),(ke=E[0])==null||ke.focus()):ne.key==="End"&&(ne.preventDefault(),b(S,we.length-1),(Ie=E[o(S)])==null||Ie.focus())}function se(ne){if(ne.key==="Escape"&&o(w)){b(w,!1);return}(ne.key==="Enter"||ne.key===" ")&&(ne.preventDefault(),F())}async function ee(){if(b(x,!0),!e.task.linkedBlockId||o(R)||o(L))return;b(R,!0);const[ne,we]=await Promise.all([Fh(e.task.linkedBlockId),qh(e.task.linkedBlockId)]);b(L,ne,!0),b(O,we,!0),b(R,!1)}function pe(){b(x,!1)}const de=V(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,we=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[we]||we)}`);var ue=tf();ue.__keydown=ne=>{ne.key==="Escape"&&o(w)&&b(w,!1)};var Ee=d(ue),_e=d(Ee),Pe=d(_e),le=f(Pe,2),U=d(le),D=f(le,2);{var q=ne=>{var we=$h(),Ye=d(we);Y(nt=>{Me(we,"title",`${e.task.currentStreak??""} day streak`),M(Ye,`${nt??""} ${e.task.currentStreak??""}`)},[()=>o(p)()]),T(ne,we)};H(D,ne=>{o(v)&&ne(q)})}var Q=f(_e,2);{var ae=ne=>{var we=Wh();we.__click=ge,T(ne,we)};H(Q,ne=>{e.onEdit&&ne(ae)})}var I=f(Ee,2),P=d(I),Z=f(d(P),2),fe=d(Z),me=f(Z,2);{var ye=ne=>{var we=Gh(),Ye=d(we);Y(nt=>M(Ye,nt),[()=>o(h)()]),T(ne,we)};H(me,ne=>{e.timezoneHandler&&ne(ye)})}var xe=f(P,2),Ae=f(d(xe),2),$e=d(Ae),Ze=f(xe,2);{var Ge=ne=>{var we=Kh(),Ye=f(d(we),2),nt=d(Ye);Y(ke=>M(nt,ke),[()=>yi(new Date(e.task.lastCompletedAt))]),T(ne,we)};H(Ze,ne=>{e.task.lastCompletedAt&&ne(Ge)})}var Je=f(Ze,2);{var ct=ne=>{var we=Zh(),Ye=d(we),nt=d(Ye),ke=f(Ye,2);{var Ie=Le=>{var bt=Qh(),Yt=d(bt);{var xt=At=>{var jt=Ba("Loading preview…");T(At,jt)},Qt=At=>{var jt=ht(),Zn=Ve(jt);{var Zt=Xt=>{var z=Vh(),ve=d(z);eh(ve,()=>o(L)),T(Xt,z)},mn=Xt=>{var z=ht(),ve=Ve(z);{var st=an=>{var Us=Ba();Y(()=>M(Us,o(j))),T(an,Us)},rn=an=>{var Us=Ba("No preview available.");T(an,Us)};H(ve,an=>{o(O)?an(st):an(rn,!1)},!0)}T(Xt,z)};H(Zn,Xt=>{o(L)?Xt(Zt):Xt(mn,!1)},!0)}T(At,jt)};H(Yt,At=>{o(R)?At(xt):At(Qt,!1)})}T(Le,bt)};H(ke,Le=>{o(x)&&Le(Ie)})}Y(()=>{Me(Ye,"title",`Linked block: ${e.task.linkedBlockId}`),M(nt,`📝 Block ${o(W)??""}`)}),Ot("mouseenter",Ye,ee),Ot("mouseleave",Ye,pe),Ot("focus",Ye,ee),Ot("blur",Ye,pe),T(ne,we)};H(Je,ne=>{e.task.linkedBlockId&&ne(ct)})}var Ce=f(I,2),ft=d(Ce),Be=f(Ce,2),et=d(Be),tt=d(et);tt.__click=F,tt.__keydown=se;var Dt=f(tt,2),Et=d(Dt);Fe(Et,17,()=>o(J),it,(ne,we)=>{var Ye=Xh();Ye.__click=()=>C(o(we).minutes);var nt=d(Ye);Y(()=>{Me(Ye,"aria-label",`Snooze for ${o(we).label}`),M(nt,o(we).label)}),T(ne,Ye)});var Bt=f(Et,2);Bt.__click=oe;var ie=f(Dt,2);{var ce=ne=>{var we=ef();we.__keydown=B,Fe(we,21,()=>Yo,it,(Ye,nt,ke)=>{var Ie=Jh();Ie.__click=()=>C(o(nt).minutes),Me(Ie,"tabindex",ke===0?0:-1);var Le=d(Ie);Tn(Ie,(bt,Yt)=>E[Yt]=bt,bt=>E==null?void 0:E[bt],()=>[ke]),Y(()=>M(Le,o(nt).label)),T(Ye,Ie)}),Y(()=>Me(we,"id",o(re))),T(ne,we)};H(ie,ne=>{o(w)&&ne(ce)})}var Se=f(et,2);Se.__click=oe;var ut=f(Se,2);ut.__click=$;var Pn=f(ut,2);Pn.__click=te,Y((ne,we)=>{Ke(ue,1,`task-card ${o(i)??""}`,"svelte-yjw1ud"),wn(ue,`--overdue-tint: ${o(l)??""}; --overdue-border: ${o(c)??""};`),Me(ue,"aria-label",ne),Me(ue,"data-task-id",e.task.id),wn(Pe,`background-color: ${o(u)??""}`),Me(Pe,"title",`Priority:  ${(e.task.priority||"normal")??""}`),M(U,e.task.name),M(fe,we),Me(xe,"title",`Urgency score: ${o(g)??""}`),M($e,o(g)),Ke(Ce,1,`task-card__health ${o(k)??""}`,"svelte-yjw1ud"),Me(Ce,"title",`Task health:  ${o(m)??""}%`),wn(ft,`width: ${o(m)??""}%`),Me(tt,"aria-expanded",o(w)),Me(tt,"aria-controls",o(re))},[()=>o(de)(),()=>yi(o(t))]),T(s,ue),lt()}mt(["keydown","click"]);var nf=A(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">🎉 No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),sf=A('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),rf=A('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function af(s,e){ot(e,!0);const t=V(()=>[...e.tasks].sort((_,g)=>new Date(_.dueAt).getTime()-new Date(g.dueAt).getTime()));let n=G(0),r=De([]);wt(()=>{o(n)>=o(t).length&&b(n,Math.max(0,o(t).length-1),!0)});function a(_){var w;if(o(t).length===0)return;const g=Math.max(0,Math.min(_,o(t).length-1));b(n,g,!0),(w=r[g])==null||w.focus()}function i(_,g){_.key==="ArrowDown"?(_.preventDefault(),a(g+1)):_.key==="ArrowUp"?(_.preventDefault(),a(g-1)):_.key==="Home"?(_.preventDefault(),a(0)):_.key==="End"&&(_.preventDefault(),a(o(t).length-1))}var l=rf(),c=d(l),u=f(d(c),2),h=d(u),v=f(c,2),p=d(v);{var m=_=>{var g=nf();T(_,g)},k=_=>{var g=ht(),w=Ve(g);Fe(w,19,()=>o(t),S=>S.id,(S,E,x)=>{var O=sf();O.__keydown=R=>i(R,o(x));var L=d(O);yr(L,{get task(){return o(E)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),Tn(O,(R,W)=>r[W]=R,R=>r==null?void 0:r[R],()=>[o(x)]),Y(()=>Me(O,"tabindex",o(x)===o(n)?0:-1)),Ot("focus",O,()=>b(n,o(x),!0)),T(S,O)}),T(_,g)};H(p,_=>{o(t).length===0?_(m):_(k,!1)})}Y(()=>M(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),T(s,l),lt()}mt(["keydown"]);var of=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),lf=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),cf=A('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">✏️</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">📄</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">🗑️</button></div></td></tr>'),uf=A('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),df=A('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),hf=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),ff=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),vf=A('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">🔍</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function gf(s,e){ot(e,!0);let t=G(null),n=G(!1),r=G(""),a=G(""),i=G(De(new Set)),l=G(0),c=De([]),u=G(null);const h=V(()=>[...e.tasks].sort((I,P)=>new Date(I.dueAt).getTime()-new Date(P.dueAt).getTime())),v=V(()=>()=>{const I=o(a).trim().toLowerCase();return I?o(h).filter(P=>{var fe;return[P.name,P.description,P.category,P.linkedBlockContent,(fe=P.tags)==null?void 0:fe.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(I)}):o(h)}),p=V(()=>o(v).map(I=>I.id)),m=V(()=>o(i).size>0),k=V(()=>o(v).length>0&&o(v).every(I=>o(i).has(I.id))),_=V(()=>o(v).some(I=>o(i).has(I.id))&&!o(k));wt(()=>{const I=new Set([...o(i)].filter(P=>e.tasks.some(Z=>Z.id===P)));I.size!==o(i).size&&b(i,I,!0)}),wt(()=>{o(u)&&(o(u).indeterminate=o(_))}),wt(()=>{o(l)>=o(v).length&&b(l,Math.max(0,o(v).length-1),!0)}),wt(()=>{const I=window.setTimeout(()=>{b(a,o(r),!0)},300);return()=>{window.clearTimeout(I)}});function g(I){b(t,I,!0)}function w(){o(t)&&(e.onDelete(o(t)),b(t,null))}function S(){b(t,null)}function E(I){const P=new Set(o(i));P.has(I)?P.delete(I):P.add(I),b(i,P,!0)}function x(){const I=new Set(o(i));o(k)?o(p).forEach(P=>I.delete(P)):o(p).forEach(P=>I.add(P)),b(i,I,!0)}function O(I){var Z;if(o(v).length===0)return;const P=Math.max(0,Math.min(I,o(v).length-1));b(l,P,!0),(Z=c[P])==null||Z.focus()}function L(I,P){I.key==="ArrowDown"?(I.preventDefault(),O(P+1)):I.key==="ArrowUp"?(I.preventDefault(),O(P-1)):I.key==="Home"?(I.preventDefault(),O(0)):I.key==="End"&&(I.preventDefault(),O(o(v).length-1))}function R(){if(o(i).size===0){b(n,!1);return}e.onBulkDelete([...o(i)]),b(i,new Set,!0),b(n,!1)}function W(){b(n,!1)}function j(I){const{type:P,interval:Z}=I.frequency,fe=P==="daily"?"day":P==="weekly"?"week":P==="monthly"?"month":"year",me=Z===1?`Every ${fe}`:`Every ${Z} ${fe}s`;if(P==="weekly")return`${me} on ${I.frequency.weekdays.map(ye=>wh[ye]??ye).join(", ")}`;if(P==="monthly")return`${me} on day ${I.frequency.dayOfMonth}`;if(P==="yearly"){const ye=J[I.frequency.month]??`Month ${I.frequency.month+1}`;return`${me} on ${ye} ${I.frequency.dayOfMonth}`}return me}const J=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var re=vf(),te=Ve(re),oe=d(te),ge=f(d(oe),2),$=d(ge),F=f(d($),2),C=f($,2);C.__click=function(...I){var P;(P=e.onCreate)==null||P.apply(this,I)};var B=f(oe,2),se=d(B),ee=d(se),pe=d(ee),de=f(ee,2),ue=d(de);ue.__click=()=>e.onBulkEnable([...o(i)]);var Ee=f(ue,2);Ee.__click=()=>e.onBulkDisable([...o(i)]);var _e=f(Ee,2);_e.__click=()=>b(n,!0);var Pe=f(se,2);{var le=I=>{var P=of();T(I,P)},U=I=>{var P=df(),Z=d(P);{var fe=ye=>{var xe=lf(),Ae=d(xe),$e=d(Ae);Y(Ze=>M($e,`No tasks match "${Ze??""}".`),[()=>o(a).trim()]),T(ye,xe)},me=ye=>{var xe=uf(),Ae=d(xe),$e=d(Ae),Ze=d($e),Ge=d(Ze);Ge.__click=x,Tn(Ge,ct=>b(u,ct),()=>o(u));var Je=f(Ae);Fe(Je,23,()=>o(v),ct=>ct.id,(ct,Ce,ft)=>{var Be=cf();Be.__keydown=Le=>L(Le,o(ft));var et=d(Be),tt=d(et);tt.__click=()=>E(o(Ce).id);var Dt=f(et),Et=d(Dt),Bt=f(Dt),ie=d(Bt),ce=f(Bt),Se=d(ce),ut=f(ce),Pn=d(ut),ne=d(Pn);ne.__change=()=>e.onToggleEnabled(o(Ce));var we=f(ut),Ye=d(we),nt=d(Ye);nt.__click=()=>e.onEdit(o(Ce));var ke=f(nt,2);ke.__click=()=>e.onDuplicate(o(Ce));var Ie=f(ke,2);Ie.__click=()=>g(o(Ce)),Tn(Be,(Le,bt)=>c[bt]=Le,Le=>c==null?void 0:c[Le],()=>[o(ft)]),Y((Le,bt,Yt,xt)=>{Ke(Be,1,sh(o(Ce).enabled?"":"disabled"),"svelte-i091qn"),Me(Be,"tabindex",o(ft)===o(l)?0:-1),Me(Be,"aria-selected",Le),Me(tt,"aria-label",`Select ${o(Ce).name}`),tr(tt,bt),M(Et,o(Ce).name),M(ie,Yt),M(Se,xt),tr(ne,o(Ce).enabled)},[()=>o(i).has(o(Ce).id),()=>o(i).has(o(Ce).id),()=>yi(new Date(o(Ce).dueAt)),()=>j(o(Ce))]),Ot("focus",Be,()=>b(l,o(ft),!0)),T(ct,Be)}),Y(()=>{tr(Ge,o(k)),Ge.disabled=o(v).length===0}),T(ye,xe)};H(Z,ye=>{o(v).length===0?ye(fe):ye(me,!1)})}T(I,P)};H(Pe,I=>{o(h).length===0?I(le):I(U,!1)})}var D=f(te,2);{var q=I=>{var P=hf(),Z=d(P),fe=f(d(Z),2),me=d(fe),ye=f(fe,2),xe=d(ye);xe.__click=S;var Ae=f(xe,2);Ae.__click=w,Y(()=>M(me,`Are you sure you want to delete "${o(t).name??""}"? This action cannot be undone.`)),T(I,P)};H(D,I=>{o(t)&&I(q)})}var Q=f(D,2);{var ae=I=>{var P=ff(),Z=d(P),fe=f(d(Z),2),me=d(fe),ye=f(fe,2),xe=d(ye);xe.__click=W;var Ae=f(xe,2);Ae.__click=R,Y(()=>M(me,`Are you sure you want to delete ${o(i).size??""} task${o(i).size===1?"":"s"}? This action cannot be undone.`)),T(I,P)};H(Q,I=>{o(n)&&I(ae)})}Y(()=>{F.disabled=o(h).length===0,M(pe,`${o(i).size??""} selected`),ue.disabled=!o(m),Ee.disabled=!o(m),_e.disabled=!o(m)}),gt(F,()=>o(r),I=>b(r,I)),T(s,re),lt()}mt(["click","keydown","change"]);var pf=A('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),mf=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),yf=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),bf=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),_f=A('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),kf=A('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),wf=A('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Tf=A('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Sf(s,e){ot(e,!0);let t=$n(e,"days",3,30);function n(w){const{frequency:S}=w;if(S.type==="weekly"){const E=[...S.weekdays].sort((x,O)=>x-O).join(",");return`weekly:${S.interval}:${S.time??""}:${E}`}return S.type==="monthly"?`monthly:${S.interval}:${S.time??""}:${S.dayOfMonth}`:S.type==="yearly"?`yearly:${S.interval}:${S.time??""}:${S.month}:${S.dayOfMonth}`:`daily:${S.interval}:${S.time??""}`}function r(w,S){const E=w.map(x=>`${x.id}:${x.enabled}:${x.dueAt}:${n(x)}`).join("|");return`${S}:${E}`}function a(w,S){const E=bi(new Date),x=Yh(us(E,S-1)),O=24*60*60*1e3,R=Hh(E,S).map(W=>({date:W,tasks:[]}));for(const W of w.filter(j=>j.enabled)){const j=new Date(W.dueAt),J=e.recurrenceEngine.getOccurrencesInRange(E,x,W.frequency,j);for(const re of J){const te=bi(re),oe=Math.floor((te.getTime()-E.getTime())/O);oe>=0&&oe<S&&R[oe].tasks.push({task:W,occurrence:re})}}for(const W of R)W.tasks.sort((j,J)=>j.occurrence.getTime()-J.occurrence.getTime());return R}const i=(()=>{let w="",S=[];return{get(E,x){const O=r(E,x);return O===w||(w=O,S=a(E,x)),S}}})(),l=V(()=>i.get(e.tasks,t())),c=V(()=>o(l).some(w=>w.tasks.length>0));var u=Tf(),h=d(u),v=f(d(h),2),p=d(v),m=f(h,2),k=d(m);{var _=w=>{var S=pf(),E=d(S),x=d(E);Y(()=>M(x,`No tasks scheduled in the next ${t()??""} days.`)),T(w,S)},g=w=>{var S=wf();Fe(S,21,()=>o(l),E=>E.date.toISOString(),(E,x)=>{var O=ht(),L=Ve(O);{var R=W=>{var j=kf(),J=d(j),re=d(J),te=d(re),oe=f(re,2),ge=d(oe),$=f(J,2);Fe($,21,()=>o(x).tasks,({task:F,occurrence:C})=>F.id+C.toISOString(),(F,C)=>{let B=()=>o(C).task,se=()=>o(C).occurrence;var ee=_f(),pe=d(ee),de=d(pe),ue=f(pe,2),Ee=d(ue),_e=d(Ee),Pe=f(Ee,2),le=d(Pe);{var U=I=>{var P=mf(),Z=d(P);Y(()=>M(Z,`🔗 ${B().linkedBlockId??""}`)),T(I,P)};H(le,I=>{B().linkedBlockId&&I(U)})}var D=f(le,2);{var q=I=>{var P=yf(),Z=d(P);Y(()=>M(Z,`⚡ ${B().priority??""}`)),T(I,P)};H(D,I=>{B().priority&&I(q)})}var Q=f(D,2);{var ae=I=>{var P=bf(),Z=d(P);Y(fe=>M(Z,`🏷️ ${fe??""}`),[()=>B().tags.join(", ")]),T(I,P)};H(Q,I=>{var P;(P=B().tags)!=null&&P.length&&I(ae)})}Y(I=>{M(de,I),M(_e,B().name)},[()=>Lh(se())]),T(F,ee)}),Y((F,C)=>{M(te,F),M(ge,C)},[()=>Uh(o(x).date),()=>o(x).date.toLocaleDateString(void 0,{weekday:"short"})]),T(W,j)};H(L,W=>{o(x).tasks.length>0&&W(R)})}T(E,O)}),T(w,S)};H(k,w=>{o(c)?w(g,!1):w(_)})}Y(()=>M(p,`Next ${t()??""} days`)),T(s,u),lt()}var Df=A('<span class="leaderboard-item__badge svelte-1ptoc1q">🏆 Best</span>'),Ef=A('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),xf=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">🔥 Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Af=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Cf=A('<h4 class="subsection-title svelte-1ptoc1q">✅ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),If=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Mf=A('<h4 class="subsection-title svelte-1ptoc1q">⚠️ Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Of=A('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">✅</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),Nf=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),Rf=A('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function Pf(s,e){ot(e,!0);const t=V(()=>()=>{let F=0,C=0;for(const ee of e.tasks)F+=ee.completionCount||0,C+=ee.missCount||0;const B=F+C,se=B>0?F/B*100:100;return{totalCompletions:F,totalMisses:C,completionRate:Math.round(se)}}),n=V(()=>()=>[...e.tasks].filter(F=>(F.currentStreak||0)>0).sort((F,C)=>(C.currentStreak||0)-(F.currentStreak||0)).slice(0,10)),r=V(()=>()=>[...e.tasks].map(F=>({task:F,health:$c(F)})).sort((F,C)=>F.health-C.health)),a=V(()=>()=>o(r)().slice(-5).reverse()),i=V(()=>()=>o(r)().slice(0,5)),l=V(()=>()=>{const F=[];for(const C of e.tasks)if(C.recentCompletions&&C.recentCompletions.length>0)for(const B of C.recentCompletions)F.push({task:C,completedAt:B});return F.sort((C,B)=>new Date(B.completedAt).getTime()-new Date(C.completedAt).getTime()).slice(0,10)});function c(F){return new Date(F).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(F){return F>=80?"#10b981":F>=60?"#3b82f6":F>=40?"#f59e0b":"#ef4444"}var h=Rf(),v=f(d(h),2),p=d(v),m=f(d(p),2),k=d(m),_=d(k),g=d(_),w=f(k,2),S=d(w),E=d(S),x=f(w,2),O=d(x),L=d(O),R=f(p,2);{var W=F=>{var C=xf(),B=f(d(C),2);Fe(B,21,()=>o(n)(),it,(se,ee,pe)=>{var de=Ef(),ue=d(de);ue.textContent=`#${pe+1}`;var Ee=f(ue,2),_e=d(Ee),Pe=f(Ee,2),le=d(Pe),U=f(le);{var D=q=>{var Q=Df();T(q,Q)};H(U,q=>{o(ee).bestStreak&&o(ee).currentStreak===o(ee).bestStreak&&q(D)})}Y(()=>{M(_e,o(ee).name),M(le,`${o(ee).currentStreak??""} day${o(ee).currentStreak!==1?"s":""} `)}),T(se,de)}),T(F,C)};H(R,F=>{o(n)().length>0&&F(W)})}var j=f(R,2),J=f(d(j),2);{var re=F=>{var C=Cf(),B=f(Ve(C),2);Fe(B,21,()=>o(a)(),it,(se,ee)=>{let pe=()=>o(ee).task,de=()=>o(ee).health;var ue=Af(),Ee=d(ue),_e=d(Ee),Pe=f(Ee,2),le=d(Pe),U=f(le,2),D=d(U);Y(q=>{M(_e,pe().name),wn(le,`width: ${de()??""}%; background-color: ${q??""}`),M(D,`${de()??""}/100`)},[()=>u(de())]),T(se,ue)}),T(F,C)};H(J,F=>{o(a)().length>0&&F(re)})}var te=f(J,2);{var oe=F=>{var C=Mf(),B=f(Ve(C),2);Fe(B,21,()=>o(i)(),it,(se,ee)=>{let pe=()=>o(ee).task,de=()=>o(ee).health;var ue=If(),Ee=d(ue),_e=d(Ee),Pe=f(Ee,2),le=d(Pe),U=f(le,2),D=d(U);Y(q=>{M(_e,pe().name),wn(le,`width: ${de()??""}%; background-color: ${q??""}`),M(D,`${de()??""}/100`)},[()=>u(de())]),T(se,ue)}),T(F,C)};H(te,F=>{o(i)().length>0&&o(i)()[0].health<80&&F(oe)})}var ge=f(j,2);{var $=F=>{var C=Nf(),B=f(d(C),2);Fe(B,21,()=>o(l)(),it,(se,ee)=>{let pe=()=>o(ee).task,de=()=>o(ee).completedAt;var ue=Of(),Ee=f(d(ue),2),_e=d(Ee),Pe=d(_e),le=f(_e,2),U=d(le);Y(D=>{M(Pe,pe().name),M(U,D)},[()=>c(de())]),T(se,ue)}),T(F,C)};H(ge,F=>{o(l)().length>0&&F($)})}Y((F,C,B)=>{M(g,F),M(E,C),M(L,`${B??""}%`)},[()=>o(t)().totalCompletions,()=>o(t)().totalMisses,()=>o(t)().completionRate]),T(s,h),lt()}var qf=A('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">📥 No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),Ff=A('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),Lf=A('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function Uf(s,e){ot(e,!0);const t=V(()=>e.tasks.filter(_=>_.status!=="done"&&_.status!=="cancelled"&&!_.dueAt&&!_.scheduledAt&&!_.startAt).sort((_,g)=>new Date(g.createdAt).getTime()-new Date(_.createdAt).getTime()));let n=G(0),r=De([]);wt(()=>{o(n)>=o(t).length&&b(n,Math.max(0,o(t).length-1),!0)});function a(_){var w;if(o(t).length===0)return;const g=Math.max(0,Math.min(_,o(t).length-1));b(n,g,!0),(w=r[g])==null||w.focus()}function i(_,g){_.key==="ArrowDown"?(_.preventDefault(),a(g+1)):_.key==="ArrowUp"?(_.preventDefault(),a(g-1)):_.key==="Enter"&&e.onEdit?(_.preventDefault(),e.onEdit(o(t)[g])):_.key===" "&&e.onDone&&(_.preventDefault(),e.onDone(o(t)[g]))}var l=Lf(),c=d(l),u=f(d(c),2),h=d(u),v=f(c,2),p=d(v);{var m=_=>{var g=qf();T(_,g)},k=_=>{var g=ht(),w=Ve(g);Fe(w,19,()=>o(t),S=>S.id,(S,E,x)=>{var O=Ff();O.__keydown=R=>i(R,o(x));var L=d(O);yr(L,{get task(){return o(E)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Tn(O,(R,W)=>r[W]=R,R=>r==null?void 0:r[R],()=>[o(x)]),Y(()=>Me(O,"tabindex",o(x)===o(n)?0:-1)),Ot("focus",O,()=>b(n,o(x),!0)),T(S,O)}),T(_,g)};H(p,_=>{o(t).length===0?_(m):_(k,!1)})}Y(()=>M(h,`${o(t).length??""} task${o(t).length!==1?"s":""} without dates`)),T(s,l),lt()}mt(["keydown"]);var zf=A('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),Bf=A('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),Yf=A('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),jf=A('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function Hf(s,e){ot(e,!0);let t=$n(e,"daysAhead",3,7);const n=new Date;n.setHours(0,0,0,0);const r=new Date(n);r.setDate(r.getDate()+t());const a=V(()=>e.tasks.filter(E=>{if(E.status==="done"||E.status==="cancelled"||!E.dueAt)return!1;const x=new Date(E.dueAt);return x.setHours(0,0,0,0),x>n&&x<=r}).sort((E,x)=>new Date(E.dueAt).getTime()-new Date(x.dueAt).getTime())),i=V(()=>()=>{const E=new Map;return o(a).forEach(x=>{const O=new Date(x.dueAt);O.setHours(0,0,0,0);const L=O.toISOString().split("T")[0];E.has(L)||E.set(L,[]),E.get(L).push(x)}),E});function l(E){const x=new Date(E),O=Math.floor((x.getTime()-n.getTime())/(1e3*60*60*24)),L=x.toLocaleDateString("en-US",{weekday:"long"}),R=x.toLocaleDateString("en-US",{month:"short",day:"numeric"});return O===1?`Tomorrow - ${L}, ${R}`:`${L}, ${R} (in ${O} days)`}let c=G(0),u=De([]);wt(()=>{o(c)>=o(a).length&&b(c,Math.max(0,o(a).length-1),!0)});function h(E,x){E.key==="ArrowDown"?(E.preventDefault(),b(c,Math.min(o(c)+1,o(a).length-1),!0)):E.key==="ArrowUp"?(E.preventDefault(),b(c,Math.max(o(c)-1,0),!0)):E.key==="Enter"&&e.onEdit?(E.preventDefault(),e.onEdit(o(a)[x])):E.key===" "&&e.onDone&&(E.preventDefault(),e.onDone(o(a)[x]))}var v=jf(),p=d(v),m=f(d(p),2),k=d(m),_=f(p,2),g=d(_);{var w=E=>{var x=zf(),O=d(x),L=d(O);Y(()=>M(L,`📅 No tasks scheduled for the next ${t()??""} days`)),T(E,x)},S=E=>{var x=ht(),O=Ve(x);Fe(O,17,()=>[...o(i).entries()],it,(L,R)=>{var W=V(()=>$l(o(R),2));let j=()=>o(W)[0],J=()=>o(W)[1];var re=Yf(),te=d(re),oe=d(te),ge=f(te,2);Fe(ge,19,J,$=>$.id,($,F)=>{const C=V(()=>o(a).indexOf(o(F)));var B=Bf();B.__keydown=ee=>h(ee,o(C));var se=d(B);yr(se,{get task(){return o(F)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Tn(B,(ee,pe)=>u[pe]=ee,ee=>u==null?void 0:u[ee],()=>[o(C)]),Y(()=>Me(B,"tabindex",o(C)===o(c)?0:-1)),Ot("focus",B,()=>b(c,o(C),!0)),T($,B)}),Y($=>M(oe,$),[()=>l(j())]),T(L,re)}),T(E,x)};H(g,E=>{o(a).length===0?E(w):E(S,!1)})}Y(()=>M(k,`${o(a).length??""} task${o(a).length!==1?"s":""} in the next ${t()??""} days`)),T(s,v),lt()}mt(["keydown"]);var $f=A('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">✅ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),Wf=A('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),Gf=A('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),Kf=A('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">← Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next →</button></div>'),Vf=A("<!> <!>",1),Qf=A('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function Zf(s,e){ot(e,!0);let t=$n(e,"daysBack",3,30),n=G(0);const r=50,a=new Date;a.setDate(a.getDate()-t()),a.setHours(0,0,0,0);const i=V(()=>e.tasks.filter(R=>R.status!=="done"||!R.doneAt?!1:new Date(R.doneAt)>=a).sort((R,W)=>new Date(W.doneAt).getTime()-new Date(R.doneAt).getTime())),l=V(()=>Math.ceil(o(i).length/r)),c=V(()=>o(i).slice(o(n)*r,(o(n)+1)*r));wt(()=>{o(n)>=o(l)&&o(l)>0&&b(n,o(l)-1)});function u(){o(n)<o(l)-1&&To(n)}function h(){o(n)>0&&To(n,-1)}function v(R){const W=new Date(R),j=new Date,J=j.getTime()-W.getTime(),re=Math.floor(J/(1e3*60*60*24));return re===0?"Today":re===1?"Yesterday":re<7?`${re} days ago`:W.toLocaleDateString("en-US",{month:"short",day:"numeric",year:W.getFullYear()!==j.getFullYear()?"numeric":void 0})}let p=G(0),m=De([]);wt(()=>{o(p)>=o(c).length&&b(p,Math.max(0,o(c).length-1),!0)});function k(R,W){R.key==="ArrowDown"?(R.preventDefault(),b(p,Math.min(o(p)+1,o(c).length-1),!0)):R.key==="ArrowUp"?(R.preventDefault(),b(p,Math.max(o(p)-1,0),!0)):R.key==="Enter"&&e.onEdit&&(R.preventDefault(),e.onEdit(o(c)[W]))}var _=Qf(),g=d(_),w=f(d(g),2),S=d(w),E=f(g,2),x=d(E);{var O=R=>{var W=$f();T(R,W)},L=R=>{var W=Vf(),j=Ve(W);Fe(j,19,()=>o(c),te=>te.id,(te,oe,ge)=>{var $=Gf();$.__keydown=de=>k(de,o(ge));var F=d($),C=d(F),B=d(C),se=f(C,2);{var ee=de=>{var ue=Wf();ue.__click=()=>e.onUncomplete(o(oe)),T(de,ue)};H(se,de=>{e.onUncomplete&&de(ee)})}var pe=f(F,2);yr(pe,{get task(){return o(oe)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),Tn($,(de,ue)=>m[ue]=de,de=>m==null?void 0:m[de],()=>[o(ge)]),Y(de=>{Me($,"tabindex",o(ge)===o(p)?0:-1),M(B,`Completed ${de??""}`)},[()=>v(o(oe).doneAt)]),Ot("focus",$,()=>b(p,o(ge),!0)),T(te,$)});var J=f(j,2);{var re=te=>{var oe=Kf(),ge=d(oe);ge.__click=h;var $=f(ge,2),F=d($),C=f($,2);C.__click=u,Y(()=>{ge.disabled=o(n)===0,M(F,`Page ${o(n)+1} of ${o(l)??""}`),C.disabled=o(n)>=o(l)-1}),T(te,oe)};H(J,te=>{o(l)>1&&te(re)})}T(R,W)};H(x,R=>{o(i).length===0?R(O):R(L,!1)})}Y(()=>M(S,`${o(i).length??""} completed task${o(i).length!==1?"s":""} in the last ${t()??""} days`)),T(s,_),lt()}mt(["keydown","click"]);var Xf=A('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">📁 No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),Jf=A('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),ev=A('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),tv=A('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),nv=A('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function sv(s,e){ot(e,!0);const t=V(()=>()=>{const j=new Map;return e.tasks.filter(re=>re.status!=="done"&&re.status!=="cancelled").forEach(re=>{const te=re.linkedBlockPath||"Uncategorized";j.has(te)||j.set(te,[]),j.get(te).push(re)}),j.forEach(re=>{re.sort((te,oe)=>!te.dueAt&&!oe.dueAt?0:te.dueAt?oe.dueAt?new Date(te.dueAt).getTime()-new Date(oe.dueAt).getTime():-1:1)}),new Map([...j.entries()].sort(([re],[te])=>re.localeCompare(te)))}),n=V(()=>[...o(t).values()].reduce((j,J)=>j+J.length,0));let r=G(De(new Set([...o(t).keys()])));function a(j){const J=new Set(o(r));J.has(j)?J.delete(j):J.add(j),b(r,J,!0)}function i(){b(r,new Set([...o(t).keys()]),!0)}function l(){b(r,new Set,!0)}let c=G(0),u=De([]);const h=V(()=>()=>{const j=[];return o(t).forEach((J,re)=>{o(r).has(re)&&j.push(...J)}),j});wt(()=>{o(c)>=o(h).length&&b(c,Math.max(0,o(h).length-1),!0)});function v(j,J){j.key==="ArrowDown"?(j.preventDefault(),b(c,Math.min(o(c)+1,o(h).length-1),!0)):j.key==="ArrowUp"?(j.preventDefault(),b(c,Math.max(o(c)-1,0),!0)):j.key==="Enter"&&e.onEdit?(j.preventDefault(),e.onEdit(o(h)[J])):j.key===" "&&e.onDone&&(j.preventDefault(),e.onDone(o(h)[J]))}function p(j){const J=j.split("/");return J[J.length-1]||j}var m=nv(),k=d(m),_=d(k),g=f(d(_),2),w=d(g),S=f(_,2),E=d(S);E.__click=i;var x=f(E,2);x.__click=l;var O=f(k,2),L=d(O);{var R=j=>{var J=Xf();T(j,J)},W=j=>{var J=ht(),re=Ve(J);Fe(re,17,()=>[...o(t).entries()],it,(te,oe)=>{var ge=V(()=>$l(o(oe),2));let $=()=>o(ge)[0],F=()=>o(ge)[1];var C=tv(),B=d(C);B.__click=()=>a($());var se=d(B),ee=d(se),pe=f(se,2),de=d(pe),ue=f(pe,2),Ee=d(ue),_e=f(B,2);{var Pe=le=>{var U=ev();Fe(U,23,F,D=>D.id,(D,q)=>{const Q=V(()=>o(h).indexOf(o(q)));var ae=Jf();ae.__keydown=P=>v(P,o(Q));var I=d(ae);yr(I,{get task(){return o(q)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Tn(ae,(P,Z)=>u[Z]=P,P=>u==null?void 0:u[P],()=>[o(Q)]),Y(()=>Me(ae,"tabindex",o(Q)===o(c)?0:-1)),Ot("focus",ae,()=>b(c,o(Q),!0)),T(D,ae)}),Y(D=>Me(U,"aria-label",D),[()=>`Tasks for ${p($())}`]),T(le,U)};H(_e,le=>{o(r).has($())&&le(Pe)})}Y((le,U)=>{M(ee,le),Me(pe,"title",$()),M(de,U),M(Ee,F().length)},[()=>o(r).has($())?"▼":"▶",()=>p($())]),T(te,C)}),T(j,J)};H(L,j=>{o(t).size===0?j(R):j(W,!1)})}Y(()=>M(w,`${o(n)??""} task${o(n)!==1?"s":""} in ${o(t).size??""} project${o(t).size!==1?"s":""}`)),T(s,m),lt()}mt(["click","keydown"]);class Ht extends Error{constructor(e,t,n,r){super(e),this.line=t,this.column=n,this.suggestion=r,this.name="QuerySyntaxError"}}class Ws extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var vt=(s=>(s.TODO="TODO",s.IN_PROGRESS="IN_PROGRESS",s.DONE="DONE",s.CANCELLED="CANCELLED",s.NON_TASK="NON_TASK",s.EMPTY="EMPTY",s))(vt||{});const En=class En{constructor(e){y(this,"symbol");y(this,"name");y(this,"nextStatusSymbol");y(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};y(En,"TODO",new En({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),y(En,"DONE",new En({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),y(En,"IN_PROGRESS",new En({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),y(En,"CANCELLED",new En({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let Fn=En;var je;(function(s){s[s.AM=0]="AM",s[s.PM=1]="PM"})(je||(je={}));var rt;(function(s){s[s.SUNDAY=0]="SUNDAY",s[s.MONDAY=1]="MONDAY",s[s.TUESDAY=2]="TUESDAY",s[s.WEDNESDAY=3]="WEDNESDAY",s[s.THURSDAY=4]="THURSDAY",s[s.FRIDAY=5]="FRIDAY",s[s.SATURDAY=6]="SATURDAY"})(rt||(rt={}));var on;(function(s){s[s.JANUARY=1]="JANUARY",s[s.FEBRUARY=2]="FEBRUARY",s[s.MARCH=3]="MARCH",s[s.APRIL=4]="APRIL",s[s.MAY=5]="MAY",s[s.JUNE=6]="JUNE",s[s.JULY=7]="JULY",s[s.AUGUST=8]="AUGUST",s[s.SEPTEMBER=9]="SEPTEMBER",s[s.OCTOBER=10]="OCTOBER",s[s.NOVEMBER=11]="NOVEMBER",s[s.DECEMBER=12]="DECEMBER"})(on||(on={}));function Ls(s,e){s.assign("day",e.getDate()),s.assign("month",e.getMonth()+1),s.assign("year",e.getFullYear())}function Gc(s,e){s.assign("hour",e.getHours()),s.assign("minute",e.getMinutes()),s.assign("second",e.getSeconds()),s.assign("millisecond",e.getMilliseconds()),s.assign("meridiem",e.getHours()<12?je.AM:je.PM)}function Vs(s,e){s.imply("day",e.getDate()),s.imply("month",e.getMonth()+1),s.imply("year",e.getFullYear())}function io(s,e){s.imply("hour",e.getHours()),s.imply("minute",e.getMinutes()),s.imply("second",e.getSeconds()),s.imply("millisecond",e.getMilliseconds()),s.imply("meridiem",e.getHours()<12?je.AM:je.PM)}const rv={ACDT:630,ACST:570,ADT:-180,AEDT:660,AEST:600,AFT:270,AKDT:-480,AKST:-540,ALMT:360,AMST:-180,AMT:-240,ANAST:720,ANAT:720,AQTT:300,ART:-180,AST:-240,AWDT:540,AWST:480,AZOST:0,AZOT:-60,AZST:300,AZT:240,BNT:480,BOT:-240,BRST:-120,BRT:-180,BST:60,BTT:360,CAST:480,CAT:120,CCT:390,CDT:-300,CEST:120,CET:{timezoneOffsetDuringDst:2*60,timezoneOffsetNonDst:60,dstStart:s=>Xo(s,on.MARCH,rt.SUNDAY,2),dstEnd:s=>Xo(s,on.OCTOBER,rt.SUNDAY,3)},CHADT:825,CHAST:765,CKT:-600,CLST:-180,CLT:-240,COT:-300,CST:-360,CT:{timezoneOffsetDuringDst:-5*60,timezoneOffsetNonDst:-6*60,dstStart:s=>Jn(s,on.MARCH,rt.SUNDAY,2,2),dstEnd:s=>Jn(s,on.NOVEMBER,rt.SUNDAY,1,2)},CVT:-60,CXT:420,ChST:600,DAVT:420,EASST:-300,EAST:-360,EAT:180,ECT:-300,EDT:-240,EEST:180,EET:120,EGST:0,EGT:-60,EST:-300,ET:{timezoneOffsetDuringDst:-4*60,timezoneOffsetNonDst:-5*60,dstStart:s=>Jn(s,on.MARCH,rt.SUNDAY,2,2),dstEnd:s=>Jn(s,on.NOVEMBER,rt.SUNDAY,1,2)},FJST:780,FJT:720,FKST:-180,FKT:-240,FNT:-120,GALT:-360,GAMT:-540,GET:240,GFT:-180,GILT:720,GMT:0,GST:240,GYT:-240,HAA:-180,HAC:-300,HADT:-540,HAE:-240,HAP:-420,HAR:-360,HAST:-600,HAT:-90,HAY:-480,HKT:480,HLV:-210,HNA:-240,HNC:-360,HNE:-300,HNP:-480,HNR:-420,HNT:-150,HNY:-540,HOVT:420,ICT:420,IDT:180,IOT:360,IRDT:270,IRKST:540,IRKT:540,IRST:210,IST:330,JST:540,KGT:360,KRAST:480,KRAT:480,KST:540,KUYT:240,LHDT:660,LHST:630,LINT:840,MAGST:720,MAGT:720,MART:-510,MAWT:300,MDT:-360,MESZ:120,MEZ:60,MHT:720,MMT:390,MSD:240,MSK:180,MST:-420,MT:{timezoneOffsetDuringDst:-6*60,timezoneOffsetNonDst:-7*60,dstStart:s=>Jn(s,on.MARCH,rt.SUNDAY,2,2),dstEnd:s=>Jn(s,on.NOVEMBER,rt.SUNDAY,1,2)},MUT:240,MVT:300,MYT:480,NCT:660,NDT:-90,NFT:690,NOVST:420,NOVT:360,NPT:345,NST:-150,NUT:-660,NZDT:780,NZST:720,OMSST:420,OMST:420,PDT:-420,PET:-300,PETST:720,PETT:720,PGT:600,PHOT:780,PHT:480,PKT:300,PMDT:-120,PMST:-180,PONT:660,PST:-480,PT:{timezoneOffsetDuringDst:-7*60,timezoneOffsetNonDst:-8*60,dstStart:s=>Jn(s,on.MARCH,rt.SUNDAY,2,2),dstEnd:s=>Jn(s,on.NOVEMBER,rt.SUNDAY,1,2)},PWT:540,PYST:-180,PYT:-240,RET:240,SAMT:240,SAST:120,SBT:660,SCT:240,SGT:480,SRT:-180,SST:-660,TAHT:-600,TFT:300,TJT:300,TKT:780,TLT:540,TMT:300,TVT:720,ULAT:480,UTC:0,UYST:-120,UYT:-180,UZT:300,VET:-210,VLAST:660,VLAT:660,VUT:660,WAST:120,WAT:60,WEST:60,WESZ:60,WET:0,WEZ:0,WFT:720,WGST:-120,WGT:-180,WIB:420,WIT:540,WITA:480,WST:780,WT:0,YAKST:600,YAKT:600,YAPT:600,YEKST:360,YEKT:360};function Jn(s,e,t,n,r=0){let a=0,i=0;for(;i<n;)a++,new Date(s,e-1,a).getDay()===t&&i++;return new Date(s,e-1,a,r)}function Xo(s,e,t,n=0){const r=t===0?7:t,a=new Date(s,e-1+1,1,12),i=a.getDay()===0?7:a.getDay();let l;return i===r?l=7:i<r?l=7+i-r:l=i-r,a.setDate(a.getDate()-l),new Date(s,e-1,a.getDate(),n)}function Kc(s,e,t={}){if(s==null)return null;if(typeof s=="number")return s;const n=t[s]??rv[s];return n==null?null:typeof n=="number"?n:e==null?null:e>n.dstStart(e.getFullYear())&&!(e>n.dstEnd(e.getFullYear()))?n.timezoneOffsetDuringDst:n.timezoneOffsetNonDst}const av={day:0,second:0,millisecond:0};function Wt(s,e){let t=new Date(s);if(e.y&&(e.year=e.y,delete e.y),e.mo&&(e.month=e.mo,delete e.mo),e.M&&(e.month=e.M,delete e.M),e.w&&(e.week=e.w,delete e.w),e.d&&(e.day=e.d,delete e.d),e.h&&(e.hour=e.h,delete e.h),e.m&&(e.minute=e.m,delete e.m),e.s&&(e.second=e.s,delete e.s),e.ms&&(e.millisecond=e.ms,delete e.ms),"year"in e){const n=Math.floor(e.year);t.setFullYear(t.getFullYear()+n);const r=e.year-n;r>0&&(e.month=(e==null?void 0:e.month)??0,e.month+=r*12)}if("quarter"in e){const n=Math.floor(e.quarter);t.setMonth(t.getMonth()+n*3)}if("month"in e){const n=Math.floor(e.month);t.setMonth(t.getMonth()+n);const r=e.month-n;r>0&&(e.week=(e==null?void 0:e.week)??0,e.week+=r*4)}if("week"in e){const n=Math.floor(e.week);t.setDate(t.getDate()+n*7);const r=e.week-n;r>0&&(e.day=(e==null?void 0:e.day)??0,e.day+=Math.round(r*7))}if("day"in e){const n=Math.floor(e.day);t.setDate(t.getDate()+n);const r=e.day-n;r>0&&(e.hour=(e==null?void 0:e.hour)??0,e.hour+=Math.round(r*24))}if("hour"in e){const n=Math.floor(e.hour);t.setHours(t.getHours()+n);const r=e.hour-n;r>0&&(e.minute=(e==null?void 0:e.minute)??0,e.minute+=Math.round(r*60))}if("minute"in e){const n=Math.floor(e.minute);t.setMinutes(t.getMinutes()+n);const r=e.minute-n;r>0&&(e.second=(e==null?void 0:e.second)??0,e.second+=Math.round(r*60))}if("second"in e){const n=Math.floor(e.second);t.setSeconds(t.getSeconds()+n);const r=e.second-n;r>0&&(e.millisecond=(e==null?void 0:e.millisecond)??0,e.millisecond+=Math.round(r*1e3))}if("millisecond"in e){const n=Math.floor(e.millisecond);t.setMilliseconds(t.getMilliseconds()+n)}return t}function Oa(s){const e={};for(const t in s)e[t]=-s[t];return e}class Ns{constructor(e,t){y(this,"instant");y(this,"timezoneOffset");this.instant=e??new Date,this.timezoneOffset=t??null}static fromDate(e){return new Ns(e)}static fromInput(e,t){if(e instanceof Date)return Ns.fromDate(e);const n=(e==null?void 0:e.instant)??new Date,r=Kc(e==null?void 0:e.timezone,n,t);return new Ns(n,r)}getDateWithAdjustedTimezone(){const e=new Date(this.instant);return this.timezoneOffset!==null&&e.setMinutes(e.getMinutes()-this.getSystemTimezoneAdjustmentMinute(this.instant)),e}getSystemTimezoneAdjustmentMinute(e,t){(!e||e.getTime()<0)&&(e=new Date);const n=-e.getTimezoneOffset(),r=t??this.timezoneOffset??n;return n-r}getTimezoneOffset(){return this.timezoneOffset??-this.instant.getTimezoneOffset()}}class Xe{constructor(e,t){y(this,"knownValues");y(this,"impliedValues");y(this,"reference");y(this,"_tags",new Set);if(this.reference=e,this.knownValues={},this.impliedValues={},t)for(const r in t)this.knownValues[r]=t[r];const n=e.getDateWithAdjustedTimezone();this.imply("day",n.getDate()),this.imply("month",n.getMonth()+1),this.imply("year",n.getFullYear()),this.imply("hour",12),this.imply("minute",0),this.imply("second",0),this.imply("millisecond",0)}static createRelativeFromReference(e,t=av){let n=Wt(e.getDateWithAdjustedTimezone(),t);const r=new Xe(e);return r.addTag("result/relativeDate"),"hour"in t||"minute"in t||"second"in t||"millisecond"in t?(r.addTag("result/relativeDateAndTime"),Gc(r,n),Ls(r,n),r.assign("timezoneOffset",e.getTimezoneOffset())):(io(r,n),r.imply("timezoneOffset",e.getTimezoneOffset()),"day"in t?(r.assign("day",n.getDate()),r.assign("month",n.getMonth()+1),r.assign("year",n.getFullYear()),r.assign("weekday",n.getDay())):"week"in t?(r.assign("day",n.getDate()),r.assign("month",n.getMonth()+1),r.assign("year",n.getFullYear()),r.imply("weekday",n.getDay())):(r.imply("day",n.getDate()),"month"in t?(r.assign("month",n.getMonth()+1),r.assign("year",n.getFullYear())):(r.imply("month",n.getMonth()+1),"year"in t?r.assign("year",n.getFullYear()):r.imply("year",n.getFullYear())))),r}get(e){return e in this.knownValues?this.knownValues[e]:e in this.impliedValues?this.impliedValues[e]:null}isCertain(e){return e in this.knownValues}getCertainComponents(){return Object.keys(this.knownValues)}imply(e,t){return e in this.knownValues?this:(this.impliedValues[e]=t,this)}assign(e,t){return this.knownValues[e]=t,delete this.impliedValues[e],this}addDurationAsImplied(e){const t=this.dateWithoutTimezoneAdjustment(),n=Wt(t,e);return("day"in e||"week"in e||"month"in e||"year"in e)&&(this.delete(["day","weekday","month","year"]),this.imply("day",n.getDate()),this.imply("weekday",n.getDay()),this.imply("month",n.getMonth()+1),this.imply("year",n.getFullYear())),("second"in e||"minute"in e||"hour"in e)&&(this.delete(["second","minute","hour"]),this.imply("second",n.getSeconds()),this.imply("minute",n.getMinutes()),this.imply("hour",n.getHours())),this}delete(e){typeof e=="string"&&(e=[e]);for(const t of e)delete this.knownValues[t],delete this.impliedValues[t]}clone(){const e=new Xe(this.reference);e.knownValues={},e.impliedValues={};for(const t in this.knownValues)e.knownValues[t]=this.knownValues[t];for(const t in this.impliedValues)e.impliedValues[t]=this.impliedValues[t];return e}isOnlyDate(){return!this.isCertain("hour")&&!this.isCertain("minute")&&!this.isCertain("second")}isOnlyTime(){return!this.isCertain("weekday")&&!this.isCertain("day")&&!this.isCertain("month")&&!this.isCertain("year")}isOnlyWeekdayComponent(){return this.isCertain("weekday")&&!this.isCertain("day")&&!this.isCertain("month")}isDateWithUnknownYear(){return this.isCertain("month")&&!this.isCertain("year")}isValidDate(){const e=this.dateWithoutTimezoneAdjustment();return!(e.getFullYear()!==this.get("year")||e.getMonth()!==this.get("month")-1||e.getDate()!==this.get("day")||this.get("hour")!=null&&e.getHours()!=this.get("hour")||this.get("minute")!=null&&e.getMinutes()!=this.get("minute"))}toString(){return`[ParsingComponents {
            tags: ${JSON.stringify(Array.from(this._tags).sort())}, 
            knownValues: ${JSON.stringify(this.knownValues)}, 
            impliedValues: ${JSON.stringify(this.impliedValues)}}, 
            reference: ${JSON.stringify(this.reference)}]`}date(){const e=this.dateWithoutTimezoneAdjustment(),t=this.reference.getSystemTimezoneAdjustmentMinute(e,this.get("timezoneOffset"));return new Date(e.getTime()+t*6e4)}addTag(e){return this._tags.add(e),this}addTags(e){for(const t of e)this._tags.add(t);return this}tags(){return new Set(this._tags)}dateWithoutTimezoneAdjustment(){const e=new Date(this.get("year"),this.get("month")-1,this.get("day"),this.get("hour"),this.get("minute"),this.get("second"),this.get("millisecond"));return e.setFullYear(this.get("year")),e}}class br{constructor(e,t,n,r,a){y(this,"refDate");y(this,"index");y(this,"text");y(this,"reference");y(this,"start");y(this,"end");this.reference=e,this.refDate=e.instant,this.index=t,this.text=n,this.start=r||new Xe(e),this.end=a}clone(){const e=new br(this.reference,this.index,this.text);return e.start=this.start?this.start.clone():null,e.end=this.end?this.end.clone():null,e}date(){return this.start.date()}addTag(e){return this.start.addTag(e),this.end&&this.end.addTag(e),this}addTags(e){return this.start.addTags(e),this.end&&this.end.addTags(e),this}tags(){const e=new Set(this.start.tags());if(this.end)for(const t of this.end.tags())e.add(t);return e}toString(){const e=Array.from(this.tags()).sort();return`[ParsingResult {index: ${this.index}, text: '${this.text}', tags: ${JSON.stringify(e)} ...}]`}}function Vc(s,e,t="\\s{0,5},?\\s{0,5}"){const n=e.replace(/\((?!\?)/g,"(?:");return`${s}${n}(?:${t}${n}){0,10}`}function iv(s){let e;return s instanceof Array?e=[...s]:s instanceof Map?e=Array.from(s.keys()):e=Object.keys(s),e}function Nn(s){return`(?:${iv(s).sort((t,n)=>n.length-t.length).join("|").replace(/\./g,"\\.")})`}function Qc(s){return s<100&&(s>50?s=s+1900:s=s+2e3),s}function Na(s,e,t){let n=new Date(s);n.setMonth(t-1),n.setDate(e);const r=Wt(n,{year:1}),a=Wt(n,{year:-1});return Math.abs(r.getTime()-s.getTime())<Math.abs(n.getTime()-s.getTime())?n=r:Math.abs(a.getTime()-s.getTime())<Math.abs(n.getTime()-s.getTime())&&(n=a),n.getFullYear()}const _i={sunday:0,sun:0,"sun.":0,monday:1,mon:1,"mon.":1,tuesday:2,tue:2,"tue.":2,wednesday:3,wed:3,"wed.":3,thursday:4,thurs:4,"thurs.":4,thur:4,"thur.":4,thu:4,"thu.":4,friday:5,fri:5,"fri.":5,saturday:6,sat:6,"sat.":6},Zc={january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12},vs={...Zc,jan:1,"jan.":1,feb:2,"feb.":2,mar:3,"mar.":3,apr:4,"apr.":4,jun:6,"jun.":6,jul:7,"jul.":7,aug:8,"aug.":8,sep:9,"sep.":9,sept:9,"sept.":9,oct:10,"oct.":10,nov:11,"nov.":11,dec:12,"dec.":12},ki={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12},wi={first:1,second:2,third:3,fourth:4,fifth:5,sixth:6,seventh:7,eighth:8,ninth:9,tenth:10,eleventh:11,twelfth:12,thirteenth:13,fourteenth:14,fifteenth:15,sixteenth:16,seventeenth:17,eighteenth:18,nineteenth:19,twentieth:20,"twenty first":21,"twenty-first":21,"twenty second":22,"twenty-second":22,"twenty third":23,"twenty-third":23,"twenty fourth":24,"twenty-fourth":24,"twenty fifth":25,"twenty-fifth":25,"twenty sixth":26,"twenty-sixth":26,"twenty seventh":27,"twenty-seventh":27,"twenty eighth":28,"twenty-eighth":28,"twenty ninth":29,"twenty-ninth":29,thirtieth:30,"thirty first":31,"thirty-first":31},Xc={second:"second",seconds:"second",minute:"minute",minutes:"minute",hour:"hour",hours:"hour",day:"day",days:"day",week:"week",weeks:"week",month:"month",months:"month",quarter:"quarter",quarters:"quarter",year:"year",years:"year"},Ra={s:"second",sec:"second",second:"second",seconds:"second",m:"minute",min:"minute",mins:"minute",minute:"minute",minutes:"minute",h:"hour",hr:"hour",hrs:"hour",hour:"hour",hours:"hour",d:"day",day:"day",days:"day",w:"week",week:"week",weeks:"week",mo:"month",mon:"month",mos:"month",month:"month",months:"month",qtr:"quarter",quarter:"quarter",quarters:"quarter",y:"year",yr:"year",year:"year",years:"year",...Xc},Jc=`(?:${Nn(ki)}|[0-9]+|[0-9]+\\.[0-9]+|half(?:\\s{0,2}an?)?|an?\\b(?:\\s{0,2}few)?|few|several|the|a?\\s{0,2}couple\\s{0,2}(?:of)?)`;function ov(s){const e=s.toLowerCase();return ki[e]!==void 0?ki[e]:e==="a"||e==="an"||e=="the"?1:e.match(/few/)?3:e.match(/half/)?.5:e.match(/couple/)?2:e.match(/several/)?7:parseFloat(e)}const va=`(?:${Nn(wi)}|[0-9]{1,2}(?:st|nd|rd|th)?)`;function ga(s){let e=s.toLowerCase();return wi[e]!==void 0?wi[e]:(e=e.replace(/(?:st|nd|rd|th)$/i,""),parseInt(e))}const Pa="(?:[1-9][0-9]{0,3}\\s{0,2}(?:BE|AD|BC|BCE|CE)|[1-2][0-9]{3}|[5-9][0-9]|2[0-5])";function qa(s){if(/BE/i.test(s))return s=s.replace(/BE/i,""),parseInt(s)-543;if(/BCE?/i.test(s))return s=s.replace(/BCE?/i,""),-parseInt(s);if(/(AD|CE)/i.test(s))return s=s.replace(/(AD|CE)/i,""),parseInt(s);const e=parseInt(s);return Qc(e)}const eu=`(${Jc})\\s{0,3}(${Nn(Ra)})`,Jo=new RegExp(eu,"i"),lv=`(${Jc})\\s{0,3}(${Nn(Xc)})`,tu="\\s{0,5},?(?:\\s*and)?\\s{0,5}",jr=Vc("(?:(?:about|around)\\s{0,3})?",eu,tu),Fa=Vc("(?:(?:about|around)\\s{0,3})?",lv,tu);function _r(s){const e={};let t=s,n=Jo.exec(t);for(;n;)cv(e,n),t=t.substring(n[0].length).trim(),n=Jo.exec(t);return Object.keys(e).length==0?null:e}function cv(s,e){if(e[0].match(/^[a-zA-Z]+$/))return;const t=ov(e[1]),n=Ra[e[2].toLowerCase()];s[n]=t}class Vt{constructor(){y(this,"cachedInnerPattern",null);y(this,"cachedPattern",null)}innerPatternHasChange(e,t){return this.innerPattern(e)!==t}patternLeftBoundary(){return"(\\W|^)"}pattern(e){return this.cachedInnerPattern&&!this.innerPatternHasChange(e,this.cachedInnerPattern)?this.cachedPattern:(this.cachedInnerPattern=this.innerPattern(e),this.cachedPattern=new RegExp(`${this.patternLeftBoundary()}${this.cachedInnerPattern.source}`,this.cachedInnerPattern.flags),this.cachedPattern)}extract(e,t){const n=t[1]??"";t.index=t.index+n.length,t[0]=t[0].substring(n.length);for(let r=2;r<t.length;r++)t[r-1]=t[r];return this.innerExtract(e,t)}}const uv=new RegExp(`(?:(?:within|in|for)\\s*)?(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${jr})(?=\\W|$)`,"i"),dv=new RegExp(`(?:within|in|for)\\s*(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${jr})(?=\\W|$)`,"i"),hv=new RegExp(`(?:within|in|for)\\s*(?:(?:about|around|roughly|approximately|just)\\s*(?:~\\s*)?)?(${Fa})(?=\\W|$)`,"i");class fv extends Vt{constructor(t){super();y(this,"strictMode");this.strictMode=t}innerPattern(t){return this.strictMode?hv:t.option.forwardDate?uv:dv}innerExtract(t,n){if(n[0].match(/^for\s*the\s*\w+/))return null;const r=_r(n[1]);return r?Xe.createRelativeFromReference(t.reference,r):null}}const vv=new RegExp(`(?:on\\s{0,3})?(${va})(?:\\s{0,3}(?:to|\\-|\\–|until|through|till)?\\s{0,3}(${va}))?(?:-|/|\\s{0,3}(?:of)?\\s{0,3})(${Nn(vs)})(?:(?:-|/|,?\\s{0,3})(${Pa}(?!\\w)))?(?=\\W|$)`,"i"),el=1,tl=2,gv=3,nl=4;class pv extends Vt{innerPattern(){return vv}innerExtract(e,t){const n=e.createParsingResult(t.index,t[0]),r=vs[t[gv].toLowerCase()],a=ga(t[el]);if(a>31)return t.index=t.index+t[el].length,null;if(n.start.assign("month",r),n.start.assign("day",a),t[nl]){const i=qa(t[nl]);n.start.assign("year",i)}else{const i=Na(e.refDate,a,r);n.start.imply("year",i)}if(t[tl]){const i=ga(t[tl]);n.end=n.start.clone(),n.end.assign("day",i)}return n}}const mv=new RegExp(`(${Nn(vs)})(?:-|/|\\s*,?\\s*)(${va})(?!\\s*(?:am|pm))\\s*(?:(?:to|\\-)\\s*(${va})\\s*)?(?:(?:-|/|\\s*,\\s*|\\s+)(${Pa}))?(?=\\W|$)(?!\\:\\d)`,"i"),yv=1,sl=2,Va=3,Qa=4;class bv extends Vt{constructor(t){super();y(this,"shouldSkipYearLikeDate");this.shouldSkipYearLikeDate=t}innerPattern(){return mv}innerExtract(t,n){const r=vs[n[yv].toLowerCase()],a=ga(n[sl]);if(a>31||this.shouldSkipYearLikeDate&&!n[Va]&&!n[Qa]&&n[sl].match(/^2[0-5]$/))return null;const i=t.createParsingComponents({day:a,month:r}).addTag("parser/ENMonthNameMiddleEndianParser");if(n[Qa]){const u=qa(n[Qa]);i.assign("year",u)}else{const u=Na(t.refDate,a,r);i.imply("year",u)}if(!n[Va])return i;const l=ga(n[Va]),c=t.createParsingResult(n.index,n[0]);return c.start=i,c.end=i.clone(),c.end.assign("day",l),c}}const _v=new RegExp(`((?:in)\\s*)?(${Nn(vs)})\\s*(?:(?:,|-|of)?\\s*(${Pa})?)?(?=[^\\s\\w]|\\s+[^0-9]|\\s+$|$)`,"i"),kv=1,wv=2,rl=3;class Tv extends Vt{innerPattern(){return _v}innerExtract(e,t){const n=t[wv].toLowerCase();if(t[0].length<=3&&!Zc[n])return null;const r=e.createParsingResult(t.index+(t[kv]||"").length,t.index+t[0].length);r.start.imply("day",1),r.start.addTag("parser/ENMonthNameParser");const a=vs[n];if(r.start.assign("month",a),t[rl]){const i=qa(t[rl]);r.start.assign("year",i)}else{const i=Na(e.refDate,1,a);r.start.imply("year",i)}return r}}const Sv=new RegExp(`([0-9]{4})[-\\.\\/\\s](?:(${Nn(vs)})|([0-9]{1,2}))[-\\.\\/\\s]([0-9]{1,2})(?=\\W|$)`,"i"),Dv=1,Ev=2,al=3,xv=4;class Av extends Vt{constructor(t){super();y(this,"strictMonthDateOrder");this.strictMonthDateOrder=t}innerPattern(){return Sv}innerExtract(t,n){const r=parseInt(n[Dv]);let a=parseInt(n[xv]),i=n[al]?parseInt(n[al]):vs[n[Ev].toLowerCase()];if(i<1||i>12){if(this.strictMonthDateOrder)return null;a>=1&&a<=12&&([i,a]=[a,i])}return a<1||a>31?null:{day:a,month:i,year:r}}}const Cv=new RegExp("([0-9]|0[1-9]|1[012])/([0-9]{4})","i"),Iv=1,Mv=2;class Ov extends Vt{innerPattern(){return Cv}innerExtract(e,t){const n=parseInt(t[Mv]),r=parseInt(t[Iv]);return e.createParsingComponents().imply("day",1).assign("month",r).assign("year",n)}}function Nv(s,e,t,n){return new RegExp(`${s}${e}(\\d{1,4})(?:(?:\\.|:|：)(\\d{1,2})(?:(?::|：)(\\d{2})(?:\\.(\\d{1,6}))?)?)?(?:\\s*(a\\.m\\.|p\\.m\\.|am?|pm?))?${t}`,n)}function Rv(s,e){return new RegExp(`^(${s})(\\d{1,4})(?:(?:\\.|\\:|\\：)(\\d{1,2})(?:(?:\\.|\\:|\\：)(\\d{1,2})(?:\\.(\\d{1,6}))?)?)?(?:\\s*(a\\.m\\.|p\\.m\\.|am?|pm?))?${e}`,"i")}const Za=2,ps=3,ta=4,na=5,Gs=6;class Pv{constructor(e=!1){y(this,"strictMode");y(this,"cachedPrimaryPrefix",null);y(this,"cachedPrimarySuffix",null);y(this,"cachedPrimaryTimePattern",null);y(this,"cachedFollowingPhase",null);y(this,"cachedFollowingSuffix",null);y(this,"cachedFollowingTimePatten",null);this.strictMode=e}patternFlags(){return"i"}primaryPatternLeftBoundary(){return"(^|\\s|T|\\b)"}primarySuffix(){return"(?!/)(?=\\W|$)"}followingSuffix(){return"(?!/)(?=\\W|$)"}pattern(e){return this.getPrimaryTimePatternThroughCache()}extract(e,t){const n=this.extractPrimaryTimeComponents(e,t);if(!n)return t[0].match(/^\d{4}/)?(t.index+=4,null):(t.index+=t[0].length,null);const r=t.index+t[1].length,a=t[0].substring(t[1].length),i=e.createParsingResult(r,a,n);t.index+=t[0].length;const l=e.text.substring(t.index),u=this.getFollowingTimePatternThroughCache().exec(l);return a.match(/^\d{3,4}/)&&u&&(u[0].match(/^\s*([+-])\s*\d{2,4}$/)||u[0].match(/^\s*([+-])\s*\d{2}\W\d{2}/))?null:!u||u[0].match(/^\s*([+-])\s*\d{3,4}$/)?this.checkAndReturnWithoutFollowingPattern(i):(i.end=this.extractFollowingTimeComponents(e,u,i),i.end&&(i.text+=u[0]),this.checkAndReturnWithFollowingPattern(i))}extractPrimaryTimeComponents(e,t,n=!1){const r=e.createParsingComponents();let a=0,i=null,l=parseInt(t[Za]);if(l>100){if(t[Za].length==4&&t[ps]==null&&!t[Gs]||this.strictMode||t[ps]!=null)return null;a=l%100,l=Math.floor(l/100)}if(l>24)return null;if(t[ps]!=null){if(t[ps].length==1&&!t[Gs])return null;a=parseInt(t[ps])}if(a>=60)return null;if(l>12&&(i=je.PM),t[Gs]!=null){if(l>12)return null;const c=t[Gs][0].toLowerCase();c=="a"&&(i=je.AM,l==12&&(l=0)),c=="p"&&(i=je.PM,l!=12&&(l+=12))}if(r.assign("hour",l),r.assign("minute",a),i!==null?r.assign("meridiem",i):l<12?r.imply("meridiem",je.AM):r.imply("meridiem",je.PM),t[na]!=null){const c=parseInt(t[na].substring(0,3));if(c>=1e3)return null;r.assign("millisecond",c)}if(t[ta]!=null){const c=parseInt(t[ta]);if(c>=60)return null;r.assign("second",c)}return r}extractFollowingTimeComponents(e,t,n){const r=e.createParsingComponents();if(t[na]!=null){const c=parseInt(t[na].substring(0,3));if(c>=1e3)return null;r.assign("millisecond",c)}if(t[ta]!=null){const c=parseInt(t[ta]);if(c>=60)return null;r.assign("second",c)}let a=parseInt(t[Za]),i=0,l=-1;if(t[ps]!=null?i=parseInt(t[ps]):a>100&&(i=a%100,a=Math.floor(a/100)),i>=60||a>24)return null;if(a>=12&&(l=je.PM),t[Gs]!=null){if(a>12)return null;const c=t[Gs][0].toLowerCase();c=="a"&&(l=je.AM,a==12&&(a=0,r.isCertain("day")||r.imply("day",r.get("day")+1))),c=="p"&&(l=je.PM,a!=12&&(a+=12)),n.start.isCertain("meridiem")||(l==je.AM?(n.start.imply("meridiem",je.AM),n.start.get("hour")==12&&n.start.assign("hour",0)):(n.start.imply("meridiem",je.PM),n.start.get("hour")!=12&&n.start.assign("hour",n.start.get("hour")+12)))}return r.assign("hour",a),r.assign("minute",i),l>=0?r.assign("meridiem",l):n.start.isCertain("meridiem")&&n.start.get("hour")>12?n.start.get("hour")-12>a?r.imply("meridiem",je.AM):a<=12&&(r.assign("hour",a+12),r.assign("meridiem",je.PM)):a>12?r.imply("meridiem",je.PM):a<=12&&r.imply("meridiem",je.AM),r.date().getTime()<n.start.date().getTime()&&r.imply("day",r.get("day")+1),r}checkAndReturnWithoutFollowingPattern(e){if(e.text.match(/^\d$/)||e.text.match(/^\d\d\d+$/)||e.text.match(/\d[apAP]$/))return null;const t=e.text.match(/[^\d:.](\d[\d.]+)$/);if(t){const n=t[1];if(this.strictMode||n.includes(".")&&!n.match(/\d(\.\d{2})+$/)||parseInt(n)>24)return null}return e}checkAndReturnWithFollowingPattern(e){if(e.text.match(/^\d+-\d+$/))return null;const t=e.text.match(/[^\d:.](\d[\d.]+)\s*-\s*(\d[\d.]+)$/);if(t){if(this.strictMode)return null;const n=t[1],r=t[2];if(r.includes(".")&&!r.match(/\d(\.\d{2})+$/))return null;const a=parseInt(r),i=parseInt(n);if(a>24||i>24)return null}return e}getPrimaryTimePatternThroughCache(){const e=this.primaryPrefix(),t=this.primarySuffix();return this.cachedPrimaryPrefix===e&&this.cachedPrimarySuffix===t?this.cachedPrimaryTimePattern:(this.cachedPrimaryTimePattern=Nv(this.primaryPatternLeftBoundary(),e,t,this.patternFlags()),this.cachedPrimaryPrefix=e,this.cachedPrimarySuffix=t,this.cachedPrimaryTimePattern)}getFollowingTimePatternThroughCache(){const e=this.followingPhase(),t=this.followingSuffix();return this.cachedFollowingPhase===e&&this.cachedFollowingSuffix===t?this.cachedFollowingTimePatten:(this.cachedFollowingTimePatten=Rv(e,t),this.cachedFollowingPhase=e,this.cachedFollowingSuffix=t,this.cachedFollowingTimePatten)}}class qv extends Pv{constructor(e){super(e)}followingPhase(){return"\\s*(?:\\-|\\–|\\~|\\〜|to|until|through|till|\\?)\\s*"}primaryPrefix(){return"(?:(?:at|from)\\s*)??"}primarySuffix(){return"(?:\\s*(?:o\\W*clock|at\\s*night|in\\s*the\\s*(?:morning|afternoon)))?(?!/)(?=\\W|$)"}extractPrimaryTimeComponents(e,t){const n=super.extractPrimaryTimeComponents(e,t);if(!n)return n;if(t[0].endsWith("night")){const r=n.get("hour");r>=6&&r<12?(n.assign("hour",n.get("hour")+12),n.assign("meridiem",je.PM)):r<6&&n.assign("meridiem",je.AM)}if(t[0].endsWith("afternoon")){n.assign("meridiem",je.PM);const r=n.get("hour");r>=0&&r<=6&&n.assign("hour",n.get("hour")+12)}return t[0].endsWith("morning")&&(n.assign("meridiem",je.AM),n.get("hour")<12&&n.assign("hour",n.get("hour"))),n.addTag("parser/ENTimeExpressionParser")}extractFollowingTimeComponents(e,t,n){const r=super.extractFollowingTimeComponents(e,t,n);return r&&r.addTag("parser/ENTimeExpressionParser"),r}}const Fv=new RegExp(`(${jr})\\s{0,5}(?:ago|before|earlier)(?=\\W|$)`,"i"),Lv=new RegExp(`(${Fa})\\s{0,5}(?:ago|before|earlier)(?=\\W|$)`,"i");class Uv extends Vt{constructor(t){super();y(this,"strictMode");this.strictMode=t}innerPattern(){return this.strictMode?Lv:Fv}innerExtract(t,n){const r=_r(n[1]);return r?Xe.createRelativeFromReference(t.reference,Oa(r)):null}}const zv=new RegExp(`(${jr})\\s{0,5}(?:later|after|from now|henceforth|forward|out)(?=(?:\\W|$))`,"i"),Bv=new RegExp(`(${Fa})\\s{0,5}(later|after|from now)(?=\\W|$)`,"i"),Yv=1;class jv extends Vt{constructor(t){super();y(this,"strictMode");this.strictMode=t}innerPattern(){return this.strictMode?Bv:zv}innerExtract(t,n){const r=_r(n[Yv]);return r?Xe.createRelativeFromReference(t.reference,r):null}}let nu=class{refine(e,t){return t.filter(n=>this.isValid(e,n))}};class Hr{refine(e,t){if(t.length<2)return t;const n=[];let r=t[0],a=null;for(let i=1;i<t.length;i++){a=t[i];const l=e.text.substring(r.index+r.text.length,a.index);if(!this.shouldMergeResults(l,r,a,e))n.push(r),r=a;else{const c=r,u=a,h=this.mergeResults(l,c,u,e);e.debug(()=>{console.log(`${this.constructor.name} merged ${c} and ${u} into ${h}`)}),r=h}}return r!=null&&n.push(r),n}}class Hv extends Hr{shouldMergeResults(e,t,n){return!t.end&&!n.end&&e.match(this.patternBetween())!=null}mergeResults(e,t,n){if(!t.start.isOnlyWeekdayComponent()&&!n.start.isOnlyWeekdayComponent()&&(n.start.getCertainComponents().forEach(a=>{t.start.isCertain(a)||t.start.imply(a,n.start.get(a))}),t.start.getCertainComponents().forEach(a=>{n.start.isCertain(a)||n.start.imply(a,t.start.get(a))})),t.start.date()>n.start.date()){let a=t.start.date(),i=n.start.date();n.start.isOnlyWeekdayComponent()&&Wt(i,{day:7})>a?(i=Wt(i,{day:7}),n.start.imply("day",i.getDate()),n.start.imply("month",i.getMonth()+1),n.start.imply("year",i.getFullYear())):t.start.isOnlyWeekdayComponent()&&Wt(a,{day:-7})<i?(a=Wt(a,{day:-7}),t.start.imply("day",a.getDate()),t.start.imply("month",a.getMonth()+1),t.start.imply("year",a.getFullYear())):n.start.isDateWithUnknownYear()&&Wt(i,{year:1})>a?(i=Wt(i,{year:1}),n.start.imply("year",i.getFullYear())):t.start.isDateWithUnknownYear()&&Wt(a,{year:-1})<i?(a=Wt(a,{year:-1}),t.start.imply("year",a.getFullYear())):[n,t]=[t,n]}const r=t.clone();return r.start=t.start,r.end=n.start,r.index=Math.min(t.index,n.index),t.index<n.index?r.text=t.text+e+n.text:r.text=n.text+e+t.text,r}}class $v extends Hv{patternBetween(){return/^\s*(to|-|–|until|through|till)\s*$/i}}function il(s,e){const t=s.clone(),n=s.start,r=e.start;if(t.start=ol(n,r),s.end!=null||e.end!=null){const a=s.end==null?s.start:s.end,i=e.end==null?e.start:e.end,l=ol(a,i);if(s.end==null&&l.date().getTime()<t.start.date().getTime()){const c=new Date(l.date().getTime());c.setDate(c.getDate()+1),l.isCertain("day")?Ls(l,c):Vs(l,c)}t.end=l}return t}function ol(s,e){const t=s.clone();return e.isCertain("hour")?(t.assign("hour",e.get("hour")),t.assign("minute",e.get("minute")),e.isCertain("second")?(t.assign("second",e.get("second")),e.isCertain("millisecond")?t.assign("millisecond",e.get("millisecond")):t.imply("millisecond",e.get("millisecond"))):(t.imply("second",e.get("second")),t.imply("millisecond",e.get("millisecond")))):(t.imply("hour",e.get("hour")),t.imply("minute",e.get("minute")),t.imply("second",e.get("second")),t.imply("millisecond",e.get("millisecond"))),e.isCertain("timezoneOffset")&&t.assign("timezoneOffset",e.get("timezoneOffset")),e.isCertain("meridiem")?t.assign("meridiem",e.get("meridiem")):e.get("meridiem")!=null&&t.get("meridiem")==null&&t.imply("meridiem",e.get("meridiem")),t.get("meridiem")==je.PM&&t.get("hour")<12&&(e.isCertain("hour")?t.assign("hour",t.get("hour")+12):t.imply("hour",t.get("hour")+12)),t.addTags(s.tags()),t.addTags(e.tags()),t}class Wv extends Hr{shouldMergeResults(e,t,n){return(t.start.isOnlyDate()&&n.start.isOnlyTime()||n.start.isOnlyDate()&&t.start.isOnlyTime())&&e.match(this.patternBetween())!=null}mergeResults(e,t,n){const r=t.start.isOnlyDate()?il(t,n):il(n,t);return r.index=t.index,r.text=t.text+e+n.text,r}}class ll extends Wv{patternBetween(){return new RegExp("^\\s*(T|at|after|before|on|of|,|-|\\.|∙|:)?\\s*$")}}const Gv=new RegExp("^\\s*,?\\s*\\(?([A-Z]{2,4})\\)?(?=\\W|$)","i");class Kv{constructor(e){y(this,"timezoneOverrides");this.timezoneOverrides=e}refine(e,t){const n=e.option.timezones??{};return t.forEach(r=>{const a=e.text.substring(r.index+r.text.length),i=Gv.exec(a);if(!i)return;const l=i[1].toUpperCase(),c=r.start.date()??r.refDate??new Date,u={...this.timezoneOverrides,...n},h=Kc(l,c,u);if(h==null)return;e.debug(()=>{console.log(`Extracting timezone: '${l}' into: ${h} for: ${r.start}`)});const v=r.start.get("timezoneOffset");v!==null&&h!=v&&(r.start.isCertain("timezoneOffset")||l!=i[1])||r.start.isOnlyDate()&&l!=i[1]||(r.text+=i[0],r.start.isCertain("timezoneOffset")||r.start.assign("timezoneOffset",h),r.end!=null&&!r.end.isCertain("timezoneOffset")&&r.end.assign("timezoneOffset",h))}),t}}const Vv=new RegExp("^\\s*(?:\\(?(?:GMT|UTC)\\s?)?([+-])(\\d{1,2})(?::?(\\d{2}))?\\)?","i"),Qv=1,Zv=2,Xv=3;class Jv{refine(e,t){return t.forEach(function(n){if(n.start.isCertain("timezoneOffset"))return;const r=e.text.substring(n.index+n.text.length),a=Vv.exec(r);if(!a)return;e.debug(()=>{console.log(`Extracting timezone: '${a[0]}' into : ${n}`)});const i=parseInt(a[Zv]),l=parseInt(a[Xv]||"0");let c=i*60+l;c>14*60||(a[Qv]==="-"&&(c=-c),n.end!=null&&n.end.assign("timezoneOffset",c),n.start.assign("timezoneOffset",c),n.text+=a[0])}),t}}class Ti{refine(e,t){if(t.length<2)return t;const n=[];let r=t[0];for(let a=1;a<t.length;a++){const i=t[a];if(i.index>=r.index+r.text.length){n.push(r),r=i;continue}let l=null,c=null;i.text.length>r.text.length?(l=i,c=r):(l=r,c=i),e.debug(()=>{console.log(`${this.constructor.name} remove ${c} by ${l}`)}),r=l}return r!=null&&n.push(r),n}}class eg{refine(e,t){return e.option.forwardDate&&t.forEach(n=>{let r=e.reference.getDateWithAdjustedTimezone();if(n.start.isOnlyTime()&&e.reference.instant>n.start.date()){const a=e.reference.getDateWithAdjustedTimezone(),i=new Date(a);i.setDate(i.getDate()+1),Vs(n.start,i),e.debug(()=>{console.log(`${this.constructor.name} adjusted ${n} time from the ref date (${a}) to the following day (${i})`)}),n.end&&n.end.isOnlyTime()&&(Vs(n.end,i),n.start.date()>n.end.date()&&(i.setDate(i.getDate()+1),Vs(n.end,i)))}if(n.start.isOnlyWeekdayComponent()&&r>n.start.date()){let a=n.start.get("weekday")-r.getDay();if(a<=0&&(a+=7),r=Wt(r,{day:a}),Vs(n.start,r),e.debug(()=>{console.log(`${this.constructor.name} adjusted ${n} weekday (${n.start})`)}),n.end&&n.end.isOnlyWeekdayComponent()){let i=n.end.get("weekday")-r.getDay();i<=0&&(i+=7),r=Wt(r,{day:i}),Vs(n.end,r),e.debug(()=>{console.log(`${this.constructor.name} adjusted ${n} weekday (${n.end})`)})}}if(n.start.isDateWithUnknownYear()&&r>n.start.date())for(let a=0;a<3&&r>n.start.date();a++)n.start.imply("year",n.start.get("year")+1),e.debug(()=>{console.log(`${this.constructor.name} adjusted ${n} year (${n.start})`)}),n.end&&!n.end.isCertain("year")&&(n.end.imply("year",n.end.get("year")+1),e.debug(()=>{console.log(`${this.constructor.name} adjusted ${n} month (${n.start})`)}))}),t}}class tg extends nu{constructor(t){super();y(this,"strictMode");this.strictMode=t}isValid(t,n){return n.text.replace(" ","").match(/^\d*(\.\d*)?$/)?(t.debug(()=>{console.log(`Removing unlikely result '${n.text}'`)}),!1):n.start.isValidDate()?n.end&&!n.end.isValidDate()?(t.debug(()=>{console.log(`Removing invalid result: ${n} (${n.end})`)}),!1):this.strictMode?this.isStrictModeValid(t,n):!0:(t.debug(()=>{console.log(`Removing invalid result: ${n} (${n.start})`)}),!1)}isStrictModeValid(t,n){return n.start.isOnlyWeekdayComponent()?(t.debug(()=>{console.log(`(Strict) Removing weekday only component: ${n} (${n.end})`)}),!1):!0}}const ng=new RegExp("([0-9]{4})\\-([0-9]{1,2})\\-([0-9]{1,2})(?:T([0-9]{1,2}):([0-9]{1,2})(?::([0-9]{1,2})(?:\\.(\\d{1,4}))?)?(Z|([+-]\\d{2}):?(\\d{2})?)?)?(?=\\W|$)","i"),sg=1,rg=2,ag=3,cl=4,ig=5,ul=6,dl=7,og=8,hl=9,fl=10;class lg extends Vt{innerPattern(){return ng}innerExtract(e,t){const n=e.createParsingComponents({year:parseInt(t[sg]),month:parseInt(t[rg]),day:parseInt(t[ag])});if(t[cl]!=null&&(n.assign("hour",parseInt(t[cl])),n.assign("minute",parseInt(t[ig])),t[ul]!=null&&n.assign("second",parseInt(t[ul])),t[dl]!=null&&n.assign("millisecond",parseInt(t[dl])),t[og]!=null)){let r=0;if(t[hl]){const a=parseInt(t[hl]);let i=0;t[fl]!=null&&(i=parseInt(t[fl])),r=a*60,r<0?r-=i:r+=i}n.assign("timezoneOffset",r)}return n.addTag("parser/ISOFormatParser")}}class cg extends Hr{mergeResults(e,t,n){const r=n.clone();return r.index=t.index,r.text=t.text+e+r.text,r.start.assign("weekday",t.start.get("weekday")),r.end&&r.end.assign("weekday",t.start.get("weekday")),r}shouldMergeResults(e,t,n){return t.start.isOnlyWeekdayComponent()&&!t.start.isCertain("hour")&&n.start.isCertain("day")&&e.match(/^,?\s*$/)!=null}}function ug(s,e=!1){return s.parsers.unshift(new lg),s.refiners.unshift(new cg),s.refiners.unshift(new Jv),s.refiners.unshift(new Ti),s.refiners.push(new Kv),s.refiners.push(new Ti),s.refiners.push(new eg),s.refiners.push(new tg(e)),s}function dg(s){const e=s.getDateWithAdjustedTimezone(),t=new Xe(s,{});return Ls(t,e),Gc(t,e),t.assign("timezoneOffset",s.getTimezoneOffset()),t.addTag("casualReference/now"),t}function hg(s){const e=s.getDateWithAdjustedTimezone(),t=new Xe(s,{});return Ls(t,e),io(t,e),t.delete("meridiem"),t.addTag("casualReference/today"),t}function fg(s){return gg(s).addTag("casualReference/yesterday")}function vg(s){return oo(s,1).addTag("casualReference/tomorrow")}function gg(s,e){return oo(s,-1)}function oo(s,e){const t=s.getDateWithAdjustedTimezone(),n=new Xe(s,{}),r=new Date(t.getTime());return r.setDate(r.getDate()+e),Ls(n,r),io(n,r),n.delete("meridiem"),n}function pg(s,e=22){const t=s.getDateWithAdjustedTimezone(),n=new Xe(s,{});return Ls(n,t),n.imply("hour",e),n.imply("meridiem",je.PM),n.addTag("casualReference/tonight"),n}function mg(s,e=20){const t=new Xe(s,{});return t.imply("meridiem",je.PM),t.imply("hour",e),t.addTag("casualReference/evening"),t}function yg(s){const e=new Xe(s,{});return s.getDateWithAdjustedTimezone().getHours()>2&&e.addDurationAsImplied({day:1}),e.assign("hour",0),e.imply("minute",0),e.imply("second",0),e.imply("millisecond",0),e.addTag("casualReference/midnight"),e}function bg(s,e=6){const t=new Xe(s,{});return t.imply("meridiem",je.AM),t.imply("hour",e),t.imply("minute",0),t.imply("second",0),t.imply("millisecond",0),t.addTag("casualReference/morning"),t}function _g(s,e=15){const t=new Xe(s,{});return t.imply("meridiem",je.PM),t.imply("hour",e),t.imply("minute",0),t.imply("second",0),t.imply("millisecond",0),t.addTag("casualReference/afternoon"),t}function kg(s){const e=new Xe(s,{});return e.imply("meridiem",je.AM),e.assign("hour",12),e.imply("minute",0),e.imply("second",0),e.imply("millisecond",0),e.addTag("casualReference/noon"),e}const wg=/(now|today|tonight|tomorrow|overmorrow|tmr|tmrw|yesterday|last\s*night)(?=\W|$)/i;class Tg extends Vt{innerPattern(e){return wg}innerExtract(e,t){let n=e.refDate;const r=t[0].toLowerCase();let a=e.createParsingComponents();switch(r){case"now":a=dg(e.reference);break;case"today":a=hg(e.reference);break;case"yesterday":a=fg(e.reference);break;case"tomorrow":case"tmr":case"tmrw":a=vg(e.reference);break;case"tonight":a=pg(e.reference);break;case"overmorrow":a=oo(e.reference,2);break;default:if(r.match(/last\s*night/)){if(n.getHours()>6){const i=new Date(n.getTime());i.setDate(i.getDate()-1),n=i}Ls(a,n),a.imply("hour",0)}break}return a.addTag("parser/ENCasualDateParser"),a}}const Sg=/(?:this)?\s{0,3}(morning|afternoon|evening|night|midnight|midday|noon)(?=\W|$)/i;class Dg extends Vt{innerPattern(){return Sg}innerExtract(e,t){let n=null;switch(t[1].toLowerCase()){case"afternoon":n=_g(e.reference);break;case"evening":case"night":n=mg(e.reference);break;case"midnight":n=yg(e.reference);break;case"morning":n=bg(e.reference);break;case"noon":case"midday":n=kg(e.reference);break}return n&&n.addTag("parser/ENCasualTimeParser"),n}}function Eg(s,e,t){const n=s.getDateWithAdjustedTimezone(),r=xg(n,e,t);let a=new Xe(s);return a=a.addDurationAsImplied({day:r}),a.assign("weekday",e),a}function xg(s,e,t){const n=s.getDay();switch(t){case"this":return la(s,e);case"last":return su(s,e);case"next":return n==rt.SUNDAY?e==rt.SUNDAY?7:e:n==rt.SATURDAY?e==rt.SATURDAY?7:e==rt.SUNDAY?8:1+e:e<n&&e!=rt.SUNDAY?la(s,e):la(s,e)+7}return Ag(s,e)}function Ag(s,e){const t=su(s,e),n=la(s,e);return n<-t?n:t}function la(s,e){const t=s.getDay();let n=e-t;return n<0&&(n+=7),n}function su(s,e){const t=s.getDay();let n=e-t;return n>=0&&(n-=7),n}const Cg=new RegExp(`(?:(?:\\,|\\(|\\（)\\s*)?(?:on\\s*?)?(?:(this|last|past|next)\\s*)?(${Nn(_i)}|weekend|weekday)(?:\\s*(?:\\,|\\)|\\）))?(?:\\s*(this|last|past|next)\\s*week)?(?=\\W|$)`,"i"),Ig=1,Mg=2,Og=3;class Ng extends Vt{innerPattern(){return Cg}innerExtract(e,t){const n=t[Ig],r=t[Og];let a=n||r;a=a||"",a=a.toLowerCase();let i=null;a=="last"||a=="past"?i="last":a=="next"?i="next":a=="this"&&(i="this");const l=t[Mg].toLowerCase();let c;if(_i[l]!==void 0)c=_i[l];else if(l=="weekend")c=i=="last"?rt.SUNDAY:rt.SATURDAY;else if(l=="weekday"){const u=e.reference.getDateWithAdjustedTimezone().getDay();u==rt.SUNDAY||u==rt.SATURDAY?c=i=="last"?rt.FRIDAY:rt.MONDAY:(c=u-1,c=i=="last"?c-1:c+1,c=c%5+1)}else return null;return Eg(e.reference,c,i)}}const Rg=new RegExp(`(this|last|past|next|after\\s*this)\\s*(${Nn(Ra)})(?=\\s*)(?=\\W|$)`,"i"),Pg=1,qg=2;class Fg extends Vt{innerPattern(){return Rg}innerExtract(e,t){const n=t[Pg].toLowerCase(),r=t[qg].toLowerCase(),a=Ra[r];if(n=="next"||n.startsWith("after")){const c={};return c[a]=1,Xe.createRelativeFromReference(e.reference,c)}if(n=="last"||n=="past"){const c={};return c[a]=-1,Xe.createRelativeFromReference(e.reference,c)}const i=e.createParsingComponents();let l=new Date(e.reference.instant.getTime());return r.match(/week/i)?(l.setDate(l.getDate()-l.getDay()),i.imply("day",l.getDate()),i.imply("month",l.getMonth()+1),i.imply("year",l.getFullYear())):r.match(/month/i)?(l.setDate(1),i.imply("day",l.getDate()),i.assign("year",l.getFullYear()),i.assign("month",l.getMonth()+1)):r.match(/year/i)&&(l.setDate(1),l.setMonth(0),i.imply("day",l.getDate()),i.imply("month",l.getMonth()+1),i.assign("year",l.getFullYear())),i}}const Lg=new RegExp("([^\\d]|^)([0-3]{0,1}[0-9]{1})[\\/\\.\\-]([0-3]{0,1}[0-9]{1})(?:[\\/\\.\\-]([0-9]{4}|[0-9]{2}))?(\\W|$)","i"),Ug=1,zg=5,vl=2,gl=3,Xa=4;class Bg{constructor(e){y(this,"groupNumberMonth");y(this,"groupNumberDay");this.groupNumberMonth=e?gl:vl,this.groupNumberDay=e?vl:gl}pattern(){return Lg}extract(e,t){const n=t.index+t[Ug].length,r=t.index+t[0].length-t[zg].length;if(n>0&&e.text.substring(0,n).match("\\d/?$")||r<e.text.length&&e.text.substring(r).match("^/?\\d"))return;const a=e.text.substring(n,r);if(a.match(/^\d\.\d$/)||a.match(/^\d\.\d{1,2}\.\d{1,2}\s*$/)||!t[Xa]&&a.indexOf("/")<0)return;const i=e.createParsingResult(n,a);let l=parseInt(t[this.groupNumberMonth]),c=parseInt(t[this.groupNumberDay]);if((l<1||l>12)&&l>12)if(c>=1&&c<=12&&l<=31)[c,l]=[l,c];else return null;if(c<1||c>31)return null;if(i.start.assign("day",c),i.start.assign("month",l),t[Xa]){const u=parseInt(t[Xa]),h=Qc(u);i.start.assign("year",h)}else{const u=Na(e.refDate,c,l);i.start.imply("year",u)}return i.addTag("parser/SlashDateFormatParser")}}const Yg=new RegExp(`(this|last|past|next|after|\\+|-)\\s*(${jr})(?=\\W|$)`,"i"),jg=new RegExp(`(this|last|past|next|after|\\+|-)\\s*(${Fa})(?=\\W|$)`,"i");class Hg extends Vt{constructor(t=!0){super();y(this,"allowAbbreviations");this.allowAbbreviations=t}innerPattern(){return this.allowAbbreviations?Yg:jg}innerExtract(t,n){const r=n[1].toLowerCase();let a=_r(n[2]);if(!a)return null;switch(r){case"last":case"past":case"-":a=Oa(a);break}return Xe.createRelativeFromReference(t.reference,a)}}function $g(s){return s.text.match(/^[+-]/i)!=null}function pl(s){return s.text.match(/^-/i)!=null}class Wg extends Hr{shouldMergeResults(e,t,n){return e.match(/^\s*$/i)?$g(n)||pl(n):!1}mergeResults(e,t,n,r){let a=_r(n.text);pl(n)&&(a=Oa(a));const i=Xe.createRelativeFromReference(Ns.fromDate(t.start.date()),a);return new br(t.reference,t.index,`${t.text}${e}${n.text}`,i)}}function ml(s){return s.text.match(/\s+(before|from)$/i)!=null}function Gg(s){return s.text.match(/\s+(after|since)$/i)!=null}class Kg extends Hr{patternBetween(){return/^\s*$/i}shouldMergeResults(e,t,n){return!e.match(this.patternBetween())||!ml(t)&&!Gg(t)?!1:!!n.start.get("day")&&!!n.start.get("month")&&!!n.start.get("year")}mergeResults(e,t,n){let r=_r(t.text);ml(t)&&(r=Oa(r));const a=Xe.createRelativeFromReference(Ns.fromDate(n.start.date()),r);return new br(n.reference,t.index,`${t.text}${e}${n.text}`,a)}}const Vg=new RegExp(`^\\s*(${Pa})`,"i"),Qg=1;class Zg{refine(e,t){return t.forEach(function(n){if(!n.start.isDateWithUnknownYear())return;const r=e.text.substring(n.index+n.text.length),a=Vg.exec(r);if(!a||a[0].trim().length<=3)return;e.debug(()=>{console.log(`Extracting year: '${a[0]}' into : ${n}`)});const i=qa(a[Qg]);n.end!=null&&n.end.assign("year",i),n.start.assign("year",i),n.text+=a[0]}),t}}class Xg extends nu{constructor(){super()}isValid(e,t){const n=t.text.trim();return n===e.text.trim()?!0:n.toLowerCase()==="may"&&!e.text.substring(0,t.index).trim().match(/\b(in)$/i)?(e.debug(()=>{console.log(`Removing unlikely result: ${t}`)}),!1):n.toLowerCase().endsWith("the second")?(e.text.substring(t.index+t.text.length).trim().length>0&&e.debug(()=>{console.log(`Removing unlikely result: ${t}`)}),!1):!0}}class ru{createCasualConfiguration(e=!1){const t=this.createConfiguration(!1,e);return t.parsers.push(new Tg),t.parsers.push(new Dg),t.parsers.push(new Tv),t.parsers.push(new Fg),t.parsers.push(new Hg),t.refiners.push(new Xg),t}createConfiguration(e=!0,t=!1){const n=ug({parsers:[new Bg(t),new fv(e),new pv,new bv(t),new Ng,new Ov,new qv(e),new Uv(e),new jv(e)],refiners:[new ll]},e);return n.parsers.unshift(new Av(e)),n.refiners.unshift(new Kg),n.refiners.unshift(new Wg),n.refiners.unshift(new Ti),n.refiners.push(new ll),n.refiners.push(new Zg),n.refiners.push(new $v),n}}class fr{constructor(e){y(this,"parsers");y(this,"refiners");y(this,"defaultConfig",new ru);e=e||this.defaultConfig.createCasualConfiguration(),this.parsers=[...e.parsers],this.refiners=[...e.refiners]}clone(){return new fr({parsers:[...this.parsers],refiners:[...this.refiners]})}parseDate(e,t,n){const r=this.parse(e,t,n);return r.length>0?r[0].start.date():null}parse(e,t,n){const r=new Jg(e,t,n);let a=[];return this.parsers.forEach(i=>{const l=fr.executeParser(r,i);a=a.concat(l)}),a.sort((i,l)=>i.index-l.index),this.refiners.forEach(function(i){a=i.refine(r,a)}),a}static executeParser(e,t){const n=[],r=t.pattern(e),a=e.text;let i=e.text,l=r.exec(i);for(;l;){const c=l.index+a.length-i.length;l.index=c;const u=t.extract(e,l);if(!u){i=a.substring(l.index+1),l=r.exec(i);continue}let h=null;u instanceof br?h=u:u instanceof Xe?(h=e.createParsingResult(l.index,l[0]),h.start=u):h=e.createParsingResult(l.index,l[0],u);const v=h.index,p=h.text;e.debug(()=>console.log(`${t.constructor.name} extracted (at index=${v}) '${p}'`)),n.push(h),i=a.substring(v+p.length),l=r.exec(i)}return n}}class Jg{constructor(e,t,n){y(this,"text");y(this,"option");y(this,"reference");y(this,"refDate");this.text=e,this.option=n??{},this.reference=Ns.fromInput(t,this.option.timezones),this.refDate=this.reference.instant}createParsingComponents(e){return e instanceof Xe?e:new Xe(this.reference,e)}createParsingResult(e,t,n,r){const a=typeof t=="string"?t:this.text.substring(e,t),i=n?this.createParsingComponents(n):null,l=r?this.createParsingComponents(r):null;return new br(this.reference,e,a,i,l)}debug(e){this.option.debug&&(this.option.debug instanceof Function?this.option.debug(e):this.option.debug.debug(e))}}const lo=new ru,ep=new fr(lo.createCasualConfiguration(!1));new fr(lo.createConfiguration(!0,!1));new fr(lo.createCasualConfiguration(!0));const tp=ep;function sa(s,e,t){return tp.parseDate(s,e,t)}function np(){return Intl.DateTimeFormat().resolvedOptions().timeZone}class dn{static parse(e,t=new Date){const n=e.trim(),r=e;if(!n)return{date:null,isValid:!1,error:"Empty date string",original:r};if(n.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const k=new Date(n);if(!isNaN(k.getTime()))return{date:k,isValid:!0,original:r}}try{const k=sa(n,t);if(k){const _=new Date(k);return _.setHours(0,0,0,0),{date:_,isValid:!0,original:r}}}catch{}const i=new Date(t);i.setHours(0,0,0,0);const l=n.toLowerCase();if(l==="today")return{date:i,isValid:!0,original:r};if(l==="tomorrow"){const k=new Date(i);return k.setDate(k.getDate()+1),{date:k,isValid:!0,original:r}}if(l==="yesterday"){const k=new Date(i);return k.setDate(k.getDate()-1),{date:k,isValid:!0,original:r}}const c=l.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(c){const k=parseInt(c[1]),_=c[2],g=new Date(i);return _.startsWith("day")?g.setDate(g.getDate()+k):_.startsWith("week")?g.setDate(g.getDate()+k*7):_.startsWith("month")&&g.setMonth(g.getMonth()+k),{date:g,isValid:!0,original:r}}const u=l.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(u){const k=parseInt(u[1]),_=u[2],g=new Date(i);return _.startsWith("day")?g.setDate(g.getDate()-k):_.startsWith("week")?g.setDate(g.getDate()-k*7):_.startsWith("month")&&g.setMonth(g.getMonth()-k),{date:g,isValid:!0,original:r}}const h=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],v=l.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(v){const k=v[1],_=h.indexOf(v[2]),g=i.getDay();let w=_-g;k==="next"?w<=0&&(w+=7):w>=0&&(w-=7);const S=new Date(i);return S.setDate(S.getDate()+w),{date:S,isValid:!0,original:r}}const p=l.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(p){const k=h.indexOf(p[1]),_=i.getDay();let g=k-_;g<0&&(g+=7);const w=new Date(i);return w.setDate(w.getDate()+g),{date:w,isValid:!0,original:r}}const m=l.match(/^(this|next|last)\s+(week|month)$/);if(m){const k=m[1],_=m[2],g=new Date(i);if(_==="week"){const w=g.getDay(),S=w===0?-6:1-w;g.setDate(g.getDate()+S),k==="next"?g.setDate(g.getDate()+7):k==="last"&&g.setDate(g.getDate()-7)}else _==="month"&&(g.setDate(1),k==="next"?g.setMonth(g.getMonth()+1):k==="last"&&g.setMonth(g.getMonth()-1));return{date:g,isValid:!0,original:r}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:r}}static toISODateString(e){return e.toISOString().split("T")[0]}static parseNaturalLanguageDate(e,t=new Date){const n=e.trim();if(!n)return null;const r=dn.handleShortcuts(n,t);if(r)return r;try{const i=sa(n,t,{forwardDate:!0});if(i)return i}catch{}return dn.parse(n,t).date}static parseToISO(e,t=new Date){const n=dn.parseNaturalLanguageDate(e,t);return n?n.toISOString():null}static isDateExpression(e){const t=e.trim().toLowerCase();if(!t)return!1;if(["today","tomorrow","yesterday","monday","tuesday","wednesday","thursday","friday","saturday","sunday","next","last","this","week","month","year","day","days","ago","eod","eow","eom","in ","at "].some(r=>t.includes(r)))return!0;try{return sa(t,new Date)!==null}catch{return!1}}static getDateSuggestions(e,t=new Date){const n=[],r=e.trim().toLowerCase(),a=new Date(t);a.setHours(0,0,0,0);const i=[{text:"Today",offset:0,icon:"📅"},{text:"Tomorrow",offset:1,icon:"➡️"},{text:"In 2 days",offset:2,icon:"📆"},{text:"In 3 days",offset:3,icon:"📆"},{text:"In 1 week",offset:7,icon:"📆"},{text:"In 2 weeks",offset:14,icon:"📆"}];for(const u of i)if(!r||u.text.toLowerCase().includes(r)){const h=us(a,u.offset);n.push({text:u.text,value:h.toISOString(),description:dn.formatDateForDisplay(h,!1),category:"relative",icon:u.icon})}const l=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];for(let u=0;u<l.length;u++){const h=l[u];if(!r||h.toLowerCase().includes(r)||`next ${h}`.toLowerCase().includes(r)){const v=a.getDay();let k=(u+1)%7-v;k<=0&&(k+=7);const _=us(a,k);n.push({text:h,value:_.toISOString(),description:dn.formatDateForDisplay(_,!1),category:"named",icon:"📅"})}}const c=[{text:"EOD (end of day)",keyword:"eod",icon:"🌆"},{text:"EOW (end of week)",keyword:"eow",icon:"🏁"},{text:"EOM (end of month)",keyword:"eom",icon:"📊"}];for(const u of c)if(!r||u.text.toLowerCase().includes(r)||u.keyword.includes(r)){const h=dn.handleShortcuts(u.keyword,t);h&&n.push({text:u.text,value:h.toISOString(),description:dn.formatDateForDisplay(h,!0),category:"shortcut",icon:u.icon})}if(!r||"next month".includes(r)){const u=new Date(a);u.setMonth(u.getMonth()+1),n.push({text:"Next month",value:u.toISOString(),description:dn.formatDateForDisplay(u,!1),category:"relative",icon:"📆"})}return n.slice(0,8)}static formatDateForDisplay(e,t=!1){const n={weekday:"short",year:"numeric",month:"short",day:"numeric"};return t&&(n.hour="2-digit",n.minute="2-digit"),e.toLocaleString(void 0,n)}static parseTime(e){const t=e.trim().toLowerCase(),n=t.match(/^(\d{1,2}):(\d{2})$/);if(n){const a=parseInt(n[1]),i=parseInt(n[2]);if(a>=0&&a<24&&i>=0&&i<60)return{hours:a,minutes:i}}const r=t.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)$/);if(r){let a=parseInt(r[1]);const i=r[2]?parseInt(r[2]):0,l=r[3];if(l==="pm"&&a!==12?a+=12:l==="am"&&a===12&&(a=0),a>=0&&a<24&&i>=0&&i<60)return{hours:a,minutes:i}}try{const a=sa(t,new Date);if(a)return{hours:a.getHours(),minutes:a.getMinutes()}}catch{}return null}static handleShortcuts(e,t){const n=e.trim().toLowerCase(),r=new Date(t);switch(r.setHours(0,0,0,0),n){case"eod":return Ka(r,17,0);case"eow":{const a=r.getDay(),i=a<=5?5-a:7-a+5,l=us(r,i);return Ka(l,17,0)}case"eom":{const a=new Date(r.getFullYear(),r.getMonth()+1,0);return Ka(a,17,0)}default:return null}}}class ds{constructor(){y(this,"input","");y(this,"position",0);y(this,"line",1);y(this,"column",1);y(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const n={filters:[]},r=this.input.split(`
`).map(a=>a.trim()).filter(a=>a.length>0);for(let a=0;a<r.length;a++){this.line=a+1,this.column=1;const i=r[a];if(i.startsWith("sort by "))n.sort=this.parseSortInstruction(i);else if(i.startsWith("group by "))n.group=this.parseGroupInstruction(i);else if(i.startsWith("limit ")||i.startsWith("limit to "))n.limit=this.parseLimitInstruction(i);else if(/^explain$/i.test(i))n.explain=!0;else{const l=this.parseFilterInstruction(i);l&&n.filters.push(l)}}return n}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Ht?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(e.match(/^(due|scheduled|start|created|done|cancelled)\s+between\s+/i)){const r=this.parseDateFilter(e);if(r)return r}if(/\s+(and|AND)\s+/i.test(e))return this.parseAndFilter(e);if(/\s+(or|OR)\s+/i.test(e))return this.parseOrFilter(e);if(/^(not|NOT)\s+/i.test(e))return this.parseNotFilter(e);if(e.startsWith("status.type is ")){const r=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(r)}}if(e.startsWith("status.name includes ")){const r=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(r)}}if(e.startsWith("status.symbol is ")){const r=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(r)}}const n=this.parseDateFilter(e);if(n)return n;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("urgency is ")){const r=e.substring(11).trim();return{type:"urgency",operator:"is",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("urgency above ")){const r=e.substring(14).trim();return{type:"urgency",operator:"above",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("urgency below ")){const r=e.substring(14).trim();return{type:"urgency",operator:"below",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("tag includes ")){const r=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(r)}}if(e.startsWith("tag does not include ")){const r=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(r),negate:!0}}if(e.startsWith("tags include ")){const r=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(r)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const r=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(r)}}if(e.startsWith("path does not include ")){const r=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(r),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};if(e.startsWith("description includes ")){const r=e.substring(21).trim();return{type:"description",operator:"includes",value:this.unquote(r)}}if(e.startsWith("description does not include ")){const r=e.substring(29).trim();return{type:"description",operator:"does not include",value:this.unquote(r)}}if(e.startsWith("description regex ")){const r=e.substring(18).trim();return{type:"description",operator:"regex",value:this.unquote(r)}}if(e.startsWith("heading includes ")){const r=e.substring(17).trim();return{type:"heading",operator:"includes",value:this.unquote(r)}}if(e.startsWith("heading does not include ")){const r=e.substring(25).trim();return{type:"heading",operator:"does not include",value:this.unquote(r)}}throw new Ht(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const n of t){if(e===`has ${n} date`)return{type:"date",operator:"has",value:{field:n}};if(e===`no ${n} date`)return{type:"date",operator:"has",value:{field:n},negate:!0};const r=e.match(new RegExp(`^${n}\\s+between\\s+(.+?)\\s+and\\s+(.+)$`,"i"));if(r){const i=r[1].trim(),l=r[2].trim(),c=dn.parse(i,this.referenceDate),u=dn.parse(l,this.referenceDate);if(!c.isValid||!c.date)throw new Ht(`Invalid start date: "${i}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');if(!u.isValid||!u.date)throw new Ht(`Invalid end date: "${l}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:"between",value:{field:n,date:c.date,endDate:u.date}}}const a=["before","after","on","on or before","on or after"];for(const i of a){const l=`${n} ${i} `;if(e.startsWith(l)){const c=e.substring(l.length).trim(),u=dn.parse(c,this.referenceDate);if(!u.isValid||!u.date)throw new Ht(`Invalid date value: "${c}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:i,value:{field:n,date:u.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Ht(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Ht(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Ht(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return vt.TODO;case"IN_PROGRESS":return vt.IN_PROGRESS;case"DONE":return vt.DONE;case"CANCELLED":return vt.CANCELLED;case"NON_TASK":return vt.NON_TASK;default:throw new Ht(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}parseNumericValue(e,t){const n=Number(e);if(Number.isNaN(n))throw new Ht(`Invalid ${t} value: "${e}"`,this.line,this.column,`Use a numeric ${t} value (e.g., "${t} above 75")`);return n}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}parseAndFilter(e){const n=e.split(/\s+(and|AND)\s+/i).filter((a,i)=>i%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(n.length===0)throw new Ht("Empty AND expression",this.line,this.column,"AND must have filters on both sides");if(n.length===1)return n[0];let r=n[0];for(let a=1;a<n.length;a++)r={type:"boolean",operator:"AND",value:null,left:r,right:n[a]};return r}parseOrFilter(e){const n=e.split(/\s+(or|OR)\s+/i).filter((a,i)=>i%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(n.length===0)throw new Ht("Empty OR expression",this.line,this.column,"OR must have filters on both sides");if(n.length===1)return n[0];let r=n[0];for(let a=1;a<n.length;a++)r={type:"boolean",operator:"OR",value:null,left:r,right:n[a]};return r}parseNotFilter(e){const t=e.replace(/^NOT\s+/i,"").trim();if(!t)throw new Ht("Empty NOT expression",this.line,this.column,"NOT must have a filter after it");const n=this.parseFilterInstruction(t);if(!n)throw new Ht("Invalid filter after NOT",this.line,this.column,"NOT must be followed by a valid filter");return{type:"boolean",operator:"NOT",value:null,inner:n}}}class yt{}const ys=class ys{constructor(){y(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return ys.instance||(ys.instance=new ys),ys.instance}addDefaultStatuses(){this.add(Fn.TODO),this.add(Fn.IN_PROGRESS),this.add(Fn.DONE),this.add(Fn.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new Fn({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:Fn.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};y(ys,"instance",null);let Sn=ys;class sp extends yt{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=Sn.getInstance(),n=e.statusSymbol||" ",a=t.get(n).type===this.statusType;return this.negate?!a:a}}class rp extends yt{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=Sn.getInstance(),n=e.statusSymbol||" ",a=t.get(n).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!a:a}}class ap extends yt{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const n=(e.statusSymbol||" ")===this.symbol;return this.negate?!n:n}}class ip extends yt{matches(e){const t=Sn.getInstance(),n=e.statusSymbol||" ";return t.get(n).type===vt.DONE}}class op extends yt{matches(e){const t=Sn.getInstance(),n=e.statusSymbol||" ";return t.get(n).type!==vt.DONE}}class yl extends yt{constructor(e,t,n,r){super(),this.field=e,this.comparator=t,this.targetDate=n,this.endDate=r}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const n=new Date(this.targetDate);n.setHours(0,0,0,0);const r=new Date(t);switch(r.setHours(0,0,0,0),this.comparator){case"before":return r<n;case"after":return r>n;case"on":return r.getTime()===n.getTime();case"on or before":return r<=n;case"on or after":return r>=n;case"between":if(!this.endDate)return!1;const a=new Date(this.endDate);return a.setHours(0,0,0,0),r>=n&&r<=a;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class lp extends yt{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const bl={lowest:0,low:1,normal:2,medium:3,high:4,highest:5};function cp(s){return hr(s)??"normal"}function up(s){return s==="urgent"?"highest":s==="none"?"normal":s}class dp extends yt{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=cp(e.priority),n=bl[t],r=bl[up(this.level)];switch(this.operator){case"is":return n===r;case"above":return n>r;case"below":return n<r;default:return!1}}}class hp extends yt{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],n=this.tag.toLowerCase(),r=t.some(a=>a.toLowerCase().includes(n));return this.negate?!r:r}}class fp extends yt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class vp extends yt{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const n=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!n:n}}class gp extends yt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const n=e.blockedBy&&e.blockedBy.length>0;return this.negate?!n:!!n}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class pp extends yt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class mp extends yt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class yp extends yt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class bp extends yt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class _p extends yt{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class kp extends yt{constructor(e,t,n=!1){super(),this.operator=e,this.pattern=t,this.caseSensitive=n}matches(e){const t=e.name||"",n=e.description||"",r=`${t} ${n}`.trim();switch(this.operator){case"includes":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return(this.caseSensitive?r:r.toLowerCase()).includes(a)}case"does not include":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return!(this.caseSensitive?r:r.toLowerCase()).includes(a)}case"regex":try{const a=this.caseSensitive?"":"i";return new RegExp(this.pattern,a).test(r)}catch{return!1}}}}class wp extends yt{constructor(e,t){super(),this.operator=e,this.pattern=t}matches(e){const n=(e.heading||"").toLowerCase().includes(this.pattern.toLowerCase());return this.operator==="includes"?n:!n}}class Tp extends yt{constructor(e,t,n,r){super(),this.comparator=e,this.threshold=t,this.referenceDate=n,this.settings=r}matches(e){const t=no(e,{now:this.referenceDate,settings:this.settings});switch(this.comparator){case"above":return t>this.threshold;case"below":return t<this.threshold;case"is":return t===this.threshold;default:return!1}}}class gs{group(e){const t=new Map;for(const n of e){const r=this.getGroupKey(n);this.addToGroup(t,r,n)}return t}addToGroup(e,t,n){e.has(t)||e.set(t,[]),e.get(t).push(n)}}class Sp extends gs{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const n=new Date(e.dueAt);n.setHours(0,0,0,0);const r=n.getTime()-t.getTime(),a=Math.ceil(r/(1e3*60*60*24));return a<0?"Overdue":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Dp extends gs{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const n=new Date(e.scheduledAt);n.setHours(0,0,0,0);const r=n.getTime()-t.getTime(),a=Math.ceil(r/(1e3*60*60*24));return a<0?"Past":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Ep extends gs{getGroupKey(e){const t=Sn.getInstance(),n=e.statusSymbol||" ";return t.get(n).type}}class xp extends gs{getGroupKey(e){const t=Sn.getInstance(),n=e.statusSymbol||" ";return t.get(n).name}}class Ap extends gs{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class Cp extends gs{getGroupKey(e){return e.path||""||"No path"}}class Ip extends gs{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const n=t.lastIndexOf("/");return n===-1?"Root":t.substring(0,n)||"Root"}}class Mp extends gs{group(e){const t=new Map;for(const n of e){const r=n.tags||[];if(r.length===0)this.addToGroup(t,"No tags",n);else for(const a of r)this.addToGroup(t,a,n)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}function au(s){const e=[];if(s.filters.length>0){e.push("**Filters:**");for(const t of s.filters)e.push(`- ${Qs(t)}`)}else e.push("**Filters:** None (showing all tasks)");if(s.sort){const t=s.sort.reverse?"descending":"ascending";e.push(`
**Sort:** By ${s.sort.field} (${t})`)}return s.group&&e.push(`
**Group:** By ${s.group.field}`),s.limit!==void 0&&s.limit>0&&e.push(`
**Limit:** First ${s.limit} tasks`),e.join(`
`)}function Qs(s){const e=s.negate?"NOT ":"";switch(s.type){case"status":return`${e}Status ${s.operator} "${s.value}"`;case"date":return`${e}${s.value.field} ${s.value.comparator} ${s.value.date}`;case"priority":return`${e}Priority ${s.operator} ${s.value}`;case"urgency":return`${e}Urgency ${s.operator} ${s.value}`;case"tag":return s.operator==="includes"?`${e}Tag includes "${s.value}"`:s.operator==="has"?`${e}Has tags`:`${e}Tag ${s.operator} "${s.value}"`;case"path":return`${e}Path ${s.operator} "${s.value}"`;case"dependency":return s.value==="blocked"?`${e}Is blocked by another task`:s.value==="blocking"?`${e}Is blocking another task`:`${e}Dependency ${s.operator} ${s.value}`;case"recurrence":return`${e}Recurrence ${s.operator} ${s.value}`;case"boolean":return s.operator==="and"?`(${Qs(s.left)} AND ${Qs(s.right)})`:s.operator==="or"?`(${Qs(s.left)} OR ${Qs(s.right)})`:s.operator==="not"?`(NOT ${Qs(s.inner)})`:"Unknown boolean filter";case"done":return s.value?`${e}Done`:`${e}Not done`;case"description":return`${e}Description ${s.operator} "${s.value}"`;default:return`${e}Unknown filter`}}class iu{constructor(e,t={}){y(this,"dependencyGraph",null);y(this,"globalFilterAST",null);y(this,"urgencySettings");this.taskIndex=e,this.urgencySettings=t.urgencySettings??to}setDependencyGraph(e){this.dependencyGraph=e}setGlobalFilter(e){if(!e){this.globalFilterAST=null;return}try{const t=new ds;this.globalFilterAST=t.parse(e)}catch(t){console.error("Failed to parse global filter:",t),this.globalFilterAST=null}}execute(e){const t=performance.now(),n=new Date;try{const r=e.explain?this.generateExplanation(e):void 0;let a=this.taskIndex.getAllTasks();const i=a.length;this.globalFilterAST&&this.globalFilterAST.filters.length>0&&(a=this.applyFilters(a,this.globalFilterAST.filters,n)),e.filters.length>0&&(a=this.applyFilters(a,e.filters,n)),e.sort&&(a=this.applySort(a,e.sort,n)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let l;e.group&&(l=this.applyGrouping(a,e.group));const u=performance.now()-t;return{tasks:a,groups:l,totalCount:i,executionTimeMs:u,explanation:r}}catch(r){throw new Ws(`Failed to execute query: ${r instanceof Error?r.message:String(r)}`,r instanceof Error?r:void 0)}}executeString(e){const n=new ds().parse(e);return this.execute(n)}validateQuery(e){try{return{valid:!0,parsedFilters:new ds().parse(e).filters.map(r=>`${r.type}:${r.operator}`)}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}applyFilters(e,t,n){let r=e;for(const a of t){const i=this.createFilter(a,n);r=r.filter(l=>i.matches(l))}return r}createFilter(e,t){switch(e.type){case"done":return e.value?new ip:new op;case"status":if(e.operator==="type-is")return new sp(e.value,e.negate);if(e.operator==="name-includes")return new rp(e.value,e.negate);if(e.operator==="symbol-is")return new ap(e.value,e.negate);throw new Ws(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new lp(e.value.field,e.negate):e.operator==="between"?new yl(e.value.field,e.operator,e.value.date,e.value.endDate):new yl(e.value.field,e.operator,e.value.date);case"priority":return new dp(e.operator,e.value);case"urgency":return new Tp(e.operator,e.value,t,this.urgencySettings);case"tag":return e.operator==="has"?new fp(!e.value):new hp(e.value,e.negate);case"path":return new vp(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new gp(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new pp(this.dependencyGraph,!e.value);throw new Ws(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new mp(!e.value);case"description":return new kp(e.operator,e.value,e.negate);case"heading":return new wp(e.operator,e.value);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new yp(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="OR"&&e.left&&e.right)return new bp(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="NOT"&&e.inner)return new _p(this.createFilter(e.inner,t));throw new Ws(`Invalid boolean operator: ${e.operator}`);default:throw new Ws(`Unknown filter type: ${e.type}`)}}applySort(e,t,n){const r=[...e];return r.sort((a,i)=>{let l=0;switch(t.field){case"due":l=this.compareDates(a.dueAt,i.dueAt);break;case"scheduled":l=this.compareDates(a.scheduledAt,i.scheduledAt);break;case"start":l=this.compareDates(a.startAt,i.startAt);break;case"created":l=this.compareDates(a.createdAt,i.createdAt);break;case"done":l=this.compareDates(a.doneAt,i.doneAt);break;case"priority":l=this.comparePriorities(a.priority,i.priority);break;case"urgency":l=this.getUrgencyScore(i,n)-this.getUrgencyScore(a,n);break;case"status.type":l=this.compareStatusTypes(a,i);break;case"description":l=(a.description||"").localeCompare(i.description||"");break;case"heading":l=(a.heading||"").localeCompare(i.heading||"");break;case"path":l=(a.path||"").localeCompare(i.path||"");break;default:l=a.name.localeCompare(i.name)}return t.reverse?-l:l}),r}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const n={lowest:0,low:1,normal:2,medium:3,high:4,highest:5},r=n[hr(e)||"normal"]||2,a=n[hr(t)||"normal"]||2;return r-a}compareStatusTypes(e,t){const n=r=>{const a=r.statusSymbol||" ";return a===" "?0:a==="/"?1:a==="x"?2:a==="-"?3:0};return n(e)-n(t)}getUrgencyScore(e,t){return no(e,{now:t,settings:this.urgencySettings})}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new Sp;case"scheduled":return new Dp;case"status.type":return new Ep;case"status.name":return new xp;case"priority":return new Ap;case"path":return new Cp;case"folder":return new Ip;case"tags":return new Mp;default:throw new Ws(`Unknown grouping field: ${e}`)}}generateExplanation(e){return au(e)}}class ou{constructor(e){y(this,"parser");this.parser=e??new ds}compose(e,t){const{query:n,ignoreGlobal:r}=this.stripIgnoreDirective(e),a=this.parser.parse(n);return!r&&t&&t.filters.length>0?{ast:{...a,filters:[...t.filters,...a.filters]},ignoredGlobal:!1}:{ast:a,ignoredGlobal:r}}stripIgnoreDirective(e){const t=e.split(`
`),n=[];let r=!1;for(const a of t){if(/^ignore global query$/i.test(a.trim())){r=!0;continue}n.push(a)}return{query:n.join(`
`),ignoreGlobal:r}}}const pa={enabled:!1,query:""},bs=class bs{constructor(e=pa){y(this,"config");y(this,"ast",null);y(this,"error",null);this.config=e,this.parse()}static getInstance(){return bs.instance||(bs.instance=new bs),bs.instance}initialize(e){this.config=e,this.parse()}updateConfig(e){this.config=e,this.parse()}getConfig(){return this.config}isEnabled(){return this.config.enabled&&this.config.query.trim().length>0}getAST(){return this.ast}getError(){return this.error}parse(){if(!this.isEnabled()){this.ast=null,this.error=null;return}try{const e=new ds;this.ast=e.parse(this.config.query),this.error=null}catch(e){this.ast=null,this.error=e instanceof Error?e.message:String(e)}}};y(bs,"instance",null);let vr=bs;var Op=A('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Np=A('<div class="search-tab__error svelte-1yjlv38"> </div>'),Rp=A('<div class="search-tab__stats svelte-1yjlv38"> </div>'),Pp=A('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),qp=A('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),Fp=A('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),Lp=A('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">🔍 No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),Up=A('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),zp=A(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function Bp(s,e){ot(e,!0);let t=G(""),n=G(De([])),r=G(""),a=G(0),i=G(De([])),l=G(!1),c=G(!1);const u=["not done","priority is high","due before tomorrow","not done AND priority above medium","is blocked","description includes meeting","tag includes #work","is recurring","priority is high OR priority is medium","NOT is blocked","not done AND priority is high AND description includes priority","sort by priority","sort by urgency","urgency above 80","group by priority"],h={getAllTasks:()=>e.tasks},v=Xl(ro),p=new iu(h,{urgencySettings:v}),m=new ou(new ds);function k(){if(!o(t).trim()){b(n,[],!0),b(r,"");return}b(c,!0),b(r,"");try{const U=vr.getInstance();if(U.isEnabled()&&U.getError())throw new Error(`Global query error: ${U.getError()}`);const D=m.compose(o(t),U.getAST()).ast,q=p.execute(D);if(b(n,q.tasks,!0),b(a,q.executionTimeMs,!0),!o(i).includes(o(t))){b(i,[o(t),...o(i)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(o(i)))}catch{}}}catch(U){b(r,U instanceof Error?U.message:String(U),!0),b(n,[],!0),K.error(`Query error: ${o(r)}`)}finally{b(c,!1)}}function _(){try{const U=localStorage.getItem("query-history");U&&b(i,JSON.parse(U),!0)}catch{}}function g(U){b(t,U,!0),k()}function w(U){b(t,U,!0),b(l,!1),k()}function S(){b(i,[],!0);try{localStorage.removeItem("query-history")}catch{}b(l,!1)}function E(U){U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),k())}wt(()=>{_()});let x=G(0),O=De([]);wt(()=>{o(x)>=o(n).length&&b(x,Math.max(0,o(n).length-1),!0)});function L(U,D){U.key==="ArrowDown"?(U.preventDefault(),b(x,Math.min(o(x)+1,o(n).length-1),!0)):U.key==="ArrowUp"?(U.preventDefault(),b(x,Math.max(o(x)-1,0),!0)):U.key==="Enter"&&e.onEdit?(U.preventDefault(),e.onEdit(o(n)[D])):U.key===" "&&e.onDone&&(U.preventDefault(),e.onDone(o(n)[D]))}var R=zp(),W=f(d(R),2),j=d(W),J=d(j);J.__keydown=E;var re=f(J,2),te=d(re);te.__click=k;var oe=d(te),ge=f(te,2);{var $=U=>{var D=Op();D.__click=()=>b(l,!o(l));var q=d(D);Y(()=>M(q,`History (${o(i).length??""})`)),T(U,D)};H(ge,U=>{o(i).length>0&&U($)})}var F=f(j,2);{var C=U=>{var D=Np(),q=d(D);Y(()=>M(q,`⚠️ ${o(r)??""}`)),T(U,D)};H(F,U=>{o(r)&&U(C)})}var B=f(F,2);{var se=U=>{var D=Rp(),q=d(D);Y(Q=>M(q,`Found ${o(n).length??""} task${o(n).length!==1?"s":""} in ${Q??""}ms`),[()=>o(a).toFixed(2)]),T(U,D)};H(B,U=>{o(a)>0&&!o(r)&&U(se)})}var ee=f(W,2);{var pe=U=>{var D=qp(),q=d(D),Q=f(d(q),2);Q.__click=S;var ae=f(q,2);Fe(ae,21,()=>o(i),it,(I,P)=>{var Z=Pp(),fe=d(Z);fe.__click=()=>w(o(P));var me=d(fe);Y(()=>M(me,o(P))),T(I,Z)}),T(U,D)};H(ee,U=>{o(l)&&o(i).length>0&&U(pe)})}var de=f(ee,2),ue=f(d(de),2);Fe(ue,21,()=>u,it,(U,D)=>{var q=Fp();q.__click=()=>g(o(D));var Q=d(q),ae=d(Q);Y(()=>M(ae,o(D))),T(U,q)});var Ee=f(de,2),_e=d(Ee);{var Pe=U=>{var D=Lp();T(U,D)},le=U=>{var D=ht(),q=Ve(D);{var Q=ae=>{var I=ht(),P=Ve(I);Fe(P,19,()=>o(n),Z=>Z.id,(Z,fe,me)=>{var ye=Up();ye.__keydown=Ae=>L(Ae,o(me));var xe=d(ye);yr(xe,{get task(){return o(fe)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Tn(ye,(Ae,$e)=>O[$e]=Ae,Ae=>O==null?void 0:O[Ae],()=>[o(me)]),Y(()=>Me(ye,"tabindex",o(me)===o(x)?0:-1)),Ot("focus",ye,()=>b(x,o(me),!0)),T(Z,ye)}),T(ae,I)};H(q,ae=>{o(n).length>0&&ae(Q)},!0)}T(U,D)};H(_e,U=>{o(n).length===0&&o(t).trim()&&!o(r)?U(Pe):U(le,!1)})}Y(()=>{te.disabled=o(c),M(oe,o(c)?"Searching...":"Search")}),gt(J,()=>o(t),U=>b(t,U)),T(s,R),lt()}mt(["keydown","click"]);class Yp{analyzeCompletionPatterns(e){if(!e.completionHistory||e.completionHistory.length===0)return this.getDefaultInsight();const t=e.completionHistory,n=new _l,r=this.calculateAverageDelay(t),a=n.calculateOptimalTime(t),i=n.findWeekdayPatterns(t),l=Array.from(i.keys()).filter(m=>{const k=i.get(m);return k&&k.confidence>.5}),c=this.calculateConsistencyScore(t),u=(e.completionCount||0)+(e.missCount||0),h=u>0?(e.missCount||0)/u*100:0,v=this.generateSuggestion(r,a,l,c),p=this.calculateConfidence(t.length,c,a.confidence);return{averageCompletionDelay:r,preferredTimeOfDay:a.hour,preferredDayOfWeek:l,completionConsistency:c,missedTaskFrequency:h,suggestedAdjustment:v,confidence:p}}suggestScheduleOptimization(e){const t=this.analyzeCompletionPatterns(e);if(t.confidence<.5||!e.completionHistory||e.completionHistory.length<10)return null;const n=e.frequency,r={...n};let a="",i="";if(Math.abs(t.averageCompletionDelay)>60&&(a=`You typically complete this task around ${t.preferredTimeOfDay}:00, `,a+=t.averageCompletionDelay>0?`${Math.round(t.averageCompletionDelay/60)} hours later than scheduled.`:`${Math.round(Math.abs(t.averageCompletionDelay)/60)} hours earlier than scheduled.`,i="Better alignment with your natural completion patterns"),n.type==="weekly"&&t.preferredDayOfWeek.length>0){const l=n.weekdays||[],c=t.preferredDayOfWeek;JSON.stringify(l.sort())!==JSON.stringify(c.sort())&&(r.weekdays=c,a+=` Consider scheduling for ${this.formatWeekdays(c)} based on completion patterns.`,i="Higher completion rate on preferred days")}return a?{currentSchedule:{frequency:n,time:this.extractTimeFromDueAt(e.dueAt)},suggestedSchedule:{frequency:r,time:t.preferredTimeOfDay!==void 0?`${t.preferredTimeOfDay.toString().padStart(2,"0")}:00`:void 0},reason:a,confidence:t.confidence,expectedImprovement:i}:null}autoAdjustSchedule(e,t=.7){var a;if(!((a=e.smartRecurrence)!=null&&a.autoAdjust))return!1;const n=this.suggestScheduleOptimization(e);if(!n||n.confidence<t)return!1;if(e.frequency=n.suggestedSchedule.frequency,n.suggestedSchedule.time){const i=new Date(e.dueAt),[l,c]=n.suggestedSchedule.time.split(":").map(Number);i.setHours(l,c||0,0,0),e.dueAt=i.toISOString()}e.learningMetrics||(e.learningMetrics={averageDelayMinutes:0,optimalHour:0,consistencyScore:0,lastLearningUpdate:new Date().toISOString()});const r=this.analyzeCompletionPatterns(e);return e.learningMetrics.averageDelayMinutes=r.averageCompletionDelay,e.learningMetrics.optimalHour=r.preferredTimeOfDay,e.learningMetrics.consistencyScore=r.completionConsistency,e.learningMetrics.lastLearningUpdate=new Date().toISOString(),!0}detectAnomalies(e){const t=[];if(!e.completionHistory||e.completionHistory.length<5)return t;const r=new _l().detectSkipPatterns(e);r.isAnomalous&&t.push({type:"consistently_skipped",severity:"high",description:r.reason,affectedPeriod:{start:e.createdAt,end:new Date().toISOString()},suggestion:"Consider adjusting the recurrence frequency or disabling this task"});const a=this.detectCompletionDrift(e.completionHistory);return a.isDrifting&&t.push({type:"completion_drift",severity:a.severity,description:`Completion times are drifting ${a.direction} by an average of ${a.averageDriftMinutes} minutes`,affectedPeriod:{start:e.completionHistory[0].completedAt,end:e.completionHistory[e.completionHistory.length-1].completedAt},suggestion:"Consider adjusting the scheduled time to match your natural completion pattern"}),t}getDefaultInsight(){return{averageCompletionDelay:0,preferredTimeOfDay:9,preferredDayOfWeek:[],completionConsistency:0,missedTaskFrequency:0,suggestedAdjustment:"Not enough data to generate insights (need at least 10 completions)",confidence:0}}calculateAverageDelay(e){if(e.length===0)return 0;const t=e.reduce((n,r)=>n+r.delayMinutes,0);return Math.round(t/e.length)}calculateConsistencyScore(e){if(e.length<2)return 0;const t=this.calculateAverageDelay(e),n=e.reduce((i,l)=>{const c=l.delayMinutes-t;return i+c*c},0)/e.length,r=Math.sqrt(n),a=Math.max(0,1-r/240);return Math.round(a*100)/100}generateSuggestion(e,t,n,r){if(r<.3)return"Completion patterns are inconsistent. Try to complete tasks at similar times.";const a=[];if(Math.abs(e)>60){const i=Math.round(Math.abs(e)/60);e>0?a.push(`Consider scheduling ${i} hour(s) later (around ${t.hour}:00)`):a.push(`Consider scheduling ${i} hour(s) earlier (around ${t.hour}:00)`)}return n.length>0&&t.confidence>.6&&a.push(`Best completion rate on ${this.formatWeekdays(n)}`),a.length>0?a.join(". "):"Maintaining good completion consistency!"}calculateConfidence(e,t,n){const a=Math.min(1,e/30)*.4+t*.3+n*.3;return Math.round(a*100)/100}extractTimeFromDueAt(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}formatWeekdays(e){const t=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];return e.map(n=>t[n]).join(", ")}detectCompletionDrift(e){if(e.length<10)return{isDrifting:!1,direction:"later",averageDriftMinutes:0,severity:"low"};const n=e.slice(-10).map(v=>v.delayMinutes);let r=0,a=0,i=0,l=0;const c=n.length;for(let v=0;v<c;v++)r+=v,a+=n[v],i+=v*n[v],l+=v*v;const u=(c*i-r*a)/(c*l-r*r),h=Math.abs(u);if(h>5){const v=h>30?"high":h>15?"medium":"low";return{isDrifting:!0,direction:u>0?"later":"earlier",averageDriftMinutes:Math.round(h),severity:v}}return{isDrifting:!1,direction:"later",averageDriftMinutes:0,severity:"low"}}}class _l{calculateOptimalTime(e){if(e.length===0)return{hour:9,confidence:0,sampleSize:0};const t=new Map;for(const i of e){const l=new Date(i.completedAt).getHours();t.set(l,(t.get(l)||0)+1)}let n=9,r=0;for(const[i,l]of t.entries())l>r&&(r=l,n=i);const a=r/e.length;return{hour:n,confidence:Math.round(a*100)/100,sampleSize:e.length}}findWeekdayPatterns(e){const t=new Map,n=new Map;for(const r of e){const a=r.dayOfWeek;n.has(a)||n.set(a,[]),n.get(a).push(r)}for(const[r,a]of n.entries()){const i=this.calculateOptimalTime(a);a.length>=2&&t.set(r,i)}return t}detectSkipPatterns(e){const t=(e.completionCount||0)+(e.missCount||0),n=t>0?(e.missCount||0)/t:0;return n>.5&&t>=10?{isAnomalous:!0,reason:`Task is skipped ${Math.round(n*100)}% of the time (${e.missCount} out of ${t})`}:(e.missCount||0)>=5&&e.currentStreak===0?{isAnomalous:!0,reason:"Task has been skipped multiple times recently"}:{isAnomalous:!1,reason:""}}}var jp=A('<div class="empty-state svelte-14xzl1l"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="svelte-14xzl1l"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg> <h3 class="svelte-14xzl1l">No Smart Tasks Yet</h3> <p>Enable smart recurrence on your tasks and complete them at least 5 times to see insights.</p></div>'),Hp=A('<div class="suggestion-box svelte-14xzl1l"><div class="suggestion-icon svelte-14xzl1l">💡</div> <p class="svelte-14xzl1l"> </p></div>'),$p=A('<div class="schedule-suggestion svelte-14xzl1l"><h4 class="svelte-14xzl1l">Suggested Schedule Adjustment</h4> <div class="schedule-comparison svelte-14xzl1l"><div class="schedule-column svelte-14xzl1l"><span class="schedule-label svelte-14xzl1l">Current</span> <span class="schedule-value svelte-14xzl1l"> </span></div> <div class="schedule-arrow svelte-14xzl1l">→</div> <div class="schedule-column svelte-14xzl1l"><span class="schedule-label svelte-14xzl1l">Suggested</span> <span class="schedule-value svelte-14xzl1l"> </span></div></div> <p class="suggestion-reason svelte-14xzl1l"> </p> <p class="suggestion-improvement svelte-14xzl1l"> </p> <button class="apply-btn svelte-14xzl1l">Apply Suggestion</button></div>'),Wp=A('<div class="anomaly-card svelte-14xzl1l"><div class="anomaly-header svelte-14xzl1l"><span class="anomaly-type svelte-14xzl1l"> </span> <span class="anomaly-severity svelte-14xzl1l"> </span></div> <p class="anomaly-description svelte-14xzl1l"> </p> <p class="anomaly-suggestion svelte-14xzl1l"> </p></div>'),Gp=A('<div class="anomalies-section svelte-14xzl1l"><h4 class="svelte-14xzl1l">⚠️ Detected Issues</h4> <!></div>'),Kp=A('<span class="history-label svelte-14xzl1l"> </span>'),Vp=A('<div class="history-summary svelte-14xzl1l"><span class="history-label svelte-14xzl1l"> </span> <!></div>'),Qp=A('<div class="insight-card svelte-14xzl1l"><div class="insight-header svelte-14xzl1l"><h3 class="svelte-14xzl1l"> </h3> <div class="confidence-badge svelte-14xzl1l"> </div></div> <div class="insight-stats svelte-14xzl1l"><div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Consistency</span> <span class="stat-value svelte-14xzl1l"> </span></div> <div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Avg Delay</span> <span class="stat-value svelte-14xzl1l"> </span></div> <div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Preferred Time</span> <span class="stat-value svelte-14xzl1l"> </span></div> <div class="stat-item svelte-14xzl1l"><span class="stat-label svelte-14xzl1l">Completion Rate</span> <span class="stat-value svelte-14xzl1l"> </span></div></div> <!> <!> <!> <!></div>'),Zp=A('<div class="insights-list svelte-14xzl1l"></div>'),Xp=A('<div class="insights-tab svelte-14xzl1l"><div class="insights-header svelte-14xzl1l"><h2 class="svelte-14xzl1l">Smart Insights</h2> <p class="svelte-14xzl1l">Learn from your task completion patterns to optimize your schedule</p></div> <!></div>');function Jp(s,e){ot(e,!0);const t=new Yp,n=V(()=>e.tasks.filter(g=>{var w;return((w=g.smartRecurrence)==null?void 0:w.enabled)&&g.completionHistory&&g.completionHistory.length>=5})),r=V(()=>o(n).map(g=>({task:g,insight:t.analyzeCompletionPatterns(g),suggestion:t.suggestScheduleOptimization(g),anomalies:t.detectAnomalies(g)}))),a=V(()=>o(r).sort((g,w)=>w.insight.confidence-g.insight.confidence));function i(g,w){var S;(S=e.onApplySuggestion)==null||S.call(e,g,w)}function l(g){if(Math.abs(g)<60)return`${Math.abs(g)} minutes`;const w=Math.abs(Math.round(g/60));return`${w} hour${w!==1?"s":""}`}function c(g){const w=g>=12?"PM":"AM";return`${g>12?g-12:g===0?12:g}:00 ${w}`}function u(g){return g>=.8?"Excellent":g>=.6?"Good":g>=.4?"Fair":"Inconsistent"}function h(g){return g>=.8?"#4caf50":g>=.6?"#2196f3":g>=.4?"#ff9800":"#f44336"}function v(g){switch(g){case"low":return"#ff9800";case"medium":return"#ff5722";case"high":return"#f44336"}}var p=Xp(),m=f(d(p),2);{var k=g=>{var w=jp();T(g,w)},_=g=>{var w=Zp();Fe(w,21,()=>o(a),it,(S,E)=>{let x=()=>o(E).task,O=()=>o(E).insight,L=()=>o(E).suggestion,R=()=>o(E).anomalies;var W=Qp(),j=d(W),J=d(j),re=d(J),te=f(J,2),oe=d(te),ge=f(j,2),$=d(ge),F=f(d($),2),C=d(F),B=f($,2),se=f(d(B),2),ee=d(se),pe=f(B,2),de=f(d(pe),2),ue=d(de),Ee=f(pe,2),_e=f(d(Ee),2),Pe=d(_e),le=f(ge,2);{var U=Z=>{var fe=Hp(),me=f(d(fe),2),ye=d(me);Y(()=>M(ye,O().suggestedAdjustment)),T(Z,fe)};H(le,Z=>{O().suggestedAdjustment&&Z(U)})}var D=f(le,2);{var q=Z=>{var fe=$p(),me=f(d(fe),2),ye=d(me),xe=f(d(ye),2),Ae=d(xe),$e=f(ye,4),Ze=f(d($e),2),Ge=d(Ze),Je=f(me,2),ct=d(Je),Ce=f(Je,2),ft=d(Ce),Be=f(Ce,2);Be.__click=()=>i(x(),L()),Y(()=>{M(Ae,L().currentSchedule.time||"Not set"),M(Ge,L().suggestedSchedule.time||"Not set"),M(ct,L().reason),M(ft,`Expected: ${L().expectedImprovement??""}`)}),T(Z,fe)};H(D,Z=>{L()&&Z(q)})}var Q=f(D,2);{var ae=Z=>{var fe=Gp(),me=f(d(fe),2);Fe(me,17,R,it,(ye,xe)=>{var Ae=Wp(),$e=d(Ae),Ze=d($e),Ge=d(Ze),Je=f(Ze,2),ct=d(Je),Ce=f($e,2),ft=d(Ce),Be=f(Ce,2),et=d(Be);Y((tt,Dt,Et)=>{wn(Ae,`border-left-color: ${tt??""}`),M(Ge,Dt),wn(Je,`background-color: ${Et??""}`),M(ct,o(xe).severity),M(ft,o(xe).description),M(et,`💡 ${o(xe).suggestion??""}`)},[()=>v(o(xe).severity),()=>o(xe).type.replace(/_/g," "),()=>v(o(xe).severity)]),T(ye,Ae)}),T(Z,fe)};H(Q,Z=>{R().length>0&&Z(ae)})}var I=f(Q,2);{var P=Z=>{var fe=Vp(),me=d(fe),ye=d(me),xe=f(me,2);{var Ae=$e=>{var Ze=Kp(),Ge=d(Ze);Y(Je=>M(Ge,`Last updated: ${Je??""}`),[()=>new Date(x().learningMetrics.lastLearningUpdate).toLocaleDateString()]),T($e,Ze)};H(xe,$e=>{x().learningMetrics&&$e(Ae)})}Y(()=>M(ye,`📊 ${x().completionHistory.length??""} completions tracked`)),T(Z,fe)};H(I,Z=>{x().completionHistory&&x().completionHistory.length>0&&Z(P)})}Y((Z,fe,me,ye,xe,Ae,$e)=>{M(re,x().name),wn(te,`background-color: ${Z??""}`),M(oe,`${fe??""}% confidence`),wn(F,`color: ${me??""}`),M(C,ye),M(ee,`${O().averageCompletionDelay>0?"+":""}${xe??""}`),M(ue,Ae),M(Pe,`${$e??""}%`)},[()=>h(O().confidence),()=>Math.round(O().confidence*100),()=>h(O().completionConsistency),()=>u(O().completionConsistency),()=>l(O().averageCompletionDelay),()=>c(O().preferredTimeOfDay),()=>Math.round(100-O().missedTaskFrequency)]),T(S,W)}),T(g,w)};H(m,g=>{o(n).length===0?g(k):g(_,!1)})}T(s,p),lt()}mt(["click"]);class Si{static parse(e){const t=e,n=e.trim().toLowerCase().replace(/\s+/g," ");if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const r=n.match(/^every\s+(.+)$/);if(!r)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let a=r[1],i;const l=a.match(/^(.+?)\s+when\s+done$/),c=a.match(/^(.+?)\s+when\s+due$/);if(l?(a=l[1],i=!0):c&&(a=c[1],i=!1),a==="weekday"||a==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:i},raw:t,isValid:!0};if(a==="weekend"||a==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:i},raw:t,isValid:!0};const u=this.parseOrdinalWeekdayPattern(a);if(u.matched)return u.error||u.ordinal===void 0||u.weekday===void 0?{frequency:{type:"daily",interval:1,whenDone:i},raw:t,isValid:!1,error:u.error||"Invalid ordinal weekday pattern"}:{frequency:{type:"monthly",interval:1,dayOfMonth:1,whenDone:i,rruleString:this.buildOrdinalRRuleString(u.weekday,u.ordinal),naturalLanguage:t},raw:t,isValid:!0};const h=a.match(/^(\d+\s+)?days?$/);if(h)return{frequency:{type:"daily",interval:h[1]?parseInt(h[1]):1,whenDone:i},raw:t,isValid:!0};const v=a.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(v){const k=v[1]?parseInt(v[1]):1,_=v[2];if(!_)return{frequency:{type:"weekly",interval:k,weekdays:[1],whenDone:i},raw:t,isValid:!0};const g=this.parseDayNames(_);return g.length===0?{frequency:{type:"weekly",interval:k,weekdays:[1],whenDone:i},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:k,weekdays:g,whenDone:i},raw:t,isValid:!0}}const p=a.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(p){const k=p[1]?parseInt(p[1]):1,_=p[2]?parseInt(p[2]):1;return _<1||_>31?{frequency:{type:"monthly",interval:k,dayOfMonth:1,whenDone:i},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:k,dayOfMonth:_,whenDone:i},raw:t,isValid:!0}}const m=a.match(/^(\d+\s+)?years?$/);return m?{frequency:{type:"yearly",interval:m[1]?parseInt(m[1]):1,month:0,dayOfMonth:1,whenDone:i},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:i},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=this.stringifyOrdinalWeekday(e.rruleString);if(t)return e.whenDone?`${t} when done`:t;const n=e.interval;let r;switch(e.type){case"daily":r=n===1?"every day":`every ${n} days`;break;case"weekly":{const a=n===1?"week":`${n} weeks`;if(e.weekdays.length===0)r=`every ${a}`;else{const i=e.weekdays.map(l=>this.getDayName(l)).join(", ");r=`every ${a} on ${i}`}break}case"monthly":{const a=n===1?"month":`${n} months`,i=this.getDaySuffix(e.dayOfMonth);r=`every ${a} on the ${e.dayOfMonth}${i}`;break}case"yearly":{r=`every ${n===1?"year":`${n} years`}`;break}default:r="every day"}return e.whenDone?`${r} when done`:r}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},n=e.split(",").map(a=>a.trim().toLowerCase()),r=[];for(const a of n)a in t&&r.push(t[a]);return r}static parseOrdinalWeekdayPattern(e){const t=e.split(" ");if(t.length<2)return{matched:!1};const n=this.parseOrdinalToken(t[0]);if(!n.matched)return{matched:!1};if(n.error)return{matched:!0,error:n.error};const r=this.parseSingleDay(t[1]);return r===null?{matched:!0,error:"Invalid weekday name"}:t.length===2?{matched:!0,ordinal:n.value,weekday:r}:t.length===5&&t[2]==="of"&&t[3]==="the"&&t[4]==="month"?{matched:!0,ordinal:n.value,weekday:r}:{matched:!0,error:"Ordinal weekday pattern must be 'every <ordinal> <weekday>' optionally followed by 'of the month'"}}static parseOrdinalToken(e){const t={first:1,second:2,third:3,fourth:4,last:-1};if(e in t)return{matched:!0,value:t[e]};const n=e.match(/^(\d+)(st|nd|rd|th)$/);if(!n)return{matched:!1};const r=parseInt(n[1],10);return r>=1&&r<=4?{matched:!0,value:r}:{matched:!0,error:"Ordinal weekday must be first, second, third, fourth, or last"}}static parseSingleDay(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6};return e in t?t[e]:null}static stringifyOrdinalWeekday(e){if(!e)return null;const t=this.parseRRuleString(e);if(!t||t.FREQ!=="MONTHLY"||!t.BYDAY||!t.BYSETPOS)return null;const n=this.fromRRuleWeekday(t.BYDAY);if(n===null)return null;const r=Number.parseInt(t.BYSETPOS,10);if(!Number.isFinite(r))return null;const a=this.ordinalWord(r);return a?`every ${a} ${this.getDayName(n)}`:null}static ordinalWord(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";case 4:return"fourth";case-1:return"last";default:return null}}static buildOrdinalRRuleString(e,t){return`RRULE:FREQ=MONTHLY;BYDAY=${this.toRRuleWeekday(e)};BYSETPOS=${t}`}static toRRuleWeekday(e){return["MO","TU","WE","TH","FR","SA","SU"][e]||"MO"}static fromRRuleWeekday(e){const n=["MO","TU","WE","TH","FR","SA","SU"].indexOf(e);return n>=0?n:null}static parseRRuleString(e){const t=e.trim().toUpperCase(),n=t.startsWith("RRULE:")?t.slice(6):t;if(!n)return null;const r=n.split(";"),a={};for(const i of r){if(!i)continue;const[l,c]=i.split("=");if(!l||!c)return null;a[l]=c}return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var em=A('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),tm=A('<div class="priority-selector svelte-1w15n9q"></div>');function nm(s,e){ot(e,!0);let t=$n(e,"value",15,"normal");const n=[{value:"highest",label:"Highest",emoji:"🔺",color:"var(--b3-theme-error, #ef4444)"},{value:"high",label:"High",emoji:"⏫",color:"#f97316"},{value:"medium",label:"Medium",emoji:"🔼",color:"#f59e0b"},{value:"normal",label:"Normal",emoji:"🟡",color:"#eab308"},{value:"low",label:"Low",emoji:"🔽",color:"#22c55e"},{value:"lowest",label:"Lowest",emoji:"⏬",color:"#64748b"}];function r(i){t(i),e.onchange(i)}var a=tm();Fe(a,21,()=>n,it,(i,l)=>{var c=em();let u;var h=d(c);h.__change=()=>r(o(l).value);var v=f(h,2),p=d(v),m=f(v,2),k=d(m);Y(()=>{u=Ke(c,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===o(l).value}),wn(c,`--priority-color: ${o(l).color??""}`),Xi(h,o(l).value),tr(h,t()===o(l).value),M(p,o(l).emoji),M(k,o(l).label)}),T(i,c)}),T(s,a),lt()}mt(["change"]);var sm=A('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),rm=A('<div class="status-selector svelte-v9ezc0"></div>');function am(s,e){ot(e,!0);let t=$n(e,"value",15,"todo");const n=[{value:"todo",label:"Todo",icon:"○",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"✓",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"✕",color:"#999"}];function r(i){t(i),e.onchange(i)}var a=rm();Fe(a,21,()=>n,it,(i,l)=>{var c=sm();let u;var h=d(c);h.__change=()=>r(o(l).value);var v=f(h,2),p=d(v),m=f(v,2),k=d(m);Y(()=>{u=Ke(c,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===o(l).value}),wn(c,`--status-color: ${o(l).color??""}`),Xi(h,o(l).value),tr(h,t()===o(l).value),M(p,o(l).icon),M(k,o(l).label)}),T(i,c)}),T(s,a),lt()}mt(["change"]);var im=A('<div class="recurrence-input__valid svelte-787fjp">✓ Valid recurrence pattern</div>'),om=A('<div class="recurrence-input__error svelte-787fjp"> </div>'),lm=A('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),cm=A('<li class="svelte-787fjp"> </li>'),um=A('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),dm=A('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function hm(s,e){ot(e,!0);let t=$n(e,"value",15,""),n=$n(e,"showPreview",3,!0);const r=V(()=>Si.parse(t())),a=V(()=>o(r).isValid),i=V(()=>o(r).error);function l(w,S=3){const E=[],x=new Date;for(let O=0;O<S;O++){const L=new Date(x);switch(w.type){case"daily":L.setDate(x.getDate()+O*w.interval);break;case"weekly":L.setDate(x.getDate()+O*w.interval*7);break;case"monthly":L.setMonth(x.getMonth()+O*w.interval);break;case"yearly":L.setFullYear(x.getFullYear()+O*w.interval);break}E.push(L.toLocaleDateString())}return E}const c=V(()=>o(a)&&n()?l(o(r).frequency):[]);function u(w){const E=w.target.value;t(E);const x=Si.parse(E);e.onchange(E,x.isValid?x.frequency:null,x.isValid)}var h=dm(),v=d(h);let p;v.__input=u;var m=f(v,2);{var k=w=>{var S=lm(),E=d(S);{var x=L=>{var R=im();T(L,R)},O=L=>{var R=om(),W=d(R);Y(()=>M(W,`⚠ ${(o(i)||"Invalid recurrence pattern")??""}`)),T(L,R)};H(E,L=>{o(a)?L(x):L(O,!1)})}T(w,S)};H(m,w=>{t().length>0&&w(k)})}var _=f(m,2);{var g=w=>{var S=um(),E=f(d(S),2);Fe(E,21,()=>o(c),it,(x,O)=>{var L=cm(),R=d(L);Y(()=>M(R,o(O))),T(x,L)}),T(w,S)};H(_,w=>{o(a)&&n()&&o(c).length>0&&w(g)})}Y(()=>{p=Ke(v,1,"recurrence-input__field svelte-787fjp",null,p,{valid:o(a),invalid:!o(a)&&t().length>0}),Me(v,"aria-invalid",!o(a)&&t().length>0)}),gt(v,t),T(s,h),lt()}mt(["input"]);var fm=A('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">✕</button></div>'),vm=A('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),gm=A('<span class="dependency-picker__option-check svelte-10ls0lk">✓</span>'),pm=A('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),mm=A('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),ym=A('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function kl(s,e){ot(e,!0);let t=$n(e,"selected",31,()=>De([])),n=$n(e,"label",3,"Select tasks"),r=G(""),a=G(!1);const i=V(()=>e.repository.getAllTasks().filter(L=>L.id!==e.excludeId)),l=V(()=>o(r).trim()?o(i).filter(L=>L.name.toLowerCase().includes(o(r).toLowerCase())):o(i)),c=V(()=>o(i).filter(L=>t().includes(L.id)));function u(L){if(!t().includes(L)){const R=[...t(),L];t(R),e.onchange(R)}b(r,""),b(a,!1)}function h(L){const R=t().filter(W=>W!==L);t(R),e.onchange(R)}function v(){b(a,!0)}function p(){setTimeout(()=>{b(a,!1)},200)}var m=ym(),k=d(m),_=d(k),g=f(k,2);{var w=L=>{var R=vm();Fe(R,21,()=>o(c),W=>W.id,(W,j)=>{var J=fm(),re=d(J),te=d(re),oe=f(re,2);oe.__click=()=>h(o(j).id),Y(()=>{M(te,o(j).name),Me(oe,"aria-label",`Remove ${o(j).name??""}`)}),T(W,J)}),T(L,R)};H(g,L=>{o(c).length>0&&L(w)})}var S=f(g,2),E=d(S),x=f(E,2);{var O=L=>{var R=mm();Fe(R,21,()=>o(l).slice(0,10),W=>W.id,(W,j)=>{var J=pm();let re;J.__click=()=>u(o(j).id);var te=d(J),oe=d(te),ge=f(te,2);{var $=F=>{var C=gm();T(F,C)};H(ge,F=>{t().includes(o(j).id)&&F($)})}Y((F,C)=>{re=Ke(J,1,"dependency-picker__option svelte-10ls0lk",null,re,F),J.disabled=C,M(oe,o(j).name)},[()=>({selected:t().includes(o(j).id)}),()=>t().includes(o(j).id)]),T(W,J)}),T(L,R)};H(x,L=>{o(a)&&o(l).length>0&&L(O)})}Y(()=>M(_,n())),Ot("focus",E,v),Ot("blur",E,p),gt(E,()=>o(r),L=>b(r,L)),T(s,m),lt()}mt(["click"]);var bm=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),_m=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),km=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),wm=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Tm=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Sm=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Dm=A('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">✕</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">💡 Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">⌘/Ctrl+Enter</kbd> to save</div></div></div>');function lu(s,e){var Ie,Le,bt,Yt,xt,Qt,At,jt,Zn,Zt,mn,Xt;ot(e,!0);const t="every day",n="Blocked by (tasks that must complete first)",r="Blocks (tasks that depend on this)",a=!e.task;let i=G(De(((Ie=e.task)==null?void 0:Ie.name)||"")),l=G(De(((Le=e.task)==null?void 0:Le.description)||"")),c=G(De(((bt=e.task)==null?void 0:bt.priority)||"normal")),u=G(De(((Yt=e.task)==null?void 0:Yt.status)||"todo")),h=G(De((xt=e.task)!=null&&xt.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),v=G(De((Qt=e.task)!=null&&Qt.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),p=G(De((At=e.task)!=null&&At.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),m=G(De(((jt=e.task)==null?void 0:jt.recurrenceText)||((Zn=e.task)!=null&&Zn.frequency?Si.stringify(e.task.frequency):t))),k=G(De(((Zt=e.task)==null?void 0:Zt.frequency)||null)),_=G(!0),g=G(De(((mn=e.task)==null?void 0:mn.blockedBy)||[])),w=G(De(((Xt=e.task)==null?void 0:Xt.dependsOn)||[])),S=G(De({name:!1,dueAt:!1,recurrence:!1})),E=G(!1),x=G(null);const O=V(()=>o(S).name&&!o(i).trim()?"Task name is required":""),L=V(()=>o(S).dueAt?o(h)?Number.isNaN(new Date(o(h)).getTime())?"Invalid due date":"":"Due date is required":""),R=V(()=>o(S).recurrence&&!o(_)?"Invalid recurrence pattern":""),W=V(()=>!!(o(O)||o(L)||o(R)));Yr(()=>{requestAnimationFrame(()=>{var z;(z=o(x))==null||z.focus()})});function j(z,ve,st){b(m,z,!0),b(k,ve,!0),b(_,st,!0),o(S).recurrence=!0}function J(z){b(c,z,!0)}function re(z){b(u,z,!0)}function te(z){b(g,z,!0)}function oe(z){b(w,z,!0)}async function ge(){if(b(S,{name:!0,dueAt:!0,recurrence:!0},!0),o(W)){K.warning("Please fix validation errors");return}if(!o(k)){K.error("Invalid recurrence pattern");return}b(E,!0);try{let z;a?z=Bc(o(i).trim(),o(k),new Date(o(h))):(z={...e.task},z.name=o(i).trim(),z.frequency=o(k),z.dueAt=new Date(o(h)).toISOString()),z.description=o(l).trim()||void 0,z.priority=o(c),z.status=o(u),z.recurrenceText=o(m),z.scheduledAt=o(v)?new Date(o(v)).toISOString():void 0,z.startAt=o(p)?new Date(o(p)).toISOString():void 0,z.blockedBy=o(g).length>0?o(g):void 0,z.dependsOn=o(w).length>0?o(w):void 0,z.updatedAt=new Date().toISOString(),o(u)==="done"&&!z.lastCompletedAt&&(z.lastCompletedAt=new Date().toISOString()),o(u)==="cancelled"&&!z.cancelledAt&&(z.cancelledAt=new Date().toISOString()),await e.repository.saveTask(z),e.onSave&&e.onSave(z),K.success(`Task "${z.name}" ${a?"created":"updated"}`),He.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(z){K.error(`Failed to save task: ${z}`)}finally{b(E,!1)}}function $(z){z.key==="Escape"&&e.onClose(),(z.metaKey||z.ctrlKey)&&z.key==="Enter"&&(z.preventDefault(),ge())}function F(z){return z?new Date(z).toLocaleString():"—"}var C=Dm();C.__keydown=$;var B=d(C),se=d(B),ee=d(se),pe=d(ee),de=f(ee,2);de.__click=function(...z){var ve;(ve=e.onClose)==null||ve.apply(this,z)};var ue=f(se,2),Ee=d(ue),_e=f(d(Ee),2);_e.__input=()=>o(S).name=!0,Tn(_e,z=>b(x,z),()=>o(x));var Pe=f(_e,2);{var le=z=>{var ve=bm(),st=d(ve);Y(()=>M(st,o(O))),T(z,ve)};H(Pe,z=>{o(O)&&z(le)})}var U=f(Ee,2),D=f(d(U),2),q=f(U,2),Q=f(d(q),2);nm(Q,{get value(){return o(c)},onchange:J});var ae=f(q,2),I=f(d(ae),2);am(I,{get value(){return o(u)},onchange:re});var P=f(ae,2),Z=f(d(P),2);Z.__input=()=>o(S).dueAt=!0;var fe=f(Z,2);{var me=z=>{var ve=_m(),st=d(ve);Y(()=>M(st,o(L))),T(z,ve)};H(fe,z=>{o(L)&&z(me)})}var ye=f(P,2),xe=f(d(ye),2),Ae=f(ye,2),$e=f(d(Ae),2),Ze=f(Ae,2),Ge=f(d(Ze),2);hm(Ge,{get value(){return o(m)},onchange:j,showPreview:!0});var Je=f(Ge,2);{var ct=z=>{var ve=km(),st=d(ve);Y(()=>M(st,o(R))),T(z,ve)};H(Je,z=>{o(R)&&z(ct)})}var Ce=f(Ze,2),ft=d(Ce);{let z=V(()=>{var ve;return(ve=e.task)==null?void 0:ve.id});kl(ft,{get repository(){return e.repository},get selected(){return o(g)},get excludeId(){return o(z)},onchange:te,label:n})}var Be=f(Ce,2),et=d(Be);{let z=V(()=>{var ve;return(ve=e.task)==null?void 0:ve.id});kl(et,{get repository(){return e.repository},get selected(){return o(w)},get excludeId(){return o(z)},onchange:oe,label:r})}var tt=f(Be,2),Dt=d(tt),Et=f(d(Dt),2),Bt=d(Et),ie=f(Dt,2);{var ce=z=>{var ve=wm(),st=f(d(ve),2),rn=d(st);Y(an=>M(rn,an),[()=>F(e.task.lastCompletedAt)]),T(z,ve)};H(ie,z=>{var ve;(ve=e.task)!=null&&ve.lastCompletedAt&&z(ce)})}var Se=f(ie,2);{var ut=z=>{var ve=Tm(),st=f(d(ve),2),rn=d(st);Y(an=>M(rn,an),[()=>F(e.task.cancelledAt)]),T(z,ve)};H(Se,z=>{var ve;(ve=e.task)!=null&&ve.cancelledAt&&z(ut)})}var Pn=f(Se,2);{var ne=z=>{var ve=Sm(),st=f(d(ve),2),rn=d(st);Y(()=>M(rn,e.task.linkedBlockId)),T(z,ve)};H(Pn,z=>{var ve;(ve=e.task)!=null&&ve.linkedBlockId&&z(ne)})}var we=f(ue,2),Ye=d(we);Ye.__click=function(...z){var ve;(ve=e.onClose)==null||ve.apply(this,z)};var nt=f(Ye,2);nt.__click=ge;var ke=d(nt);Y(z=>{M(pe,a?"Create Task":"Edit Task"),Me(_e,"aria-invalid",!!o(O)),Me(Z,"aria-invalid",!!o(L)),M(Bt,z),nt.disabled=o(E),M(ke,o(E)?"Saving...":a?"Create Task":"Save Changes")},[()=>{var z;return F((z=e.task)==null?void 0:z.createdAt)}]),Ot("blur",_e,()=>o(S).name=!0),gt(_e,()=>o(i),z=>b(i,z)),gt(D,()=>o(l),z=>b(l,z)),Ot("blur",Z,()=>o(S).dueAt=!0),gt(Z,()=>o(h),z=>b(h,z)),gt(xe,()=>o(v),z=>b(v,z)),gt($e,()=>o(p),z=>b(p,z)),T(s,C),lt()}mt(["keydown","click","input"]);class Em{constructor(e){y(this,"config");y(this,"compiledExcludeFolders",[]);y(this,"compiledExcludeNotebooks",[]);y(this,"compiledExcludeTags",[]);y(this,"compiledExcludeFilePatterns",[]);y(this,"statusRegistry",Sn.getInstance());this.config=e,this.compileExclusions()}evaluate(e,t){if(!this.config.enabled)return!0;if(!this.passesExclusions(e,t))return!1;if(this.config.mode==="all")return!0;const n=this.config.rules.filter(l=>l.enabled);if(n.length===0)return!0;const r=n.map(l=>this.evaluateRule(l,e,t)),a=r.every(l=>l),i=r.some(l=>l);return this.config.mode==="include"?a:!i}updateConfig(e){this.config=e,this.compileExclusions()}getConfig(){return this.config}evaluateRule(e,t,n){switch(e.type){case"tag":const r=this.extractTags(t),a=e.pattern.replace(/\*/g,".*"),i=new RegExp(`^${a}$`);return r.some(c=>i.test(c));case"regex":try{const c=e.pattern.match(/^\/(.+)\/([gimsuy]*)$/);let u;return c?u=new RegExp(c[1],c[2]):u=new RegExp(e.pattern),u.test(t)}catch{return!1}case"path":return n?this.normalizePath(n).includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}evaluateTask(e){if(!this.config.enabled)return!0;const t=e.linkedBlockContent??e.name??"",n=e.path;if(!this.passesExclusions(t,n,e.statusSymbol,e.tags))return!1;if(this.config.mode==="all")return!0;const r=this.config.rules.filter(c=>c.enabled);if(r.length===0)return!0;const a=r.map(c=>this.evaluateRule(c,t,n)),i=a.every(c=>c),l=a.some(c=>c);return this.config.mode==="include"?i:!l}extractTags(e){return e.match(/#[\w/-]+/g)||[]}passesExclusions(e,t,n,r){const a=t?this.normalizePath(t):void 0,i=r??this.extractTags(e);if(a&&(this.compiledExcludeFolders.some(l=>l.test(a))||this.compiledExcludeNotebooks.some(l=>l.test(a))||this.compiledExcludeFilePatterns.some(l=>l.test(a)))||i.length>0&&this.compiledExcludeTags.length>0&&i.some(l=>this.compiledExcludeTags.some(c=>c.test(l))))return!1;if(this.config.excludeStatusTypes.length>0){const l=this.resolveStatusType(n,e);if(l&&this.config.excludeStatusTypes.includes(l))return!1}return!0}resolveStatusType(e,t){const n=e??this.extractStatusSymbol(t??"");return n?this.statusRegistry.get(n).type:null}extractStatusSymbol(e){const t=e.match(/^\s*-\s*\[(.)\]/);return t?t[1]:null}compileExclusions(){this.compiledExcludeFolders=this.config.excludeFolders.map(e=>this.compilePathPattern(e)),this.compiledExcludeNotebooks=this.config.excludeNotebooks.map(e=>this.compilePathPattern(e)),this.compiledExcludeFilePatterns=this.config.excludeFilePatterns.map(e=>this.compilePathPattern(e)),this.compiledExcludeTags=this.config.excludeTags.map(e=>this.compileTagPattern(e))}compileTagPattern(e){const t=e.trim();if(!t)return/^$/;const n=t.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i")}compilePathPattern(e){const t=e.trim();if(!t)return/^$/;const n=t.match(/^\/(.+)\/([gimsuy]*)$/);if(n)try{return new RegExp(n[1],n[2])}catch{return/^$/}return this.globToRegExp(t)}globToRegExp(e){let n=this.normalizePath(e).replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*\*/g,"::DOUBLE_STAR::").replace(/\*/g,"[^/]*").replace(/::DOUBLE_STAR::/g,".*");return n.startsWith(".*")||(n=`.*${n}`),new RegExp(n)}normalizePath(e){return e.replace(/\\/g,"/")}}const Rr={enabled:!1,mode:"all",rules:[],excludeFolders:[],excludeNotebooks:[],excludeTags:[],excludeFilePatterns:[],excludeStatusTypes:[]},_s=class _s{constructor(){y(this,"engine");this.engine=new Em(Rr)}static getInstance(){return _s.instance||(_s.instance=new _s),_s.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}shouldIncludeTask(e){return this.engine.evaluateTask(e)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(Rr)}};y(_s,"instance",null);let ma=_s;var xm=A("<span> </span>"),Am=A("<span>Preview unavailable</span>"),Cm=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Im=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Mm=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Om=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Nm=A('<label class="status-toggle svelte-b8rwae"><input type="checkbox"/> <span> </span></label>'),Rm=A("<div> </div>"),Pm=A('<pre class="query-explanation svelte-b8rwae"> </pre>'),qm=A('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Filtering &amp; Query</h3> <p class="description svelte-b8rwae">Apply a hard exclusion filter before indexing, plus a default query fragment applied to every query.</p> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Filter (Hard Exclusions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Filter</span></label></div> <div class="preview svelte-b8rwae"><!></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Folders</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/archive/**"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Notebooks</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="Personal"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Tags</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="#log"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude File Patterns (glob or /regex/)</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/templates/** or /daily/.+\\.md/"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Status Types</label> <div class="status-toggle-list svelte-b8rwae"></div></div> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Filter</button></section> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Query (Default Conditions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Query</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Global Query DSL</label> <textarea class="settings__input svelte-b8rwae" rows="4" placeholder="not done\\nnot blocked\\ndue before next 30 days"></textarea></div> <div class="query-actions svelte-b8rwae"><button class="add-btn svelte-b8rwae" type="button">Save Global Query</button> <button class="add-btn svelte-b8rwae" type="button">Validate / Explain</button> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Query</button></div> <!> <!> <p class="hint svelte-b8rwae">Use <code>ignore global query</code> on a local query line to bypass the global query for that block.</p></section></div>');function Fm(s,e){ot(e,!0);const t=ma.getInstance(),n=vr.getInstance();let r=G(De(e.settingsService.get().globalFilter??Rr)),a=G(De(e.settingsService.get().globalQuery??pa)),i=G(""),l=G(""),c=G(""),u=G(""),h=G(null),v=G(null),p=G(null);const m=Object.values(vt);wt(()=>{x()});function k(ie){return Array.from(new Set(ie.map(ce=>ce.trim()).filter(Boolean)))}function _(ie,ce){const Se=ce.trim();Se&&(b(r,{...o(r),[ie]:k([...o(r)[ie],Se])},!0),S())}function g(ie,ce){b(r,{...o(r),[ie]:o(r)[ie].filter(Se=>Se!==ce)},!0),S()}function w(ie){const ce=new Set(o(r).excludeStatusTypes);ce.has(ie)?ce.delete(ie):ce.add(ie),b(r,{...o(r),excludeStatusTypes:Array.from(ce)},!0),S()}async function S(){t.updateConfig(o(r)),await e.settingsService.update({globalFilter:o(r)}),He.emit("task:settings",{source:"global-filter"}),x()}async function E(){n.updateConfig(o(a)),await e.settingsService.update({globalQuery:o(a)}),He.emit("task:settings",{source:"global-query"})}function x(){if(!e.repository){b(h,null);return}const ie=e.repository.getAllTasks();b(h,ie.filter(ce=>!t.shouldIncludeTask(ce)).length,!0)}async function O(){b(r,{...Rr},!0),await S(),K.success("Global filter reset to defaults")}async function L(){b(a,{...pa},!0),b(v,null),b(p,null),await E(),K.success("Global query reset to defaults")}function R(){const ie=new ds;try{const ce=ie.parse(o(a).query||"");b(v,{valid:!0,message:"Global query is valid."},!0),b(p,au(ce),!0)}catch(ce){const Se=ce instanceof Error?ce.message:String(ce);b(v,{valid:!1,message:Se},!0),b(p,null)}}var W=qm(),j=f(d(W),4),J=d(j),re=f(d(J),2),te=d(re);te.__change=S;var oe=f(J,2),ge=d(oe);{var $=ie=>{var ce=xm(),Se=d(ce);Y(()=>M(Se,`Preview: ${o(h)??""} tasks excluded (from current index)`)),T(ie,ce)},F=ie=>{var ce=Am();T(ie,ce)};H(ge,ie=>{o(h)!==null?ie($):ie(F,!1)})}var C=f(oe,2),B=f(d(C),2);Fe(B,21,()=>o(r).excludeFolders,it,(ie,ce)=>{var Se=Cm();Se.__click=()=>g("excludeFolders",o(ce));var ut=d(Se);Y(()=>M(ut,`${o(ce)??""} ✕`)),T(ie,Se)});var se=f(B,2),ee=d(se),pe=f(ee,2);pe.__click=()=>{_("excludeFolders",o(i)),b(i,"")};var de=f(C,2),ue=f(d(de),2);Fe(ue,21,()=>o(r).excludeNotebooks,it,(ie,ce)=>{var Se=Im();Se.__click=()=>g("excludeNotebooks",o(ce));var ut=d(Se);Y(()=>M(ut,`${o(ce)??""} ✕`)),T(ie,Se)});var Ee=f(ue,2),_e=d(Ee),Pe=f(_e,2);Pe.__click=()=>{_("excludeNotebooks",o(l)),b(l,"")};var le=f(de,2),U=f(d(le),2);Fe(U,21,()=>o(r).excludeTags,it,(ie,ce)=>{var Se=Mm();Se.__click=()=>g("excludeTags",o(ce));var ut=d(Se);Y(()=>M(ut,`${o(ce)??""} ✕`)),T(ie,Se)});var D=f(U,2),q=d(D),Q=f(q,2);Q.__click=()=>{_("excludeTags",o(c)),b(c,"")};var ae=f(le,2),I=f(d(ae),2);Fe(I,21,()=>o(r).excludeFilePatterns,it,(ie,ce)=>{var Se=Om();Se.__click=()=>g("excludeFilePatterns",o(ce));var ut=d(Se);Y(()=>M(ut,`${o(ce)??""} ✕`)),T(ie,Se)});var P=f(I,2),Z=d(P),fe=f(Z,2);fe.__click=()=>{_("excludeFilePatterns",o(u)),b(u,"")};var me=f(ae,2),ye=f(d(me),2);Fe(ye,21,()=>m,it,(ie,ce)=>{var Se=Nm(),ut=d(Se);ut.__change=()=>w(o(ce));var Pn=f(ut,2),ne=d(Pn);Y(we=>{tr(ut,we),M(ne,o(ce))},[()=>o(r).excludeStatusTypes.includes(o(ce))]),T(ie,Se)});var xe=f(me,2);xe.__click=O;var Ae=f(j,2),$e=d(Ae),Ze=f(d($e),2),Ge=d(Ze);Ge.__change=E;var Je=f($e,2),ct=f(d(Je),2),Ce=f(Je,2),ft=d(Ce);ft.__click=E;var Be=f(ft,2);Be.__click=R;var et=f(Be,2);et.__click=L;var tt=f(Ce,2);{var Dt=ie=>{var ce=Rm(),Se=d(ce);Y(()=>{Ke(ce,1,`validation ${o(v).valid?"success":"error"}`,"svelte-b8rwae"),M(Se,o(v).message)}),T(ie,ce)};H(tt,ie=>{o(v)&&ie(Dt)})}var Et=f(tt,2);{var Bt=ie=>{var ce=Pm(),Se=d(ce);Y(()=>M(Se,o(p))),T(ie,ce)};H(Et,ie=>{o(p)&&ie(Bt)})}gi(te,()=>o(r).enabled,ie=>o(r).enabled=ie),gt(ee,()=>o(i),ie=>b(i,ie)),gt(_e,()=>o(l),ie=>b(l,ie)),gt(q,()=>o(c),ie=>b(c,ie)),gt(Z,()=>o(u),ie=>b(u,ie)),gi(Ge,()=>o(a).enabled,ie=>o(a).enabled=ie),gt(ct,()=>o(a).query,ie=>o(a).query=ie),T(s,W),lt()}mt(["change","click"]);var Lm=A('<button class="delete-btn svelte-1qw3eru">Delete</button>'),Um=A('<span class="default-badge svelte-1qw3eru">Default</span>'),zm=A('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),Bm=A('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function Ym(s,e){ot(e,!0);let t=Sn.getInstance(),n=G(De([])),r=G(""),a=G(""),i=G(De(vt.TODO)),l=G("x");function c(){b(n,t.getAll(),!0)}function u(){if(!o(r).trim()||!o(a).trim()){K.error("Symbol and name are required");return}if(o(r).length!==1){K.error("Symbol must be a single character");return}const le={symbol:o(r),name:o(a),type:o(i),nextStatusSymbol:o(l)},U=new Fn(le);t.register(U),c(),p(),K.success(`Status "${o(a)}" added`)}function h(le){if([" ","x","/","-"].includes(le)){K.error("Cannot delete default status");return}t.unregister(le),c(),K.success("Status deleted")}function v(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),c(),K.success("Statuses reset to defaults"))}function p(){b(r,""),b(a,""),b(i,vt.TODO,!0),b(l,"x")}wt(()=>{c()});var m=Bm(),k=f(d(m),4),_=d(k),g=d(_),w=f(d(g));Fe(w,21,()=>o(n),it,(le,U)=>{var D=zm(),q=d(D),Q=d(q),ae=d(Q),I=f(q),P=d(I),Z=f(I),fe=d(Z),me=d(fe),ye=f(Z),xe=d(ye),Ae=d(xe),$e=f(ye),Ze=d($e),Ge=d(Ze),Je=f($e),ct=d(Je);{var Ce=Be=>{var et=Lm();et.__click=()=>h(o(U).symbol),T(Be,et)},ft=Be=>{var et=Um();T(Be,et)};H(ct,Be=>{[" ","x","/","-"].includes(o(U).symbol)?Be(ft,!1):Be(Ce)})}Y(()=>{M(ae,`[${o(U).symbol??""}]`),M(P,o(U).name),M(me,o(U).type),M(Ae,`[${o(U).nextStatusSymbol??""}]`),M(Ge,`- [${o(U).symbol??""}] Task example`)}),T(le,D)});var S=f(k,2),E=f(d(S),2),x=d(E),O=d(x),L=f(d(O),2),R=f(O,2),W=f(d(R),2),j=f(R,2),J=f(d(j),2),re=d(J),te={},oe=f(re),ge={},$=f(oe),F={},C=f($),B={},se=f(C),ee={},pe=f(j,2),de=f(d(pe),2),ue=f(pe,2),Ee=f(d(ue),2);Ee.__click=u;var _e=f(S,2),Pe=d(_e);Pe.__click=v,Y(()=>{te!==(te=vt.TODO)&&(re.value=(re.__value=vt.TODO)??""),ge!==(ge=vt.IN_PROGRESS)&&(oe.value=(oe.__value=vt.IN_PROGRESS)??""),F!==(F=vt.DONE)&&($.value=($.__value=vt.DONE)??""),B!==(B=vt.CANCELLED)&&(C.value=(C.__value=vt.CANCELLED)??""),ee!==(ee=vt.NON_TASK)&&(se.value=(se.__value=vt.NON_TASK)??"")}),gt(L,()=>o(r),le=>b(r,le)),gt(W,()=>o(a),le=>b(a,le)),oh(J,()=>o(i),le=>b(i,le)),gt(de,()=>o(l),le=>b(l,le)),T(s,m),lt()}mt(["click"]);var jm=A('<button class="settings__close-btn svelte-1ke3hir">✕</button>'),Hm=A("<div> </div>"),$m=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),Wm=A('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Gm=A('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"><input class="settings__shortcut-input svelte-1ke3hir" type="text" placeholder="Unassigned"/> <div class="settings__shortcut-actions svelte-1ke3hir"><button class="settings__shortcut-btn svelte-1ke3hir" type="button">Save</button> <button class="settings__shortcut-btn settings__shortcut-btn--ghost svelte-1ke3hir" type="button">Reset</button></div> <div class="settings__shortcut-default svelte-1ke3hir"> </div></div></div>'),Km=A(`<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div> <button class="settings__shortcut-reset-all svelte-1ke3hir" type="button">Reset all shortcuts</button> <p class="settings__shortcut-note svelte-1ke3hir">Tip: You can also customize these in SiYuan's native shortcut settings.</p></section>`),Vm=A('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),Qm=A('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filtering & Query</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function Zm(s,e){ot(e,!0);let t=G(De(pi)),n=G(null),r=De({}),a=G("general"),i=G(De([])),l=G(De({}));function c(){if(!e.shortcutManager){b(i,[],!0),b(l,{},!0);return}b(i,e.shortcutManager.getShortcutDisplay(),!0),b(l,o(i).reduce(($,F)=>($[F.id]=F.currentHotkey||"",$),{}),!0)}function u($,F){b(l,{...o(l),[$]:F},!0)}async function h($){if(!e.shortcutManager)return;const F=await e.shortcutManager.updateShortcut($,o(l)[$]??"");if(!F.success){K.error(F.message||"Failed to update shortcut.");return}K.success("Shortcut updated."),c()}async function v($){e.shortcutManager&&(await e.shortcutManager.resetShortcut($),K.success("Shortcut reset."),c())}async function p(){e.shortcutManager&&(await e.shortcutManager.resetAllShortcuts(),K.success("Shortcuts reset to defaults."),c())}wt(()=>{b(t,e.eventService.getConfig(),!0)}),wt(()=>{c()});async function m(){try{await e.eventService.saveConfig(o(t)),K.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch($){K.error("Failed to save settings: "+$)}}async function k(){b(n,"n8n"),r.n8n={success:!1,message:"Testing..."};try{const $=await e.eventService.testConnection();r.n8n={success:$.success,message:$.success?"Test successful!":$.message||"Test failed. Check configuration."}}catch($){r.n8n={success:!1,message:"Error: "+($ instanceof Error?$.message:String($))}}finally{b(n,null)}}var _=Qm(),g=d(_),w=f(d(g),2);{var S=$=>{var F=jm();F.__click=function(...C){var B;(B=e.onClose)==null||B.apply(this,C)},T($,F)};H(w,$=>{e.onClose&&$(S)})}var E=f(g,2),x=d(E),O=d(x);O.__click=()=>b(a,"general");var L=f(O,2);L.__click=()=>b(a,"filter");var R=f(L,2);R.__click=()=>b(a,"statuses");var W=f(R,2);W.__click=()=>b(a,"shortcuts");var j=f(x,2),J=d(j);{var re=$=>{var F=$m(),C=d(F),B=f(d(C),2),se=d(B),ee=f(C,2),pe=f(d(ee),2),de=f(ee,2),ue=f(d(de),2),Ee=f(de,2);Ee.__click=k;var _e=d(Ee),Pe=f(Ee,2);{var le=U=>{var D=Hm(),q=d(D);Y(()=>{Ke(D,1,`settings__test-result ${r.n8n.success?"success":"error"}`,"svelte-1ke3hir"),M(q,r.n8n.message)}),T(U,D)};H(Pe,U=>{r.n8n&&U(le)})}Y(()=>{pe.disabled=!o(t).n8n.enabled,ue.disabled=!o(t).n8n.enabled,Ee.disabled=!o(t).n8n.enabled||o(n)==="n8n",M(_e,o(n)==="n8n"?"Testing...":"Test Connection")}),gi(se,()=>o(t).n8n.enabled,U=>o(t).n8n.enabled=U),gt(pe,()=>o(t).n8n.webhookUrl,U=>o(t).n8n.webhookUrl=U),gt(ue,()=>o(t).n8n.sharedSecret,U=>o(t).n8n.sharedSecret=U),T($,F)},te=$=>{var F=ht(),C=Ve(F);{var B=ee=>{Fm(ee,{get settingsService(){return e.settingsService},get repository(){return e.repository}})},se=ee=>{var pe=ht(),de=Ve(pe);{var ue=_e=>{Ym(_e,{})},Ee=_e=>{var Pe=ht(),le=Ve(Pe);{var U=D=>{var q=Km(),Q=f(d(q),2);Fe(Q,21,()=>o(i),it,(I,P)=>{var Z=Gm(),fe=d(Z),me=d(fe),ye=d(me),xe=f(me,2),Ae=d(xe),$e=f(xe,2);{var Ze=tt=>{var Dt=Wm(),Et=d(Dt);Y(()=>M(Et,o(P).context)),T(tt,Dt)};H($e,tt=>{o(P).context&&tt(Ze)})}var Ge=f(fe,2),Je=d(Ge);Je.__input=tt=>u(o(P).id,tt.currentTarget.value);var ct=f(Je,2),Ce=d(ct);Ce.__click=()=>h(o(P).id);var ft=f(Ce,2);ft.__click=()=>v(o(P).id);var Be=f(ct,2),et=d(Be);Y(()=>{M(ye,o(P).label),M(Ae,o(P).description),Xi(Je,o(l)[o(P).id]??""),M(et,`Default: ${(o(P).defaultHotkey||"Unassigned")??""}`)}),T(I,Z)});var ae=f(Q,2);ae.__click=p,T(D,q)};H(le,D=>{o(a)==="shortcuts"&&D(U)},!0)}T(_e,Pe)};H(de,_e=>{o(a)==="statuses"?_e(ue):_e(Ee,!1)},!0)}T(ee,pe)};H(C,ee=>{o(a)==="filter"?ee(B):ee(se,!1)},!0)}T($,F)};H(J,$=>{o(a)==="general"?$(re):$(te,!1)})}var oe=f(E,2);{var ge=$=>{var F=Vm(),C=d(F);C.__click=m,T($,F)};H(oe,$=>{o(a)==="general"&&$(ge)})}Y(()=>{Ke(O,1,`settings__nav-btn ${o(a)==="general"?"active":""}`,"svelte-1ke3hir"),Ke(L,1,`settings__nav-btn ${o(a)==="filter"?"active":""}`,"svelte-1ke3hir"),Ke(R,1,`settings__nav-btn ${o(a)==="statuses"?"active":""}`,"svelte-1ke3hir"),Ke(W,1,`settings__nav-btn ${o(a)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),T(s,_),lt()}mt(["click","input"]);var Xm=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Jm=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),ey=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ty=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ny=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),sy=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ry=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ay=A('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>Blocking</button> <button>High Priority</button></div>'),iy=A('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">📥 Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">📋 Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">📅 Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">✅ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">📁 Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">🔍 Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">📝 All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button> <button id="dashboard-tab-insights" role="tab" aria-controls="dashboard-panel">💡 Insights</button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),oy=A('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">⚙️ Settings</button></div></div> <!></div>');function ly(s,e){ot(e,!0),pd(ro,e.settingsService.get().urgency);const t=e.scheduler.getTimezoneHandler(),n=e.scheduler.getRecurrenceEngine();let r=G("today"),a=G(!1),i=G(!1),l=G(void 0),c=G(De(new Set)),u=G(De([])),h=V(()=>Rh(o(u))),v=G(!1);const p=V(()=>["inbox","today","upcoming","done","projects","search","all","insights"].includes(o(r))?`dashboard-tab-${o(r)}`:void 0),m=V(()=>()=>{let D=o(u);if(o(c).has("notDone")&&(D=D.filter(q=>q.status!=="done"&&q.status!=="cancelled")),o(c).has("dueToday")){const q=new Date;q.setHours(0,0,0,0);const Q=new Date(q);Q.setDate(Q.getDate()+1),D=D.filter(ae=>{if(!ae.dueAt)return!1;const I=new Date(ae.dueAt);return I>=q&&I<Q})}if(o(c).has("overdue")){const q=new Date;q.setHours(0,0,0,0),D=D.filter(Q=>!Q.dueAt||Q.status==="done"||Q.status==="cancelled"?!1:new Date(Q.dueAt)<q)}return o(c).has("inProgress")&&(D=D.filter(q=>q.status==="todo"&&q.statusSymbol&&q.statusSymbol!==" ")),o(c).has("blocked")&&(D=D.filter(q=>Ih(q,o(u)))),o(c).has("blocking")&&(D=D.filter(q=>Mh(q,o(u)))),o(c).has("highPriority")&&(D=D.filter(q=>{const Q=hr(q.priority)||"normal";return Q==="high"||Q==="highest"})),D}),k=V(()=>o(u).filter(D=>D.status!=="done"&&D.status!=="cancelled"&&!D.dueAt&&!D.scheduledAt&&!D.startAt).length),_=V(()=>()=>{const D=new Date;D.setHours(0,0,0,0);const q=new Date(D);return q.setDate(q.getDate()+7),o(u).filter(Q=>{if(Q.status==="done"||Q.status==="cancelled"||!Q.dueAt)return!1;const ae=new Date(Q.dueAt);return ae.setHours(0,0,0,0),ae>D&&ae<=q}).length}),g=V(()=>()=>{const D=new Date;return D.setDate(D.getDate()-30),D.setHours(0,0,0,0),o(u).filter(q=>q.status!=="done"||!q.doneAt?!1:new Date(q.doneAt)>=D).length}),w=V(()=>o(u).filter(D=>D.status!=="done"&&D.status!=="cancelled").length);function S(D="initial"){b(v,!0),b(u,e.repository.getAllTasks().map(q=>({...q})),!0),b(v,!1),D!=="initial"&&K.info("Task list reloaded")}S();const E=()=>S("reload");Yr(()=>{window.addEventListener("recurring-task-refresh",E)}),hh(()=>{window.removeEventListener("recurring-task-refresh",E)});async function x(D){He.emit("task: complete",{taskId:D.id})}async function O(D){const q=o(u),Q=Ga(o(u),D.id,ae=>{const I={...ae},P=new Date(I.dueAt),Z=t.tomorrow();return Z.setHours(P.getHours(),P.getMinutes(),0,0),I.dueAt=Z.toISOString(),I.snoozeCount=(I.snoozeCount||0)+1,I.updatedAt=new Date().toISOString(),I});b(u,Q,!0),K.info(`Task "${D.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",D),await e.scheduler.delayToTomorrow(D.id)}catch(ae){b(u,q,!0),K.error("Failed to delay task:  "+ae),S("external")}}async function L(D){var Q;if(!((Q=D.name)!=null&&Q.trim())){K.error("Task name is required");return}if(!Uc(D.frequency)){K.error("Invalid frequency configuration");return}const q={...D};b(u,ea(o(u),q),!0),b(a,!1),b(l,void 0),K.success(`Task "${D.name}" saved successfully`),e.repository.saveTask(q).catch(ae=>{K.error("Failed to save task: "+ae),S("external")})}async function R(D){const q=o(u);b(u,Vo(o(u),D.id),!0);const Q=window.setTimeout(async()=>{try{await e.repository.deleteTask(D.id)}catch(ae){b(u,q,!0),K.error("Failed to delete task: "+ae),S("external")}},5e3);Ts({message:`Task "${D.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(Q),b(u,q,!0),K.info(`Restored "${D.name}"`)},showCountdown:!0})}async function W(D){const q=D.name.endsWith(" (copy)")?`${D.name} ${new Date().toLocaleDateString()}`:`${D.name} (copy)`,Q=jc(D,{name:q});b(u,ea(o(u),Q),!0),K.success(`Duplicated "${D.name}"`),e.repository.saveTask(Q).catch(ae=>{b(u,Vo(o(u),Q.id),!0),K.error("Failed to duplicate task: "+ae),S("external")})}async function j(D){const q=!D.enabled,Q={...D,enabled:q},ae=Ga(o(u),D.id,()=>Q);b(u,ae,!0),K.info(`Task ${q?"enabled":"disabled"}`),e.repository.saveTask(Q).catch(I=>{K.error("Failed to update task: "+I),S("external")})}async function J(D,q){if(D.length===0)return;const Q=o(u),ae=new Set(D),I=o(u).map(P=>ae.has(P.id)?{...P,enabled:q}:P);b(u,I,!0),K.info(`${q?"Enabled":"Disabled"} ${D.length} task${D.length===1?"":"s"}`);try{const P=I.filter(Z=>ae.has(Z.id));await Promise.all(P.map(Z=>e.repository.saveTask(Z)))}catch(P){b(u,Q,!0),K.error(`Failed to ${q?"enable":"disable"} tasks: ${P}`),S("external")}}async function re(D){if(D.length===0)return;const q=o(u),Q=new Set(D),ae=o(u).filter(P=>Q.has(P.id));b(u,o(u).filter(P=>!Q.has(P.id)),!0);const I=window.setTimeout(async()=>{try{await Promise.all(ae.map(P=>e.repository.deleteTask(P.id)))}catch(P){b(u,q,!0),K.error("Failed to delete tasks: "+P),S("external")}},5e3);Ts({message:`${ae.length} task${ae.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(I),b(u,q,!0),K.info("Bulk delete undone")},showCountdown:!0})}function te(D){b(l,D,!0),b(a,!0)}function oe(){b(l,void 0),b(a,!0)}function ge(){b(a,!1),b(l,void 0)}function $(){b(i,!0)}function F(){b(i,!1)}async function C(D){const q=o(u),Q=Ga(o(u),D.id,ae=>{const I={...ae};Hc(I);const P=n.calculateNext(new Date(I.dueAt),I.frequency);return I.dueAt=P.toISOString(),I});b(u,Q,!0),K.info(`Task "${D.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",D),await e.scheduler.skipTaskOccurrence(D.id)}catch(ae){b(u,q,!0),K.error("Failed to skip task: "+ae),S("external")}}function B(D){const q=new Set(o(c));q.has(D)?q.delete(D):q.add(D),b(c,q,!0)}async function se(D){const q={...D,status:"todo",doneAt:void 0};b(u,ea(o(u),q),!0),K.success(`Task "${D.name}" marked as not done`),e.repository.saveTask(q).catch(Q=>{K.error("Failed to update task: "+Q),S("external")})}var ee=oy(),pe=d(ee),de=f(d(pe),2),ue=d(de);ue.__click=()=>S("reload");var Ee=d(ue),_e=f(ue,2);_e.__click=$;var Pe=f(pe,2);{var le=D=>{var q=Xm(),Q=d(q);Zm(Q,{get eventService(){return e.eventService},get shortcutManager(){return e.shortcutManager},get settingsService(){return e.settingsService},get repository(){return e.repository},onClose:F}),T(D,q)},U=D=>{var q=ht(),Q=Ve(q);{var ae=P=>{var Z=Jm(),fe=d(Z);lu(fe,{get task(){return o(l)},get repository(){return e.repository},onSave:L,onClose:ge}),T(P,Z)},I=P=>{var Z=iy(),fe=Ve(Z),me=d(fe);me.__click=()=>b(r,"inbox");var ye=f(d(me));{var xe=ke=>{var Ie=ey(),Le=d(Ie);Y(()=>M(Le,o(k))),T(ke,Ie)};H(ye,ke=>{o(k)>0&&ke(xe)})}var Ae=f(me,2);Ae.__click=()=>b(r,"today");var $e=f(d(Ae));{var Ze=ke=>{var Ie=ty(),Le=d(Ie);Y(()=>M(Le,o(h).length)),T(ke,Ie)};H($e,ke=>{o(h).length>0&&ke(Ze)})}var Ge=f(Ae,2);Ge.__click=()=>b(r,"upcoming");var Je=f(d(Ge));{var ct=ke=>{var Ie=ny(),Le=d(Ie);Y(()=>M(Le,o(_))),T(ke,Ie)};H(Je,ke=>{o(_)>0&&ke(ct)})}var Ce=f(Ge,2);Ce.__click=()=>b(r,"done");var ft=f(d(Ce));{var Be=ke=>{var Ie=sy(),Le=d(Ie);Y(()=>M(Le,o(g))),T(ke,Ie)};H(ft,ke=>{o(g)>0&&ke(Be)})}var et=f(Ce,2);et.__click=()=>b(r,"projects");var tt=f(d(et));{var Dt=ke=>{var Ie=ry(),Le=d(Ie);Y(()=>M(Le,o(w))),T(ke,Ie)};H(tt,ke=>{o(w)>0&&ke(Dt)})}var Et=f(et,2);Et.__click=()=>b(r,"search");var Bt=f(Et,2);Bt.__click=()=>b(r,"all");var ie=f(d(Bt)),ce=d(ie),Se=f(Bt,2);Se.__click=()=>b(r,"insights");var ut=f(fe,2);{var Pn=ke=>{var Ie=ay(),Le=f(d(Ie),2);Le.__click=()=>B("notDone");var bt=f(Le,2);bt.__click=()=>B("dueToday");var Yt=f(bt,2);Yt.__click=()=>B("overdue");var xt=f(Yt,2);xt.__click=()=>B("inProgress");var Qt=f(xt,2);Qt.__click=()=>B("blocked");var At=f(Qt,2);At.__click=()=>B("blocking");var jt=f(At,2);jt.__click=()=>B("highPriority"),Y((Zn,Zt,mn,Xt,z,ve,st)=>{Ke(Le,1,`dashboard__filter-btn ${Zn??""}`,"svelte-1y1a8hs"),Ke(bt,1,`dashboard__filter-btn ${Zt??""}`,"svelte-1y1a8hs"),Ke(Yt,1,`dashboard__filter-btn ${mn??""}`,"svelte-1y1a8hs"),Ke(xt,1,`dashboard__filter-btn ${Xt??""}`,"svelte-1y1a8hs"),Ke(Qt,1,`dashboard__filter-btn ${z??""}`,"svelte-1y1a8hs"),Ke(At,1,`dashboard__filter-btn ${ve??""}`,"svelte-1y1a8hs"),Ke(jt,1,`dashboard__filter-btn ${st??""}`,"svelte-1y1a8hs")},[()=>o(c).has("notDone")?"active":"",()=>o(c).has("dueToday")?"active":"",()=>o(c).has("overdue")?"active":"",()=>o(c).has("inProgress")?"active":"",()=>o(c).has("blocked")?"active":"",()=>o(c).has("blocking")?"active":"",()=>o(c).has("highPriority")?"active":""]),T(ke,Ie)};H(ut,ke=>{o(r)!=="search"&&o(r)!=="timeline"&&o(r)!=="analytics"&&o(r)!=="insights"&&ke(Pn)})}var ne=f(ut,2),we=d(ne);{var Ye=ke=>{{let Ie=V(()=>o(c).size>0?o(m):o(u));Uf(ke,{get tasks(){return o(Ie)},onEdit:te,onDone:x,onDelete:R})}},nt=ke=>{var Ie=ht(),Le=Ve(Ie);{var bt=xt=>{{let Qt=V(()=>o(c).size>0?o(m).filter(At=>o(h).some(jt=>jt.id===At.id)):o(h));af(xt,{get tasks(){return o(Qt)},onDone:x,onDelay:O,onSkip:C,onEdit:te,get timezoneHandler(){return t}})}},Yt=xt=>{var Qt=ht(),At=Ve(Qt);{var jt=Zt=>{{let mn=V(()=>o(c).size>0?o(m):o(u));Hf(Zt,{get tasks(){return o(mn)},onEdit:te,onDone:x,onDelete:R})}},Zn=Zt=>{var mn=ht(),Xt=Ve(mn);{var z=st=>{{let rn=V(()=>o(c).size>0?o(m):o(u));Zf(st,{get tasks(){return o(rn)},onEdit:te,onDelete:R,onUncomplete:se})}},ve=st=>{var rn=ht(),an=Ve(rn);{var Us=zs=>{{let $r=V(()=>o(c).size>0?o(m):o(u));sv(zs,{get tasks(){return o($r)},onEdit:te,onDone:x,onDelete:R})}},_u=zs=>{var $r=ht(),ku=Ve($r);{var wu=Bs=>{Bp(Bs,{get tasks(){return o(u)},onEdit:te,onDone:x,onDelete:R})},Tu=Bs=>{var go=ht(),Su=Ve(go);{var Du=Ys=>{{let Wr=V(()=>o(c).size>0?o(m):o(u));gf(Ys,{get tasks(){return o(Wr)},onEdit:te,onDelete:R,onDuplicate:W,onToggleEnabled:j,onBulkEnable:wr=>J(wr,!0),onBulkDisable:wr=>J(wr,!1),onBulkDelete:re,onCreate:oe})}},Eu=Ys=>{var Wr=ht(),wr=Ve(Wr);{var xu=js=>{Sf(js,{get tasks(){return o(u)},get recurrenceEngine(){return n}})},Au=js=>{var po=ht(),Cu=Ve(po);{var Iu=Hs=>{Pf(Hs,{get tasks(){return o(u)}})},Mu=Hs=>{var mo=ht(),Ou=Ve(mo);{var Nu=La=>{Jp(La,{get tasks(){return o(u)},onApplySuggestion:async(Gr,Ua)=>{const yo={...Gr,frequency:Ua.suggestedSchedule.frequency,dueAt:Ua.suggestedSchedule.time?(()=>{const Kr=new Date(Gr.dueAt),[Ru,Pu]=Ua.suggestedSchedule.time.split(":").map(Number);return Kr.setHours(Ru,Pu||0,0,0),Kr.toISOString()})():Gr.dueAt,updatedAt:new Date().toISOString()};b(u,ea(o(u),yo),!0),K.success(`Schedule updated for "${Gr.name}"`);try{await e.repository.saveTask(yo)}catch(Kr){K.error("Failed to save schedule update: "+Kr),S("external")}}})};H(Ou,La=>{o(r)==="insights"&&La(Nu)},!0)}T(Hs,mo)};H(Cu,Hs=>{o(r)==="analytics"?Hs(Iu):Hs(Mu,!1)},!0)}T(js,po)};H(wr,js=>{o(r)==="timeline"?js(xu):js(Au,!1)},!0)}T(Ys,Wr)};H(Su,Ys=>{o(r)==="all"?Ys(Du):Ys(Eu,!1)},!0)}T(Bs,go)};H(ku,Bs=>{o(r)==="search"?Bs(wu):Bs(Tu,!1)},!0)}T(zs,$r)};H(an,zs=>{o(r)==="projects"?zs(Us):zs(_u,!1)},!0)}T(st,rn)};H(Xt,st=>{o(r)==="done"?st(z):st(ve,!1)},!0)}T(Zt,mn)};H(At,Zt=>{o(r)==="upcoming"?Zt(jt):Zt(Zn,!1)},!0)}T(xt,Qt)};H(Le,xt=>{o(r)==="today"?xt(bt):xt(Yt,!1)},!0)}T(ke,Ie)};H(we,ke=>{o(r)==="inbox"?ke(Ye):ke(nt,!1)})}Y(()=>{Ke(me,1,`dashboard__tab ${o(r)==="inbox"?"active":""}`,"svelte-1y1a8hs"),Me(me,"aria-selected",o(r)==="inbox"),Ke(Ae,1,`dashboard__tab ${o(r)==="today"?"active":""}`,"svelte-1y1a8hs"),Me(Ae,"aria-selected",o(r)==="today"),Ke(Ge,1,`dashboard__tab ${o(r)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),Me(Ge,"aria-selected",o(r)==="upcoming"),Ke(Ce,1,`dashboard__tab ${o(r)==="done"?"active":""}`,"svelte-1y1a8hs"),Me(Ce,"aria-selected",o(r)==="done"),Ke(et,1,`dashboard__tab ${o(r)==="projects"?"active":""}`,"svelte-1y1a8hs"),Me(et,"aria-selected",o(r)==="projects"),Ke(Et,1,`dashboard__tab ${o(r)==="search"?"active":""}`,"svelte-1y1a8hs"),Me(Et,"aria-selected",o(r)==="search"),Ke(Bt,1,`dashboard__tab ${o(r)==="all"?"active":""}`,"svelte-1y1a8hs"),Me(Bt,"aria-selected",o(r)==="all"),M(ce,o(u).length),Ke(Se,1,`dashboard__tab ${o(r)==="insights"?"active":""}`,"svelte-1y1a8hs"),Me(Se,"aria-selected",o(r)==="insights"),Me(ne,"aria-labelledby",o(p))}),T(P,Z)};H(Q,P=>{o(a)?P(ae):P(I,!1)},!0)}T(D,q)};H(Pe,D=>{o(i)?D(le):D(U,!1)})}Y(()=>{ue.disabled=o(v),M(Ee,o(v)?"⟳":"↻")}),T(s,ee),lt()}mt(["click"]);var cy=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),uy=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),dy=A('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),hy=A('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),fy=A('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">✕</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ⌘/Ctrl + Enter to save.</p></div></div>');function vy(s,e){var F;ot(e,!0);let t=G(De(((F=e.prefill)==null?void 0:F.suggestedName)??"")),n=G(De(new Date().toISOString().slice(0,16))),r=G(De({name:!1,dueAt:!1})),a=G(!1),i=G(null);const l=V(()=>o(r).name&&!o(t).trim()?"Task name is required.":""),c=V(()=>o(r).dueAt?o(n)?Number.isNaN(new Date(o(n)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=V(()=>!!(o(l)||o(c)));Yr(()=>{var C;if((C=e.prefill)!=null&&C.suggestedTime){const B=new Date,[se,ee]=e.prefill.suggestedTime.split(":").map(Number);B.setHours(se,ee,0,0),b(n,B.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var B;(B=o(i))==null||B.focus()})});async function h(){var ee,pe;if(b(r,{name:!0,dueAt:!0},!0),o(u)){K.warning("Please fill out the required fields.");return}const C=vh(),B=o(n).slice(11,16);if(C.time=B,!Uc(C)){K.error("Invalid frequency configuration.");return}const se=Bc(o(t).trim(),C,new Date(o(n)));se.linkedBlockId=((ee=e.prefill)==null?void 0:ee.linkedBlockId)||void 0,se.linkedBlockContent=((pe=e.prefill)==null?void 0:pe.linkedBlockContent)||void 0,b(a,!0);try{await e.repository.saveTask(se),K.success(`Task "${se.name}" created`),He.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(de){K.error("Failed to create task: "+de)}finally{b(a,!1)}}function v(C){C.key==="Escape"&&e.onClose(),(C.metaKey||C.ctrlKey)&&C.key==="Enter"&&(C.preventDefault(),h())}var p=fy();p.__keydown=v;var m=d(p),k=d(m),_=f(d(k),2);_.__click=function(...C){var B;(B=e.onClose)==null||B.apply(this,C)};var g=f(k,2),w=f(d(g),2);w.__input=()=>o(r).name=!0,Tn(w,C=>b(i,C),()=>o(i));var S=f(w,2);{var E=C=>{var B=cy(),se=d(B);Y(()=>M(se,o(l))),T(C,B)};H(S,C=>{o(l)&&C(E)})}var x=f(g,2),O=f(d(x),2);O.__input=()=>o(r).dueAt=!0;var L=f(O,2);{var R=C=>{var B=uy(),se=d(B);Y(()=>M(se,o(c))),T(C,B)};H(L,C=>{o(c)&&C(R)})}var W=f(x,2);{var j=C=>{var B=dy(),se=f(d(B)),ee=d(se);Y(()=>M(ee,e.prefill.linkedBlockId)),T(C,B)};H(W,C=>{var B;(B=e.prefill)!=null&&B.linkedBlockId&&C(j)})}var J=f(W,2),re=d(J);re.__click=function(...C){var B;(B=e.onClose)==null||B.apply(this,C)};var te=f(re,2);{var oe=C=>{var B=hy();B.__click=function(...se){var ee;(ee=e.onAdvanced)==null||ee.apply(this,se)},T(C,B)};H(te,C=>{e.onAdvanced&&C(oe)})}var ge=f(te,2);ge.__click=h;var $=d(ge);Y(()=>{Me(w,"aria-invalid",!!o(l)),Me(O,"aria-invalid",!!o(c)),ge.disabled=o(a),M($,o(a)?"Saving…":"Create Task")}),Ot("blur",w,()=>o(r).name=!0),gt(w,()=>o(t),C=>b(t,C)),Ot("blur",O,()=>o(r).dueAt=!0),gt(O,()=>o(n),C=>b(n,C)),T(s,p),lt()}mt(["keydown","click","input"]);var gy=A('<button class="postpone-card__option svelte-tkdeu6" type="button" role="listitem"> </button>'),py=A('<div class="postpone-overlay svelte-tkdeu6" role="dialog" aria-modal="true" aria-labelledby="postpone-title"><div class="postpone-card svelte-tkdeu6" role="document"><div class="postpone-card__header svelte-tkdeu6"><h2 id="postpone-title" class="svelte-tkdeu6">Postpone task</h2> <button class="postpone-card__close svelte-tkdeu6" type="button" aria-label="Close">✕</button></div> <p class="postpone-card__summary svelte-tkdeu6">Choose a new due offset for <strong> </strong>.</p> <div class="postpone-card__options svelte-tkdeu6" role="list"></div> <div class="postpone-card__actions svelte-tkdeu6"><button class="postpone-card__cancel svelte-tkdeu6" type="button">Cancel</button></div></div></div>');function my(s,e){ot(e,!0);let t=G(null);function n(_,g){g&&b(t,_,!0)}Yr(()=>{requestAnimationFrame(()=>{var _;(_=o(t))==null||_.focus()})});function r(_){_.key==="Escape"&&e.onClose()}var a=py();a.__keydown=r;var i=d(a),l=d(i),c=f(d(l),2);c.__click=function(..._){var g;(g=e.onClose)==null||g.apply(this,_)};var u=f(l,2),h=f(d(u)),v=d(h),p=f(u,2);Fe(p,21,()=>_h,it,(_,g,w)=>{var S=gy();S.__click=()=>e.onSelect(o(g).minutes);var E=d(S);th(S,(x,O)=>n==null?void 0:n(x,O),()=>w===0),Y(()=>M(E,o(g).label)),T(_,S)});var m=f(p,2),k=d(m);k.__click=function(..._){var g;(g=e.onClose)==null||g.apply(this,_)},Y(()=>M(v,e.taskName)),T(s,a),lt()}mt(["keydown","click"]);class yy{constructor(e){y(this,"plugin");this.plugin=e}getCurrentVersion(){return es}async createBackup(e,t){try{const n=await this.plugin.loadData(e);if(n){const r=new Date().toISOString().replace(/[:.]/g,"-"),a=t!==void 0?`v${t}`:"unknown",i=`${e}-backup-${a}-${r}`;return await this.plugin.saveData(i,n),he(`Created backup: ${i}`),i}throw new Error("No data to backup")}catch(n){throw Te("Failed to create backup",n),n}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return he("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:es};const n=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(n.length===0)return he("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:es};let r=!1,a,i,l=0;for(let c=0;c<n.length;c++){const u=n[c],h=u.version||0;h<es&&(r||(i=h,a=await this.createBackup(e,h),r=!0),n[c]=this.migrateTask(u,h),l++,he(`Migrated task ${u.id} from v${h} to v${es}`))}if(r){const c=Array.isArray(t)?n:{...t,tasks:n};return await this.plugin.saveData(e,c),he(`Migration complete: ${l} tasks migrated`),{migrated:!0,tasksAffected:l,fromVersion:i,toVersion:es,backupKey:a}}else return he("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:es}}catch(t){throw Te("Migration failed",t),t}}migrateTask(e,t){let n={...e};return t<1&&(n.version=1),t<2&&(n={...n,version:2,timezone:n.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:n.completionCount||0,missCount:n.missCount||0,currentStreak:n.currentStreak||0,bestStreak:n.bestStreak||0,recentCompletions:n.recentCompletions||[],priority:n.priority||"normal",tags:n.tags||[],notificationChannels:n.notificationChannels||[],snoozeCount:n.snoozeCount||0,maxSnoozes:n.maxSnoozes||3}),t<3&&(n={...n,version:3,escalationPolicy:n.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:n.linkedBlockContent||void 0,category:n.category||void 0,description:n.description||void 0}),t<4&&(n={...n,version:4,onCompletion:n.onCompletion||"keep",dependsOn:n.dependsOn||[],blockedBy:n.blockedBy||[]}),n}}class by{constructor(e,t=50){y(this,"pendingState",null);y(this,"writeInProgress",!1);y(this,"scheduledTimer",null);y(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){Te("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return Te("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const Di={},_y=Object.freeze(Object.defineProperty({__proto__:null,default:Di},Symbol.toStringTag,{value:"Module"})),wl=new Set;function ca(s){const e=`${s.feature}:${s.capability}:${s.message}`;wl.has(e)||(wl.add(e),at(s.message,{feature:s.feature,capability:s.capability,cause:s.cause}))}class cu extends Error{constructor(t,n,r){super(r);y(this,"capability");y(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=n}}class uu extends Error{constructor(t,n,r,a){super(r);y(this,"capability");y(this,"feature");y(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=n,this.cause=a}}class ky{constructor(e=globalThis){y(this,"supportedCapabilities");y(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,n,r;return typeof((r=(n=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:n.system)==null?void 0:r.dataDir)=="string"}getDataDir(){var e,t,n;return this.isDataDirAvailable()?((n=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:n.dataDir)??null:null}async setBlockAttrs(e,t){const n=this.getSetBlockAttrs();try{await n(e,t)}catch(r){throw new uu("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",r)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new cu("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const wy=".tmp";class Ty{constructor(e,t){y(this,"plugin");y(this,"apiAdapter");y(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(ws);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){Te("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),he(`Saved ${e.tasks.length} active tasks`)}catch(t){throw Te("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(ws,e);return}const n=this.resolveStoragePath(ws);if(!n){await this.plugin.saveData(ws,e);return}const r=Di.dirname(n);await t.mkdir(r,{recursive:!0});const a=`${n}${wy}`,i=JSON.stringify(e),l=await t.open(a,"w");try{await l.writeFile(i,"utf8"),await l.sync()}finally{await l.close()}try{await t.rename(a,n)}catch{await t.rm(n,{force:!0}),await t.rename(a,n)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>_y);return this.fsPromises=e.promises,this.fsPromises}catch(e){return at("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),n=this.plugin.name;return!t||!n?(t||ca({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):Di.join(t,"storage",`p${n}`,`${e}.json`)}}const Tl=1,Sl=1e3;class Sy{constructor(e){y(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),n=this.groupByYear(e);for(const[r,a]of n.entries())await this.appendTasksToYear(t,r,a);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const n=this.filterChunks(t.chunks,e),r=[];for(const l of n){const c=await this.loadChunk(l.key);if(c)for(const u of c.tasks)this.matchesQuery(u,e)&&r.push(u)}const a=(e==null?void 0:e.offset)??0,i=(e==null?void 0:e.limit)??r.length;return r.slice(a,a+i)}async loadIndex(){try{const e=await this.plugin.loadData(ia);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??Tl,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){Te("Failed to load archive index",e)}return{version:Tl,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(ia,e)}catch(t){throw Te("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${ia}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){Te("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(n){throw Te("Failed to save archive chunk",{key:e,err:n}),n}}groupByYear(e){const t=new Map;for(const n of e){const r=this.getCompletionTimestamp(n),a=new Date(r).getFullYear(),i=t.get(a);i?i.push(n):t.set(a,[n])}return t}async appendTasksToYear(e,t,n){let r=[...n];for(;r.length>0;){const a=this.findOrCreateChunk(e,t),i=await this.loadChunk(a.key)||{tasks:[]},l=Sl-i.tasks.length,c=r.slice(0,l);i.tasks.push(...c),r=r.slice(c.length);const u=this.updateChunkMeta(a,c);a.count=u.count,a.start=u.start,a.end=u.end,await this.saveChunk(a.key,i),e.totalCount+=c.length}}findOrCreateChunk(e,t){const r=e.chunks.filter(l=>l.year===t).sort((l,c)=>l.sequence-c.sequence).at(-1);if(r&&r.count<Sl)return r;const a=r?r.sequence+1:1,i={key:this.buildChunkKey(t,a),year:t,sequence:a,count:0};return e.chunks.push(i),i}updateChunkMeta(e,t){let n=e.start,r=e.end;for(const a of t){const i=this.getCompletionTimestamp(a);(!n||i<n)&&(n=i),(!r||i>r)&&(r=i)}return{...e,count:e.count+t.length,start:n,end:r}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const n=t!=null&&t.from?new Date(t.from).getTime():null,r=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(a=>{const i=a.start?new Date(a.start).getTime():null,l=a.end?new Date(a.end).getTime():null;return!(n&&l&&l<n||r&&i&&i>r)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const n=this.getCompletionTimestamp(e),r=new Date(n).getTime();return!(t.from&&r<new Date(t.from).getTime()||t.to&&r>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Dy{constructor(e,t=new ky){y(this,"plugin");y(this,"activeTasks");y(this,"blockIndex",new Map);y(this,"taskBlockIndex",new Map);y(this,"dueIndex",new Map);y(this,"activeStore");y(this,"archiveStore");y(this,"persistence");y(this,"blockAttrSyncEnabled",!0);y(this,"blockApi");y(this,"apiAdapter");y(this,"syncRetryQueue",new Map);y(this,"retryProcessorInterval");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Ty(e,t),this.archiveStore=new Sy(e),this.persistence=new by(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),he(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex(),this.startSyncRetryProcessor()}async loadActiveTasks(e=1e3,t){const n=await this.activeStore.loadActive(),r=Array.from(n.values()),a=r.length;if(a===0)return[];const i=[];for(let l=0;l<a;l+=e){const c=r.slice(l,Math.min(l+e,a));i.push(...c),t&&t(i.length,a),await new Promise(u=>setTimeout(u,0))}return i}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));he(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);he(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),n=this.dueIndex.get(t);n&&(n.delete(e.id),n.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),n=[];for(const[r]of this.dueIndex)r<=t&&n.push(...this.getTasksForDueKey(r));return n}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const n=[];for(const r of t){const a=this.activeTasks.get(r);if(!a){this.removeStaleDueIndexEntry(e,r,"missing task");continue}if(!a.enabled){this.removeStaleDueIndexEntry(e,r,"task disabled");continue}if(a.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,r,"date mismatch");continue}n.push(a)}return n}removeStaleDueIndexEntry(e,t,n){const r=this.dueIndex.get(e);r&&(r.delete(t),r.size===0&&this.dueIndex.delete(e),at("Removed stale due index entry",{taskId:t,dateKey:e,reason:n}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id);if(t&&e.version!==void 0&&t.version!==void 0&&e.version<t.version)throw new Error(`Concurrent modification detected for task "${e.name}". Please refresh and try again.`);e.version=(e.version??0)+1;const n=this.activeTasks.get(e.id),r=this.taskBlockIndex.get(e.id);r&&r!==e.linkedBlockId&&(this.blockIndex.delete(r),this.taskBlockIndex.delete(e.id)),n&&n.enabled&&(n.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(n),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrsWithRetry(e),r&&r!==e.linkedBlockId&&await this.clearBlockAttrs(r)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Ho]:e.id,[$o]:e.dueAt,[Wo]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Ho]:"",[$o]:"",[Wo]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){ca({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(n){n instanceof cu||n instanceof uu?ca({feature:n.feature,capability:n.capability,message:n.message,cause:n.cause}):ca({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:n}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(n=>new Date(n.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(n=>{const r=new Date(n.dueAt);return r>=e&&r<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(ws);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(Ro);if(!t)return;const n=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(n.length===0)return;await this.plugin.saveData(Po,t),he(`Created legacy backup at ${Po}`);const r=n.filter(l=>!l.enabled&&l.lastCompletedAt),a=n.filter(l=>!r.includes(l)),i=new Map(a.map(l=>[l.id,l]));this.persistence.requestSave({tasks:Array.from(i.values())}),await this.persistence.flush(),r.length>0&&await this.archiveStore.archiveTasks(r),he("Legacy storage migration complete",{activeCount:a.length,archivedCount:r.length,legacyKey:Ro,activeKey:ws,archiveIndexKey:ia})}async syncTaskToBlockAttrsWithRetry(e){try{await this.syncTaskToBlockAttrs(e),this.syncRetryQueue.delete(e.id)}catch(t){const n=this.syncRetryQueue.get(e.id)||{task:e,attempts:0,nextRetry:Date.now()};n.attempts<Jr?(n.attempts++,n.nextRetry=Date.now()+Go[n.attempts-1],n.task=e,this.syncRetryQueue.set(e.id,n),at(`Block sync failed for task ${e.id}, added to retry queue`,{taskId:e.id,attempts:n.attempts,nextRetry:new Date(n.nextRetry).toISOString(),error:t instanceof Error?t.message:String(t)})):(Te(`Block sync failed for task ${e.id} after ${Jr} attempts`,{taskId:e.id,error:t instanceof Error?t.message:String(t)}),this.syncRetryQueue.delete(e.id))}}startSyncRetryProcessor(){this.retryProcessorInterval&&clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=setInterval(async()=>{const e=Date.now(),t=[];for(const[n,r]of this.syncRetryQueue.entries())r.nextRetry<=e&&t.push({id:n,entry:r});for(const{id:n,entry:r}of t)try{await this.syncTaskToBlockAttrs(r.task),this.syncRetryQueue.delete(n),he(`Block sync retry succeeded for task ${n}`,{taskId:n,attempts:r.attempts})}catch(a){r.attempts<Jr?(r.attempts++,r.nextRetry=Date.now()+Go[r.attempts-1],this.syncRetryQueue.set(n,r),at(`Block sync retry failed for task ${n}`,{taskId:n,attempts:r.attempts,nextRetry:new Date(r.nextRetry).toISOString(),error:a instanceof Error?a.message:String(a)})):(Te(`Block sync retry exhausted for task ${n} after ${Jr} attempts`,{taskId:n,error:a instanceof Error?a.message:String(a)}),this.syncRetryQueue.delete(n))}},Th)}stopSyncRetryProcessor(){this.retryProcessorInterval&&(clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=void 0)}}class Ey{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}var Ei=["MO","TU","WE","TH","FR","SA","SU"],Lt=function(){function s(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return s.fromStr=function(e){return new s(Ei.indexOf(e))},s.prototype.nth=function(e){return this.n===e?this:new s(this.weekday,e)},s.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},s.prototype.toString=function(){var e=Ei[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},s.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},s}(),pt=function(s){return s!=null},Dn=function(s){return typeof s=="number"},Dl=function(s){return typeof s=="string"&&Ei.includes(s)},tn=Array.isArray,Rn=function(s,e){e===void 0&&(e=s),arguments.length===1&&(e=s,s=0);for(var t=[],n=s;n<e;n++)t.push(n);return t},Ue=function(s,e){var t=0,n=[];if(tn(s))for(;t<e;t++)n[t]=[].concat(s);else for(;t<e;t++)n[t]=s;return n},xy=function(s){return tn(s)?s:[s]};function Ks(s,e,t){t===void 0&&(t=" ");var n=String(s);return e=e>>0,n.length>e?String(n):(e=e-n.length,e>t.length&&(t+=Ue(t,e/t.length)),t.slice(0,e)+String(n))}var Ay=function(s,e,t){var n=s.split(e);return t?n.slice(0,t).concat([n.slice(t).join(e)]):n},vn=function(s,e){var t=s%e;return t*e<0?t+e:t},Ja=function(s,e){return{div:Math.floor(s/e),mod:vn(s,e)}},Mn=function(s){return!pt(s)||s.length===0},kt=function(s){return!Mn(s)},Qe=function(s,e){return kt(s)&&s.indexOf(e)!==-1},qs=function(s,e,t,n,r,a){return n===void 0&&(n=0),r===void 0&&(r=0),a===void 0&&(a=0),new Date(Date.UTC(s,e-1,t,n,r,a))},Cy=[31,28,31,30,31,30,31,31,30,31,30,31],du=1e3*60*60*24,hu=9999,fu=qs(1970,1,1),Iy=[6,0,1,2,3,4,5],Ir=function(s){return s%4===0&&s%100!==0||s%400===0},vu=function(s){return s instanceof Date},Dr=function(s){return vu(s)&&!isNaN(s.getTime())},My=function(s,e){var t=s.getTime(),n=e.getTime(),r=t-n;return Math.round(r/du)},xi=function(s){return My(s,fu)},gu=function(s){return new Date(fu.getTime()+s*du)},Oy=function(s){var e=s.getUTCMonth();return e===1&&Ir(s.getUTCFullYear())?29:Cy[e]},gr=function(s){return Iy[s.getUTCDay()]},El=function(s,e){var t=qs(s,e+1,1);return[gr(t),Oy(t)]},pu=function(s,e){return e=e||s,new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Ai=function(s){var e=new Date(s.getTime());return e},xl=function(s){for(var e=[],t=0;t<s.length;t++)e.push(Ai(s[t]));return e},Pr=function(s){s.sort(function(e,t){return e.getTime()-t.getTime()})},co=function(s,e){e===void 0&&(e=!0);var t=new Date(s);return[Ks(t.getUTCFullYear().toString(),4,"0"),Ks(t.getUTCMonth()+1,2,"0"),Ks(t.getUTCDate(),2,"0"),"T",Ks(t.getUTCHours(),2,"0"),Ks(t.getUTCMinutes(),2,"0"),Ks(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},uo=function(s){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(s);if(!t)throw new Error("Invalid UNTIL value: ".concat(s));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},Al=function(s,e){var t=s.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},Ny=function(s,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,n=new Date(Al(s,t)),r=new Date(Al(s,e??"UTC")),a=r.getTime()-n.getTime();return new Date(s.getTime()-a)},Js=function(){function s(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return s.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,n=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(n)return!1}else if(this.method==="before"){if(n)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},s.prototype.add=function(e){return this._result.push(e),!0},s.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},s.prototype.clone=function(){return new s(this.method,this.args)},s}(),Ci=function(s,e){return Ci=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])},Ci(s,e)};function ho(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Ci(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var sn=function(){return sn=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},sn.apply(this,arguments)};function X(s,e,t){if(t||arguments.length===2)for(var n=0,r=e.length,a;n<r;n++)(a||!(n in e))&&(a||(a=Array.prototype.slice.call(e,0,n)),a[n]=e[n]);return s.concat(a||Array.prototype.slice.call(e))}var Cl=function(s){ho(e,s);function e(t,n,r){var a=s.call(this,t,n)||this;return a.iterator=r,a}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Js),ya={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},Il=function(s,e){return s.indexOf(e)!==-1},Ry=function(s){return s.toString()},Py=function(s,e,t){return"".concat(e," ").concat(t,", ").concat(s)},Qn=function(){function s(e,t,n,r){if(t===void 0&&(t=Ry),n===void 0&&(n=ya),r===void 0&&(r=Py),this.text=[],this.language=n||ya,this.gettext=t,this.dateFormatter=r,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var a=[].concat(this.options.bymonthday),i=[].concat(this.options.bynmonthday);a.sort(function(h,v){return h-v}),i.sort(function(h,v){return v-h}),this.bymonthday=a.concat(i),this.bymonthday.length||(this.bymonthday=null)}if(pt(this.origOptions.byweekday)){var l=tn(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],c=String(l);this.byweekday={allWeeks:l.filter(function(h){return!h.n}),someWeeks:l.filter(function(h){return!!h.n}),isWeekdays:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")===-1&&c.indexOf("SU")===-1,isEveryDay:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")!==-1&&c.indexOf("SU")!==-1};var u=function(h,v){return h.weekday-v.weekday};this.byweekday.allWeeks.sort(u),this.byweekday.someWeeks.sort(u),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return s.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in s.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var n in e.origOptions){if(Il(["dtstart","tzid","wkst","freq"],n))return!0;if(!Il(s.IMPLEMENTED[e.options.freq],n))return!1}return t},s.prototype.isFullyConvertible=function(){return s.isFullyConvertible(this.rrule)},s.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in s.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[be.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},s.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},s.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},s.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},s.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},s.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},s.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},s.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},s.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},s.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},s.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},s.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,n=this.gettext;if(e===-1)return n("last");var r=Math.abs(e);switch(r){case 1:case 21:case 31:t=r+n("st");break;case 2:case 22:t=r+n("nd");break;case 3:case 23:t=r+n("rd");break;default:t=r+n("th")}return e<0?t+" "+n("last"):t},s.prototype.monthtext=function(e){return this.language.monthNames[e-1]},s.prototype.weekdaytext=function(e){var t=Dn(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},s.prototype.plural=function(e){return e%100!==1},s.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},s.prototype.list=function(e,t,n,r){var a=this;r===void 0&&(r=","),tn(e)||(e=[e]);var i=function(c,u,h){for(var v="",p=0;p<c.length;p++)p!==0&&(p===c.length-1?v+=" "+h+" ":v+=u+" "),v+=c[p];return v};t=t||function(c){return c.toString()};var l=function(c){return t&&t.call(a,c)};return n?i(e.map(l),r,n):e.map(l).join(r+" ")},s}(),qy=function(){function s(e){this.done=!0,this.rules=e}return s.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},s.prototype.isDone=function(){return this.done&&this.symbol===null},s.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var n=void 0;e=null;for(var r in this.rules){n=this.rules[r];var a=n.exec(this.text);a&&(e===null||a[0].length>e[0].length)&&(e=a,t=r)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},s.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},s.prototype.acceptNumber=function(){return this.accept("number")},s.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},s}();function mu(s,e){e===void 0&&(e=ya);var t={},n=new qy(e.tokens);if(!n.start(s))return null;return r(),t;function r(){n.expect("every");var p=n.acceptNumber();if(p&&(t.interval=parseInt(p[0],10)),n.isDone())throw new Error("Unexpected end");switch(n.symbol){case"day(s)":t.freq=be.DAILY,n.nextSymbol()&&(i(),v());break;case"weekday(s)":t.freq=be.WEEKLY,t.byweekday=[be.MO,be.TU,be.WE,be.TH,be.FR],n.nextSymbol(),i(),v();break;case"week(s)":t.freq=be.WEEKLY,n.nextSymbol()&&(a(),i(),v());break;case"hour(s)":t.freq=be.HOURLY,n.nextSymbol()&&(a(),v());break;case"minute(s)":t.freq=be.MINUTELY,n.nextSymbol()&&(a(),v());break;case"month(s)":t.freq=be.MONTHLY,n.nextSymbol()&&(a(),v());break;case"year(s)":t.freq=be.YEARLY,n.nextSymbol()&&(a(),v());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=be.WEEKLY;var m=n.symbol.substr(0,2).toUpperCase();if(t.byweekday=[be[m]],!n.nextSymbol())return;for(;n.accept("comma");){if(n.isDone())throw new Error("Unexpected end");var k=c();if(!k)throw new Error("Unexpected symbol "+n.symbol+", expected weekday");t.byweekday.push(be[k]),n.nextSymbol()}i(),h(),v();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=be.YEARLY,t.bymonth=[l()],!n.nextSymbol())return;for(;n.accept("comma");){if(n.isDone())throw new Error("Unexpected end");var _=l();if(!_)throw new Error("Unexpected symbol "+n.symbol+", expected month");t.bymonth.push(_),n.nextSymbol()}a(),v();break;default:throw new Error("Unknown symbol")}}function a(){var p=n.accept("on"),m=n.accept("the");if(p||m)do{var k=u(),_=c(),g=l();if(k)_?(n.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(be[_].nth(k))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(k),n.accept("day(s)"));else if(_)n.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(be[_]);else if(n.symbol==="weekday(s)")n.nextSymbol(),t.byweekday||(t.byweekday=[be.MO,be.TU,be.WE,be.TH,be.FR]);else if(n.symbol==="week(s)"){n.nextSymbol();var w=n.acceptNumber();if(!w)throw new Error("Unexpected symbol "+n.symbol+", expected week number");for(t.byweekno=[parseInt(w[0],10)];n.accept("comma");){if(w=n.acceptNumber(),!w)throw new Error("Unexpected symbol "+n.symbol+"; expected monthday");t.byweekno.push(parseInt(w[0],10))}}else if(g)n.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(g);else return}while(n.accept("comma")||n.accept("the")||n.accept("on"))}function i(){var p=n.accept("at");if(p)do{var m=n.acceptNumber();if(!m)throw new Error("Unexpected symbol "+n.symbol+", expected hour");for(t.byhour=[parseInt(m[0],10)];n.accept("comma");){if(m=n.acceptNumber(),!m)throw new Error("Unexpected symbol "+n.symbol+"; expected hour");t.byhour.push(parseInt(m[0],10))}}while(n.accept("comma")||n.accept("at"))}function l(){switch(n.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function c(){switch(n.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return n.symbol.substr(0,2).toUpperCase();default:return!1}}function u(){switch(n.symbol){case"last":return n.nextSymbol(),-1;case"first":return n.nextSymbol(),1;case"second":return n.nextSymbol(),n.accept("last")?-2:2;case"third":return n.nextSymbol(),n.accept("last")?-3:3;case"nth":var p=parseInt(n.value[1],10);if(p<-366||p>366)throw new Error("Nth out of range: "+p);return n.nextSymbol(),n.accept("last")?-p:p;default:return!1}}function h(){n.accept("on"),n.accept("the");var p=u();if(p)for(t.bymonthday=[p],n.nextSymbol();n.accept("comma");){if(p=u(),!p)throw new Error("Unexpected symbol "+n.symbol+"; expected monthday");t.bymonthday.push(p),n.nextSymbol()}}function v(){if(n.symbol==="until"){var p=Date.parse(n.text);if(!p)throw new Error("Cannot parse until date:"+n.text);t.until=new Date(p)}else n.accept("for")&&(t.count=parseInt(n.value[0],10),n.expect("number"))}}var ze;(function(s){s[s.YEARLY=0]="YEARLY",s[s.MONTHLY=1]="MONTHLY",s[s.WEEKLY=2]="WEEKLY",s[s.DAILY=3]="DAILY",s[s.HOURLY=4]="HOURLY",s[s.MINUTELY=5]="MINUTELY",s[s.SECONDLY=6]="SECONDLY"})(ze||(ze={}));function fo(s){return s<ze.HOURLY}var Fy=function(s,e){return e===void 0&&(e=ya),new be(mu(s,e)||void 0)},kr=["count","until","interval","byweekday","bymonthday","bymonth"];Qn.IMPLEMENTED=[];Qn.IMPLEMENTED[ze.HOURLY]=kr;Qn.IMPLEMENTED[ze.MINUTELY]=kr;Qn.IMPLEMENTED[ze.DAILY]=["byhour"].concat(kr);Qn.IMPLEMENTED[ze.WEEKLY]=kr;Qn.IMPLEMENTED[ze.MONTHLY]=kr;Qn.IMPLEMENTED[ze.YEARLY]=["byweekno","byyearday"].concat(kr);var Ly=function(s,e,t,n){return new Qn(s,e,t,n).toString()},Uy=Qn.isFullyConvertible,ba=function(){function s(e,t,n,r){this.hour=e,this.minute=t,this.second=n,this.millisecond=r||0}return s.prototype.getHours=function(){return this.hour},s.prototype.getMinutes=function(){return this.minute},s.prototype.getSeconds=function(){return this.second},s.prototype.getMilliseconds=function(){return this.millisecond},s.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},s}(),zy=function(s){ho(e,s);function e(t,n,r,a,i,l,c){var u=s.call(this,a,i,l,c)||this;return u.year=t,u.month=n,u.day=r,u}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return gr(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var n=Math.floor(this.month/12),r=vn(this.month,12);this.month=r,this.year+=n,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,n){n>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-n))+t*7:this.day+=-(this.getWeekday()-n)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,n,r){for(n&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var a=Ja(this.hour,24),i=a.div,l=a.mod;if(i&&(this.hour=l,this.addDaily(i)),Mn(r)||Qe(r,this.hour))break}},e.prototype.addMinutes=function(t,n,r,a){for(n&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var i=Ja(this.minute,60),l=i.div,c=i.mod;if(l&&(this.minute=c,this.addHours(l,!1,r)),(Mn(r)||Qe(r,this.hour))&&(Mn(a)||Qe(a,this.minute)))break}},e.prototype.addSeconds=function(t,n,r,a,i){for(n&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var l=Ja(this.second,60),c=l.div,u=l.mod;if(c&&(this.second=u,this.addMinutes(c,!1,r,a)),(Mn(r)||Qe(r,this.hour))&&(Mn(a)||Qe(a,this.minute))&&(Mn(i)||Qe(i,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=El(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>hu))return;t=El(this.year,this.month-1)[1]}}},e.prototype.add=function(t,n){var r=t.freq,a=t.interval,i=t.wkst,l=t.byhour,c=t.byminute,u=t.bysecond;switch(r){case ze.YEARLY:return this.addYears(a);case ze.MONTHLY:return this.addMonths(a);case ze.WEEKLY:return this.addWeekly(a,i);case ze.DAILY:return this.addDaily(a);case ze.HOURLY:return this.addHours(a,n,l);case ze.MINUTELY:return this.addMinutes(a,n,l,c);case ze.SECONDLY:return this.addSeconds(a,n,l,c,u)}},e}(ba);function yu(s){for(var e=[],t=Object.keys(s),n=0,r=t;n<r.length;n++){var a=r[n];Qe(pb,a)||e.push(a),vu(s[a])&&!Dr(s[a])&&e.push(a)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return sn({},s)}function By(s){var e=sn(sn({},vo),yu(s));if(pt(e.byeaster)&&(e.freq=be.YEARLY),!(pt(e.freq)&&be.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(s.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),pt(e.wkst)?Dn(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=be.MO.weekday,pt(e.bysetpos)){Dn(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var n=e.bysetpos[t];if(n===0||!(n>=-366&&n<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||kt(e.byweekno)||kt(e.byyearday)||e.bymonthday||kt(e.bymonthday)||pt(e.byweekday)||pt(e.byeaster)))switch(e.freq){case be.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case be.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case be.WEEKLY:e.byweekday=[gr(e.dtstart)];break}if(pt(e.bymonth)&&!tn(e.bymonth)&&(e.bymonth=[e.bymonth]),pt(e.byyearday)&&!tn(e.byyearday)&&Dn(e.byyearday)&&(e.byyearday=[e.byyearday]),!pt(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(tn(e.bymonthday)){for(var r=[],a=[],t=0;t<e.bymonthday.length;t++){var n=e.bymonthday[t];n>0?r.push(n):n<0&&a.push(n)}e.bymonthday=r,e.bynmonthday=a}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(pt(e.byweekno)&&!tn(e.byweekno)&&(e.byweekno=[e.byweekno]),!pt(e.byweekday))e.bynweekday=null;else if(Dn(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(Dl(e.byweekday))e.byweekday=[Lt.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof Lt)!e.byweekday.n||e.freq>be.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var i=[],l=[],t=0;t<e.byweekday.length;t++){var c=e.byweekday[t];if(Dn(c)){i.push(c);continue}else if(Dl(c)){i.push(Lt.fromStr(c).weekday);continue}!c.n||e.freq>be.MONTHLY?i.push(c.weekday):l.push([c.weekday,c.n])}e.byweekday=kt(i)?i:null,e.bynweekday=kt(l)?l:null}return pt(e.byhour)?Dn(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<be.HOURLY?[e.dtstart.getUTCHours()]:null,pt(e.byminute)?Dn(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<be.MINUTELY?[e.dtstart.getUTCMinutes()]:null,pt(e.bysecond)?Dn(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<be.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function Yy(s){var e=s.dtstart.getTime()%1e3;if(!fo(s.freq))return[];var t=[];return s.byhour.forEach(function(n){s.byminute.forEach(function(r){s.bysecond.forEach(function(a){t.push(new ba(n,r,a,e))})})}),t}function Ii(s){var e=s.split(`
`).map(jy).filter(function(t){return t!==null});return sn(sn({},e[0]),e[1])}function _a(s){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(s);if(!t)return e;var n=t[1],r=t[2];return n&&(e.tzid=n),e.dtstart=uo(r),e}function jy(s){if(s=s.replace(/^\s+|\s+$/,""),!s.length)return null;var e=/^([A-Z]+?)[:;]/.exec(s.toUpperCase());if(!e)return Ml(s);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return Ml(s);case"DTSTART":return _a(s);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(s))}}function Ml(s){var e=s.replace(/^RRULE:/i,""),t=_a(e),n=s.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return n.forEach(function(r){var a=r.split("="),i=a[0],l=a[1];switch(i.toUpperCase()){case"FREQ":t.freq=ze[l.toUpperCase()];break;case"WKST":t.wkst=_n[l.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var c=Hy(l),u=i.toLowerCase();t[u]=c;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=$y(l);break;case"DTSTART":case"TZID":var h=_a(s);t.tzid=h.tzid,t.dtstart=h.dtstart;break;case"UNTIL":t.until=uo(l);break;case"BYEASTER":t.byeaster=Number(l);break;default:throw new Error("Unknown RRULE property '"+i+"'")}}),t}function Hy(s){if(s.indexOf(",")!==-1){var e=s.split(",");return e.map(Ol)}return Ol(s)}function Ol(s){return/^[+-]?\d+$/.test(s)?Number(s):s}function $y(s){var e=s.split(",");return e.map(function(t){if(t.length===2)return _n[t];var n=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!n||n.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var r=Number(n[1]),a=n[2],i=_n[a].weekday;return new Lt(i,r)})}var ka=function(){function s(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(s.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),s.prototype.toString=function(){var e=co(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},s.prototype.getTime=function(){return this.date.getTime()},s.prototype.rezonedDate=function(){return this.isUTC?this.date:Ny(this.date,this.tzid)},s}();function Mi(s){for(var e=[],t="",n=Object.keys(s),r=Object.keys(vo),a=0;a<n.length;a++)if(n[a]!=="tzid"&&Qe(r,n[a])){var i=n[a].toUpperCase(),l=s[n[a]],c="";if(!(!pt(l)||tn(l)&&!l.length)){switch(i){case"FREQ":c=be.FREQUENCIES[s.freq];break;case"WKST":Dn(l)?c=new Lt(l).toString():c=l.toString();break;case"BYWEEKDAY":i="BYDAY",c=xy(l).map(function(m){return m instanceof Lt?m:tn(m)?new Lt(m[0],m[1]):new Lt(m)}).toString();break;case"DTSTART":t=Wy(l,s.tzid);break;case"UNTIL":c=co(l,!s.tzid);break;default:if(tn(l)){for(var u=[],h=0;h<l.length;h++)u[h]=String(l[h]);c=u.toString()}else c=String(l)}c&&e.push([i,c])}}var v=e.map(function(m){var k=m[0],_=m[1];return"".concat(k,"=").concat(_.toString())}).join(";"),p="";return v!==""&&(p="RRULE:".concat(v)),[t,p].filter(function(m){return!!m}).join(`
`)}function Wy(s,e){return s?"DTSTART"+new ka(new Date(s),e).toString():""}function Gy(s,e){return Array.isArray(s)?!Array.isArray(e)||s.length!==e.length?!1:s.every(function(t,n){return t.getTime()===e[n].getTime()}):s instanceof Date?e instanceof Date&&s.getTime()===e.getTime():s===e}var Ky=function(){function s(){this.all=!1,this.before=[],this.after=[],this.between=[]}return s.prototype._cacheAdd=function(e,t,n){t&&(t=t instanceof Date?Ai(t):xl(t)),e==="all"?this.all=t:(n._value=t,this[e].push(n))},s.prototype._cacheGet=function(e,t){var n=!1,r=t?Object.keys(t):[],a=function(h){for(var v=0;v<r.length;v++){var p=r[v];if(!Gy(t[p],h[p]))return!0}return!1},i=this[e];if(e==="all")n=this.all;else if(tn(i))for(var l=0;l<i.length;l++){var c=i[l];if(!(r.length&&a(c))){n=c._value;break}}if(!n&&this.all){for(var u=new Js(e,t),l=0;l<this.all.length&&u.accept(this.all[l]);l++);n=u.getValue(),this._cacheAdd(e,n,t)}return tn(n)?xl(n):n instanceof Date?Ai(n):n},s}(),Vy=X(X(X(X(X(X(X(X(X(X(X(X(X([],Ue(1,31),!0),Ue(2,28),!0),Ue(3,31),!0),Ue(4,30),!0),Ue(5,31),!0),Ue(6,30),!0),Ue(7,31),!0),Ue(8,31),!0),Ue(9,30),!0),Ue(10,31),!0),Ue(11,30),!0),Ue(12,31),!0),Ue(1,7),!0),Qy=X(X(X(X(X(X(X(X(X(X(X(X(X([],Ue(1,31),!0),Ue(2,29),!0),Ue(3,31),!0),Ue(4,30),!0),Ue(5,31),!0),Ue(6,30),!0),Ue(7,31),!0),Ue(8,31),!0),Ue(9,30),!0),Ue(10,31),!0),Ue(11,30),!0),Ue(12,31),!0),Ue(1,7),!0),Zy=Rn(1,29),Xy=Rn(1,30),is=Rn(1,31),Rt=Rn(1,32),Jy=X(X(X(X(X(X(X(X(X(X(X(X(X([],Rt,!0),Xy,!0),Rt,!0),is,!0),Rt,!0),is,!0),Rt,!0),Rt,!0),is,!0),Rt,!0),is,!0),Rt,!0),Rt.slice(0,7),!0),eb=X(X(X(X(X(X(X(X(X(X(X(X(X([],Rt,!0),Zy,!0),Rt,!0),is,!0),Rt,!0),is,!0),Rt,!0),Rt,!0),is,!0),Rt,!0),is,!0),Rt,!0),Rt.slice(0,7),!0),tb=Rn(-28,0),nb=Rn(-29,0),os=Rn(-30,0),Pt=Rn(-31,0),sb=X(X(X(X(X(X(X(X(X(X(X(X(X([],Pt,!0),nb,!0),Pt,!0),os,!0),Pt,!0),os,!0),Pt,!0),Pt,!0),os,!0),Pt,!0),os,!0),Pt,!0),Pt.slice(0,7),!0),rb=X(X(X(X(X(X(X(X(X(X(X(X(X([],Pt,!0),tb,!0),Pt,!0),os,!0),Pt,!0),os,!0),Pt,!0),Pt,!0),os,!0),Pt,!0),os,!0),Pt,!0),Pt.slice(0,7),!0),ab=[0,31,60,91,121,152,182,213,244,274,305,335,366],ib=[0,31,59,90,120,151,181,212,243,273,304,334,365],Nl=function(){for(var s=[],e=0;e<55;e++)s=s.concat(Rn(7));return s}();function ob(s,e){var t=qs(s,1,1),n=Ir(s)?366:365,r=Ir(s+1)?366:365,a=xi(t),i=gr(t),l=sn(sn({yearlen:n,nextyearlen:r,yearordinal:a,yearweekday:i},lb(s)),{wnomask:null});if(Mn(e.byweekno))return l;l.wnomask=Ue(0,n+7);var c,u,h=c=vn(7-i+e.wkst,7);h>=4?(h=0,u=l.yearlen+vn(i-e.wkst,7)):u=n-h;for(var v=Math.floor(u/7),p=vn(u,7),m=Math.floor(v+p/4),k=0;k<e.byweekno.length;k++){var _=e.byweekno[k];if(_<0&&(_+=m+1),_>0&&_<=m){var g=void 0;_>1?(g=h+(_-1)*7,h!==c&&(g-=7-c)):g=h;for(var w=0;w<7&&(l.wnomask[g]=1,g++,l.wdaymask[g]!==e.wkst);w++);}}if(Qe(e.byweekno,1)){var g=h+m*7;if(h!==c&&(g-=7-c),g<n)for(var k=0;k<7&&(l.wnomask[g]=1,g+=1,l.wdaymask[g]!==e.wkst);k++);}if(h){var S=void 0;if(Qe(e.byweekno,-1))S=-1;else{var E=gr(qs(s-1,1,1)),x=vn(7-E.valueOf()+e.wkst,7),O=Ir(s-1)?366:365,L=void 0;x>=4?(x=0,L=O+vn(E-e.wkst,7)):L=n-h,S=Math.floor(52+vn(L,7)/4)}if(Qe(e.byweekno,S))for(var g=0;g<h;g++)l.wnomask[g]=1}return l}function lb(s){var e=Ir(s)?366:365,t=qs(s,1,1),n=gr(t);return e===365?{mmask:Vy,mdaymask:eb,nmdaymask:rb,wdaymask:Nl.slice(n),mrange:ib}:{mmask:Qy,mdaymask:Jy,nmdaymask:sb,wdaymask:Nl.slice(n),mrange:ab}}function cb(s,e,t,n,r,a){var i={lastyear:s,lastmonth:e,nwdaymask:[]},l=[];if(a.freq===be.YEARLY)if(Mn(a.bymonth))l=[[0,t]];else for(var c=0;c<a.bymonth.length;c++)e=a.bymonth[c],l.push(n.slice(e-1,e+1));else a.freq===be.MONTHLY&&(l=[n.slice(e-1,e+1)]);if(Mn(l))return i;i.nwdaymask=Ue(0,t);for(var c=0;c<l.length;c++)for(var u=l[c],h=u[0],v=u[1]-1,p=0;p<a.bynweekday.length;p++){var m=void 0,k=a.bynweekday[p],_=k[0],g=k[1];g<0?(m=v+(g+1)*7,m-=vn(r[m]-_,7)):(m=h+(g-1)*7,m+=vn(7-r[m]+_,7)),h<=m&&m<=v&&(i.nwdaymask[m]=1)}return i}function ub(s,e){e===void 0&&(e=0);var t=s%19,n=Math.floor(s/100),r=s%100,a=Math.floor(n/4),i=n%4,l=Math.floor((n+8)/25),c=Math.floor((n-l+1)/3),u=Math.floor(19*t+n-a-c+15)%30,h=Math.floor(r/4),v=r%4,p=Math.floor(32+2*i+2*h-u-v)%7,m=Math.floor((t+11*u+22*p)/451),k=Math.floor((u+p-7*m+114)/31),_=(u+p-7*m+114)%31+1,g=Date.UTC(s,k-1,_+e),w=Date.UTC(s,0,1);return[Math.ceil((g-w)/(1e3*60*60*24))]}var db=function(){function s(e){this.options=e}return s.prototype.rebuild=function(e,t){var n=this.options;if(e!==this.lastyear&&(this.yearinfo=ob(e,n)),kt(n.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var r=this.yearinfo,a=r.yearlen,i=r.mrange,l=r.wdaymask;this.monthinfo=cb(e,t,a,i,l,n)}pt(n.byeaster)&&(this.eastermask=ub(e,n.byeaster))},Object.defineProperty(s.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),s.prototype.ydayset=function(){return[Rn(this.yearlen),0,this.yearlen]},s.prototype.mdayset=function(e,t){for(var n=this.mrange[t-1],r=this.mrange[t],a=Ue(null,this.yearlen),i=n;i<r;i++)a[i]=i;return[a,n,r]},s.prototype.wdayset=function(e,t,n){for(var r=Ue(null,this.yearlen+7),a=xi(qs(e,t,n))-this.yearordinal,i=a,l=0;l<7&&(r[a]=a,++a,this.wdaymask[a]!==this.options.wkst);l++);return[r,i,a]},s.prototype.ddayset=function(e,t,n){var r=Ue(null,this.yearlen),a=xi(qs(e,t,n))-this.yearordinal;return r[a]=a,[r,a,a+1]},s.prototype.htimeset=function(e,t,n,r){var a=this,i=[];return this.options.byminute.forEach(function(l){i=i.concat(a.mtimeset(e,l,n,r))}),Pr(i),i},s.prototype.mtimeset=function(e,t,n,r){var a=this.options.bysecond.map(function(i){return new ba(e,t,i,r)});return Pr(a),a},s.prototype.stimeset=function(e,t,n,r){return[new ba(e,t,n,r)]},s.prototype.getdayset=function(e){switch(e){case ze.YEARLY:return this.ydayset.bind(this);case ze.MONTHLY:return this.mdayset.bind(this);case ze.WEEKLY:return this.wdayset.bind(this);case ze.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},s.prototype.gettimeset=function(e){switch(e){case ze.HOURLY:return this.htimeset.bind(this);case ze.MINUTELY:return this.mtimeset.bind(this);case ze.SECONDLY:return this.stimeset.bind(this)}},s}();function hb(s,e,t,n,r,a){for(var i=[],l=0;l<s.length;l++){var c=void 0,u=void 0,h=s[l];h<0?(c=Math.floor(h/e.length),u=vn(h,e.length)):(c=Math.floor((h-1)/e.length),u=vn(h-1,e.length));for(var v=[],p=t;p<n;p++){var m=a[p];pt(m)&&v.push(m)}var k=void 0;c<0?k=v.slice(c)[0]:k=v[c];var _=e[u],g=gu(r.yearordinal+k),w=pu(g,_);Qe(i,w)||i.push(w)}return Pr(i),i}function bu(s,e){var t=e.dtstart,n=e.freq,r=e.interval,a=e.until,i=e.bysetpos,l=e.count;if(l===0||r===0)return qn(s);var c=zy.fromDate(t),u=new db(e);u.rebuild(c.year,c.month);for(var h=gb(u,c,e);;){var v=u.getdayset(n)(c.year,c.month,c.day),p=v[0],m=v[1],k=v[2],_=vb(p,m,k,u,e);if(kt(i))for(var g=hb(i,h,m,k,u,p),w=0;w<g.length;w++){var S=g[w];if(a&&S>a)return qn(s);if(S>=t){var E=Rl(S,e);if(!s.accept(E)||l&&(--l,!l))return qn(s)}}else for(var w=m;w<k;w++){var x=p[w];if(pt(x))for(var O=gu(u.yearordinal+x),L=0;L<h.length;L++){var R=h[L],S=pu(O,R);if(a&&S>a)return qn(s);if(S>=t){var E=Rl(S,e);if(!s.accept(E)||l&&(--l,!l))return qn(s)}}}if(e.interval===0||(c.add(e,_),c.year>hu))return qn(s);fo(n)||(h=u.gettimeset(n)(c.hour,c.minute,c.second,0)),u.rebuild(c.year,c.month)}}function fb(s,e,t){var n=t.bymonth,r=t.byweekno,a=t.byweekday,i=t.byeaster,l=t.bymonthday,c=t.bynmonthday,u=t.byyearday;return kt(n)&&!Qe(n,s.mmask[e])||kt(r)&&!s.wnomask[e]||kt(a)&&!Qe(a,s.wdaymask[e])||kt(s.nwdaymask)&&!s.nwdaymask[e]||i!==null&&!Qe(s.eastermask,e)||(kt(l)||kt(c))&&!Qe(l,s.mdaymask[e])&&!Qe(c,s.nmdaymask[e])||kt(u)&&(e<s.yearlen&&!Qe(u,e+1)&&!Qe(u,-s.yearlen+e)||e>=s.yearlen&&!Qe(u,e+1-s.yearlen)&&!Qe(u,-s.nextyearlen+e-s.yearlen))}function Rl(s,e){return new ka(s,e.tzid).rezonedDate()}function qn(s){return s.getValue()}function vb(s,e,t,n,r){for(var a=!1,i=e;i<t;i++){var l=s[i];a=fb(n,l,r),a&&(s[l]=null)}return a}function gb(s,e,t){var n=t.freq,r=t.byhour,a=t.byminute,i=t.bysecond;return fo(n)?Yy(t):n>=be.HOURLY&&kt(r)&&!Qe(r,e.hour)||n>=be.MINUTELY&&kt(a)&&!Qe(a,e.minute)||n>=be.SECONDLY&&kt(i)&&!Qe(i,e.second)?[]:s.gettimeset(n)(e.hour,e.minute,e.second,e.millisecond)}var _n={MO:new Lt(0),TU:new Lt(1),WE:new Lt(2),TH:new Lt(3),FR:new Lt(4),SA:new Lt(5),SU:new Lt(6)},vo={freq:ze.YEARLY,dtstart:null,interval:1,wkst:_n.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},pb=Object.keys(vo),be=function(){function s(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new Ky,this.origOptions=yu(e);var n=By(e).parsedOptions;this.options=n}return s.parseText=function(e,t){return mu(e,t)},s.fromText=function(e,t){return Fy(e,t)},s.fromString=function(e){return new s(s.parseString(e)||void 0)},s.prototype._iter=function(e){return bu(e,this.options)},s.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},s.prototype._cacheAdd=function(e,t,n){if(this._cache)return this._cache._cacheAdd(e,t,n)},s.prototype.all=function(e){if(e)return this._iter(new Cl("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Js("all",{})),this._cacheAdd("all",t)),t},s.prototype.between=function(e,t,n,r){if(n===void 0&&(n=!1),!Dr(e)||!Dr(t))throw new Error("Invalid date passed in to RRule.between");var a={before:t,after:e,inc:n};if(r)return this._iter(new Cl("between",a,r));var i=this._cacheGet("between",a);return i===!1&&(i=this._iter(new Js("between",a)),this._cacheAdd("between",i,a)),i},s.prototype.before=function(e,t){if(t===void 0&&(t=!1),!Dr(e))throw new Error("Invalid date passed in to RRule.before");var n={dt:e,inc:t},r=this._cacheGet("before",n);return r===!1&&(r=this._iter(new Js("before",n)),this._cacheAdd("before",r,n)),r},s.prototype.after=function(e,t){if(t===void 0&&(t=!1),!Dr(e))throw new Error("Invalid date passed in to RRule.after");var n={dt:e,inc:t},r=this._cacheGet("after",n);return r===!1&&(r=this._iter(new Js("after",n)),this._cacheAdd("after",r,n)),r},s.prototype.count=function(){return this.all().length},s.prototype.toString=function(){return Mi(this.origOptions)},s.prototype.toText=function(e,t,n){return Ly(this,e,t,n)},s.prototype.isFullyConvertibleToText=function(){return Uy(this)},s.prototype.clone=function(){return new s(this.origOptions)},s.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],s.YEARLY=ze.YEARLY,s.MONTHLY=ze.MONTHLY,s.WEEKLY=ze.WEEKLY,s.DAILY=ze.DAILY,s.HOURLY=ze.HOURLY,s.MINUTELY=ze.MINUTELY,s.SECONDLY=ze.SECONDLY,s.MO=_n.MO,s.TU=_n.TU,s.WE=_n.WE,s.TH=_n.TH,s.FR=_n.FR,s.SA=_n.SA,s.SU=_n.SU,s.parseString=Ii,s.optionsToString=Mi,s}();function mb(s,e,t,n,r,a){var i={},l=s.accept;function c(p,m){t.forEach(function(k){k.between(p,m,!0).forEach(function(_){i[Number(_)]=!0})})}r.forEach(function(p){var m=new ka(p,a).rezonedDate();i[Number(m)]=!0}),s.accept=function(p){var m=Number(p);return isNaN(m)?l.call(this,p):!i[m]&&(c(new Date(m-1),new Date(m+1)),!i[m])?(i[m]=!0,l.call(this,p)):!0},s.method==="between"&&(c(s.args.after,s.args.before),s.accept=function(p){var m=Number(p);return i[m]?!0:(i[m]=!0,l.call(this,p))});for(var u=0;u<n.length;u++){var h=new ka(n[u],a).rezonedDate();if(!s.accept(new Date(h.getTime())))break}e.forEach(function(p){bu(s,p.options)});var v=s._result;switch(Pr(v),s.method){case"all":case"between":return v;case"before":return v.length&&v[v.length-1]||null;case"after":default:return v.length&&v[0]||null}}var Pl={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function yb(s,e){var t=[],n=[],r=[],a=[],i=_a(s),l=i.dtstart,c=i.tzid,u=Tb(s,e.unfold);return u.forEach(function(h){var v;if(h){var p=wb(h),m=p.name,k=p.parms,_=p.value;switch(m.toUpperCase()){case"RRULE":if(k.length)throw new Error("unsupported RRULE parm: ".concat(k.join(",")));t.push(Ii(h));break;case"RDATE":var g=(v=/RDATE(?:;TZID=([^:=]+))?/i.exec(h))!==null&&v!==void 0?v:[],w=g[1];w&&!c&&(c=w),n=n.concat(ql(_,k));break;case"EXRULE":if(k.length)throw new Error("unsupported EXRULE parm: ".concat(k.join(",")));r.push(Ii(_));break;case"EXDATE":a=a.concat(ql(_,k));break;case"DTSTART":break;default:throw new Error("unsupported property: "+m)}}}),{dtstart:l,tzid:c,rrulevals:t,rdatevals:n,exrulevals:r,exdatevals:a}}function bb(s,e){var t=yb(s,e),n=t.rrulevals,r=t.rdatevals,a=t.exrulevals,i=t.exdatevals,l=t.dtstart,c=t.tzid,u=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||n.length>1||r.length||a.length||i.length){var h=new Db(u);return h.dtstart(l),h.tzid(c||void 0),n.forEach(function(p){h.rrule(new be(ei(p,l,c),u))}),r.forEach(function(p){h.rdate(p)}),a.forEach(function(p){h.exrule(new be(ei(p,l,c),u))}),i.forEach(function(p){h.exdate(p)}),e.compatible&&e.dtstart&&h.rdate(l),h}var v=n[0]||{};return new be(ei(v,v.dtstart||e.dtstart||l,v.tzid||e.tzid||c),u)}function Oi(s,e){return e===void 0&&(e={}),bb(s,_b(e))}function ei(s,e,t){return sn(sn({},s),{dtstart:e,tzid:t})}function _b(s){var e=[],t=Object.keys(s),n=Object.keys(Pl);if(t.forEach(function(r){Qe(n,r)||e.push(r)}),e.length)throw new Error("Invalid options: "+e.join(", "));return sn(sn({},Pl),s)}function kb(s){if(s.indexOf(":")===-1)return{name:"RRULE",value:s};var e=Ay(s,":",1),t=e[0],n=e[1];return{name:t,value:n}}function wb(s){var e=kb(s),t=e.name,n=e.value,r=t.split(";");if(!r)throw new Error("empty property name");return{name:r[0].toUpperCase(),parms:r.slice(1),value:n}}function Tb(s,e){if(e===void 0&&(e=!1),s=s&&s.trim(),!s)throw new Error("Invalid empty string");if(!e)return s.split(/\s/);for(var t=s.split(`
`),n=0;n<t.length;){var r=t[n]=t[n].replace(/\s+$/g,"");r?n>0&&r[0]===" "?(t[n-1]+=r.slice(1),t.splice(n,1)):n+=1:t.splice(n,1)}return t}function Sb(s){s.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function ql(s,e){return Sb(e),s.split(",").map(function(t){return uo(t)})}function Fl(s){var e=this;return function(t){if(t!==void 0&&(e["_".concat(s)]=t),e["_".concat(s)]!==void 0)return e["_".concat(s)];for(var n=0;n<e._rrule.length;n++){var r=e._rrule[n].origOptions[s];if(r)return r}}}var Db=function(s){ho(e,s);function e(t){t===void 0&&(t=!1);var n=s.call(this,{},t)||this;return n.dtstart=Fl.apply(n,["dtstart"]),n.tzid=Fl.apply(n,["tzid"]),n._rrule=[],n._rdate=[],n._exrule=[],n._exdate=[],n}return e.prototype._iter=function(t){return mb(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){Ll(t,this._rrule)},e.prototype.exrule=function(t){Ll(t,this._exrule)},e.prototype.rdate=function(t){Ul(t,this._rdate)},e.prototype.exdate=function(t){Ul(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return Oi(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return Oi(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(Mi({dtstart:this._dtstart}))),this._rrule.forEach(function(n){t=t.concat(n.toString().split(`
`))}),this._exrule.forEach(function(n){t=t.concat(n.toString().split(`
`).map(function(r){return r.replace(/^RRULE:/,"EXRULE:")}).filter(function(r){return!/^DTSTART/.test(r)}))}),this._rdate.length&&t.push(zl("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(zl("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(n){return t.rrule(n.clone())}),this._exrule.forEach(function(n){return t.exrule(n.clone())}),this._rdate.forEach(function(n){return t.rdate(new Date(n.getTime()))}),this._exdate.forEach(function(n){return t.exdate(new Date(n.getTime()))}),t},e}(be);function Ll(s,e){if(!(s instanceof be))throw new TypeError(String(s)+" is not RRule instance");Qe(e.map(String),String(s))||e.push(s)}function Ul(s,e){if(!(s instanceof Date))throw new TypeError(String(s)+" is not Date instance");Qe(e.map(Number),Number(s))||(e.push(s),Pr(e))}function zl(s,e,t){var n=!t||t.toUpperCase()==="UTC",r=n?"".concat(s,":"):"".concat(s,";TZID=").concat(t,":"),a=e.map(function(i){return co(i.valueOf(),n)}).join(",");return"".concat(r).concat(a)}class Eb{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const n of e)Number.isFinite(n)&&n>=0&&n<=6&&t.add(Math.floor(n));return Array.from(t).sort((n,r)=>n-r)}normalizeDayOfMonth(e,t){const n=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(n,1),31)}normalizeMonth(e,t){const n=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(n,0),11)}calculateNext(e,t,n){if(n!=null&&n.timezone||np(),t.rruleString)return this.calculateNextWithRRule(e,t,n);const a=((n==null?void 0:n.whenDone)??t.whenDone??!1)&&(n!=null&&n.completionDate)?n.completionDate:e,{type:i,time:l}=t,c=this.normalizeInterval(t.interval);let u;switch(i){case"daily":u=this.calculateNextDaily(a,c);break;case"weekly":u=this.calculateNextWeekly(a,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(a,c,this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;case"yearly":u=this.calculateNextYearly(a,c,this.normalizeMonth(t.month,a.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;default:throw new Error(`Unknown frequency type: ${i}`)}if(l){const{hours:h,minutes:v}=mi(l);if(Number.isFinite(h)&&Number.isFinite(v)){const{date:p,shifted:m}=Zo(u,h,v);m&&at("DST shift detected while applying recurrence time",{requestedTime:l,original:u.toISOString(),adjusted:p.toISOString()}),u=p}}return u}calculateNextWithRRule(e,t,n){try{const a=((n==null?void 0:n.whenDone)??t.whenDone??!1)&&(n!=null&&n.completionDate)?n.completionDate:e,l=Oi(t.rruleString).after(a,!1);if(!l){at("RRule returned no next occurrence, falling back to legacy logic",{rruleString:t.rruleString,baseDate:a.toISOString()});const{rruleString:u,naturalLanguage:h,...v}=t;return this.calculateNext(a,v,n)}let c=l;if(t.time){const{hours:u,minutes:h}=mi(t.time);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:v,shifted:p}=Zo(c,u,h);p&&at("DST shift detected while applying recurrence time",{requestedTime:t.time,original:c.toISOString(),adjusted:v.toISOString()}),c=v}}return c}catch(r){Te("Failed to parse rrule, falling back to legacy logic",{error:r instanceof Error?r.message:String(r),rruleString:t.rruleString});const{rruleString:a,naturalLanguage:i,...l}=t;return this.calculateNext(e,l,n)}}calculateNextDaily(e,t){return us(e,t)}calculateNextWeekly(e,t,n){if(!n||n.length===0)return Qo(e,t);const r=this.getMondayIndex(e),a=Math.min($a,t*14);for(let i=1;i<=a;i++){if(Math.floor((r+i)/7)%t!==0)continue;const c=us(e,i),u=this.getMondayIndex(c);if(n.includes(u))return c}return at("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:n}),Qo(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,n){const r=n??e.getDate(),a=e.getFullYear(),l=e.getMonth()+t,c=a+Math.floor(l/12),u=(l%12+12)%12,h=new Date(c,u+1,0).getDate(),v=Math.min(r,h),p=new Date(e);return p.setFullYear(c,u,v),p}calculateNextYearly(e,t,n,r){const a=r??e.getDate(),i=e.getFullYear()+t,l=new Date(i,n+1,0).getDate(),c=Math.min(a,l),u=new Date(e);return u.setFullYear(i,n,c),u}getOccurrencesInRange(e,t,n,r){const a=[];let i=new Date(r),l=0;for(;i<=t&&l<$a;)i>=e&&a.push(new Date(i)),i=this.calculateNext(i,n),l++;return a}getMissedOccurrences(e,t,n,r){const a=[];let i=new Date(r),l=0;for(;i<=e&&l<$a;)i=this.calculateNext(i,n),l++;let c=0;for(;i<t&&c<oa;)a.push(new Date(i)),i=this.calculateNext(i,n),c++;return c>=oa&&at("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:n,firstOccurrence:r.toISOString(),cap:oa}),a}}class xb{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:n,minutes:r}=mi(t);if(!Number.isFinite(n)||!Number.isFinite(r))return new Date(e);const a=new Date(e);return a.setHours(n,r,0,0),a}isSameLocalDay(e,t){const n=new Date(e),r=new Date(t);return n.getFullYear()===r.getFullYear()&&n.getMonth()===r.getMonth()&&n.getDate()===r.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,n=e.getTime()-t.getTime(),r=Math.trunc(n/(1e3*60)),a=Math.trunc(n/(1e3*60*60)),i=Math.trunc(n/(1e3*60*60*24));return Math.abs(n)<1e3*60?"now":Math.abs(r)<60?r>0?`in ${r}m`:`${-r}m ago`:Math.abs(a)<24?a>0?`in ${a}h`:`${-a}h ago`:i>0?`in ${i}d`:`${-i}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const n=new Date(e);return n.setDate(n.getDate()+t),n}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class Ab{constructor(e){y(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return he(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return at(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return at("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),he(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return at("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(n){return Te("Failed to execute onCompletion action",{taskId:e.id,action:t,error:n}),{success:!1,error:n instanceof Error?n.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return at("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return Te("Failed to check for nested items",{blockId:e,error:t}),!0}}}class Cb{constructor(e,t){y(this,"intervalMs");y(this,"timeoutId",null);y(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:eo,n=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},n)}}class Ib{constructor(e,t=eo,n){y(this,"storage");y(this,"recurrenceEngine");y(this,"onCompletionHandler");y(this,"emittedDue",new Set);y(this,"emittedMissed",new Set);y(this,"timezoneHandler");y(this,"isChecking",!1);y(this,"lastCheckStartTime",0);y(this,"plugin",null);y(this,"listeners",{"task:due":new Set,"task:overdue":new Set});y(this,"MAX_EMITTED_ENTRIES",1e3);y(this,"EMITTED_RETENTION_DAYS",30);y(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);y(this,"persistTimeoutId",null);y(this,"emittedStateReady",null);y(this,"timer");this.storage=e,this.recurrenceEngine=new Eb,this.onCompletionHandler=new Ab(n),this.timezoneHandler=new xb,this.plugin=n||null,this.timer=new Cb(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),he("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),he("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)at("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const n of t){if(!this.isActive(n))continue;const r=new Date(n.dueAt),a=r<=e;if(a){const l=this.buildOccurrenceKey(n.id,r,"hour");this.emittedDue.has(l)||(this.emitEvent("task:due",{taskId:n.id,dueAt:r,context:"today",task:n}),this.registerEmittedKey("due",l),he(`Task due: ${n.name}`,{taskId:n.id,dueAt:n.dueAt}))}const i=n.lastCompletedAt?new Date(n.lastCompletedAt):null;if(a&&e.getTime()-r.getTime()>=yh&&(!i||i<r)){const l=this.buildOccurrenceKey(n.id,r,"hour");this.emittedMissed.has(l)||(this.emitEvent("task:overdue",{taskId:n.id,dueAt:r,context:"overdue",task:n}),this.registerEmittedKey("missed",l),at(`Task missed: ${n.name}`,{taskId:n.id,dueAt:n.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),n=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=n.set,(t.didTrim||n.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,n){const r=n.getTime(),a=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let i=a.filter(({time:u})=>u===null||u>=r),l=i.length!==a.length;i.length>this.MAX_EMITTED_ENTRIES&&(i=i.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),l=!0);const c=new Set(i.map(({entry:u})=>u));return l&&he(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${c.size}`),{set:c,didTrim:l}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const n=e.slice(t+1);if(!n)return null;const r=n.length===13?`${n}:00:00.000Z`:n,a=new Date(r);return Number.isNaN(a.getTime())?null:a.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const n=new Date;t.doneAt=n.toISOString(),Ch(t);const r=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(r);const a=t.onCompletion||"keep",i=await this.onCompletionHandler.execute(t,a);if(i.success||Te(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:a,error:i.error}),i.warnings)for(const u of i.warnings)at(u,{taskId:t.id});const l=new Date(t.dueAt),c=this.recurrenceEngine.calculateNext(l,t.frequency,{completionDate:n,whenDone:t.whenDone});t.dueAt=c.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),he(`Task "${t.name}" completed and rescheduled to ${c.toISOString()}`)}async delayTask(e,t){const n=this.storage.getTask(e);if(!n)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(n);const r=new Date(n.dueAt),a=new Date(r.getTime()+t*60*1e3);n.dueAt=a.toISOString(),n.snoozeCount=(n.snoozeCount||0)+1,await this.storage.saveTask(n),he(`Task "${n.name}" delayed by ${t} minutes to ${a.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const n=new Date(t.dueAt),r=this.timezoneHandler.tomorrow();r.setHours(n.getHours(),n.getMinutes(),0,0),t.dueAt=r.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),he(`Task "${t.name}" delayed to tomorrow: ${r.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Hc(t);const n=new Date(t.dueAt),r=this.recurrenceEngine.calculateNext(n,t.frequency);t.dueAt=r.toISOString(),await this.storage.saveTask(t),he(`Task "${t.name}" skipped to ${r.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),he("First run detected, no recovery needed");return}he(`Recovering missed tasks since ${e.toISOString()}`);for(const n of this.storage.getEnabledTasks())try{const r=this.recurrenceEngine.getMissedOccurrences(e,t,n.frequency,new Date(n.createdAt));for(const a of r){const i=this.buildOccurrenceKey(n.id,a,"exact");this.emittedMissed.has(i)||(this.emitEvent("task:overdue",{taskId:n.id,dueAt:a,context:"overdue",task:n}),this.registerEmittedKey("missed",i))}await this.advanceToNextFutureOccurrence(n,t)}catch(r){Te(`Failed to recover task ${n.id}:`,r)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),he("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const n=new Date(e.dueAt);if(n>=t)return;let r=n,a=0;for(;r<t&&a<oa;)r=this.recurrenceEngine.calculateNext(r,e.frequency),a++;r>n&&(e.dueAt=r.toISOString(),await this.storage.saveTask(e),he(`Advanced task "${e.name}" to ${r.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(jo);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){Te("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(jo,{timestamp:e.toISOString()})}catch(t){Te("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const n=this.listeners[e];for(const r of n)try{const a=r(t);a instanceof Promise&&a.catch(i=>{Te(`Scheduler listener error for ${e}:`,i)})}catch(a){Te(`Scheduler listener error for ${e}:`,a)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??bh,n=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(n>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Lo),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(r=>typeof r=="string"):[],n=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(r=>typeof r=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(n.slice(-this.MAX_EMITTED_ENTRIES)),he("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){Te("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Lo,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){Te("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,n){return n==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const Mb=7,Ob=2e3;class Nb{constructor(e,t){y(this,"plugin");y(this,"storageKey");y(this,"notifications",new Map);y(this,"escalations",new Map);y(this,"lastCleanup",new Date);y(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const n of t.notifications)this.notifications.set(n.taskKey,n);if(Array.isArray(t.escalations))for(const n of t.escalations)this.escalations.set(n.taskId,n);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),he(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){Te("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Wc("Saved notification state")}catch(e){Te("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>Ob&&Array.from(this.notifications.keys()).slice(0,100).forEach(n=>this.notifications.delete(n))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const n=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:n,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,n}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const n=new Date(t);return`${e}:${n.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const n=new Date(e.getTime()-Mb*24*60*60*1e3);let r=0;for(const[a,i]of this.notifications.entries())new Date(i.notifiedAt)<n&&(this.notifications.delete(a),r++);r>0&&(he(`Cleaned up ${r} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function Rb(s){return{id:s.id,name:s.name,dueAt:s.dueAt,frequency:s.frequency,linkedBlockId:s.linkedBlockId,linkedBlockContent:s.linkedBlockContent,priority:s.priority,tags:s.tags,notificationChannels:s.notificationChannels,completionCount:s.completionCount,missCount:s.missCount,currentStreak:s.currentStreak,bestStreak:s.bestStreak}}const Pb=30*1e3,qb=30*60*1e3,ms=500;class Fb{constructor(e,t={}){y(this,"plugin");y(this,"config");y(this,"queue",[]);y(this,"dedupeKeys",new Set);y(this,"flushIntervalId",null);y(this,"fetcher");y(this,"notificationState");y(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...pi},this.notificationState=t.notificationState??new Nb(this.plugin,gh)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(qo);e&&(this.config={...pi,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(qo,e)}async loadQueue(){try{const e=await this.plugin.loadData(Fo);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>ms){const n=this.queue.length-ms;this.queue=this.queue.slice(-ms),console.warn(`Event queue trimmed to ${ms} entries (dropped ${n}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-Ha);await this.plugin.saveData(Fo,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},mh))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const n=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,n),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const n=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,n),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,n=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const r=this.buildDedupeKey(e,t);if(this.isDuplicate(r))return;const a=this.buildPayload(e,t,r,1,n);await this.sendPayload(a)?(this.markDelivered(r),await this.persistQueue()):this.enqueue(a)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:Uo,version:zo,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},n=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return n.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${n.status}: ${n.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const n=[];for(const r of this.queue){if(new Date(r.nextAttemptAt).getTime()>e){n.push(r);continue}const a={...r.payload,delivery:{...r.payload.delivery,attempt:r.attempt}};if(await this.sendPayload(a))this.markDelivered(a.delivery.dedupeKey),t=!0;else{const l=r.attempt+1,c=this.getRetryDelay(l);n.push({...r,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}t&&(this.queue=n,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,n,r,a=0){const i=new Date,l=new Date(t.dueAt),c=i.getTime()-l.getTime();return{event:e,source:Uo,version:zo,occurredAt:i.toISOString(),task:Rb(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:c>0?c:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:a,channels:t.notificationChannels||[]},delivery:{dedupeKey:n,attempt:r}}}buildDedupeKey(e,t){const n=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${n}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>Ha){const t=Array.from(this.dedupeKeys).slice(-Ha);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=ms){const n=this.queue.length-ms+1;this.queue.splice(0,n),console.warn(`Event queue capped at ${ms}. Dropped ${n} oldest entr${n===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=Pb*Math.pow(2,e-1);return Math.min(t,qb)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const n=new TextEncoder,r=n.encode(t),a=n.encode(e),i=await crypto.subtle.importKey("raw",r,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),l=await crypto.subtle.sign("HMAC",i,a);return Array.from(new Uint8Array(l)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(n){return console.error("Failed to generate signature:",n),""}}async buildHeaders(e){const t=JSON.stringify(e),n=new Date().toISOString();let r="";this.config.n8n.sharedSecret&&(r=await this.generateSignature(t+n,this.config.n8n.sharedSecret));const a={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":n};return r&&(a["X-Shehab-Signature"]=r),this.config.n8n.sharedSecret&&(a["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),a}async sendPayload(e,t=!1){try{const n=JSON.stringify(e),r=await this.buildHeaders(e),a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:r,body:n});if(!a.ok)return console.error("n8n webhook failed:",a.statusText),!1;if(t){const i=await a.json().catch(()=>null);return!!(i&&i.ok)}return!0}catch(n){return console.error("Failed to send n8n event:",n),!1}}}const dt={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:Rr,globalQuery:pa,urgency:to,smartRecurrence:{enabled:!0,autoAdjust:!1,minCompletionsForLearning:10,confidenceThreshold:.7},naturalLanguage:{enabled:!0,showConfidenceScore:!0,provideExamples:!0},crossNoteDependencies:{enabled:!0,checkInterval:5,notifyWhenMet:!0},smartSuggestions:{enabled:!0,minConfidence:.65,showDismissed:!1,autoApplyHighConfidence:!1},predictiveScheduling:{enabled:!0,showHeatmap:!0,minDataPoints:5,workingHours:{start:6,end:22},preferredDays:[1,2,3,4,5]},keyboardNavigation:{enabled:!1,useVimKeybindings:!0,customKeybindings:{},showModeIndicator:!0,showQuickHints:!0,enableCommandPalette:!0}};function Bl(s){var e,t,n,r,a,i,l,c;return{dates:{...dt.dates,...s.dates},recurrence:{...dt.recurrence,...s.recurrence},dependencies:{...dt.dependencies,...s.dependencies},filenameDate:{...dt.filenameDate,...s.filenameDate},globalFilter:{...dt.globalFilter,...s.globalFilter,excludeFolders:((e=s.globalFilter)==null?void 0:e.excludeFolders)??dt.globalFilter.excludeFolders,excludeNotebooks:((t=s.globalFilter)==null?void 0:t.excludeNotebooks)??dt.globalFilter.excludeNotebooks,excludeTags:((n=s.globalFilter)==null?void 0:n.excludeTags)??dt.globalFilter.excludeTags,excludeFilePatterns:((r=s.globalFilter)==null?void 0:r.excludeFilePatterns)??dt.globalFilter.excludeFilePatterns,excludeStatusTypes:((a=s.globalFilter)==null?void 0:a.excludeStatusTypes)??dt.globalFilter.excludeStatusTypes},globalQuery:{...dt.globalQuery,...s.globalQuery},urgency:{...dt.urgency,...s.urgency},smartRecurrence:{...dt.smartRecurrence,...s.smartRecurrence},naturalLanguage:{...dt.naturalLanguage,...s.naturalLanguage},crossNoteDependencies:{...dt.crossNoteDependencies,...s.crossNoteDependencies},smartSuggestions:{...dt.smartSuggestions,...s.smartSuggestions},predictiveScheduling:{...dt.predictiveScheduling,...s.predictiveScheduling,preferredDays:((i=s.predictiveScheduling)==null?void 0:i.preferredDays)??dt.predictiveScheduling.preferredDays,workingHours:((l=s.predictiveScheduling)==null?void 0:l.workingHours)??dt.predictiveScheduling.workingHours},keyboardNavigation:{...dt.keyboardNavigation,...s.keyboardNavigation,customKeybindings:((c=s.keyboardNavigation)==null?void 0:c.customKeybindings)??dt.keyboardNavigation.customKeybindings}}}const ti="plugin-settings";class Lb{constructor(e){y(this,"plugin");y(this,"settings");this.plugin=e,this.settings=dt}async load(){try{const e=await this.plugin.loadData(ti);e&&typeof e=="object"&&(this.settings=Bl(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(ti,e),He.emit("task:refresh",void 0)}get(){return this.settings}async update(e){this.settings=Bl(e),await this.plugin.saveData(ti,this.settings),He.emit("task:refresh",void 0)}}const ts=class ts{constructor(e){y(this,"plugin");y(this,"isInitialized",!1);y(this,"storage");y(this,"repository");y(this,"scheduler");y(this,"eventService");y(this,"settingsService");this.plugin=e}static getInstance(e){if(!ts.instance){if(!e)return null;ts.instance=new ts(e)}return ts.instance}async initialize(){if(this.isInitialized){at("TaskManager already initialized");return}he("Initializing TaskManager"),this.settingsService=new Lb(this.plugin),await this.settingsService.load();const e=this.settingsService.get();ma.getInstance().initialize(e.globalFilter),vr.getInstance().initialize(e.globalQuery),this.storage=new Dy(this.plugin),await this.storage.init(),this.repository=new Ey(this.storage),this.eventService=new Fb(this.plugin),await this.eventService.init(),this.scheduler=new Ib(this.storage,eo,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,he("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:n})=>e(n)),t&&this.scheduler.on("task:overdue",({task:n})=>t(n)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),he("TaskManager started")}async destroy(){he("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,ts.instance=null,he("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};y(ts,"instance",null);let wa=ts;function Ub(s){let t=`- [${s.status==="done"?"x":" "}] ${s.name}`;if(s.dueAt){const n=new Date(s.dueAt);t+=` 📅 ${n.toISOString().split("T")[0]}`}return s.frequency&&(t+=` 🔁 every ${s.frequency.interval} ${s.frequency.type}${s.frequency.interval>1?"s":""}`),t}class zb{constructor(e,t,n,r){this.storage=e,this.recurrenceEngine=t,this.settings=n,this.siyuanApi=r}async onComplete(e,t){try{const n=[],r=this.addCompletionDate(e,t);let a;return e.frequency&&(a=await this.generateNextInstance(r,t),a&&(await this.placeNextInstance(r,a)||n.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(a))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(at("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(r),n.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(r),{success:!0,nextTask:a,warnings:n.length>0?n:void 0}}catch(n){return Te("Failed to handle task completion",{taskId:e.id,error:n}),{success:!1,error:n instanceof Error?n.message:"Unknown error occurred"}}}addCompletionDate(e,t){const n={...e},r=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(n.doneAt=r,n.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(n.cancelledAt=r,n.doneAt=void 0),n}async generateNextInstance(e,t){if(e.frequency)try{const n=new Date(e.dueAt),r=this.recurrenceEngine.calculateNext(n,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),a=jc(e,{dueAt:r.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(a.scheduledAt=void 0),a}catch(n){Te("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:n});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return at("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return at("SiYuan API not available, cannot place next instance"),!1;const n=this.settings.recurrence.newTaskPosition,r=Ub(t);try{let a;return n==="above"&&this.siyuanApi.insertBlockAbove?a=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,r):n==="below"&&this.siyuanApi.insertBlockBelow&&(a=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,r)),a!=null&&a.id?(t.linkedBlockId=a.id,t.linkedBlockContent=r,!0):!1}catch(a){return Te("Failed to place next instance in document",{taskId:e.id,placement:n,error:a}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const n=await this.siyuanApi.getChildBlocks({id:e});return n&&n.length>0}catch(n){return Te("Failed to check for nested items",{blockId:e,error:n}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),he("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(n){Te("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:n})}else he("Task deleted from storage only (no linked block)",{taskId:e.id})}}class Bb{constructor(e,t,n,r){y(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=n,this.siyuanApi=r,t&&n&&(this.completionHandler=new zb(e,t,n(),r))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,n;try{const r=this.repository.getTask(e);if(!r){K.error("Task not found");return}const a=Sn.getInstance(),i=r.statusSymbol||" ",l=a.getNextSymbol(i),c={...r,statusSymbol:l},u=a.getStatus(l);if(u.type==="DONE"){if(c.status="done",r.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(c,new Date);h.success?(h.nextTask?(he("Next recurrence created",{taskId:c.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),K.success("Task completed - next occurrence scheduled")):K.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(v=>K.warning(v))):K.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!c.doneAt&&(c.doneAt=new Date().toISOString()),await this.repository.saveTask(c),K.success(`Task status updated to ${u.name}`);He.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(c.status="cancelled",(n=this.settings)!=null&&n.dates.autoAddCancelled&&!c.cancelledAt&&(c.cancelledAt=new Date().toISOString()),await this.repository.saveTask(c),He.emit("task:updated",{taskId:e}),K.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(c.status="todo",await this.repository.saveTask(c),He.emit("task:updated",{taskId:e}),K.success(`Task status updated to ${u.name}`))}catch(r){Te("Failed to toggle task status",r),K.error("Failed to toggle status")}}async completeTask(e){var t;try{const n=this.repository.getTask(e);if(!n){K.error("Task not found");return}const r={...n,status:"done"};if(n.frequency&&this.completionHandler){const a=await this.completionHandler.onComplete(r,new Date);a.success?(a.nextTask?(he("Next recurrence created",{taskId:r.id,nextTaskId:a.nextTask.id,nextDue:a.nextTask.dueAt}),K.success(`Task "${n.name}" completed - next occurrence scheduled`)):K.success(`Task "${n.name}" completed`),a.warnings&&a.warnings.forEach(i=>K.warning(i))):K.error(`Failed to complete task: ${a.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!r.doneAt&&(r.doneAt=new Date().toISOString()),await this.repository.saveTask(r),K.success(`Task "${n.name}" completed`);He.emit("task:complete",{taskId:e})}catch(n){Te("Failed to complete task",n),K.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){K.error("Task not found");return}const r=this.repository.getAllTasks().filter(a=>{var i,l;return((i=a.blockedBy)==null?void 0:i.includes(e))||((l=a.dependsOn)==null?void 0:l.includes(e))});if(r.length>0&&!confirm(`This task is blocking ${r.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),He.emit("task:deleted",{taskId:e}),K.success(`Task "${t.name}" deleted`)}catch(t){Te("Failed to delete task",t),K.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){K.error("Task not found");return}const n=new Date;n.setHours(12,0,0,0);const r={...t,scheduledAt:n.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(r),He.emit("task:updated",{taskId:e}),K.success("Task rescheduled to today")}catch(t){Te("Failed to reschedule task",t),K.error("Failed to reschedule task")}}async deferTask(e,t){try{const n=this.repository.getTask(e);if(!n){K.error("Task not found");return}const r={...n,updatedAt:new Date().toISOString()};if(n.dueAt){const a=new Date(n.dueAt);a.setDate(a.getDate()+t),r.dueAt=a.toISOString()}if(n.scheduledAt){const a=new Date(n.scheduledAt);a.setDate(a.getDate()+t),r.scheduledAt=a.toISOString()}await this.repository.saveTask(r),He.emit("task:updated",{taskId:e}),K.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(n){Te("Failed to defer task",n),K.error("Failed to defer task")}}}class Yb{constructor(e,t,n){y(this,"plugin");y(this,"storageKey");y(this,"settings");y(this,"defaults");this.plugin=e,this.storageKey=t,this.defaults={...n},this.settings={...n}}async load(){try{const e=await this.plugin.loadData(this.storageKey);e&&(this.settings={...this.defaults,...e})}catch(e){console.error(`Failed to load settings from ${this.storageKey}:`,e),this.settings={...this.defaults}}return this.settings}async save(e){e&&(this.settings=e);try{await this.plugin.saveData(this.storageKey,this.settings)}catch(t){throw console.error(`Failed to save settings to ${this.storageKey}:`,t),t}}get(){return{...this.settings}}async set(e,t){this.settings[e]=t,await this.save()}async reset(){this.settings={...this.defaults},await this.save()}has(e){return e in this.settings}getValue(e){return this.settings[e]}}const Zs=[{id:"quickAddTask",langKey:"quickAddTask",label:"Quick add recurring task",description:"Open the quick add dialog with focus on the task title.",defaultHotkey:"Ctrl+Shift+T",context:"Global / Editor"},{id:"markTaskDone",langKey:"markTaskDone",label:"Mark task as done",description:"Complete the focused task and trigger recurrence.",defaultHotkey:"Ctrl+Enter",context:"Task focus / Task block"},{id:"postponeTask",langKey:"postponeTask",label:"Postpone task",description:"Open the snooze selector for the focused task.",defaultHotkey:"Ctrl+Shift+P",context:"Task focus"},{id:"openRecurringTasksDock",langKey:"openRecurringTasksDock",label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",defaultHotkey:"Ctrl+Shift+O",context:"Global"},{id:"createRecurringTask",langKey:"createRecurringTask",label:"Create recurring task from selection",description:"Create a recurring task based on the current editor block.",defaultHotkey:"Ctrl+Shift+R",context:"Editor"},{id:"quickCompleteNextTask",langKey:"quickCompleteNextTask",label:"Quick complete next task",description:"Marks the most overdue task as complete.",defaultHotkey:"Ctrl+Shift+D",context:"Global"},{id:"toggleTaskStatus",langKey:"toggleTaskStatus",label:"Toggle task status",description:"Cycle the status of the focused task.",defaultHotkey:"Ctrl+Shift+X",context:"Task focus"},{id:"openTaskEditor",langKey:"openTaskEditor",label:"Open task editor",description:"Open the full task editor modal.",defaultHotkey:"Ctrl+Shift+E",context:"Global"}],ni=Zs.reduce((s,e)=>(s[e.id]=e.defaultHotkey,s),{});function Ni(s,e){He.emit("task:snooze",{taskId:s,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:e}})),he(`Snoozing task ${s} for ${e} minutes`)}function jb(s){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const n=bi(t),r=Math.max(0,Math.floor((n.getTime()-e.getTime())/(60*1e3)));He.emit("task:snooze",{taskId:s,minutes:r}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:r}})),he(`Snoozing task ${s} to tomorrow`)}function Hb(s){s.eventBus.on("click-blockicon",({detail:e})=>{var i,l,c;const t=e.blockElements;if(!t||t.length===0)return;const n=t[0],r=n==null?void 0:n.getAttribute("data-node-id");if(!r)return;const a=(n==null?void 0:n.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((i=s.i18n)==null?void 0:i.createRecurringTask)||"Create Recurring Task",click:()=>{He.emit("task:create",{source:"block-menu",linkedBlockId:r,linkedBlockContent:a,suggestedName:Ri(a),suggestedTime:Pi(a)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:r,linkedBlockContent:a,suggestedName:Ri(a),suggestedTime:Pi(a)}}))}});try{const u=wa.getInstance();if(u&&u.isReady()){const v=u.getRepository().getTaskByBlockId(r);if(v){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((l=s.i18n)==null?void 0:l.completeTask)||"Complete Task",click:()=>{He.emit("task:complete",{taskId:v.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:v.id}}))}});const p=[{label:"15 minutes",click:()=>Ni(v.id,15)},{label:"1 hour",click:()=>Ni(v.id,60)},{label:"Tomorrow",click:()=>jb(v.id)}];e.menu.addItem({icon:"iconClock",label:((c=s.i18n)==null?void 0:c.snoozeTask)||"Snooze Task",submenu:p})}}}catch{Wc("TaskManager not available for quick actions")}}),he("Registered block context menu")}function Ri(s){const e=s.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function Pi(s){var n;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=s.match(e);if(t){let r=parseInt(t[1],10);const a=t[2],i=(n=t[3])==null?void 0:n.toUpperCase();return i==="PM"&&r<12?r+=12:i==="AM"&&r===12&&(r=0),`${r.toString().padStart(2,"0")}:${a}`}return null}const $b="recurring-task-shortcuts",Wb=350;class Gb{constructor(e,t,n,r,a){y(this,"settingsStore");y(this,"settings",{...ni});y(this,"taskCommands");y(this,"cooldownTimers",new Map);this.plugin=e,this.repository=t,this.handlers=a,this.settingsStore=new Yb(e,$b,ni),this.taskCommands=new Bb(t,n,r,void 0)}async initialize(){this.settings=await this.settingsStore.load()}registerShortcuts(){Zs.forEach(e=>{const t=this.settings[e.id]||e.defaultHotkey;this.plugin.addCommand({langKey:e.langKey,hotkey:t,callback:()=>{this.handleShortcut(e.id)}})}),he("Registered shortcut commands",{shortcuts:Zs.map(e=>({id:e.id,hotkey:this.settings[e.id]}))})}getShortcutDisplay(){return Zs.map(e=>({id:e.id,label:e.label,description:e.description,context:e.context,currentHotkey:this.settings[e.id]||"",defaultHotkey:e.defaultHotkey}))}async updateShortcut(e,t){const n=t.trim(),r=this.findDuplicateHotkey(e,n);return r?{success:!1,message:`Hotkey already assigned to "${r.label}".`}:(this.settings={...this.settings,[e]:n},await this.settingsStore.save(this.settings),this.registerShortcuts(),{success:!0})}async resetShortcut(e){const t=this.getDefinition(e);t&&(this.settings={...this.settings,[e]:t.defaultHotkey},await this.settingsStore.save(this.settings),this.registerShortcuts())}async resetAllShortcuts(){this.settings={...ni},await this.settingsStore.save(this.settings),this.registerShortcuts()}destroy(){this.cooldownTimers.forEach(e=>globalThis.clearTimeout(e)),this.cooldownTimers.clear()}async handleShortcut(e){if(!this.shouldIgnoreShortcut(e))switch(e){case"quickAddTask":this.guardCooldown(e,Wb,()=>{this.handlers.createTask(this.buildCreatePayload("shortcut"))});break;case"createRecurringTask":this.handlers.createTask(this.buildCreatePayload("shortcut"));break;case"openRecurringTasksDock":this.handlers.openDock();break;case"markTaskDone":{const t=this.resolveTaskId();if(!t)return;await this.handlers.completeTask(t);break}case"postponeTask":{const t=this.resolveTaskId();if(!t)return;this.handlers.postponeTask(t);break}case"quickCompleteNextTask":await this.quickCompleteNextTask();break;case"toggleTaskStatus":{const t=this.resolveTaskId();if(!t)return;await this.taskCommands.toggleStatus(t);break}case"openTaskEditor":this.handlers.openTaskEditor();break}}guardCooldown(e,t,n){if(this.cooldownTimers.has(e))return;n();const r=globalThis.setTimeout(()=>{this.cooldownTimers.delete(e)},t);this.cooldownTimers.set(e,r)}shouldIgnoreShortcut(e){const t=document.activeElement;if(!t)return!1;const n=t.tagName.toLowerCase();return["input","textarea","select"].includes(n)?!0:t.isContentEditable?!this.isEditorAllowedShortcut(e):!1}isEditorAllowedShortcut(e){return e==="quickAddTask"||e==="createRecurringTask"}resolveTaskId(){const e=this.getFocusedTaskId();if(e)return e;const t=this.getSelectedBlockContext();if(!t)return null;const n=this.repository.getTaskByBlockId(t.blockId);return(n==null?void 0:n.id)??null}getFocusedTaskId(){const e=document.activeElement;if(!e)return null;const t=e.closest("[data-task-id]");return(t==null?void 0:t.dataset.taskId)??null}getSelectedBlockContext(){const e=window.getSelection(),t=e==null?void 0:e.anchorNode;if(!t)return null;const n=t instanceof HTMLElement?t:t.parentElement;if(!n)return null;const r=n.closest("[data-node-id]");if(!r)return null;const a=r.getAttribute("data-node-id");return a?{blockId:a,blockContent:r.textContent||""}:null}buildCreatePayload(e){const t=this.getSelectedBlockContext();return t?{source:e,linkedBlockId:t.blockId,linkedBlockContent:t.blockContent,suggestedName:Ri(t.blockContent),suggestedTime:Pi(t.blockContent)}:{source:e}}async quickCompleteNextTask(){try{const e=this.repository.getTodayAndOverdueTasks();if(e.length===0)return;const t=e[0];await this.taskCommands.completeTask(t.id)}catch(e){Te("Failed to quick complete task",e),K.error("Failed to complete task")}}getDefinition(e){return Zs.find(t=>t.id===e)}findDuplicateHotkey(e,t){if(!t)return null;const n=t.toLowerCase(),r=Zs.find(a=>a.id===e?!1:(this.settings[a.id]||"").toLowerCase()===n);return r?{id:r.id,label:r.label,description:r.description,context:r.context,currentHotkey:this.settings[r.id],defaultHotkey:r.defaultHotkey}:null}}async function Kb(s,e,t,n,r){const a=new Gb(s,e,n,r,t);return await a.initialize(),a.registerShortcuts(),a}class Vb{constructor(e,t){y(this,"plugin");y(this,"repository");y(this,"topbarElement",null);y(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),he("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),he("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(n=>{const r=new Date(n.dueAt);return r<new Date&&!ao(r)}).length;if(e.length>0){const n=this.topbarElement.querySelector(".b3-badge");if(n)n.textContent=e.length.toString(),n.style.display="block",t>0?n.style.backgroundColor="var(--b3-theme-error)":n.style.backgroundColor="var(--b3-theme-primary)";else{const r=document.createElement("span");r.className="b3-badge",r.textContent=e.length.toString(),r.style.display="block",r.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(r)}}else{const n=this.topbarElement.querySelector(".b3-badge");n&&n.remove()}}toggleMenu(){He.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Qb{constructor(e="tasks"){y(this,"codeLanguage");y(this,"cachedCodeBlocks",new WeakMap);y(this,"cachedAttributeBlocks",new WeakMap);this.codeLanguage=e.toLowerCase()}parse(e){const t=[];let n=this.cachedCodeBlocks.get(e);n||(n=e.querySelectorAll('[data-type="NodeCodeBlock"]'),this.cachedCodeBlocks.set(e,n)),n.forEach(a=>{var h;if((a.dataset.subtype||a.getAttribute("data-subtype")||"").toLowerCase()!==this.codeLanguage)return;const l=a.querySelector("code")||a.querySelector("textarea")||a.querySelector(".hljs")||a,c=((h=l==null?void 0:l.textContent)==null?void 0:h.trim())??"";if(!c)return;const u=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:u,query:c,element:a,source:"code"})});let r=this.cachedAttributeBlocks.get(e);return r||(r=e.querySelectorAll("[data-node-id]"),this.cachedAttributeBlocks.set(e,r)),r.forEach(a=>{if(a.classList.contains("rt-inline-query")||a.getAttribute("data-type")==="NodeCodeBlock")return;const i=this.parseAttributes(a);if(!i.query)return;const l=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:l,query:i.query,view:i.view,element:a,source:"attribute"})}),t}parseAttributes(e){var a;const t=e.getAttribute("custom-task-query")||e.getAttribute("data-attr-custom-task-query")||e.dataset.customTaskQuery||e.dataset.attrCustomTaskQuery,n=e.getAttribute("custom-task-view")||e.getAttribute("data-attr-custom-task-view")||e.dataset.customTaskView||e.dataset.attrCustomTaskView;if(t)return{query:t.trim(),view:n};const r=e.getAttribute("data-attrs");if(!r)return{};try{const i=JSON.parse(r),l=(a=i["custom-task-query"])==null?void 0:a.trim(),c=i["custom-task-view"];return{query:l,view:c}}catch{return{}}}}class Zb{constructor(e=6e4,t=100){y(this,"cache",new Map);y(this,"metrics",{hits:0,misses:0,evictions:0});y(this,"maxSize");this.ttlMs=e,this.maxSize=t}buildKey(e,t){return`${e}::${t}`}get(e){const t=this.cache.get(e);return t?this.ttlMs>0&&Date.now()-t.updatedAt>this.ttlMs?(this.cache.delete(e),this.metrics.misses++,null):(t.lastAccessedAt=Date.now(),this.cache.delete(e),this.cache.set(e,t),this.metrics.hits++,t):(this.metrics.misses++,null)}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictLRU();const n=Date.now();this.cache.set(e,{result:t,updatedAt:n,lastAccessedAt:n})}clear(){this.cache.clear()}evictLRU(){const e=this.cache.keys().next().value;e&&(this.cache.delete(e),this.metrics.evictions++)}getMetrics(){return{hits:this.metrics.hits,misses:this.metrics.misses,size:this.cache.size,evictions:this.metrics.evictions}}resetMetrics(){this.metrics.hits=0,this.metrics.misses=0,this.metrics.evictions=0}}class Xb{render(e,t){if(e.innerHTML="",e.classList.add("rt-inline-query"),e.dataset.query=t.query,e.dataset.view=t.view,e.setAttribute("role","region"),e.setAttribute("aria-label","Task query results"),t.isIndexing){e.appendChild(this.renderLoadingState());return}if(t.error){e.appendChild(this.renderErrorState(t.error));return}if(!t.result){e.appendChild(this.renderState("No results yet."));return}const n=t.result.tasks,r=n.length;if(r===0||n.length===0){e.appendChild(this.renderEmptyState());return}const a=document.createElement("div");a.className="rt-inline-query__header",a.textContent=`Inline Tasks · ${r}`,e.appendChild(a);const i=t.view||"list",l=t.result.groups;if(l&&l.size>0?l.forEach((c,u)=>{const h=this.renderGroupSection(u,c,i,t);e.appendChild(h)}):e.appendChild(this.renderTaskCollection(n,i,t)),typeof t.maxItems=="number"&&typeof t.renderedCount=="number"&&t.renderedCount<r){const c=document.createElement("div");c.className="rt-inline-query__footer";const u=document.createElement("button");u.type="button",u.className="rt-inline-query__more",u.dataset.rtAction="more",u.textContent=`Show more (${t.renderedCount}/${r})`,c.appendChild(u),e.appendChild(c)}}renderGroupSection(e,t,n,r){const a=document.createElement("section");a.className="rt-inline-query__group";const i=document.createElement("div");return i.className="rt-inline-query__group-title",i.textContent=e||"Untitled",a.appendChild(i),a.appendChild(this.renderTaskCollection(t,n,r)),a}renderTaskCollection(e,t,n){return t==="table"?this.renderTable(e,n):this.renderList(e,n)}renderList(e,t){const n=document.createElement("ul");n.className="rt-inline-query__list",n.setAttribute("role","list"),n.setAttribute("aria-label","Tasks");const r=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(i=>{const l=document.createElement("li");l.className="rt-inline-query__item",l.dataset.taskId=i.id;const c=document.createElement("button");c.type="button",c.className="rt-inline-query__checkbox",c.dataset.rtAction="toggle",c.setAttribute("aria-pressed",String(i.status==="done"));const u=i.status==="done"?`Mark incomplete: ${i.name.replace(/"/g,"'")}`:`Mark complete: ${i.name.replace(/"/g,"'")}`;c.setAttribute("aria-label",u),c.textContent=i.status==="done"?"☑":"☐";const h=document.createElement("span");h.className="rt-inline-query__title",h.textContent=i.name,i.status==="done"&&h.classList.add("rt-inline-query__title--done");const v=document.createElement("span");v.className="rt-inline-query__meta",v.textContent=this.formatTaskMeta(i);const p=this.renderSource(i),m=document.createElement("button");m.type="button",m.className="rt-inline-query__edit",m.dataset.rtAction="edit",m.setAttribute("aria-label",`Edit task: ${i.name.replace(/"/g,"'")}`),m.textContent="Edit",l.appendChild(c),l.appendChild(h),l.appendChild(v),p&&l.appendChild(p),l.appendChild(m),r.appendChild(l)}),n.appendChild(r),n}renderTable(e,t){const n=document.createElement("table");n.className="rt-inline-query__table",n.setAttribute("role","table"),n.setAttribute("aria-label","Tasks table");const r=document.createElement("thead"),a=document.createElement("tr");["Status","Task","Dates","Priority","Source",""].forEach(u=>{const h=document.createElement("th");h.textContent=u,a.appendChild(h)}),r.appendChild(a),n.appendChild(r);const i=document.createElement("tbody"),l=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(u=>{const h=document.createElement("tr");h.dataset.taskId=u.id;const v=document.createElement("td"),p=document.createElement("button");p.type="button",p.className="rt-inline-query__checkbox",p.dataset.rtAction="toggle",p.setAttribute("aria-pressed",String(u.status==="done"));const m=u.status==="done"?`Mark incomplete: ${u.name.replace(/"/g,"'")}`:`Mark complete: ${u.name.replace(/"/g,"'")}`;p.setAttribute("aria-label",m),p.textContent=u.status==="done"?"☑":"☐",v.appendChild(p);const k=document.createElement("td");k.textContent=u.name,u.status==="done"&&k.classList.add("rt-inline-query__title--done");const _=document.createElement("td");_.textContent=this.formatTaskDates(u);const g=document.createElement("td");g.textContent=u.priority??"—";const w=document.createElement("td"),S=this.renderSource(u);S?w.appendChild(S):w.textContent="—";const E=document.createElement("td"),x=document.createElement("button");x.type="button",x.className="rt-inline-query__edit",x.dataset.rtAction="edit",x.setAttribute("aria-label",`Edit task: ${u.name.replace(/"/g,"'")}`),x.textContent="Edit",E.appendChild(x),h.appendChild(v),h.appendChild(k),h.appendChild(_),h.appendChild(g),h.appendChild(w),h.appendChild(E),l.appendChild(h)}),i.appendChild(l),n.appendChild(i),n}getRenderedTasks(e,t){return t.maxItems?e.slice(0,t.maxItems):e}formatTaskDates(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),t.length>0?t.join(" · "):"—"}formatTaskMeta(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),e.priority&&t.push(`Priority ${e.priority}`),t.length>0?t.join(" · "):"No dates"}formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString()}catch{return e}}renderSource(e){if(!e.linkedBlockId&&!e.path)return null;const t=document.createElement("a");return t.className="rt-inline-query__source",t.dataset.rtAction="jump",t.dataset.blockId=e.linkedBlockId??"",e.linkedBlockId&&(t.href=`siyuan://blocks/${e.linkedBlockId}`),t.textContent=this.formatSourceLabel(e),t.title=e.path??e.linkedBlockId??"",t}formatSourceLabel(e){if(e.path){const t=e.path.split("/");return t[t.length-1]||e.path}return e.linkedBlockId?"Block":"Source"}renderState(e,t="info"){const n=document.createElement("div");return n.className=`rt-inline-query__state rt-inline-query__state--${t}`,n.textContent=e,n}renderLoadingState(){const e=document.createElement("div");e.className="rt-inline-query__loading",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Loading tasks");const t=document.createElement("div");t.className="rt-inline-query__spinner";const n=document.createElement("div");return n.className="rt-inline-query__loading-text",n.textContent="Building index…",e.appendChild(t),e.appendChild(n),e}renderErrorState(e){const t=document.createElement("div");t.className="rt-inline-query__state rt-inline-query__state--error",t.setAttribute("role","alert");const n=document.createElement("div");n.className="rt-inline-query__error-icon",n.textContent="⚠";const r=document.createElement("div");r.className="rt-inline-query__error-message",r.textContent=e;const a=document.createElement("div");return a.className="rt-inline-query__error-hint",a.textContent="Check your query syntax and try again.",t.appendChild(n),t.appendChild(r),t.appendChild(a),t}renderEmptyState(){const e=document.createElement("div");e.className="rt-inline-query__state rt-inline-query__state--empty";const t=document.createElement("div");t.className="rt-inline-query__empty-icon",t.textContent="📋";const n=document.createElement("div");n.className="rt-inline-query__empty-message",n.textContent="No tasks match this query";const r=document.createElement("div");return r.className="rt-inline-query__empty-hint",r.textContent="Try adjusting your filters or create a new task.",e.appendChild(t),e.appendChild(n),e.appendChild(r),e}}class Jb{constructor(e){y(this,"parser",new Qb);y(this,"renderer",new Xb);y(this,"cache",new Zb);y(this,"queryComposer",new ou(new ds));y(this,"blocks",new Map);y(this,"refreshTimer");y(this,"indexReady",!1);y(this,"unsubs",[]);y(this,"debounceMs");y(this,"pageSize");this.options=e,this.debounceMs=e.debounceMs??300,this.pageSize=e.pageSize??50}mount(){var r,a,i,l;this.refreshAll();const{plugin:e}=this.options,t=()=>this.scheduleRefresh(),n=()=>this.scheduleRefresh();try{const c=(a=(r=e.eventBus).on)==null?void 0:a.call(r,"loaded-protyle",t),u=(l=(i=e.eventBus).on)==null?void 0:l.call(i,"switch-protyle",n);typeof c=="function"&&this.unsubs.push(c),typeof u=="function"&&this.unsubs.push(u)}catch(c){at("Inline query controller failed to bind protyle events",c)}this.unsubs.push(He.on("task:refresh",()=>{this.cache.clear(),this.scheduleRefresh()})),this.unsubs.push(He.on("task:settings",()=>{this.cache.clear(),this.scheduleRefresh()}))}destroy(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.blocks.forEach(({container:e})=>e.remove()),this.blocks.clear(),this.unsubs.forEach(e=>e()),this.unsubs=[]}scheduleRefresh(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.refreshTimer=globalThis.setTimeout(()=>{this.refreshAll()},this.debounceMs)}refreshAll(){const e=this.getProtyleRoots();if(e.length===0)return;const t=new Set;e.forEach(n=>{this.parser.parse(n).forEach(a=>{t.add(a.id);const i=this.getOrCreateBlockState(a);this.renderBlock(i)})}),Array.from(this.blocks.keys()).forEach(n=>{if(!t.has(n)){const r=this.blocks.get(n);r==null||r.container.remove(),this.blocks.delete(n)}}),this.indexReady=!0}renderBlock(e){const{block:t}=e,n=t.view??"list";if(!this.indexReady){this.renderer.render(e.container,{query:t.query,view:n,isIndexing:!0});return}let r,a;try{a=this.executeQuery(t.query)}catch(l){r=l instanceof Error?l.message:String(l)}const i=a?Math.min(e.renderLimit,a.tasks.length):0;this.renderer.render(e.container,{query:t.query,view:n,result:a,error:r,maxItems:e.renderLimit,renderedCount:i})}executeQuery(e){const t=this.options.settingsService.get(),n=this.buildSettingsHash(t),r=this.cache.buildKey(e,n),a=this.cache.get(r);if(a)return a.result;const i={getAllTasks:()=>this.options.repository.getAllTasks()},l=new iu(i,{urgencySettings:t.urgency}),c=vr.getInstance();if(c.isEnabled()&&c.getError())throw new Error(`Global query error: ${c.getError()}`);const u=this.queryComposer.compose(e,c.getAST()).ast,h=l.execute(u);return this.cache.set(r,h),h}buildSettingsHash(e){try{return JSON.stringify(e)}catch{return String(Date.now())}}getOrCreateBlockState(e){const t=this.blocks.get(e.id);if(t)return t.block=e,t;const n=document.createElement("div");n.dataset.rtInlineQuery=e.id,n.className="rt-inline-query",e.element.insertAdjacentElement("afterend",n),n.addEventListener("click",a=>this.handleContainerClick(a));const r={block:e,container:n,renderLimit:this.pageSize};return this.blocks.set(e.id,r),r}handleContainerClick(e){const t=e.target;if(!t)return;const n=t.closest("[data-rt-action]");if(!n)return;const r=n.dataset.rtAction,a=t.closest(".rt-inline-query");if(!a)return;const i=a.dataset.rtInlineQuery;if(!i)return;const l=this.blocks.get(i);if(!l)return;if(r==="more"){l.renderLimit+=this.pageSize,this.renderBlock(l);return}const c=t.closest("[data-task-id]"),u=c==null?void 0:c.dataset.taskId;if(u){if(r==="toggle"){this.options.onToggleTask(u);return}if(r==="edit"){const h=this.options.repository.getTask(u);h&&this.options.onEditTask(h)}}}getProtyleRoots(){return Array.from(document.querySelectorAll(".protyle-wysiwyg"))}}class e_ extends Fi.Plugin{constructor(){super(...arguments);y(this,"taskManager");y(this,"repository");y(this,"scheduler");y(this,"eventService");y(this,"migrationManager");y(this,"topbarMenu");y(this,"settingsService");y(this,"dashboardComponent",null);y(this,"dockEl");y(this,"quickAddComponent",null);y(this,"quickAddContainer",null);y(this,"taskEditorComponent",null);y(this,"taskEditorContainer",null);y(this,"postponeComponent",null);y(this,"postponeContainer",null);y(this,"pendingCompletionTimeouts",new Map);y(this,"shortcutManager",null);y(this,"inlineQueryController",null);y(this,"handleCreateTaskEvent",t=>{try{const n=t;he("Create task event received",n.detail),this.openQuickAdd(n.detail)}catch(n){Te("Failed to handle create task event",n),K.error("Failed to open task creator.")}});y(this,"handleSettingsEvent",t=>{try{he("Settings event received",t.detail),this.openDock()}catch(n){Te("Failed to handle settings event",n),K.error("Failed to open settings.")}});y(this,"handleCompleteTaskEvent",async t=>{try{const n=t,{taskId:r}=n.detail??{};if(!r)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(r)}catch(n){Te("Failed to complete task",n),K.error("Failed to complete task.")}});y(this,"handleSnoozeTaskEvent",async t=>{try{const n=t,{taskId:r,minutes:a}=n.detail??{};if(!r||typeof a!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(r,a)}catch(n){Te("Failed to snooze task",n),K.error("Failed to snooze task.")}})}async onload(){he("Loading Recurring Tasks Plugin"),this.migrationManager=new yy(this);try{await this.migrationManager.migrate(ws)}catch(r){Te("Migration failed, continuing with existing data",r)}const t=wa.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const n=this.taskManager.getSettingsService();this.settingsService=n;try{await this.taskManager.start()}catch(r){Te("Failed to start TaskManager",r)}this.shortcutManager=await Kb(this,this.repository,{createTask:r=>this.dispatchCreateTask(r),completeTask:r=>He.emit("task:complete",{taskId:r}),postponeTask:r=>this.openPostponePicker(r),openDock:()=>this.openDock(),openTaskEditor:()=>this.openTaskEditor()},this.scheduler.getRecurrenceEngine(),()=>n.get()),Hb(this),this.topbarMenu=new Vb(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:ph,init:r=>{this.dockEl=r.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),this.inlineQueryController=new Jb({plugin:this,repository:this.repository,settingsService:this.settingsService,onEditTask:r=>this.openTaskEditor(r),onToggleTask:r=>He.emit("task:complete",{taskId:r})}),this.inlineQueryController.mount(),he("Recurring Tasks Plugin loaded successfully")}async onunload(){he("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.closePostponePicker(),this.removeEventListeners(),this.shortcutManager&&(this.shortcutManager.destroy(),this.shortcutManager=null),this.inlineQueryController&&(this.inlineQueryController.destroy(),this.inlineQueryController=null)}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=Qr(ly,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService,shortcutManager:this.shortcutManager,settingsService:this.settingsService}}))}destroyDashboard(){this.dashboardComponent&&(Zr(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{He.on("task:create",t=>{he("Create task event received",t),this.openQuickAdd(t)}),He.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),He.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),He.on("task:settings",()=>{this.openDock()}),He.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){Te("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){He.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const n=this.repository.getTask(t);if(n){if(this.pendingCompletionTimeouts.has(t)){K.info(`Completion already pending for "${n.name}".`);return}const r=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(n),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),He.emit("task:refresh",void 0),he(`Task completed: ${n.name}`)}catch(i){Te("Failed to finalize task completion",i),K.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,r);const a=()=>{const i=this.pendingCompletionTimeouts.get(t);i&&(globalThis.clearTimeout(i),this.pendingCompletionTimeouts.delete(t),K.info(`Undo: "${n.name}" restored`))};Ts({message:`Task "${n.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:a,showCountdown:!0})}}async handleSnoozeTask(t,n){const r=this.repository.getTask(t);r&&(await this.eventService.handleTaskSnoozed(r),await this.scheduler.delayTask(t,n),this.topbarMenu&&this.topbarMenu.update(),he(`Task snoozed: ${r.name} for ${n} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=Qr(vy,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}openPostponePicker(t){const n=this.repository.getTask(t);if(!n){K.error("Task not found");return}this.postponeComponent&&this.closePostponePicker(),this.postponeContainer=document.createElement("div"),document.body.appendChild(this.postponeContainer),this.postponeComponent=Qr(my,{target:this.postponeContainer,props:{taskName:n.name,onClose:()=>this.closePostponePicker(),onSelect:r=>{Ni(t,r),this.closePostponePicker()}}})}closePostponePicker(){this.postponeComponent&&(Zr(this.postponeComponent),this.postponeComponent=null),this.postponeContainer&&(this.postponeContainer.remove(),this.postponeContainer=null)}dispatchCreateTask(t){He.emit("task:create",t),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:t}))}closeQuickAdd(){this.quickAddComponent&&(Zr(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=Qr(lu,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(Zr(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=e_;

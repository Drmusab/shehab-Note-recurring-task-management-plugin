"use strict";var fo=Object.defineProperty;var nr=a=>{throw TypeError(a)};var _o=(a,e,t)=>e in a?fo(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var D=(a,e,t)=>_o(a,typeof e!="symbol"?e+"":e,t),vn=(a,e,t)=>e.has(a)||nr("Cannot "+t);var I=(a,e,t)=>(vn(a,e,"read from private field"),t?t.call(a):e.get(a)),Ee=(a,e,t)=>e.has(a)?nr("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,t),Se=(a,e,t,s)=>(vn(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t),nt=(a,e,t)=>(vn(a,e,"access private method"),t);const jn=require("siyuan"),wn=!1;var Kn=Array.isArray,po=Array.prototype.indexOf,sn=Array.from,go=Object.defineProperty,ia=Object.getOwnPropertyDescriptor,mo=Object.getOwnPropertyDescriptors,yo=Object.prototype,ko=Array.prototype,Vr=Object.getPrototypeOf,rr=Object.isExtensible;function bo(a){for(var e=0;e<a.length;e++)a[e]()}function Wr(){var a,e,t=new Promise((s,n)=>{a=s,e=n});return{promise:t,resolve:a,reject:e}}function Qr(a,e){if(Array.isArray(a))return a;if(!(Symbol.iterator in a))return Array.from(a);const t=[];for(const s of a)if(t.push(s),t.length===e)break;return t}const lt=2,Wa=4,an=8,Xr=1<<24,hs=16,fs=32,Xs=64,Un=128,Pt=512,ht=1024,kt=2048,_s=4096,It=8192,cs=16384,Hn=32768,_a=65536,ir=1<<17,$r=1<<18,ya=1<<19,wo=1<<20,os=1<<25,Ws=32768,Tn=1<<21,Gn=1<<22,Ds=1<<23,Us=Symbol("$state"),To=Symbol("legacy props"),So=Symbol(""),ra=new class extends Error{constructor(){super(...arguments);D(this,"name","StaleReactionError");D(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function Jr(a){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Do(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Eo(a){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Ao(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function xo(a){throw new Error("https://svelte.dev/e/effect_orphan")}function Co(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Io(a){throw new Error("https://svelte.dev/e/props_invalid_value")}function qo(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Oo(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Mo(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function No(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const Ro=1,Bo=2,Zr=4,Fo=8,Po=16,zo=1,Lo=4,jo=8,Ko=16,Uo=1,Ho=2,rt=Symbol(),Go="http://www.w3.org/1999/xhtml";function Yo(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Vo(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function ei(a){return a===this.v}function Wo(a,e){return a!=a?e==e:a!==e||a!==null&&typeof a=="object"||typeof a=="function"}function ti(a){return!Wo(a,this.v)}let Qo=!1,St=null;function pa(a){St=a}function Ue(a,e=!1,t){St={p:St,i:!1,c:null,e:null,s:a,x:null,l:null}}function He(a){var e=St,t=e.e;if(t!==null){e.e=null;for(var s of t)bi(s)}return e.i=!0,St=e.p,{}}function si(){return!0}let Ns=[];function ai(){var a=Ns;Ns=[],bo(a)}function ka(a){if(Ns.length===0&&!Aa){var e=Ns;queueMicrotask(()=>{e===Ns&&ai()})}Ns.push(a)}function Xo(){for(;Ns.length>0;)ai()}function ni(a){var e=Ce;if(e===null)return Te.f|=Ds,a;if(e.f&Hn)ga(a,e);else{if(!(e.f&Un))throw a;e.b.error(a)}}function ga(a,e){for(;e!==null;){if(e.f&Un)try{e.b.error(a);return}catch(t){a=t}e=e.parent}throw a}const $o=-7169;function Xe(a,e){a.f=a.f&$o|e}function Yn(a){a.f&Pt||a.deps===null?Xe(a,ht):Xe(a,_s)}function ri(a){if(a!==null)for(const e of a)!(e.f&lt)||!(e.f&Ws)||(e.f^=Ws,ri(e.deps))}function ii(a,e,t){a.f&kt?e.add(a):a.f&_s&&t.add(a),ri(a.deps),Xe(a,ht)}const ja=new Set;let we=null,Ea=null,it=null,Bt=[],nn=null,Sn=!1,Aa=!1;var ca,da,Fs,Ps,Na,ua,va,zt,Dn,En,oi,li;const Za=class Za{constructor(){Ee(this,zt);D(this,"committed",!1);D(this,"current",new Map);D(this,"previous",new Map);Ee(this,ca,new Set);Ee(this,da,new Set);Ee(this,Fs,0);Ee(this,Ps,0);Ee(this,Na,null);Ee(this,ua,new Set);Ee(this,va,new Set);D(this,"skipped_effects",new Set);D(this,"is_fork",!1)}is_deferred(){return this.is_fork||I(this,Ps)>0}process(e){var n;Bt=[],Ea=null,this.apply();var t=[],s=[];for(const i of e)nt(this,zt,Dn).call(this,i,t,s);this.is_fork||nt(this,zt,oi).call(this),this.is_deferred()?(nt(this,zt,En).call(this,s),nt(this,zt,En).call(this,t)):(Ea=this,we=null,or(s),or(t),Ea=null,(n=I(this,Na))==null||n.resolve()),it=null}capture(e,t){t!==rt&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Ds||(this.current.set(e,e.v),it==null||it.set(e,e.v))}activate(){we=this,this.apply()}deactivate(){we===this&&(we=null,it=null)}flush(){if(this.activate(),Bt.length>0){if(ci(),we!==null&&we!==this)return}else I(this,Fs)===0&&this.process([]);this.deactivate()}discard(){for(const e of I(this,da))e(this);I(this,da).clear()}increment(e){Se(this,Fs,I(this,Fs)+1),e&&Se(this,Ps,I(this,Ps)+1)}decrement(e){Se(this,Fs,I(this,Fs)-1),e&&Se(this,Ps,I(this,Ps)-1),this.revive()}revive(){for(const e of I(this,ua))I(this,va).delete(e),Xe(e,kt),us(e);for(const e of I(this,va))Xe(e,_s),us(e);this.flush()}oncommit(e){I(this,ca).add(e)}ondiscard(e){I(this,da).add(e)}settled(){return(I(this,Na)??Se(this,Na,Wr())).promise}static ensure(){if(we===null){const e=we=new Za;ja.add(we),Aa||Za.enqueue(()=>{we===e&&e.flush()})}return we}static enqueue(e){ka(e)}apply(){}};ca=new WeakMap,da=new WeakMap,Fs=new WeakMap,Ps=new WeakMap,Na=new WeakMap,ua=new WeakMap,va=new WeakMap,zt=new WeakSet,Dn=function(e,t,s){e.f^=ht;for(var n=e.first,i=null;n!==null;){var o=n.f,c=(o&(fs|Xs))!==0,l=c&&(o&ht)!==0,u=l||(o&It)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){c?n.f^=ht:i!==null&&o&(Wa|an|Xr)?i.b.defer_effect(n):o&Wa?t.push(n):Pa(n)&&(o&hs&&I(this,ua).add(n),qa(n));var h=n.first;if(h!==null){n=h;continue}}var m=n.parent;for(n=n.next;n===null&&m!==null;)m===i&&(i=null),n=m.next,m=m.parent}},En=function(e){for(var t=0;t<e.length;t+=1)ii(e[t],I(this,ua),I(this,va))},oi=function(){if(I(this,Ps)===0){for(const e of I(this,ca))e();I(this,ca).clear()}I(this,Fs)===0&&nt(this,zt,li).call(this)},li=function(){var n;if(ja.size>1){this.previous.clear();var e=it,t=!0;for(const i of ja){if(i===this){t=!1;continue}const o=[];for(const[l,u]of this.current){if(i.current.has(l))if(t&&u!==i.current.get(l))i.current.set(l,u);else continue;o.push(l)}if(o.length===0)continue;const c=[...i.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var s=Bt;Bt=[];const l=new Set,u=new Map;for(const h of o)di(h,c,l,u);if(Bt.length>0){we=i,i.apply();for(const h of Bt)nt(n=i,zt,Dn).call(n,h,[],[]);i.deactivate()}Bt=s}}we=null,it=e}this.committed=!0,ja.delete(this)};let ls=Za;function Jo(a){var e=Aa;Aa=!0;try{for(var t;;){if(Xo(),Bt.length===0&&(we==null||we.flush(),Bt.length===0))return nn=null,t;ci()}}finally{Aa=e}}function ci(){var a=Gs;Sn=!0;var e=null;try{var t=0;for(Xa(!0);Bt.length>0;){var s=ls.ensure();if(t++>1e3){var n,i;Zo()}s.process(Bt),Es.clear()}}finally{Sn=!1,Xa(a),nn=null}}function Zo(){try{Co()}catch(a){ga(a,nn)}}let Gt=null;function or(a){var e=a.length;if(e!==0){for(var t=0;t<e;){var s=a[t++];if(!(s.f&(cs|It))&&Pa(s)&&(Gt=new Set,qa(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?Ei(s):s.fn=null),(Gt==null?void 0:Gt.size)>0)){Es.clear();for(const n of Gt){if(n.f&(cs|It))continue;const i=[n];let o=n.parent;for(;o!==null;)Gt.has(o)&&(Gt.delete(o),i.push(o)),o=o.parent;for(let c=i.length-1;c>=0;c--){const l=i[c];l.f&(cs|It)||qa(l)}}Gt.clear()}}Gt=null}}function di(a,e,t,s){if(!t.has(a)&&(t.add(a),a.reactions!==null))for(const n of a.reactions){const i=n.f;i&lt?di(n,e,t,s):i&(Gn|hs)&&!(i&kt)&&ui(n,e,s)&&(Xe(n,kt),us(n))}}function ui(a,e,t){const s=t.get(a);if(s!==void 0)return s;if(a.deps!==null)for(const n of a.deps){if(e.includes(n))return!0;if(n.f&lt&&ui(n,e,t))return t.set(n,!0),!0}return t.set(a,!1),!1}function us(a){for(var e=nn=a;e.parent!==null;){e=e.parent;var t=e.f;if(Sn&&e===Ce&&t&hs&&!(t&$r))return;if(t&(Xs|fs)){if(!(t&ht))return;e.f^=ht}}Bt.push(e)}function el(a){let e=0,t=Qs(0),s;return()=>{Qn()&&(r(t),ln(()=>(e===0&&(s=$s(()=>a(()=>xa(t)))),e+=1,()=>{ka(()=>{e-=1,e===0&&(s==null||s(),s=void 0,xa(t))})})))}}var tl=_a|ya|Un;function sl(a,e,t){new al(a,e,t)}var Nt,Ln,Jt,zs,Zt,Rt,bt,es,is,bs,Ls,ws,js,ha,fa,Ts,en,Qe,nl,rl,An,Ua,Ha,xn;class al{constructor(e,t,s){Ee(this,Qe);D(this,"parent");D(this,"is_pending",!1);Ee(this,Nt);Ee(this,Ln,null);Ee(this,Jt);Ee(this,zs);Ee(this,Zt);Ee(this,Rt,null);Ee(this,bt,null);Ee(this,es,null);Ee(this,is,null);Ee(this,bs,null);Ee(this,Ls,0);Ee(this,ws,0);Ee(this,js,!1);Ee(this,ha,new Set);Ee(this,fa,new Set);Ee(this,Ts,null);Ee(this,en,el(()=>(Se(this,Ts,Qs(I(this,Ls))),()=>{Se(this,Ts,null)})));Se(this,Nt,e),Se(this,Jt,t),Se(this,zs,s),this.parent=Ce.b,this.is_pending=!!I(this,Jt).pending,Se(this,Zt,$n(()=>{Ce.b=this;{var n=nt(this,Qe,An).call(this);try{Se(this,Rt,Ft(()=>s(n)))}catch(i){this.error(i)}I(this,ws)>0?nt(this,Qe,Ha).call(this):this.is_pending=!1}return()=>{var i;(i=I(this,bs))==null||i.remove()}},tl))}defer_effect(e){ii(e,I(this,ha),I(this,fa))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!I(this,Jt).pending}update_pending_count(e){nt(this,Qe,xn).call(this,e),Se(this,Ls,I(this,Ls)+e),I(this,Ts)&&ma(I(this,Ts),I(this,Ls))}get_effect_pending(){return I(this,en).call(this),r(I(this,Ts))}error(e){var t=I(this,Jt).onerror;let s=I(this,Jt).failed;if(I(this,js)||!t&&!s)throw e;I(this,Rt)&&(Tt(I(this,Rt)),Se(this,Rt,null)),I(this,bt)&&(Tt(I(this,bt)),Se(this,bt,null)),I(this,es)&&(Tt(I(this,es)),Se(this,es,null));var n=!1,i=!1;const o=()=>{if(n){Vo();return}n=!0,i&&No(),ls.ensure(),Se(this,Ls,0),I(this,es)!==null&&Hs(I(this,es),()=>{Se(this,es,null)}),this.is_pending=this.has_pending_snippet(),Se(this,Rt,nt(this,Qe,Ua).call(this,()=>(Se(this,js,!1),Ft(()=>I(this,zs).call(this,I(this,Nt)))))),I(this,ws)>0?nt(this,Qe,Ha).call(this):this.is_pending=!1};var c=Te;try{wt(null),i=!0,t==null||t(e,o),i=!1}catch(l){ga(l,I(this,Zt)&&I(this,Zt).parent)}finally{wt(c)}s&&ka(()=>{Se(this,es,nt(this,Qe,Ua).call(this,()=>{ls.ensure(),Se(this,js,!0);try{return Ft(()=>{s(I(this,Nt),()=>e,()=>o)})}catch(l){return ga(l,I(this,Zt).parent),null}finally{Se(this,js,!1)}}))})}}Nt=new WeakMap,Ln=new WeakMap,Jt=new WeakMap,zs=new WeakMap,Zt=new WeakMap,Rt=new WeakMap,bt=new WeakMap,es=new WeakMap,is=new WeakMap,bs=new WeakMap,Ls=new WeakMap,ws=new WeakMap,js=new WeakMap,ha=new WeakMap,fa=new WeakMap,Ts=new WeakMap,en=new WeakMap,Qe=new WeakSet,nl=function(){try{Se(this,Rt,Ft(()=>I(this,zs).call(this,I(this,Nt))))}catch(e){this.error(e)}},rl=function(){const e=I(this,Jt).pending;e&&(Se(this,bt,Ft(()=>e(I(this,Nt)))),ls.enqueue(()=>{var t=nt(this,Qe,An).call(this);Se(this,Rt,nt(this,Qe,Ua).call(this,()=>(ls.ensure(),Ft(()=>I(this,zs).call(this,t))))),I(this,ws)>0?nt(this,Qe,Ha).call(this):(Hs(I(this,bt),()=>{Se(this,bt,null)}),this.is_pending=!1)}))},An=function(){var e=I(this,Nt);return this.is_pending&&(Se(this,bs,ds()),I(this,Nt).before(I(this,bs)),e=I(this,bs)),e},Ua=function(e){var t=Ce,s=Te,n=St;ss(I(this,Zt)),wt(I(this,Zt)),pa(I(this,Zt).ctx);try{return e()}catch(i){return ni(i),null}finally{ss(t),wt(s),pa(n)}},Ha=function(){const e=I(this,Jt).pending;I(this,Rt)!==null&&(Se(this,is,document.createDocumentFragment()),I(this,is).append(I(this,bs)),Ci(I(this,Rt),I(this,is))),I(this,bt)===null&&Se(this,bt,Ft(()=>e(I(this,Nt))))},xn=function(e){var t;if(!this.has_pending_snippet()){this.parent&&nt(t=this.parent,Qe,xn).call(t,e);return}if(Se(this,ws,I(this,ws)+e),I(this,ws)===0){this.is_pending=!1;for(const s of I(this,ha))Xe(s,kt),us(s);for(const s of I(this,fa))Xe(s,_s),us(s);I(this,ha).clear(),I(this,fa).clear(),I(this,bt)&&Hs(I(this,bt),()=>{Se(this,bt,null)}),I(this,is)&&(I(this,Nt).before(I(this,is)),Se(this,is,null))}};function il(a,e,t,s){const n=rn;if(t.length===0&&a.length===0){s(e.map(n));return}var i=we,o=Ce,c=ol();function l(){Promise.all(t.map(u=>ll(u))).then(u=>{c();try{s([...e.map(n),...u])}catch(h){o.f&cs||ga(h,o)}i==null||i.deactivate(),Qa()}).catch(u=>{ga(u,o)})}a.length>0?Promise.all(a).then(()=>{c();try{return l()}finally{i==null||i.deactivate(),Qa()}}):l()}function ol(){var a=Ce,e=Te,t=St,s=we;return function(i=!0){ss(a),wt(e),pa(t),i&&(s==null||s.activate())}}function Qa(){ss(null),wt(null),pa(null)}function rn(a){var e=lt|kt,t=Te!==null&&Te.f&lt?Te:null;return Ce!==null&&(Ce.f|=ya),{ctx:St,deps:null,effects:null,equals:ei,f:e,fn:a,reactions:null,rv:0,v:rt,wv:0,parent:t??Ce,ac:null}}function ll(a,e,t){let s=Ce;s===null&&Do();var n=s.b,i=void 0,o=Qs(rt),c=!Te,l=new Map;return yl(()=>{var _;var u=Wr();i=u.promise;try{Promise.resolve(a()).then(u.resolve,u.reject).then(()=>{h===we&&h.committed&&h.deactivate(),Qa()})}catch(q){u.reject(q),Qa()}var h=we;if(c){var m=n.is_rendered();n.update_pending_count(1),h.increment(m),(_=l.get(h))==null||_.reject(ra),l.delete(h),l.set(h,u)}const y=(q,g=void 0)=>{if(h.activate(),g)g!==ra&&(o.f|=Ds,ma(o,g));else{o.f&Ds&&(o.f^=Ds),ma(o,q);for(const[p,w]of l){if(l.delete(p),p===h)break;w.reject(ra)}}c&&(n.update_pending_count(-1),h.decrement(m))};u.promise.then(y,q=>y(null,q||"unknown"))}),Xn(()=>{for(const u of l.values())u.reject(ra)}),new Promise(u=>{function h(m){function y(){m===i?u(o):h(i)}m.then(y,y)}h(i)})}function Q(a){const e=rn(a);return Ii(e),e}function vi(a){const e=rn(a);return e.equals=ti,e}function hi(a){var e=a.effects;if(e!==null){a.effects=null;for(var t=0;t<e.length;t+=1)Tt(e[t])}}function cl(a){for(var e=a.parent;e!==null;){if(!(e.f&lt))return e.f&cs?null:e;e=e.parent}return null}function Vn(a){var e,t=Ce;ss(cl(a));try{a.f&=~Ws,hi(a),e=Ni(a)}finally{ss(t)}return e}function fi(a){var e=Vn(a);if(!a.equals(e)&&(a.wv=Oi(),(!(we!=null&&we.is_fork)||a.deps===null)&&(a.v=e,a.deps===null))){Xe(a,ht);return}As||(it!==null?(Qn()||we!=null&&we.is_fork)&&it.set(a,e):Yn(a))}let Cn=new Set;const Es=new Map;let _i=!1;function Qs(a,e){var t={f:0,v:a,reactions:null,equals:ei,rv:0,wv:0};return t}function W(a,e){const t=Qs(a);return Ii(t),t}function dl(a,e=!1,t=!0){const s=Qs(a);return e||(s.equals=ti),s}function f(a,e,t=!1){Te!==null&&(!Vt||Te.f&ir)&&si()&&Te.f&(lt|hs|Gn|ir)&&!(yt!=null&&yt.includes(a))&&Mo();let s=t?ye(e):e;return ma(a,s)}function ma(a,e){if(!a.equals(e)){var t=a.v;As?Es.set(a,e):Es.set(a,t),a.v=e;var s=ls.ensure();if(s.capture(a,t),a.f&lt){const n=a;a.f&kt&&Vn(n),Yn(n)}a.wv=Oi(),pi(a,kt),Ce!==null&&Ce.f&ht&&!(Ce.f&(fs|Xs))&&(Mt===null?bl([a]):Mt.push(a)),!s.is_fork&&Cn.size>0&&!_i&&ul()}return e}function ul(){_i=!1;var a=Gs;Xa(!0);const e=Array.from(Cn);try{for(const t of e)t.f&ht&&Xe(t,_s),Pa(t)&&qa(t)}finally{Xa(a)}Cn.clear()}function lr(a,e=1){var t=r(a),s=e===1?t++:t--;return f(a,t),s}function xa(a){f(a,a.v+1)}function pi(a,e){var t=a.reactions;if(t!==null)for(var s=t.length,n=0;n<s;n++){var i=t[n],o=i.f,c=(o&kt)===0;if(c&&Xe(i,e),o&lt){var l=i;it==null||it.delete(l),o&Ws||(o&Pt&&(i.f|=Ws),pi(l,_s))}else c&&(o&hs&&Gt!==null&&Gt.add(i),us(i))}}function ye(a){if(typeof a!="object"||a===null||Us in a)return a;const e=Vr(a);if(e!==yo&&e!==ko)return a;var t=new Map,s=Kn(a),n=W(0),i=Ys,o=c=>{if(Ys===i)return c();var l=Te,u=Ys;wt(null),hr(i);var h=c();return wt(l),hr(u),h};return s&&t.set("length",W(a.length)),new Proxy(a,{defineProperty(c,l,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&qo();var h=t.get(l);return h===void 0?h=o(()=>{var m=W(u.value);return t.set(l,m),m}):f(h,u.value,!0),!0},deleteProperty(c,l){var u=t.get(l);if(u===void 0){if(l in c){const h=o(()=>W(rt));t.set(l,h),xa(n)}}else f(u,rt),xa(n);return!0},get(c,l,u){var _;if(l===Us)return a;var h=t.get(l),m=l in c;if(h===void 0&&(!m||(_=ia(c,l))!=null&&_.writable)&&(h=o(()=>{var q=ye(m?c[l]:rt),g=W(q);return g}),t.set(l,h)),h!==void 0){var y=r(h);return y===rt?void 0:y}return Reflect.get(c,l,u)},getOwnPropertyDescriptor(c,l){var u=Reflect.getOwnPropertyDescriptor(c,l);if(u&&"value"in u){var h=t.get(l);h&&(u.value=r(h))}else if(u===void 0){var m=t.get(l),y=m==null?void 0:m.v;if(m!==void 0&&y!==rt)return{enumerable:!0,configurable:!0,value:y,writable:!0}}return u},has(c,l){var y;if(l===Us)return!0;var u=t.get(l),h=u!==void 0&&u.v!==rt||Reflect.has(c,l);if(u!==void 0||Ce!==null&&(!h||(y=ia(c,l))!=null&&y.writable)){u===void 0&&(u=o(()=>{var _=h?ye(c[l]):rt,q=W(_);return q}),t.set(l,u));var m=r(u);if(m===rt)return!1}return h},set(c,l,u,h){var T;var m=t.get(l),y=l in c;if(s&&l==="length")for(var _=u;_<m.v;_+=1){var q=t.get(_+"");q!==void 0?f(q,rt):_ in c&&(q=o(()=>W(rt)),t.set(_+"",q))}if(m===void 0)(!y||(T=ia(c,l))!=null&&T.writable)&&(m=o(()=>W(void 0)),f(m,ye(u)),t.set(l,m));else{y=m.v!==rt;var g=o(()=>ye(u));f(m,g)}var p=Reflect.getOwnPropertyDescriptor(c,l);if(p!=null&&p.set&&p.set.call(h,u),!y){if(s&&typeof l=="string"){var w=t.get("length"),x=Number(l);Number.isInteger(x)&&x>=w.v&&f(w,x+1)}xa(n)}return!0},ownKeys(c){r(n);var l=Reflect.ownKeys(c).filter(m=>{var y=t.get(m);return y===void 0||y.v!==rt});for(var[u,h]of t)h.v!==rt&&!(u in c)&&l.push(u);return l},setPrototypeOf(){Oo()}})}function cr(a){try{if(a!==null&&typeof a=="object"&&Us in a)return a[Us]}catch{}return a}function vl(a,e){return Object.is(cr(a),cr(e))}var dr,gi,mi,yi;function hl(){if(dr===void 0){dr=window,gi=/Firefox/.test(navigator.userAgent);var a=Element.prototype,e=Node.prototype,t=Text.prototype;mi=ia(e,"firstChild").get,yi=ia(e,"nextSibling").get,rr(a)&&(a.__click=void 0,a.__className=void 0,a.__attributes=null,a.__style=void 0,a.__e=void 0),rr(t)&&(t.__t=void 0)}}function ds(a=""){return document.createTextNode(a)}function Ss(a){return mi.call(a)}function Fa(a){return yi.call(a)}function d(a,e){return Ss(a)}function qe(a,e=!1){{var t=Ss(a);return t instanceof Comment&&t.data===""?Fa(t):t}}function v(a,e=1,t=!1){let s=a;for(;e--;)s=Fa(s);return s}function fl(a){a.textContent=""}function ki(){return!1}let ur=!1;function _l(){ur||(ur=!0,document.addEventListener("reset",a=>{Promise.resolve().then(()=>{var e;if(!a.defaultPrevented)for(const t of a.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function on(a){var e=Te,t=Ce;wt(null),ss(null);try{return a()}finally{wt(e),ss(t)}}function Wn(a,e,t,s=t){a.addEventListener(e,()=>on(t));const n=a.__on_r;n?a.__on_r=()=>{n(),s(!0)}:a.__on_r=()=>s(!0),_l()}function pl(a){Ce===null&&(Te===null&&xo(),Ao()),As&&Eo()}function gl(a,e){var t=e.last;t===null?e.last=e.first=a:(t.next=a,a.prev=t,e.last=a)}function ps(a,e,t){var s=Ce;s!==null&&s.f&It&&(a|=It);var n={ctx:St,deps:null,nodes:null,f:a|kt|Pt,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{qa(n),n.f|=Hn}catch(c){throw Tt(n),c}else e!==null&&us(n);var i=n;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&!(i.f&ya)&&(i=i.first,a&hs&&a&_a&&i!==null&&(i.f|=_a)),i!==null&&(i.parent=s,s!==null&&gl(i,s),Te!==null&&Te.f&lt&&!(a&Xs))){var o=Te;(o.effects??(o.effects=[])).push(i)}return n}function Qn(){return Te!==null&&!Vt}function Xn(a){const e=ps(an,null,!1);return Xe(e,ht),e.teardown=a,e}function ut(a){pl();var e=Ce.f,t=!Te&&(e&fs)!==0&&(e&Hn)===0;if(t){var s=St;(s.e??(s.e=[])).push(a)}else return bi(a)}function bi(a){return ps(Wa|wo,a,!1)}function ml(a){ls.ensure();const e=ps(Xs|ya,a,!0);return(t={})=>new Promise(s=>{t.outro?Hs(e,()=>{Tt(e),s(void 0)}):(Tt(e),s(void 0))})}function wi(a){return ps(Wa,a,!1)}function yl(a){return ps(Gn|ya,a,!0)}function ln(a,e=0){return ps(an|e,a,!0)}function H(a,e=[],t=[],s=[]){il(s,e,t,n=>{ps(an,()=>a(...n.map(r)),!0)})}function $n(a,e=0){var t=ps(hs|e,a,!0);return t}function Ft(a){return ps(fs|ya,a,!0)}function Ti(a){var e=a.teardown;if(e!==null){const t=As,s=Te;vr(!0),wt(null);try{e.call(null)}finally{vr(t),wt(s)}}}function Si(a,e=!1){var t=a.first;for(a.first=a.last=null;t!==null;){const n=t.ac;n!==null&&on(()=>{n.abort(ra)});var s=t.next;t.f&Xs?t.parent=null:Tt(t,e),t=s}}function kl(a){for(var e=a.first;e!==null;){var t=e.next;e.f&fs||Tt(e),e=t}}function Tt(a,e=!0){var t=!1;(e||a.f&$r)&&a.nodes!==null&&a.nodes.end!==null&&(Di(a.nodes.start,a.nodes.end),t=!0),Si(a,e&&!t),$a(a,0),Xe(a,cs);var s=a.nodes&&a.nodes.t;if(s!==null)for(const i of s)i.stop();Ti(a);var n=a.parent;n!==null&&n.first!==null&&Ei(a),a.next=a.prev=a.teardown=a.ctx=a.deps=a.fn=a.nodes=a.ac=null}function Di(a,e){for(;a!==null;){var t=a===e?null:Fa(a);a.remove(),a=t}}function Ei(a){var e=a.parent,t=a.prev,s=a.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===a&&(e.first=s),e.last===a&&(e.last=t))}function Hs(a,e,t=!0){var s=[];Ai(a,s,!0);var n=()=>{t&&Tt(a),e&&e()},i=s.length;if(i>0){var o=()=>--i||n();for(var c of s)c.out(o)}else n()}function Ai(a,e,t){if(!(a.f&It)){a.f^=It;var s=a.nodes&&a.nodes.t;if(s!==null)for(const c of s)(c.is_global||t)&&e.push(c);for(var n=a.first;n!==null;){var i=n.next,o=(n.f&_a)!==0||(n.f&fs)!==0&&(a.f&hs)!==0;Ai(n,e,o?t:!1),n=i}}}function Jn(a){xi(a,!0)}function xi(a,e){if(a.f&It){a.f^=It,a.f&ht||(Xe(a,kt),us(a));for(var t=a.first;t!==null;){var s=t.next,n=(t.f&_a)!==0||(t.f&fs)!==0;xi(t,n?e:!1),t=s}var i=a.nodes&&a.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Ci(a,e){if(a.nodes)for(var t=a.nodes.start,s=a.nodes.end;t!==null;){var n=t===s?null:Fa(t);e.append(t),t=n}}let Gs=!1;function Xa(a){Gs=a}let As=!1;function vr(a){As=a}let Te=null,Vt=!1;function wt(a){Te=a}let Ce=null;function ss(a){Ce=a}let yt=null;function Ii(a){Te!==null&&(yt===null?yt=[a]:yt.push(a))}let mt=null,xt=0,Mt=null;function bl(a){Mt=a}let qi=1,Ia=0,Ys=Ia;function hr(a){Ys=a}function Oi(){return++qi}function Pa(a){var e=a.f;if(e&kt)return!0;if(e&lt&&(a.f&=~Ws),e&_s){for(var t=a.deps,s=t.length,n=0;n<s;n++){var i=t[n];if(Pa(i)&&fi(i),i.wv>a.wv)return!0}e&Pt&&it===null&&Xe(a,ht)}return!1}function Mi(a,e,t=!0){var s=a.reactions;if(s!==null&&!(yt!=null&&yt.includes(a)))for(var n=0;n<s.length;n++){var i=s[n];i.f&lt?Mi(i,e,!1):e===i&&(t?Xe(i,kt):i.f&ht&&Xe(i,_s),us(i))}}function Ni(a){var q;var e=mt,t=xt,s=Mt,n=Te,i=yt,o=St,c=Vt,l=Ys,u=a.f;mt=null,xt=0,Mt=null,Te=u&(fs|Xs)?null:a,yt=null,pa(a.ctx),Vt=!1,Ys=++Ia,a.ac!==null&&(on(()=>{a.ac.abort(ra)}),a.ac=null);try{a.f|=Tn;var h=a.fn,m=h(),y=a.deps;if(mt!==null){var _;if($a(a,xt),y!==null&&xt>0)for(y.length=xt+mt.length,_=0;_<mt.length;_++)y[xt+_]=mt[_];else a.deps=y=mt;if(Qn()&&a.f&Pt)for(_=xt;_<y.length;_++)((q=y[_]).reactions??(q.reactions=[])).push(a)}else y!==null&&xt<y.length&&($a(a,xt),y.length=xt);if(si()&&Mt!==null&&!Vt&&y!==null&&!(a.f&(lt|_s|kt)))for(_=0;_<Mt.length;_++)Mi(Mt[_],a);return n!==null&&n!==a&&(Ia++,Mt!==null&&(s===null?s=Mt:s.push(...Mt))),a.f&Ds&&(a.f^=Ds),m}catch(g){return ni(g)}finally{a.f^=Tn,mt=e,xt=t,Mt=s,Te=n,yt=i,pa(o),Vt=c,Ys=l}}function wl(a,e){let t=e.reactions;if(t!==null){var s=po.call(t,a);if(s!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[s]=t[n],t.pop())}}if(t===null&&e.f&lt&&(mt===null||!mt.includes(e))){var i=e;i.f&Pt&&(i.f^=Pt,i.f&=~Ws),Yn(i),hi(i),$a(i,0)}}function $a(a,e){var t=a.deps;if(t!==null)for(var s=e;s<t.length;s++)wl(a,t[s])}function qa(a){var e=a.f;if(!(e&cs)){Xe(a,ht);var t=Ce,s=Gs;Ce=a,Gs=!0;try{e&(hs|Xr)?kl(a):Si(a),Ti(a);var n=Ni(a);a.teardown=typeof n=="function"?n:null,a.wv=qi;var i;wn&&Qo&&a.f&kt&&a.deps}finally{Gs=s,Ce=t}}}async function Ri(){await Promise.resolve(),Jo()}function r(a){var e=a.f,t=(e&lt)!==0;if(Te!==null&&!Vt){var s=Ce!==null&&(Ce.f&cs)!==0;if(!s&&!(yt!=null&&yt.includes(a))){var n=Te.deps;if(Te.f&Tn)a.rv<Ia&&(a.rv=Ia,mt===null&&n!==null&&n[xt]===a?xt++:mt===null?mt=[a]:mt.includes(a)||mt.push(a));else{(Te.deps??(Te.deps=[])).push(a);var i=a.reactions;i===null?a.reactions=[Te]:i.includes(Te)||i.push(Te)}}}if(As&&Es.has(a))return Es.get(a);if(t){var o=a;if(As){var c=o.v;return(!(o.f&ht)&&o.reactions!==null||Fi(o))&&(c=Vn(o)),Es.set(o,c),c}var l=(o.f&Pt)===0&&!Vt&&Te!==null&&(Gs||(Te.f&Pt)!==0),u=o.deps===null;Pa(o)&&(l&&(o.f|=Pt),fi(o)),l&&!u&&Bi(o)}if(it!=null&&it.has(a))return it.get(a);if(a.f&Ds)throw a.v;return a.v}function Bi(a){if(a.deps!==null){a.f|=Pt;for(const e of a.deps)(e.reactions??(e.reactions=[])).push(a),e.f&lt&&!(e.f&Pt)&&Bi(e)}}function Fi(a){if(a.v===rt)return!0;if(a.deps===null)return!1;for(const e of a.deps)if(Es.has(e)||e.f&lt&&Fi(e))return!0;return!1}function $s(a){var e=Vt;try{return Vt=!0,a()}finally{Vt=e}}const Tl=["touchstart","touchmove"];function Sl(a){return Tl.includes(a)}const Pi=new Set,In=new Set;function Dl(a,e,t,s={}){function n(i){if(s.capture||Sa.call(e,i),!i.cancelBubble)return on(()=>t==null?void 0:t.call(this,i))}return a.startsWith("pointer")||a.startsWith("touch")||a==="wheel"?ka(()=>{e.addEventListener(a,n,s)}):e.addEventListener(a,n,s),n}function ot(a,e,t,s,n){var i={capture:s,passive:n},o=Dl(a,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Xn(()=>{e.removeEventListener(a,o,i)})}function $e(a){for(var e=0;e<a.length;e++)Pi.add(a[e]);for(var t of In)t(a)}let fr=null;function Sa(a){var p;var e=this,t=e.ownerDocument,s=a.type,n=((p=a.composedPath)==null?void 0:p.call(a))||[],i=n[0]||a.target;fr=a;var o=0,c=fr===a&&a.__root;if(c){var l=n.indexOf(c);if(l!==-1&&(e===document||e===window)){a.__root=e;return}var u=n.indexOf(e);if(u===-1)return;l<=u&&(o=l)}if(i=n[o]||a.target,i!==e){go(a,"currentTarget",{configurable:!0,get(){return i||t}});var h=Te,m=Ce;wt(null),ss(null);try{for(var y,_=[];i!==null;){var q=i.assignedSlot||i.parentNode||i.host||null;try{var g=i["__"+s];g!=null&&(!i.disabled||a.target===i)&&g.call(i,a)}catch(w){y?_.push(w):y=w}if(a.cancelBubble||q===e||q===null)break;i=q}if(y){for(let w of _)queueMicrotask(()=>{throw w});throw y}}finally{a.__root=e,delete a.currentTarget,wt(h),ss(m)}}}function zi(a){var e=document.createElement("template");return e.innerHTML=a.replaceAll("<!>","<!---->"),e.content}function Oa(a,e){var t=Ce;t.nodes===null&&(t.nodes={start:a,end:e,a:null,t:null})}function A(a,e){var t=(e&Uo)!==0,s=(e&Ho)!==0,n,i=!a.startsWith("<!>");return()=>{n===void 0&&(n=zi(i?a:"<!>"+a),t||(n=Ss(n)));var o=s||gi?document.importNode(n,!0):n.cloneNode(!0);if(t){var c=Ss(o),l=o.lastChild;Oa(c,l)}else Oa(o,o);return o}}function oa(a=""){{var e=ds(a+"");return Oa(e,e),e}}function Pe(){var a=document.createDocumentFragment(),e=document.createComment(""),t=ds();return a.append(e,t),Oa(e,t),a}function k(a,e){a!==null&&a.before(e)}function L(a,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(a.__t??(a.__t=a.nodeValue))&&(a.__t=t,a.nodeValue=t+"")}function hn(a,e){return El(a,e)}const sa=new Map;function El(a,{target:e,anchor:t,props:s={},events:n,context:i,intro:o=!0}){hl();var c=new Set,l=m=>{for(var y=0;y<m.length;y++){var _=m[y];if(!c.has(_)){c.add(_);var q=Sl(_);e.addEventListener(_,Sa,{passive:q});var g=sa.get(_);g===void 0?(document.addEventListener(_,Sa,{passive:q}),sa.set(_,1)):sa.set(_,g+1)}}};l(sn(Pi)),In.add(l);var u=void 0,h=ml(()=>{var m=t??e.appendChild(ds());return sl(m,{pending:()=>{}},y=>{if(i){Ue({});var _=St;_.c=i}n&&(s.$$events=n),u=a(y,s)||{},i&&He()}),()=>{var q;for(var y of c){e.removeEventListener(y,Sa);var _=sa.get(y);--_===0?(document.removeEventListener(y,Sa),sa.delete(y)):sa.set(y,_)}In.delete(l),m!==t&&((q=m.parentNode)==null||q.removeChild(m))}});return qn.set(u,h),u}let qn=new WeakMap;function fn(a,e){const t=qn.get(a);return t?(qn.delete(a),t(e)):Promise.resolve()}var Yt,ts,Ct,Ks,Ra,Ba,tn;class Al{constructor(e,t=!0){D(this,"anchor");Ee(this,Yt,new Map);Ee(this,ts,new Map);Ee(this,Ct,new Map);Ee(this,Ks,new Set);Ee(this,Ra,!0);Ee(this,Ba,()=>{var e=we;if(I(this,Yt).has(e)){var t=I(this,Yt).get(e),s=I(this,ts).get(t);if(s)Jn(s),I(this,Ks).delete(t);else{var n=I(this,Ct).get(t);n&&(I(this,ts).set(t,n.effect),I(this,Ct).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[i,o]of I(this,Yt)){if(I(this,Yt).delete(i),i===e)break;const c=I(this,Ct).get(o);c&&(Tt(c.effect),I(this,Ct).delete(o))}for(const[i,o]of I(this,ts)){if(i===t||I(this,Ks).has(i))continue;const c=()=>{if(Array.from(I(this,Yt).values()).includes(i)){var u=document.createDocumentFragment();Ci(o,u),u.append(ds()),I(this,Ct).set(i,{effect:o,fragment:u})}else Tt(o);I(this,Ks).delete(i),I(this,ts).delete(i)};I(this,Ra)||!s?(I(this,Ks).add(i),Hs(o,c,!1)):c()}}});Ee(this,tn,e=>{I(this,Yt).delete(e);const t=Array.from(I(this,Yt).values());for(const[s,n]of I(this,Ct))t.includes(s)||(Tt(n.effect),I(this,Ct).delete(s))});this.anchor=e,Se(this,Ra,t)}ensure(e,t){var s=we,n=ki();if(t&&!I(this,ts).has(e)&&!I(this,Ct).has(e))if(n){var i=document.createDocumentFragment(),o=ds();i.append(o),I(this,Ct).set(e,{effect:Ft(()=>t(o)),fragment:i})}else I(this,ts).set(e,Ft(()=>t(this.anchor)));if(I(this,Yt).set(s,e),n){for(const[c,l]of I(this,ts))c===e?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[c,l]of I(this,Ct))c===e?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(I(this,Ba)),s.ondiscard(I(this,tn))}else I(this,Ba).call(this)}}Yt=new WeakMap,ts=new WeakMap,Ct=new WeakMap,Ks=new WeakMap,Ra=new WeakMap,Ba=new WeakMap,tn=new WeakMap;function G(a,e,t=!1){var s=new Al(a),n=t?_a:0;function i(o,c){s.ensure(o,c)}$n(()=>{var o=!1;e((c,l=!0)=>{o=!0,i(l,c)}),o||i(!1,null)},n)}function vt(a,e){return e}function xl(a,e,t){for(var s=[],n=e.length,i,o=e.length,c=0;c<n;c++){let m=e[c];Hs(m,()=>{if(i){if(i.pending.delete(m),i.done.add(m),i.pending.size===0){var y=a.outrogroups;On(sn(i.done)),y.delete(i),y.size===0&&(a.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=s.length===0&&t!==null;if(l){var u=t,h=u.parentNode;fl(h),h.append(u),a.items.clear()}On(e,!l)}else i={pending:new Set(e),done:new Set},(a.outrogroups??(a.outrogroups=new Set)).add(i)}function On(a,e=!0){for(var t=0;t<a.length;t++)Tt(a[t],e)}var _r;function Me(a,e,t,s,n,i=null){var o=a,c=new Map,l=(e&Zr)!==0;if(l){var u=a;o=u.appendChild(ds())}var h=null,m=vi(()=>{var w=t();return Kn(w)?w:w==null?[]:sn(w)}),y,_=!0;function q(){p.fallback=h,Cl(p,y,o,e,s),h!==null&&(y.length===0?h.f&os?(h.f^=os,Da(h,null,o)):Jn(h):Hs(h,()=>{h=null}))}var g=$n(()=>{y=r(m);for(var w=y.length,x=new Set,T=we,C=ki(),P=0;P<w;P+=1){var K=y[P],M=s(K,P),N=_?null:c.get(M);N?(N.v&&ma(N.v,K),N.i&&ma(N.i,P),C&&T.skipped_effects.delete(N.e)):(N=Il(c,_?o:_r??(_r=ds()),K,M,P,n,e,t),_||(N.e.f|=os),c.set(M,N)),x.add(M)}if(w===0&&i&&!h&&(_?h=Ft(()=>i(o)):(h=Ft(()=>i(_r??(_r=ds()))),h.f|=os)),!_)if(C){for(const[z,Y]of c)x.has(z)||T.skipped_effects.add(Y.e);T.oncommit(q),T.ondiscard(()=>{})}else q();r(m)}),p={effect:g,items:c,outrogroups:null,fallback:h};_=!1}function Cl(a,e,t,s,n){var Y,J,te,ie,he,le,j,E,B;var i=(s&Fo)!==0,o=e.length,c=a.items,l=a.effect.first,u,h=null,m,y=[],_=[],q,g,p,w;if(i)for(w=0;w<o;w+=1)q=e[w],g=n(q,w),p=c.get(g).e,p.f&os||((J=(Y=p.nodes)==null?void 0:Y.a)==null||J.measure(),(m??(m=new Set)).add(p));for(w=0;w<o;w+=1){if(q=e[w],g=n(q,w),p=c.get(g).e,a.outrogroups!==null)for(const Z of a.outrogroups)Z.pending.delete(p),Z.done.delete(p);if(p.f&os)if(p.f^=os,p===l)Da(p,null,t);else{var x=h?h.next:l;p===a.effect.last&&(a.effect.last=p.prev),p.prev&&(p.prev.next=p.next),p.next&&(p.next.prev=p.prev),ms(a,h,p),ms(a,p,x),Da(p,x,t),h=p,y=[],_=[],l=h.next;continue}if(p.f&It&&(Jn(p),i&&((ie=(te=p.nodes)==null?void 0:te.a)==null||ie.unfix(),(m??(m=new Set)).delete(p))),p!==l){if(u!==void 0&&u.has(p)){if(y.length<_.length){var T=_[0],C;h=T.prev;var P=y[0],K=y[y.length-1];for(C=0;C<y.length;C+=1)Da(y[C],T,t);for(C=0;C<_.length;C+=1)u.delete(_[C]);ms(a,P.prev,K.next),ms(a,h,P),ms(a,K,T),l=T,h=K,w-=1,y=[],_=[]}else u.delete(p),Da(p,l,t),ms(a,p.prev,p.next),ms(a,p,h===null?a.effect.first:h.next),ms(a,h,p),h=p;continue}for(y=[],_=[];l!==null&&l!==p;)(u??(u=new Set)).add(l),_.push(l),l=l.next;if(l===null)continue}p.f&os||y.push(p),h=p,l=p.next}if(a.outrogroups!==null){for(const Z of a.outrogroups)Z.pending.size===0&&(On(sn(Z.done)),(he=a.outrogroups)==null||he.delete(Z));a.outrogroups.size===0&&(a.outrogroups=null)}if(l!==null||u!==void 0){var M=[];if(u!==void 0)for(p of u)p.f&It||M.push(p);for(;l!==null;)!(l.f&It)&&l!==a.fallback&&M.push(l),l=l.next;var N=M.length;if(N>0){var z=s&Zr&&o===0?t:null;if(i){for(w=0;w<N;w+=1)(j=(le=M[w].nodes)==null?void 0:le.a)==null||j.measure();for(w=0;w<N;w+=1)(B=(E=M[w].nodes)==null?void 0:E.a)==null||B.fix()}xl(a,M,z)}}i&&ka(()=>{var Z,ee;if(m!==void 0)for(p of m)(ee=(Z=p.nodes)==null?void 0:Z.a)==null||ee.apply()})}function Il(a,e,t,s,n,i,o,c){var l=o&Ro?o&Po?Qs(t):dl(t,!1,!1):null,u=o&Bo?Qs(n):null;return{v:l,i:u,e:Ft(()=>(i(e,l??t,u??n,c),()=>{a.delete(s)}))}}function Da(a,e,t){if(a.nodes)for(var s=a.nodes.start,n=a.nodes.end,i=e&&!(e.f&os)?e.nodes.start:t;s!==null;){var o=Fa(s);if(i.before(s),s===n)return;s=o}}function ms(a,e,t){e===null?a.effect.first=t:e.next=t,t===null?a.effect.last=e:t.prev=e}function ql(a,e,t=!1,s=!1,n=!1){var i=a,o="";H(()=>{var c=Ce;if(o!==(o=e()??"")&&(c.nodes!==null&&(Di(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var u=zi(l);if((t||s)&&(u=Ss(u)),Oa(Ss(u),u.lastChild),t||s)for(;Ss(u);)i.before(Ss(u));else i.before(u)}})}function Li(a){var e,t,s="";if(typeof a=="string"||typeof a=="number")s+=a;else if(typeof a=="object")if(Array.isArray(a)){var n=a.length;for(e=0;e<n;e++)a[e]&&(t=Li(a[e]))&&(s&&(s+=" "),s+=t)}else for(t in a)a[t]&&(s&&(s+=" "),s+=t);return s}function Ol(){for(var a,e,t=0,s="",n=arguments.length;t<n;t++)(a=arguments[t])&&(e=Li(a))&&(s&&(s+=" "),s+=e);return s}function Ml(a){return typeof a=="object"?Ol(a):a??""}const pr=[...` 	
\r\f¬†\v\uFEFF`];function Nl(a,e,t){var s=a==null?"":""+a;if(e&&(s=s?s+" "+e:e),t){for(var n in t)if(t[n])s=s?s+" "+n:n;else if(s.length)for(var i=n.length,o=0;(o=s.indexOf(n,o))>=0;){var c=o+i;(o===0||pr.includes(s[o-1]))&&(c===s.length||pr.includes(s[c]))?s=(o===0?"":s.substring(0,o))+s.substring(c+1):o=c}}return s===""?null:s}function Rl(a,e){return a==null?null:String(a)}function Re(a,e,t,s,n,i){var o=a.__className;if(o!==t||o===void 0){var c=Nl(t,s,i);c==null?a.removeAttribute("class"):a.className=c,a.__className=t}else if(i&&n!==i)for(var l in i){var u=!!i[l];(n==null||u!==!!n[l])&&a.classList.toggle(l,u)}return i}function Vs(a,e,t,s){var n=a.__style;if(n!==e){var i=Rl(e);i==null?a.removeAttribute("style"):a.style.cssText=i,a.__style=e}return s}function ji(a,e,t=!1){if(a.multiple){if(e==null)return;if(!Kn(e))return Yo();for(var s of a.options)s.selected=e.includes(Ca(s));return}for(s of a.options){var n=Ca(s);if(vl(n,e)){s.selected=!0;return}}(!t||e!==void 0)&&(a.selectedIndex=-1)}function Bl(a){var e=new MutationObserver(()=>{ji(a,a.__value)});e.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Xn(()=>{e.disconnect()})}function Mn(a,e,t=e){var s=new WeakSet,n=!0;Wn(a,"change",i=>{var o=i?"[selected]":":checked",c;if(a.multiple)c=[].map.call(a.querySelectorAll(o),Ca);else{var l=a.querySelector(o)??a.querySelector("option:not([disabled])");c=l&&Ca(l)}t(c),we!==null&&s.add(we)}),wi(()=>{var i=e();if(a===document.activeElement){var o=Ea??we;if(s.has(o))return}if(ji(a,i,n),n&&i===void 0){var c=a.querySelector(":checked");c!==null&&(i=Ca(c),t(i))}a.__value=i,n=!1}),Bl(a)}function Ca(a){return"__value"in a?a.__value:a.value}const Fl=Symbol("is custom element"),Pl=Symbol("is html");function Ki(a,e){var t=Zn(a);t.value===(t.value=e??void 0)||a.value===e&&(e!==0||a.nodeName!=="PROGRESS")||(a.value=e??"")}function la(a,e){var t=Zn(a);t.checked!==(t.checked=e??void 0)&&(a.checked=e)}function De(a,e,t,s){var n=Zn(a);n[e]!==(n[e]=t)&&(e==="loading"&&(a[So]=t),t==null?a.removeAttribute(e):typeof t!="string"&&zl(a).includes(e)?a[e]=t:a.setAttribute(e,t))}function Zn(a){return a.__attributes??(a.__attributes={[Fl]:a.nodeName.includes("-"),[Pl]:a.namespaceURI===Go})}var gr=new Map;function zl(a){var e=a.getAttribute("is")||a.nodeName,t=gr.get(e);if(t)return t;gr.set(e,t=[]);for(var s,n=a,i=Element.prototype;i!==n;){s=mo(n);for(var o in s)s[o].set&&t.push(o);n=Vr(n)}return t}function We(a,e,t=e){var s=new WeakSet;Wn(a,"input",async n=>{var i=n?a.defaultValue:a.value;if(i=_n(a)?pn(i):i,t(i),we!==null&&s.add(we),await Ri(),i!==(i=e())){var o=a.selectionStart,c=a.selectionEnd,l=a.value.length;if(a.value=i??"",c!==null){var u=a.value.length;o===c&&c===l&&u>l?(a.selectionStart=u,a.selectionEnd=u):(a.selectionStart=o,a.selectionEnd=Math.min(c,u))}}}),$s(e)==null&&a.value&&(t(_n(a)?pn(a.value):a.value),we!==null&&s.add(we)),ln(()=>{var n=e();if(a===document.activeElement){var i=Ea??we;if(s.has(i))return}_n(a)&&n===pn(a.value)||a.type==="date"&&!n&&!a.value||n!==a.value&&(a.value=n??"")})}function Ui(a,e,t=e){Wn(a,"change",s=>{var n=s?a.defaultChecked:a.checked;t(n)}),$s(e)==null&&t(a.checked),ln(()=>{var s=e();a.checked=!!s})}function _n(a){var e=a.type;return e==="number"||e==="range"}function pn(a){return a===""?null:+a}function mr(a,e){return a===e||(a==null?void 0:a[Us])===e}function Wt(a={},e,t,s){return wi(()=>{var n,i;return ln(()=>{n=i,i=(s==null?void 0:s())||[],$s(()=>{a!==t(...i)&&(e(a,...i),n&&mr(t(...n),a)&&e(null,...n))})}),()=>{ka(()=>{i&&mr(t(...i),a)&&e(null,...i)})}}),a}let Ka=!1;function Ll(a){var e=Ka;try{return Ka=!1,[a(),Ka]}finally{Ka=e}}function vs(a,e,t,s){var x;var n=(t&jo)!==0,i=(t&Ko)!==0,o=s,c=!0,l=()=>(c&&(c=!1,o=i?$s(s):s),o),u;if(n){var h=Us in a||To in a;u=((x=ia(a,e))==null?void 0:x.set)??(h&&e in a?T=>a[e]=T:void 0)}var m,y=!1;n?[m,y]=Ll(()=>a[e]):m=a[e],m===void 0&&s!==void 0&&(m=l(),u&&(Io(),u(m)));var _;if(_=()=>{var T=a[e];return T===void 0?l():(c=!0,T)},!(t&Lo))return _;if(u){var q=a.$$legacy;return function(T,C){return arguments.length>0?((!C||q||y)&&u(C?_():T),T):_()}}var g=!1,p=(t&zo?rn:vi)(()=>(g=!1,_()));n&&r(p);var w=Ce;return function(T,C){if(arguments.length>0){const P=C?r(p):n?ye(T):T;return f(p,P),g=!0,o!==void 0&&(o=P),T}return As&&g||w.f&cs?p.v:r(p)}}function cn(a){St===null&&Jr(),ut(()=>{const e=$s(a);if(typeof e=="function")return e})}function jl(a){St===null&&Jr(),cn(()=>()=>$s(a))}const Kl="5";var Yr;typeof window<"u"&&((Yr=window.__svelte??(window.__svelte={})).v??(Yr.v=new Set)).add(Kl);function Ul(){return{type:"daily",interval:1,time:"09:00"}}function Hi(a){return!a||!a.type||!a.interval||a.interval<1?!1:a.type==="weekly"?Array.isArray(a.weekdays)&&a.weekdays.length>0&&a.weekdays.every(e=>e>=0&&e<=6):a.type==="monthly"?a.dayOfMonth>=1&&a.dayOfMonth<=31:a.type==="yearly"?a.month>=0&&a.month<=11&&a.dayOfMonth>=1&&a.dayOfMonth<=31:!0}const Rs="recurring-tasks-active",Ga="recurring-tasks-archive",yr="recurring-tasks",kr="recurring-tasks.json.bak",br="n8n-event-settings",wr="n8n-event-queue",Hl="notification-state",Gl="recurring-tasks-dock",Tr="scheduler-emitted-occurrences",ys=4,Nn={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},er=60*1e3,Yl=30*1e3,gn=2e3,Sr="shehab-note-recurring-plugin",Dr="1.0.0",Vl=60*60*1e3,Wl=3,Er=10,mn=1e3,Ya=100,Ar=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],xr={low:"#64748b",normal:"#3b82f6",high:"#f59e0b",urgent:"#ef4444"},Ql=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Cr="last-run-timestamp",Ir="custom-recurring-task-id",qr="custom-recurring-task-due",Or="custom-recurring-task-enabled";function Gi(a,e,t){const s=new Date().toISOString(),n=t||new Date;return{id:Yi(),name:a,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:ys,createdAt:s,updatedAt:s}}function Yi(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Vi(a,e={}){const t=new Date().toISOString();return{...{...a,id:Yi(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Xl(a){const e=new Date().toISOString();a.completionCount=(a.completionCount||0)+1,a.currentStreak=(a.currentStreak||0)+1,a.bestStreak=Math.max(a.bestStreak||0,a.currentStreak),a.recentCompletions||(a.recentCompletions=[]),a.recentCompletions.push(e),a.recentCompletions.length>Er&&(a.recentCompletions=a.recentCompletions.slice(-Er)),a.snoozeCount=0,a.lastCompletedAt=e,a.updatedAt=e}function Wi(a){a.missCount=(a.missCount||0)+1,a.currentStreak=0,a.updatedAt=new Date().toISOString()}function Qi(a){const e=a.completionCount||0,t=a.missCount||0,s=e+t;if(s===0)return 100;let i=e/s*70;const o=a.currentStreak||0,c=Math.min(30,o*3);return i+=c,Math.round(Math.min(100,i))}function Bs(a){const{message:e,type:t="info",duration:s=3e3,actionLabel:n,onAction:i,showCountdown:o=!1}=a,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let u=null;if(n&&i){const m=document.createElement("button");m.type="button";let y=Math.max(1,Math.ceil(s/1e3));m.textContent=o?`${n} (${y}s)`:n,m.className="recurring-tasks-toast__action",m.addEventListener("click",()=>{i(),u!==null&&window.clearInterval(u),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(m),o&&s>0&&(u=window.setInterval(()=>{y=Math.max(0,y-1),m.textContent=`${n} (${y}s)`,y<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:$l(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const h=()=>{u!==null&&window.clearInterval(u),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};s>0&&setTimeout(()=>{h()},s)}function $l(a){switch(a){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const X={success:(a,e)=>Bs({message:a,type:"success",duration:e}),error:(a,e)=>Bs({message:a,type:"error",duration:e}),warning:(a,e)=>Bs({message:a,type:"warning",duration:e}),info:(a,e)=>Bs({message:a,type:"info",duration:e})};if(typeof document<"u"){const a=document.createElement("style");a.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(a)}class Jl{constructor(){D(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(n=>n(t))}clear(){this.handlers.clear()}}const Ke=new Jl;function yn(a,e){const t=a.findIndex(n=>n.id===e.id);if(t===-1)return[...a,e];const s=[...a];return s[t]=e,s}function Mr(a,e){const t=a.filter(s=>s.id!==e);return t.length===a.length?a:t}function kn(a,e,t){let s=!1;const n=a.map(i=>i.id!==e?i:(s=!0,t(i)));return s?n:a}function Zl(a,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),a.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const ec=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function dn(a,e,t){const s={timestamp:new Date().toISOString()},n=`[${a.toUpperCase()}] [${s.timestamp}]`;a==="error"?console.error(n,e,t||""):a==="warn"?console.warn(n,e,t||""):a==="debug"&&ec?console.debug(n,e,t||""):a==="info"&&console.log(n,e,t||"")}function Xi(a,e){dn("debug",a,e)}function ue(a,e){dn("info",a,e)}function Ye(a,e){dn("warn",a,e)}function me(a,e){dn("error",a,e)}async function tc(a){return new Promise(e=>{try{jn.fetchPost("/api/block/getBlockInfo",{id:a},t=>{var n,i,o;const s=((n=t==null?void 0:t.data)==null?void 0:n.content)??((i=t==null?void 0:t.data)==null?void 0:i.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){Ye("Failed to fetch block preview",t),e(null)}})}async function sc(a){return new Promise(e=>{try{jn.fetchPost("/api/block/getBlockHTML",{id:a},t=>{var n;const s=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(s?s.trim():null)})}catch(t){Ye("Failed to fetch block embed",t),e(null)}})}function $i(a){const[e,t]=a.split(":").map(Number);return{hours:e,minutes:t}}function ac(a){const e=a.getHours().toString().padStart(2,"0"),t=a.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function nc(a){return a.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Rn(a){return a.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function tr(a){const e=new Date;return a.getDate()===e.getDate()&&a.getMonth()===e.getMonth()&&a.getFullYear()===e.getFullYear()}function rc(a){return a<new Date}function ic(a){return rc(a)&&!tr(a)}function Ma(a,e){const t=new Date(a);return t.setDate(t.getDate()+e),t}function Nr(a,e){return Ma(a,e*7)}function oc(a,e,t){const s=new Date(a);s.setHours(e,t,0,0);const n=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:n}}function Bn(a){const e=new Date(a);return e.setHours(0,0,0,0),e}function lc(a){const e=new Date(a);return e.setHours(23,59,59,999),e}function cc(a,e){const s=Math.abs(e.getTime()-a.getTime());return Math.floor(s/864e5)}function dc(a,e){const t=[];for(let s=0;s<e;s++)t.push(Ma(a,s));return t}var uc=A('<span class="task-card__streak svelte-yjw1ud"> </span>'),vc=A('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),hc=A('<span class="task-card__relative svelte-yjw1ud"> </span>'),fc=A('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),_c=A('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),pc=A('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),gc=A('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),mc=A('<button class="task-card__snooze-chip"> </button>'),yc=A('<button class="task-card__snooze-option" role="menuitem"> </button>'),kc=A('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),bc=A('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">üïí Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function ba(a,e){Ue(e,!0);const t=Q(()=>new Date(e.task.dueAt)),s=Q(()=>ic(r(t))),n=Q(()=>tr(r(t))),i=Q(()=>r(s)?cc(new Date(e.task.dueAt),new Date):0),o=Q(()=>r(s)?"task-card--overdue":r(n)?"task-card--today":""),c=Q(()=>()=>r(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+r(i)*.05)})`:""),l=Q(()=>()=>r(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+r(i)*.08)})`:""),u=Q(()=>e.task.priority?xr[e.task.priority]:xr.normal),h=Q(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(r(t)):""),m=Q(()=>(e.task.currentStreak||0)>0),y=Q(()=>()=>"üî•"),_=Q(()=>Qi(e.task)),q=Q(()=>r(_)>=80?"health--good":r(_)>=50?"health--fair":"health--poor");let g=W(!1),p=W(-1),w=[],x=W(!1),T=W(null),C=W(null),P=W(!1);const K=Q(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),M=Q(()=>()=>{if(!r(T))return"";const ae=r(T).replace(/\s+/g," ").trim();return ae.length>220?`${ae.slice(0,220)}‚Ä¶`:ae}),N=Q(()=>()=>Ar.filter(ae=>[15,60,120].includes(ae.minutes))),z=Q(()=>()=>`snooze-menu-${e.task.id}`);ut(()=>{f(T,e.task.linkedBlockContent??null,!0),f(C,null),f(P,!1)});function Y(){e.onDone(e.task)}function J(){e.onDelay(e.task)}function te(){e.onEdit&&e.onEdit(e.task)}function ie(){e.onSkip(e.task)}async function he(){f(g,!r(g)),r(g)&&(await Ri(),f(p,-1),w=[])}function le(ae){const pe=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ae}});window.dispatchEvent(pe),f(g,!1),f(p,-1)}function j(ae){var Ae,Le,dt,tt;const pe=r(N);ae.key==="ArrowDown"?(ae.preventDefault(),f(p,Math.min(r(p)+1,pe.length-1),!0),(Ae=w[r(p)])==null||Ae.focus()):ae.key==="ArrowUp"?(ae.preventDefault(),f(p,Math.max(r(p)-1,0),!0),(Le=w[r(p)])==null||Le.focus()):ae.key==="Escape"?(f(g,!1),f(p,-1)):ae.key==="Home"?(ae.preventDefault(),f(p,0),(dt=w[0])==null||dt.focus()):ae.key==="End"&&(ae.preventDefault(),f(p,pe.length-1),(tt=w[r(p)])==null||tt.focus())}function E(ae){if(ae.key==="Escape"&&r(g)){f(g,!1);return}(ae.key==="Enter"||ae.key===" ")&&(ae.preventDefault(),he())}async function B(){if(f(x,!0),!e.task.linkedBlockId||r(P)||r(C))return;f(P,!0);const[ae,pe]=await Promise.all([sc(e.task.linkedBlockId),tc(e.task.linkedBlockId)]);f(C,ae,!0),f(T,pe,!0),f(P,!1)}function Z(){f(x,!1)}const ee=Q(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,pe=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[pe]||pe)}`);var ce=bc();ce.__keydown=ae=>{ae.key==="Escape"&&r(g)&&f(g,!1)};var de=d(ce),_e=d(de),se=d(_e),ve=v(se,2),U=d(ve),V=v(ve,2);{var re=ae=>{var pe=uc(),Ae=d(pe);H(Le=>{De(pe,"title",`${e.task.currentStreak??""} day streak`),L(Ae,`${Le??""} ${e.task.currentStreak??""}`)},[()=>r(y)()]),k(ae,pe)};G(V,ae=>{r(m)&&ae(re)})}var b=v(_e,2);{var R=ae=>{var pe=vc();pe.__click=te,k(ae,pe)};G(b,ae=>{e.onEdit&&ae(R)})}var $=v(de,2),ne=d($),S=v(d(ne),2),O=d(S),oe=v(S,2);{var be=ae=>{var pe=hc(),Ae=d(pe);H(Le=>L(Ae,Le),[()=>r(h)()]),k(ae,pe)};G(oe,ae=>{e.timezoneHandler&&ae(be)})}var xe=v(ne,2);{var ke=ae=>{var pe=fc(),Ae=v(d(pe),2),Le=d(Ae);H(dt=>L(Le,dt),[()=>Rn(new Date(e.task.lastCompletedAt))]),k(ae,pe)};G(xe,ae=>{e.task.lastCompletedAt&&ae(ke)})}var Ne=v(xe,2);{var Be=ae=>{var pe=gc(),Ae=d(pe),Le=d(Ae),dt=v(Ae,2);{var tt=Kt=>{var Et=pc(),ge=d(Et);{var Ie=Fe=>{var st=oa("Loading preview‚Ä¶");k(Fe,st)},je=Fe=>{var st=Pe(),at=qe(st);{var _t=pt=>{var Ot=_c(),gt=d(Ot);ql(gt,()=>r(C)),k(pt,Ot)},Ut=pt=>{var Ot=Pe(),gt=qe(Ot);{var Ht=At=>{var F=oa();H(()=>L(F,r(M))),k(At,F)},gs=At=>{var F=oa("No preview available.");k(At,F)};G(gt,At=>{r(T)?At(Ht):At(gs,!1)},!0)}k(pt,Ot)};G(at,pt=>{r(C)?pt(_t):pt(Ut,!1)},!0)}k(Fe,st)};G(ge,Fe=>{r(P)?Fe(Ie):Fe(je,!1)})}k(Kt,Et)};G(dt,Kt=>{r(x)&&Kt(tt)})}H(()=>{De(Ae,"title",`Linked block: ${e.task.linkedBlockId}`),L(Le,`üìù Block ${r(K)??""}`)}),ot("mouseenter",Ae,B),ot("mouseleave",Ae,Z),ot("focus",Ae,B),ot("blur",Ae,Z),k(ae,pe)};G(Ne,ae=>{e.task.linkedBlockId&&ae(Be)})}var ft=v($,2),qt=d(ft),Je=v(ft,2),Qt=d(Je),Ze=d(Qt);Ze.__click=he,Ze.__keydown=E;var Oe=v(Ze,2),Dt=d(Oe);Me(Dt,17,()=>r(N),vt,(ae,pe)=>{var Ae=mc();Ae.__click=()=>le(r(pe).minutes);var Le=d(Ae);H(()=>{De(Ae,"aria-label",`Snooze for ${r(pe).label}`),L(Le,r(pe).label)}),k(ae,Ae)});var ze=v(Dt,2);ze.__click=J;var et=v(Oe,2);{var ns=ae=>{var pe=kc();pe.__keydown=j,Me(pe,21,()=>Ar,vt,(Ae,Le,dt)=>{var tt=yc();tt.__click=()=>le(r(Le).minutes),De(tt,"tabindex",dt===0?0:-1);var Kt=d(tt);Wt(tt,(Et,ge)=>w[ge]=Et,Et=>w==null?void 0:w[Et],()=>[dt]),H(()=>L(Kt,r(Le).label)),k(Ae,tt)}),H(()=>De(pe,"id",r(z))),k(ae,pe)};G(et,ae=>{r(g)&&ae(ns)})}var Xt=v(Qt,2);Xt.__click=J;var Lt=v(Xt,2);Lt.__click=ie;var jt=v(Lt,2);jt.__click=Y,H((ae,pe)=>{Re(ce,1,`task-card ${r(o)??""}`,"svelte-yjw1ud"),Vs(ce,`--overdue-tint: ${r(c)??""}; --overdue-border: ${r(l)??""};`),De(ce,"aria-label",ae),Vs(se,`background-color: ${r(u)??""}`),De(se,"title",`Priority:  ${(e.task.priority||"normal")??""}`),L(U,e.task.name),L(O,pe),Re(ft,1,`task-card__health ${r(q)??""}`,"svelte-yjw1ud"),De(ft,"title",`Task health:  ${r(_)??""}%`),Vs(qt,`width: ${r(_)??""}%`),De(Ze,"aria-expanded",r(g)),De(Ze,"aria-controls",r(z))},[()=>r(ee)(),()=>Rn(r(t))]),k(a,ce),He()}$e(["keydown","click"]);var wc=A(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),Tc=A('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),Sc=A('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function Dc(a,e){Ue(e,!0);const t=Q(()=>[...e.tasks].sort((g,p)=>new Date(g.dueAt).getTime()-new Date(p.dueAt).getTime()));let s=W(0),n=ye([]);ut(()=>{r(s)>=r(t).length&&f(s,Math.max(0,r(t).length-1),!0)});function i(g){var w;if(r(t).length===0)return;const p=Math.max(0,Math.min(g,r(t).length-1));f(s,p,!0),(w=n[p])==null||w.focus()}function o(g,p){g.key==="ArrowDown"?(g.preventDefault(),i(p+1)):g.key==="ArrowUp"?(g.preventDefault(),i(p-1)):g.key==="Home"?(g.preventDefault(),i(0)):g.key==="End"&&(g.preventDefault(),i(r(t).length-1))}var c=Sc(),l=d(c),u=v(d(l),2),h=d(u),m=v(l,2),y=d(m);{var _=g=>{var p=wc();k(g,p)},q=g=>{var p=Pe(),w=qe(p);Me(w,19,()=>r(t),x=>x.id,(x,T,C)=>{var P=Tc();P.__keydown=M=>o(M,r(C));var K=d(P);ba(K,{get task(){return r(T)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),Wt(P,(M,N)=>n[N]=M,M=>n==null?void 0:n[M],()=>[r(C)]),H(()=>De(P,"tabindex",r(C)===r(s)?0:-1)),ot("focus",P,()=>f(s,r(C),!0)),k(x,P)}),k(g,p)};G(y,g=>{r(t).length===0?g(_):g(q,!1)})}H(()=>L(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),k(a,c),He()}$e(["keydown"]);var Ec=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Ac=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),xc=A('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),Cc=A('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ic=A('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),qc=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Oc=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Mc=A('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Nc(a,e){Ue(e,!0);let t=W(null),s=W(!1),n=W(""),i=W(""),o=W(ye(new Set)),c=W(0),l=ye([]),u=W(null);const h=Q(()=>[...e.tasks].sort((S,O)=>new Date(S.dueAt).getTime()-new Date(O.dueAt).getTime())),m=Q(()=>()=>{const S=r(i).trim().toLowerCase();return S?r(h).filter(O=>{var be;return[O.name,O.description,O.category,O.linkedBlockContent,(be=O.tags)==null?void 0:be.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(S)}):r(h)}),y=Q(()=>r(m).map(S=>S.id)),_=Q(()=>r(o).size>0),q=Q(()=>r(m).length>0&&r(m).every(S=>r(o).has(S.id))),g=Q(()=>r(m).some(S=>r(o).has(S.id))&&!r(q));ut(()=>{const S=new Set([...r(o)].filter(O=>e.tasks.some(oe=>oe.id===O)));S.size!==r(o).size&&f(o,S,!0)}),ut(()=>{r(u)&&(r(u).indeterminate=r(g))}),ut(()=>{r(c)>=r(m).length&&f(c,Math.max(0,r(m).length-1),!0)}),ut(()=>{const S=window.setTimeout(()=>{f(i,r(n),!0)},300);return()=>{window.clearTimeout(S)}});function p(S){f(t,S,!0)}function w(){r(t)&&(e.onDelete(r(t)),f(t,null))}function x(){f(t,null)}function T(S){const O=new Set(r(o));O.has(S)?O.delete(S):O.add(S),f(o,O,!0)}function C(){const S=new Set(r(o));r(q)?r(y).forEach(O=>S.delete(O)):r(y).forEach(O=>S.add(O)),f(o,S,!0)}function P(S){var oe;if(r(m).length===0)return;const O=Math.max(0,Math.min(S,r(m).length-1));f(c,O,!0),(oe=l[O])==null||oe.focus()}function K(S,O){S.key==="ArrowDown"?(S.preventDefault(),P(O+1)):S.key==="ArrowUp"?(S.preventDefault(),P(O-1)):S.key==="Home"?(S.preventDefault(),P(0)):S.key==="End"&&(S.preventDefault(),P(r(m).length-1))}function M(){if(r(o).size===0){f(s,!1);return}e.onBulkDelete([...r(o)]),f(o,new Set,!0),f(s,!1)}function N(){f(s,!1)}function z(S){const{type:O,interval:oe}=S.frequency,be=O==="daily"?"day":O==="weekly"?"week":O==="monthly"?"month":"year",xe=oe===1?`Every ${be}`:`Every ${oe} ${be}s`;if(O==="weekly")return`${xe} on ${S.frequency.weekdays.map(ke=>Ql[ke]??ke).join(", ")}`;if(O==="monthly")return`${xe} on day ${S.frequency.dayOfMonth}`;if(O==="yearly"){const ke=Y[S.frequency.month]??`Month ${S.frequency.month+1}`;return`${xe} on ${ke} ${S.frequency.dayOfMonth}`}return xe}const Y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var J=Mc(),te=qe(J),ie=d(te),he=v(d(ie),2),le=d(he),j=v(d(le),2),E=v(le,2);E.__click=function(...S){var O;(O=e.onCreate)==null||O.apply(this,S)};var B=v(ie,2),Z=d(B),ee=d(Z),ce=d(ee),de=v(ee,2),_e=d(de);_e.__click=()=>e.onBulkEnable([...r(o)]);var se=v(_e,2);se.__click=()=>e.onBulkDisable([...r(o)]);var ve=v(se,2);ve.__click=()=>f(s,!0);var U=v(Z,2);{var V=S=>{var O=Ec();k(S,O)},re=S=>{var O=Ic(),oe=d(O);{var be=ke=>{var Ne=Ac(),Be=d(Ne),ft=d(Be);H(qt=>L(ft,`No tasks match "${qt??""}".`),[()=>r(i).trim()]),k(ke,Ne)},xe=ke=>{var Ne=Cc(),Be=d(Ne),ft=d(Be),qt=d(ft),Je=d(qt);Je.__click=C,Wt(Je,Ze=>f(u,Ze),()=>r(u));var Qt=v(Be);Me(Qt,23,()=>r(m),Ze=>Ze.id,(Ze,Oe,Dt)=>{var ze=xc();ze.__keydown=Fe=>K(Fe,r(Dt));var et=d(ze),ns=d(et);ns.__click=()=>T(r(Oe).id);var Xt=v(et),Lt=d(Xt),jt=v(Xt),ae=d(jt),pe=v(jt),Ae=d(pe),Le=v(pe),dt=d(Le),tt=d(dt);tt.__change=()=>e.onToggleEnabled(r(Oe));var Kt=v(Le),Et=d(Kt),ge=d(Et);ge.__click=()=>e.onEdit(r(Oe));var Ie=v(ge,2);Ie.__click=()=>e.onDuplicate(r(Oe));var je=v(Ie,2);je.__click=()=>p(r(Oe)),Wt(ze,(Fe,st)=>l[st]=Fe,Fe=>l==null?void 0:l[Fe],()=>[r(Dt)]),H((Fe,st,at,_t)=>{Re(ze,1,Ml(r(Oe).enabled?"":"disabled"),"svelte-i091qn"),De(ze,"tabindex",r(Dt)===r(c)?0:-1),De(ze,"aria-selected",Fe),De(ns,"aria-label",`Select ${r(Oe).name}`),la(ns,st),L(Lt,r(Oe).name),L(ae,at),L(Ae,_t),la(tt,r(Oe).enabled)},[()=>r(o).has(r(Oe).id),()=>r(o).has(r(Oe).id),()=>Rn(new Date(r(Oe).dueAt)),()=>z(r(Oe))]),ot("focus",ze,()=>f(c,r(Dt),!0)),k(Ze,ze)}),H(()=>{la(Je,r(q)),Je.disabled=r(m).length===0}),k(ke,Ne)};G(oe,ke=>{r(m).length===0?ke(be):ke(xe,!1)})}k(S,O)};G(U,S=>{r(h).length===0?S(V):S(re,!1)})}var b=v(te,2);{var R=S=>{var O=qc(),oe=d(O),be=v(d(oe),2),xe=d(be),ke=v(be,2),Ne=d(ke);Ne.__click=x;var Be=v(Ne,2);Be.__click=w,H(()=>L(xe,`Are you sure you want to delete "${r(t).name??""}"? This action cannot be undone.`)),k(S,O)};G(b,S=>{r(t)&&S(R)})}var $=v(b,2);{var ne=S=>{var O=Oc(),oe=d(O),be=v(d(oe),2),xe=d(be),ke=v(be,2),Ne=d(ke);Ne.__click=N;var Be=v(Ne,2);Be.__click=M,H(()=>L(xe,`Are you sure you want to delete ${r(o).size??""} task${r(o).size===1?"":"s"}? This action cannot be undone.`)),k(S,O)};G($,S=>{r(s)&&S(ne)})}H(()=>{j.disabled=r(h).length===0,L(ce,`${r(o).size??""} selected`),_e.disabled=!r(_),se.disabled=!r(_),ve.disabled=!r(_)}),We(j,()=>r(n),S=>f(n,S)),k(a,J),He()}$e(["click","keydown","change"]);var Rc=A('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Bc=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Fc=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Pc=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),zc=A('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Lc=A('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),jc=A('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Kc=A('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Uc(a,e){Ue(e,!0);let t=vs(e,"days",3,30);function s(w){const{frequency:x}=w;if(x.type==="weekly"){const T=[...x.weekdays].sort((C,P)=>C-P).join(",");return`weekly:${x.interval}:${x.time??""}:${T}`}return x.type==="monthly"?`monthly:${x.interval}:${x.time??""}:${x.dayOfMonth}`:x.type==="yearly"?`yearly:${x.interval}:${x.time??""}:${x.month}:${x.dayOfMonth}`:`daily:${x.interval}:${x.time??""}`}function n(w,x){const T=w.map(C=>`${C.id}:${C.enabled}:${C.dueAt}:${s(C)}`).join("|");return`${x}:${T}`}function i(w,x){const T=Bn(new Date),C=lc(Ma(T,x-1)),P=24*60*60*1e3,M=dc(T,x).map(N=>({date:N,tasks:[]}));for(const N of w.filter(z=>z.enabled)){const z=new Date(N.dueAt),Y=e.recurrenceEngine.getOccurrencesInRange(T,C,N.frequency,z);for(const J of Y){const te=Bn(J),ie=Math.floor((te.getTime()-T.getTime())/P);ie>=0&&ie<x&&M[ie].tasks.push({task:N,occurrence:J})}}for(const N of M)N.tasks.sort((z,Y)=>z.occurrence.getTime()-Y.occurrence.getTime());return M}const o=(()=>{let w="",x=[];return{get(T,C){const P=n(T,C);return P===w||(w=P,x=i(T,C)),x}}})(),c=Q(()=>o.get(e.tasks,t())),l=Q(()=>r(c).some(w=>w.tasks.length>0));var u=Kc(),h=d(u),m=v(d(h),2),y=d(m),_=v(h,2),q=d(_);{var g=w=>{var x=Rc(),T=d(x),C=d(T);H(()=>L(C,`No tasks scheduled in the next ${t()??""} days.`)),k(w,x)},p=w=>{var x=jc();Me(x,21,()=>r(c),T=>T.date.toISOString(),(T,C)=>{var P=Pe(),K=qe(P);{var M=N=>{var z=Lc(),Y=d(z),J=d(Y),te=d(J),ie=v(J,2),he=d(ie),le=v(Y,2);Me(le,21,()=>r(C).tasks,({task:j,occurrence:E})=>j.id+E.toISOString(),(j,E)=>{let B=()=>r(E).task,Z=()=>r(E).occurrence;var ee=zc(),ce=d(ee),de=d(ce),_e=v(ce,2),se=d(_e),ve=d(se),U=v(se,2),V=d(U);{var re=S=>{var O=Bc(),oe=d(O);H(()=>L(oe,`üîó ${B().linkedBlockId??""}`)),k(S,O)};G(V,S=>{B().linkedBlockId&&S(re)})}var b=v(V,2);{var R=S=>{var O=Fc(),oe=d(O);H(()=>L(oe,`‚ö° ${B().priority??""}`)),k(S,O)};G(b,S=>{B().priority&&S(R)})}var $=v(b,2);{var ne=S=>{var O=Pc(),oe=d(O);H(be=>L(oe,`üè∑Ô∏è ${be??""}`),[()=>B().tags.join(", ")]),k(S,O)};G($,S=>{var O;(O=B().tags)!=null&&O.length&&S(ne)})}H(S=>{L(de,S),L(ve,B().name)},[()=>ac(Z())]),k(j,ee)}),H((j,E)=>{L(te,j),L(he,E)},[()=>nc(r(C).date),()=>r(C).date.toLocaleDateString(void 0,{weekday:"short"})]),k(N,z)};G(K,N=>{r(C).tasks.length>0&&N(M)})}k(T,P)}),k(w,x)};G(q,w=>{r(l)?w(p,!1):w(g)})}H(()=>L(y,`Next ${t()??""} days`)),k(a,u),He()}var Hc=A('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),Gc=A('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Yc=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Vc=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Wc=A('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Qc=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Xc=A('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),$c=A('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),Jc=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),Zc=A('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function ed(a,e){Ue(e,!0);const t=Q(()=>()=>{let j=0,E=0;for(const ee of e.tasks)j+=ee.completionCount||0,E+=ee.missCount||0;const B=j+E,Z=B>0?j/B*100:100;return{totalCompletions:j,totalMisses:E,completionRate:Math.round(Z)}}),s=Q(()=>()=>[...e.tasks].filter(j=>(j.currentStreak||0)>0).sort((j,E)=>(E.currentStreak||0)-(j.currentStreak||0)).slice(0,10)),n=Q(()=>()=>[...e.tasks].map(j=>({task:j,health:Qi(j)})).sort((j,E)=>j.health-E.health)),i=Q(()=>()=>r(n)().slice(-5).reverse()),o=Q(()=>()=>r(n)().slice(0,5)),c=Q(()=>()=>{const j=[];for(const E of e.tasks)if(E.recentCompletions&&E.recentCompletions.length>0)for(const B of E.recentCompletions)j.push({task:E,completedAt:B});return j.sort((E,B)=>new Date(B.completedAt).getTime()-new Date(E.completedAt).getTime()).slice(0,10)});function l(j){return new Date(j).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(j){return j>=80?"#10b981":j>=60?"#3b82f6":j>=40?"#f59e0b":"#ef4444"}var h=Zc(),m=v(d(h),2),y=d(m),_=v(d(y),2),q=d(_),g=d(q),p=d(g),w=v(q,2),x=d(w),T=d(x),C=v(w,2),P=d(C),K=d(P),M=v(y,2);{var N=j=>{var E=Yc(),B=v(d(E),2);Me(B,21,()=>r(s)(),vt,(Z,ee,ce)=>{var de=Gc(),_e=d(de);_e.textContent=`#${ce+1}`;var se=v(_e,2),ve=d(se),U=v(se,2),V=d(U),re=v(V);{var b=R=>{var $=Hc();k(R,$)};G(re,R=>{r(ee).bestStreak&&r(ee).currentStreak===r(ee).bestStreak&&R(b)})}H(()=>{L(ve,r(ee).name),L(V,`${r(ee).currentStreak??""} day${r(ee).currentStreak!==1?"s":""} `)}),k(Z,de)}),k(j,E)};G(M,j=>{r(s)().length>0&&j(N)})}var z=v(M,2),Y=v(d(z),2);{var J=j=>{var E=Wc(),B=v(qe(E),2);Me(B,21,()=>r(i)(),vt,(Z,ee)=>{let ce=()=>r(ee).task,de=()=>r(ee).health;var _e=Vc(),se=d(_e),ve=d(se),U=v(se,2),V=d(U),re=v(V,2),b=d(re);H(R=>{L(ve,ce().name),Vs(V,`width: ${de()??""}%; background-color: ${R??""}`),L(b,`${de()??""}/100`)},[()=>u(de())]),k(Z,_e)}),k(j,E)};G(Y,j=>{r(i)().length>0&&j(J)})}var te=v(Y,2);{var ie=j=>{var E=Xc(),B=v(qe(E),2);Me(B,21,()=>r(o)(),vt,(Z,ee)=>{let ce=()=>r(ee).task,de=()=>r(ee).health;var _e=Qc(),se=d(_e),ve=d(se),U=v(se,2),V=d(U),re=v(V,2),b=d(re);H(R=>{L(ve,ce().name),Vs(V,`width: ${de()??""}%; background-color: ${R??""}`),L(b,`${de()??""}/100`)},[()=>u(de())]),k(Z,_e)}),k(j,E)};G(te,j=>{r(o)().length>0&&r(o)()[0].health<80&&j(ie)})}var he=v(z,2);{var le=j=>{var E=Jc(),B=v(d(E),2);Me(B,21,()=>r(c)(),vt,(Z,ee)=>{let ce=()=>r(ee).task,de=()=>r(ee).completedAt;var _e=$c(),se=v(d(_e),2),ve=d(se),U=d(ve),V=v(ve,2),re=d(V);H(b=>{L(U,ce().name),L(re,b)},[()=>l(de())]),k(Z,_e)}),k(j,E)};G(he,j=>{r(c)().length>0&&j(le)})}H((j,E,B)=>{L(p,j),L(T,E),L(K,`${B??""}%`)},[()=>r(t)().totalCompletions,()=>r(t)().totalMisses,()=>r(t)().completionRate]),k(a,h),He()}var td=A('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">üì• No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),sd=A('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),ad=A('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function nd(a,e){Ue(e,!0);const t=Q(()=>e.tasks.filter(g=>g.status!=="done"&&g.status!=="cancelled"&&!g.dueAt&&!g.scheduledAt&&!g.startAt).sort((g,p)=>new Date(p.createdAt).getTime()-new Date(g.createdAt).getTime()));let s=W(0),n=ye([]);ut(()=>{r(s)>=r(t).length&&f(s,Math.max(0,r(t).length-1),!0)});function i(g){var w;if(r(t).length===0)return;const p=Math.max(0,Math.min(g,r(t).length-1));f(s,p,!0),(w=n[p])==null||w.focus()}function o(g,p){g.key==="ArrowDown"?(g.preventDefault(),i(p+1)):g.key==="ArrowUp"?(g.preventDefault(),i(p-1)):g.key==="Enter"&&e.onEdit?(g.preventDefault(),e.onEdit(r(t)[p])):g.key===" "&&e.onDone&&(g.preventDefault(),e.onDone(r(t)[p]))}var c=ad(),l=d(c),u=v(d(l),2),h=d(u),m=v(l,2),y=d(m);{var _=g=>{var p=td();k(g,p)},q=g=>{var p=Pe(),w=qe(p);Me(w,19,()=>r(t),x=>x.id,(x,T,C)=>{var P=sd();P.__keydown=M=>o(M,r(C));var K=d(P);ba(K,{get task(){return r(T)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(P,(M,N)=>n[N]=M,M=>n==null?void 0:n[M],()=>[r(C)]),H(()=>De(P,"tabindex",r(C)===r(s)?0:-1)),ot("focus",P,()=>f(s,r(C),!0)),k(x,P)}),k(g,p)};G(y,g=>{r(t).length===0?g(_):g(q,!1)})}H(()=>L(h,`${r(t).length??""} task${r(t).length!==1?"s":""} without dates`)),k(a,c),He()}$e(["keydown"]);var rd=A('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),id=A('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),od=A('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),ld=A('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function cd(a,e){Ue(e,!0);let t=vs(e,"daysAhead",3,7);const s=new Date;s.setHours(0,0,0,0);const n=new Date(s);n.setDate(n.getDate()+t());const i=Q(()=>e.tasks.filter(T=>{if(T.status==="done"||T.status==="cancelled"||!T.dueAt)return!1;const C=new Date(T.dueAt);return C.setHours(0,0,0,0),C>s&&C<=n}).sort((T,C)=>new Date(T.dueAt).getTime()-new Date(C.dueAt).getTime())),o=Q(()=>()=>{const T=new Map;return r(i).forEach(C=>{const P=new Date(C.dueAt);P.setHours(0,0,0,0);const K=P.toISOString().split("T")[0];T.has(K)||T.set(K,[]),T.get(K).push(C)}),T});function c(T){const C=new Date(T),P=Math.floor((C.getTime()-s.getTime())/(1e3*60*60*24)),K=C.toLocaleDateString("en-US",{weekday:"long"}),M=C.toLocaleDateString("en-US",{month:"short",day:"numeric"});return P===1?`Tomorrow - ${K}, ${M}`:`${K}, ${M} (in ${P} days)`}let l=W(0),u=ye([]);ut(()=>{r(l)>=r(i).length&&f(l,Math.max(0,r(i).length-1),!0)});function h(T,C){T.key==="ArrowDown"?(T.preventDefault(),f(l,Math.min(r(l)+1,r(i).length-1),!0)):T.key==="ArrowUp"?(T.preventDefault(),f(l,Math.max(r(l)-1,0),!0)):T.key==="Enter"&&e.onEdit?(T.preventDefault(),e.onEdit(r(i)[C])):T.key===" "&&e.onDone&&(T.preventDefault(),e.onDone(r(i)[C]))}var m=ld(),y=d(m),_=v(d(y),2),q=d(_),g=v(y,2),p=d(g);{var w=T=>{var C=rd(),P=d(C),K=d(P);H(()=>L(K,`üìÖ No tasks scheduled for the next ${t()??""} days`)),k(T,C)},x=T=>{var C=Pe(),P=qe(C);Me(P,17,()=>[...r(o).entries()],vt,(K,M)=>{var N=Q(()=>Qr(r(M),2));let z=()=>r(N)[0],Y=()=>r(N)[1];var J=od(),te=d(J),ie=d(te),he=v(te,2);Me(he,19,Y,le=>le.id,(le,j)=>{const E=Q(()=>r(i).indexOf(r(j)));var B=id();B.__keydown=ee=>h(ee,r(E));var Z=d(B);ba(Z,{get task(){return r(j)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(B,(ee,ce)=>u[ce]=ee,ee=>u==null?void 0:u[ee],()=>[r(E)]),H(()=>De(B,"tabindex",r(E)===r(l)?0:-1)),ot("focus",B,()=>f(l,r(E),!0)),k(le,B)}),H(le=>L(ie,le),[()=>c(z())]),k(K,J)}),k(T,C)};G(p,T=>{r(i).length===0?T(w):T(x,!1)})}H(()=>L(q,`${r(i).length??""} task${r(i).length!==1?"s":""} in the next ${t()??""} days`)),k(a,m),He()}$e(["keydown"]);var dd=A('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">‚úÖ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),ud=A('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),vd=A('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),hd=A('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">‚Üê Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next ‚Üí</button></div>'),fd=A("<!> <!>",1),_d=A('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function pd(a,e){Ue(e,!0);let t=vs(e,"daysBack",3,30),s=W(0);const n=50,i=new Date;i.setDate(i.getDate()-t()),i.setHours(0,0,0,0);const o=Q(()=>e.tasks.filter(M=>M.status!=="done"||!M.doneAt?!1:new Date(M.doneAt)>=i).sort((M,N)=>new Date(N.doneAt).getTime()-new Date(M.doneAt).getTime())),c=Q(()=>Math.ceil(r(o).length/n)),l=Q(()=>r(o).slice(r(s)*n,(r(s)+1)*n));ut(()=>{r(s)>=r(c)&&r(c)>0&&f(s,r(c)-1)});function u(){r(s)<r(c)-1&&lr(s)}function h(){r(s)>0&&lr(s,-1)}function m(M){const N=new Date(M),z=new Date,Y=z.getTime()-N.getTime(),J=Math.floor(Y/(1e3*60*60*24));return J===0?"Today":J===1?"Yesterday":J<7?`${J} days ago`:N.toLocaleDateString("en-US",{month:"short",day:"numeric",year:N.getFullYear()!==z.getFullYear()?"numeric":void 0})}let y=W(0),_=ye([]);ut(()=>{r(y)>=r(l).length&&f(y,Math.max(0,r(l).length-1),!0)});function q(M,N){M.key==="ArrowDown"?(M.preventDefault(),f(y,Math.min(r(y)+1,r(l).length-1),!0)):M.key==="ArrowUp"?(M.preventDefault(),f(y,Math.max(r(y)-1,0),!0)):M.key==="Enter"&&e.onEdit&&(M.preventDefault(),e.onEdit(r(l)[N]))}var g=_d(),p=d(g),w=v(d(p),2),x=d(w),T=v(p,2),C=d(T);{var P=M=>{var N=dd();k(M,N)},K=M=>{var N=fd(),z=qe(N);Me(z,19,()=>r(l),te=>te.id,(te,ie,he)=>{var le=vd();le.__keydown=de=>q(de,r(he));var j=d(le),E=d(j),B=d(E),Z=v(E,2);{var ee=de=>{var _e=ud();_e.__click=()=>e.onUncomplete(r(ie)),k(de,_e)};G(Z,de=>{e.onUncomplete&&de(ee)})}var ce=v(j,2);ba(ce,{get task(){return r(ie)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),Wt(le,(de,_e)=>_[_e]=de,de=>_==null?void 0:_[de],()=>[r(he)]),H(de=>{De(le,"tabindex",r(he)===r(y)?0:-1),L(B,`Completed ${de??""}`)},[()=>m(r(ie).doneAt)]),ot("focus",le,()=>f(y,r(he),!0)),k(te,le)});var Y=v(z,2);{var J=te=>{var ie=hd(),he=d(ie);he.__click=h;var le=v(he,2),j=d(le),E=v(le,2);E.__click=u,H(()=>{he.disabled=r(s)===0,L(j,`Page ${r(s)+1} of ${r(c)??""}`),E.disabled=r(s)>=r(c)-1}),k(te,ie)};G(Y,te=>{r(c)>1&&te(J)})}k(M,N)};G(C,M=>{r(o).length===0?M(P):M(K,!1)})}H(()=>L(x,`${r(o).length??""} completed task${r(o).length!==1?"s":""} in the last ${t()??""} days`)),k(a,g),He()}$e(["keydown","click"]);var gd=A('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">üìÅ No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),md=A('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),yd=A('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),kd=A('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),bd=A('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function wd(a,e){Ue(e,!0);const t=Q(()=>()=>{const z=new Map;return e.tasks.filter(J=>J.status!=="done"&&J.status!=="cancelled").forEach(J=>{const te=J.linkedBlockPath||"Uncategorized";z.has(te)||z.set(te,[]),z.get(te).push(J)}),z.forEach(J=>{J.sort((te,ie)=>!te.dueAt&&!ie.dueAt?0:te.dueAt?ie.dueAt?new Date(te.dueAt).getTime()-new Date(ie.dueAt).getTime():-1:1)}),new Map([...z.entries()].sort(([J],[te])=>J.localeCompare(te)))}),s=Q(()=>[...r(t).values()].reduce((z,Y)=>z+Y.length,0));let n=W(ye(new Set([...r(t).keys()])));function i(z){const Y=new Set(r(n));Y.has(z)?Y.delete(z):Y.add(z),f(n,Y,!0)}function o(){f(n,new Set([...r(t).keys()]),!0)}function c(){f(n,new Set,!0)}let l=W(0),u=ye([]);const h=Q(()=>()=>{const z=[];return r(t).forEach((Y,J)=>{r(n).has(J)&&z.push(...Y)}),z});ut(()=>{r(l)>=r(h).length&&f(l,Math.max(0,r(h).length-1),!0)});function m(z,Y){z.key==="ArrowDown"?(z.preventDefault(),f(l,Math.min(r(l)+1,r(h).length-1),!0)):z.key==="ArrowUp"?(z.preventDefault(),f(l,Math.max(r(l)-1,0),!0)):z.key==="Enter"&&e.onEdit?(z.preventDefault(),e.onEdit(r(h)[Y])):z.key===" "&&e.onDone&&(z.preventDefault(),e.onDone(r(h)[Y]))}function y(z){const Y=z.split("/");return Y[Y.length-1]||z}var _=bd(),q=d(_),g=d(q),p=v(d(g),2),w=d(p),x=v(g,2),T=d(x);T.__click=o;var C=v(T,2);C.__click=c;var P=v(q,2),K=d(P);{var M=z=>{var Y=gd();k(z,Y)},N=z=>{var Y=Pe(),J=qe(Y);Me(J,17,()=>[...r(t).entries()],vt,(te,ie)=>{var he=Q(()=>Qr(r(ie),2));let le=()=>r(he)[0],j=()=>r(he)[1];var E=kd(),B=d(E);B.__click=()=>i(le());var Z=d(B),ee=d(Z),ce=v(Z,2),de=d(ce),_e=v(ce,2),se=d(_e),ve=v(B,2);{var U=V=>{var re=yd();Me(re,23,j,b=>b.id,(b,R)=>{const $=Q(()=>r(h).indexOf(r(R)));var ne=md();ne.__keydown=O=>m(O,r($));var S=d(ne);ba(S,{get task(){return r(R)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(ne,(O,oe)=>u[oe]=O,O=>u==null?void 0:u[O],()=>[r($)]),H(()=>De(ne,"tabindex",r($)===r(l)?0:-1)),ot("focus",ne,()=>f(l,r($),!0)),k(b,ne)}),H(b=>De(re,"aria-label",b),[()=>`Tasks for ${y(le())}`]),k(V,re)};G(ve,V=>{r(n).has(le())&&V(U)})}H((V,re)=>{L(ee,V),De(ce,"title",le()),L(de,re),L(se,j().length)},[()=>r(n).has(le())?"‚ñº":"‚ñ∂",()=>y(le())]),k(te,E)}),k(z,Y)};G(K,z=>{r(t).size===0?z(M):z(N,!1)})}H(()=>L(w,`${r(s)??""} task${r(s)!==1?"s":""} in ${r(t).size??""} project${r(t).size!==1?"s":""}`)),k(a,_),He()}$e(["click","keydown"]);class Is extends Error{constructor(e,t,s,n){super(e),this.line=t,this.column=s,this.suggestion=n,this.name="QuerySyntaxError"}}class aa extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var Ge=(a=>(a.TODO="TODO",a.IN_PROGRESS="IN_PROGRESS",a.DONE="DONE",a.CANCELLED="CANCELLED",a.NON_TASK="NON_TASK",a.EMPTY="EMPTY",a))(Ge||{});const $t=class $t{constructor(e){D(this,"symbol");D(this,"name");D(this,"nextStatusSymbol");D(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};D($t,"TODO",new $t({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),D($t,"DONE",new $t({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),D($t,"IN_PROGRESS",new $t({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),D($t,"CANCELLED",new $t({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let rs=$t;class Td{static parse(e,t=new Date){const s=e.trim().toLowerCase(),n=e;if(!s)return{date:null,isValid:!1,error:"Empty date string",original:n};if(s.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const _=new Date(s);if(!isNaN(_.getTime()))return{date:_,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),s==="today")return{date:o,isValid:!0,original:n};if(s==="tomorrow"){const _=new Date(o);return _.setDate(_.getDate()+1),{date:_,isValid:!0,original:n}}if(s==="yesterday"){const _=new Date(o);return _.setDate(_.getDate()-1),{date:_,isValid:!0,original:n}}const c=s.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(c){const _=parseInt(c[1]),q=c[2],g=new Date(o);return q.startsWith("day")?g.setDate(g.getDate()+_):q.startsWith("week")?g.setDate(g.getDate()+_*7):q.startsWith("month")&&g.setMonth(g.getMonth()+_),{date:g,isValid:!0,original:n}}const l=s.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(l){const _=parseInt(l[1]),q=l[2],g=new Date(o);return q.startsWith("day")?g.setDate(g.getDate()-_):q.startsWith("week")?g.setDate(g.getDate()-_*7):q.startsWith("month")&&g.setMonth(g.getMonth()-_),{date:g,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=s.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const _=h[1],q=u.indexOf(h[2]),g=o.getDay();let p=q-g;_==="next"?p<=0&&(p+=7):p>=0&&(p-=7);const w=new Date(o);return w.setDate(w.getDate()+p),{date:w,isValid:!0,original:n}}const m=s.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(m){const _=u.indexOf(m[1]),q=o.getDay();let g=_-q;g<0&&(g+=7);const p=new Date(o);return p.setDate(p.getDate()+g),{date:p,isValid:!0,original:n}}const y=s.match(/^(this|next|last)\s+(week|month)$/);if(y){const _=y[1],q=y[2],g=new Date(o);if(q==="week"){const p=g.getDay(),w=p===0?-6:1-p;g.setDate(g.getDate()+w),_==="next"?g.setDate(g.getDate()+7):_==="last"&&g.setDate(g.getDate()-7)}else q==="month"&&(g.setDate(1),_==="next"?g.setMonth(g.getMonth()+1):_==="last"&&g.setMonth(g.getMonth()-1));return{date:g,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class Ji{constructor(){D(this,"input","");D(this,"position",0);D(this,"line",1);D(this,"column",1);D(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const s={filters:[]},n=this.input.split(`
`).map(i=>i.trim()).filter(i=>i.length>0);for(let i=0;i<n.length;i++){this.line=i+1,this.column=1;const o=n[i];if(o.startsWith("sort by "))s.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))s.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))s.limit=this.parseLimitInstruction(o);else{const c=this.parseFilterInstruction(o);c&&s.filters.push(c)}}return s}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Is?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(e.startsWith("status.type is ")){const s=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(s)}}if(e.startsWith("status.name includes ")){const s=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(s)}}if(e.startsWith("status.symbol is ")){const s=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(s)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("tag includes ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e.startsWith("tag does not include ")){const s=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(s),negate:!0}}if(e.startsWith("tags include ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const s=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(s)}}if(e.startsWith("path does not include ")){const s=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(s),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};throw new Is(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const s of t){if(e===`has ${s} date`)return{type:"date",operator:"has",value:{field:s}};if(e===`no ${s} date`)return{type:"date",operator:"has",value:{field:s},negate:!0};const n=["before","after","on","on or before","on or after"];for(const i of n){const o=`${s} ${i} `;if(e.startsWith(o)){const c=e.substring(o.length).trim(),l=Td.parse(c,this.referenceDate);if(!l.isValid||!l.date)throw new Is(`Invalid date value: "${c}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:i,value:{field:s,date:l.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Is(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Is(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Is(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return Ge.TODO;case"IN_PROGRESS":return Ge.IN_PROGRESS;case"DONE":return Ge.DONE;case"CANCELLED":return Ge.CANCELLED;case"NON_TASK":return Ge.NON_TASK;default:throw new Is(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}}class ct{}const Os=class Os{constructor(){D(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return Os.instance||(Os.instance=new Os),Os.instance}addDefaultStatuses(){this.add(rs.TODO),this.add(rs.IN_PROGRESS),this.add(rs.DONE),this.add(rs.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new rs({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:rs.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};D(Os,"instance",null);let as=Os;class Sd extends ct{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=as.getInstance(),s=e.statusSymbol||" ",i=t.get(s).type===this.statusType;return this.negate?!i:i}}class Dd extends ct{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=as.getInstance(),s=e.statusSymbol||" ",i=t.get(s).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!i:i}}class Ed extends ct{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const s=(e.statusSymbol||" ")===this.symbol;return this.negate?!s:s}}class Ad extends ct{matches(e){const t=as.getInstance(),s=e.statusSymbol||" ";return t.get(s).type===Ge.DONE}}class xd extends ct{matches(e){const t=as.getInstance(),s=e.statusSymbol||" ";return t.get(s).type!==Ge.DONE}}class Cd extends ct{constructor(e,t,s){super(),this.field=e,this.comparator=t,this.targetDate=s}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const s=new Date(this.targetDate);s.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<s;case"after":return n>s;case"on":return n.getTime()===s.getTime();case"on or before":return n<=s;case"on or after":return n>=s;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class Id extends ct{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const Rr={lowest:0,low:1,medium:2,normal:2,high:3,highest:4};function qd(a){switch(a){case"low":return"low";case"normal":return"normal";case"high":return"high";case"urgent":return"highest";default:return"normal"}}class Od extends ct{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=qd(e.priority),s=Rr[t],n=Rr[this.level];switch(this.operator){case"is":return s===n;case"above":return s>n;case"below":return s<n;default:return!1}}}class Md extends ct{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],s=this.tag.toLowerCase(),n=t.some(i=>i.toLowerCase().includes(s));return this.negate?!n:n}}class Nd extends ct{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class Rd extends ct{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const s=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!s:s}}class Bd extends ct{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const s=e.blockedBy&&e.blockedBy.length>0;return this.negate?!s:!!s}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Fd extends ct{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Pd extends ct{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class zd extends ct{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Ld extends ct{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class jd extends ct{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class xs{group(e){const t=new Map;for(const s of e){const n=this.getGroupKey(s);this.addToGroup(t,n,s)}return t}addToGroup(e,t,s){e.has(t)||e.set(t,[]),e.get(t).push(s)}}class Kd extends xs{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.dueAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),i=Math.ceil(n/(1e3*60*60*24));return i<0?"Overdue":i===0?"Today":i===1?"Tomorrow":i<=7?"This Week":"Later"}}class Ud extends xs{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.scheduledAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),i=Math.ceil(n/(1e3*60*60*24));return i<0?"Past":i===0?"Today":i===1?"Tomorrow":i<=7?"This Week":"Later"}}class Hd extends xs{getGroupKey(e){const t=as.getInstance(),s=e.statusSymbol||" ";return t.get(s).type}}class Gd extends xs{getGroupKey(e){const t=as.getInstance(),s=e.statusSymbol||" ";return t.get(s).name}}class Yd extends xs{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class Vd extends xs{getGroupKey(e){return e.path||""||"No path"}}class Wd extends xs{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const s=t.lastIndexOf("/");return s===-1?"Root":t.substring(0,s)||"Root"}}class Qd extends xs{group(e){const t=new Map;for(const s of e){const n=s.tags||[];if(n.length===0)this.addToGroup(t,"No tags",s);else for(const i of n)this.addToGroup(t,i,s)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}class Xd{constructor(e){D(this,"dependencyGraph",null);this.taskIndex=e}setDependencyGraph(e){this.dependencyGraph=e}execute(e){const t=performance.now();try{let s=this.taskIndex.getAllTasks();const n=s.length;e.filters.length>0&&(s=this.applyFilters(s,e.filters)),e.sort&&(s=this.applySort(s,e.sort)),e.limit!==void 0&&e.limit>0&&(s=s.slice(0,e.limit));let i;e.group&&(i=this.applyGrouping(s,e.group));const c=performance.now()-t;return{tasks:s,groups:i,totalCount:n,executionTimeMs:c}}catch(s){throw new aa(`Failed to execute query: ${s instanceof Error?s.message:String(s)}`,s instanceof Error?s:void 0)}}executeString(e){const s=new Ji().parse(e);return this.execute(s)}applyFilters(e,t){let s=e;for(const n of t){const i=this.createFilter(n);s=s.filter(o=>i.matches(o))}return s}createFilter(e){switch(e.type){case"done":return e.value?new Ad:new xd;case"status":if(e.operator==="type-is")return new Sd(e.value,e.negate);if(e.operator==="name-includes")return new Dd(e.value,e.negate);if(e.operator==="symbol-is")return new Ed(e.value,e.negate);throw new aa(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new Id(e.value.field,e.negate):new Cd(e.value.field,e.operator,e.value.date);case"priority":return new Od(e.operator,e.value);case"tag":return e.operator==="has"?new Nd(!e.value):new Md(e.value,e.negate);case"path":return new Rd(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new Bd(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Fd(this.dependencyGraph,!e.value);throw new aa(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Pd(!e.value);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new zd(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="OR"&&e.left&&e.right)return new Ld(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="NOT"&&e.inner)return new jd(this.createFilter(e.inner));throw new aa(`Invalid boolean operator: ${e.operator}`);default:throw new aa(`Unknown filter type: ${e.type}`)}}applySort(e,t){const s=[...e];return s.sort((n,i)=>{let o=0;switch(t.field){case"due":o=this.compareDates(n.dueAt,i.dueAt);break;case"scheduled":o=this.compareDates(n.scheduledAt,i.scheduledAt);break;case"start":o=this.compareDates(n.startAt,i.startAt);break;case"created":o=this.compareDates(n.createdAt,i.createdAt);break;case"done":o=this.compareDates(n.doneAt,i.doneAt);break;case"priority":o=this.comparePriorities(n.priority,i.priority);break;case"status.type":o=this.compareStatusTypes(n,i);break;case"description":o=(n.description||"").localeCompare(i.description||"");break;case"path":o=(n.path||"").localeCompare(i.path||"");break;default:o=n.name.localeCompare(i.name)}return t.reverse?-o:o}),s}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const s={low:1,normal:2,high:3,urgent:4},n=s[e||"normal"]||2,i=s[t||"normal"]||2;return n-i}compareStatusTypes(e,t){const s=n=>{const i=n.statusSymbol||" ";return i===" "?0:i==="/"?1:i==="x"?2:i==="-"?3:0};return s(e)-s(t)}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new Kd;case"scheduled":return new Ud;case"status.type":return new Hd;case"status.name":return new Gd;case"priority":return new Yd;case"path":return new Vd;case"folder":return new Wd;case"tags":return new Qd;default:throw new aa(`Unknown grouping field: ${e}`)}}}var $d=A('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Jd=A('<div class="search-tab__error svelte-1yjlv38"> </div>'),Zd=A('<div class="search-tab__stats svelte-1yjlv38"> </div>'),eu=A('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),tu=A('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),su=A('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),au=A('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">üîç No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),nu=A('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),ru=A(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function iu(a,e){Ue(e,!0);let t=W(""),s=W(ye([])),n=W(""),i=W(0),o=W(ye([])),c=W(!1),l=W(!1);const u=["not done","due today","priority high","status.type IN_PROGRESS","not done AND due before tomorrow","has tags","done after 7 days ago","not done GROUP BY priority"],h={getAllTasks:()=>e.tasks},m=new Xd(h);function y(){if(!r(t).trim()){f(s,[],!0),f(n,"");return}f(l,!0),f(n,"");try{const V=new Ji().parse(r(t)),re=m.execute(V);if(f(s,re.tasks,!0),f(i,re.executionTimeMs,!0),!r(o).includes(r(t))){f(o,[r(t),...r(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(r(o)))}catch{}}}catch(U){f(n,U instanceof Error?U.message:String(U),!0),f(s,[],!0),X.error(`Query error: ${r(n)}`)}finally{f(l,!1)}}function _(){try{const U=localStorage.getItem("query-history");U&&f(o,JSON.parse(U),!0)}catch{}}function q(U){f(t,U,!0),y()}function g(U){f(t,U,!0),f(c,!1),y()}function p(){f(o,[],!0);try{localStorage.removeItem("query-history")}catch{}f(c,!1)}function w(U){U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),y())}ut(()=>{_()});let x=W(0),T=ye([]);ut(()=>{r(x)>=r(s).length&&f(x,Math.max(0,r(s).length-1),!0)});function C(U,V){U.key==="ArrowDown"?(U.preventDefault(),f(x,Math.min(r(x)+1,r(s).length-1),!0)):U.key==="ArrowUp"?(U.preventDefault(),f(x,Math.max(r(x)-1,0),!0)):U.key==="Enter"&&e.onEdit?(U.preventDefault(),e.onEdit(r(s)[V])):U.key===" "&&e.onDone&&(U.preventDefault(),e.onDone(r(s)[V]))}var P=ru(),K=v(d(P),2),M=d(K),N=d(M);N.__keydown=w;var z=v(N,2),Y=d(z);Y.__click=y;var J=d(Y),te=v(Y,2);{var ie=U=>{var V=$d();V.__click=()=>f(c,!r(c));var re=d(V);H(()=>L(re,`History (${r(o).length??""})`)),k(U,V)};G(te,U=>{r(o).length>0&&U(ie)})}var he=v(M,2);{var le=U=>{var V=Jd(),re=d(V);H(()=>L(re,`‚ö†Ô∏è ${r(n)??""}`)),k(U,V)};G(he,U=>{r(n)&&U(le)})}var j=v(he,2);{var E=U=>{var V=Zd(),re=d(V);H(b=>L(re,`Found ${r(s).length??""} task${r(s).length!==1?"s":""} in ${b??""}ms`),[()=>r(i).toFixed(2)]),k(U,V)};G(j,U=>{r(i)>0&&!r(n)&&U(E)})}var B=v(K,2);{var Z=U=>{var V=tu(),re=d(V),b=v(d(re),2);b.__click=p;var R=v(re,2);Me(R,21,()=>r(o),vt,($,ne)=>{var S=eu(),O=d(S);O.__click=()=>g(r(ne));var oe=d(O);H(()=>L(oe,r(ne))),k($,S)}),k(U,V)};G(B,U=>{r(c)&&r(o).length>0&&U(Z)})}var ee=v(B,2),ce=v(d(ee),2);Me(ce,21,()=>u,vt,(U,V)=>{var re=su();re.__click=()=>q(r(V));var b=d(re),R=d(b);H(()=>L(R,r(V))),k(U,re)});var de=v(ee,2),_e=d(de);{var se=U=>{var V=au();k(U,V)},ve=U=>{var V=Pe(),re=qe(V);{var b=R=>{var $=Pe(),ne=qe($);Me(ne,19,()=>r(s),S=>S.id,(S,O,oe)=>{var be=nu();be.__keydown=ke=>C(ke,r(oe));var xe=d(be);ba(xe,{get task(){return r(O)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(be,(ke,Ne)=>T[Ne]=ke,ke=>T==null?void 0:T[ke],()=>[r(oe)]),H(()=>De(be,"tabindex",r(oe)===r(x)?0:-1)),ot("focus",be,()=>f(x,r(oe),!0)),k(S,be)}),k(R,$)};G(re,R=>{r(s).length>0&&R(b)},!0)}k(U,V)};G(_e,U=>{r(s).length===0&&r(t).trim()&&!r(n)?U(se):U(ve,!1)})}H(()=>{Y.disabled=r(l),L(J,r(l)?"Searching...":"Search")}),We(N,()=>r(t),U=>f(t,U)),k(a,P),He()}$e(["keydown","click"]);class Fn{static parse(e){const t=e,s=e.trim().toLowerCase();if(!s)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=s.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let i=n[1],o;const c=i.match(/^(.+?)\s+when\s+done$/),l=i.match(/^(.+?)\s+when\s+due$/);if(c?(i=c[1],o=!0):l&&(i=l[1],o=!1),i==="weekday"||i==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(i==="weekend"||i==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=i.match(/^(\d+\s+)?days?$/);if(u)return{frequency:{type:"daily",interval:u[1]?parseInt(u[1]):1,whenDone:o},raw:t,isValid:!0};const h=i.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(h){const _=h[1]?parseInt(h[1]):1,q=h[2];if(!q)return{frequency:{type:"weekly",interval:_,weekdays:[1],whenDone:o},raw:t,isValid:!0};const g=this.parseDayNames(q);return g.length===0?{frequency:{type:"weekly",interval:_,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:_,weekdays:g,whenDone:o},raw:t,isValid:!0}}const m=i.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(m){const _=m[1]?parseInt(m[1]):1,q=m[2]?parseInt(m[2]):1;return q<1||q>31?{frequency:{type:"monthly",interval:_,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:_,dayOfMonth:q,whenDone:o},raw:t,isValid:!0}}const y=i.match(/^(\d+\s+)?years?$/);return y?{frequency:{type:"yearly",interval:y[1]?parseInt(y[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=e.interval;let s;switch(e.type){case"daily":s=t===1?"every day":`every ${t} days`;break;case"weekly":{const n=t===1?"week":`${t} weeks`;if(e.weekdays.length===0)s=`every ${n}`;else{const i=e.weekdays.map(o=>this.getDayName(o)).join(", ");s=`every ${n} on ${i}`}break}case"monthly":{const n=t===1?"month":`${t} months`,i=this.getDaySuffix(e.dayOfMonth);s=`every ${n} on the ${e.dayOfMonth}${i}`;break}case"yearly":{s=`every ${t===1?"year":`${t} years`}`;break}default:s="every day"}return e.whenDone?`${s} when done`:s}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},s=e.split(",").map(i=>i.trim().toLowerCase()),n=[];for(const i of s)i in t&&n.push(t[i]);return n}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var ou=A('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),lu=A('<div class="priority-selector svelte-1w15n9q"></div>');function cu(a,e){Ue(e,!0);let t=vs(e,"value",15,"normal");const s=[{value:"urgent",label:"Urgent",emoji:"üî¥",color:"var(--b3-theme-error, #ff4444)"},{value:"high",label:"High",emoji:"üü†",color:"#ff8800"},{value:"normal",label:"Normal",emoji:"üü°",color:"#ffcc00"},{value:"low",label:"Low",emoji:"üü¢",color:"#44cc44"}];function n(o){t(o),e.onchange(o)}var i=lu();Me(i,21,()=>s,vt,(o,c)=>{var l=ou();let u;var h=d(l);h.__change=()=>n(r(c).value);var m=v(h,2),y=d(m),_=v(m,2),q=d(_);H(()=>{u=Re(l,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===r(c).value}),Vs(l,`--priority-color: ${r(c).color??""}`),Ki(h,r(c).value),la(h,t()===r(c).value),L(y,r(c).emoji),L(q,r(c).label)}),k(o,l)}),k(a,i),He()}$e(["change"]);var du=A('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),uu=A('<div class="status-selector svelte-v9ezc0"></div>');function vu(a,e){Ue(e,!0);let t=vs(e,"value",15,"todo");const s=[{value:"todo",label:"Todo",icon:"‚óã",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"‚úì",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"‚úï",color:"#999"}];function n(o){t(o),e.onchange(o)}var i=uu();Me(i,21,()=>s,vt,(o,c)=>{var l=du();let u;var h=d(l);h.__change=()=>n(r(c).value);var m=v(h,2),y=d(m),_=v(m,2),q=d(_);H(()=>{u=Re(l,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===r(c).value}),Vs(l,`--status-color: ${r(c).color??""}`),Ki(h,r(c).value),la(h,t()===r(c).value),L(y,r(c).icon),L(q,r(c).label)}),k(o,l)}),k(a,i),He()}$e(["change"]);var hu=A('<div class="recurrence-input__valid svelte-787fjp">‚úì Valid recurrence pattern</div>'),fu=A('<div class="recurrence-input__error svelte-787fjp"> </div>'),_u=A('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),pu=A('<li class="svelte-787fjp"> </li>'),gu=A('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),mu=A('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function yu(a,e){Ue(e,!0);let t=vs(e,"value",15,""),s=vs(e,"showPreview",3,!0);const n=Q(()=>Fn.parse(t())),i=Q(()=>r(n).isValid),o=Q(()=>r(n).error);function c(w,x=3){const T=[],C=new Date;for(let P=0;P<x;P++){const K=new Date(C);switch(w.type){case"daily":K.setDate(C.getDate()+P*w.interval);break;case"weekly":K.setDate(C.getDate()+P*w.interval*7);break;case"monthly":K.setMonth(C.getMonth()+P*w.interval);break;case"yearly":K.setFullYear(C.getFullYear()+P*w.interval);break}T.push(K.toLocaleDateString())}return T}const l=Q(()=>r(i)&&s()?c(r(n).frequency):[]);function u(w){const T=w.target.value;t(T);const C=Fn.parse(T);e.onchange(T,C.isValid?C.frequency:null,C.isValid)}var h=mu(),m=d(h);let y;m.__input=u;var _=v(m,2);{var q=w=>{var x=_u(),T=d(x);{var C=K=>{var M=hu();k(K,M)},P=K=>{var M=fu(),N=d(M);H(()=>L(N,`‚ö† ${(r(o)||"Invalid recurrence pattern")??""}`)),k(K,M)};G(T,K=>{r(i)?K(C):K(P,!1)})}k(w,x)};G(_,w=>{t().length>0&&w(q)})}var g=v(_,2);{var p=w=>{var x=gu(),T=v(d(x),2);Me(T,21,()=>r(l),vt,(C,P)=>{var K=pu(),M=d(K);H(()=>L(M,r(P))),k(C,K)}),k(w,x)};G(g,w=>{r(i)&&s()&&r(l).length>0&&w(p)})}H(()=>{y=Re(m,1,"recurrence-input__field svelte-787fjp",null,y,{valid:r(i),invalid:!r(i)&&t().length>0}),De(m,"aria-invalid",!r(i)&&t().length>0)}),We(m,t),k(a,h),He()}$e(["input"]);var ku=A('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">‚úï</button></div>'),bu=A('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),wu=A('<span class="dependency-picker__option-check svelte-10ls0lk">‚úì</span>'),Tu=A('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Su=A('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),Du=A('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function Br(a,e){Ue(e,!0);let t=vs(e,"selected",31,()=>ye([])),s=vs(e,"label",3,"Select tasks"),n=W(""),i=W(!1);const o=Q(()=>e.repository.getAllTasks().filter(K=>K.id!==e.excludeId)),c=Q(()=>r(n).trim()?r(o).filter(K=>K.name.toLowerCase().includes(r(n).toLowerCase())):r(o)),l=Q(()=>r(o).filter(K=>t().includes(K.id)));function u(K){if(!t().includes(K)){const M=[...t(),K];t(M),e.onchange(M)}f(n,""),f(i,!1)}function h(K){const M=t().filter(N=>N!==K);t(M),e.onchange(M)}function m(){f(i,!0)}function y(){setTimeout(()=>{f(i,!1)},200)}var _=Du(),q=d(_),g=d(q),p=v(q,2);{var w=K=>{var M=bu();Me(M,21,()=>r(l),N=>N.id,(N,z)=>{var Y=ku(),J=d(Y),te=d(J),ie=v(J,2);ie.__click=()=>h(r(z).id),H(()=>{L(te,r(z).name),De(ie,"aria-label",`Remove ${r(z).name??""}`)}),k(N,Y)}),k(K,M)};G(p,K=>{r(l).length>0&&K(w)})}var x=v(p,2),T=d(x),C=v(T,2);{var P=K=>{var M=Su();Me(M,21,()=>r(c).slice(0,10),N=>N.id,(N,z)=>{var Y=Tu();let J;Y.__click=()=>u(r(z).id);var te=d(Y),ie=d(te),he=v(te,2);{var le=j=>{var E=wu();k(j,E)};G(he,j=>{t().includes(r(z).id)&&j(le)})}H((j,E)=>{J=Re(Y,1,"dependency-picker__option svelte-10ls0lk",null,J,j),Y.disabled=E,L(ie,r(z).name)},[()=>({selected:t().includes(r(z).id)}),()=>t().includes(r(z).id)]),k(N,Y)}),k(K,M)};G(C,K=>{r(i)&&r(c).length>0&&K(P)})}H(()=>L(g,s())),ot("focus",T,m),ot("blur",T,y),We(T,()=>r(n),K=>f(n,K)),k(a,_),He()}$e(["click"]);var Eu=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Au=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),xu=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Cu=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Iu=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),qu=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Ou=A('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">‚úï</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">üí° Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">‚åò/Ctrl+Enter</kbd> to save</div></div></div>');function Zi(a,e){var je,Fe,st,at,_t,Ut,pt,Ot,gt,Ht,gs,At;Ue(e,!0);const t="every day",s="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",i=!e.task;let o=W(ye(((je=e.task)==null?void 0:je.name)||"")),c=W(ye(((Fe=e.task)==null?void 0:Fe.description)||"")),l=W(ye(((st=e.task)==null?void 0:st.priority)||"normal")),u=W(ye(((at=e.task)==null?void 0:at.status)||"todo")),h=W(ye((_t=e.task)!=null&&_t.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),m=W(ye((Ut=e.task)!=null&&Ut.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),y=W(ye((pt=e.task)!=null&&pt.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),_=W(ye(((Ot=e.task)==null?void 0:Ot.recurrenceText)||((gt=e.task)!=null&&gt.frequency?Fn.stringify(e.task.frequency):t))),q=W(ye(((Ht=e.task)==null?void 0:Ht.frequency)||null)),g=W(!0),p=W(ye(((gs=e.task)==null?void 0:gs.blockedBy)||[])),w=W(ye(((At=e.task)==null?void 0:At.dependsOn)||[])),x=W(ye({name:!1,dueAt:!1,recurrence:!1})),T=W(!1),C=W(null);const P=Q(()=>r(x).name&&!r(o).trim()?"Task name is required":""),K=Q(()=>r(x).dueAt?r(h)?Number.isNaN(new Date(r(h)).getTime())?"Invalid due date":"":"Due date is required":""),M=Q(()=>r(x).recurrence&&!r(g)?"Invalid recurrence pattern":""),N=Q(()=>!!(r(P)||r(K)||r(M)));cn(()=>{requestAnimationFrame(()=>{var F;(F=r(C))==null||F.focus()})});function z(F,fe,Ve){f(_,F,!0),f(q,fe,!0),f(g,Ve,!0),r(x).recurrence=!0}function Y(F){f(l,F,!0)}function J(F){f(u,F,!0)}function te(F){f(p,F,!0)}function ie(F){f(w,F,!0)}async function he(){if(f(x,{name:!0,dueAt:!0,recurrence:!0},!0),r(N)){X.warning("Please fix validation errors");return}if(!r(q)){X.error("Invalid recurrence pattern");return}f(T,!0);try{let F;i?F=Gi(r(o).trim(),r(q),new Date(r(h))):(F={...e.task},F.name=r(o).trim(),F.frequency=r(q),F.dueAt=new Date(r(h)).toISOString()),F.description=r(c).trim()||void 0,F.priority=r(l),F.status=r(u),F.recurrenceText=r(_),F.scheduledAt=r(m)?new Date(r(m)).toISOString():void 0,F.startAt=r(y)?new Date(r(y)).toISOString():void 0,F.blockedBy=r(p).length>0?r(p):void 0,F.dependsOn=r(w).length>0?r(w):void 0,F.updatedAt=new Date().toISOString(),r(u)==="done"&&!F.lastCompletedAt&&(F.lastCompletedAt=new Date().toISOString()),r(u)==="cancelled"&&!F.cancelledAt&&(F.cancelledAt=new Date().toISOString()),await e.repository.saveTask(F),e.onSave&&e.onSave(F),X.success(`Task "${F.name}" ${i?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(F){X.error(`Failed to save task: ${F}`)}finally{f(T,!1)}}function le(F){F.key==="Escape"&&e.onClose(),(F.metaKey||F.ctrlKey)&&F.key==="Enter"&&(F.preventDefault(),he())}function j(F){return F?new Date(F).toLocaleString():"‚Äî"}var E=Ou();E.__keydown=le;var B=d(E),Z=d(B),ee=d(Z),ce=d(ee),de=v(ee,2);de.__click=function(...F){var fe;(fe=e.onClose)==null||fe.apply(this,F)};var _e=v(Z,2),se=d(_e),ve=v(d(se),2);ve.__input=()=>r(x).name=!0,Wt(ve,F=>f(C,F),()=>r(C));var U=v(ve,2);{var V=F=>{var fe=Eu(),Ve=d(fe);H(()=>L(Ve,r(P))),k(F,fe)};G(U,F=>{r(P)&&F(V)})}var re=v(se,2),b=v(d(re),2),R=v(re,2),$=v(d(R),2);cu($,{get value(){return r(l)},onchange:Y});var ne=v(R,2),S=v(d(ne),2);vu(S,{get value(){return r(u)},onchange:J});var O=v(ne,2),oe=v(d(O),2);oe.__input=()=>r(x).dueAt=!0;var be=v(oe,2);{var xe=F=>{var fe=Au(),Ve=d(fe);H(()=>L(Ve,r(K))),k(F,fe)};G(be,F=>{r(K)&&F(xe)})}var ke=v(O,2),Ne=v(d(ke),2),Be=v(ke,2),ft=v(d(Be),2),qt=v(Be,2),Je=v(d(qt),2);yu(Je,{get value(){return r(_)},onchange:z,showPreview:!0});var Qt=v(Je,2);{var Ze=F=>{var fe=xu(),Ve=d(fe);H(()=>L(Ve,r(M))),k(F,fe)};G(Qt,F=>{r(M)&&F(Ze)})}var Oe=v(qt,2),Dt=d(Oe);{let F=Q(()=>{var fe;return(fe=e.task)==null?void 0:fe.id});Br(Dt,{get repository(){return e.repository},get selected(){return r(p)},get excludeId(){return r(F)},onchange:te,label:s})}var ze=v(Oe,2),et=d(ze);{let F=Q(()=>{var fe;return(fe=e.task)==null?void 0:fe.id});Br(et,{get repository(){return e.repository},get selected(){return r(w)},get excludeId(){return r(F)},onchange:ie,label:n})}var ns=v(ze,2),Xt=d(ns),Lt=v(d(Xt),2),jt=d(Lt),ae=v(Xt,2);{var pe=F=>{var fe=Cu(),Ve=v(d(fe),2),Cs=d(Ve);H(wa=>L(Cs,wa),[()=>j(e.task.lastCompletedAt)]),k(F,fe)};G(ae,F=>{var fe;(fe=e.task)!=null&&fe.lastCompletedAt&&F(pe)})}var Ae=v(ae,2);{var Le=F=>{var fe=Iu(),Ve=v(d(fe),2),Cs=d(Ve);H(wa=>L(Cs,wa),[()=>j(e.task.cancelledAt)]),k(F,fe)};G(Ae,F=>{var fe;(fe=e.task)!=null&&fe.cancelledAt&&F(Le)})}var dt=v(Ae,2);{var tt=F=>{var fe=qu(),Ve=v(d(fe),2),Cs=d(Ve);H(()=>L(Cs,e.task.linkedBlockId)),k(F,fe)};G(dt,F=>{var fe;(fe=e.task)!=null&&fe.linkedBlockId&&F(tt)})}var Kt=v(_e,2),Et=d(Kt);Et.__click=function(...F){var fe;(fe=e.onClose)==null||fe.apply(this,F)};var ge=v(Et,2);ge.__click=he;var Ie=d(ge);H(F=>{L(ce,i?"Create Task":"Edit Task"),De(ve,"aria-invalid",!!r(P)),De(oe,"aria-invalid",!!r(K)),L(jt,F),ge.disabled=r(T),L(Ie,r(T)?"Saving...":i?"Create Task":"Save Changes")},[()=>{var F;return j((F=e.task)==null?void 0:F.createdAt)}]),ot("blur",ve,()=>r(x).name=!0),We(ve,()=>r(o),F=>f(o,F)),We(b,()=>r(c),F=>f(c,F)),ot("blur",oe,()=>r(x).dueAt=!0),We(oe,()=>r(h),F=>f(h,F)),We(Ne,()=>r(m),F=>f(m,F)),We(ft,()=>r(y),F=>f(y,F)),k(a,E),He()}$e(["keydown","click","input"]);const Mu=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];class Nu{constructor(e){D(this,"config");this.config=e}evaluate(e,t){if(!this.config.enabled||this.config.mode==="all")return!0;const s=this.config.rules.filter(o=>o.enabled);if(s.length===0)return!0;const i=s.map(o=>this.evaluateRule(o,e,t)).some(o=>o);return this.config.mode==="include"?i:!i}updateConfig(e){this.config=e}getConfig(){return this.config}evaluateRule(e,t,s){switch(e.type){case"tag":const n=this.extractTags(t),i=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${i}$`);return n.some(c=>o.test(c));case"regex":try{return new RegExp(e.pattern).test(t)}catch{return!1}case"path":return s?s.includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}extractTags(e){return e.match(/#[\w/-]+/g)||[]}}function Ru(a){if(!a.pattern||a.pattern.trim().length===0)return{valid:!1,error:"Pattern cannot be empty"};switch(a.type){case"regex":try{return new RegExp(a.pattern),{valid:!0}}catch(e){return{valid:!1,error:`Invalid regex pattern: ${e instanceof Error?e.message:String(e)}`}}case"tag":return a.pattern.startsWith("#")?{valid:!0}:{valid:!1,error:"Tag pattern should start with #"};case"path":case"marker":return{valid:!0};default:return{valid:!1,error:`Unknown rule type: ${a.type}`}}}function Bu(a,e,t){return{id:typeof crypto<"u"&&crypto.randomUUID?`rule_${crypto.randomUUID()}`:`rule_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,type:a,pattern:e,enabled:!0,description:t}}const Fr={enabled:!1,mode:"all",rules:[]},Ms=class Ms{constructor(){D(this,"engine");this.engine=new Nu(Fr)}static getInstance(){return Ms.instance||(Ms.instance=new Ms),Ms.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(Fr)}};D(Ms,"instance",null);let Pn=Ms;var Fu=A('<p class="empty-state svelte-b8rwae">No filter rules configured</p>'),Pu=A('<span class="rule-description svelte-b8rwae"> </span>'),zu=A('<div class="rule-item svelte-b8rwae"><input type="checkbox" class="rule-checkbox svelte-b8rwae"/> <div class="rule-info svelte-b8rwae"><span class="rule-type svelte-b8rwae"> </span> <code class="rule-pattern svelte-b8rwae"> </code> <!></div> <button class="delete-btn svelte-b8rwae">Delete</button></div>'),Lu=A('<div class="rules-list svelte-b8rwae"></div>'),ju=A('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Task Filter</h3> <p class="description svelte-b8rwae">Control which checkboxes are treated as tasks</p> <div class="form-field svelte-b8rwae"><label class="settings__toggle svelte-b8rwae"><input type="checkbox" class="svelte-b8rwae"/> <span>Enable Global Filter</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Filter Mode</label> <select class="settings__input svelte-b8rwae"><option>All checkboxes are tasks (default)</option><option>Only checkboxes matching rules</option><option>All except checkboxes matching rules</option></select> <p class="hint svelte-b8rwae"><!></p></div> <div class="rules-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Filter Rules</h4> <!></div> <div class="add-rule-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Add Rule</h4> <div class="add-rule-form svelte-b8rwae"><select class="settings__input svelte-b8rwae"><option>Tag (e.g., #task)</option><option>Regex pattern</option><option>Document path (e.g., daily/)</option><option>Text marker (e.g., TODO:)</option></select> <input type="text" placeholder="Pattern" class="settings__input svelte-b8rwae"/> <input type="text" placeholder="Description (optional)" class="settings__input svelte-b8rwae"/> <button class="add-btn svelte-b8rwae">Add Rule</button></div></div> <div class="examples svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Examples</h4> <ul class="svelte-b8rwae"><li class="svelte-b8rwae"><strong>Tag:</strong> <code class="svelte-b8rwae">#task</code> - Only checkboxes with #task tag</li> <li class="svelte-b8rwae"><strong>Tag wildcard:</strong> <code class="svelte-b8rwae">#work/*</code> - Any #work subtag</li> <li class="svelte-b8rwae"><strong>Path:</strong> <code class="svelte-b8rwae">projects/</code> - Only in projects folder</li> <li class="svelte-b8rwae"><strong>Regex:</strong> <code class="svelte-b8rwae">TODO:|TASK:</code> - Checkboxes with TODO: or TASK:</li> <li class="svelte-b8rwae"><strong>Marker:</strong> <code class="svelte-b8rwae">@action</code> - Checkboxes with @action marker</li></ul></div></div>');function Ku(a,e){Ue(e,!0);let t=Pn.getInstance(),s=ye(t.getConfig()),n=W("tag"),i=W(""),o=W("");function c(){if(!r(i).trim()){X.error("Pattern cannot be empty");return}const se=Bu(r(n),r(i).trim(),r(o).trim()),ve=Ru(se);if(!ve.valid){X.error(ve.error||"Invalid rule");return}s.rules.push(se),h(),f(i,""),f(o,""),X.success("Filter rule added")}function l(se){s.rules=s.rules.filter(ve=>ve.id!==se),h(),X.success("Filter rule deleted")}function u(se){const ve=s.rules.find(U=>U.id===se);ve&&(ve.enabled=!ve.enabled,h())}function h(){t.updateConfig(s)}function m(){h()}function y(){h()}var _=ju(),q=v(d(_),4),g=d(q),p=d(g);p.__change=y;var w=v(q,2),x=v(d(w),2);x.__change=m;var T=d(x);T.value=T.__value="all";var C=v(T);C.value=C.__value="include";var P=v(C);P.value=P.__value="exclude";var K=v(x,2),M=d(K);{var N=se=>{var ve=oa("All checkboxes will be treated as tasks (no filtering)");k(se,ve)},z=se=>{var ve=Pe(),U=qe(ve);{var V=b=>{var R=oa("Only checkboxes matching at least one rule will be treated as tasks");k(b,R)},re=b=>{var R=Pe(),$=qe(R);{var ne=S=>{var O=oa("Checkboxes matching any rule will be ignored");k(S,O)};G($,S=>{s.mode==="exclude"&&S(ne)},!0)}k(b,R)};G(U,b=>{s.mode==="include"?b(V):b(re,!1)},!0)}k(se,ve)};G(M,se=>{s.mode==="all"?se(N):se(z,!1)})}var Y=v(w,2),J=v(d(Y),2);{var te=se=>{var ve=Fu();k(se,ve)},ie=se=>{var ve=Lu();Me(ve,21,()=>s.rules,vt,(U,V)=>{var re=zu(),b=d(re);b.__change=()=>u(r(V).id);var R=v(b,2),$=d(R),ne=d($),S=v($,2),O=d(S),oe=v(S,2);{var be=ke=>{var Ne=Pu(),Be=d(Ne);H(()=>L(Be,r(V).description)),k(ke,Ne)};G(oe,ke=>{r(V).description&&ke(be)})}var xe=v(R,2);xe.__click=()=>l(r(V).id),H(()=>{la(b,r(V).enabled),L(ne,r(V).type),L(O,r(V).pattern)}),k(U,re)}),k(se,ve)};G(J,se=>{s.rules.length===0?se(te):se(ie,!1)})}var he=v(Y,2),le=v(d(he),2),j=d(le),E=d(j);E.value=E.__value="tag";var B=v(E);B.value=B.__value="regex";var Z=v(B);Z.value=Z.__value="path";var ee=v(Z);ee.value=ee.__value="marker";var ce=v(j,2),de=v(ce,2),_e=v(de,2);_e.__click=c,Ui(p,()=>s.enabled,se=>s.enabled=se),Mn(x,()=>s.mode,se=>s.mode=se),Mn(j,()=>r(n),se=>f(n,se)),We(ce,()=>r(i),se=>f(i,se)),We(de,()=>r(o),se=>f(o,se)),k(a,_),He()}$e(["change","click"]);var Uu=A('<button class="delete-btn svelte-1qw3eru">Delete</button>'),Hu=A('<span class="default-badge svelte-1qw3eru">Default</span>'),Gu=A('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),Yu=A('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function Vu(a,e){Ue(e,!0);let t=as.getInstance(),s=W(ye([])),n=W(""),i=W(""),o=W(ye(Ge.TODO)),c=W("x");function l(){f(s,t.getAll(),!0)}function u(){if(!r(n).trim()||!r(i).trim()){X.error("Symbol and name are required");return}if(r(n).length!==1){X.error("Symbol must be a single character");return}const V={symbol:r(n),name:r(i),type:r(o),nextStatusSymbol:r(c)},re=new rs(V);t.register(re),l(),y(),X.success(`Status "${r(i)}" added`)}function h(V){if([" ","x","/","-"].includes(V)){X.error("Cannot delete default status");return}t.unregister(V),l(),X.success("Status deleted")}function m(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),l(),X.success("Statuses reset to defaults"))}function y(){f(n,""),f(i,""),f(o,Ge.TODO,!0),f(c,"x")}ut(()=>{l()});var _=Yu(),q=v(d(_),4),g=d(q),p=d(g),w=v(d(p));Me(w,21,()=>r(s),vt,(V,re)=>{var b=Gu(),R=d(b),$=d(R),ne=d($),S=v(R),O=d(S),oe=v(S),be=d(oe),xe=d(be),ke=v(oe),Ne=d(ke),Be=d(Ne),ft=v(ke),qt=d(ft),Je=d(qt),Qt=v(ft),Ze=d(Qt);{var Oe=ze=>{var et=Uu();et.__click=()=>h(r(re).symbol),k(ze,et)},Dt=ze=>{var et=Hu();k(ze,et)};G(Ze,ze=>{[" ","x","/","-"].includes(r(re).symbol)?ze(Dt,!1):ze(Oe)})}H(()=>{L(ne,`[${r(re).symbol??""}]`),L(O,r(re).name),L(xe,r(re).type),L(Be,`[${r(re).nextStatusSymbol??""}]`),L(Je,`- [${r(re).symbol??""}] Task example`)}),k(V,b)});var x=v(q,2),T=v(d(x),2),C=d(T),P=d(C),K=v(d(P),2),M=v(P,2),N=v(d(M),2),z=v(M,2),Y=v(d(z),2),J=d(Y),te={},ie=v(J),he={},le=v(ie),j={},E=v(le),B={},Z=v(E),ee={},ce=v(z,2),de=v(d(ce),2),_e=v(ce,2),se=v(d(_e),2);se.__click=u;var ve=v(x,2),U=d(ve);U.__click=m,H(()=>{te!==(te=Ge.TODO)&&(J.value=(J.__value=Ge.TODO)??""),he!==(he=Ge.IN_PROGRESS)&&(ie.value=(ie.__value=Ge.IN_PROGRESS)??""),j!==(j=Ge.DONE)&&(le.value=(le.__value=Ge.DONE)??""),B!==(B=Ge.CANCELLED)&&(E.value=(E.__value=Ge.CANCELLED)??""),ee!==(ee=Ge.NON_TASK)&&(Z.value=(Z.__value=Ge.NON_TASK)??"")}),We(K,()=>r(n),V=>f(n,V)),We(N,()=>r(i),V=>f(i,V)),Mn(Y,()=>r(o),V=>f(o,V)),We(de,()=>r(c),V=>f(c,V)),k(a,_),He()}$e(["click"]);var Wu=A('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),Qu=A("<div> </div>"),Xu=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),$u=A('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Ju=A('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),Zu=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section>'),ev=A('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),tv=A('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filter</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function sv(a,e){Ue(e,!0);let t=W(ye(Nn)),s=W(null),n=ye({}),i=W("general");ut(()=>{f(t,e.eventService.getConfig(),!0)});async function o(){try{await e.eventService.saveConfig(r(t)),X.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(N){X.error("Failed to save settings: "+N)}}async function c(){f(s,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const N=await e.eventService.testConnection();n.n8n={success:N.success,message:N.success?"Test successful!":N.message||"Test failed. Check configuration."}}catch(N){n.n8n={success:!1,message:"Error: "+(N instanceof Error?N.message:String(N))}}finally{f(s,null)}}var l=tv(),u=d(l),h=v(d(u),2);{var m=N=>{var z=Wu();z.__click=function(...Y){var J;(J=e.onClose)==null||J.apply(this,Y)},k(N,z)};G(h,N=>{e.onClose&&N(m)})}var y=v(u,2),_=d(y),q=d(_);q.__click=()=>f(i,"general");var g=v(q,2);g.__click=()=>f(i,"filter");var p=v(g,2);p.__click=()=>f(i,"statuses");var w=v(p,2);w.__click=()=>f(i,"shortcuts");var x=v(_,2),T=d(x);{var C=N=>{var z=Xu(),Y=d(z),J=v(d(Y),2),te=d(J),ie=v(Y,2),he=v(d(ie),2),le=v(ie,2),j=v(d(le),2),E=v(le,2);E.__click=c;var B=d(E),Z=v(E,2);{var ee=ce=>{var de=Qu(),_e=d(de);H(()=>{Re(de,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),L(_e,n.n8n.message)}),k(ce,de)};G(Z,ce=>{n.n8n&&ce(ee)})}H(()=>{he.disabled=!r(t).n8n.enabled,j.disabled=!r(t).n8n.enabled,E.disabled=!r(t).n8n.enabled||r(s)==="n8n",L(B,r(s)==="n8n"?"Testing...":"Test Connection")}),Ui(te,()=>r(t).n8n.enabled,ce=>r(t).n8n.enabled=ce),We(he,()=>r(t).n8n.webhookUrl,ce=>r(t).n8n.webhookUrl=ce),We(j,()=>r(t).n8n.sharedSecret,ce=>r(t).n8n.sharedSecret=ce),k(N,z)},P=N=>{var z=Pe(),Y=qe(z);{var J=ie=>{Ku(ie,{})},te=ie=>{var he=Pe(),le=qe(he);{var j=B=>{Vu(B,{})},E=B=>{var Z=Pe(),ee=qe(Z);{var ce=de=>{var _e=Zu(),se=v(d(_e),2);Me(se,21,()=>Mu,vt,(ve,U)=>{var V=Ju(),re=d(V),b=d(re),R=d(b),$=v(b,2),ne=d($),S=v($,2);{var O=xe=>{var ke=$u(),Ne=d(ke);H(()=>L(Ne,r(U).context)),k(xe,ke)};G(S,xe=>{r(U).context&&xe(O)})}var oe=v(re,2),be=d(oe);H(()=>{L(R,r(U).label),L(ne,r(U).description),L(be,r(U).keys)}),k(ve,V)}),k(de,_e)};G(ee,de=>{r(i)==="shortcuts"&&de(ce)},!0)}k(B,Z)};G(le,B=>{r(i)==="statuses"?B(j):B(E,!1)},!0)}k(ie,he)};G(Y,ie=>{r(i)==="filter"?ie(J):ie(te,!1)},!0)}k(N,z)};G(T,N=>{r(i)==="general"?N(C):N(P,!1)})}var K=v(y,2);{var M=N=>{var z=ev(),Y=d(z);Y.__click=o,k(N,z)};G(K,N=>{r(i)==="general"&&N(M)})}H(()=>{Re(q,1,`settings__nav-btn ${r(i)==="general"?"active":""}`,"svelte-1ke3hir"),Re(g,1,`settings__nav-btn ${r(i)==="filter"?"active":""}`,"svelte-1ke3hir"),Re(p,1,`settings__nav-btn ${r(i)==="statuses"?"active":""}`,"svelte-1ke3hir"),Re(w,1,`settings__nav-btn ${r(i)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),k(a,l),He()}$e(["click"]);var av=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),nv=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),rv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),iv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ov=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),lv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),cv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),dv=A('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>High Priority</button></div>'),uv=A('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">üì• Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">üìã Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">üìÖ Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">‚úÖ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">üìÅ Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">üîç Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">üìù All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),vv=A('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div></div> <!></div>');function hv(a,e){Ue(e,!0);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let n=W("today"),i=W(!1),o=W(!1),c=W(void 0),l=W(ye(new Set)),u=W(ye([])),h=Q(()=>Zl(r(u))),m=W(!1);const y=Q(()=>["inbox","today","upcoming","done","projects","search","all"].includes(r(n))?`dashboard-tab-${r(n)}`:void 0),_=Q(()=>()=>{let b=r(u);if(r(l).has("notDone")&&(b=b.filter(R=>R.status!=="done"&&R.status!=="cancelled")),r(l).has("dueToday")){const R=new Date;R.setHours(0,0,0,0);const $=new Date(R);$.setDate($.getDate()+1),b=b.filter(ne=>{if(!ne.dueAt)return!1;const S=new Date(ne.dueAt);return S>=R&&S<$})}if(r(l).has("overdue")){const R=new Date;R.setHours(0,0,0,0),b=b.filter($=>!$.dueAt||$.status==="done"||$.status==="cancelled"?!1:new Date($.dueAt)<R)}return r(l).has("inProgress")&&(b=b.filter(R=>R.status==="todo"&&R.statusSymbol&&R.statusSymbol!==" ")),r(l).has("blocked")&&(b=b.filter(R=>R.blockedBy&&R.blockedBy.length>0)),r(l).has("highPriority")&&(b=b.filter(R=>R.priority==="high"||R.priority==="urgent")),b}),q=Q(()=>r(u).filter(b=>b.status!=="done"&&b.status!=="cancelled"&&!b.dueAt&&!b.scheduledAt&&!b.startAt).length),g=Q(()=>()=>{const b=new Date;b.setHours(0,0,0,0);const R=new Date(b);return R.setDate(R.getDate()+7),r(u).filter($=>{if($.status==="done"||$.status==="cancelled"||!$.dueAt)return!1;const ne=new Date($.dueAt);return ne.setHours(0,0,0,0),ne>b&&ne<=R}).length}),p=Q(()=>()=>{const b=new Date;return b.setDate(b.getDate()-30),b.setHours(0,0,0,0),r(u).filter(R=>R.status!=="done"||!R.doneAt?!1:new Date(R.doneAt)>=b).length}),w=Q(()=>r(u).filter(b=>b.status!=="done"&&b.status!=="cancelled").length);function x(b="initial"){f(m,!0),f(u,e.repository.getAllTasks().map(R=>({...R})),!0),f(m,!1),b!=="initial"&&X.info("Task list reloaded")}x();const T=()=>x("reload");cn(()=>{window.addEventListener("recurring-task-refresh",T)}),jl(()=>{window.removeEventListener("recurring-task-refresh",T)});async function C(b){Ke.emit("task: complete",{taskId:b.id})}async function P(b){const R=r(u),$=kn(r(u),b.id,ne=>{const S={...ne},O=new Date(S.dueAt),oe=t.tomorrow();return oe.setHours(O.getHours(),O.getMinutes(),0,0),S.dueAt=oe.toISOString(),S.snoozeCount=(S.snoozeCount||0)+1,S.updatedAt=new Date().toISOString(),S});f(u,$,!0),X.info(`Task "${b.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",b),await e.scheduler.delayToTomorrow(b.id)}catch(ne){f(u,R,!0),X.error("Failed to delay task:  "+ne),x("external")}}async function K(b){var $;if(!(($=b.name)!=null&&$.trim())){X.error("Task name is required");return}if(!Hi(b.frequency)){X.error("Invalid frequency configuration");return}const R={...b};f(u,yn(r(u),R),!0),f(i,!1),f(c,void 0),X.success(`Task "${b.name}" saved successfully`),e.repository.saveTask(R).catch(ne=>{X.error("Failed to save task: "+ne),x("external")})}async function M(b){const R=r(u);f(u,Mr(r(u),b.id),!0);const $=window.setTimeout(async()=>{try{await e.repository.deleteTask(b.id)}catch(ne){f(u,R,!0),X.error("Failed to delete task: "+ne),x("external")}},5e3);Bs({message:`Task "${b.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout($),f(u,R,!0),X.info(`Restored "${b.name}"`)},showCountdown:!0})}async function N(b){const R=b.name.endsWith(" (copy)")?`${b.name} ${new Date().toLocaleDateString()}`:`${b.name} (copy)`,$=Vi(b,{name:R});f(u,yn(r(u),$),!0),X.success(`Duplicated "${b.name}"`),e.repository.saveTask($).catch(ne=>{f(u,Mr(r(u),$.id),!0),X.error("Failed to duplicate task: "+ne),x("external")})}async function z(b){const R=!b.enabled,$={...b,enabled:R},ne=kn(r(u),b.id,()=>$);f(u,ne,!0),X.info(`Task ${R?"enabled":"disabled"}`),e.repository.saveTask($).catch(S=>{X.error("Failed to update task: "+S),x("external")})}async function Y(b,R){if(b.length===0)return;const $=r(u),ne=new Set(b),S=r(u).map(O=>ne.has(O.id)?{...O,enabled:R}:O);f(u,S,!0),X.info(`${R?"Enabled":"Disabled"} ${b.length} task${b.length===1?"":"s"}`);try{const O=S.filter(oe=>ne.has(oe.id));await Promise.all(O.map(oe=>e.repository.saveTask(oe)))}catch(O){f(u,$,!0),X.error(`Failed to ${R?"enable":"disable"} tasks: ${O}`),x("external")}}async function J(b){if(b.length===0)return;const R=r(u),$=new Set(b),ne=r(u).filter(O=>$.has(O.id));f(u,r(u).filter(O=>!$.has(O.id)),!0);const S=window.setTimeout(async()=>{try{await Promise.all(ne.map(O=>e.repository.deleteTask(O.id)))}catch(O){f(u,R,!0),X.error("Failed to delete tasks: "+O),x("external")}},5e3);Bs({message:`${ne.length} task${ne.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(S),f(u,R,!0),X.info("Bulk delete undone")},showCountdown:!0})}function te(b){f(c,b,!0),f(i,!0)}function ie(){f(c,void 0),f(i,!0)}function he(){f(i,!1),f(c,void 0)}function le(){f(o,!0)}function j(){f(o,!1)}async function E(b){const R=r(u),$=kn(r(u),b.id,ne=>{const S={...ne};Wi(S);const O=s.calculateNext(new Date(S.dueAt),S.frequency);return S.dueAt=O.toISOString(),S});f(u,$,!0),X.info(`Task "${b.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",b),await e.scheduler.skipTaskOccurrence(b.id)}catch(ne){f(u,R,!0),X.error("Failed to skip task: "+ne),x("external")}}function B(b){const R=new Set(r(l));R.has(b)?R.delete(b):R.add(b),f(l,R,!0)}async function Z(b){const R={...b,status:"todo",doneAt:void 0};f(u,yn(r(u),R),!0),X.success(`Task "${b.name}" marked as not done`),e.repository.saveTask(R).catch($=>{X.error("Failed to update task: "+$),x("external")})}var ee=vv(),ce=d(ee),de=v(d(ce),2),_e=d(de);_e.__click=()=>x("reload");var se=d(_e),ve=v(_e,2);ve.__click=le;var U=v(ce,2);{var V=b=>{var R=av(),$=d(R);sv($,{get eventService(){return e.eventService},onClose:j}),k(b,R)},re=b=>{var R=Pe(),$=qe(R);{var ne=O=>{var oe=nv(),be=d(oe);Zi(be,{get task(){return r(c)},get repository(){return e.repository},onSave:K,onClose:he}),k(O,oe)},S=O=>{var oe=uv(),be=qe(oe),xe=d(be);xe.__click=()=>f(n,"inbox");var ke=v(d(xe));{var Ne=ge=>{var Ie=rv(),je=d(Ie);H(()=>L(je,r(q))),k(ge,Ie)};G(ke,ge=>{r(q)>0&&ge(Ne)})}var Be=v(xe,2);Be.__click=()=>f(n,"today");var ft=v(d(Be));{var qt=ge=>{var Ie=iv(),je=d(Ie);H(()=>L(je,r(h).length)),k(ge,Ie)};G(ft,ge=>{r(h).length>0&&ge(qt)})}var Je=v(Be,2);Je.__click=()=>f(n,"upcoming");var Qt=v(d(Je));{var Ze=ge=>{var Ie=ov(),je=d(Ie);H(()=>L(je,r(g))),k(ge,Ie)};G(Qt,ge=>{r(g)>0&&ge(Ze)})}var Oe=v(Je,2);Oe.__click=()=>f(n,"done");var Dt=v(d(Oe));{var ze=ge=>{var Ie=lv(),je=d(Ie);H(()=>L(je,r(p))),k(ge,Ie)};G(Dt,ge=>{r(p)>0&&ge(ze)})}var et=v(Oe,2);et.__click=()=>f(n,"projects");var ns=v(d(et));{var Xt=ge=>{var Ie=cv(),je=d(Ie);H(()=>L(je,r(w))),k(ge,Ie)};G(ns,ge=>{r(w)>0&&ge(Xt)})}var Lt=v(et,2);Lt.__click=()=>f(n,"search");var jt=v(Lt,2);jt.__click=()=>f(n,"all");var ae=v(d(jt)),pe=d(ae),Ae=v(be,2);{var Le=ge=>{var Ie=dv(),je=v(d(Ie),2);je.__click=()=>B("notDone");var Fe=v(je,2);Fe.__click=()=>B("dueToday");var st=v(Fe,2);st.__click=()=>B("overdue");var at=v(st,2);at.__click=()=>B("inProgress");var _t=v(at,2);_t.__click=()=>B("blocked");var Ut=v(_t,2);Ut.__click=()=>B("highPriority"),H((pt,Ot,gt,Ht,gs,At)=>{Re(je,1,`dashboard__filter-btn ${pt??""}`,"svelte-1y1a8hs"),Re(Fe,1,`dashboard__filter-btn ${Ot??""}`,"svelte-1y1a8hs"),Re(st,1,`dashboard__filter-btn ${gt??""}`,"svelte-1y1a8hs"),Re(at,1,`dashboard__filter-btn ${Ht??""}`,"svelte-1y1a8hs"),Re(_t,1,`dashboard__filter-btn ${gs??""}`,"svelte-1y1a8hs"),Re(Ut,1,`dashboard__filter-btn ${At??""}`,"svelte-1y1a8hs")},[()=>r(l).has("notDone")?"active":"",()=>r(l).has("dueToday")?"active":"",()=>r(l).has("overdue")?"active":"",()=>r(l).has("inProgress")?"active":"",()=>r(l).has("blocked")?"active":"",()=>r(l).has("highPriority")?"active":""]),k(ge,Ie)};G(Ae,ge=>{r(n)!=="search"&&r(n)!=="timeline"&&r(n)!=="analytics"&&ge(Le)})}var dt=v(Ae,2),tt=d(dt);{var Kt=ge=>{{let Ie=Q(()=>r(l).size>0?r(_):r(u));nd(ge,{get tasks(){return r(Ie)},onEdit:te,onDone:C,onDelete:M})}},Et=ge=>{var Ie=Pe(),je=qe(Ie);{var Fe=at=>{{let _t=Q(()=>r(l).size>0?r(_).filter(Ut=>r(h).some(pt=>pt.id===Ut.id)):r(h));Dc(at,{get tasks(){return r(_t)},onDone:C,onDelay:P,onSkip:E,onEdit:te,get timezoneHandler(){return t}})}},st=at=>{var _t=Pe(),Ut=qe(_t);{var pt=gt=>{{let Ht=Q(()=>r(l).size>0?r(_):r(u));cd(gt,{get tasks(){return r(Ht)},onEdit:te,onDone:C,onDelete:M})}},Ot=gt=>{var Ht=Pe(),gs=qe(Ht);{var At=fe=>{{let Ve=Q(()=>r(l).size>0?r(_):r(u));pd(fe,{get tasks(){return r(Ve)},onEdit:te,onDelete:M,onUncomplete:Z})}},F=fe=>{var Ve=Pe(),Cs=qe(Ve);{var wa=Js=>{{let za=Q(()=>r(l).size>0?r(_):r(u));wd(Js,{get tasks(){return r(za)},onEdit:te,onDone:C,onDelete:M})}},so=Js=>{var za=Pe(),ao=qe(za);{var no=Zs=>{iu(Zs,{get tasks(){return r(u)},onEdit:te,onDone:C,onDelete:M})},ro=Zs=>{var sr=Pe(),io=qe(sr);{var oo=ea=>{{let La=Q(()=>r(l).size>0?r(_):r(u));Nc(ea,{get tasks(){return r(La)},onEdit:te,onDelete:M,onDuplicate:N,onToggleEnabled:z,onBulkEnable:Ta=>Y(Ta,!0),onBulkDisable:Ta=>Y(Ta,!1),onBulkDelete:J,onCreate:ie})}},lo=ea=>{var La=Pe(),Ta=qe(La);{var co=ta=>{Uc(ta,{get tasks(){return r(u)},get recurrenceEngine(){return s}})},uo=ta=>{var ar=Pe(),vo=qe(ar);{var ho=un=>{ed(un,{get tasks(){return r(u)}})};G(vo,un=>{r(n)==="analytics"&&un(ho)},!0)}k(ta,ar)};G(Ta,ta=>{r(n)==="timeline"?ta(co):ta(uo,!1)},!0)}k(ea,La)};G(io,ea=>{r(n)==="all"?ea(oo):ea(lo,!1)},!0)}k(Zs,sr)};G(ao,Zs=>{r(n)==="search"?Zs(no):Zs(ro,!1)},!0)}k(Js,za)};G(Cs,Js=>{r(n)==="projects"?Js(wa):Js(so,!1)},!0)}k(fe,Ve)};G(gs,fe=>{r(n)==="done"?fe(At):fe(F,!1)},!0)}k(gt,Ht)};G(Ut,gt=>{r(n)==="upcoming"?gt(pt):gt(Ot,!1)},!0)}k(at,_t)};G(je,at=>{r(n)==="today"?at(Fe):at(st,!1)},!0)}k(ge,Ie)};G(tt,ge=>{r(n)==="inbox"?ge(Kt):ge(Et,!1)})}H(()=>{Re(xe,1,`dashboard__tab ${r(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),De(xe,"aria-selected",r(n)==="inbox"),Re(Be,1,`dashboard__tab ${r(n)==="today"?"active":""}`,"svelte-1y1a8hs"),De(Be,"aria-selected",r(n)==="today"),Re(Je,1,`dashboard__tab ${r(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),De(Je,"aria-selected",r(n)==="upcoming"),Re(Oe,1,`dashboard__tab ${r(n)==="done"?"active":""}`,"svelte-1y1a8hs"),De(Oe,"aria-selected",r(n)==="done"),Re(et,1,`dashboard__tab ${r(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),De(et,"aria-selected",r(n)==="projects"),Re(Lt,1,`dashboard__tab ${r(n)==="search"?"active":""}`,"svelte-1y1a8hs"),De(Lt,"aria-selected",r(n)==="search"),Re(jt,1,`dashboard__tab ${r(n)==="all"?"active":""}`,"svelte-1y1a8hs"),De(jt,"aria-selected",r(n)==="all"),L(pe,r(u).length),De(dt,"aria-labelledby",r(y))}),k(O,oe)};G($,O=>{r(i)?O(ne):O(S,!1)},!0)}k(b,R)};G(U,b=>{r(o)?b(V):b(re,!1)})}H(()=>{_e.disabled=r(m),L(se,r(m)?"‚ü≥":"‚Üª")}),k(a,ee),He()}$e(["click"]);var fv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),_v=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),pv=A('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),gv=A('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),mv=A('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function yv(a,e){var j;Ue(e,!0);let t=W(ye(((j=e.prefill)==null?void 0:j.suggestedName)??"")),s=W(ye(new Date().toISOString().slice(0,16))),n=W(ye({name:!1,dueAt:!1})),i=W(!1),o=W(null);const c=Q(()=>r(n).name&&!r(t).trim()?"Task name is required.":""),l=Q(()=>r(n).dueAt?r(s)?Number.isNaN(new Date(r(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=Q(()=>!!(r(c)||r(l)));cn(()=>{var E;if((E=e.prefill)!=null&&E.suggestedTime){const B=new Date,[Z,ee]=e.prefill.suggestedTime.split(":").map(Number);B.setHours(Z,ee,0,0),f(s,B.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var B;(B=r(o))==null||B.focus()})});async function h(){var ee,ce;if(f(n,{name:!0,dueAt:!0},!0),r(u)){X.warning("Please fill out the required fields.");return}const E=Ul(),B=r(s).slice(11,16);if(E.time=B,!Hi(E)){X.error("Invalid frequency configuration.");return}const Z=Gi(r(t).trim(),E,new Date(r(s)));Z.linkedBlockId=((ee=e.prefill)==null?void 0:ee.linkedBlockId)||void 0,Z.linkedBlockContent=((ce=e.prefill)==null?void 0:ce.linkedBlockContent)||void 0,f(i,!0);try{await e.repository.saveTask(Z),X.success(`Task "${Z.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(de){X.error("Failed to create task: "+de)}finally{f(i,!1)}}function m(E){E.key==="Escape"&&e.onClose(),(E.metaKey||E.ctrlKey)&&E.key==="Enter"&&(E.preventDefault(),h())}var y=mv();y.__keydown=m;var _=d(y),q=d(_),g=v(d(q),2);g.__click=function(...E){var B;(B=e.onClose)==null||B.apply(this,E)};var p=v(q,2),w=v(d(p),2);w.__input=()=>r(n).name=!0,Wt(w,E=>f(o,E),()=>r(o));var x=v(w,2);{var T=E=>{var B=fv(),Z=d(B);H(()=>L(Z,r(c))),k(E,B)};G(x,E=>{r(c)&&E(T)})}var C=v(p,2),P=v(d(C),2);P.__input=()=>r(n).dueAt=!0;var K=v(P,2);{var M=E=>{var B=_v(),Z=d(B);H(()=>L(Z,r(l))),k(E,B)};G(K,E=>{r(l)&&E(M)})}var N=v(C,2);{var z=E=>{var B=pv(),Z=v(d(B)),ee=d(Z);H(()=>L(ee,e.prefill.linkedBlockId)),k(E,B)};G(N,E=>{var B;(B=e.prefill)!=null&&B.linkedBlockId&&E(z)})}var Y=v(N,2),J=d(Y);J.__click=function(...E){var B;(B=e.onClose)==null||B.apply(this,E)};var te=v(J,2);{var ie=E=>{var B=gv();B.__click=function(...Z){var ee;(ee=e.onAdvanced)==null||ee.apply(this,Z)},k(E,B)};G(te,E=>{e.onAdvanced&&E(ie)})}var he=v(te,2);he.__click=h;var le=d(he);H(()=>{De(w,"aria-invalid",!!r(c)),De(P,"aria-invalid",!!r(l)),he.disabled=r(i),L(le,r(i)?"Saving‚Ä¶":"Create Task")}),ot("blur",w,()=>r(n).name=!0),We(w,()=>r(t),E=>f(t,E)),ot("blur",P,()=>r(n).dueAt=!0),We(P,()=>r(s),E=>f(s,E)),k(a,y),He()}$e(["keydown","click","input"]);class kv{constructor(e){D(this,"plugin");this.plugin=e}getCurrentVersion(){return ys}async createBackup(e,t){try{const s=await this.plugin.loadData(e);if(s){const n=new Date().toISOString().replace(/[:.]/g,"-"),i=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${i}-${n}`;return await this.plugin.saveData(o,s),ue(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(s){throw me("Failed to create backup",s),s}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return ue("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:ys};const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0)return ue("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:ys};let n=!1,i,o,c=0;for(let l=0;l<s.length;l++){const u=s[l],h=u.version||0;h<ys&&(n||(o=h,i=await this.createBackup(e,h),n=!0),s[l]=this.migrateTask(u,h),c++,ue(`Migrated task ${u.id} from v${h} to v${ys}`))}if(n){const l=Array.isArray(t)?s:{...t,tasks:s};return await this.plugin.saveData(e,l),ue(`Migration complete: ${c} tasks migrated`),{migrated:!0,tasksAffected:c,fromVersion:o,toVersion:ys,backupKey:i}}else return ue("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:ys}}catch(t){throw me("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),t<4&&(s={...s,version:4,onCompletion:s.onCompletion||"keep",dependsOn:s.dependsOn||[],blockedBy:s.blockedBy||[]}),s}}class bv{constructor(e,t=50){D(this,"pendingState",null);D(this,"writeInProgress",!1);D(this,"scheduledTimer",null);D(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){me("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return me("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const zn={},wv=Object.freeze(Object.defineProperty({__proto__:null,default:zn},Symbol.toStringTag,{value:"Module"})),Pr=new Set;function Va(a){const e=`${a.feature}:${a.capability}:${a.message}`;Pr.has(e)||(Pr.add(e),Ye(a.message,{feature:a.feature,capability:a.capability,cause:a.cause}))}class eo extends Error{constructor(t,s,n){super(n);D(this,"capability");D(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class to extends Error{constructor(t,s,n,i){super(n);D(this,"capability");D(this,"feature");D(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=i}}class Tv{constructor(e=globalThis){D(this,"supportedCapabilities");D(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,n;return typeof((n=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(n){throw new to("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new eo("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Sv=".tmp";class Dv{constructor(e,t){D(this,"plugin");D(this,"apiAdapter");D(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(Rs);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){me("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),ue(`Saved ${e.tasks.length} active tasks`)}catch(t){throw me("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(Rs,e);return}const s=this.resolveStoragePath(Rs);if(!s){await this.plugin.saveData(Rs,e);return}const n=zn.dirname(s);await t.mkdir(n,{recursive:!0});const i=`${s}${Sv}`,o=JSON.stringify(e),c=await t.open(i,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(i,s)}catch{await t.rm(s,{force:!0}),await t.rename(i,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>wv);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Ye("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Va({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):zn.join(t,"storage",`p${s}`,`${e}.json`)}}const zr=1,Lr=1e3;class Ev{constructor(e){D(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[n,i]of s.entries())await this.appendTasksToYear(t,n,i);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),n=[];for(const c of s){const l=await this.loadChunk(c.key);if(l)for(const u of l.tasks)this.matchesQuery(u,e)&&n.push(u)}const i=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(i,i+o)}async loadIndex(){try{const e=await this.plugin.loadData(Ga);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??zr,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){me("Failed to load archive index",e)}return{version:zr,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Ga,e)}catch(t){throw me("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Ga}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){me("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw me("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const n=this.getCompletionTimestamp(s),i=new Date(n).getFullYear(),o=t.get(i);o?o.push(s):t.set(i,[s])}return t}async appendTasksToYear(e,t,s){let n=[...s];for(;n.length>0;){const i=this.findOrCreateChunk(e,t),o=await this.loadChunk(i.key)||{tasks:[]},c=Lr-o.tasks.length,l=n.slice(0,c);o.tasks.push(...l),n=n.slice(l.length);const u=this.updateChunkMeta(i,l);i.count=u.count,i.start=u.start,i.end=u.end,await this.saveChunk(i.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(n&&n.count<Lr)return n;const i=n?n.sequence+1:1,o={key:this.buildChunkKey(t,i),year:t,sequence:i,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,n=e.end;for(const i of t){const o=this.getCompletionTimestamp(i);(!s||o<s)&&(s=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:s,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(i=>{const o=i.start?new Date(i.start).getTime():null,c=i.end?new Date(i.end).getTime():null;return!(s&&c&&c<s||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),n=new Date(s).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Av{constructor(e,t=new Tv){D(this,"plugin");D(this,"activeTasks");D(this,"blockIndex",new Map);D(this,"taskBlockIndex",new Map);D(this,"dueIndex",new Map);D(this,"activeStore");D(this,"archiveStore");D(this,"persistence");D(this,"blockAttrSyncEnabled",!0);D(this,"blockApi");D(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Dv(e,t),this.archiveStore=new Ev(e),this.persistence=new bv(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),ue(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}async loadActiveTasks(e=1e3,t){const s=await this.activeStore.loadActive(),n=Array.from(s.values()),i=n.length;if(i===0)return[];const o=[];for(let c=0;c<i;c+=e){const l=n.slice(c,Math.min(c+e,i));o.push(...l),t&&t(o.length,i),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));ue(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);ue(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[n]of this.dueIndex)n<=t&&s.push(...this.getTasksForDueKey(n));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const n of t){const i=this.activeTasks.get(n);if(!i){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!i.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(i.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}s.push(i)}return s}removeStaleDueIndexEntry(e,t,s){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),Ye("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),s=this.taskBlockIndex.get(e.id);s&&s!==e.linkedBlockId&&(this.blockIndex.delete(s),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),s&&s!==e.linkedBlockId&&await this.clearBlockAttrs(s)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Ir]:e.id,[qr]:e.dueAt,[Or]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Ir]:"",[qr]:"",[Or]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Va({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof eo||s instanceof to?Va({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Va({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const n=new Date(s.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(Rs);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(yr);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(kr,t),ue(`Created legacy backup at ${kr}`);const n=s.filter(c=>!c.enabled&&c.lastCompletedAt),i=s.filter(c=>!n.includes(c)),o=new Map(i.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),ue("Legacy storage migration complete",{activeCount:i.length,archivedCount:n.length,legacyKey:yr,activeKey:Rs,archiveIndexKey:Ga})}}class xv{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}class Cv{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,n)=>s-n)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t,s){const i=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,{type:o,time:c}=t,l=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(i,l);break;case"weekly":u=this.calculateNextWeekly(i,l,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(i,l,this.normalizeDayOfMonth(t.dayOfMonth,i.getDate()));break;case"yearly":u=this.calculateNextYearly(i,l,this.normalizeMonth(t.month,i.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,i.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(c){const{hours:h,minutes:m}=$i(c);if(Number.isFinite(h)&&Number.isFinite(m)){const{date:y,shifted:_}=oc(u,h,m);_&&Ye("DST shift detected while applying recurrence time",{requestedTime:c,original:u.toISOString(),adjusted:y.toISOString()}),u=y}}return u}calculateNextDaily(e,t){return Ma(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return Nr(e,t);const n=this.getMondayIndex(e),i=Math.min(mn,t*14);for(let o=1;o<=i;o++){if(Math.floor((n+o)/7)%t!==0)continue;const l=Ma(e,o),u=this.getMondayIndex(l);if(s.includes(u))return l}return Ye("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),Nr(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const n=s??e.getDate(),i=e.getFullYear(),c=e.getMonth()+t,l=i+Math.floor(c/12),u=(c%12+12)%12,h=new Date(l,u+1,0).getDate(),m=Math.min(n,h),y=new Date(e);return y.setFullYear(l,u,m),y}calculateNextYearly(e,t,s,n){const i=n??e.getDate(),o=e.getFullYear()+t,c=new Date(o,s+1,0).getDate(),l=Math.min(i,c),u=new Date(e);return u.setFullYear(o,s,l),u}getOccurrencesInRange(e,t,s,n){const i=[];let o=new Date(n),c=0;for(;o<=t&&c<mn;)o>=e&&i.push(new Date(o)),o=this.calculateNext(o,s),c++;return i}getMissedOccurrences(e,t,s,n){const i=[];let o=new Date(n),c=0;for(;o<=e&&c<mn;)o=this.calculateNext(o,s),c++;let l=0;for(;o<t&&l<Ya;)i.push(new Date(o)),o=this.calculateNext(o,s),l++;return l>=Ya&&Ye("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:n.toISOString(),cap:Ya}),i}}class Iv{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:n}=$i(t);if(!Number.isFinite(s)||!Number.isFinite(n))return new Date(e);const i=new Date(e);return i.setHours(s,n,0,0),i}isSameLocalDay(e,t){const s=new Date(e),n=new Date(t);return s.getFullYear()===n.getFullYear()&&s.getMonth()===n.getMonth()&&s.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),n=Math.trunc(s/(1e3*60)),i=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(i)<24?i>0?`in ${i}h`:`${-i}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class qv{constructor(e){D(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return ue(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return Ye(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return Ye("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),ue(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return Ye("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(s){return me("Failed to execute onCompletion action",{taskId:e.id,action:t,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return Ye("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return me("Failed to check for nested items",{blockId:e,error:t}),!0}}}class Ov{constructor(e,t){D(this,"intervalMs");D(this,"timeoutId",null);D(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:er,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class Mv{constructor(e,t=er,s){D(this,"storage");D(this,"recurrenceEngine");D(this,"onCompletionHandler");D(this,"emittedDue",new Set);D(this,"emittedMissed",new Set);D(this,"timezoneHandler");D(this,"isChecking",!1);D(this,"lastCheckStartTime",0);D(this,"plugin",null);D(this,"listeners",{"task:due":new Set,"task:overdue":new Set});D(this,"MAX_EMITTED_ENTRIES",1e3);D(this,"EMITTED_RETENTION_DAYS",30);D(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);D(this,"persistTimeoutId",null);D(this,"emittedStateReady",null);D(this,"timer");this.storage=e,this.recurrenceEngine=new Cv,this.onCompletionHandler=new qv(s),this.timezoneHandler=new Iv,this.plugin=s||null,this.timer=new Ov(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),ue("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),ue("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Ye("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const n=new Date(s.dueAt),i=n<=e;if(i){const c=this.buildOccurrenceKey(s.id,n,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:s.id,dueAt:n,context:"today",task:s}),this.registerEmittedKey("due",c),ue(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(i&&e.getTime()-n.getTime()>=Vl&&(!o||o<n)){const c=this.buildOccurrenceKey(s.id,n,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:n,context:"overdue",task:s}),this.registerEmittedKey("missed",c),Ye(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),s=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=s.set,(t.didTrim||s.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,s){const n=s.getTime(),i=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=i.filter(({time:u})=>u===null||u>=n),c=o.length!==i.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),c=!0);const l=new Set(o.map(({entry:u})=>u));return c&&ue(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${l.size}`),{set:l,didTrim:c}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const s=e.slice(t+1);if(!s)return null;const n=s.length===13?`${s}:00:00.000Z`:s,i=new Date(n);return Number.isNaN(i.getTime())?null:i.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const s=new Date;t.doneAt=s.toISOString(),Xl(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const i=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,i);if(o.success||me(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:i,error:o.error}),o.warnings)for(const u of o.warnings)Ye(u,{taskId:t.id});const c=new Date(t.dueAt),l=this.recurrenceEngine.calculateNext(c,t.frequency,{completionDate:s,whenDone:t.whenDone});t.dueAt=l.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),ue(`Task "${t.name}" completed and rescheduled to ${l.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const n=new Date(s.dueAt),i=new Date(n.getTime()+t*60*1e3);s.dueAt=i.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),ue(`Task "${s.name}" delayed by ${t} minutes to ${i.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),ue(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Wi(t);const s=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),ue(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),ue("First run detected, no recovery needed");return}ue(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const i of n){const o=this.buildOccurrenceKey(s.id,i,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:i,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(n){me(`Failed to recover task ${s.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),ue("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let n=s,i=0;for(;n<t&&i<Ya;)n=this.recurrenceEngine.calculateNext(n,e.frequency),i++;n>s&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),ue(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Cr);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){me("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Cr,{timestamp:e.toISOString()})}catch(t){me("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const n of s)try{const i=n(t);i instanceof Promise&&i.catch(o=>{me(`Scheduler listener error for ${e}:`,o)})}catch(i){me(`Scheduler listener error for ${e}:`,i)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Wl,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Tr),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),ue("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){me("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Tr,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){me("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const Nv=7,Rv=2e3;class Bv{constructor(e,t){D(this,"plugin");D(this,"storageKey");D(this,"notifications",new Map);D(this,"escalations",new Map);D(this,"lastCleanup",new Date);D(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),ue(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){me("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Xi("Saved notification state")}catch(e){me("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>Rv&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-Nv*24*60*60*1e3);let n=0;for(const[i,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(i),n++);n>0&&(ue(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function Fv(a){return{id:a.id,name:a.name,dueAt:a.dueAt,frequency:a.frequency,linkedBlockId:a.linkedBlockId,linkedBlockContent:a.linkedBlockContent,priority:a.priority,tags:a.tags,notificationChannels:a.notificationChannels,completionCount:a.completionCount,missCount:a.missCount,currentStreak:a.currentStreak,bestStreak:a.bestStreak}}const Pv=30*1e3,zv=30*60*1e3,qs=500;class Lv{constructor(e,t={}){D(this,"plugin");D(this,"config");D(this,"queue",[]);D(this,"dedupeKeys",new Set);D(this,"flushIntervalId",null);D(this,"fetcher");D(this,"notificationState");D(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...Nn},this.notificationState=t.notificationState??new Bv(this.plugin,Hl)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(br);e&&(this.config={...Nn,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(br,e)}async loadQueue(){try{const e=await this.plugin.loadData(wr);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>qs){const s=this.queue.length-qs;this.queue=this.queue.slice(-qs),console.warn(`Event queue trimmed to ${qs} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-gn);await this.plugin.saveData(wr,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Yl))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const i=this.buildPayload(e,t,n,1,s);await this.sendPayload(i)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(i)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:Sr,version:Dr,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){s.push(n);continue}const i={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(i))this.markDelivered(i.delivery.dedupeKey),t=!0;else{const c=n.attempt+1,l=this.getRetryDelay(c);s.push({...n,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,n,i=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:Sr,version:Dr,occurredAt:o.toISOString(),task:Fv(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:i,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:n}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>gn){const t=Array.from(this.dedupeKeys).slice(-gn);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=qs){const s=this.queue.length-qs+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${qs}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=Pv*Math.pow(2,e-1);return Math.min(t,zv)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,n=s.encode(t),i=s.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,i);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const i={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return n&&(i["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(i["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),i}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),n=await this.buildHeaders(e),i=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:s});if(!i.ok)return console.error("n8n webhook failed:",i.statusText),!1;if(t){const o=await i.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const na={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:{enabled:!1,mode:"include",tagPattern:void 0,pathPattern:void 0,regex:void 0}};function jr(a){return{dates:{...na.dates,...a.dates},recurrence:{...na.recurrence,...a.recurrence},dependencies:{...na.dependencies,...a.dependencies},filenameDate:{...na.filenameDate,...a.filenameDate},globalFilter:{...na.globalFilter,...a.globalFilter}}}const bn="plugin-settings";class jv{constructor(e){D(this,"plugin");D(this,"settings");this.plugin=e,this.settings=na}async load(){try{const e=await this.plugin.loadData(bn);e&&typeof e=="object"&&(this.settings=jr(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(bn,e)}get(){return this.settings}async update(e){this.settings=jr(e),await this.plugin.saveData(bn,this.settings)}}const ks=class ks{constructor(e){D(this,"plugin");D(this,"isInitialized",!1);D(this,"storage");D(this,"repository");D(this,"scheduler");D(this,"eventService");D(this,"settingsService");this.plugin=e}static getInstance(e){if(!ks.instance){if(!e)return null;ks.instance=new ks(e)}return ks.instance}async initialize(){if(this.isInitialized){Ye("TaskManager already initialized");return}ue("Initializing TaskManager"),this.settingsService=new jv(this.plugin),await this.settingsService.load(),this.storage=new Av(this.plugin),await this.storage.init(),this.repository=new xv(this.storage),this.eventService=new Lv(this.plugin),await this.eventService.init(),this.scheduler=new Mv(this.storage,er,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,ue("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),ue("TaskManager started")}async destroy(){ue("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,ks.instance=null,ue("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};D(ks,"instance",null);let Ja=ks;function Kv(a){let t=`- [${a.status==="done"?"x":" "}] ${a.name}`;if(a.dueAt){const s=new Date(a.dueAt);t+=` üìÖ ${s.toISOString().split("T")[0]}`}return a.frequency&&(t+=` üîÅ every ${a.frequency.interval} ${a.frequency.type}${a.frequency.interval>1?"s":""}`),t}class Uv{constructor(e,t,s,n){this.storage=e,this.recurrenceEngine=t,this.settings=s,this.siyuanApi=n}async onComplete(e,t){try{const s=[],n=this.addCompletionDate(e,t);let i;return e.frequency&&(i=await this.generateNextInstance(n,t),i&&(await this.placeNextInstance(n,i)||s.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(i))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(Ye("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(n),s.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(n),{success:!0,nextTask:i,warnings:s.length>0?s:void 0}}catch(s){return me("Failed to handle task completion",{taskId:e.id,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}addCompletionDate(e,t){const s={...e},n=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(s.doneAt=n,s.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(s.cancelledAt=n,s.doneAt=void 0),s}async generateNextInstance(e,t){if(e.frequency)try{const s=new Date(e.dueAt),n=this.recurrenceEngine.calculateNext(s,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),i=Vi(e,{dueAt:n.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(i.scheduledAt=void 0),i}catch(s){me("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:s});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return Ye("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return Ye("SiYuan API not available, cannot place next instance"),!1;const s=this.settings.recurrence.newTaskPosition,n=Kv(t);try{let i;return s==="above"&&this.siyuanApi.insertBlockAbove?i=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,n):s==="below"&&this.siyuanApi.insertBlockBelow&&(i=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,n)),i!=null&&i.id?(t.linkedBlockId=i.id,t.linkedBlockContent=n,!0):!1}catch(i){return me("Failed to place next instance in document",{taskId:e.id,placement:s,error:i}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const s=await this.siyuanApi.getChildBlocks({id:e});return s&&s.length>0}catch(s){return me("Failed to check for nested items",{blockId:e,error:s}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),ue("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(s){me("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:s})}else ue("Task deleted from storage only (no linked block)",{taskId:e.id})}}class Hv{constructor(e,t,s,n){D(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=s,this.siyuanApi=n,t&&s&&(this.completionHandler=new Uv(e,t,s(),n))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,s;try{const n=this.repository.getTask(e);if(!n){X.error("Task not found");return}const i=as.getInstance(),o=n.statusSymbol||" ",c=i.getNextSymbol(o),l={...n,statusSymbol:c},u=i.getStatus(c);if(u.type==="DONE"){if(l.status="done",n.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(l,new Date);h.success?(h.nextTask?(ue("Next recurrence created",{taskId:l.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),X.success("Task completed - next occurrence scheduled")):X.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(m=>X.warning(m))):X.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!l.doneAt&&(l.doneAt=new Date().toISOString()),await this.repository.saveTask(l),X.success(`Task status updated to ${u.name}`);Ke.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(l.status="cancelled",(s=this.settings)!=null&&s.dates.autoAddCancelled&&!l.cancelledAt&&(l.cancelledAt=new Date().toISOString()),await this.repository.saveTask(l),Ke.emit("task:updated",{taskId:e}),X.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(l.status="todo",await this.repository.saveTask(l),Ke.emit("task:updated",{taskId:e}),X.success(`Task status updated to ${u.name}`))}catch(n){me("Failed to toggle task status",n),X.error("Failed to toggle status")}}async completeTask(e){var t;try{const s=this.repository.getTask(e);if(!s){X.error("Task not found");return}const n={...s,status:"done"};if(s.frequency&&this.completionHandler){const i=await this.completionHandler.onComplete(n,new Date);i.success?(i.nextTask?(ue("Next recurrence created",{taskId:n.id,nextTaskId:i.nextTask.id,nextDue:i.nextTask.dueAt}),X.success(`Task "${s.name}" completed - next occurrence scheduled`)):X.success(`Task "${s.name}" completed`),i.warnings&&i.warnings.forEach(o=>X.warning(o))):X.error(`Failed to complete task: ${i.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),X.success(`Task "${s.name}" completed`);Ke.emit("task:complete",{taskId:e})}catch(s){me("Failed to complete task",s),X.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){X.error("Task not found");return}const n=this.repository.getAllTasks().filter(i=>{var o,c;return((o=i.blockedBy)==null?void 0:o.includes(e))||((c=i.dependsOn)==null?void 0:c.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),Ke.emit("task:deleted",{taskId:e}),X.success(`Task "${t.name}" deleted`)}catch(t){me("Failed to delete task",t),X.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){X.error("Task not found");return}const s=new Date;s.setHours(12,0,0,0);const n={...t,scheduledAt:s.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),Ke.emit("task:updated",{taskId:e}),X.success("Task rescheduled to today")}catch(t){me("Failed to reschedule task",t),X.error("Failed to reschedule task")}}async deferTask(e,t){try{const s=this.repository.getTask(e);if(!s){X.error("Task not found");return}const n={...s,updatedAt:new Date().toISOString()};if(s.dueAt){const i=new Date(s.dueAt);i.setDate(i.getDate()+t),n.dueAt=i.toISOString()}if(s.scheduledAt){const i=new Date(s.scheduledAt);i.setDate(i.getDate()+t),n.scheduledAt=i.toISOString()}await this.repository.saveTask(n),Ke.emit("task:updated",{taskId:e}),X.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(s){me("Failed to defer task",s),X.error("Failed to defer task")}}}function Gv(a,e,t,s){const n=new Hv(e,t,s);a.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{Kr()}}),a.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{a.openDock()}}),a.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await Vv(e,n)}}),a.addCommand({langKey:"toggleTaskStatus",hotkey:"‚åò‚áßX",callback:async()=>{const i=await Wv();i&&await n.toggleStatus(i)}}),a.addCommand({langKey:"openTaskEditor",hotkey:"‚åò‚áßE",callback:()=>{Yv()}}),a.addCommand({langKey:"quickAddTask",hotkey:"‚åò‚áßN",callback:()=>{Kr()}}),ue("Registered slash commands and hotkeys")}function Kr(){Ke.emit("task:create",{source:"command"});const a=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(a)}function Yv(){Ke.emit("task:edit",{source:"command"});const a=new CustomEvent("recurring-task-edit",{detail:{source:"command"}});window.dispatchEvent(a)}async function Vv(a,e){try{const t=a.getTodayAndOverdueTasks();if(t.length===0){ue("No tasks due today");return}const s=t[0];await e.completeTask(s.id),ue(`Quick completing task: ${s.name}`)}catch(t){me("Failed to quick complete task",t)}}async function Wv(){return null}function Ur(a,e){Ke.emit("task:snooze",{taskId:a,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:a,minutes:e}})),ue(`Snoozing task ${a} for ${e} minutes`)}function Qv(a){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=Bn(t),n=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));Ke.emit("task:snooze",{taskId:a,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:a,minutes:n}})),ue(`Snoozing task ${a} to tomorrow`)}function Xv(a){a.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],n=s==null?void 0:s.getAttribute("data-node-id");if(!n)return;const i=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=a.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Ke.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:i,suggestedName:Hr(i),suggestedTime:Gr(i)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:i,suggestedName:Hr(i),suggestedTime:Gr(i)}}))}});try{const u=Ja.getInstance();if(u&&u.isReady()){const m=u.getRepository().getTaskByBlockId(n);if(m){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=a.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{Ke.emit("task:complete",{taskId:m.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:m.id}}))}});const y=[{label:"15 minutes",click:()=>Ur(m.id,15)},{label:"1 hour",click:()=>Ur(m.id,60)},{label:"Tomorrow",click:()=>Qv(m.id)}];e.menu.addItem({icon:"iconClock",label:((l=a.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:y})}}}catch{Xi("TaskManager not available for quick actions")}}),ue("Registered block context menu")}function Hr(a){const e=a.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function Gr(a){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=a.match(e);if(t){let n=parseInt(t[1],10);const i=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${i}`}return null}class $v{constructor(e,t){D(this,"plugin");D(this,"repository");D(this,"topbarElement",null);D(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),ue("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),ue("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const n=new Date(s.dueAt);return n<new Date&&!tr(n)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){Ke.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Jv extends jn.Plugin{constructor(){super(...arguments);D(this,"taskManager");D(this,"repository");D(this,"scheduler");D(this,"eventService");D(this,"migrationManager");D(this,"topbarMenu");D(this,"dashboardComponent",null);D(this,"dockEl");D(this,"quickAddComponent",null);D(this,"quickAddContainer",null);D(this,"taskEditorComponent",null);D(this,"taskEditorContainer",null);D(this,"pendingCompletionTimeouts",new Map);D(this,"handleCreateTaskEvent",t=>{try{const s=t;ue("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){me("Failed to handle create task event",s),X.error("Failed to open task creator.")}});D(this,"handleSettingsEvent",t=>{try{ue("Settings event received",t.detail),this.openDock()}catch(s){me("Failed to handle settings event",s),X.error("Failed to open settings.")}});D(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:n}=s.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(s){me("Failed to complete task",s),X.error("Failed to complete task.")}});D(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:n,minutes:i}=s.detail??{};if(!n||typeof i!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,i)}catch(s){me("Failed to snooze task",s),X.error("Failed to snooze task.")}})}async onload(){ue("Loading Recurring Tasks Plugin"),this.migrationManager=new kv(this);try{await this.migrationManager.migrate(Rs)}catch(n){me("Migration failed, continuing with existing data",n)}const t=Ja.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const s=this.taskManager.getSettingsService();try{await this.taskManager.start()}catch(n){me("Failed to start TaskManager",n)}Gv(this,this.repository,this.scheduler.getRecurrenceEngine(),()=>s.get()),Xv(this),this.topbarMenu=new $v(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:Gl,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),ue("Recurring Tasks Plugin loaded successfully")}async onunload(){ue("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=hn(hv,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(fn(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Ke.on("task:create",t=>{ue("Create task event received",t),this.openQuickAdd(t)}),Ke.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Ke.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Ke.on("task:settings",()=>{this.openDock()}),Ke.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){me("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Ke.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){X.info(`Completion already pending for "${s.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),ue(`Task completed: ${s.name}`)}catch(o){me("Failed to finalize task completion",o),X.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const i=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),X.info(`Undo: "${s.name}" restored`))};Bs({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:i,showCountdown:!0})}}async handleSnoozeTask(t,s){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),ue(`Task snoozed: ${n.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=hn(yv,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}closeQuickAdd(){this.quickAddComponent&&(fn(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=hn(Zi,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(fn(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=Jv;

"use strict";var ql=Object.defineProperty;var ei=a=>{throw TypeError(a)};var Rl=(a,e,t)=>e in a?ql(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var A=(a,e,t)=>Rl(a,typeof e!="symbol"?e+"":e,t),Wn=(a,e,t)=>e.has(a)||ei("Cannot "+t);var O=(a,e,t)=>(Wn(a,e,"read from private field"),t?t.call(a):e.get(a)),Ae=(a,e,t)=>e.has(a)?ei("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(a):e.set(a,t),Ee=(a,e,t,s)=>(Wn(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t),ht=(a,e,t)=>(Wn(a,e,"access private method"),t);const Mr=require("siyuan"),nr=!1;var Nr=Array.isArray,Ll=Array.prototype.indexOf,Fn=Array.from,Fl=Object.defineProperty,Is=Object.getOwnPropertyDescriptor,Bl=Object.getOwnPropertyDescriptors,Ul=Object.prototype,Pl=Array.prototype,ro=Object.getPrototypeOf,ti=Object.isExtensible;function jl(a){for(var e=0;e<a.length;e++)a[e]()}function io(){var a,e,t=new Promise((s,n)=>{a=s,e=n});return{promise:t,resolve:a,reject:e}}function oo(a,e){if(Array.isArray(a))return a;if(!(Symbol.iterator in a))return Array.from(a);const t=[];for(const s of a)if(t.push(s),t.length===e)break;return t}const yt=2,Dn=4,Bn=8,lo=1<<24,Ma=16,Na=32,gs=64,qr=128,Zt=512,Tt=1024,It=2048,qa=4096,jt=8192,Aa=16384,Rr=32768,Us=65536,ai=1<<17,co=1<<18,Hs=1<<19,zl=1<<20,Ea=1<<25,ps=32768,rr=1<<21,Lr=1<<22,Ga=1<<23,us=Symbol("$state"),Yl=Symbol("legacy props"),Hl=Symbol(""),As=new class extends Error{constructor(){super(...arguments);A(this,"name","StaleReactionError");A(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function uo(a){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Kl(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Wl(a){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Gl(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Vl(a){throw new Error("https://svelte.dev/e/effect_orphan")}function Ql(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Xl(a){throw new Error("https://svelte.dev/e/props_invalid_value")}function $l(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Zl(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Jl(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function ec(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const tc=1,ac=2,ho=4,sc=8,nc=16,rc=1,ic=4,oc=8,lc=16,cc=1,uc=2,ft=Symbol(),dc="http://www.w3.org/1999/xhtml";function hc(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function fc(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function fo(a){return a===this.v}function vc(a,e){return a!=a?e==e:a!==e||a!==null&&typeof a=="object"||typeof a=="function"}function vo(a){return!vc(a,this.v)}let pc=!1,qt=null;function Ps(a){qt=a}function Qe(a,e=!1,t){qt={p:qt,i:!1,c:null,e:null,s:a,x:null,l:null}}function Xe(a){var e=qt,t=e.e;if(t!==null){e.e=null;for(var s of t)qo(s)}return e.i=!0,qt=e.p,{}}function po(){return!0}let ts=[];function yo(){var a=ts;ts=[],jl(a)}function Ks(a){if(ts.length===0&&!en){var e=ts;queueMicrotask(()=>{e===ts&&yo()})}ts.push(a)}function yc(){for(;ts.length>0;)yo()}function mo(a){var e=Ne;if(e===null)return De.f|=Ga,a;if(e.f&Rr)js(a,e);else{if(!(e.f&qr))throw a;e.b.error(a)}}function js(a,e){for(;e!==null;){if(e.f&qr)try{e.b.error(a);return}catch(t){a=t}e=e.parent}throw a}const mc=-7169;function st(a,e){a.f=a.f&mc|e}function Fr(a){a.f&Zt||a.deps===null?st(a,Tt):st(a,qa)}function go(a){if(a!==null)for(const e of a)!(e.f&yt)||!(e.f&ps)||(e.f^=ps,go(e.deps))}function _o(a,e,t){a.f&It?e.add(a):a.f&qa&&t.add(a),go(a.deps),st(a,Tt)}const gn=new Set;let Se=null,Js=null,vt=null,Qt=[],Un=null,ir=!1,en=!1;var Ns,qs,ns,rs,dn,Rs,Ls,Jt,or,lr,bo,ko;const qn=class qn{constructor(){Ae(this,Jt);A(this,"committed",!1);A(this,"current",new Map);A(this,"previous",new Map);Ae(this,Ns,new Set);Ae(this,qs,new Set);Ae(this,ns,0);Ae(this,rs,0);Ae(this,dn,null);Ae(this,Rs,new Set);Ae(this,Ls,new Set);A(this,"skipped_effects",new Set);A(this,"is_fork",!1)}is_deferred(){return this.is_fork||O(this,rs)>0}process(e){var n;Qt=[],Js=null,this.apply();var t=[],s=[];for(const r of e)ht(this,Jt,or).call(this,r,t,s);this.is_fork||ht(this,Jt,bo).call(this),this.is_deferred()?(ht(this,Jt,lr).call(this,s),ht(this,Jt,lr).call(this,t)):(Js=this,Se=null,si(s),si(t),Js=null,(n=O(this,dn))==null||n.resolve()),vt=null}capture(e,t){t!==ft&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Ga||(this.current.set(e,e.v),vt==null||vt.set(e,e.v))}activate(){Se=this,this.apply()}deactivate(){Se===this&&(Se=null,vt=null)}flush(){if(this.activate(),Qt.length>0){if(wo(),Se!==null&&Se!==this)return}else O(this,ns)===0&&this.process([]);this.deactivate()}discard(){for(const e of O(this,qs))e(this);O(this,qs).clear()}increment(e){Ee(this,ns,O(this,ns)+1),e&&Ee(this,rs,O(this,rs)+1)}decrement(e){Ee(this,ns,O(this,ns)-1),e&&Ee(this,rs,O(this,rs)-1),this.revive()}revive(){for(const e of O(this,Rs))O(this,Ls).delete(e),st(e,It),Ia(e);for(const e of O(this,Ls))st(e,qa),Ia(e);this.flush()}oncommit(e){O(this,Ns).add(e)}ondiscard(e){O(this,qs).add(e)}settled(){return(O(this,dn)??Ee(this,dn,io())).promise}static ensure(){if(Se===null){const e=Se=new qn;gn.add(Se),en||qn.enqueue(()=>{Se===e&&e.flush()})}return Se}static enqueue(e){Ks(e)}apply(){}};Ns=new WeakMap,qs=new WeakMap,ns=new WeakMap,rs=new WeakMap,dn=new WeakMap,Rs=new WeakMap,Ls=new WeakMap,Jt=new WeakSet,or=function(e,t,s){e.f^=Tt;for(var n=e.first,r=null;n!==null;){var o=n.f,c=(o&(Na|gs))!==0,l=c&&(o&Tt)!==0,u=l||(o&jt)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){c?n.f^=Tt:r!==null&&o&(Dn|Bn|lo)?r.b.defer_effect(n):o&Dn?t.push(n):pn(n)&&(o&Ma&&O(this,Rs).add(n),rn(n));var h=n.first;if(h!==null){n=h;continue}}var y=n.parent;for(n=n.next;n===null&&y!==null;)y===r&&(r=null),n=y.next,y=y.parent}},lr=function(e){for(var t=0;t<e.length;t+=1)_o(e[t],O(this,Rs),O(this,Ls))},bo=function(){if(O(this,rs)===0){for(const e of O(this,Ns))e();O(this,Ns).clear()}O(this,ns)===0&&ht(this,Jt,ko).call(this)},ko=function(){var n;if(gn.size>1){this.previous.clear();var e=vt,t=!0;for(const r of gn){if(r===this){t=!1;continue}const o=[];for(const[l,u]of this.current){if(r.current.has(l))if(t&&u!==r.current.get(l))r.current.set(l,u);else continue;o.push(l)}if(o.length===0)continue;const c=[...r.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var s=Qt;Qt=[];const l=new Set,u=new Map;for(const h of o)To(h,c,l,u);if(Qt.length>0){Se=r,r.apply();for(const h of Qt)ht(n=r,Jt,or).call(n,h,[],[]);r.deactivate()}Qt=s}}Se=null,vt=e}this.committed=!0,gn.delete(this)};let xa=qn;function gc(a){var e=en;en=!0;try{for(var t;;){if(yc(),Qt.length===0&&(Se==null||Se.flush(),Qt.length===0))return Un=null,t;wo()}}finally{en=e}}function wo(){var a=hs;ir=!0;var e=null;try{var t=0;for(xn(!0);Qt.length>0;){var s=xa.ensure();if(t++>1e3){var n,r;_c()}s.process(Qt),Va.clear()}}finally{ir=!1,xn(a),Un=null}}function _c(){try{Ql()}catch(a){js(a,Un)}}let ra=null;function si(a){var e=a.length;if(e!==0){for(var t=0;t<e;){var s=a[t++];if(!(s.f&(Aa|jt))&&pn(s)&&(ra=new Set,rn(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?Uo(s):s.fn=null),(ra==null?void 0:ra.size)>0)){Va.clear();for(const n of ra){if(n.f&(Aa|jt))continue;const r=[n];let o=n.parent;for(;o!==null;)ra.has(o)&&(ra.delete(o),r.push(o)),o=o.parent;for(let c=r.length-1;c>=0;c--){const l=r[c];l.f&(Aa|jt)||rn(l)}}ra.clear()}}ra=null}}function To(a,e,t,s){if(!t.has(a)&&(t.add(a),a.reactions!==null))for(const n of a.reactions){const r=n.f;r&yt?To(n,e,t,s):r&(Lr|Ma)&&!(r&It)&&So(n,e,s)&&(st(n,It),Ia(n))}}function So(a,e,t){const s=t.get(a);if(s!==void 0)return s;if(a.deps!==null)for(const n of a.deps){if(e.includes(n))return!0;if(n.f&yt&&So(n,e,t))return t.set(n,!0),!0}return t.set(a,!1),!1}function Ia(a){for(var e=Un=a;e.parent!==null;){e=e.parent;var t=e.f;if(ir&&e===Ne&&t&Ma&&!(t&co))return;if(t&(gs|Na)){if(!(t&Tt))return;e.f^=Tt}}Qt.push(e)}function bc(a){let e=0,t=ys(0),s;return()=>{Pr()&&(i(t),zn(()=>(e===0&&(s=_s(()=>a(()=>tn(t)))),e+=1,()=>{Ks(()=>{e-=1,e===0&&(s==null||s(),s=void 0,tn(t))})})))}}var kc=Us|Hs|qr;function wc(a,e,t){new Tc(a,e,t)}var Gt,Or,va,is,pa,Vt,Ot,ya,Da,ja,os,za,ls,Fs,Bs,Ya,Rn,at,Sc,Dc,cr,bn,kn,ur;class Tc{constructor(e,t,s){Ae(this,at);A(this,"parent");A(this,"is_pending",!1);Ae(this,Gt);Ae(this,Or,null);Ae(this,va);Ae(this,is);Ae(this,pa);Ae(this,Vt,null);Ae(this,Ot,null);Ae(this,ya,null);Ae(this,Da,null);Ae(this,ja,null);Ae(this,os,0);Ae(this,za,0);Ae(this,ls,!1);Ae(this,Fs,new Set);Ae(this,Bs,new Set);Ae(this,Ya,null);Ae(this,Rn,bc(()=>(Ee(this,Ya,ys(O(this,os))),()=>{Ee(this,Ya,null)})));Ee(this,Gt,e),Ee(this,va,t),Ee(this,is,s),this.parent=Ne.b,this.is_pending=!!O(this,va).pending,Ee(this,pa,zr(()=>{Ne.b=this;{var n=ht(this,at,cr).call(this);try{Ee(this,Vt,Xt(()=>s(n)))}catch(r){this.error(r)}O(this,za)>0?ht(this,at,kn).call(this):this.is_pending=!1}return()=>{var r;(r=O(this,ja))==null||r.remove()}},kc))}defer_effect(e){_o(e,O(this,Fs),O(this,Bs))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!O(this,va).pending}update_pending_count(e){ht(this,at,ur).call(this,e),Ee(this,os,O(this,os)+e),O(this,Ya)&&zs(O(this,Ya),O(this,os))}get_effect_pending(){return O(this,Rn).call(this),i(O(this,Ya))}error(e){var t=O(this,va).onerror;let s=O(this,va).failed;if(O(this,ls)||!t&&!s)throw e;O(this,Vt)&&(Nt(O(this,Vt)),Ee(this,Vt,null)),O(this,Ot)&&(Nt(O(this,Ot)),Ee(this,Ot,null)),O(this,ya)&&(Nt(O(this,ya)),Ee(this,ya,null));var n=!1,r=!1;const o=()=>{if(n){fc();return}n=!0,r&&ec(),xa.ensure(),Ee(this,os,0),O(this,ya)!==null&&ds(O(this,ya),()=>{Ee(this,ya,null)}),this.is_pending=this.has_pending_snippet(),Ee(this,Vt,ht(this,at,bn).call(this,()=>(Ee(this,ls,!1),Xt(()=>O(this,is).call(this,O(this,Gt)))))),O(this,za)>0?ht(this,at,kn).call(this):this.is_pending=!1};var c=De;try{Mt(null),r=!0,t==null||t(e,o),r=!1}catch(l){js(l,O(this,pa)&&O(this,pa).parent)}finally{Mt(c)}s&&Ks(()=>{Ee(this,ya,ht(this,at,bn).call(this,()=>{xa.ensure(),Ee(this,ls,!0);try{return Xt(()=>{s(O(this,Gt),()=>e,()=>o)})}catch(l){return js(l,O(this,pa).parent),null}finally{Ee(this,ls,!1)}}))})}}Gt=new WeakMap,Or=new WeakMap,va=new WeakMap,is=new WeakMap,pa=new WeakMap,Vt=new WeakMap,Ot=new WeakMap,ya=new WeakMap,Da=new WeakMap,ja=new WeakMap,os=new WeakMap,za=new WeakMap,ls=new WeakMap,Fs=new WeakMap,Bs=new WeakMap,Ya=new WeakMap,Rn=new WeakMap,at=new WeakSet,Sc=function(){try{Ee(this,Vt,Xt(()=>O(this,is).call(this,O(this,Gt))))}catch(e){this.error(e)}},Dc=function(){const e=O(this,va).pending;e&&(Ee(this,Ot,Xt(()=>e(O(this,Gt)))),xa.enqueue(()=>{var t=ht(this,at,cr).call(this);Ee(this,Vt,ht(this,at,bn).call(this,()=>(xa.ensure(),Xt(()=>O(this,is).call(this,t))))),O(this,za)>0?ht(this,at,kn).call(this):(ds(O(this,Ot),()=>{Ee(this,Ot,null)}),this.is_pending=!1)}))},cr=function(){var e=O(this,Gt);return this.is_pending&&(Ee(this,ja,Ca()),O(this,Gt).before(O(this,ja)),e=O(this,ja)),e},bn=function(e){var t=Ne,s=De,n=qt;_a(O(this,pa)),Mt(O(this,pa)),Ps(O(this,pa).ctx);try{return e()}catch(r){return mo(r),null}finally{_a(t),Mt(s),Ps(n)}},kn=function(){const e=O(this,va).pending;O(this,Vt)!==null&&(Ee(this,Da,document.createDocumentFragment()),O(this,Da).append(O(this,ja)),zo(O(this,Vt),O(this,Da))),O(this,Ot)===null&&Ee(this,Ot,Xt(()=>e(O(this,Gt))))},ur=function(e){var t;if(!this.has_pending_snippet()){this.parent&&ht(t=this.parent,at,ur).call(t,e);return}if(Ee(this,za,O(this,za)+e),O(this,za)===0){this.is_pending=!1;for(const s of O(this,Fs))st(s,It),Ia(s);for(const s of O(this,Bs))st(s,qa),Ia(s);O(this,Fs).clear(),O(this,Bs).clear(),O(this,Ot)&&ds(O(this,Ot),()=>{Ee(this,Ot,null)}),O(this,Da)&&(O(this,Gt).before(O(this,Da)),Ee(this,Da,null))}};function Ec(a,e,t,s){const n=Pn;if(t.length===0&&a.length===0){s(e.map(n));return}var r=Se,o=Ne,c=xc();function l(){Promise.all(t.map(u=>Ac(u))).then(u=>{c();try{s([...e.map(n),...u])}catch(h){o.f&Aa||js(h,o)}r==null||r.deactivate(),En()}).catch(u=>{js(u,o)})}a.length>0?Promise.all(a).then(()=>{c();try{return l()}finally{r==null||r.deactivate(),En()}}):l()}function xc(){var a=Ne,e=De,t=qt,s=Se;return function(r=!0){_a(a),Mt(e),Ps(t),r&&(s==null||s.activate())}}function En(){_a(null),Mt(null),Ps(null)}function Pn(a){var e=yt|It,t=De!==null&&De.f&yt?De:null;return Ne!==null&&(Ne.f|=Hs),{ctx:qt,deps:null,effects:null,equals:fo,f:e,fn:a,reactions:null,rv:0,v:ft,wv:0,parent:t??Ne,ac:null}}function Ac(a,e,t){let s=Ne;s===null&&Kl();var n=s.b,r=void 0,o=ys(ft),c=!De,l=new Map;return Uc(()=>{var p;var u=io();r=u.promise;try{Promise.resolve(a()).then(u.resolve,u.reject).then(()=>{h===Se&&h.committed&&h.deactivate(),En()})}catch(k){u.reject(k),En()}var h=Se;if(c){var y=n.is_rendered();n.update_pending_count(1),h.increment(y),(p=l.get(h))==null||p.reject(As),l.delete(h),l.set(h,u)}const v=(k,g=void 0)=>{if(h.activate(),g)g!==As&&(o.f|=Ga,zs(o,g));else{o.f&Ga&&(o.f^=Ga),zs(o,k);for(const[m,b]of l){if(l.delete(m),m===h)break;b.reject(As)}}c&&(n.update_pending_count(-1),h.decrement(y))};u.promise.then(v,k=>v(null,k||"unknown"))}),jr(()=>{for(const u of l.values())u.reject(As)}),new Promise(u=>{function h(y){function v(){y===r?u(o):h(r)}y.then(v,v)}h(r)})}function $(a){const e=Pn(a);return Yo(e),e}function Do(a){const e=Pn(a);return e.equals=vo,e}function Eo(a){var e=a.effects;if(e!==null){a.effects=null;for(var t=0;t<e.length;t+=1)Nt(e[t])}}function Cc(a){for(var e=a.parent;e!==null;){if(!(e.f&yt))return e.f&Aa?null:e;e=e.parent}return null}function Br(a){var e,t=Ne;_a(Cc(a));try{a.f&=~ps,Eo(a),e=Go(a)}finally{_a(t)}return e}function xo(a){var e=Br(a);if(!a.equals(e)&&(a.wv=Ko(),(!(Se!=null&&Se.is_fork)||a.deps===null)&&(a.v=e,a.deps===null))){st(a,Tt);return}Qa||(vt!==null?(Pr()||Se!=null&&Se.is_fork)&&vt.set(a,e):Fr(a))}let dr=new Set;const Va=new Map;let Ao=!1;function ys(a,e){var t={f:0,v:a,reactions:null,equals:fo,rv:0,wv:0};return t}function Q(a,e){const t=ys(a);return Yo(t),t}function Ic(a,e=!1,t=!0){const s=ys(a);return e||(s.equals=vo),s}function _(a,e,t=!1){De!==null&&(!la||De.f&ai)&&po()&&De.f&(yt|Ma|Lr|ai)&&!(Ct!=null&&Ct.includes(a))&&Jl();let s=t?ke(e):e;return zs(a,s)}function zs(a,e){if(!a.equals(e)){var t=a.v;Qa?Va.set(a,e):Va.set(a,t),a.v=e;var s=xa.ensure();if(s.capture(a,t),a.f&yt){const n=a;a.f&It&&Br(n),Fr(n)}a.wv=Ko(),Co(a,It),Ne!==null&&Ne.f&Tt&&!(Ne.f&(Na|gs))&&(Wt===null?jc([a]):Wt.push(a)),!s.is_fork&&dr.size>0&&!Ao&&Oc()}return e}function Oc(){Ao=!1;var a=hs;xn(!0);const e=Array.from(dr);try{for(const t of e)t.f&Tt&&st(t,qa),pn(t)&&rn(t)}finally{xn(a)}dr.clear()}function ni(a,e=1){var t=i(a),s=e===1?t++:t--;return _(a,t),s}function tn(a){_(a,a.v+1)}function Co(a,e){var t=a.reactions;if(t!==null)for(var s=t.length,n=0;n<s;n++){var r=t[n],o=r.f,c=(o&It)===0;if(c&&st(r,e),o&yt){var l=r;vt==null||vt.delete(l),o&ps||(o&Zt&&(r.f|=ps),Co(l,qa))}else c&&(o&Ma&&ra!==null&&ra.add(r),Ia(r))}}function ke(a){if(typeof a!="object"||a===null||us in a)return a;const e=ro(a);if(e!==Ul&&e!==Pl)return a;var t=new Map,s=Nr(a),n=Q(0),r=fs,o=c=>{if(fs===r)return c();var l=De,u=fs;Mt(null),ci(r);var h=c();return Mt(l),ci(u),h};return s&&t.set("length",Q(a.length)),new Proxy(a,{defineProperty(c,l,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&$l();var h=t.get(l);return h===void 0?h=o(()=>{var y=Q(u.value);return t.set(l,y),y}):_(h,u.value,!0),!0},deleteProperty(c,l){var u=t.get(l);if(u===void 0){if(l in c){const h=o(()=>Q(ft));t.set(l,h),tn(n)}}else _(u,ft),tn(n);return!0},get(c,l,u){var p;if(l===us)return a;var h=t.get(l),y=l in c;if(h===void 0&&(!y||(p=Is(c,l))!=null&&p.writable)&&(h=o(()=>{var k=ke(y?c[l]:ft),g=Q(k);return g}),t.set(l,h)),h!==void 0){var v=i(h);return v===ft?void 0:v}return Reflect.get(c,l,u)},getOwnPropertyDescriptor(c,l){var u=Reflect.getOwnPropertyDescriptor(c,l);if(u&&"value"in u){var h=t.get(l);h&&(u.value=i(h))}else if(u===void 0){var y=t.get(l),v=y==null?void 0:y.v;if(y!==void 0&&v!==ft)return{enumerable:!0,configurable:!0,value:v,writable:!0}}return u},has(c,l){var v;if(l===us)return!0;var u=t.get(l),h=u!==void 0&&u.v!==ft||Reflect.has(c,l);if(u!==void 0||Ne!==null&&(!h||(v=Is(c,l))!=null&&v.writable)){u===void 0&&(u=o(()=>{var p=h?ke(c[l]):ft,k=Q(p);return k}),t.set(l,u));var y=i(u);if(y===ft)return!1}return h},set(c,l,u,h){var S;var y=t.get(l),v=l in c;if(s&&l==="length")for(var p=u;p<y.v;p+=1){var k=t.get(p+"");k!==void 0?_(k,ft):p in c&&(k=o(()=>Q(ft)),t.set(p+"",k))}if(y===void 0)(!v||(S=Is(c,l))!=null&&S.writable)&&(y=o(()=>Q(void 0)),_(y,ke(u)),t.set(l,y));else{v=y.v!==ft;var g=o(()=>ke(u));_(y,g)}var m=Reflect.getOwnPropertyDescriptor(c,l);if(m!=null&&m.set&&m.set.call(h,u),!v){if(s&&typeof l=="string"){var b=t.get("length"),D=Number(l);Number.isInteger(D)&&D>=b.v&&_(b,D+1)}tn(n)}return!0},ownKeys(c){i(n);var l=Reflect.ownKeys(c).filter(y=>{var v=t.get(y);return v===void 0||v.v!==ft});for(var[u,h]of t)h.v!==ft&&!(u in c)&&l.push(u);return l},setPrototypeOf(){Zl()}})}function ri(a){try{if(a!==null&&typeof a=="object"&&us in a)return a[us]}catch{}return a}function Mc(a,e){return Object.is(ri(a),ri(e))}var ii,Io,Oo,Mo;function Nc(){if(ii===void 0){ii=window,Io=/Firefox/.test(navigator.userAgent);var a=Element.prototype,e=Node.prototype,t=Text.prototype;Oo=Is(e,"firstChild").get,Mo=Is(e,"nextSibling").get,ti(a)&&(a.__click=void 0,a.__className=void 0,a.__attributes=null,a.__style=void 0,a.__e=void 0),ti(t)&&(t.__t=void 0)}}function Ca(a=""){return document.createTextNode(a)}function Ha(a){return Oo.call(a)}function vn(a){return Mo.call(a)}function d(a,e){return Ha(a)}function Re(a,e=!1){{var t=Ha(a);return t instanceof Comment&&t.data===""?vn(t):t}}function f(a,e=1,t=!1){let s=a;for(;e--;)s=vn(s);return s}function qc(a){a.textContent=""}function No(){return!1}let oi=!1;function Rc(){oi||(oi=!0,document.addEventListener("reset",a=>{Promise.resolve().then(()=>{var e;if(!a.defaultPrevented)for(const t of a.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function jn(a){var e=De,t=Ne;Mt(null),_a(null);try{return a()}finally{Mt(e),_a(t)}}function Ur(a,e,t,s=t){a.addEventListener(e,()=>jn(t));const n=a.__on_r;n?a.__on_r=()=>{n(),s(!0)}:a.__on_r=()=>s(!0),Rc()}function Lc(a){Ne===null&&(De===null&&Vl(),Gl()),Qa&&Wl()}function Fc(a,e){var t=e.last;t===null?e.last=e.first=a:(t.next=a,a.prev=t,e.last=a)}function Ra(a,e,t){var s=Ne;s!==null&&s.f&jt&&(a|=jt);var n={ctx:qt,deps:null,nodes:null,f:a|It|Zt,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{rn(n),n.f|=Rr}catch(c){throw Nt(n),c}else e!==null&&Ia(n);var r=n;if(t&&r.deps===null&&r.teardown===null&&r.nodes===null&&r.first===r.last&&!(r.f&Hs)&&(r=r.first,a&Ma&&a&Us&&r!==null&&(r.f|=Us)),r!==null&&(r.parent=s,s!==null&&Fc(r,s),De!==null&&De.f&yt&&!(a&gs))){var o=De;(o.effects??(o.effects=[])).push(r)}return n}function Pr(){return De!==null&&!la}function jr(a){const e=Ra(Bn,null,!1);return st(e,Tt),e.teardown=a,e}function kt(a){Lc();var e=Ne.f,t=!De&&(e&Na)!==0&&(e&Rr)===0;if(t){var s=qt;(s.e??(s.e=[])).push(a)}else return qo(a)}function qo(a){return Ra(Dn|zl,a,!1)}function Bc(a){xa.ensure();const e=Ra(gs|Hs,a,!0);return(t={})=>new Promise(s=>{t.outro?ds(e,()=>{Nt(e),s(void 0)}):(Nt(e),s(void 0))})}function Ro(a){return Ra(Dn,a,!1)}function Uc(a){return Ra(Lr|Hs,a,!0)}function zn(a,e=0){return Ra(Bn|e,a,!0)}function H(a,e=[],t=[],s=[]){Ec(s,e,t,n=>{Ra(Bn,()=>a(...n.map(i)),!0)})}function zr(a,e=0){var t=Ra(Ma|e,a,!0);return t}function Xt(a){return Ra(Na|Hs,a,!0)}function Lo(a){var e=a.teardown;if(e!==null){const t=Qa,s=De;li(!0),Mt(null);try{e.call(null)}finally{li(t),Mt(s)}}}function Fo(a,e=!1){var t=a.first;for(a.first=a.last=null;t!==null;){const n=t.ac;n!==null&&jn(()=>{n.abort(As)});var s=t.next;t.f&gs?t.parent=null:Nt(t,e),t=s}}function Pc(a){for(var e=a.first;e!==null;){var t=e.next;e.f&Na||Nt(e),e=t}}function Nt(a,e=!0){var t=!1;(e||a.f&co)&&a.nodes!==null&&a.nodes.end!==null&&(Bo(a.nodes.start,a.nodes.end),t=!0),Fo(a,e&&!t),An(a,0),st(a,Aa);var s=a.nodes&&a.nodes.t;if(s!==null)for(const r of s)r.stop();Lo(a);var n=a.parent;n!==null&&n.first!==null&&Uo(a),a.next=a.prev=a.teardown=a.ctx=a.deps=a.fn=a.nodes=a.ac=null}function Bo(a,e){for(;a!==null;){var t=a===e?null:vn(a);a.remove(),a=t}}function Uo(a){var e=a.parent,t=a.prev,s=a.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===a&&(e.first=s),e.last===a&&(e.last=t))}function ds(a,e,t=!0){var s=[];Po(a,s,!0);var n=()=>{t&&Nt(a),e&&e()},r=s.length;if(r>0){var o=()=>--r||n();for(var c of s)c.out(o)}else n()}function Po(a,e,t){if(!(a.f&jt)){a.f^=jt;var s=a.nodes&&a.nodes.t;if(s!==null)for(const c of s)(c.is_global||t)&&e.push(c);for(var n=a.first;n!==null;){var r=n.next,o=(n.f&Us)!==0||(n.f&Na)!==0&&(a.f&Ma)!==0;Po(n,e,o?t:!1),n=r}}}function Yr(a){jo(a,!0)}function jo(a,e){if(a.f&jt){a.f^=jt,a.f&Tt||(st(a,It),Ia(a));for(var t=a.first;t!==null;){var s=t.next,n=(t.f&Us)!==0||(t.f&Na)!==0;jo(t,n?e:!1),t=s}var r=a.nodes&&a.nodes.t;if(r!==null)for(const o of r)(o.is_global||e)&&o.in()}}function zo(a,e){if(a.nodes)for(var t=a.nodes.start,s=a.nodes.end;t!==null;){var n=t===s?null:vn(t);e.append(t),t=n}}let hs=!1;function xn(a){hs=a}let Qa=!1;function li(a){Qa=a}let De=null,la=!1;function Mt(a){De=a}let Ne=null;function _a(a){Ne=a}let Ct=null;function Yo(a){De!==null&&(Ct===null?Ct=[a]:Ct.push(a))}let xt=null,Bt=0,Wt=null;function jc(a){Wt=a}let Ho=1,nn=0,fs=nn;function ci(a){fs=a}function Ko(){return++Ho}function pn(a){var e=a.f;if(e&It)return!0;if(e&yt&&(a.f&=~ps),e&qa){for(var t=a.deps,s=t.length,n=0;n<s;n++){var r=t[n];if(pn(r)&&xo(r),r.wv>a.wv)return!0}e&Zt&&vt===null&&st(a,Tt)}return!1}function Wo(a,e,t=!0){var s=a.reactions;if(s!==null&&!(Ct!=null&&Ct.includes(a)))for(var n=0;n<s.length;n++){var r=s[n];r.f&yt?Wo(r,e,!1):e===r&&(t?st(r,It):r.f&Tt&&st(r,qa),Ia(r))}}function Go(a){var k;var e=xt,t=Bt,s=Wt,n=De,r=Ct,o=qt,c=la,l=fs,u=a.f;xt=null,Bt=0,Wt=null,De=u&(Na|gs)?null:a,Ct=null,Ps(a.ctx),la=!1,fs=++nn,a.ac!==null&&(jn(()=>{a.ac.abort(As)}),a.ac=null);try{a.f|=rr;var h=a.fn,y=h(),v=a.deps;if(xt!==null){var p;if(An(a,Bt),v!==null&&Bt>0)for(v.length=Bt+xt.length,p=0;p<xt.length;p++)v[Bt+p]=xt[p];else a.deps=v=xt;if(Pr()&&a.f&Zt)for(p=Bt;p<v.length;p++)((k=v[p]).reactions??(k.reactions=[])).push(a)}else v!==null&&Bt<v.length&&(An(a,Bt),v.length=Bt);if(po()&&Wt!==null&&!la&&v!==null&&!(a.f&(yt|qa|It)))for(p=0;p<Wt.length;p++)Wo(Wt[p],a);return n!==null&&n!==a&&(nn++,Wt!==null&&(s===null?s=Wt:s.push(...Wt))),a.f&Ga&&(a.f^=Ga),y}catch(g){return mo(g)}finally{a.f^=rr,xt=e,Bt=t,Wt=s,De=n,Ct=r,Ps(o),la=c,fs=l}}function zc(a,e){let t=e.reactions;if(t!==null){var s=Ll.call(t,a);if(s!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[s]=t[n],t.pop())}}if(t===null&&e.f&yt&&(xt===null||!xt.includes(e))){var r=e;r.f&Zt&&(r.f^=Zt,r.f&=~ps),Fr(r),Eo(r),An(r,0)}}function An(a,e){var t=a.deps;if(t!==null)for(var s=e;s<t.length;s++)zc(a,t[s])}function rn(a){var e=a.f;if(!(e&Aa)){st(a,Tt);var t=Ne,s=hs;Ne=a,hs=!0;try{e&(Ma|lo)?Pc(a):Fo(a),Lo(a);var n=Go(a);a.teardown=typeof n=="function"?n:null,a.wv=Ho;var r;nr&&pc&&a.f&It&&a.deps}finally{hs=s,Ne=t}}}async function Vo(){await Promise.resolve(),gc()}function i(a){var e=a.f,t=(e&yt)!==0;if(De!==null&&!la){var s=Ne!==null&&(Ne.f&Aa)!==0;if(!s&&!(Ct!=null&&Ct.includes(a))){var n=De.deps;if(De.f&rr)a.rv<nn&&(a.rv=nn,xt===null&&n!==null&&n[Bt]===a?Bt++:xt===null?xt=[a]:xt.includes(a)||xt.push(a));else{(De.deps??(De.deps=[])).push(a);var r=a.reactions;r===null?a.reactions=[De]:r.includes(De)||r.push(De)}}}if(Qa&&Va.has(a))return Va.get(a);if(t){var o=a;if(Qa){var c=o.v;return(!(o.f&Tt)&&o.reactions!==null||Xo(o))&&(c=Br(o)),Va.set(o,c),c}var l=(o.f&Zt)===0&&!la&&De!==null&&(hs||(De.f&Zt)!==0),u=o.deps===null;pn(o)&&(l&&(o.f|=Zt),xo(o)),l&&!u&&Qo(o)}if(vt!=null&&vt.has(a))return vt.get(a);if(a.f&Ga)throw a.v;return a.v}function Qo(a){if(a.deps!==null){a.f|=Zt;for(const e of a.deps)(e.reactions??(e.reactions=[])).push(a),e.f&yt&&!(e.f&Zt)&&Qo(e)}}function Xo(a){if(a.v===ft)return!0;if(a.deps===null)return!1;for(const e of a.deps)if(Va.has(e)||e.f&yt&&Xo(e))return!0;return!1}function _s(a){var e=la;try{return la=!0,a()}finally{la=e}}const Yc=["touchstart","touchmove"];function Hc(a){return Yc.includes(a)}const $o=new Set,hr=new Set;function Kc(a,e,t,s={}){function n(r){if(s.capture||Xs.call(e,r),!r.cancelBubble)return jn(()=>t==null?void 0:t.call(this,r))}return a.startsWith("pointer")||a.startsWith("touch")||a==="wheel"?Ks(()=>{e.addEventListener(a,n,s)}):e.addEventListener(a,n,s),n}function pt(a,e,t,s,n){var r={capture:s,passive:n},o=Kc(a,e,t,r);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&jr(()=>{e.removeEventListener(a,o,r)})}function nt(a){for(var e=0;e<a.length;e++)$o.add(a[e]);for(var t of hr)t(a)}let ui=null;function Xs(a){var m;var e=this,t=e.ownerDocument,s=a.type,n=((m=a.composedPath)==null?void 0:m.call(a))||[],r=n[0]||a.target;ui=a;var o=0,c=ui===a&&a.__root;if(c){var l=n.indexOf(c);if(l!==-1&&(e===document||e===window)){a.__root=e;return}var u=n.indexOf(e);if(u===-1)return;l<=u&&(o=l)}if(r=n[o]||a.target,r!==e){Fl(a,"currentTarget",{configurable:!0,get(){return r||t}});var h=De,y=Ne;Mt(null),_a(null);try{for(var v,p=[];r!==null;){var k=r.assignedSlot||r.parentNode||r.host||null;try{var g=r["__"+s];g!=null&&(!r.disabled||a.target===r)&&g.call(r,a)}catch(b){v?p.push(b):v=b}if(a.cancelBubble||k===e||k===null)break;r=k}if(v){for(let b of p)queueMicrotask(()=>{throw b});throw v}}finally{a.__root=e,delete a.currentTarget,Mt(h),_a(y)}}}function Zo(a){var e=document.createElement("template");return e.innerHTML=a.replaceAll("<!>","<!---->"),e.content}function on(a,e){var t=Ne;t.nodes===null&&(t.nodes={start:a,end:e,a:null,t:null})}function I(a,e){var t=(e&cc)!==0,s=(e&uc)!==0,n,r=!a.startsWith("<!>");return()=>{n===void 0&&(n=Zo(r?a:"<!>"+a),t||(n=Ha(n)));var o=s||Io?document.importNode(n,!0):n.cloneNode(!0);if(t){var c=Ha(o),l=o.lastChild;on(c,l)}else on(o,o);return o}}function Os(a=""){{var e=Ca(a+"");return on(e,e),e}}function Ye(){var a=document.createDocumentFragment(),e=document.createComment(""),t=Ca();return a.append(e,t),on(e,t),a}function w(a,e){a!==null&&a.before(e)}function j(a,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(a.__t??(a.__t=a.nodeValue))&&(a.__t=t,a.nodeValue=t+"")}function Gn(a,e){return Wc(a,e)}const Ss=new Map;function Wc(a,{target:e,anchor:t,props:s={},events:n,context:r,intro:o=!0}){Nc();var c=new Set,l=y=>{for(var v=0;v<y.length;v++){var p=y[v];if(!c.has(p)){c.add(p);var k=Hc(p);e.addEventListener(p,Xs,{passive:k});var g=Ss.get(p);g===void 0?(document.addEventListener(p,Xs,{passive:k}),Ss.set(p,1)):Ss.set(p,g+1)}}};l(Fn($o)),hr.add(l);var u=void 0,h=Bc(()=>{var y=t??e.appendChild(Ca());return wc(y,{pending:()=>{}},v=>{if(r){Qe({});var p=qt;p.c=r}n&&(s.$$events=n),u=a(v,s)||{},r&&Xe()}),()=>{var k;for(var v of c){e.removeEventListener(v,Xs);var p=Ss.get(v);--p===0?(document.removeEventListener(v,Xs),Ss.delete(v)):Ss.set(v,p)}hr.delete(l),y!==t&&((k=y.parentNode)==null||k.removeChild(y))}});return fr.set(u,h),u}let fr=new WeakMap;function Vn(a,e){const t=fr.get(a);return t?(fr.delete(a),t(e)):Promise.resolve()}var ia,ma,Ut,cs,hn,fn,Ln;class Gc{constructor(e,t=!0){A(this,"anchor");Ae(this,ia,new Map);Ae(this,ma,new Map);Ae(this,Ut,new Map);Ae(this,cs,new Set);Ae(this,hn,!0);Ae(this,fn,()=>{var e=Se;if(O(this,ia).has(e)){var t=O(this,ia).get(e),s=O(this,ma).get(t);if(s)Yr(s),O(this,cs).delete(t);else{var n=O(this,Ut).get(t);n&&(O(this,ma).set(t,n.effect),O(this,Ut).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[r,o]of O(this,ia)){if(O(this,ia).delete(r),r===e)break;const c=O(this,Ut).get(o);c&&(Nt(c.effect),O(this,Ut).delete(o))}for(const[r,o]of O(this,ma)){if(r===t||O(this,cs).has(r))continue;const c=()=>{if(Array.from(O(this,ia).values()).includes(r)){var u=document.createDocumentFragment();zo(o,u),u.append(Ca()),O(this,Ut).set(r,{effect:o,fragment:u})}else Nt(o);O(this,cs).delete(r),O(this,ma).delete(r)};O(this,hn)||!s?(O(this,cs).add(r),ds(o,c,!1)):c()}}});Ae(this,Ln,e=>{O(this,ia).delete(e);const t=Array.from(O(this,ia).values());for(const[s,n]of O(this,Ut))t.includes(s)||(Nt(n.effect),O(this,Ut).delete(s))});this.anchor=e,Ee(this,hn,t)}ensure(e,t){var s=Se,n=No();if(t&&!O(this,ma).has(e)&&!O(this,Ut).has(e))if(n){var r=document.createDocumentFragment(),o=Ca();r.append(o),O(this,Ut).set(e,{effect:Xt(()=>t(o)),fragment:r})}else O(this,ma).set(e,Xt(()=>t(this.anchor)));if(O(this,ia).set(s,e),n){for(const[c,l]of O(this,ma))c===e?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[c,l]of O(this,Ut))c===e?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(O(this,fn)),s.ondiscard(O(this,Ln))}else O(this,fn).call(this)}}ia=new WeakMap,ma=new WeakMap,Ut=new WeakMap,cs=new WeakMap,hn=new WeakMap,fn=new WeakMap,Ln=new WeakMap;function K(a,e,t=!1){var s=new Gc(a),n=t?Us:0;function r(o,c){s.ensure(o,c)}zr(()=>{var o=!1;e((c,l=!0)=>{o=!0,r(l,c)}),o||r(!1,null)},n)}function wt(a,e){return e}function Vc(a,e,t){for(var s=[],n=e.length,r,o=e.length,c=0;c<n;c++){let y=e[c];ds(y,()=>{if(r){if(r.pending.delete(y),r.done.add(y),r.pending.size===0){var v=a.outrogroups;vr(Fn(r.done)),v.delete(r),v.size===0&&(a.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=s.length===0&&t!==null;if(l){var u=t,h=u.parentNode;qc(h),h.append(u),a.items.clear()}vr(e,!l)}else r={pending:new Set(e),done:new Set},(a.outrogroups??(a.outrogroups=new Set)).add(r)}function vr(a,e=!0){for(var t=0;t<a.length;t++)Nt(a[t],e)}var di;function Be(a,e,t,s,n,r=null){var o=a,c=new Map,l=(e&ho)!==0;if(l){var u=a;o=u.appendChild(Ca())}var h=null,y=Do(()=>{var b=t();return Nr(b)?b:b==null?[]:Fn(b)}),v,p=!0;function k(){m.fallback=h,Qc(m,v,o,e,s),h!==null&&(v.length===0?h.f&Ea?(h.f^=Ea,$s(h,null,o)):Yr(h):ds(h,()=>{h=null}))}var g=zr(()=>{v=i(y);for(var b=v.length,D=new Set,S=Se,x=No(),L=0;L<b;L+=1){var U=v[L],M=s(U,L),q=p?null:c.get(M);q?(q.v&&zs(q.v,U),q.i&&zs(q.i,L),x&&S.skipped_effects.delete(q.e)):(q=Xc(c,p?o:di??(di=Ca()),U,M,L,n,e,t),p||(q.e.f|=Ea),c.set(M,q)),D.add(M)}if(b===0&&r&&!h&&(p?h=Xt(()=>r(o)):(h=Xt(()=>r(di??(di=Ca()))),h.f|=Ea)),!p)if(x){for(const[P,W]of c)D.has(P)||S.skipped_effects.add(W.e);S.oncommit(k),S.ondiscard(()=>{})}else k();i(y)}),m={effect:g,items:c,outrogroups:null,fallback:h};p=!1}function Qc(a,e,t,s,n){var W,J,se,oe,ve,ce,z,C,F;var r=(s&sc)!==0,o=e.length,c=a.items,l=a.effect.first,u,h=null,y,v=[],p=[],k,g,m,b;if(r)for(b=0;b<o;b+=1)k=e[b],g=n(k,b),m=c.get(g).e,m.f&Ea||((J=(W=m.nodes)==null?void 0:W.a)==null||J.measure(),(y??(y=new Set)).add(m));for(b=0;b<o;b+=1){if(k=e[b],g=n(k,b),m=c.get(g).e,a.outrogroups!==null)for(const ee of a.outrogroups)ee.pending.delete(m),ee.done.delete(m);if(m.f&Ea)if(m.f^=Ea,m===l)$s(m,null,t);else{var D=h?h.next:l;m===a.effect.last&&(a.effect.last=m.prev),m.prev&&(m.prev.next=m.next),m.next&&(m.next.prev=m.prev),Ba(a,h,m),Ba(a,m,D),$s(m,D,t),h=m,v=[],p=[],l=h.next;continue}if(m.f&jt&&(Yr(m),r&&((oe=(se=m.nodes)==null?void 0:se.a)==null||oe.unfix(),(y??(y=new Set)).delete(m))),m!==l){if(u!==void 0&&u.has(m)){if(v.length<p.length){var S=p[0],x;h=S.prev;var L=v[0],U=v[v.length-1];for(x=0;x<v.length;x+=1)$s(v[x],S,t);for(x=0;x<p.length;x+=1)u.delete(p[x]);Ba(a,L.prev,U.next),Ba(a,h,L),Ba(a,U,S),l=S,h=U,b-=1,v=[],p=[]}else u.delete(m),$s(m,l,t),Ba(a,m.prev,m.next),Ba(a,m,h===null?a.effect.first:h.next),Ba(a,h,m),h=m;continue}for(v=[],p=[];l!==null&&l!==m;)(u??(u=new Set)).add(l),p.push(l),l=l.next;if(l===null)continue}m.f&Ea||v.push(m),h=m,l=m.next}if(a.outrogroups!==null){for(const ee of a.outrogroups)ee.pending.size===0&&(vr(Fn(ee.done)),(ve=a.outrogroups)==null||ve.delete(ee));a.outrogroups.size===0&&(a.outrogroups=null)}if(l!==null||u!==void 0){var M=[];if(u!==void 0)for(m of u)m.f&jt||M.push(m);for(;l!==null;)!(l.f&jt)&&l!==a.fallback&&M.push(l),l=l.next;var q=M.length;if(q>0){var P=s&ho&&o===0?t:null;if(r){for(b=0;b<q;b+=1)(z=(ce=M[b].nodes)==null?void 0:ce.a)==null||z.measure();for(b=0;b<q;b+=1)(F=(C=M[b].nodes)==null?void 0:C.a)==null||F.fix()}Vc(a,M,P)}}r&&Ks(()=>{var ee,te;if(y!==void 0)for(m of y)(te=(ee=m.nodes)==null?void 0:ee.a)==null||te.apply()})}function Xc(a,e,t,s,n,r,o,c){var l=o&tc?o&nc?ys(t):Ic(t,!1,!1):null,u=o&ac?ys(n):null;return{v:l,i:u,e:Xt(()=>(r(e,l??t,u??n,c),()=>{a.delete(s)}))}}function $s(a,e,t){if(a.nodes)for(var s=a.nodes.start,n=a.nodes.end,r=e&&!(e.f&Ea)?e.nodes.start:t;s!==null;){var o=vn(s);if(r.before(s),s===n)return;s=o}}function Ba(a,e,t){e===null?a.effect.first=t:e.next=t,t===null?a.effect.last=e:t.prev=e}function $c(a,e,t=!1,s=!1,n=!1){var r=a,o="";H(()=>{var c=Ne;if(o!==(o=e()??"")&&(c.nodes!==null&&(Bo(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var u=Zo(l);if((t||s)&&(u=Ha(u)),on(Ha(u),u.lastChild),t||s)for(;Ha(u);)r.before(Ha(u));else r.before(u)}})}function Jo(a){var e,t,s="";if(typeof a=="string"||typeof a=="number")s+=a;else if(typeof a=="object")if(Array.isArray(a)){var n=a.length;for(e=0;e<n;e++)a[e]&&(t=Jo(a[e]))&&(s&&(s+=" "),s+=t)}else for(t in a)a[t]&&(s&&(s+=" "),s+=t);return s}function Zc(){for(var a,e,t=0,s="",n=arguments.length;t<n;t++)(a=arguments[t])&&(e=Jo(a))&&(s&&(s+=" "),s+=e);return s}function Jc(a){return typeof a=="object"?Zc(a):a??""}const hi=[...` 	
\r\f¬†\v\uFEFF`];function eu(a,e,t){var s=a==null?"":""+a;if(e&&(s=s?s+" "+e:e),t){for(var n in t)if(t[n])s=s?s+" "+n:n;else if(s.length)for(var r=n.length,o=0;(o=s.indexOf(n,o))>=0;){var c=o+r;(o===0||hi.includes(s[o-1]))&&(c===s.length||hi.includes(s[c]))?s=(o===0?"":s.substring(0,o))+s.substring(c+1):o=c}}return s===""?null:s}function tu(a,e){return a==null?null:String(a)}function Pe(a,e,t,s,n,r){var o=a.__className;if(o!==t||o===void 0){var c=eu(t,s,r);c==null?a.removeAttribute("class"):a.className=c,a.__className=t}else if(r&&n!==r)for(var l in r){var u=!!r[l];(n==null||u!==!!n[l])&&a.classList.toggle(l,u)}return r}function vs(a,e,t,s){var n=a.__style;if(n!==e){var r=tu(e);r==null?a.removeAttribute("style"):a.style.cssText=r,a.__style=e}return s}function el(a,e,t=!1){if(a.multiple){if(e==null)return;if(!Nr(e))return hc();for(var s of a.options)s.selected=e.includes(an(s));return}for(s of a.options){var n=an(s);if(Mc(n,e)){s.selected=!0;return}}(!t||e!==void 0)&&(a.selectedIndex=-1)}function au(a){var e=new MutationObserver(()=>{el(a,a.__value)});e.observe(a,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),jr(()=>{e.disconnect()})}function pr(a,e,t=e){var s=new WeakSet,n=!0;Ur(a,"change",r=>{var o=r?"[selected]":":checked",c;if(a.multiple)c=[].map.call(a.querySelectorAll(o),an);else{var l=a.querySelector(o)??a.querySelector("option:not([disabled])");c=l&&an(l)}t(c),Se!==null&&s.add(Se)}),Ro(()=>{var r=e();if(a===document.activeElement){var o=Js??Se;if(s.has(o))return}if(el(a,r,n),n&&r===void 0){var c=a.querySelector(":checked");c!==null&&(r=an(c),t(r))}a.__value=r,n=!1}),au(a)}function an(a){return"__value"in a?a.__value:a.value}const su=Symbol("is custom element"),nu=Symbol("is html");function tl(a,e){var t=Hr(a);t.value===(t.value=e??void 0)||a.value===e&&(e!==0||a.nodeName!=="PROGRESS")||(a.value=e??"")}function Ms(a,e){var t=Hr(a);t.checked!==(t.checked=e??void 0)&&(a.checked=e)}function xe(a,e,t,s){var n=Hr(a);n[e]!==(n[e]=t)&&(e==="loading"&&(a[Hl]=t),t==null?a.removeAttribute(e):typeof t!="string"&&ru(a).includes(e)?a[e]=t:a.setAttribute(e,t))}function Hr(a){return a.__attributes??(a.__attributes={[su]:a.nodeName.includes("-"),[nu]:a.namespaceURI===dc})}var fi=new Map;function ru(a){var e=a.getAttribute("is")||a.nodeName,t=fi.get(e);if(t)return t;fi.set(e,t=[]);for(var s,n=a,r=Element.prototype;r!==n;){s=Bl(n);for(var o in s)s[o].set&&t.push(o);n=ro(n)}return t}function tt(a,e,t=e){var s=new WeakSet;Ur(a,"input",async n=>{var r=n?a.defaultValue:a.value;if(r=Qn(a)?Xn(r):r,t(r),Se!==null&&s.add(Se),await Vo(),r!==(r=e())){var o=a.selectionStart,c=a.selectionEnd,l=a.value.length;if(a.value=r??"",c!==null){var u=a.value.length;o===c&&c===l&&u>l?(a.selectionStart=u,a.selectionEnd=u):(a.selectionStart=o,a.selectionEnd=Math.min(c,u))}}}),_s(e)==null&&a.value&&(t(Qn(a)?Xn(a.value):a.value),Se!==null&&s.add(Se)),zn(()=>{var n=e();if(a===document.activeElement){var r=Js??Se;if(s.has(r))return}Qn(a)&&n===Xn(a.value)||a.type==="date"&&!n&&!a.value||n!==a.value&&(a.value=n??"")})}function al(a,e,t=e){Ur(a,"change",s=>{var n=s?a.defaultChecked:a.checked;t(n)}),_s(e)==null&&t(a.checked),zn(()=>{var s=e();a.checked=!!s})}function Qn(a){var e=a.type;return e==="number"||e==="range"}function Xn(a){return a===""?null:+a}function vi(a,e){return a===e||(a==null?void 0:a[us])===e}function ca(a={},e,t,s){return Ro(()=>{var n,r;return zn(()=>{n=r,r=(s==null?void 0:s())||[],_s(()=>{a!==t(...r)&&(e(a,...r),n&&vi(t(...n),a)&&e(null,...n))})}),()=>{Ks(()=>{r&&vi(t(...r),a)&&e(null,...r)})}}),a}let _n=!1;function iu(a){var e=_n;try{return _n=!1,[a(),_n]}finally{_n=e}}function Oa(a,e,t,s){var D;var n=(t&oc)!==0,r=(t&lc)!==0,o=s,c=!0,l=()=>(c&&(c=!1,o=r?_s(s):s),o),u;if(n){var h=us in a||Yl in a;u=((D=Is(a,e))==null?void 0:D.set)??(h&&e in a?S=>a[e]=S:void 0)}var y,v=!1;n?[y,v]=iu(()=>a[e]):y=a[e],y===void 0&&s!==void 0&&(y=l(),u&&(Xl(),u(y)));var p;if(p=()=>{var S=a[e];return S===void 0?l():(c=!0,S)},!(t&ic))return p;if(u){var k=a.$$legacy;return function(S,x){return arguments.length>0?((!x||k||v)&&u(x?p():S),S):p()}}var g=!1,m=(t&rc?Pn:Do)(()=>(g=!1,p()));n&&i(m);var b=Ne;return function(S,x){if(arguments.length>0){const L=x?i(m):n?ke(S):S;return _(m,L),g=!0,o!==void 0&&(o=L),S}return Qa&&g||b.f&Aa?m.v:i(m)}}function Yn(a){qt===null&&uo(),kt(()=>{const e=_s(a);if(typeof e=="function")return e})}function ou(a){qt===null&&uo(),Yn(()=>()=>_s(a))}const lu="5";var no;typeof window<"u"&&((no=window.__svelte??(window.__svelte={})).v??(no.v=new Set)).add(lu);function cu(){return{type:"daily",interval:1,time:"09:00"}}function sl(a){return!a||!a.type||!a.interval||a.interval<1?!1:a.type==="weekly"?Array.isArray(a.weekdays)&&a.weekdays.length>0&&a.weekdays.every(e=>e>=0&&e<=6):a.type==="monthly"?a.dayOfMonth>=1&&a.dayOfMonth<=31:a.type==="yearly"?a.month>=0&&a.month<=11&&a.dayOfMonth>=1&&a.dayOfMonth<=31:!0}const as="recurring-tasks-active",wn="recurring-tasks-archive",pi="recurring-tasks",yi="recurring-tasks.json.bak",mi="n8n-event-settings",gi="n8n-event-queue",uu="notification-state",du="recurring-tasks-dock",_i="scheduler-emitted-occurrences",Ua=4,yr={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},Kr=60*1e3,hu=30*1e3,$n=2e3,bi="shehab-note-recurring-plugin",ki="1.0.0",fu=60*60*1e3,vu=3,wi=10,Zn=1e3,Tn=100,Ti=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],pu={lowest:"#94a3b8",low:"#64748b",normal:"#3b82f6",medium:"#f59e0b",high:"#f97316",highest:"#ef4444"},yu=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Si="last-run-timestamp",Di="custom-recurring-task-id",Ei="custom-recurring-task-due",xi="custom-recurring-task-enabled";function nl(a,e,t){const s=new Date().toISOString(),n=t||new Date;return{id:rl(),name:a,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:Ua,createdAt:s,updatedAt:s}}const mu=["lowest","low","normal","medium","high","highest"];function ln(a){if(!a)return;const e=a.toLowerCase();if(e==="urgent")return"highest";if(e==="none")return"normal";if(mu.includes(e))return e}function rl(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function il(a,e={}){const t=new Date().toISOString();return{...{...a,id:rl(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function gu(a){const e=new Date().toISOString();a.completionCount=(a.completionCount||0)+1,a.currentStreak=(a.currentStreak||0)+1,a.bestStreak=Math.max(a.bestStreak||0,a.currentStreak),a.recentCompletions||(a.recentCompletions=[]),a.recentCompletions.push(e),a.recentCompletions.length>wi&&(a.recentCompletions=a.recentCompletions.slice(-wi)),a.snoozeCount=0,a.lastCompletedAt=e,a.updatedAt=e}function ol(a){a.missCount=(a.missCount||0)+1,a.currentStreak=0,a.updatedAt=new Date().toISOString()}function ll(a){const e=a.completionCount||0,t=a.missCount||0,s=e+t;if(s===0)return 100;let r=e/s*70;const o=a.currentStreak||0,c=Math.min(30,o*3);return r+=c,Math.round(Math.min(100,r))}function _u(a,e){const t=new Set([...a.blockedBy??[],...a.dependsOn??[]]);return t.size===0?!1:e.filter(n=>t.has(n.id)).some(n=>cl(n))}function bu(a,e){return e.some(t=>t.id===a.id||!new Set([...t.blockedBy??[],...t.dependsOn??[]]).has(a.id)?!1:cl(t))}function cl(a){return a.status?a.status==="todo":a.enabled}function ss(a){const{message:e,type:t="info",duration:s=3e3,actionLabel:n,onAction:r,showCountdown:o=!1}=a,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let u=null;if(n&&r){const y=document.createElement("button");y.type="button";let v=Math.max(1,Math.ceil(s/1e3));y.textContent=o?`${n} (${v}s)`:n,y.className="recurring-tasks-toast__action",y.addEventListener("click",()=>{r(),u!==null&&window.clearInterval(u),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(y),o&&s>0&&(u=window.setInterval(()=>{v=Math.max(0,v-1),y.textContent=`${n} (${v}s)`,v<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:ku(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const h=()=>{u!==null&&window.clearInterval(u),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};s>0&&setTimeout(()=>{h()},s)}function ku(a){switch(a){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const Z={success:(a,e)=>ss({message:a,type:"success",duration:e}),error:(a,e)=>ss({message:a,type:"error",duration:e}),warning:(a,e)=>ss({message:a,type:"warning",duration:e}),info:(a,e)=>ss({message:a,type:"info",duration:e})};if(typeof document<"u"){const a=document.createElement("style");a.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(a)}class wu{constructor(){A(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(n=>n(t))}clear(){this.handlers.clear()}}const Ge=new wu;function Jn(a,e){const t=a.findIndex(n=>n.id===e.id);if(t===-1)return[...a,e];const s=[...a];return s[t]=e,s}function Ai(a,e){const t=a.filter(s=>s.id!==e);return t.length===a.length?a:t}function er(a,e,t){let s=!1;const n=a.map(r=>r.id!==e?r:(s=!0,t(r)));return s?n:a}function Tu(a,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),a.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const Su=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function Hn(a,e,t){const s={timestamp:new Date().toISOString()},n=`[${a.toUpperCase()}] [${s.timestamp}]`;a==="error"?console.error(n,e,t||""):a==="warn"?console.warn(n,e,t||""):a==="debug"&&Su?console.debug(n,e,t||""):a==="info"&&console.log(n,e,t||"")}function ul(a,e){Hn("debug",a,e)}function he(a,e){Hn("info",a,e)}function Ve(a,e){Hn("warn",a,e)}function _e(a,e){Hn("error",a,e)}async function Du(a){return new Promise(e=>{try{Mr.fetchPost("/api/block/getBlockInfo",{id:a},t=>{var n,r,o;const s=((n=t==null?void 0:t.data)==null?void 0:n.content)??((r=t==null?void 0:t.data)==null?void 0:r.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){Ve("Failed to fetch block preview",t),e(null)}})}async function Eu(a){return new Promise(e=>{try{Mr.fetchPost("/api/block/getBlockHTML",{id:a},t=>{var n;const s=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(s?s.trim():null)})}catch(t){Ve("Failed to fetch block embed",t),e(null)}})}function mr(a){const[e,t]=a.split(":").map(Number);return{hours:e,minutes:t}}function xu(a){const e=a.getHours().toString().padStart(2,"0"),t=a.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function Au(a){return a.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function gr(a){return a.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Wr(a){const e=new Date;return a.getDate()===e.getDate()&&a.getMonth()===e.getMonth()&&a.getFullYear()===e.getFullYear()}function Cu(a){return a<new Date}function Iu(a){return Cu(a)&&!Wr(a)}function cn(a,e){const t=new Date(a);return t.setDate(t.getDate()+e),t}function Ci(a,e){return cn(a,e*7)}function Ii(a,e,t){const s=new Date(a);s.setHours(e,t,0,0);const n=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:n}}function _r(a){const e=new Date(a);return e.setHours(0,0,0,0),e}function Ou(a){const e=new Date(a);return e.setHours(23,59,59,999),e}function Mu(a,e){const s=Math.abs(e.getTime()-a.getTime());return Math.floor(s/864e5)}function Nu(a,e){const t=[];for(let s=0;s<e;s++)t.push(cn(a,s));return t}var qu=I('<span class="task-card__streak svelte-yjw1ud"> </span>'),Ru=I('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),Lu=I('<span class="task-card__relative svelte-yjw1ud"> </span>'),Fu=I('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),Bu=I('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),Uu=I('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),Pu=I('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),ju=I('<button class="task-card__snooze-chip"> </button>'),zu=I('<button class="task-card__snooze-option" role="menuitem"> </button>'),Yu=I('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),Hu=I('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">üïí Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function Ws(a,e){Qe(e,!0);const t=$(()=>new Date(e.task.dueAt)),s=$(()=>Iu(i(t))),n=$(()=>Wr(i(t))),r=$(()=>i(s)?Mu(new Date(e.task.dueAt),new Date):0),o=$(()=>i(s)?"task-card--overdue":i(n)?"task-card--today":""),c=$(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+i(r)*.05)})`:""),l=$(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+i(r)*.08)})`:""),u=$(()=>()=>{const ae=ln(e.task.priority)||"normal";return pu[ae]}),h=$(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(i(t)):""),y=$(()=>(e.task.currentStreak||0)>0),v=$(()=>()=>"üî•"),p=$(()=>ll(e.task)),k=$(()=>i(p)>=80?"health--good":i(p)>=50?"health--fair":"health--poor");let g=Q(!1),m=Q(-1),b=[],D=Q(!1),S=Q(null),x=Q(null),L=Q(!1);const U=$(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),M=$(()=>()=>{if(!i(S))return"";const ae=i(S).replace(/\s+/g," ").trim();return ae.length>220?`${ae.slice(0,220)}‚Ä¶`:ae}),q=$(()=>()=>Ti.filter(ae=>[15,60,120].includes(ae.minutes))),P=$(()=>()=>`snooze-menu-${e.task.id}`);kt(()=>{_(S,e.task.linkedBlockContent??null,!0),_(x,null),_(L,!1)});function W(){e.onDone(e.task)}function J(){e.onDelay(e.task)}function se(){e.onEdit&&e.onEdit(e.task)}function oe(){e.onSkip(e.task)}async function ve(){_(g,!i(g)),i(g)&&(await Vo(),_(m,-1),b=[])}function ce(ae){const ge=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ae}});window.dispatchEvent(ge),_(g,!1),_(m,-1)}function z(ae){var Ce,Ke,mt,ct;const ge=i(q);ae.key==="ArrowDown"?(ae.preventDefault(),_(m,Math.min(i(m)+1,ge.length-1),!0),(Ce=b[i(m)])==null||Ce.focus()):ae.key==="ArrowUp"?(ae.preventDefault(),_(m,Math.max(i(m)-1,0),!0),(Ke=b[i(m)])==null||Ke.focus()):ae.key==="Escape"?(_(g,!1),_(m,-1)):ae.key==="Home"?(ae.preventDefault(),_(m,0),(mt=b[0])==null||mt.focus()):ae.key==="End"&&(ae.preventDefault(),_(m,ge.length-1),(ct=b[i(m)])==null||ct.focus())}function C(ae){if(ae.key==="Escape"&&i(g)){_(g,!1);return}(ae.key==="Enter"||ae.key===" ")&&(ae.preventDefault(),ve())}async function F(){if(_(D,!0),!e.task.linkedBlockId||i(L)||i(x))return;_(L,!0);const[ae,ge]=await Promise.all([Eu(e.task.linkedBlockId),Du(e.task.linkedBlockId)]);_(x,ae,!0),_(S,ge,!0),_(L,!1)}function ee(){_(D,!1)}const te=$(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,ge=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[ge]||ge)}`);var ue=Hu();ue.__keydown=ae=>{ae.key==="Escape"&&i(g)&&_(g,!1)};var de=d(ue),me=d(de),ne=d(me),fe=f(ne,2),Y=d(fe),G=f(fe,2);{var ie=ae=>{var ge=qu(),Ce=d(ge);H(Ke=>{xe(ge,"title",`${e.task.currentStreak??""} day streak`),j(Ce,`${Ke??""} ${e.task.currentStreak??""}`)},[()=>i(v)()]),w(ae,ge)};K(G,ae=>{i(y)&&ae(ie)})}var T=f(me,2);{var R=ae=>{var ge=Ru();ge.__click=se,w(ae,ge)};K(T,ae=>{e.onEdit&&ae(R)})}var X=f(de,2),re=d(X),E=f(d(re),2),N=d(E),le=f(E,2);{var Te=ae=>{var ge=Lu(),Ce=d(ge);H(Ke=>j(Ce,Ke),[()=>i(h)()]),w(ae,ge)};K(le,ae=>{e.timezoneHandler&&ae(Te)})}var Me=f(re,2);{var we=ae=>{var ge=Fu(),Ce=f(d(ge),2),Ke=d(Ce);H(mt=>j(Ke,mt),[()=>gr(new Date(e.task.lastCompletedAt))]),w(ae,ge)};K(Me,ae=>{e.task.lastCompletedAt&&ae(we)})}var Ue=f(Me,2);{var je=ae=>{var ge=Pu(),Ce=d(ge),Ke=d(Ce),mt=f(Ce,2);{var ct=aa=>{var Lt=Uu(),be=d(Lt);{var qe=ze=>{var ut=Os("Loading preview‚Ä¶");w(ze,ut)},We=ze=>{var ut=Ye(),dt=Re(ut);{var Dt=gt=>{var Kt=Bu(),Et=d(Kt);$c(Et,()=>i(x)),w(gt,Kt)},Ht=gt=>{var Kt=Ye(),Et=Re(Kt);{var sa=Ft=>{var B=Os();H(()=>j(B,i(M))),w(Ft,B)},Fa=Ft=>{var B=Os("No preview available.");w(Ft,B)};K(Et,Ft=>{i(S)?Ft(sa):Ft(Fa,!1)},!0)}w(gt,Kt)};K(dt,gt=>{i(x)?gt(Dt):gt(Ht,!1)},!0)}w(ze,ut)};K(be,ze=>{i(L)?ze(qe):ze(We,!1)})}w(aa,Lt)};K(mt,aa=>{i(D)&&aa(ct)})}H(()=>{xe(Ce,"title",`Linked block: ${e.task.linkedBlockId}`),j(Ke,`üìù Block ${i(U)??""}`)}),pt("mouseenter",Ce,F),pt("mouseleave",Ce,ee),pt("focus",Ce,F),pt("blur",Ce,ee),w(ae,ge)};K(Ue,ae=>{e.task.linkedBlockId&&ae(je)})}var St=f(X,2),Yt=d(St),it=f(St,2),ua=d(it),ot=d(ua);ot.__click=ve,ot.__keydown=C;var Le=f(ot,2),Rt=d(Le);Be(Rt,17,()=>i(q),wt,(ae,ge)=>{var Ce=ju();Ce.__click=()=>ce(i(ge).minutes);var Ke=d(Ce);H(()=>{xe(Ce,"aria-label",`Snooze for ${i(ge).label}`),j(Ke,i(ge).label)}),w(ae,Ce)});var He=f(Rt,2);He.__click=J;var lt=f(Le,2);{var wa=ae=>{var ge=Yu();ge.__keydown=z,Be(ge,21,()=>Ti,wt,(Ce,Ke,mt)=>{var ct=zu();ct.__click=()=>ce(i(Ke).minutes),xe(ct,"tabindex",mt===0?0:-1);var aa=d(ct);ca(ct,(Lt,be)=>b[be]=Lt,Lt=>b==null?void 0:b[Lt],()=>[mt]),H(()=>j(aa,i(Ke).label)),w(Ce,ct)}),H(()=>xe(ge,"id",i(P))),w(ae,ge)};K(lt,ae=>{i(g)&&ae(wa)})}var da=f(ua,2);da.__click=J;var ea=f(da,2);ea.__click=oe;var ta=f(ea,2);ta.__click=W,H((ae,ge)=>{Pe(ue,1,`task-card ${i(o)??""}`,"svelte-yjw1ud"),vs(ue,`--overdue-tint: ${i(c)??""}; --overdue-border: ${i(l)??""};`),xe(ue,"aria-label",ae),vs(ne,`background-color: ${i(u)??""}`),xe(ne,"title",`Priority:  ${(e.task.priority||"normal")??""}`),j(Y,e.task.name),j(N,ge),Pe(St,1,`task-card__health ${i(k)??""}`,"svelte-yjw1ud"),xe(St,"title",`Task health:  ${i(p)??""}%`),vs(Yt,`width: ${i(p)??""}%`),xe(ot,"aria-expanded",i(g)),xe(ot,"aria-controls",i(P))},[()=>i(te)(),()=>gr(i(t))]),w(a,ue),Xe()}nt(["keydown","click"]);var Ku=I(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),Wu=I('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),Gu=I('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function Vu(a,e){Qe(e,!0);const t=$(()=>[...e.tasks].sort((g,m)=>new Date(g.dueAt).getTime()-new Date(m.dueAt).getTime()));let s=Q(0),n=ke([]);kt(()=>{i(s)>=i(t).length&&_(s,Math.max(0,i(t).length-1),!0)});function r(g){var b;if(i(t).length===0)return;const m=Math.max(0,Math.min(g,i(t).length-1));_(s,m,!0),(b=n[m])==null||b.focus()}function o(g,m){g.key==="ArrowDown"?(g.preventDefault(),r(m+1)):g.key==="ArrowUp"?(g.preventDefault(),r(m-1)):g.key==="Home"?(g.preventDefault(),r(0)):g.key==="End"&&(g.preventDefault(),r(i(t).length-1))}var c=Gu(),l=d(c),u=f(d(l),2),h=d(u),y=f(l,2),v=d(y);{var p=g=>{var m=Ku();w(g,m)},k=g=>{var m=Ye(),b=Re(m);Be(b,19,()=>i(t),D=>D.id,(D,S,x)=>{var L=Wu();L.__keydown=M=>o(M,i(x));var U=d(L);Ws(U,{get task(){return i(S)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),ca(L,(M,q)=>n[q]=M,M=>n==null?void 0:n[M],()=>[i(x)]),H(()=>xe(L,"tabindex",i(x)===i(s)?0:-1)),pt("focus",L,()=>_(s,i(x),!0)),w(D,L)}),w(g,m)};K(v,g=>{i(t).length===0?g(p):g(k,!1)})}H(()=>j(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),w(a,c),Xe()}nt(["keydown"]);var Qu=I('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Xu=I('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),$u=I('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),Zu=I('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ju=I('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),ed=I('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),td=I('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),ad=I('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function sd(a,e){Qe(e,!0);let t=Q(null),s=Q(!1),n=Q(""),r=Q(""),o=Q(ke(new Set)),c=Q(0),l=ke([]),u=Q(null);const h=$(()=>[...e.tasks].sort((E,N)=>new Date(E.dueAt).getTime()-new Date(N.dueAt).getTime())),y=$(()=>()=>{const E=i(r).trim().toLowerCase();return E?i(h).filter(N=>{var Te;return[N.name,N.description,N.category,N.linkedBlockContent,(Te=N.tags)==null?void 0:Te.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(E)}):i(h)}),v=$(()=>i(y).map(E=>E.id)),p=$(()=>i(o).size>0),k=$(()=>i(y).length>0&&i(y).every(E=>i(o).has(E.id))),g=$(()=>i(y).some(E=>i(o).has(E.id))&&!i(k));kt(()=>{const E=new Set([...i(o)].filter(N=>e.tasks.some(le=>le.id===N)));E.size!==i(o).size&&_(o,E,!0)}),kt(()=>{i(u)&&(i(u).indeterminate=i(g))}),kt(()=>{i(c)>=i(y).length&&_(c,Math.max(0,i(y).length-1),!0)}),kt(()=>{const E=window.setTimeout(()=>{_(r,i(n),!0)},300);return()=>{window.clearTimeout(E)}});function m(E){_(t,E,!0)}function b(){i(t)&&(e.onDelete(i(t)),_(t,null))}function D(){_(t,null)}function S(E){const N=new Set(i(o));N.has(E)?N.delete(E):N.add(E),_(o,N,!0)}function x(){const E=new Set(i(o));i(k)?i(v).forEach(N=>E.delete(N)):i(v).forEach(N=>E.add(N)),_(o,E,!0)}function L(E){var le;if(i(y).length===0)return;const N=Math.max(0,Math.min(E,i(y).length-1));_(c,N,!0),(le=l[N])==null||le.focus()}function U(E,N){E.key==="ArrowDown"?(E.preventDefault(),L(N+1)):E.key==="ArrowUp"?(E.preventDefault(),L(N-1)):E.key==="Home"?(E.preventDefault(),L(0)):E.key==="End"&&(E.preventDefault(),L(i(y).length-1))}function M(){if(i(o).size===0){_(s,!1);return}e.onBulkDelete([...i(o)]),_(o,new Set,!0),_(s,!1)}function q(){_(s,!1)}function P(E){const{type:N,interval:le}=E.frequency,Te=N==="daily"?"day":N==="weekly"?"week":N==="monthly"?"month":"year",Me=le===1?`Every ${Te}`:`Every ${le} ${Te}s`;if(N==="weekly")return`${Me} on ${E.frequency.weekdays.map(we=>yu[we]??we).join(", ")}`;if(N==="monthly")return`${Me} on day ${E.frequency.dayOfMonth}`;if(N==="yearly"){const we=W[E.frequency.month]??`Month ${E.frequency.month+1}`;return`${Me} on ${we} ${E.frequency.dayOfMonth}`}return Me}const W=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var J=ad(),se=Re(J),oe=d(se),ve=f(d(oe),2),ce=d(ve),z=f(d(ce),2),C=f(ce,2);C.__click=function(...E){var N;(N=e.onCreate)==null||N.apply(this,E)};var F=f(oe,2),ee=d(F),te=d(ee),ue=d(te),de=f(te,2),me=d(de);me.__click=()=>e.onBulkEnable([...i(o)]);var ne=f(me,2);ne.__click=()=>e.onBulkDisable([...i(o)]);var fe=f(ne,2);fe.__click=()=>_(s,!0);var Y=f(ee,2);{var G=E=>{var N=Qu();w(E,N)},ie=E=>{var N=Ju(),le=d(N);{var Te=we=>{var Ue=Xu(),je=d(Ue),St=d(je);H(Yt=>j(St,`No tasks match "${Yt??""}".`),[()=>i(r).trim()]),w(we,Ue)},Me=we=>{var Ue=Zu(),je=d(Ue),St=d(je),Yt=d(St),it=d(Yt);it.__click=x,ca(it,ot=>_(u,ot),()=>i(u));var ua=f(je);Be(ua,23,()=>i(y),ot=>ot.id,(ot,Le,Rt)=>{var He=$u();He.__keydown=ze=>U(ze,i(Rt));var lt=d(He),wa=d(lt);wa.__click=()=>S(i(Le).id);var da=f(lt),ea=d(da),ta=f(da),ae=d(ta),ge=f(ta),Ce=d(ge),Ke=f(ge),mt=d(Ke),ct=d(mt);ct.__change=()=>e.onToggleEnabled(i(Le));var aa=f(Ke),Lt=d(aa),be=d(Lt);be.__click=()=>e.onEdit(i(Le));var qe=f(be,2);qe.__click=()=>e.onDuplicate(i(Le));var We=f(qe,2);We.__click=()=>m(i(Le)),ca(He,(ze,ut)=>l[ut]=ze,ze=>l==null?void 0:l[ze],()=>[i(Rt)]),H((ze,ut,dt,Dt)=>{Pe(He,1,Jc(i(Le).enabled?"":"disabled"),"svelte-i091qn"),xe(He,"tabindex",i(Rt)===i(c)?0:-1),xe(He,"aria-selected",ze),xe(wa,"aria-label",`Select ${i(Le).name}`),Ms(wa,ut),j(ea,i(Le).name),j(ae,dt),j(Ce,Dt),Ms(ct,i(Le).enabled)},[()=>i(o).has(i(Le).id),()=>i(o).has(i(Le).id),()=>gr(new Date(i(Le).dueAt)),()=>P(i(Le))]),pt("focus",He,()=>_(c,i(Rt),!0)),w(ot,He)}),H(()=>{Ms(it,i(k)),it.disabled=i(y).length===0}),w(we,Ue)};K(le,we=>{i(y).length===0?we(Te):we(Me,!1)})}w(E,N)};K(Y,E=>{i(h).length===0?E(G):E(ie,!1)})}var T=f(se,2);{var R=E=>{var N=ed(),le=d(N),Te=f(d(le),2),Me=d(Te),we=f(Te,2),Ue=d(we);Ue.__click=D;var je=f(Ue,2);je.__click=b,H(()=>j(Me,`Are you sure you want to delete "${i(t).name??""}"? This action cannot be undone.`)),w(E,N)};K(T,E=>{i(t)&&E(R)})}var X=f(T,2);{var re=E=>{var N=td(),le=d(N),Te=f(d(le),2),Me=d(Te),we=f(Te,2),Ue=d(we);Ue.__click=q;var je=f(Ue,2);je.__click=M,H(()=>j(Me,`Are you sure you want to delete ${i(o).size??""} task${i(o).size===1?"":"s"}? This action cannot be undone.`)),w(E,N)};K(X,E=>{i(s)&&E(re)})}H(()=>{z.disabled=i(h).length===0,j(ue,`${i(o).size??""} selected`),me.disabled=!i(p),ne.disabled=!i(p),fe.disabled=!i(p)}),tt(z,()=>i(n),E=>_(n,E)),w(a,J),Xe()}nt(["click","keydown","change"]);var nd=I('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),rd=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),id=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),od=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),ld=I('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),cd=I('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),ud=I('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),dd=I('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function hd(a,e){Qe(e,!0);let t=Oa(e,"days",3,30);function s(b){const{frequency:D}=b;if(D.type==="weekly"){const S=[...D.weekdays].sort((x,L)=>x-L).join(",");return`weekly:${D.interval}:${D.time??""}:${S}`}return D.type==="monthly"?`monthly:${D.interval}:${D.time??""}:${D.dayOfMonth}`:D.type==="yearly"?`yearly:${D.interval}:${D.time??""}:${D.month}:${D.dayOfMonth}`:`daily:${D.interval}:${D.time??""}`}function n(b,D){const S=b.map(x=>`${x.id}:${x.enabled}:${x.dueAt}:${s(x)}`).join("|");return`${D}:${S}`}function r(b,D){const S=_r(new Date),x=Ou(cn(S,D-1)),L=24*60*60*1e3,M=Nu(S,D).map(q=>({date:q,tasks:[]}));for(const q of b.filter(P=>P.enabled)){const P=new Date(q.dueAt),W=e.recurrenceEngine.getOccurrencesInRange(S,x,q.frequency,P);for(const J of W){const se=_r(J),oe=Math.floor((se.getTime()-S.getTime())/L);oe>=0&&oe<D&&M[oe].tasks.push({task:q,occurrence:J})}}for(const q of M)q.tasks.sort((P,W)=>P.occurrence.getTime()-W.occurrence.getTime());return M}const o=(()=>{let b="",D=[];return{get(S,x){const L=n(S,x);return L===b||(b=L,D=r(S,x)),D}}})(),c=$(()=>o.get(e.tasks,t())),l=$(()=>i(c).some(b=>b.tasks.length>0));var u=dd(),h=d(u),y=f(d(h),2),v=d(y),p=f(h,2),k=d(p);{var g=b=>{var D=nd(),S=d(D),x=d(S);H(()=>j(x,`No tasks scheduled in the next ${t()??""} days.`)),w(b,D)},m=b=>{var D=ud();Be(D,21,()=>i(c),S=>S.date.toISOString(),(S,x)=>{var L=Ye(),U=Re(L);{var M=q=>{var P=cd(),W=d(P),J=d(W),se=d(J),oe=f(J,2),ve=d(oe),ce=f(W,2);Be(ce,21,()=>i(x).tasks,({task:z,occurrence:C})=>z.id+C.toISOString(),(z,C)=>{let F=()=>i(C).task,ee=()=>i(C).occurrence;var te=ld(),ue=d(te),de=d(ue),me=f(ue,2),ne=d(me),fe=d(ne),Y=f(ne,2),G=d(Y);{var ie=E=>{var N=rd(),le=d(N);H(()=>j(le,`üîó ${F().linkedBlockId??""}`)),w(E,N)};K(G,E=>{F().linkedBlockId&&E(ie)})}var T=f(G,2);{var R=E=>{var N=id(),le=d(N);H(()=>j(le,`‚ö° ${F().priority??""}`)),w(E,N)};K(T,E=>{F().priority&&E(R)})}var X=f(T,2);{var re=E=>{var N=od(),le=d(N);H(Te=>j(le,`üè∑Ô∏è ${Te??""}`),[()=>F().tags.join(", ")]),w(E,N)};K(X,E=>{var N;(N=F().tags)!=null&&N.length&&E(re)})}H(E=>{j(de,E),j(fe,F().name)},[()=>xu(ee())]),w(z,te)}),H((z,C)=>{j(se,z),j(ve,C)},[()=>Au(i(x).date),()=>i(x).date.toLocaleDateString(void 0,{weekday:"short"})]),w(q,P)};K(U,q=>{i(x).tasks.length>0&&q(M)})}w(S,L)}),w(b,D)};K(k,b=>{i(l)?b(m,!1):b(g)})}H(()=>j(v,`Next ${t()??""} days`)),w(a,u),Xe()}var fd=I('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),vd=I('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),pd=I('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),yd=I('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),md=I('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),gd=I('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),_d=I('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),bd=I('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),kd=I('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),wd=I('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function Td(a,e){Qe(e,!0);const t=$(()=>()=>{let z=0,C=0;for(const te of e.tasks)z+=te.completionCount||0,C+=te.missCount||0;const F=z+C,ee=F>0?z/F*100:100;return{totalCompletions:z,totalMisses:C,completionRate:Math.round(ee)}}),s=$(()=>()=>[...e.tasks].filter(z=>(z.currentStreak||0)>0).sort((z,C)=>(C.currentStreak||0)-(z.currentStreak||0)).slice(0,10)),n=$(()=>()=>[...e.tasks].map(z=>({task:z,health:ll(z)})).sort((z,C)=>z.health-C.health)),r=$(()=>()=>i(n)().slice(-5).reverse()),o=$(()=>()=>i(n)().slice(0,5)),c=$(()=>()=>{const z=[];for(const C of e.tasks)if(C.recentCompletions&&C.recentCompletions.length>0)for(const F of C.recentCompletions)z.push({task:C,completedAt:F});return z.sort((C,F)=>new Date(F.completedAt).getTime()-new Date(C.completedAt).getTime()).slice(0,10)});function l(z){return new Date(z).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(z){return z>=80?"#10b981":z>=60?"#3b82f6":z>=40?"#f59e0b":"#ef4444"}var h=wd(),y=f(d(h),2),v=d(y),p=f(d(v),2),k=d(p),g=d(k),m=d(g),b=f(k,2),D=d(b),S=d(D),x=f(b,2),L=d(x),U=d(L),M=f(v,2);{var q=z=>{var C=pd(),F=f(d(C),2);Be(F,21,()=>i(s)(),wt,(ee,te,ue)=>{var de=vd(),me=d(de);me.textContent=`#${ue+1}`;var ne=f(me,2),fe=d(ne),Y=f(ne,2),G=d(Y),ie=f(G);{var T=R=>{var X=fd();w(R,X)};K(ie,R=>{i(te).bestStreak&&i(te).currentStreak===i(te).bestStreak&&R(T)})}H(()=>{j(fe,i(te).name),j(G,`${i(te).currentStreak??""} day${i(te).currentStreak!==1?"s":""} `)}),w(ee,de)}),w(z,C)};K(M,z=>{i(s)().length>0&&z(q)})}var P=f(M,2),W=f(d(P),2);{var J=z=>{var C=md(),F=f(Re(C),2);Be(F,21,()=>i(r)(),wt,(ee,te)=>{let ue=()=>i(te).task,de=()=>i(te).health;var me=yd(),ne=d(me),fe=d(ne),Y=f(ne,2),G=d(Y),ie=f(G,2),T=d(ie);H(R=>{j(fe,ue().name),vs(G,`width: ${de()??""}%; background-color: ${R??""}`),j(T,`${de()??""}/100`)},[()=>u(de())]),w(ee,me)}),w(z,C)};K(W,z=>{i(r)().length>0&&z(J)})}var se=f(W,2);{var oe=z=>{var C=_d(),F=f(Re(C),2);Be(F,21,()=>i(o)(),wt,(ee,te)=>{let ue=()=>i(te).task,de=()=>i(te).health;var me=gd(),ne=d(me),fe=d(ne),Y=f(ne,2),G=d(Y),ie=f(G,2),T=d(ie);H(R=>{j(fe,ue().name),vs(G,`width: ${de()??""}%; background-color: ${R??""}`),j(T,`${de()??""}/100`)},[()=>u(de())]),w(ee,me)}),w(z,C)};K(se,z=>{i(o)().length>0&&i(o)()[0].health<80&&z(oe)})}var ve=f(P,2);{var ce=z=>{var C=kd(),F=f(d(C),2);Be(F,21,()=>i(c)(),wt,(ee,te)=>{let ue=()=>i(te).task,de=()=>i(te).completedAt;var me=bd(),ne=f(d(me),2),fe=d(ne),Y=d(fe),G=f(fe,2),ie=d(G);H(T=>{j(Y,ue().name),j(ie,T)},[()=>l(de())]),w(ee,me)}),w(z,C)};K(ve,z=>{i(c)().length>0&&z(ce)})}H((z,C,F)=>{j(m,z),j(S,C),j(U,`${F??""}%`)},[()=>i(t)().totalCompletions,()=>i(t)().totalMisses,()=>i(t)().completionRate]),w(a,h),Xe()}var Sd=I('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">üì• No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),Dd=I('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),Ed=I('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function xd(a,e){Qe(e,!0);const t=$(()=>e.tasks.filter(g=>g.status!=="done"&&g.status!=="cancelled"&&!g.dueAt&&!g.scheduledAt&&!g.startAt).sort((g,m)=>new Date(m.createdAt).getTime()-new Date(g.createdAt).getTime()));let s=Q(0),n=ke([]);kt(()=>{i(s)>=i(t).length&&_(s,Math.max(0,i(t).length-1),!0)});function r(g){var b;if(i(t).length===0)return;const m=Math.max(0,Math.min(g,i(t).length-1));_(s,m,!0),(b=n[m])==null||b.focus()}function o(g,m){g.key==="ArrowDown"?(g.preventDefault(),r(m+1)):g.key==="ArrowUp"?(g.preventDefault(),r(m-1)):g.key==="Enter"&&e.onEdit?(g.preventDefault(),e.onEdit(i(t)[m])):g.key===" "&&e.onDone&&(g.preventDefault(),e.onDone(i(t)[m]))}var c=Ed(),l=d(c),u=f(d(l),2),h=d(u),y=f(l,2),v=d(y);{var p=g=>{var m=Sd();w(g,m)},k=g=>{var m=Ye(),b=Re(m);Be(b,19,()=>i(t),D=>D.id,(D,S,x)=>{var L=Dd();L.__keydown=M=>o(M,i(x));var U=d(L);Ws(U,{get task(){return i(S)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ca(L,(M,q)=>n[q]=M,M=>n==null?void 0:n[M],()=>[i(x)]),H(()=>xe(L,"tabindex",i(x)===i(s)?0:-1)),pt("focus",L,()=>_(s,i(x),!0)),w(D,L)}),w(g,m)};K(v,g=>{i(t).length===0?g(p):g(k,!1)})}H(()=>j(h,`${i(t).length??""} task${i(t).length!==1?"s":""} without dates`)),w(a,c),Xe()}nt(["keydown"]);var Ad=I('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),Cd=I('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),Id=I('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),Od=I('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function Md(a,e){Qe(e,!0);let t=Oa(e,"daysAhead",3,7);const s=new Date;s.setHours(0,0,0,0);const n=new Date(s);n.setDate(n.getDate()+t());const r=$(()=>e.tasks.filter(S=>{if(S.status==="done"||S.status==="cancelled"||!S.dueAt)return!1;const x=new Date(S.dueAt);return x.setHours(0,0,0,0),x>s&&x<=n}).sort((S,x)=>new Date(S.dueAt).getTime()-new Date(x.dueAt).getTime())),o=$(()=>()=>{const S=new Map;return i(r).forEach(x=>{const L=new Date(x.dueAt);L.setHours(0,0,0,0);const U=L.toISOString().split("T")[0];S.has(U)||S.set(U,[]),S.get(U).push(x)}),S});function c(S){const x=new Date(S),L=Math.floor((x.getTime()-s.getTime())/(1e3*60*60*24)),U=x.toLocaleDateString("en-US",{weekday:"long"}),M=x.toLocaleDateString("en-US",{month:"short",day:"numeric"});return L===1?`Tomorrow - ${U}, ${M}`:`${U}, ${M} (in ${L} days)`}let l=Q(0),u=ke([]);kt(()=>{i(l)>=i(r).length&&_(l,Math.max(0,i(r).length-1),!0)});function h(S,x){S.key==="ArrowDown"?(S.preventDefault(),_(l,Math.min(i(l)+1,i(r).length-1),!0)):S.key==="ArrowUp"?(S.preventDefault(),_(l,Math.max(i(l)-1,0),!0)):S.key==="Enter"&&e.onEdit?(S.preventDefault(),e.onEdit(i(r)[x])):S.key===" "&&e.onDone&&(S.preventDefault(),e.onDone(i(r)[x]))}var y=Od(),v=d(y),p=f(d(v),2),k=d(p),g=f(v,2),m=d(g);{var b=S=>{var x=Ad(),L=d(x),U=d(L);H(()=>j(U,`üìÖ No tasks scheduled for the next ${t()??""} days`)),w(S,x)},D=S=>{var x=Ye(),L=Re(x);Be(L,17,()=>[...i(o).entries()],wt,(U,M)=>{var q=$(()=>oo(i(M),2));let P=()=>i(q)[0],W=()=>i(q)[1];var J=Id(),se=d(J),oe=d(se),ve=f(se,2);Be(ve,19,W,ce=>ce.id,(ce,z)=>{const C=$(()=>i(r).indexOf(i(z)));var F=Cd();F.__keydown=te=>h(te,i(C));var ee=d(F);Ws(ee,{get task(){return i(z)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ca(F,(te,ue)=>u[ue]=te,te=>u==null?void 0:u[te],()=>[i(C)]),H(()=>xe(F,"tabindex",i(C)===i(l)?0:-1)),pt("focus",F,()=>_(l,i(C),!0)),w(ce,F)}),H(ce=>j(oe,ce),[()=>c(P())]),w(U,J)}),w(S,x)};K(m,S=>{i(r).length===0?S(b):S(D,!1)})}H(()=>j(k,`${i(r).length??""} task${i(r).length!==1?"s":""} in the next ${t()??""} days`)),w(a,y),Xe()}nt(["keydown"]);var Nd=I('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">‚úÖ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),qd=I('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),Rd=I('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),Ld=I('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">‚Üê Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next ‚Üí</button></div>'),Fd=I("<!> <!>",1),Bd=I('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function Ud(a,e){Qe(e,!0);let t=Oa(e,"daysBack",3,30),s=Q(0);const n=50,r=new Date;r.setDate(r.getDate()-t()),r.setHours(0,0,0,0);const o=$(()=>e.tasks.filter(M=>M.status!=="done"||!M.doneAt?!1:new Date(M.doneAt)>=r).sort((M,q)=>new Date(q.doneAt).getTime()-new Date(M.doneAt).getTime())),c=$(()=>Math.ceil(i(o).length/n)),l=$(()=>i(o).slice(i(s)*n,(i(s)+1)*n));kt(()=>{i(s)>=i(c)&&i(c)>0&&_(s,i(c)-1)});function u(){i(s)<i(c)-1&&ni(s)}function h(){i(s)>0&&ni(s,-1)}function y(M){const q=new Date(M),P=new Date,W=P.getTime()-q.getTime(),J=Math.floor(W/(1e3*60*60*24));return J===0?"Today":J===1?"Yesterday":J<7?`${J} days ago`:q.toLocaleDateString("en-US",{month:"short",day:"numeric",year:q.getFullYear()!==P.getFullYear()?"numeric":void 0})}let v=Q(0),p=ke([]);kt(()=>{i(v)>=i(l).length&&_(v,Math.max(0,i(l).length-1),!0)});function k(M,q){M.key==="ArrowDown"?(M.preventDefault(),_(v,Math.min(i(v)+1,i(l).length-1),!0)):M.key==="ArrowUp"?(M.preventDefault(),_(v,Math.max(i(v)-1,0),!0)):M.key==="Enter"&&e.onEdit&&(M.preventDefault(),e.onEdit(i(l)[q]))}var g=Bd(),m=d(g),b=f(d(m),2),D=d(b),S=f(m,2),x=d(S);{var L=M=>{var q=Nd();w(M,q)},U=M=>{var q=Fd(),P=Re(q);Be(P,19,()=>i(l),se=>se.id,(se,oe,ve)=>{var ce=Rd();ce.__keydown=de=>k(de,i(ve));var z=d(ce),C=d(z),F=d(C),ee=f(C,2);{var te=de=>{var me=qd();me.__click=()=>e.onUncomplete(i(oe)),w(de,me)};K(ee,de=>{e.onUncomplete&&de(te)})}var ue=f(z,2);Ws(ue,{get task(){return i(oe)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),ca(ce,(de,me)=>p[me]=de,de=>p==null?void 0:p[de],()=>[i(ve)]),H(de=>{xe(ce,"tabindex",i(ve)===i(v)?0:-1),j(F,`Completed ${de??""}`)},[()=>y(i(oe).doneAt)]),pt("focus",ce,()=>_(v,i(ve),!0)),w(se,ce)});var W=f(P,2);{var J=se=>{var oe=Ld(),ve=d(oe);ve.__click=h;var ce=f(ve,2),z=d(ce),C=f(ce,2);C.__click=u,H(()=>{ve.disabled=i(s)===0,j(z,`Page ${i(s)+1} of ${i(c)??""}`),C.disabled=i(s)>=i(c)-1}),w(se,oe)};K(W,se=>{i(c)>1&&se(J)})}w(M,q)};K(x,M=>{i(o).length===0?M(L):M(U,!1)})}H(()=>j(D,`${i(o).length??""} completed task${i(o).length!==1?"s":""} in the last ${t()??""} days`)),w(a,g),Xe()}nt(["keydown","click"]);var Pd=I('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">üìÅ No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),jd=I('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),zd=I('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),Yd=I('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),Hd=I('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function Kd(a,e){Qe(e,!0);const t=$(()=>()=>{const P=new Map;return e.tasks.filter(J=>J.status!=="done"&&J.status!=="cancelled").forEach(J=>{const se=J.linkedBlockPath||"Uncategorized";P.has(se)||P.set(se,[]),P.get(se).push(J)}),P.forEach(J=>{J.sort((se,oe)=>!se.dueAt&&!oe.dueAt?0:se.dueAt?oe.dueAt?new Date(se.dueAt).getTime()-new Date(oe.dueAt).getTime():-1:1)}),new Map([...P.entries()].sort(([J],[se])=>J.localeCompare(se)))}),s=$(()=>[...i(t).values()].reduce((P,W)=>P+W.length,0));let n=Q(ke(new Set([...i(t).keys()])));function r(P){const W=new Set(i(n));W.has(P)?W.delete(P):W.add(P),_(n,W,!0)}function o(){_(n,new Set([...i(t).keys()]),!0)}function c(){_(n,new Set,!0)}let l=Q(0),u=ke([]);const h=$(()=>()=>{const P=[];return i(t).forEach((W,J)=>{i(n).has(J)&&P.push(...W)}),P});kt(()=>{i(l)>=i(h).length&&_(l,Math.max(0,i(h).length-1),!0)});function y(P,W){P.key==="ArrowDown"?(P.preventDefault(),_(l,Math.min(i(l)+1,i(h).length-1),!0)):P.key==="ArrowUp"?(P.preventDefault(),_(l,Math.max(i(l)-1,0),!0)):P.key==="Enter"&&e.onEdit?(P.preventDefault(),e.onEdit(i(h)[W])):P.key===" "&&e.onDone&&(P.preventDefault(),e.onDone(i(h)[W]))}function v(P){const W=P.split("/");return W[W.length-1]||P}var p=Hd(),k=d(p),g=d(k),m=f(d(g),2),b=d(m),D=f(g,2),S=d(D);S.__click=o;var x=f(S,2);x.__click=c;var L=f(k,2),U=d(L);{var M=P=>{var W=Pd();w(P,W)},q=P=>{var W=Ye(),J=Re(W);Be(J,17,()=>[...i(t).entries()],wt,(se,oe)=>{var ve=$(()=>oo(i(oe),2));let ce=()=>i(ve)[0],z=()=>i(ve)[1];var C=Yd(),F=d(C);F.__click=()=>r(ce());var ee=d(F),te=d(ee),ue=f(ee,2),de=d(ue),me=f(ue,2),ne=d(me),fe=f(F,2);{var Y=G=>{var ie=zd();Be(ie,23,z,T=>T.id,(T,R)=>{const X=$(()=>i(h).indexOf(i(R)));var re=jd();re.__keydown=N=>y(N,i(X));var E=d(re);Ws(E,{get task(){return i(R)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ca(re,(N,le)=>u[le]=N,N=>u==null?void 0:u[N],()=>[i(X)]),H(()=>xe(re,"tabindex",i(X)===i(l)?0:-1)),pt("focus",re,()=>_(l,i(X),!0)),w(T,re)}),H(T=>xe(ie,"aria-label",T),[()=>`Tasks for ${v(ce())}`]),w(G,ie)};K(fe,G=>{i(n).has(ce())&&G(Y)})}H((G,ie)=>{j(te,G),xe(ue,"title",ce()),j(de,ie),j(ne,z().length)},[()=>i(n).has(ce())?"‚ñº":"‚ñ∂",()=>v(ce())]),w(se,C)}),w(P,W)};K(U,P=>{i(t).size===0?P(M):P(q,!1)})}H(()=>j(b,`${i(s)??""} task${i(s)!==1?"s":""} in ${i(t).size??""} project${i(t).size!==1?"s":""}`)),w(a,p),Xe()}nt(["click","keydown"]);class na extends Error{constructor(e,t,s,n){super(e),this.line=t,this.column=s,this.suggestion=n,this.name="QuerySyntaxError"}}class Ds extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var Ze=(a=>(a.TODO="TODO",a.IN_PROGRESS="IN_PROGRESS",a.DONE="DONE",a.CANCELLED="CANCELLED",a.NON_TASK="NON_TASK",a.EMPTY="EMPTY",a))(Ze||{});const fa=class fa{constructor(e){A(this,"symbol");A(this,"name");A(this,"nextStatusSymbol");A(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};A(fa,"TODO",new fa({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),A(fa,"DONE",new fa({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),A(fa,"IN_PROGRESS",new fa({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),A(fa,"CANCELLED",new fa({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let Sa=fa;class Wd{static parse(e,t=new Date){const s=e.trim().toLowerCase(),n=e;if(!s)return{date:null,isValid:!1,error:"Empty date string",original:n};if(s.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const p=new Date(s);if(!isNaN(p.getTime()))return{date:p,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),s==="today")return{date:o,isValid:!0,original:n};if(s==="tomorrow"){const p=new Date(o);return p.setDate(p.getDate()+1),{date:p,isValid:!0,original:n}}if(s==="yesterday"){const p=new Date(o);return p.setDate(p.getDate()-1),{date:p,isValid:!0,original:n}}const c=s.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(c){const p=parseInt(c[1]),k=c[2],g=new Date(o);return k.startsWith("day")?g.setDate(g.getDate()+p):k.startsWith("week")?g.setDate(g.getDate()+p*7):k.startsWith("month")&&g.setMonth(g.getMonth()+p),{date:g,isValid:!0,original:n}}const l=s.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(l){const p=parseInt(l[1]),k=l[2],g=new Date(o);return k.startsWith("day")?g.setDate(g.getDate()-p):k.startsWith("week")?g.setDate(g.getDate()-p*7):k.startsWith("month")&&g.setMonth(g.getMonth()-p),{date:g,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=s.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const p=h[1],k=u.indexOf(h[2]),g=o.getDay();let m=k-g;p==="next"?m<=0&&(m+=7):m>=0&&(m-=7);const b=new Date(o);return b.setDate(b.getDate()+m),{date:b,isValid:!0,original:n}}const y=s.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(y){const p=u.indexOf(y[1]),k=o.getDay();let g=p-k;g<0&&(g+=7);const m=new Date(o);return m.setDate(m.getDate()+g),{date:m,isValid:!0,original:n}}const v=s.match(/^(this|next|last)\s+(week|month)$/);if(v){const p=v[1],k=v[2],g=new Date(o);if(k==="week"){const m=g.getDay(),b=m===0?-6:1-m;g.setDate(g.getDate()+b),p==="next"?g.setDate(g.getDate()+7):p==="last"&&g.setDate(g.getDate()-7)}else k==="month"&&(g.setDate(1),p==="next"?g.setMonth(g.getMonth()+1):p==="last"&&g.setMonth(g.getMonth()-1));return{date:g,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class br{constructor(){A(this,"input","");A(this,"position",0);A(this,"line",1);A(this,"column",1);A(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const s={filters:[]},n=this.input.split(`
`).map(r=>r.trim()).filter(r=>r.length>0);for(let r=0;r<n.length;r++){this.line=r+1,this.column=1;const o=n[r];if(o.startsWith("sort by "))s.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))s.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))s.limit=this.parseLimitInstruction(o);else{const c=this.parseFilterInstruction(o);c&&s.filters.push(c)}}return s}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof na?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e.includes(" AND ")||e.includes(" and "))return this.parseAndFilter(e);if(e.includes(" OR ")||e.includes(" or "))return this.parseOrFilter(e);if(e.startsWith("NOT ")||e.startsWith("not "))return this.parseNotFilter(e);if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(e.startsWith("status.type is ")){const s=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(s)}}if(e.startsWith("status.name includes ")){const s=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(s)}}if(e.startsWith("status.symbol is ")){const s=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(s)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("tag includes ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e.startsWith("tag does not include ")){const s=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(s),negate:!0}}if(e.startsWith("tags include ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const s=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(s)}}if(e.startsWith("path does not include ")){const s=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(s),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};if(e.startsWith("description includes ")){const s=e.substring(21).trim();return{type:"description",operator:"includes",value:this.unquote(s)}}if(e.startsWith("description does not include ")){const s=e.substring(29).trim();return{type:"description",operator:"does not include",value:this.unquote(s)}}if(e.startsWith("description regex ")){const s=e.substring(18).trim();return{type:"description",operator:"regex",value:this.unquote(s)}}throw new na(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const s of t){if(e===`has ${s} date`)return{type:"date",operator:"has",value:{field:s}};if(e===`no ${s} date`)return{type:"date",operator:"has",value:{field:s},negate:!0};const n=["before","after","on","on or before","on or after"];for(const r of n){const o=`${s} ${r} `;if(e.startsWith(o)){const c=e.substring(o.length).trim(),l=Wd.parse(c,this.referenceDate);if(!l.isValid||!l.date)throw new na(`Invalid date value: "${c}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:r,value:{field:s,date:l.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new na(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new na(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new na(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return Ze.TODO;case"IN_PROGRESS":return Ze.IN_PROGRESS;case"DONE":return Ze.DONE;case"CANCELLED":return Ze.CANCELLED;case"NON_TASK":return Ze.NON_TASK;default:throw new na(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}parseAndFilter(e){const s=e.split(/ AND | and /).map(r=>this.parseFilterInstruction(r.trim())).filter(r=>r!==null);if(s.length===0)throw new na("Empty AND expression",this.line,this.column,"AND must have filters on both sides");if(s.length===1)return s[0];let n=s[0];for(let r=1;r<s.length;r++)n={type:"boolean",operator:"AND",value:null,left:n,right:s[r]};return n}parseOrFilter(e){const s=e.split(/ OR | or /).map(r=>this.parseFilterInstruction(r.trim())).filter(r=>r!==null);if(s.length===0)throw new na("Empty OR expression",this.line,this.column,"OR must have filters on both sides");if(s.length===1)return s[0];let n=s[0];for(let r=1;r<s.length;r++)n={type:"boolean",operator:"OR",value:null,left:n,right:s[r]};return n}parseNotFilter(e){const t=e.replace(/^NOT\s+/i,"").trim();if(!t)throw new na("Empty NOT expression",this.line,this.column,"NOT must have a filter after it");const s=this.parseFilterInstruction(t);if(!s)throw new na("Invalid filter after NOT",this.line,this.column,"NOT must be followed by a valid filter");return{type:"boolean",operator:"NOT",value:null,inner:s}}}class rt{}const Ja=class Ja{constructor(){A(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return Ja.instance||(Ja.instance=new Ja),Ja.instance}addDefaultStatuses(){this.add(Sa.TODO),this.add(Sa.IN_PROGRESS),this.add(Sa.DONE),this.add(Sa.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new Sa({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:Sa.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};A(Ja,"instance",null);let ba=Ja;class Gd extends rt{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=ba.getInstance(),s=e.statusSymbol||" ",r=t.get(s).type===this.statusType;return this.negate?!r:r}}class Vd extends rt{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=ba.getInstance(),s=e.statusSymbol||" ",r=t.get(s).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!r:r}}class Qd extends rt{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const s=(e.statusSymbol||" ")===this.symbol;return this.negate?!s:s}}class Xd extends rt{matches(e){const t=ba.getInstance(),s=e.statusSymbol||" ";return t.get(s).type===Ze.DONE}}class $d extends rt{matches(e){const t=ba.getInstance(),s=e.statusSymbol||" ";return t.get(s).type!==Ze.DONE}}class Zd extends rt{constructor(e,t,s){super(),this.field=e,this.comparator=t,this.targetDate=s}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const s=new Date(this.targetDate);s.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<s;case"after":return n>s;case"on":return n.getTime()===s.getTime();case"on or before":return n<=s;case"on or after":return n>=s;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class Jd extends rt{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const Oi={lowest:0,low:1,normal:2,medium:3,high:4,highest:5};function eh(a){return ln(a)??"normal"}function th(a){return a==="urgent"?"highest":a==="none"?"normal":a}class ah extends rt{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=eh(e.priority),s=Oi[t],n=Oi[th(this.level)];switch(this.operator){case"is":return s===n;case"above":return s>n;case"below":return s<n;default:return!1}}}class sh extends rt{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],s=this.tag.toLowerCase(),n=t.some(r=>r.toLowerCase().includes(s));return this.negate?!n:n}}class nh extends rt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class rh extends rt{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const s=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!s:s}}class ih extends rt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const s=e.blockedBy&&e.blockedBy.length>0;return this.negate?!s:!!s}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class oh extends rt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class lh extends rt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class ch extends rt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class uh extends rt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class dh extends rt{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class hh extends rt{constructor(e,t,s=!1){super(),this.operator=e,this.pattern=t,this.caseSensitive=s}matches(e){const t=e.name||"";switch(this.operator){case"includes":{const s=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return(this.caseSensitive?t:t.toLowerCase()).includes(s)}case"does not include":{const s=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return!(this.caseSensitive?t:t.toLowerCase()).includes(s)}case"regex":try{const s=this.caseSensitive?"":"i";return new RegExp(this.pattern,s).test(t)}catch{return!1}}}}class Xa{group(e){const t=new Map;for(const s of e){const n=this.getGroupKey(s);this.addToGroup(t,n,s)}return t}addToGroup(e,t,s){e.has(t)||e.set(t,[]),e.get(t).push(s)}}class fh extends Xa{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.dueAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),r=Math.ceil(n/(1e3*60*60*24));return r<0?"Overdue":r===0?"Today":r===1?"Tomorrow":r<=7?"This Week":"Later"}}class vh extends Xa{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.scheduledAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),r=Math.ceil(n/(1e3*60*60*24));return r<0?"Past":r===0?"Today":r===1?"Tomorrow":r<=7?"This Week":"Later"}}class ph extends Xa{getGroupKey(e){const t=ba.getInstance(),s=e.statusSymbol||" ";return t.get(s).type}}class yh extends Xa{getGroupKey(e){const t=ba.getInstance(),s=e.statusSymbol||" ";return t.get(s).name}}class mh extends Xa{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class gh extends Xa{getGroupKey(e){return e.path||""||"No path"}}class _h extends Xa{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const s=t.lastIndexOf("/");return s===-1?"Root":t.substring(0,s)||"Root"}}class bh extends Xa{group(e){const t=new Map;for(const s of e){const n=s.tags||[];if(n.length===0)this.addToGroup(t,"No tags",s);else for(const r of n)this.addToGroup(t,r,s)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}class kh{constructor(e){A(this,"dependencyGraph",null);this.taskIndex=e}setDependencyGraph(e){this.dependencyGraph=e}execute(e){const t=performance.now();try{let s=this.taskIndex.getAllTasks();const n=s.length;e.filters.length>0&&(s=this.applyFilters(s,e.filters)),e.sort&&(s=this.applySort(s,e.sort)),e.limit!==void 0&&e.limit>0&&(s=s.slice(0,e.limit));let r;e.group&&(r=this.applyGrouping(s,e.group));const c=performance.now()-t;return{tasks:s,groups:r,totalCount:n,executionTimeMs:c}}catch(s){throw new Ds(`Failed to execute query: ${s instanceof Error?s.message:String(s)}`,s instanceof Error?s:void 0)}}executeString(e){const s=new br().parse(e);return this.execute(s)}validateQuery(e){try{return{valid:!0,parsedFilters:new br().parse(e).filters.map(n=>`${n.type}:${n.operator}`)}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}applyFilters(e,t){let s=e;for(const n of t){const r=this.createFilter(n);s=s.filter(o=>r.matches(o))}return s}createFilter(e){switch(e.type){case"done":return e.value?new Xd:new $d;case"status":if(e.operator==="type-is")return new Gd(e.value,e.negate);if(e.operator==="name-includes")return new Vd(e.value,e.negate);if(e.operator==="symbol-is")return new Qd(e.value,e.negate);throw new Ds(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new Jd(e.value.field,e.negate):new Zd(e.value.field,e.operator,e.value.date);case"priority":return new ah(e.operator,e.value);case"tag":return e.operator==="has"?new nh(!e.value):new sh(e.value,e.negate);case"path":return new rh(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new ih(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new oh(this.dependencyGraph,!e.value);throw new Ds(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new lh(!e.value);case"description":return new hh(e.operator,e.value,e.negate);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new ch(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="OR"&&e.left&&e.right)return new uh(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="NOT"&&e.inner)return new dh(this.createFilter(e.inner));throw new Ds(`Invalid boolean operator: ${e.operator}`);default:throw new Ds(`Unknown filter type: ${e.type}`)}}applySort(e,t){const s=[...e];return s.sort((n,r)=>{let o=0;switch(t.field){case"due":o=this.compareDates(n.dueAt,r.dueAt);break;case"scheduled":o=this.compareDates(n.scheduledAt,r.scheduledAt);break;case"start":o=this.compareDates(n.startAt,r.startAt);break;case"created":o=this.compareDates(n.createdAt,r.createdAt);break;case"done":o=this.compareDates(n.doneAt,r.doneAt);break;case"priority":o=this.comparePriorities(n.priority,r.priority);break;case"status.type":o=this.compareStatusTypes(n,r);break;case"description":o=(n.description||"").localeCompare(r.description||"");break;case"path":o=(n.path||"").localeCompare(r.path||"");break;default:o=n.name.localeCompare(r.name)}return t.reverse?-o:o}),s}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const s={lowest:0,low:1,normal:2,medium:3,high:4,highest:5},n=s[ln(e)||"normal"]||2,r=s[ln(t)||"normal"]||2;return n-r}compareStatusTypes(e,t){const s=n=>{const r=n.statusSymbol||" ";return r===" "?0:r==="/"?1:r==="x"?2:r==="-"?3:0};return s(e)-s(t)}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new fh;case"scheduled":return new vh;case"status.type":return new ph;case"status.name":return new yh;case"priority":return new mh;case"path":return new gh;case"folder":return new _h;case"tags":return new bh;default:throw new Ds(`Unknown grouping field: ${e}`)}}}var wh=I('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Th=I('<div class="search-tab__error svelte-1yjlv38"> </div>'),Sh=I('<div class="search-tab__stats svelte-1yjlv38"> </div>'),Dh=I('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),Eh=I('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),xh=I('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),Ah=I('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">üîç No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),Ch=I('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),Ih=I(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function Oh(a,e){Qe(e,!0);let t=Q(""),s=Q(ke([])),n=Q(""),r=Q(0),o=Q(ke([])),c=Q(!1),l=Q(!1);const u=["not done","due today","priority high","description includes meeting","not done AND due before tomorrow","tag includes #work","is recurring","is blocked","sort by priority","not done GROUP BY priority"],h={getAllTasks:()=>e.tasks},y=new kh(h);function v(){if(!i(t).trim()){_(s,[],!0),_(n,"");return}_(l,!0),_(n,"");try{const G=new br().parse(i(t)),ie=y.execute(G);if(_(s,ie.tasks,!0),_(r,ie.executionTimeMs,!0),!i(o).includes(i(t))){_(o,[i(t),...i(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(i(o)))}catch{}}}catch(Y){_(n,Y instanceof Error?Y.message:String(Y),!0),_(s,[],!0),Z.error(`Query error: ${i(n)}`)}finally{_(l,!1)}}function p(){try{const Y=localStorage.getItem("query-history");Y&&_(o,JSON.parse(Y),!0)}catch{}}function k(Y){_(t,Y,!0),v()}function g(Y){_(t,Y,!0),_(c,!1),v()}function m(){_(o,[],!0);try{localStorage.removeItem("query-history")}catch{}_(c,!1)}function b(Y){Y.key==="Enter"&&!Y.shiftKey&&(Y.preventDefault(),v())}kt(()=>{p()});let D=Q(0),S=ke([]);kt(()=>{i(D)>=i(s).length&&_(D,Math.max(0,i(s).length-1),!0)});function x(Y,G){Y.key==="ArrowDown"?(Y.preventDefault(),_(D,Math.min(i(D)+1,i(s).length-1),!0)):Y.key==="ArrowUp"?(Y.preventDefault(),_(D,Math.max(i(D)-1,0),!0)):Y.key==="Enter"&&e.onEdit?(Y.preventDefault(),e.onEdit(i(s)[G])):Y.key===" "&&e.onDone&&(Y.preventDefault(),e.onDone(i(s)[G]))}var L=Ih(),U=f(d(L),2),M=d(U),q=d(M);q.__keydown=b;var P=f(q,2),W=d(P);W.__click=v;var J=d(W),se=f(W,2);{var oe=Y=>{var G=wh();G.__click=()=>_(c,!i(c));var ie=d(G);H(()=>j(ie,`History (${i(o).length??""})`)),w(Y,G)};K(se,Y=>{i(o).length>0&&Y(oe)})}var ve=f(M,2);{var ce=Y=>{var G=Th(),ie=d(G);H(()=>j(ie,`‚ö†Ô∏è ${i(n)??""}`)),w(Y,G)};K(ve,Y=>{i(n)&&Y(ce)})}var z=f(ve,2);{var C=Y=>{var G=Sh(),ie=d(G);H(T=>j(ie,`Found ${i(s).length??""} task${i(s).length!==1?"s":""} in ${T??""}ms`),[()=>i(r).toFixed(2)]),w(Y,G)};K(z,Y=>{i(r)>0&&!i(n)&&Y(C)})}var F=f(U,2);{var ee=Y=>{var G=Eh(),ie=d(G),T=f(d(ie),2);T.__click=m;var R=f(ie,2);Be(R,21,()=>i(o),wt,(X,re)=>{var E=Dh(),N=d(E);N.__click=()=>g(i(re));var le=d(N);H(()=>j(le,i(re))),w(X,E)}),w(Y,G)};K(F,Y=>{i(c)&&i(o).length>0&&Y(ee)})}var te=f(F,2),ue=f(d(te),2);Be(ue,21,()=>u,wt,(Y,G)=>{var ie=xh();ie.__click=()=>k(i(G));var T=d(ie),R=d(T);H(()=>j(R,i(G))),w(Y,ie)});var de=f(te,2),me=d(de);{var ne=Y=>{var G=Ah();w(Y,G)},fe=Y=>{var G=Ye(),ie=Re(G);{var T=R=>{var X=Ye(),re=Re(X);Be(re,19,()=>i(s),E=>E.id,(E,N,le)=>{var Te=Ch();Te.__keydown=we=>x(we,i(le));var Me=d(Te);Ws(Me,{get task(){return i(N)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ca(Te,(we,Ue)=>S[Ue]=we,we=>S==null?void 0:S[we],()=>[i(le)]),H(()=>xe(Te,"tabindex",i(le)===i(D)?0:-1)),pt("focus",Te,()=>_(D,i(le),!0)),w(E,Te)}),w(R,X)};K(ie,R=>{i(s).length>0&&R(T)},!0)}w(Y,G)};K(me,Y=>{i(s).length===0&&i(t).trim()&&!i(n)?Y(ne):Y(fe,!1)})}H(()=>{W.disabled=i(l),j(J,i(l)?"Searching...":"Search")}),tt(q,()=>i(t),Y=>_(t,Y)),w(a,L),Xe()}nt(["keydown","click"]);class kr{static parse(e){const t=e,s=e.trim().toLowerCase();if(!s)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=s.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let r=n[1],o;const c=r.match(/^(.+?)\s+when\s+done$/),l=r.match(/^(.+?)\s+when\s+due$/);if(c?(r=c[1],o=!0):l&&(r=l[1],o=!1),r==="weekday"||r==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(r==="weekend"||r==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=r.match(/^(\d+\s+)?days?$/);if(u)return{frequency:{type:"daily",interval:u[1]?parseInt(u[1]):1,whenDone:o},raw:t,isValid:!0};const h=r.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(h){const p=h[1]?parseInt(h[1]):1,k=h[2];if(!k)return{frequency:{type:"weekly",interval:p,weekdays:[1],whenDone:o},raw:t,isValid:!0};const g=this.parseDayNames(k);return g.length===0?{frequency:{type:"weekly",interval:p,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:p,weekdays:g,whenDone:o},raw:t,isValid:!0}}const y=r.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(y){const p=y[1]?parseInt(y[1]):1,k=y[2]?parseInt(y[2]):1;return k<1||k>31?{frequency:{type:"monthly",interval:p,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:p,dayOfMonth:k,whenDone:o},raw:t,isValid:!0}}const v=r.match(/^(\d+\s+)?years?$/);return v?{frequency:{type:"yearly",interval:v[1]?parseInt(v[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=e.interval;let s;switch(e.type){case"daily":s=t===1?"every day":`every ${t} days`;break;case"weekly":{const n=t===1?"week":`${t} weeks`;if(e.weekdays.length===0)s=`every ${n}`;else{const r=e.weekdays.map(o=>this.getDayName(o)).join(", ");s=`every ${n} on ${r}`}break}case"monthly":{const n=t===1?"month":`${t} months`,r=this.getDaySuffix(e.dayOfMonth);s=`every ${n} on the ${e.dayOfMonth}${r}`;break}case"yearly":{s=`every ${t===1?"year":`${t} years`}`;break}default:s="every day"}return e.whenDone?`${s} when done`:s}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},s=e.split(",").map(r=>r.trim().toLowerCase()),n=[];for(const r of s)r in t&&n.push(t[r]);return n}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var Mh=I('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),Nh=I('<div class="priority-selector svelte-1w15n9q"></div>');function qh(a,e){Qe(e,!0);let t=Oa(e,"value",15,"normal");const s=[{value:"highest",label:"Highest",emoji:"üî∫",color:"var(--b3-theme-error, #ef4444)"},{value:"high",label:"High",emoji:"‚è´",color:"#f97316"},{value:"medium",label:"Medium",emoji:"üîº",color:"#f59e0b"},{value:"normal",label:"Normal",emoji:"üü°",color:"#eab308"},{value:"low",label:"Low",emoji:"üîΩ",color:"#22c55e"},{value:"lowest",label:"Lowest",emoji:"‚è¨",color:"#64748b"}];function n(o){t(o),e.onchange(o)}var r=Nh();Be(r,21,()=>s,wt,(o,c)=>{var l=Mh();let u;var h=d(l);h.__change=()=>n(i(c).value);var y=f(h,2),v=d(y),p=f(y,2),k=d(p);H(()=>{u=Pe(l,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===i(c).value}),vs(l,`--priority-color: ${i(c).color??""}`),tl(h,i(c).value),Ms(h,t()===i(c).value),j(v,i(c).emoji),j(k,i(c).label)}),w(o,l)}),w(a,r),Xe()}nt(["change"]);var Rh=I('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),Lh=I('<div class="status-selector svelte-v9ezc0"></div>');function Fh(a,e){Qe(e,!0);let t=Oa(e,"value",15,"todo");const s=[{value:"todo",label:"Todo",icon:"‚óã",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"‚úì",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"‚úï",color:"#999"}];function n(o){t(o),e.onchange(o)}var r=Lh();Be(r,21,()=>s,wt,(o,c)=>{var l=Rh();let u;var h=d(l);h.__change=()=>n(i(c).value);var y=f(h,2),v=d(y),p=f(y,2),k=d(p);H(()=>{u=Pe(l,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===i(c).value}),vs(l,`--status-color: ${i(c).color??""}`),tl(h,i(c).value),Ms(h,t()===i(c).value),j(v,i(c).icon),j(k,i(c).label)}),w(o,l)}),w(a,r),Xe()}nt(["change"]);var Bh=I('<div class="recurrence-input__valid svelte-787fjp">‚úì Valid recurrence pattern</div>'),Uh=I('<div class="recurrence-input__error svelte-787fjp"> </div>'),Ph=I('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),jh=I('<li class="svelte-787fjp"> </li>'),zh=I('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),Yh=I('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function Hh(a,e){Qe(e,!0);let t=Oa(e,"value",15,""),s=Oa(e,"showPreview",3,!0);const n=$(()=>kr.parse(t())),r=$(()=>i(n).isValid),o=$(()=>i(n).error);function c(b,D=3){const S=[],x=new Date;for(let L=0;L<D;L++){const U=new Date(x);switch(b.type){case"daily":U.setDate(x.getDate()+L*b.interval);break;case"weekly":U.setDate(x.getDate()+L*b.interval*7);break;case"monthly":U.setMonth(x.getMonth()+L*b.interval);break;case"yearly":U.setFullYear(x.getFullYear()+L*b.interval);break}S.push(U.toLocaleDateString())}return S}const l=$(()=>i(r)&&s()?c(i(n).frequency):[]);function u(b){const S=b.target.value;t(S);const x=kr.parse(S);e.onchange(S,x.isValid?x.frequency:null,x.isValid)}var h=Yh(),y=d(h);let v;y.__input=u;var p=f(y,2);{var k=b=>{var D=Ph(),S=d(D);{var x=U=>{var M=Bh();w(U,M)},L=U=>{var M=Uh(),q=d(M);H(()=>j(q,`‚ö† ${(i(o)||"Invalid recurrence pattern")??""}`)),w(U,M)};K(S,U=>{i(r)?U(x):U(L,!1)})}w(b,D)};K(p,b=>{t().length>0&&b(k)})}var g=f(p,2);{var m=b=>{var D=zh(),S=f(d(D),2);Be(S,21,()=>i(l),wt,(x,L)=>{var U=jh(),M=d(U);H(()=>j(M,i(L))),w(x,U)}),w(b,D)};K(g,b=>{i(r)&&s()&&i(l).length>0&&b(m)})}H(()=>{v=Pe(y,1,"recurrence-input__field svelte-787fjp",null,v,{valid:i(r),invalid:!i(r)&&t().length>0}),xe(y,"aria-invalid",!i(r)&&t().length>0)}),tt(y,t),w(a,h),Xe()}nt(["input"]);var Kh=I('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">‚úï</button></div>'),Wh=I('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),Gh=I('<span class="dependency-picker__option-check svelte-10ls0lk">‚úì</span>'),Vh=I('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Qh=I('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),Xh=I('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function Mi(a,e){Qe(e,!0);let t=Oa(e,"selected",31,()=>ke([])),s=Oa(e,"label",3,"Select tasks"),n=Q(""),r=Q(!1);const o=$(()=>e.repository.getAllTasks().filter(U=>U.id!==e.excludeId)),c=$(()=>i(n).trim()?i(o).filter(U=>U.name.toLowerCase().includes(i(n).toLowerCase())):i(o)),l=$(()=>i(o).filter(U=>t().includes(U.id)));function u(U){if(!t().includes(U)){const M=[...t(),U];t(M),e.onchange(M)}_(n,""),_(r,!1)}function h(U){const M=t().filter(q=>q!==U);t(M),e.onchange(M)}function y(){_(r,!0)}function v(){setTimeout(()=>{_(r,!1)},200)}var p=Xh(),k=d(p),g=d(k),m=f(k,2);{var b=U=>{var M=Wh();Be(M,21,()=>i(l),q=>q.id,(q,P)=>{var W=Kh(),J=d(W),se=d(J),oe=f(J,2);oe.__click=()=>h(i(P).id),H(()=>{j(se,i(P).name),xe(oe,"aria-label",`Remove ${i(P).name??""}`)}),w(q,W)}),w(U,M)};K(m,U=>{i(l).length>0&&U(b)})}var D=f(m,2),S=d(D),x=f(S,2);{var L=U=>{var M=Qh();Be(M,21,()=>i(c).slice(0,10),q=>q.id,(q,P)=>{var W=Vh();let J;W.__click=()=>u(i(P).id);var se=d(W),oe=d(se),ve=f(se,2);{var ce=z=>{var C=Gh();w(z,C)};K(ve,z=>{t().includes(i(P).id)&&z(ce)})}H((z,C)=>{J=Pe(W,1,"dependency-picker__option svelte-10ls0lk",null,J,z),W.disabled=C,j(oe,i(P).name)},[()=>({selected:t().includes(i(P).id)}),()=>t().includes(i(P).id)]),w(q,W)}),w(U,M)};K(x,U=>{i(r)&&i(c).length>0&&U(L)})}H(()=>j(g,s())),pt("focus",S,y),pt("blur",S,v),tt(S,()=>i(n),U=>_(n,U)),w(a,p),Xe()}nt(["click"]);var $h=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),Zh=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),Jh=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),ef=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),tf=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),af=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),sf=I('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">‚úï</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">üí° Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">‚åò/Ctrl+Enter</kbd> to save</div></div></div>');function dl(a,e){var We,ze,ut,dt,Dt,Ht,gt,Kt,Et,sa,Fa,Ft;Qe(e,!0);const t="every day",s="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",r=!e.task;let o=Q(ke(((We=e.task)==null?void 0:We.name)||"")),c=Q(ke(((ze=e.task)==null?void 0:ze.description)||"")),l=Q(ke(((ut=e.task)==null?void 0:ut.priority)||"normal")),u=Q(ke(((dt=e.task)==null?void 0:dt.status)||"todo")),h=Q(ke((Dt=e.task)!=null&&Dt.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),y=Q(ke((Ht=e.task)!=null&&Ht.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),v=Q(ke((gt=e.task)!=null&&gt.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),p=Q(ke(((Kt=e.task)==null?void 0:Kt.recurrenceText)||((Et=e.task)!=null&&Et.frequency?kr.stringify(e.task.frequency):t))),k=Q(ke(((sa=e.task)==null?void 0:sa.frequency)||null)),g=Q(!0),m=Q(ke(((Fa=e.task)==null?void 0:Fa.blockedBy)||[])),b=Q(ke(((Ft=e.task)==null?void 0:Ft.dependsOn)||[])),D=Q(ke({name:!1,dueAt:!1,recurrence:!1})),S=Q(!1),x=Q(null);const L=$(()=>i(D).name&&!i(o).trim()?"Task name is required":""),U=$(()=>i(D).dueAt?i(h)?Number.isNaN(new Date(i(h)).getTime())?"Invalid due date":"":"Due date is required":""),M=$(()=>i(D).recurrence&&!i(g)?"Invalid recurrence pattern":""),q=$(()=>!!(i(L)||i(U)||i(M)));Yn(()=>{requestAnimationFrame(()=>{var B;(B=i(x))==null||B.focus()})});function P(B,pe,Je){_(p,B,!0),_(k,pe,!0),_(g,Je,!0),i(D).recurrence=!0}function W(B){_(l,B,!0)}function J(B){_(u,B,!0)}function se(B){_(m,B,!0)}function oe(B){_(b,B,!0)}async function ve(){if(_(D,{name:!0,dueAt:!0,recurrence:!0},!0),i(q)){Z.warning("Please fix validation errors");return}if(!i(k)){Z.error("Invalid recurrence pattern");return}_(S,!0);try{let B;r?B=nl(i(o).trim(),i(k),new Date(i(h))):(B={...e.task},B.name=i(o).trim(),B.frequency=i(k),B.dueAt=new Date(i(h)).toISOString()),B.description=i(c).trim()||void 0,B.priority=i(l),B.status=i(u),B.recurrenceText=i(p),B.scheduledAt=i(y)?new Date(i(y)).toISOString():void 0,B.startAt=i(v)?new Date(i(v)).toISOString():void 0,B.blockedBy=i(m).length>0?i(m):void 0,B.dependsOn=i(b).length>0?i(b):void 0,B.updatedAt=new Date().toISOString(),i(u)==="done"&&!B.lastCompletedAt&&(B.lastCompletedAt=new Date().toISOString()),i(u)==="cancelled"&&!B.cancelledAt&&(B.cancelledAt=new Date().toISOString()),await e.repository.saveTask(B),e.onSave&&e.onSave(B),Z.success(`Task "${B.name}" ${r?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(B){Z.error(`Failed to save task: ${B}`)}finally{_(S,!1)}}function ce(B){B.key==="Escape"&&e.onClose(),(B.metaKey||B.ctrlKey)&&B.key==="Enter"&&(B.preventDefault(),ve())}function z(B){return B?new Date(B).toLocaleString():"‚Äî"}var C=sf();C.__keydown=ce;var F=d(C),ee=d(F),te=d(ee),ue=d(te),de=f(te,2);de.__click=function(...B){var pe;(pe=e.onClose)==null||pe.apply(this,B)};var me=f(ee,2),ne=d(me),fe=f(d(ne),2);fe.__input=()=>i(D).name=!0,ca(fe,B=>_(x,B),()=>i(x));var Y=f(fe,2);{var G=B=>{var pe=$h(),Je=d(pe);H(()=>j(Je,i(L))),w(B,pe)};K(Y,B=>{i(L)&&B(G)})}var ie=f(ne,2),T=f(d(ie),2),R=f(ie,2),X=f(d(R),2);qh(X,{get value(){return i(l)},onchange:W});var re=f(R,2),E=f(d(re),2);Fh(E,{get value(){return i(u)},onchange:J});var N=f(re,2),le=f(d(N),2);le.__input=()=>i(D).dueAt=!0;var Te=f(le,2);{var Me=B=>{var pe=Zh(),Je=d(pe);H(()=>j(Je,i(U))),w(B,pe)};K(Te,B=>{i(U)&&B(Me)})}var we=f(N,2),Ue=f(d(we),2),je=f(we,2),St=f(d(je),2),Yt=f(je,2),it=f(d(Yt),2);Hh(it,{get value(){return i(p)},onchange:P,showPreview:!0});var ua=f(it,2);{var ot=B=>{var pe=Jh(),Je=d(pe);H(()=>j(Je,i(M))),w(B,pe)};K(ua,B=>{i(M)&&B(ot)})}var Le=f(Yt,2),Rt=d(Le);{let B=$(()=>{var pe;return(pe=e.task)==null?void 0:pe.id});Mi(Rt,{get repository(){return e.repository},get selected(){return i(m)},get excludeId(){return i(B)},onchange:se,label:s})}var He=f(Le,2),lt=d(He);{let B=$(()=>{var pe;return(pe=e.task)==null?void 0:pe.id});Mi(lt,{get repository(){return e.repository},get selected(){return i(b)},get excludeId(){return i(B)},onchange:oe,label:n})}var wa=f(He,2),da=d(wa),ea=f(d(da),2),ta=d(ea),ae=f(da,2);{var ge=B=>{var pe=ef(),Je=f(d(pe),2),$a=d(Je);H(Vs=>j($a,Vs),[()=>z(e.task.lastCompletedAt)]),w(B,pe)};K(ae,B=>{var pe;(pe=e.task)!=null&&pe.lastCompletedAt&&B(ge)})}var Ce=f(ae,2);{var Ke=B=>{var pe=tf(),Je=f(d(pe),2),$a=d(Je);H(Vs=>j($a,Vs),[()=>z(e.task.cancelledAt)]),w(B,pe)};K(Ce,B=>{var pe;(pe=e.task)!=null&&pe.cancelledAt&&B(Ke)})}var mt=f(Ce,2);{var ct=B=>{var pe=af(),Je=f(d(pe),2),$a=d(Je);H(()=>j($a,e.task.linkedBlockId)),w(B,pe)};K(mt,B=>{var pe;(pe=e.task)!=null&&pe.linkedBlockId&&B(ct)})}var aa=f(me,2),Lt=d(aa);Lt.__click=function(...B){var pe;(pe=e.onClose)==null||pe.apply(this,B)};var be=f(Lt,2);be.__click=ve;var qe=d(be);H(B=>{j(ue,r?"Create Task":"Edit Task"),xe(fe,"aria-invalid",!!i(L)),xe(le,"aria-invalid",!!i(U)),j(ta,B),be.disabled=i(S),j(qe,i(S)?"Saving...":r?"Create Task":"Save Changes")},[()=>{var B;return z((B=e.task)==null?void 0:B.createdAt)}]),pt("blur",fe,()=>i(D).name=!0),tt(fe,()=>i(o),B=>_(o,B)),tt(T,()=>i(c),B=>_(c,B)),pt("blur",le,()=>i(D).dueAt=!0),tt(le,()=>i(h),B=>_(h,B)),tt(Ue,()=>i(y),B=>_(y,B)),tt(St,()=>i(v),B=>_(v,B)),w(a,C),Xe()}nt(["keydown","click","input"]);const nf=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];class rf{constructor(e){A(this,"config");this.config=e}evaluate(e,t){if(!this.config.enabled||this.config.mode==="all")return!0;const s=this.config.rules.filter(o=>o.enabled);if(s.length===0)return!0;const r=s.map(o=>this.evaluateRule(o,e,t)).some(o=>o);return this.config.mode==="include"?r:!r}updateConfig(e){this.config=e}getConfig(){return this.config}evaluateRule(e,t,s){switch(e.type){case"tag":const n=this.extractTags(t),r=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${r}$`);return n.some(c=>o.test(c));case"regex":try{return new RegExp(e.pattern).test(t)}catch{return!1}case"path":return s?s.includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}extractTags(e){return e.match(/#[\w/-]+/g)||[]}}function of(a){if(!a.pattern||a.pattern.trim().length===0)return{valid:!1,error:"Pattern cannot be empty"};switch(a.type){case"regex":try{return new RegExp(a.pattern),{valid:!0}}catch(e){return{valid:!1,error:`Invalid regex pattern: ${e instanceof Error?e.message:String(e)}`}}case"tag":return a.pattern.startsWith("#")?{valid:!0}:{valid:!1,error:"Tag pattern should start with #"};case"path":case"marker":return{valid:!0};default:return{valid:!1,error:`Unknown rule type: ${a.type}`}}}function lf(a,e,t){return{id:typeof crypto<"u"&&crypto.randomUUID?`rule_${crypto.randomUUID()}`:`rule_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,type:a,pattern:e,enabled:!0,description:t}}const Ni={enabled:!1,mode:"all",rules:[]},es=class es{constructor(){A(this,"engine");this.engine=new rf(Ni)}static getInstance(){return es.instance||(es.instance=new es),es.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(Ni)}};A(es,"instance",null);let wr=es;var cf=I('<p class="empty-state svelte-b8rwae">No filter rules configured</p>'),uf=I('<span class="rule-description svelte-b8rwae"> </span>'),df=I('<div class="rule-item svelte-b8rwae"><input type="checkbox" class="rule-checkbox svelte-b8rwae"/> <div class="rule-info svelte-b8rwae"><span class="rule-type svelte-b8rwae"> </span> <code class="rule-pattern svelte-b8rwae"> </code> <!></div> <button class="delete-btn svelte-b8rwae">Delete</button></div>'),hf=I('<div class="rules-list svelte-b8rwae"></div>'),ff=I('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Task Filter</h3> <p class="description svelte-b8rwae">Control which checkboxes are treated as tasks</p> <div class="form-field svelte-b8rwae"><label class="settings__toggle svelte-b8rwae"><input type="checkbox" class="svelte-b8rwae"/> <span>Enable Global Filter</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Filter Mode</label> <select class="settings__input svelte-b8rwae"><option>All checkboxes are tasks (default)</option><option>Only checkboxes matching rules</option><option>All except checkboxes matching rules</option></select> <p class="hint svelte-b8rwae"><!></p></div> <div class="rules-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Filter Rules</h4> <!></div> <div class="add-rule-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Add Rule</h4> <div class="add-rule-form svelte-b8rwae"><select class="settings__input svelte-b8rwae"><option>Tag (e.g., #task)</option><option>Regex pattern</option><option>Document path (e.g., daily/)</option><option>Text marker (e.g., TODO:)</option></select> <input type="text" placeholder="Pattern" class="settings__input svelte-b8rwae"/> <input type="text" placeholder="Description (optional)" class="settings__input svelte-b8rwae"/> <button class="add-btn svelte-b8rwae">Add Rule</button></div></div> <div class="examples svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Examples</h4> <ul class="svelte-b8rwae"><li class="svelte-b8rwae"><strong>Tag:</strong> <code class="svelte-b8rwae">#task</code> - Only checkboxes with #task tag</li> <li class="svelte-b8rwae"><strong>Tag wildcard:</strong> <code class="svelte-b8rwae">#work/*</code> - Any #work subtag</li> <li class="svelte-b8rwae"><strong>Path:</strong> <code class="svelte-b8rwae">projects/</code> - Only in projects folder</li> <li class="svelte-b8rwae"><strong>Regex:</strong> <code class="svelte-b8rwae">TODO:|TASK:</code> - Checkboxes with TODO: or TASK:</li> <li class="svelte-b8rwae"><strong>Marker:</strong> <code class="svelte-b8rwae">@action</code> - Checkboxes with @action marker</li></ul></div></div>');function vf(a,e){Qe(e,!0);let t=wr.getInstance(),s=ke(t.getConfig()),n=Q("tag"),r=Q(""),o=Q("");function c(){if(!i(r).trim()){Z.error("Pattern cannot be empty");return}const ne=lf(i(n),i(r).trim(),i(o).trim()),fe=of(ne);if(!fe.valid){Z.error(fe.error||"Invalid rule");return}s.rules.push(ne),h(),_(r,""),_(o,""),Z.success("Filter rule added")}function l(ne){s.rules=s.rules.filter(fe=>fe.id!==ne),h(),Z.success("Filter rule deleted")}function u(ne){const fe=s.rules.find(Y=>Y.id===ne);fe&&(fe.enabled=!fe.enabled,h())}function h(){t.updateConfig(s)}function y(){h()}function v(){h()}var p=ff(),k=f(d(p),4),g=d(k),m=d(g);m.__change=v;var b=f(k,2),D=f(d(b),2);D.__change=y;var S=d(D);S.value=S.__value="all";var x=f(S);x.value=x.__value="include";var L=f(x);L.value=L.__value="exclude";var U=f(D,2),M=d(U);{var q=ne=>{var fe=Os("All checkboxes will be treated as tasks (no filtering)");w(ne,fe)},P=ne=>{var fe=Ye(),Y=Re(fe);{var G=T=>{var R=Os("Only checkboxes matching at least one rule will be treated as tasks");w(T,R)},ie=T=>{var R=Ye(),X=Re(R);{var re=E=>{var N=Os("Checkboxes matching any rule will be ignored");w(E,N)};K(X,E=>{s.mode==="exclude"&&E(re)},!0)}w(T,R)};K(Y,T=>{s.mode==="include"?T(G):T(ie,!1)},!0)}w(ne,fe)};K(M,ne=>{s.mode==="all"?ne(q):ne(P,!1)})}var W=f(b,2),J=f(d(W),2);{var se=ne=>{var fe=cf();w(ne,fe)},oe=ne=>{var fe=hf();Be(fe,21,()=>s.rules,wt,(Y,G)=>{var ie=df(),T=d(ie);T.__change=()=>u(i(G).id);var R=f(T,2),X=d(R),re=d(X),E=f(X,2),N=d(E),le=f(E,2);{var Te=we=>{var Ue=uf(),je=d(Ue);H(()=>j(je,i(G).description)),w(we,Ue)};K(le,we=>{i(G).description&&we(Te)})}var Me=f(R,2);Me.__click=()=>l(i(G).id),H(()=>{Ms(T,i(G).enabled),j(re,i(G).type),j(N,i(G).pattern)}),w(Y,ie)}),w(ne,fe)};K(J,ne=>{s.rules.length===0?ne(se):ne(oe,!1)})}var ve=f(W,2),ce=f(d(ve),2),z=d(ce),C=d(z);C.value=C.__value="tag";var F=f(C);F.value=F.__value="regex";var ee=f(F);ee.value=ee.__value="path";var te=f(ee);te.value=te.__value="marker";var ue=f(z,2),de=f(ue,2),me=f(de,2);me.__click=c,al(m,()=>s.enabled,ne=>s.enabled=ne),pr(D,()=>s.mode,ne=>s.mode=ne),pr(z,()=>i(n),ne=>_(n,ne)),tt(ue,()=>i(r),ne=>_(r,ne)),tt(de,()=>i(o),ne=>_(o,ne)),w(a,p),Xe()}nt(["change","click"]);var pf=I('<button class="delete-btn svelte-1qw3eru">Delete</button>'),yf=I('<span class="default-badge svelte-1qw3eru">Default</span>'),mf=I('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),gf=I('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function _f(a,e){Qe(e,!0);let t=ba.getInstance(),s=Q(ke([])),n=Q(""),r=Q(""),o=Q(ke(Ze.TODO)),c=Q("x");function l(){_(s,t.getAll(),!0)}function u(){if(!i(n).trim()||!i(r).trim()){Z.error("Symbol and name are required");return}if(i(n).length!==1){Z.error("Symbol must be a single character");return}const G={symbol:i(n),name:i(r),type:i(o),nextStatusSymbol:i(c)},ie=new Sa(G);t.register(ie),l(),v(),Z.success(`Status "${i(r)}" added`)}function h(G){if([" ","x","/","-"].includes(G)){Z.error("Cannot delete default status");return}t.unregister(G),l(),Z.success("Status deleted")}function y(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),l(),Z.success("Statuses reset to defaults"))}function v(){_(n,""),_(r,""),_(o,Ze.TODO,!0),_(c,"x")}kt(()=>{l()});var p=gf(),k=f(d(p),4),g=d(k),m=d(g),b=f(d(m));Be(b,21,()=>i(s),wt,(G,ie)=>{var T=mf(),R=d(T),X=d(R),re=d(X),E=f(R),N=d(E),le=f(E),Te=d(le),Me=d(Te),we=f(le),Ue=d(we),je=d(Ue),St=f(we),Yt=d(St),it=d(Yt),ua=f(St),ot=d(ua);{var Le=He=>{var lt=pf();lt.__click=()=>h(i(ie).symbol),w(He,lt)},Rt=He=>{var lt=yf();w(He,lt)};K(ot,He=>{[" ","x","/","-"].includes(i(ie).symbol)?He(Rt,!1):He(Le)})}H(()=>{j(re,`[${i(ie).symbol??""}]`),j(N,i(ie).name),j(Me,i(ie).type),j(je,`[${i(ie).nextStatusSymbol??""}]`),j(it,`- [${i(ie).symbol??""}] Task example`)}),w(G,T)});var D=f(k,2),S=f(d(D),2),x=d(S),L=d(x),U=f(d(L),2),M=f(L,2),q=f(d(M),2),P=f(M,2),W=f(d(P),2),J=d(W),se={},oe=f(J),ve={},ce=f(oe),z={},C=f(ce),F={},ee=f(C),te={},ue=f(P,2),de=f(d(ue),2),me=f(ue,2),ne=f(d(me),2);ne.__click=u;var fe=f(D,2),Y=d(fe);Y.__click=y,H(()=>{se!==(se=Ze.TODO)&&(J.value=(J.__value=Ze.TODO)??""),ve!==(ve=Ze.IN_PROGRESS)&&(oe.value=(oe.__value=Ze.IN_PROGRESS)??""),z!==(z=Ze.DONE)&&(ce.value=(ce.__value=Ze.DONE)??""),F!==(F=Ze.CANCELLED)&&(C.value=(C.__value=Ze.CANCELLED)??""),te!==(te=Ze.NON_TASK)&&(ee.value=(ee.__value=Ze.NON_TASK)??"")}),tt(U,()=>i(n),G=>_(n,G)),tt(q,()=>i(r),G=>_(r,G)),pr(W,()=>i(o),G=>_(o,G)),tt(de,()=>i(c),G=>_(c,G)),w(a,p),Xe()}nt(["click"]);var bf=I('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),kf=I("<div> </div>"),wf=I('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),Tf=I('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Sf=I('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),Df=I('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section>'),Ef=I('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),xf=I('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filter</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function Af(a,e){Qe(e,!0);let t=Q(ke(yr)),s=Q(null),n=ke({}),r=Q("general");kt(()=>{_(t,e.eventService.getConfig(),!0)});async function o(){try{await e.eventService.saveConfig(i(t)),Z.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(q){Z.error("Failed to save settings: "+q)}}async function c(){_(s,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const q=await e.eventService.testConnection();n.n8n={success:q.success,message:q.success?"Test successful!":q.message||"Test failed. Check configuration."}}catch(q){n.n8n={success:!1,message:"Error: "+(q instanceof Error?q.message:String(q))}}finally{_(s,null)}}var l=xf(),u=d(l),h=f(d(u),2);{var y=q=>{var P=bf();P.__click=function(...W){var J;(J=e.onClose)==null||J.apply(this,W)},w(q,P)};K(h,q=>{e.onClose&&q(y)})}var v=f(u,2),p=d(v),k=d(p);k.__click=()=>_(r,"general");var g=f(k,2);g.__click=()=>_(r,"filter");var m=f(g,2);m.__click=()=>_(r,"statuses");var b=f(m,2);b.__click=()=>_(r,"shortcuts");var D=f(p,2),S=d(D);{var x=q=>{var P=wf(),W=d(P),J=f(d(W),2),se=d(J),oe=f(W,2),ve=f(d(oe),2),ce=f(oe,2),z=f(d(ce),2),C=f(ce,2);C.__click=c;var F=d(C),ee=f(C,2);{var te=ue=>{var de=kf(),me=d(de);H(()=>{Pe(de,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),j(me,n.n8n.message)}),w(ue,de)};K(ee,ue=>{n.n8n&&ue(te)})}H(()=>{ve.disabled=!i(t).n8n.enabled,z.disabled=!i(t).n8n.enabled,C.disabled=!i(t).n8n.enabled||i(s)==="n8n",j(F,i(s)==="n8n"?"Testing...":"Test Connection")}),al(se,()=>i(t).n8n.enabled,ue=>i(t).n8n.enabled=ue),tt(ve,()=>i(t).n8n.webhookUrl,ue=>i(t).n8n.webhookUrl=ue),tt(z,()=>i(t).n8n.sharedSecret,ue=>i(t).n8n.sharedSecret=ue),w(q,P)},L=q=>{var P=Ye(),W=Re(P);{var J=oe=>{vf(oe,{})},se=oe=>{var ve=Ye(),ce=Re(ve);{var z=F=>{_f(F,{})},C=F=>{var ee=Ye(),te=Re(ee);{var ue=de=>{var me=Df(),ne=f(d(me),2);Be(ne,21,()=>nf,wt,(fe,Y)=>{var G=Sf(),ie=d(G),T=d(ie),R=d(T),X=f(T,2),re=d(X),E=f(X,2);{var N=Me=>{var we=Tf(),Ue=d(we);H(()=>j(Ue,i(Y).context)),w(Me,we)};K(E,Me=>{i(Y).context&&Me(N)})}var le=f(ie,2),Te=d(le);H(()=>{j(R,i(Y).label),j(re,i(Y).description),j(Te,i(Y).keys)}),w(fe,G)}),w(de,me)};K(te,de=>{i(r)==="shortcuts"&&de(ue)},!0)}w(F,ee)};K(ce,F=>{i(r)==="statuses"?F(z):F(C,!1)},!0)}w(oe,ve)};K(W,oe=>{i(r)==="filter"?oe(J):oe(se,!1)},!0)}w(q,P)};K(S,q=>{i(r)==="general"?q(x):q(L,!1)})}var U=f(v,2);{var M=q=>{var P=Ef(),W=d(P);W.__click=o,w(q,P)};K(U,q=>{i(r)==="general"&&q(M)})}H(()=>{Pe(k,1,`settings__nav-btn ${i(r)==="general"?"active":""}`,"svelte-1ke3hir"),Pe(g,1,`settings__nav-btn ${i(r)==="filter"?"active":""}`,"svelte-1ke3hir"),Pe(m,1,`settings__nav-btn ${i(r)==="statuses"?"active":""}`,"svelte-1ke3hir"),Pe(b,1,`settings__nav-btn ${i(r)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),w(a,l),Xe()}nt(["click"]);var Cf=I('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),If=I('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Of=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Mf=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Nf=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),qf=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Rf=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Lf=I('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>Blocking</button> <button>High Priority</button></div>'),Ff=I('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">üì• Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">üìã Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">üìÖ Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">‚úÖ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">üìÅ Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">üîç Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">üìù All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),Bf=I('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div></div> <!></div>');function Uf(a,e){Qe(e,!0);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let n=Q("today"),r=Q(!1),o=Q(!1),c=Q(void 0),l=Q(ke(new Set)),u=Q(ke([])),h=$(()=>Tu(i(u))),y=Q(!1);const v=$(()=>["inbox","today","upcoming","done","projects","search","all"].includes(i(n))?`dashboard-tab-${i(n)}`:void 0),p=$(()=>()=>{let T=i(u);if(i(l).has("notDone")&&(T=T.filter(R=>R.status!=="done"&&R.status!=="cancelled")),i(l).has("dueToday")){const R=new Date;R.setHours(0,0,0,0);const X=new Date(R);X.setDate(X.getDate()+1),T=T.filter(re=>{if(!re.dueAt)return!1;const E=new Date(re.dueAt);return E>=R&&E<X})}if(i(l).has("overdue")){const R=new Date;R.setHours(0,0,0,0),T=T.filter(X=>!X.dueAt||X.status==="done"||X.status==="cancelled"?!1:new Date(X.dueAt)<R)}return i(l).has("inProgress")&&(T=T.filter(R=>R.status==="todo"&&R.statusSymbol&&R.statusSymbol!==" ")),i(l).has("blocked")&&(T=T.filter(R=>_u(R,i(u)))),i(l).has("blocking")&&(T=T.filter(R=>bu(R,i(u)))),i(l).has("highPriority")&&(T=T.filter(R=>{const X=ln(R.priority)||"normal";return X==="high"||X==="highest"})),T}),k=$(()=>i(u).filter(T=>T.status!=="done"&&T.status!=="cancelled"&&!T.dueAt&&!T.scheduledAt&&!T.startAt).length),g=$(()=>()=>{const T=new Date;T.setHours(0,0,0,0);const R=new Date(T);return R.setDate(R.getDate()+7),i(u).filter(X=>{if(X.status==="done"||X.status==="cancelled"||!X.dueAt)return!1;const re=new Date(X.dueAt);return re.setHours(0,0,0,0),re>T&&re<=R}).length}),m=$(()=>()=>{const T=new Date;return T.setDate(T.getDate()-30),T.setHours(0,0,0,0),i(u).filter(R=>R.status!=="done"||!R.doneAt?!1:new Date(R.doneAt)>=T).length}),b=$(()=>i(u).filter(T=>T.status!=="done"&&T.status!=="cancelled").length);function D(T="initial"){_(y,!0),_(u,e.repository.getAllTasks().map(R=>({...R})),!0),_(y,!1),T!=="initial"&&Z.info("Task list reloaded")}D();const S=()=>D("reload");Yn(()=>{window.addEventListener("recurring-task-refresh",S)}),ou(()=>{window.removeEventListener("recurring-task-refresh",S)});async function x(T){Ge.emit("task: complete",{taskId:T.id})}async function L(T){const R=i(u),X=er(i(u),T.id,re=>{const E={...re},N=new Date(E.dueAt),le=t.tomorrow();return le.setHours(N.getHours(),N.getMinutes(),0,0),E.dueAt=le.toISOString(),E.snoozeCount=(E.snoozeCount||0)+1,E.updatedAt=new Date().toISOString(),E});_(u,X,!0),Z.info(`Task "${T.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",T),await e.scheduler.delayToTomorrow(T.id)}catch(re){_(u,R,!0),Z.error("Failed to delay task:  "+re),D("external")}}async function U(T){var X;if(!((X=T.name)!=null&&X.trim())){Z.error("Task name is required");return}if(!sl(T.frequency)){Z.error("Invalid frequency configuration");return}const R={...T};_(u,Jn(i(u),R),!0),_(r,!1),_(c,void 0),Z.success(`Task "${T.name}" saved successfully`),e.repository.saveTask(R).catch(re=>{Z.error("Failed to save task: "+re),D("external")})}async function M(T){const R=i(u);_(u,Ai(i(u),T.id),!0);const X=window.setTimeout(async()=>{try{await e.repository.deleteTask(T.id)}catch(re){_(u,R,!0),Z.error("Failed to delete task: "+re),D("external")}},5e3);ss({message:`Task "${T.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(X),_(u,R,!0),Z.info(`Restored "${T.name}"`)},showCountdown:!0})}async function q(T){const R=T.name.endsWith(" (copy)")?`${T.name} ${new Date().toLocaleDateString()}`:`${T.name} (copy)`,X=il(T,{name:R});_(u,Jn(i(u),X),!0),Z.success(`Duplicated "${T.name}"`),e.repository.saveTask(X).catch(re=>{_(u,Ai(i(u),X.id),!0),Z.error("Failed to duplicate task: "+re),D("external")})}async function P(T){const R=!T.enabled,X={...T,enabled:R},re=er(i(u),T.id,()=>X);_(u,re,!0),Z.info(`Task ${R?"enabled":"disabled"}`),e.repository.saveTask(X).catch(E=>{Z.error("Failed to update task: "+E),D("external")})}async function W(T,R){if(T.length===0)return;const X=i(u),re=new Set(T),E=i(u).map(N=>re.has(N.id)?{...N,enabled:R}:N);_(u,E,!0),Z.info(`${R?"Enabled":"Disabled"} ${T.length} task${T.length===1?"":"s"}`);try{const N=E.filter(le=>re.has(le.id));await Promise.all(N.map(le=>e.repository.saveTask(le)))}catch(N){_(u,X,!0),Z.error(`Failed to ${R?"enable":"disable"} tasks: ${N}`),D("external")}}async function J(T){if(T.length===0)return;const R=i(u),X=new Set(T),re=i(u).filter(N=>X.has(N.id));_(u,i(u).filter(N=>!X.has(N.id)),!0);const E=window.setTimeout(async()=>{try{await Promise.all(re.map(N=>e.repository.deleteTask(N.id)))}catch(N){_(u,R,!0),Z.error("Failed to delete tasks: "+N),D("external")}},5e3);ss({message:`${re.length} task${re.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(E),_(u,R,!0),Z.info("Bulk delete undone")},showCountdown:!0})}function se(T){_(c,T,!0),_(r,!0)}function oe(){_(c,void 0),_(r,!0)}function ve(){_(r,!1),_(c,void 0)}function ce(){_(o,!0)}function z(){_(o,!1)}async function C(T){const R=i(u),X=er(i(u),T.id,re=>{const E={...re};ol(E);const N=s.calculateNext(new Date(E.dueAt),E.frequency);return E.dueAt=N.toISOString(),E});_(u,X,!0),Z.info(`Task "${T.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",T),await e.scheduler.skipTaskOccurrence(T.id)}catch(re){_(u,R,!0),Z.error("Failed to skip task: "+re),D("external")}}function F(T){const R=new Set(i(l));R.has(T)?R.delete(T):R.add(T),_(l,R,!0)}async function ee(T){const R={...T,status:"todo",doneAt:void 0};_(u,Jn(i(u),R),!0),Z.success(`Task "${T.name}" marked as not done`),e.repository.saveTask(R).catch(X=>{Z.error("Failed to update task: "+X),D("external")})}var te=Bf(),ue=d(te),de=f(d(ue),2),me=d(de);me.__click=()=>D("reload");var ne=d(me),fe=f(me,2);fe.__click=ce;var Y=f(ue,2);{var G=T=>{var R=Cf(),X=d(R);Af(X,{get eventService(){return e.eventService},onClose:z}),w(T,R)},ie=T=>{var R=Ye(),X=Re(R);{var re=N=>{var le=If(),Te=d(le);dl(Te,{get task(){return i(c)},get repository(){return e.repository},onSave:U,onClose:ve}),w(N,le)},E=N=>{var le=Ff(),Te=Re(le),Me=d(Te);Me.__click=()=>_(n,"inbox");var we=f(d(Me));{var Ue=be=>{var qe=Of(),We=d(qe);H(()=>j(We,i(k))),w(be,qe)};K(we,be=>{i(k)>0&&be(Ue)})}var je=f(Me,2);je.__click=()=>_(n,"today");var St=f(d(je));{var Yt=be=>{var qe=Mf(),We=d(qe);H(()=>j(We,i(h).length)),w(be,qe)};K(St,be=>{i(h).length>0&&be(Yt)})}var it=f(je,2);it.__click=()=>_(n,"upcoming");var ua=f(d(it));{var ot=be=>{var qe=Nf(),We=d(qe);H(()=>j(We,i(g))),w(be,qe)};K(ua,be=>{i(g)>0&&be(ot)})}var Le=f(it,2);Le.__click=()=>_(n,"done");var Rt=f(d(Le));{var He=be=>{var qe=qf(),We=d(qe);H(()=>j(We,i(m))),w(be,qe)};K(Rt,be=>{i(m)>0&&be(He)})}var lt=f(Le,2);lt.__click=()=>_(n,"projects");var wa=f(d(lt));{var da=be=>{var qe=Rf(),We=d(qe);H(()=>j(We,i(b))),w(be,qe)};K(wa,be=>{i(b)>0&&be(da)})}var ea=f(lt,2);ea.__click=()=>_(n,"search");var ta=f(ea,2);ta.__click=()=>_(n,"all");var ae=f(d(ta)),ge=d(ae),Ce=f(Te,2);{var Ke=be=>{var qe=Lf(),We=f(d(qe),2);We.__click=()=>F("notDone");var ze=f(We,2);ze.__click=()=>F("dueToday");var ut=f(ze,2);ut.__click=()=>F("overdue");var dt=f(ut,2);dt.__click=()=>F("inProgress");var Dt=f(dt,2);Dt.__click=()=>F("blocked");var Ht=f(Dt,2);Ht.__click=()=>F("blocking");var gt=f(Ht,2);gt.__click=()=>F("highPriority"),H((Kt,Et,sa,Fa,Ft,B,pe)=>{Pe(We,1,`dashboard__filter-btn ${Kt??""}`,"svelte-1y1a8hs"),Pe(ze,1,`dashboard__filter-btn ${Et??""}`,"svelte-1y1a8hs"),Pe(ut,1,`dashboard__filter-btn ${sa??""}`,"svelte-1y1a8hs"),Pe(dt,1,`dashboard__filter-btn ${Fa??""}`,"svelte-1y1a8hs"),Pe(Dt,1,`dashboard__filter-btn ${Ft??""}`,"svelte-1y1a8hs"),Pe(Ht,1,`dashboard__filter-btn ${B??""}`,"svelte-1y1a8hs"),Pe(gt,1,`dashboard__filter-btn ${pe??""}`,"svelte-1y1a8hs")},[()=>i(l).has("notDone")?"active":"",()=>i(l).has("dueToday")?"active":"",()=>i(l).has("overdue")?"active":"",()=>i(l).has("inProgress")?"active":"",()=>i(l).has("blocked")?"active":"",()=>i(l).has("blocking")?"active":"",()=>i(l).has("highPriority")?"active":""]),w(be,qe)};K(Ce,be=>{i(n)!=="search"&&i(n)!=="timeline"&&i(n)!=="analytics"&&be(Ke)})}var mt=f(Ce,2),ct=d(mt);{var aa=be=>{{let qe=$(()=>i(l).size>0?i(p):i(u));xd(be,{get tasks(){return i(qe)},onEdit:se,onDone:x,onDelete:M})}},Lt=be=>{var qe=Ye(),We=Re(qe);{var ze=dt=>{{let Dt=$(()=>i(l).size>0?i(p).filter(Ht=>i(h).some(gt=>gt.id===Ht.id)):i(h));Vu(dt,{get tasks(){return i(Dt)},onDone:x,onDelay:L,onSkip:C,onEdit:se,get timezoneHandler(){return t}})}},ut=dt=>{var Dt=Ye(),Ht=Re(Dt);{var gt=Et=>{{let sa=$(()=>i(l).size>0?i(p):i(u));Md(Et,{get tasks(){return i(sa)},onEdit:se,onDone:x,onDelete:M})}},Kt=Et=>{var sa=Ye(),Fa=Re(sa);{var Ft=pe=>{{let Je=$(()=>i(l).size>0?i(p):i(u));Ud(pe,{get tasks(){return i(Je)},onEdit:se,onDelete:M,onUncomplete:ee})}},B=pe=>{var Je=Ye(),$a=Re(Je);{var Vs=bs=>{{let yn=$(()=>i(l).size>0?i(p):i(u));Kd(bs,{get tasks(){return i(yn)},onEdit:se,onDone:x,onDelete:M})}},Tl=bs=>{var yn=Ye(),Sl=Re(yn);{var Dl=ks=>{Oh(ks,{get tasks(){return i(u)},onEdit:se,onDone:x,onDelete:M})},El=ks=>{var Zr=Ye(),xl=Re(Zr);{var Al=ws=>{{let mn=$(()=>i(l).size>0?i(p):i(u));sd(ws,{get tasks(){return i(mn)},onEdit:se,onDelete:M,onDuplicate:q,onToggleEnabled:P,onBulkEnable:Qs=>W(Qs,!0),onBulkDisable:Qs=>W(Qs,!1),onBulkDelete:J,onCreate:oe})}},Cl=ws=>{var mn=Ye(),Qs=Re(mn);{var Il=Ts=>{hd(Ts,{get tasks(){return i(u)},get recurrenceEngine(){return s}})},Ol=Ts=>{var Jr=Ye(),Ml=Re(Jr);{var Nl=Kn=>{Td(Kn,{get tasks(){return i(u)}})};K(Ml,Kn=>{i(n)==="analytics"&&Kn(Nl)},!0)}w(Ts,Jr)};K(Qs,Ts=>{i(n)==="timeline"?Ts(Il):Ts(Ol,!1)},!0)}w(ws,mn)};K(xl,ws=>{i(n)==="all"?ws(Al):ws(Cl,!1)},!0)}w(ks,Zr)};K(Sl,ks=>{i(n)==="search"?ks(Dl):ks(El,!1)},!0)}w(bs,yn)};K($a,bs=>{i(n)==="projects"?bs(Vs):bs(Tl,!1)},!0)}w(pe,Je)};K(Fa,pe=>{i(n)==="done"?pe(Ft):pe(B,!1)},!0)}w(Et,sa)};K(Ht,Et=>{i(n)==="upcoming"?Et(gt):Et(Kt,!1)},!0)}w(dt,Dt)};K(We,dt=>{i(n)==="today"?dt(ze):dt(ut,!1)},!0)}w(be,qe)};K(ct,be=>{i(n)==="inbox"?be(aa):be(Lt,!1)})}H(()=>{Pe(Me,1,`dashboard__tab ${i(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),xe(Me,"aria-selected",i(n)==="inbox"),Pe(je,1,`dashboard__tab ${i(n)==="today"?"active":""}`,"svelte-1y1a8hs"),xe(je,"aria-selected",i(n)==="today"),Pe(it,1,`dashboard__tab ${i(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),xe(it,"aria-selected",i(n)==="upcoming"),Pe(Le,1,`dashboard__tab ${i(n)==="done"?"active":""}`,"svelte-1y1a8hs"),xe(Le,"aria-selected",i(n)==="done"),Pe(lt,1,`dashboard__tab ${i(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),xe(lt,"aria-selected",i(n)==="projects"),Pe(ea,1,`dashboard__tab ${i(n)==="search"?"active":""}`,"svelte-1y1a8hs"),xe(ea,"aria-selected",i(n)==="search"),Pe(ta,1,`dashboard__tab ${i(n)==="all"?"active":""}`,"svelte-1y1a8hs"),xe(ta,"aria-selected",i(n)==="all"),j(ge,i(u).length),xe(mt,"aria-labelledby",i(v))}),w(N,le)};K(X,N=>{i(r)?N(re):N(E,!1)},!0)}w(T,R)};K(Y,T=>{i(o)?T(G):T(ie,!1)})}H(()=>{me.disabled=i(y),j(ne,i(y)?"‚ü≥":"‚Üª")}),w(a,te),Xe()}nt(["click"]);var Pf=I('<div class="quick-add-card__error svelte-1q3w22"> </div>'),jf=I('<div class="quick-add-card__error svelte-1q3w22"> </div>'),zf=I('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),Yf=I('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),Hf=I('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function Kf(a,e){var z;Qe(e,!0);let t=Q(ke(((z=e.prefill)==null?void 0:z.suggestedName)??"")),s=Q(ke(new Date().toISOString().slice(0,16))),n=Q(ke({name:!1,dueAt:!1})),r=Q(!1),o=Q(null);const c=$(()=>i(n).name&&!i(t).trim()?"Task name is required.":""),l=$(()=>i(n).dueAt?i(s)?Number.isNaN(new Date(i(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=$(()=>!!(i(c)||i(l)));Yn(()=>{var C;if((C=e.prefill)!=null&&C.suggestedTime){const F=new Date,[ee,te]=e.prefill.suggestedTime.split(":").map(Number);F.setHours(ee,te,0,0),_(s,F.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var F;(F=i(o))==null||F.focus()})});async function h(){var te,ue;if(_(n,{name:!0,dueAt:!0},!0),i(u)){Z.warning("Please fill out the required fields.");return}const C=cu(),F=i(s).slice(11,16);if(C.time=F,!sl(C)){Z.error("Invalid frequency configuration.");return}const ee=nl(i(t).trim(),C,new Date(i(s)));ee.linkedBlockId=((te=e.prefill)==null?void 0:te.linkedBlockId)||void 0,ee.linkedBlockContent=((ue=e.prefill)==null?void 0:ue.linkedBlockContent)||void 0,_(r,!0);try{await e.repository.saveTask(ee),Z.success(`Task "${ee.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(de){Z.error("Failed to create task: "+de)}finally{_(r,!1)}}function y(C){C.key==="Escape"&&e.onClose(),(C.metaKey||C.ctrlKey)&&C.key==="Enter"&&(C.preventDefault(),h())}var v=Hf();v.__keydown=y;var p=d(v),k=d(p),g=f(d(k),2);g.__click=function(...C){var F;(F=e.onClose)==null||F.apply(this,C)};var m=f(k,2),b=f(d(m),2);b.__input=()=>i(n).name=!0,ca(b,C=>_(o,C),()=>i(o));var D=f(b,2);{var S=C=>{var F=Pf(),ee=d(F);H(()=>j(ee,i(c))),w(C,F)};K(D,C=>{i(c)&&C(S)})}var x=f(m,2),L=f(d(x),2);L.__input=()=>i(n).dueAt=!0;var U=f(L,2);{var M=C=>{var F=jf(),ee=d(F);H(()=>j(ee,i(l))),w(C,F)};K(U,C=>{i(l)&&C(M)})}var q=f(x,2);{var P=C=>{var F=zf(),ee=f(d(F)),te=d(ee);H(()=>j(te,e.prefill.linkedBlockId)),w(C,F)};K(q,C=>{var F;(F=e.prefill)!=null&&F.linkedBlockId&&C(P)})}var W=f(q,2),J=d(W);J.__click=function(...C){var F;(F=e.onClose)==null||F.apply(this,C)};var se=f(J,2);{var oe=C=>{var F=Yf();F.__click=function(...ee){var te;(te=e.onAdvanced)==null||te.apply(this,ee)},w(C,F)};K(se,C=>{e.onAdvanced&&C(oe)})}var ve=f(se,2);ve.__click=h;var ce=d(ve);H(()=>{xe(b,"aria-invalid",!!i(c)),xe(L,"aria-invalid",!!i(l)),ve.disabled=i(r),j(ce,i(r)?"Saving‚Ä¶":"Create Task")}),pt("blur",b,()=>i(n).name=!0),tt(b,()=>i(t),C=>_(t,C)),pt("blur",L,()=>i(n).dueAt=!0),tt(L,()=>i(s),C=>_(s,C)),w(a,v),Xe()}nt(["keydown","click","input"]);class Wf{constructor(e){A(this,"plugin");this.plugin=e}getCurrentVersion(){return Ua}async createBackup(e,t){try{const s=await this.plugin.loadData(e);if(s){const n=new Date().toISOString().replace(/[:.]/g,"-"),r=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${r}-${n}`;return await this.plugin.saveData(o,s),he(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(s){throw _e("Failed to create backup",s),s}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return he("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Ua};const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0)return he("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Ua};let n=!1,r,o,c=0;for(let l=0;l<s.length;l++){const u=s[l],h=u.version||0;h<Ua&&(n||(o=h,r=await this.createBackup(e,h),n=!0),s[l]=this.migrateTask(u,h),c++,he(`Migrated task ${u.id} from v${h} to v${Ua}`))}if(n){const l=Array.isArray(t)?s:{...t,tasks:s};return await this.plugin.saveData(e,l),he(`Migration complete: ${c} tasks migrated`),{migrated:!0,tasksAffected:c,fromVersion:o,toVersion:Ua,backupKey:r}}else return he("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:Ua}}catch(t){throw _e("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),t<4&&(s={...s,version:4,onCompletion:s.onCompletion||"keep",dependsOn:s.dependsOn||[],blockedBy:s.blockedBy||[]}),s}}class Gf{constructor(e,t=50){A(this,"pendingState",null);A(this,"writeInProgress",!1);A(this,"scheduledTimer",null);A(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){_e("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return _e("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const Tr={},Vf=Object.freeze(Object.defineProperty({__proto__:null,default:Tr},Symbol.toStringTag,{value:"Module"})),qi=new Set;function Sn(a){const e=`${a.feature}:${a.capability}:${a.message}`;qi.has(e)||(qi.add(e),Ve(a.message,{feature:a.feature,capability:a.capability,cause:a.cause}))}class hl extends Error{constructor(t,s,n){super(n);A(this,"capability");A(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class fl extends Error{constructor(t,s,n,r){super(n);A(this,"capability");A(this,"feature");A(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=r}}class Qf{constructor(e=globalThis){A(this,"supportedCapabilities");A(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,n;return typeof((n=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(n){throw new fl("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new hl("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Xf=".tmp";class $f{constructor(e,t){A(this,"plugin");A(this,"apiAdapter");A(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(as);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){_e("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),he(`Saved ${e.tasks.length} active tasks`)}catch(t){throw _e("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(as,e);return}const s=this.resolveStoragePath(as);if(!s){await this.plugin.saveData(as,e);return}const n=Tr.dirname(s);await t.mkdir(n,{recursive:!0});const r=`${s}${Xf}`,o=JSON.stringify(e),c=await t.open(r,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(r,s)}catch{await t.rm(s,{force:!0}),await t.rename(r,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>Vf);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Ve("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Sn({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):Tr.join(t,"storage",`p${s}`,`${e}.json`)}}const Ri=1,Li=1e3;class Zf{constructor(e){A(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[n,r]of s.entries())await this.appendTasksToYear(t,n,r);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),n=[];for(const c of s){const l=await this.loadChunk(c.key);if(l)for(const u of l.tasks)this.matchesQuery(u,e)&&n.push(u)}const r=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(r,r+o)}async loadIndex(){try{const e=await this.plugin.loadData(wn);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??Ri,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){_e("Failed to load archive index",e)}return{version:Ri,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(wn,e)}catch(t){throw _e("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${wn}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){_e("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw _e("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const n=this.getCompletionTimestamp(s),r=new Date(n).getFullYear(),o=t.get(r);o?o.push(s):t.set(r,[s])}return t}async appendTasksToYear(e,t,s){let n=[...s];for(;n.length>0;){const r=this.findOrCreateChunk(e,t),o=await this.loadChunk(r.key)||{tasks:[]},c=Li-o.tasks.length,l=n.slice(0,c);o.tasks.push(...l),n=n.slice(l.length);const u=this.updateChunkMeta(r,l);r.count=u.count,r.start=u.start,r.end=u.end,await this.saveChunk(r.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(n&&n.count<Li)return n;const r=n?n.sequence+1:1,o={key:this.buildChunkKey(t,r),year:t,sequence:r,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,n=e.end;for(const r of t){const o=this.getCompletionTimestamp(r);(!s||o<s)&&(s=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:s,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(r=>{const o=r.start?new Date(r.start).getTime():null,c=r.end?new Date(r.end).getTime():null;return!(s&&c&&c<s||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),n=new Date(s).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Jf{constructor(e,t=new Qf){A(this,"plugin");A(this,"activeTasks");A(this,"blockIndex",new Map);A(this,"taskBlockIndex",new Map);A(this,"dueIndex",new Map);A(this,"activeStore");A(this,"archiveStore");A(this,"persistence");A(this,"blockAttrSyncEnabled",!0);A(this,"blockApi");A(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new $f(e,t),this.archiveStore=new Zf(e),this.persistence=new Gf(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),he(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}async loadActiveTasks(e=1e3,t){const s=await this.activeStore.loadActive(),n=Array.from(s.values()),r=n.length;if(r===0)return[];const o=[];for(let c=0;c<r;c+=e){const l=n.slice(c,Math.min(c+e,r));o.push(...l),t&&t(o.length,r),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));he(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);he(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[n]of this.dueIndex)n<=t&&s.push(...this.getTasksForDueKey(n));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const n of t){const r=this.activeTasks.get(n);if(!r){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!r.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(r.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}s.push(r)}return s}removeStaleDueIndexEntry(e,t,s){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),Ve("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),s=this.taskBlockIndex.get(e.id);s&&s!==e.linkedBlockId&&(this.blockIndex.delete(s),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),s&&s!==e.linkedBlockId&&await this.clearBlockAttrs(s)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Di]:e.id,[Ei]:e.dueAt,[xi]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Di]:"",[Ei]:"",[xi]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Sn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof hl||s instanceof fl?Sn({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Sn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const n=new Date(s.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(as);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(pi);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(yi,t),he(`Created legacy backup at ${yi}`);const n=s.filter(c=>!c.enabled&&c.lastCompletedAt),r=s.filter(c=>!n.includes(c)),o=new Map(r.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),he("Legacy storage migration complete",{activeCount:r.length,archivedCount:n.length,legacyKey:pi,activeKey:as,archiveIndexKey:wn})}}class ev{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}var Sr=["MO","TU","WE","TH","FR","SA","SU"],At=function(){function a(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return a.fromStr=function(e){return new a(Sr.indexOf(e))},a.prototype.nth=function(e){return this.n===e?this:new a(this.weekday,e)},a.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},a.prototype.toString=function(){var e=Sr[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},a.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},a}(),$e=function(a){return a!=null},ha=function(a){return typeof a=="number"},Fi=function(a){return typeof a=="string"&&Sr.includes(a)},Pt=Array.isArray,ka=function(a,e){e===void 0&&(e=a),arguments.length===1&&(e=a,a=0);for(var t=[],s=a;s<e;s++)t.push(s);return t},Ie=function(a,e){var t=0,s=[];if(Pt(a))for(;t<e;t++)s[t]=[].concat(a);else for(;t<e;t++)s[t]=a;return s},tv=function(a){return Pt(a)?a:[a]};function Es(a,e,t){t===void 0&&(t=" ");var s=String(a);return e=e>>0,s.length>e?String(s):(e=e-s.length,e>t.length&&(t+=Ie(t,e/t.length)),t.slice(0,e)+String(s))}var av=function(a,e,t){var s=a.split(e);return t?s.slice(0,t).concat([s.slice(t).join(e)]):s},$t=function(a,e){var t=a%e;return t*e<0?t+e:t},tr=function(a,e){return{div:Math.floor(a/e),mod:$t(a,e)}},ga=function(a){return!$e(a)||a.length===0},et=function(a){return!ga(a)},Fe=function(a,e){return et(a)&&a.indexOf(e)!==-1},ms=function(a,e,t,s,n,r){return s===void 0&&(s=0),n===void 0&&(n=0),r===void 0&&(r=0),new Date(Date.UTC(a,e-1,t,s,n,r))},sv=[31,28,31,30,31,30,31,31,30,31,30,31],vl=1e3*60*60*24,pl=9999,yl=ms(1970,1,1),nv=[6,0,1,2,3,4,5],sn=function(a){return a%4===0&&a%100!==0||a%400===0},ml=function(a){return a instanceof Date},Zs=function(a){return ml(a)&&!isNaN(a.getTime())},rv=function(a,e){var t=a.getTime(),s=e.getTime(),n=t-s;return Math.round(n/vl)},Dr=function(a){return rv(a,yl)},gl=function(a){return new Date(yl.getTime()+a*vl)},iv=function(a){var e=a.getUTCMonth();return e===1&&sn(a.getUTCFullYear())?29:sv[e]},Ys=function(a){return nv[a.getUTCDay()]},Bi=function(a,e){var t=ms(a,e+1,1);return[Ys(t),iv(t)]},_l=function(a,e){return e=e||a,new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Er=function(a){var e=new Date(a.getTime());return e},Ui=function(a){for(var e=[],t=0;t<a.length;t++)e.push(Er(a[t]));return e},un=function(a){a.sort(function(e,t){return e.getTime()-t.getTime()})},Gr=function(a,e){e===void 0&&(e=!0);var t=new Date(a);return[Es(t.getUTCFullYear().toString(),4,"0"),Es(t.getUTCMonth()+1,2,"0"),Es(t.getUTCDate(),2,"0"),"T",Es(t.getUTCHours(),2,"0"),Es(t.getUTCMinutes(),2,"0"),Es(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},Vr=function(a){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(a);if(!t)throw new Error("Invalid UNTIL value: ".concat(a));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},Pi=function(a,e){var t=a.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},ov=function(a,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,s=new Date(Pi(a,t)),n=new Date(Pi(a,e??"UTC")),r=n.getTime()-s.getTime();return new Date(a.getTime()-r)},Cs=function(){function a(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return a.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,s=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(s)return!1}else if(this.method==="before"){if(s)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},a.prototype.add=function(e){return this._result.push(e),!0},a.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},a.prototype.clone=function(){return new a(this.method,this.args)},a}(),xr=function(a,e){return xr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])},xr(a,e)};function Qr(a,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");xr(a,e);function t(){this.constructor=a}a.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var zt=function(){return zt=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++){t=arguments[s];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},zt.apply(this,arguments)};function V(a,e,t){if(t||arguments.length===2)for(var s=0,n=e.length,r;s<n;s++)(r||!(s in e))&&(r||(r=Array.prototype.slice.call(e,0,s)),r[s]=e[s]);return a.concat(r||Array.prototype.slice.call(e))}var ji=function(a){Qr(e,a);function e(t,s,n){var r=a.call(this,t,s)||this;return r.iterator=n,r}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Cs),Cn={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},zi=function(a,e){return a.indexOf(e)!==-1},lv=function(a){return a.toString()},cv=function(a,e,t){return"".concat(e," ").concat(t,", ").concat(a)},La=function(){function a(e,t,s,n){if(t===void 0&&(t=lv),s===void 0&&(s=Cn),n===void 0&&(n=cv),this.text=[],this.language=s||Cn,this.gettext=t,this.dateFormatter=n,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var r=[].concat(this.options.bymonthday),o=[].concat(this.options.bynmonthday);r.sort(function(h,y){return h-y}),o.sort(function(h,y){return y-h}),this.bymonthday=r.concat(o),this.bymonthday.length||(this.bymonthday=null)}if($e(this.origOptions.byweekday)){var c=Pt(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],l=String(c);this.byweekday={allWeeks:c.filter(function(h){return!h.n}),someWeeks:c.filter(function(h){return!!h.n}),isWeekdays:l.indexOf("MO")!==-1&&l.indexOf("TU")!==-1&&l.indexOf("WE")!==-1&&l.indexOf("TH")!==-1&&l.indexOf("FR")!==-1&&l.indexOf("SA")===-1&&l.indexOf("SU")===-1,isEveryDay:l.indexOf("MO")!==-1&&l.indexOf("TU")!==-1&&l.indexOf("WE")!==-1&&l.indexOf("TH")!==-1&&l.indexOf("FR")!==-1&&l.indexOf("SA")!==-1&&l.indexOf("SU")!==-1};var u=function(h,y){return h.weekday-y.weekday};this.byweekday.allWeeks.sort(u),this.byweekday.someWeeks.sort(u),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return a.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in a.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var s in e.origOptions){if(zi(["dtstart","tzid","wkst","freq"],s))return!0;if(!zi(a.IMPLEMENTED[e.options.freq],s))return!1}return t},a.prototype.isFullyConvertible=function(){return a.isFullyConvertible(this.rrule)},a.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in a.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[ye.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},a.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},a.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},a.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},a.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},a.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},a.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},a.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},a.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},a.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},a.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},a.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,s=this.gettext;if(e===-1)return s("last");var n=Math.abs(e);switch(n){case 1:case 21:case 31:t=n+s("st");break;case 2:case 22:t=n+s("nd");break;case 3:case 23:t=n+s("rd");break;default:t=n+s("th")}return e<0?t+" "+s("last"):t},a.prototype.monthtext=function(e){return this.language.monthNames[e-1]},a.prototype.weekdaytext=function(e){var t=ha(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},a.prototype.plural=function(e){return e%100!==1},a.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},a.prototype.list=function(e,t,s,n){var r=this;n===void 0&&(n=","),Pt(e)||(e=[e]);var o=function(l,u,h){for(var y="",v=0;v<l.length;v++)v!==0&&(v===l.length-1?y+=" "+h+" ":y+=u+" "),y+=l[v];return y};t=t||function(l){return l.toString()};var c=function(l){return t&&t.call(r,l)};return s?o(e.map(c),n,s):e.map(c).join(n+" ")},a}(),uv=function(){function a(e){this.done=!0,this.rules=e}return a.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},a.prototype.isDone=function(){return this.done&&this.symbol===null},a.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var s=void 0;e=null;for(var n in this.rules){s=this.rules[n];var r=s.exec(this.text);r&&(e===null||r[0].length>e[0].length)&&(e=r,t=n)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},a.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},a.prototype.acceptNumber=function(){return this.accept("number")},a.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},a}();function bl(a,e){e===void 0&&(e=Cn);var t={},s=new uv(e.tokens);if(!s.start(a))return null;return n(),t;function n(){s.expect("every");var v=s.acceptNumber();if(v&&(t.interval=parseInt(v[0],10)),s.isDone())throw new Error("Unexpected end");switch(s.symbol){case"day(s)":t.freq=ye.DAILY,s.nextSymbol()&&(o(),y());break;case"weekday(s)":t.freq=ye.WEEKLY,t.byweekday=[ye.MO,ye.TU,ye.WE,ye.TH,ye.FR],s.nextSymbol(),o(),y();break;case"week(s)":t.freq=ye.WEEKLY,s.nextSymbol()&&(r(),o(),y());break;case"hour(s)":t.freq=ye.HOURLY,s.nextSymbol()&&(r(),y());break;case"minute(s)":t.freq=ye.MINUTELY,s.nextSymbol()&&(r(),y());break;case"month(s)":t.freq=ye.MONTHLY,s.nextSymbol()&&(r(),y());break;case"year(s)":t.freq=ye.YEARLY,s.nextSymbol()&&(r(),y());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=ye.WEEKLY;var p=s.symbol.substr(0,2).toUpperCase();if(t.byweekday=[ye[p]],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");var k=l();if(!k)throw new Error("Unexpected symbol "+s.symbol+", expected weekday");t.byweekday.push(ye[k]),s.nextSymbol()}o(),h(),y();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=ye.YEARLY,t.bymonth=[c()],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");var g=c();if(!g)throw new Error("Unexpected symbol "+s.symbol+", expected month");t.bymonth.push(g),s.nextSymbol()}r(),y();break;default:throw new Error("Unknown symbol")}}function r(){var v=s.accept("on"),p=s.accept("the");if(v||p)do{var k=u(),g=l(),m=c();if(k)g?(s.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(ye[g].nth(k))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(k),s.accept("day(s)"));else if(g)s.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(ye[g]);else if(s.symbol==="weekday(s)")s.nextSymbol(),t.byweekday||(t.byweekday=[ye.MO,ye.TU,ye.WE,ye.TH,ye.FR]);else if(s.symbol==="week(s)"){s.nextSymbol();var b=s.acceptNumber();if(!b)throw new Error("Unexpected symbol "+s.symbol+", expected week number");for(t.byweekno=[parseInt(b[0],10)];s.accept("comma");){if(b=s.acceptNumber(),!b)throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");t.byweekno.push(parseInt(b[0],10))}}else if(m)s.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(m);else return}while(s.accept("comma")||s.accept("the")||s.accept("on"))}function o(){var v=s.accept("at");if(v)do{var p=s.acceptNumber();if(!p)throw new Error("Unexpected symbol "+s.symbol+", expected hour");for(t.byhour=[parseInt(p[0],10)];s.accept("comma");){if(p=s.acceptNumber(),!p)throw new Error("Unexpected symbol "+s.symbol+"; expected hour");t.byhour.push(parseInt(p[0],10))}}while(s.accept("comma")||s.accept("at"))}function c(){switch(s.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function l(){switch(s.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return s.symbol.substr(0,2).toUpperCase();default:return!1}}function u(){switch(s.symbol){case"last":return s.nextSymbol(),-1;case"first":return s.nextSymbol(),1;case"second":return s.nextSymbol(),s.accept("last")?-2:2;case"third":return s.nextSymbol(),s.accept("last")?-3:3;case"nth":var v=parseInt(s.value[1],10);if(v<-366||v>366)throw new Error("Nth out of range: "+v);return s.nextSymbol(),s.accept("last")?-v:v;default:return!1}}function h(){s.accept("on"),s.accept("the");var v=u();if(v)for(t.bymonthday=[v],s.nextSymbol();s.accept("comma");){if(v=u(),!v)throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");t.bymonthday.push(v),s.nextSymbol()}}function y(){if(s.symbol==="until"){var v=Date.parse(s.text);if(!v)throw new Error("Cannot parse until date:"+s.text);t.until=new Date(v)}else s.accept("for")&&(t.count=parseInt(s.value[0],10),s.expect("number"))}}var Oe;(function(a){a[a.YEARLY=0]="YEARLY",a[a.MONTHLY=1]="MONTHLY",a[a.WEEKLY=2]="WEEKLY",a[a.DAILY=3]="DAILY",a[a.HOURLY=4]="HOURLY",a[a.MINUTELY=5]="MINUTELY",a[a.SECONDLY=6]="SECONDLY"})(Oe||(Oe={}));function Xr(a){return a<Oe.HOURLY}var dv=function(a,e){return e===void 0&&(e=Cn),new ye(bl(a,e)||void 0)},Gs=["count","until","interval","byweekday","bymonthday","bymonth"];La.IMPLEMENTED=[];La.IMPLEMENTED[Oe.HOURLY]=Gs;La.IMPLEMENTED[Oe.MINUTELY]=Gs;La.IMPLEMENTED[Oe.DAILY]=["byhour"].concat(Gs);La.IMPLEMENTED[Oe.WEEKLY]=Gs;La.IMPLEMENTED[Oe.MONTHLY]=Gs;La.IMPLEMENTED[Oe.YEARLY]=["byweekno","byyearday"].concat(Gs);var hv=function(a,e,t,s){return new La(a,e,t,s).toString()},fv=La.isFullyConvertible,In=function(){function a(e,t,s,n){this.hour=e,this.minute=t,this.second=s,this.millisecond=n||0}return a.prototype.getHours=function(){return this.hour},a.prototype.getMinutes=function(){return this.minute},a.prototype.getSeconds=function(){return this.second},a.prototype.getMilliseconds=function(){return this.millisecond},a.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},a}(),vv=function(a){Qr(e,a);function e(t,s,n,r,o,c,l){var u=a.call(this,r,o,c,l)||this;return u.year=t,u.month=s,u.day=n,u}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return Ys(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var s=Math.floor(this.month/12),n=$t(this.month,12);this.month=n,this.year+=s,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,s){s>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-s))+t*7:this.day+=-(this.getWeekday()-s)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,s,n){for(s&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var r=tr(this.hour,24),o=r.div,c=r.mod;if(o&&(this.hour=c,this.addDaily(o)),ga(n)||Fe(n,this.hour))break}},e.prototype.addMinutes=function(t,s,n,r){for(s&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var o=tr(this.minute,60),c=o.div,l=o.mod;if(c&&(this.minute=l,this.addHours(c,!1,n)),(ga(n)||Fe(n,this.hour))&&(ga(r)||Fe(r,this.minute)))break}},e.prototype.addSeconds=function(t,s,n,r,o){for(s&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var c=tr(this.second,60),l=c.div,u=c.mod;if(l&&(this.second=u,this.addMinutes(l,!1,n,r)),(ga(n)||Fe(n,this.hour))&&(ga(r)||Fe(r,this.minute))&&(ga(o)||Fe(o,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=Bi(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>pl))return;t=Bi(this.year,this.month-1)[1]}}},e.prototype.add=function(t,s){var n=t.freq,r=t.interval,o=t.wkst,c=t.byhour,l=t.byminute,u=t.bysecond;switch(n){case Oe.YEARLY:return this.addYears(r);case Oe.MONTHLY:return this.addMonths(r);case Oe.WEEKLY:return this.addWeekly(r,o);case Oe.DAILY:return this.addDaily(r);case Oe.HOURLY:return this.addHours(r,s,c);case Oe.MINUTELY:return this.addMinutes(r,s,c,l);case Oe.SECONDLY:return this.addSeconds(r,s,c,l,u)}},e}(In);function kl(a){for(var e=[],t=Object.keys(a),s=0,n=t;s<n.length;s++){var r=n[s];Fe(Hv,r)||e.push(r),ml(a[r])&&!Zs(a[r])&&e.push(r)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return zt({},a)}function pv(a){var e=zt(zt({},$r),kl(a));if($e(e.byeaster)&&(e.freq=ye.YEARLY),!($e(e.freq)&&ye.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(a.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),$e(e.wkst)?ha(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=ye.MO.weekday,$e(e.bysetpos)){ha(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var s=e.bysetpos[t];if(s===0||!(s>=-366&&s<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||et(e.byweekno)||et(e.byyearday)||e.bymonthday||et(e.bymonthday)||$e(e.byweekday)||$e(e.byeaster)))switch(e.freq){case ye.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case ye.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case ye.WEEKLY:e.byweekday=[Ys(e.dtstart)];break}if($e(e.bymonth)&&!Pt(e.bymonth)&&(e.bymonth=[e.bymonth]),$e(e.byyearday)&&!Pt(e.byyearday)&&ha(e.byyearday)&&(e.byyearday=[e.byyearday]),!$e(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(Pt(e.bymonthday)){for(var n=[],r=[],t=0;t<e.bymonthday.length;t++){var s=e.bymonthday[t];s>0?n.push(s):s<0&&r.push(s)}e.bymonthday=n,e.bynmonthday=r}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if($e(e.byweekno)&&!Pt(e.byweekno)&&(e.byweekno=[e.byweekno]),!$e(e.byweekday))e.bynweekday=null;else if(ha(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(Fi(e.byweekday))e.byweekday=[At.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof At)!e.byweekday.n||e.freq>ye.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var o=[],c=[],t=0;t<e.byweekday.length;t++){var l=e.byweekday[t];if(ha(l)){o.push(l);continue}else if(Fi(l)){o.push(At.fromStr(l).weekday);continue}!l.n||e.freq>ye.MONTHLY?o.push(l.weekday):c.push([l.weekday,l.n])}e.byweekday=et(o)?o:null,e.bynweekday=et(c)?c:null}return $e(e.byhour)?ha(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<ye.HOURLY?[e.dtstart.getUTCHours()]:null,$e(e.byminute)?ha(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<ye.MINUTELY?[e.dtstart.getUTCMinutes()]:null,$e(e.bysecond)?ha(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<ye.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function yv(a){var e=a.dtstart.getTime()%1e3;if(!Xr(a.freq))return[];var t=[];return a.byhour.forEach(function(s){a.byminute.forEach(function(n){a.bysecond.forEach(function(r){t.push(new In(s,n,r,e))})})}),t}function Ar(a){var e=a.split(`
`).map(mv).filter(function(t){return t!==null});return zt(zt({},e[0]),e[1])}function On(a){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(a);if(!t)return e;var s=t[1],n=t[2];return s&&(e.tzid=s),e.dtstart=Vr(n),e}function mv(a){if(a=a.replace(/^\s+|\s+$/,""),!a.length)return null;var e=/^([A-Z]+?)[:;]/.exec(a.toUpperCase());if(!e)return Yi(a);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return Yi(a);case"DTSTART":return On(a);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(a))}}function Yi(a){var e=a.replace(/^RRULE:/i,""),t=On(e),s=a.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return s.forEach(function(n){var r=n.split("="),o=r[0],c=r[1];switch(o.toUpperCase()){case"FREQ":t.freq=Oe[c.toUpperCase()];break;case"WKST":t.wkst=oa[c.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var l=gv(c),u=o.toLowerCase();t[u]=l;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=_v(c);break;case"DTSTART":case"TZID":var h=On(a);t.tzid=h.tzid,t.dtstart=h.dtstart;break;case"UNTIL":t.until=Vr(c);break;case"BYEASTER":t.byeaster=Number(c);break;default:throw new Error("Unknown RRULE property '"+o+"'")}}),t}function gv(a){if(a.indexOf(",")!==-1){var e=a.split(",");return e.map(Hi)}return Hi(a)}function Hi(a){return/^[+-]?\d+$/.test(a)?Number(a):a}function _v(a){var e=a.split(",");return e.map(function(t){if(t.length===2)return oa[t];var s=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!s||s.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var n=Number(s[1]),r=s[2],o=oa[r].weekday;return new At(o,n)})}var Mn=function(){function a(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(a.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),a.prototype.toString=function(){var e=Gr(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},a.prototype.getTime=function(){return this.date.getTime()},a.prototype.rezonedDate=function(){return this.isUTC?this.date:ov(this.date,this.tzid)},a}();function Cr(a){for(var e=[],t="",s=Object.keys(a),n=Object.keys($r),r=0;r<s.length;r++)if(s[r]!=="tzid"&&Fe(n,s[r])){var o=s[r].toUpperCase(),c=a[s[r]],l="";if(!(!$e(c)||Pt(c)&&!c.length)){switch(o){case"FREQ":l=ye.FREQUENCIES[a.freq];break;case"WKST":ha(c)?l=new At(c).toString():l=c.toString();break;case"BYWEEKDAY":o="BYDAY",l=tv(c).map(function(p){return p instanceof At?p:Pt(p)?new At(p[0],p[1]):new At(p)}).toString();break;case"DTSTART":t=bv(c,a.tzid);break;case"UNTIL":l=Gr(c,!a.tzid);break;default:if(Pt(c)){for(var u=[],h=0;h<c.length;h++)u[h]=String(c[h]);l=u.toString()}else l=String(c)}l&&e.push([o,l])}}var y=e.map(function(p){var k=p[0],g=p[1];return"".concat(k,"=").concat(g.toString())}).join(";"),v="";return y!==""&&(v="RRULE:".concat(y)),[t,v].filter(function(p){return!!p}).join(`
`)}function bv(a,e){return a?"DTSTART"+new Mn(new Date(a),e).toString():""}function kv(a,e){return Array.isArray(a)?!Array.isArray(e)||a.length!==e.length?!1:a.every(function(t,s){return t.getTime()===e[s].getTime()}):a instanceof Date?e instanceof Date&&a.getTime()===e.getTime():a===e}var wv=function(){function a(){this.all=!1,this.before=[],this.after=[],this.between=[]}return a.prototype._cacheAdd=function(e,t,s){t&&(t=t instanceof Date?Er(t):Ui(t)),e==="all"?this.all=t:(s._value=t,this[e].push(s))},a.prototype._cacheGet=function(e,t){var s=!1,n=t?Object.keys(t):[],r=function(h){for(var y=0;y<n.length;y++){var v=n[y];if(!kv(t[v],h[v]))return!0}return!1},o=this[e];if(e==="all")s=this.all;else if(Pt(o))for(var c=0;c<o.length;c++){var l=o[c];if(!(n.length&&r(l))){s=l._value;break}}if(!s&&this.all){for(var u=new Cs(e,t),c=0;c<this.all.length&&u.accept(this.all[c]);c++);s=u.getValue(),this._cacheAdd(e,s,t)}return Pt(s)?Ui(s):s instanceof Date?Er(s):s},a}(),Tv=V(V(V(V(V(V(V(V(V(V(V(V(V([],Ie(1,31),!0),Ie(2,28),!0),Ie(3,31),!0),Ie(4,30),!0),Ie(5,31),!0),Ie(6,30),!0),Ie(7,31),!0),Ie(8,31),!0),Ie(9,30),!0),Ie(10,31),!0),Ie(11,30),!0),Ie(12,31),!0),Ie(1,7),!0),Sv=V(V(V(V(V(V(V(V(V(V(V(V(V([],Ie(1,31),!0),Ie(2,29),!0),Ie(3,31),!0),Ie(4,30),!0),Ie(5,31),!0),Ie(6,30),!0),Ie(7,31),!0),Ie(8,31),!0),Ie(9,30),!0),Ie(10,31),!0),Ie(11,30),!0),Ie(12,31),!0),Ie(1,7),!0),Dv=ka(1,29),Ev=ka(1,30),Ka=ka(1,31),_t=ka(1,32),xv=V(V(V(V(V(V(V(V(V(V(V(V(V([],_t,!0),Ev,!0),_t,!0),Ka,!0),_t,!0),Ka,!0),_t,!0),_t,!0),Ka,!0),_t,!0),Ka,!0),_t,!0),_t.slice(0,7),!0),Av=V(V(V(V(V(V(V(V(V(V(V(V(V([],_t,!0),Dv,!0),_t,!0),Ka,!0),_t,!0),Ka,!0),_t,!0),_t,!0),Ka,!0),_t,!0),Ka,!0),_t,!0),_t.slice(0,7),!0),Cv=ka(-28,0),Iv=ka(-29,0),Wa=ka(-30,0),bt=ka(-31,0),Ov=V(V(V(V(V(V(V(V(V(V(V(V(V([],bt,!0),Iv,!0),bt,!0),Wa,!0),bt,!0),Wa,!0),bt,!0),bt,!0),Wa,!0),bt,!0),Wa,!0),bt,!0),bt.slice(0,7),!0),Mv=V(V(V(V(V(V(V(V(V(V(V(V(V([],bt,!0),Cv,!0),bt,!0),Wa,!0),bt,!0),Wa,!0),bt,!0),bt,!0),Wa,!0),bt,!0),Wa,!0),bt,!0),bt.slice(0,7),!0),Nv=[0,31,60,91,121,152,182,213,244,274,305,335,366],qv=[0,31,59,90,120,151,181,212,243,273,304,334,365],Ki=function(){for(var a=[],e=0;e<55;e++)a=a.concat(ka(7));return a}();function Rv(a,e){var t=ms(a,1,1),s=sn(a)?366:365,n=sn(a+1)?366:365,r=Dr(t),o=Ys(t),c=zt(zt({yearlen:s,nextyearlen:n,yearordinal:r,yearweekday:o},Lv(a)),{wnomask:null});if(ga(e.byweekno))return c;c.wnomask=Ie(0,s+7);var l,u,h=l=$t(7-o+e.wkst,7);h>=4?(h=0,u=c.yearlen+$t(o-e.wkst,7)):u=s-h;for(var y=Math.floor(u/7),v=$t(u,7),p=Math.floor(y+v/4),k=0;k<e.byweekno.length;k++){var g=e.byweekno[k];if(g<0&&(g+=p+1),g>0&&g<=p){var m=void 0;g>1?(m=h+(g-1)*7,h!==l&&(m-=7-l)):m=h;for(var b=0;b<7&&(c.wnomask[m]=1,m++,c.wdaymask[m]!==e.wkst);b++);}}if(Fe(e.byweekno,1)){var m=h+p*7;if(h!==l&&(m-=7-l),m<s)for(var k=0;k<7&&(c.wnomask[m]=1,m+=1,c.wdaymask[m]!==e.wkst);k++);}if(h){var D=void 0;if(Fe(e.byweekno,-1))D=-1;else{var S=Ys(ms(a-1,1,1)),x=$t(7-S.valueOf()+e.wkst,7),L=sn(a-1)?366:365,U=void 0;x>=4?(x=0,U=L+$t(S-e.wkst,7)):U=s-h,D=Math.floor(52+$t(U,7)/4)}if(Fe(e.byweekno,D))for(var m=0;m<h;m++)c.wnomask[m]=1}return c}function Lv(a){var e=sn(a)?366:365,t=ms(a,1,1),s=Ys(t);return e===365?{mmask:Tv,mdaymask:Av,nmdaymask:Mv,wdaymask:Ki.slice(s),mrange:qv}:{mmask:Sv,mdaymask:xv,nmdaymask:Ov,wdaymask:Ki.slice(s),mrange:Nv}}function Fv(a,e,t,s,n,r){var o={lastyear:a,lastmonth:e,nwdaymask:[]},c=[];if(r.freq===ye.YEARLY)if(ga(r.bymonth))c=[[0,t]];else for(var l=0;l<r.bymonth.length;l++)e=r.bymonth[l],c.push(s.slice(e-1,e+1));else r.freq===ye.MONTHLY&&(c=[s.slice(e-1,e+1)]);if(ga(c))return o;o.nwdaymask=Ie(0,t);for(var l=0;l<c.length;l++)for(var u=c[l],h=u[0],y=u[1]-1,v=0;v<r.bynweekday.length;v++){var p=void 0,k=r.bynweekday[v],g=k[0],m=k[1];m<0?(p=y+(m+1)*7,p-=$t(n[p]-g,7)):(p=h+(m-1)*7,p+=$t(7-n[p]+g,7)),h<=p&&p<=y&&(o.nwdaymask[p]=1)}return o}function Bv(a,e){e===void 0&&(e=0);var t=a%19,s=Math.floor(a/100),n=a%100,r=Math.floor(s/4),o=s%4,c=Math.floor((s+8)/25),l=Math.floor((s-c+1)/3),u=Math.floor(19*t+s-r-l+15)%30,h=Math.floor(n/4),y=n%4,v=Math.floor(32+2*o+2*h-u-y)%7,p=Math.floor((t+11*u+22*v)/451),k=Math.floor((u+v-7*p+114)/31),g=(u+v-7*p+114)%31+1,m=Date.UTC(a,k-1,g+e),b=Date.UTC(a,0,1);return[Math.ceil((m-b)/(1e3*60*60*24))]}var Uv=function(){function a(e){this.options=e}return a.prototype.rebuild=function(e,t){var s=this.options;if(e!==this.lastyear&&(this.yearinfo=Rv(e,s)),et(s.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var n=this.yearinfo,r=n.yearlen,o=n.mrange,c=n.wdaymask;this.monthinfo=Fv(e,t,r,o,c,s)}$e(s.byeaster)&&(this.eastermask=Bv(e,s.byeaster))},Object.defineProperty(a.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),a.prototype.ydayset=function(){return[ka(this.yearlen),0,this.yearlen]},a.prototype.mdayset=function(e,t){for(var s=this.mrange[t-1],n=this.mrange[t],r=Ie(null,this.yearlen),o=s;o<n;o++)r[o]=o;return[r,s,n]},a.prototype.wdayset=function(e,t,s){for(var n=Ie(null,this.yearlen+7),r=Dr(ms(e,t,s))-this.yearordinal,o=r,c=0;c<7&&(n[r]=r,++r,this.wdaymask[r]!==this.options.wkst);c++);return[n,o,r]},a.prototype.ddayset=function(e,t,s){var n=Ie(null,this.yearlen),r=Dr(ms(e,t,s))-this.yearordinal;return n[r]=r,[n,r,r+1]},a.prototype.htimeset=function(e,t,s,n){var r=this,o=[];return this.options.byminute.forEach(function(c){o=o.concat(r.mtimeset(e,c,s,n))}),un(o),o},a.prototype.mtimeset=function(e,t,s,n){var r=this.options.bysecond.map(function(o){return new In(e,t,o,n)});return un(r),r},a.prototype.stimeset=function(e,t,s,n){return[new In(e,t,s,n)]},a.prototype.getdayset=function(e){switch(e){case Oe.YEARLY:return this.ydayset.bind(this);case Oe.MONTHLY:return this.mdayset.bind(this);case Oe.WEEKLY:return this.wdayset.bind(this);case Oe.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},a.prototype.gettimeset=function(e){switch(e){case Oe.HOURLY:return this.htimeset.bind(this);case Oe.MINUTELY:return this.mtimeset.bind(this);case Oe.SECONDLY:return this.stimeset.bind(this)}},a}();function Pv(a,e,t,s,n,r){for(var o=[],c=0;c<a.length;c++){var l=void 0,u=void 0,h=a[c];h<0?(l=Math.floor(h/e.length),u=$t(h,e.length)):(l=Math.floor((h-1)/e.length),u=$t(h-1,e.length));for(var y=[],v=t;v<s;v++){var p=r[v];$e(p)&&y.push(p)}var k=void 0;l<0?k=y.slice(l)[0]:k=y[l];var g=e[u],m=gl(n.yearordinal+k),b=_l(m,g);Fe(o,b)||o.push(b)}return un(o),o}function wl(a,e){var t=e.dtstart,s=e.freq,n=e.interval,r=e.until,o=e.bysetpos,c=e.count;if(c===0||n===0)return Ta(a);var l=vv.fromDate(t),u=new Uv(e);u.rebuild(l.year,l.month);for(var h=Yv(u,l,e);;){var y=u.getdayset(s)(l.year,l.month,l.day),v=y[0],p=y[1],k=y[2],g=zv(v,p,k,u,e);if(et(o))for(var m=Pv(o,h,p,k,u,v),b=0;b<m.length;b++){var D=m[b];if(r&&D>r)return Ta(a);if(D>=t){var S=Wi(D,e);if(!a.accept(S)||c&&(--c,!c))return Ta(a)}}else for(var b=p;b<k;b++){var x=v[b];if($e(x))for(var L=gl(u.yearordinal+x),U=0;U<h.length;U++){var M=h[U],D=_l(L,M);if(r&&D>r)return Ta(a);if(D>=t){var S=Wi(D,e);if(!a.accept(S)||c&&(--c,!c))return Ta(a)}}}if(e.interval===0||(l.add(e,g),l.year>pl))return Ta(a);Xr(s)||(h=u.gettimeset(s)(l.hour,l.minute,l.second,0)),u.rebuild(l.year,l.month)}}function jv(a,e,t){var s=t.bymonth,n=t.byweekno,r=t.byweekday,o=t.byeaster,c=t.bymonthday,l=t.bynmonthday,u=t.byyearday;return et(s)&&!Fe(s,a.mmask[e])||et(n)&&!a.wnomask[e]||et(r)&&!Fe(r,a.wdaymask[e])||et(a.nwdaymask)&&!a.nwdaymask[e]||o!==null&&!Fe(a.eastermask,e)||(et(c)||et(l))&&!Fe(c,a.mdaymask[e])&&!Fe(l,a.nmdaymask[e])||et(u)&&(e<a.yearlen&&!Fe(u,e+1)&&!Fe(u,-a.yearlen+e)||e>=a.yearlen&&!Fe(u,e+1-a.yearlen)&&!Fe(u,-a.nextyearlen+e-a.yearlen))}function Wi(a,e){return new Mn(a,e.tzid).rezonedDate()}function Ta(a){return a.getValue()}function zv(a,e,t,s,n){for(var r=!1,o=e;o<t;o++){var c=a[o];r=jv(s,c,n),r&&(a[c]=null)}return r}function Yv(a,e,t){var s=t.freq,n=t.byhour,r=t.byminute,o=t.bysecond;return Xr(s)?yv(t):s>=ye.HOURLY&&et(n)&&!Fe(n,e.hour)||s>=ye.MINUTELY&&et(r)&&!Fe(r,e.minute)||s>=ye.SECONDLY&&et(o)&&!Fe(o,e.second)?[]:a.gettimeset(s)(e.hour,e.minute,e.second,e.millisecond)}var oa={MO:new At(0),TU:new At(1),WE:new At(2),TH:new At(3),FR:new At(4),SA:new At(5),SU:new At(6)},$r={freq:Oe.YEARLY,dtstart:null,interval:1,wkst:oa.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},Hv=Object.keys($r),ye=function(){function a(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new wv,this.origOptions=kl(e);var s=pv(e).parsedOptions;this.options=s}return a.parseText=function(e,t){return bl(e,t)},a.fromText=function(e,t){return dv(e,t)},a.fromString=function(e){return new a(a.parseString(e)||void 0)},a.prototype._iter=function(e){return wl(e,this.options)},a.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},a.prototype._cacheAdd=function(e,t,s){if(this._cache)return this._cache._cacheAdd(e,t,s)},a.prototype.all=function(e){if(e)return this._iter(new ji("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Cs("all",{})),this._cacheAdd("all",t)),t},a.prototype.between=function(e,t,s,n){if(s===void 0&&(s=!1),!Zs(e)||!Zs(t))throw new Error("Invalid date passed in to RRule.between");var r={before:t,after:e,inc:s};if(n)return this._iter(new ji("between",r,n));var o=this._cacheGet("between",r);return o===!1&&(o=this._iter(new Cs("between",r)),this._cacheAdd("between",o,r)),o},a.prototype.before=function(e,t){if(t===void 0&&(t=!1),!Zs(e))throw new Error("Invalid date passed in to RRule.before");var s={dt:e,inc:t},n=this._cacheGet("before",s);return n===!1&&(n=this._iter(new Cs("before",s)),this._cacheAdd("before",n,s)),n},a.prototype.after=function(e,t){if(t===void 0&&(t=!1),!Zs(e))throw new Error("Invalid date passed in to RRule.after");var s={dt:e,inc:t},n=this._cacheGet("after",s);return n===!1&&(n=this._iter(new Cs("after",s)),this._cacheAdd("after",n,s)),n},a.prototype.count=function(){return this.all().length},a.prototype.toString=function(){return Cr(this.origOptions)},a.prototype.toText=function(e,t,s){return hv(this,e,t,s)},a.prototype.isFullyConvertibleToText=function(){return fv(this)},a.prototype.clone=function(){return new a(this.origOptions)},a.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],a.YEARLY=Oe.YEARLY,a.MONTHLY=Oe.MONTHLY,a.WEEKLY=Oe.WEEKLY,a.DAILY=Oe.DAILY,a.HOURLY=Oe.HOURLY,a.MINUTELY=Oe.MINUTELY,a.SECONDLY=Oe.SECONDLY,a.MO=oa.MO,a.TU=oa.TU,a.WE=oa.WE,a.TH=oa.TH,a.FR=oa.FR,a.SA=oa.SA,a.SU=oa.SU,a.parseString=Ar,a.optionsToString=Cr,a}();function Kv(a,e,t,s,n,r){var o={},c=a.accept;function l(v,p){t.forEach(function(k){k.between(v,p,!0).forEach(function(g){o[Number(g)]=!0})})}n.forEach(function(v){var p=new Mn(v,r).rezonedDate();o[Number(p)]=!0}),a.accept=function(v){var p=Number(v);return isNaN(p)?c.call(this,v):!o[p]&&(l(new Date(p-1),new Date(p+1)),!o[p])?(o[p]=!0,c.call(this,v)):!0},a.method==="between"&&(l(a.args.after,a.args.before),a.accept=function(v){var p=Number(v);return o[p]?!0:(o[p]=!0,c.call(this,v))});for(var u=0;u<s.length;u++){var h=new Mn(s[u],r).rezonedDate();if(!a.accept(new Date(h.getTime())))break}e.forEach(function(v){wl(a,v.options)});var y=a._result;switch(un(y),a.method){case"all":case"between":return y;case"before":return y.length&&y[y.length-1]||null;case"after":default:return y.length&&y[0]||null}}var Gi={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function Wv(a,e){var t=[],s=[],n=[],r=[],o=On(a),c=o.dtstart,l=o.tzid,u=$v(a,e.unfold);return u.forEach(function(h){var y;if(h){var v=Xv(h),p=v.name,k=v.parms,g=v.value;switch(p.toUpperCase()){case"RRULE":if(k.length)throw new Error("unsupported RRULE parm: ".concat(k.join(",")));t.push(Ar(h));break;case"RDATE":var m=(y=/RDATE(?:;TZID=([^:=]+))?/i.exec(h))!==null&&y!==void 0?y:[],b=m[1];b&&!l&&(l=b),s=s.concat(Vi(g,k));break;case"EXRULE":if(k.length)throw new Error("unsupported EXRULE parm: ".concat(k.join(",")));n.push(Ar(g));break;case"EXDATE":r=r.concat(Vi(g,k));break;case"DTSTART":break;default:throw new Error("unsupported property: "+p)}}}),{dtstart:c,tzid:l,rrulevals:t,rdatevals:s,exrulevals:n,exdatevals:r}}function Gv(a,e){var t=Wv(a,e),s=t.rrulevals,n=t.rdatevals,r=t.exrulevals,o=t.exdatevals,c=t.dtstart,l=t.tzid,u=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||s.length>1||n.length||r.length||o.length){var h=new Jv(u);return h.dtstart(c),h.tzid(l||void 0),s.forEach(function(v){h.rrule(new ye(ar(v,c,l),u))}),n.forEach(function(v){h.rdate(v)}),r.forEach(function(v){h.exrule(new ye(ar(v,c,l),u))}),o.forEach(function(v){h.exdate(v)}),e.compatible&&e.dtstart&&h.rdate(c),h}var y=s[0]||{};return new ye(ar(y,y.dtstart||e.dtstart||c,y.tzid||e.tzid||l),u)}function Ir(a,e){return e===void 0&&(e={}),Gv(a,Vv(e))}function ar(a,e,t){return zt(zt({},a),{dtstart:e,tzid:t})}function Vv(a){var e=[],t=Object.keys(a),s=Object.keys(Gi);if(t.forEach(function(n){Fe(s,n)||e.push(n)}),e.length)throw new Error("Invalid options: "+e.join(", "));return zt(zt({},Gi),a)}function Qv(a){if(a.indexOf(":")===-1)return{name:"RRULE",value:a};var e=av(a,":",1),t=e[0],s=e[1];return{name:t,value:s}}function Xv(a){var e=Qv(a),t=e.name,s=e.value,n=t.split(";");if(!n)throw new Error("empty property name");return{name:n[0].toUpperCase(),parms:n.slice(1),value:s}}function $v(a,e){if(e===void 0&&(e=!1),a=a&&a.trim(),!a)throw new Error("Invalid empty string");if(!e)return a.split(/\s/);for(var t=a.split(`
`),s=0;s<t.length;){var n=t[s]=t[s].replace(/\s+$/g,"");n?s>0&&n[0]===" "?(t[s-1]+=n.slice(1),t.splice(s,1)):s+=1:t.splice(s,1)}return t}function Zv(a){a.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function Vi(a,e){return Zv(e),a.split(",").map(function(t){return Vr(t)})}function Qi(a){var e=this;return function(t){if(t!==void 0&&(e["_".concat(a)]=t),e["_".concat(a)]!==void 0)return e["_".concat(a)];for(var s=0;s<e._rrule.length;s++){var n=e._rrule[s].origOptions[a];if(n)return n}}}var Jv=function(a){Qr(e,a);function e(t){t===void 0&&(t=!1);var s=a.call(this,{},t)||this;return s.dtstart=Qi.apply(s,["dtstart"]),s.tzid=Qi.apply(s,["tzid"]),s._rrule=[],s._rdate=[],s._exrule=[],s._exdate=[],s}return e.prototype._iter=function(t){return Kv(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){Xi(t,this._rrule)},e.prototype.exrule=function(t){Xi(t,this._exrule)},e.prototype.rdate=function(t){$i(t,this._rdate)},e.prototype.exdate=function(t){$i(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return Ir(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return Ir(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(Cr({dtstart:this._dtstart}))),this._rrule.forEach(function(s){t=t.concat(s.toString().split(`
`))}),this._exrule.forEach(function(s){t=t.concat(s.toString().split(`
`).map(function(n){return n.replace(/^RRULE:/,"EXRULE:")}).filter(function(n){return!/^DTSTART/.test(n)}))}),this._rdate.length&&t.push(Zi("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(Zi("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(s){return t.rrule(s.clone())}),this._exrule.forEach(function(s){return t.exrule(s.clone())}),this._rdate.forEach(function(s){return t.rdate(new Date(s.getTime()))}),this._exdate.forEach(function(s){return t.exdate(new Date(s.getTime()))}),t},e}(ye);function Xi(a,e){if(!(a instanceof ye))throw new TypeError(String(a)+" is not RRule instance");Fe(e.map(String),String(a))||e.push(a)}function $i(a,e){if(!(a instanceof Date))throw new TypeError(String(a)+" is not Date instance");Fe(e.map(Number),Number(a))||(e.push(a),un(e))}function Zi(a,e,t){var s=!t||t.toUpperCase()==="UTC",n=s?"".concat(a,":"):"".concat(a,";TZID=").concat(t,":"),r=e.map(function(o){return Gr(o.valueOf(),s)}).join(",");return"".concat(n).concat(r)}class ep{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,n)=>s-n)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t,s){if(t.rruleString)return this.calculateNextWithRRule(e,t,s);const r=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,{type:o,time:c}=t,l=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(r,l);break;case"weekly":u=this.calculateNextWeekly(r,l,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(r,l,this.normalizeDayOfMonth(t.dayOfMonth,r.getDate()));break;case"yearly":u=this.calculateNextYearly(r,l,this.normalizeMonth(t.month,r.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,r.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(c){const{hours:h,minutes:y}=mr(c);if(Number.isFinite(h)&&Number.isFinite(y)){const{date:v,shifted:p}=Ii(u,h,y);p&&Ve("DST shift detected while applying recurrence time",{requestedTime:c,original:u.toISOString(),adjusted:v.toISOString()}),u=v}}return u}calculateNextWithRRule(e,t,s){try{const r=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,c=Ir(t.rruleString).after(r,!1);if(!c){Ve("RRule returned no next occurrence, falling back to legacy logic",{rruleString:t.rruleString,baseDate:r.toISOString()});const u={...t};return delete u.rruleString,this.calculateNext(r,u,s)}let l=c;if(t.time){const{hours:u,minutes:h}=mr(t.time);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:y,shifted:v}=Ii(l,u,h);v&&Ve("DST shift detected while applying recurrence time",{requestedTime:t.time,original:l.toISOString(),adjusted:y.toISOString()}),l=y}}return l}catch(n){_e("Failed to parse rrule, falling back to legacy logic",{error:n instanceof Error?n.message:String(n),rruleString:t.rruleString});const r={...t};return delete r.rruleString,this.calculateNext(e,r,s)}}calculateNextDaily(e,t){return cn(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return Ci(e,t);const n=this.getMondayIndex(e),r=Math.min(Zn,t*14);for(let o=1;o<=r;o++){if(Math.floor((n+o)/7)%t!==0)continue;const l=cn(e,o),u=this.getMondayIndex(l);if(s.includes(u))return l}return Ve("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),Ci(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const n=s??e.getDate(),r=e.getFullYear(),c=e.getMonth()+t,l=r+Math.floor(c/12),u=(c%12+12)%12,h=new Date(l,u+1,0).getDate(),y=Math.min(n,h),v=new Date(e);return v.setFullYear(l,u,y),v}calculateNextYearly(e,t,s,n){const r=n??e.getDate(),o=e.getFullYear()+t,c=new Date(o,s+1,0).getDate(),l=Math.min(r,c),u=new Date(e);return u.setFullYear(o,s,l),u}getOccurrencesInRange(e,t,s,n){const r=[];let o=new Date(n),c=0;for(;o<=t&&c<Zn;)o>=e&&r.push(new Date(o)),o=this.calculateNext(o,s),c++;return r}getMissedOccurrences(e,t,s,n){const r=[];let o=new Date(n),c=0;for(;o<=e&&c<Zn;)o=this.calculateNext(o,s),c++;let l=0;for(;o<t&&l<Tn;)r.push(new Date(o)),o=this.calculateNext(o,s),l++;return l>=Tn&&Ve("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:n.toISOString(),cap:Tn}),r}}class tp{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:n}=mr(t);if(!Number.isFinite(s)||!Number.isFinite(n))return new Date(e);const r=new Date(e);return r.setHours(s,n,0,0),r}isSameLocalDay(e,t){const s=new Date(e),n=new Date(t);return s.getFullYear()===n.getFullYear()&&s.getMonth()===n.getMonth()&&s.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),n=Math.trunc(s/(1e3*60)),r=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(r)<24?r>0?`in ${r}h`:`${-r}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class ap{constructor(e){A(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return he(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return Ve(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return Ve("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),he(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return Ve("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(s){return _e("Failed to execute onCompletion action",{taskId:e.id,action:t,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return Ve("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return _e("Failed to check for nested items",{blockId:e,error:t}),!0}}}class sp{constructor(e,t){A(this,"intervalMs");A(this,"timeoutId",null);A(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:Kr,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class np{constructor(e,t=Kr,s){A(this,"storage");A(this,"recurrenceEngine");A(this,"onCompletionHandler");A(this,"emittedDue",new Set);A(this,"emittedMissed",new Set);A(this,"timezoneHandler");A(this,"isChecking",!1);A(this,"lastCheckStartTime",0);A(this,"plugin",null);A(this,"listeners",{"task:due":new Set,"task:overdue":new Set});A(this,"MAX_EMITTED_ENTRIES",1e3);A(this,"EMITTED_RETENTION_DAYS",30);A(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);A(this,"persistTimeoutId",null);A(this,"emittedStateReady",null);A(this,"timer");this.storage=e,this.recurrenceEngine=new ep,this.onCompletionHandler=new ap(s),this.timezoneHandler=new tp,this.plugin=s||null,this.timer=new sp(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),he("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),he("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Ve("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const n=new Date(s.dueAt),r=n<=e;if(r){const c=this.buildOccurrenceKey(s.id,n,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:s.id,dueAt:n,context:"today",task:s}),this.registerEmittedKey("due",c),he(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(r&&e.getTime()-n.getTime()>=fu&&(!o||o<n)){const c=this.buildOccurrenceKey(s.id,n,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:n,context:"overdue",task:s}),this.registerEmittedKey("missed",c),Ve(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),s=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=s.set,(t.didTrim||s.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,s){const n=s.getTime(),r=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=r.filter(({time:u})=>u===null||u>=n),c=o.length!==r.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),c=!0);const l=new Set(o.map(({entry:u})=>u));return c&&he(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${l.size}`),{set:l,didTrim:c}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const s=e.slice(t+1);if(!s)return null;const n=s.length===13?`${s}:00:00.000Z`:s,r=new Date(n);return Number.isNaN(r.getTime())?null:r.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const s=new Date;t.doneAt=s.toISOString(),gu(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const r=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,r);if(o.success||_e(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:r,error:o.error}),o.warnings)for(const u of o.warnings)Ve(u,{taskId:t.id});const c=new Date(t.dueAt),l=this.recurrenceEngine.calculateNext(c,t.frequency,{completionDate:s,whenDone:t.whenDone});t.dueAt=l.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),he(`Task "${t.name}" completed and rescheduled to ${l.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const n=new Date(s.dueAt),r=new Date(n.getTime()+t*60*1e3);s.dueAt=r.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),he(`Task "${s.name}" delayed by ${t} minutes to ${r.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),he(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);ol(t);const s=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),he(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),he("First run detected, no recovery needed");return}he(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const r of n){const o=this.buildOccurrenceKey(s.id,r,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:r,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(n){_e(`Failed to recover task ${s.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),he("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let n=s,r=0;for(;n<t&&r<Tn;)n=this.recurrenceEngine.calculateNext(n,e.frequency),r++;n>s&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),he(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Si);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){_e("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Si,{timestamp:e.toISOString()})}catch(t){_e("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const n of s)try{const r=n(t);r instanceof Promise&&r.catch(o=>{_e(`Scheduler listener error for ${e}:`,o)})}catch(r){_e(`Scheduler listener error for ${e}:`,r)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??vu,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(_i),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),he("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){_e("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(_i,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){_e("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const rp=7,ip=2e3;class op{constructor(e,t){A(this,"plugin");A(this,"storageKey");A(this,"notifications",new Map);A(this,"escalations",new Map);A(this,"lastCleanup",new Date);A(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),he(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){_e("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,ul("Saved notification state")}catch(e){_e("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>ip&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-rp*24*60*60*1e3);let n=0;for(const[r,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(r),n++);n>0&&(he(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function lp(a){return{id:a.id,name:a.name,dueAt:a.dueAt,frequency:a.frequency,linkedBlockId:a.linkedBlockId,linkedBlockContent:a.linkedBlockContent,priority:a.priority,tags:a.tags,notificationChannels:a.notificationChannels,completionCount:a.completionCount,missCount:a.missCount,currentStreak:a.currentStreak,bestStreak:a.bestStreak}}const cp=30*1e3,up=30*60*1e3,Za=500;class dp{constructor(e,t={}){A(this,"plugin");A(this,"config");A(this,"queue",[]);A(this,"dedupeKeys",new Set);A(this,"flushIntervalId",null);A(this,"fetcher");A(this,"notificationState");A(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...yr},this.notificationState=t.notificationState??new op(this.plugin,uu)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(mi);e&&(this.config={...yr,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(mi,e)}async loadQueue(){try{const e=await this.plugin.loadData(gi);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>Za){const s=this.queue.length-Za;this.queue=this.queue.slice(-Za),console.warn(`Event queue trimmed to ${Za} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-$n);await this.plugin.saveData(gi,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},hu))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const r=this.buildPayload(e,t,n,1,s);await this.sendPayload(r)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(r)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:bi,version:ki,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){s.push(n);continue}const r={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(r))this.markDelivered(r.delivery.dedupeKey),t=!0;else{const c=n.attempt+1,l=this.getRetryDelay(c);s.push({...n,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,n,r=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:bi,version:ki,occurredAt:o.toISOString(),task:lp(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:r,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:n}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>$n){const t=Array.from(this.dedupeKeys).slice(-$n);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=Za){const s=this.queue.length-Za+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${Za}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=cp*Math.pow(2,e-1);return Math.min(t,up)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,n=s.encode(t),r=s.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,r);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const r={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return n&&(r["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(r["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),r}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),n=await this.buildHeaders(e),r=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:s});if(!r.ok)return console.error("n8n webhook failed:",r.statusText),!1;if(t){const o=await r.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const xs={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:{enabled:!1,mode:"include",tagPattern:void 0,pathPattern:void 0,regex:void 0}};function Ji(a){return{dates:{...xs.dates,...a.dates},recurrence:{...xs.recurrence,...a.recurrence},dependencies:{...xs.dependencies,...a.dependencies},filenameDate:{...xs.filenameDate,...a.filenameDate},globalFilter:{...xs.globalFilter,...a.globalFilter}}}const sr="plugin-settings";class hp{constructor(e){A(this,"plugin");A(this,"settings");this.plugin=e,this.settings=xs}async load(){try{const e=await this.plugin.loadData(sr);e&&typeof e=="object"&&(this.settings=Ji(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(sr,e)}get(){return this.settings}async update(e){this.settings=Ji(e),await this.plugin.saveData(sr,this.settings)}}const Pa=class Pa{constructor(e){A(this,"plugin");A(this,"isInitialized",!1);A(this,"storage");A(this,"repository");A(this,"scheduler");A(this,"eventService");A(this,"settingsService");this.plugin=e}static getInstance(e){if(!Pa.instance){if(!e)return null;Pa.instance=new Pa(e)}return Pa.instance}async initialize(){if(this.isInitialized){Ve("TaskManager already initialized");return}he("Initializing TaskManager"),this.settingsService=new hp(this.plugin),await this.settingsService.load(),this.storage=new Jf(this.plugin),await this.storage.init(),this.repository=new ev(this.storage),this.eventService=new dp(this.plugin),await this.eventService.init(),this.scheduler=new np(this.storage,Kr,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,he("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),he("TaskManager started")}async destroy(){he("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,Pa.instance=null,he("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};A(Pa,"instance",null);let Nn=Pa;function fp(a){let t=`- [${a.status==="done"?"x":" "}] ${a.name}`;if(a.dueAt){const s=new Date(a.dueAt);t+=` üìÖ ${s.toISOString().split("T")[0]}`}return a.frequency&&(t+=` üîÅ every ${a.frequency.interval} ${a.frequency.type}${a.frequency.interval>1?"s":""}`),t}class vp{constructor(e,t,s,n){this.storage=e,this.recurrenceEngine=t,this.settings=s,this.siyuanApi=n}async onComplete(e,t){try{const s=[],n=this.addCompletionDate(e,t);let r;return e.frequency&&(r=await this.generateNextInstance(n,t),r&&(await this.placeNextInstance(n,r)||s.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(r))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(Ve("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(n),s.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(n),{success:!0,nextTask:r,warnings:s.length>0?s:void 0}}catch(s){return _e("Failed to handle task completion",{taskId:e.id,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}addCompletionDate(e,t){const s={...e},n=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(s.doneAt=n,s.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(s.cancelledAt=n,s.doneAt=void 0),s}async generateNextInstance(e,t){if(e.frequency)try{const s=new Date(e.dueAt),n=this.recurrenceEngine.calculateNext(s,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),r=il(e,{dueAt:n.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(r.scheduledAt=void 0),r}catch(s){_e("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:s});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return Ve("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return Ve("SiYuan API not available, cannot place next instance"),!1;const s=this.settings.recurrence.newTaskPosition,n=fp(t);try{let r;return s==="above"&&this.siyuanApi.insertBlockAbove?r=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,n):s==="below"&&this.siyuanApi.insertBlockBelow&&(r=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,n)),r!=null&&r.id?(t.linkedBlockId=r.id,t.linkedBlockContent=n,!0):!1}catch(r){return _e("Failed to place next instance in document",{taskId:e.id,placement:s,error:r}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const s=await this.siyuanApi.getChildBlocks({id:e});return s&&s.length>0}catch(s){return _e("Failed to check for nested items",{blockId:e,error:s}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),he("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(s){_e("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:s})}else he("Task deleted from storage only (no linked block)",{taskId:e.id})}}class pp{constructor(e,t,s,n){A(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=s,this.siyuanApi=n,t&&s&&(this.completionHandler=new vp(e,t,s(),n))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,s;try{const n=this.repository.getTask(e);if(!n){Z.error("Task not found");return}const r=ba.getInstance(),o=n.statusSymbol||" ",c=r.getNextSymbol(o),l={...n,statusSymbol:c},u=r.getStatus(c);if(u.type==="DONE"){if(l.status="done",n.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(l,new Date);h.success?(h.nextTask?(he("Next recurrence created",{taskId:l.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),Z.success("Task completed - next occurrence scheduled")):Z.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(y=>Z.warning(y))):Z.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!l.doneAt&&(l.doneAt=new Date().toISOString()),await this.repository.saveTask(l),Z.success(`Task status updated to ${u.name}`);Ge.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(l.status="cancelled",(s=this.settings)!=null&&s.dates.autoAddCancelled&&!l.cancelledAt&&(l.cancelledAt=new Date().toISOString()),await this.repository.saveTask(l),Ge.emit("task:updated",{taskId:e}),Z.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(l.status="todo",await this.repository.saveTask(l),Ge.emit("task:updated",{taskId:e}),Z.success(`Task status updated to ${u.name}`))}catch(n){_e("Failed to toggle task status",n),Z.error("Failed to toggle status")}}async completeTask(e){var t;try{const s=this.repository.getTask(e);if(!s){Z.error("Task not found");return}const n={...s,status:"done"};if(s.frequency&&this.completionHandler){const r=await this.completionHandler.onComplete(n,new Date);r.success?(r.nextTask?(he("Next recurrence created",{taskId:n.id,nextTaskId:r.nextTask.id,nextDue:r.nextTask.dueAt}),Z.success(`Task "${s.name}" completed - next occurrence scheduled`)):Z.success(`Task "${s.name}" completed`),r.warnings&&r.warnings.forEach(o=>Z.warning(o))):Z.error(`Failed to complete task: ${r.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),Z.success(`Task "${s.name}" completed`);Ge.emit("task:complete",{taskId:e})}catch(s){_e("Failed to complete task",s),Z.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){Z.error("Task not found");return}const n=this.repository.getAllTasks().filter(r=>{var o,c;return((o=r.blockedBy)==null?void 0:o.includes(e))||((c=r.dependsOn)==null?void 0:c.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),Ge.emit("task:deleted",{taskId:e}),Z.success(`Task "${t.name}" deleted`)}catch(t){_e("Failed to delete task",t),Z.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){Z.error("Task not found");return}const s=new Date;s.setHours(12,0,0,0);const n={...t,scheduledAt:s.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),Ge.emit("task:updated",{taskId:e}),Z.success("Task rescheduled to today")}catch(t){_e("Failed to reschedule task",t),Z.error("Failed to reschedule task")}}async deferTask(e,t){try{const s=this.repository.getTask(e);if(!s){Z.error("Task not found");return}const n={...s,updatedAt:new Date().toISOString()};if(s.dueAt){const r=new Date(s.dueAt);r.setDate(r.getDate()+t),n.dueAt=r.toISOString()}if(s.scheduledAt){const r=new Date(s.scheduledAt);r.setDate(r.getDate()+t),n.scheduledAt=r.toISOString()}await this.repository.saveTask(n),Ge.emit("task:updated",{taskId:e}),Z.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(s){_e("Failed to defer task",s),Z.error("Failed to defer task")}}}function yp(a,e,t,s){const n=new pp(e,t,s);a.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{eo()}}),a.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{a.openDock()}}),a.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await gp(e,n)}}),a.addCommand({langKey:"toggleTaskStatus",hotkey:"‚åò‚áßX",callback:async()=>{const r=await _p();r&&await n.toggleStatus(r)}}),a.addCommand({langKey:"openTaskEditor",hotkey:"‚åò‚áßE",callback:()=>{mp()}}),a.addCommand({langKey:"quickAddTask",hotkey:"‚åò‚áßN",callback:()=>{eo()}}),he("Registered slash commands and hotkeys")}function eo(){Ge.emit("task:create",{source:"command"});const a=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(a)}function mp(){Ge.emit("task:edit",{source:"command"});const a=new CustomEvent("recurring-task-edit",{detail:{source:"command"}});window.dispatchEvent(a)}async function gp(a,e){try{const t=a.getTodayAndOverdueTasks();if(t.length===0){he("No tasks due today");return}const s=t[0];await e.completeTask(s.id),he(`Quick completing task: ${s.name}`)}catch(t){_e("Failed to quick complete task",t)}}async function _p(){return null}function to(a,e){Ge.emit("task:snooze",{taskId:a,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:a,minutes:e}})),he(`Snoozing task ${a} for ${e} minutes`)}function bp(a){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=_r(t),n=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));Ge.emit("task:snooze",{taskId:a,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:a,minutes:n}})),he(`Snoozing task ${a} to tomorrow`)}function kp(a){a.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],n=s==null?void 0:s.getAttribute("data-node-id");if(!n)return;const r=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=a.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Ge.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:r,suggestedName:ao(r),suggestedTime:so(r)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:r,suggestedName:ao(r),suggestedTime:so(r)}}))}});try{const u=Nn.getInstance();if(u&&u.isReady()){const y=u.getRepository().getTaskByBlockId(n);if(y){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=a.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{Ge.emit("task:complete",{taskId:y.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:y.id}}))}});const v=[{label:"15 minutes",click:()=>to(y.id,15)},{label:"1 hour",click:()=>to(y.id,60)},{label:"Tomorrow",click:()=>bp(y.id)}];e.menu.addItem({icon:"iconClock",label:((l=a.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:v})}}}catch{ul("TaskManager not available for quick actions")}}),he("Registered block context menu")}function ao(a){const e=a.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function so(a){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=a.match(e);if(t){let n=parseInt(t[1],10);const r=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${r}`}return null}class wp{constructor(e,t){A(this,"plugin");A(this,"repository");A(this,"topbarElement",null);A(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),he("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),he("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const n=new Date(s.dueAt);return n<new Date&&!Wr(n)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){Ge.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Tp extends Mr.Plugin{constructor(){super(...arguments);A(this,"taskManager");A(this,"repository");A(this,"scheduler");A(this,"eventService");A(this,"migrationManager");A(this,"topbarMenu");A(this,"dashboardComponent",null);A(this,"dockEl");A(this,"quickAddComponent",null);A(this,"quickAddContainer",null);A(this,"taskEditorComponent",null);A(this,"taskEditorContainer",null);A(this,"pendingCompletionTimeouts",new Map);A(this,"handleCreateTaskEvent",t=>{try{const s=t;he("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){_e("Failed to handle create task event",s),Z.error("Failed to open task creator.")}});A(this,"handleSettingsEvent",t=>{try{he("Settings event received",t.detail),this.openDock()}catch(s){_e("Failed to handle settings event",s),Z.error("Failed to open settings.")}});A(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:n}=s.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(s){_e("Failed to complete task",s),Z.error("Failed to complete task.")}});A(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:n,minutes:r}=s.detail??{};if(!n||typeof r!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,r)}catch(s){_e("Failed to snooze task",s),Z.error("Failed to snooze task.")}})}async onload(){he("Loading Recurring Tasks Plugin"),this.migrationManager=new Wf(this);try{await this.migrationManager.migrate(as)}catch(n){_e("Migration failed, continuing with existing data",n)}const t=Nn.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const s=this.taskManager.getSettingsService();try{await this.taskManager.start()}catch(n){_e("Failed to start TaskManager",n)}yp(this,this.repository,this.scheduler.getRecurrenceEngine(),()=>s.get()),kp(this),this.topbarMenu=new wp(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:du,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),he("Recurring Tasks Plugin loaded successfully")}async onunload(){he("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=Gn(Uf,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(Vn(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Ge.on("task:create",t=>{he("Create task event received",t),this.openQuickAdd(t)}),Ge.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Ge.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Ge.on("task:settings",()=>{this.openDock()}),Ge.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){_e("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Ge.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){Z.info(`Completion already pending for "${s.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),he(`Task completed: ${s.name}`)}catch(o){_e("Failed to finalize task completion",o),Z.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const r=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),Z.info(`Undo: "${s.name}" restored`))};ss({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:r,showCountdown:!0})}}async handleSnoozeTask(t,s){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),he(`Task snoozed: ${n.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=Gn(Kf,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}closeQuickAdd(){this.quickAddComponent&&(Vn(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=Gn(dl,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(Vn(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=Tp;

"use strict";var ec=Object.defineProperty;var wi=r=>{throw TypeError(r)};var tc=(r,e,t)=>e in r?ec(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var k=(r,e,t)=>tc(r,typeof e!="symbol"?e+"":e,t),ra=(r,e,t)=>e.has(r)||wi("Cannot "+t);var O=(r,e,t)=>(ra(r,e,"read from private field"),t?t.call(r):e.get(r)),Ne=(r,e,t)=>e.has(r)?wi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),Me=(r,e,t,s)=>(ra(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t),kt=(r,e,t)=>(ra(r,e,"access private method"),t);const Wa=require("siyuan"),ya=!1;var Ga=Array.isArray,sc=Array.prototype.indexOf,Vn=Array.from,rc=Object.defineProperty,Lr=Object.getOwnPropertyDescriptor,Do=Object.getOwnPropertyDescriptors,nc=Object.prototype,ac=Array.prototype,Qa=Object.getPrototypeOf,Ti=Object.isExtensible;function ic(r){for(var e=0;e<r.length;e++)r[e]()}function Eo(){var r,e,t=new Promise((s,n)=>{r=s,e=n});return{promise:t,resolve:r,reject:e}}function xo(r,e){if(Array.isArray(r))return r;if(!(Symbol.iterator in r))return Array.from(r);const t=[];for(const s of r)if(t.push(s),t.length===e)break;return t}const Dt=2,Ln=4,Xn=8,Ao=1<<24,Ls=16,Fs=32,Tr=64,$a=128,as=512,It=1024,Ft=2048,Ps=4096,Qt=8192,Os=16384,Va=32768,Hr=65536,Si=1<<17,Co=1<<18,Xr=1<<19,oc=1<<20,Cs=1<<25,_r=32768,ma=1<<21,Xa=1<<22,Xs=1<<23,Ms=Symbol("$state"),lc=Symbol("legacy props"),cc=Symbol(""),qr=new class extends Error{constructor(){super(...arguments);k(this,"name","StaleReactionError");k(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function Za(r){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function uc(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function dc(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function hc(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function fc(r){throw new Error("https://svelte.dev/e/effect_orphan")}function vc(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function pc(r){throw new Error("https://svelte.dev/e/props_invalid_value")}function yc(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function mc(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function gc(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function bc(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const _c=1,kc=2,Io=4,wc=8,Tc=16,Sc=1,Dc=4,Ec=8,xc=16,Ac=1,Cc=2,wt=Symbol(),Ic="http://www.w3.org/1999/xhtml";function Oc(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Mc(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Oo(r){return r===this.v}function Mo(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function No(r){return!Mo(r,this.v)}let Nc=!1,dt=null;function Kr(r){dt=r}function qo(r){return Lo().get(r)}function qc(r,e){return Lo().set(r,e),e}function Je(r,e=!1,t){dt={p:dt,i:!1,c:null,e:null,s:r,x:null,l:null}}function et(r){var e=dt,t=e.e;if(t!==null){e.e=null;for(var s of t)tl(s)}return e.i=!0,dt=e.p,{}}function Ro(){return!0}function Lo(r){return dt===null&&Za(),dt.c??(dt.c=new Map(Rc(dt)||void 0))}function Rc(r){let e=r.p;for(;e!==null;){const t=e.c;if(t!==null)return t;e=e.p}return null}let or=[];function Fo(){var r=or;or=[],ic(r)}function Zr(r){if(or.length===0&&!on){var e=or;queueMicrotask(()=>{e===or&&Fo()})}or.push(r)}function Lc(){for(;or.length>0;)Fo()}function Po(r){var e=je;if(e===null)return xe.f|=Xs,r;if(e.f&Va)Wr(r,e);else{if(!(e.f&$a))throw r;e.b.error(r)}}function Wr(r,e){for(;e!==null;){if(e.f&$a)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r}const Fc=-7169;function gt(r,e){r.f=r.f&Fc|e}function Ja(r){r.f&as||r.deps===null?gt(r,It):gt(r,Ps)}function Bo(r){if(r!==null)for(const e of r)!(e.f&Dt)||!(e.f&_r)||(e.f^=_r,Bo(e.deps))}function Uo(r,e,t){r.f&Ft?e.add(r):r.f&Ps&&t.add(r),Bo(r.deps),gt(r,It)}const En=new Set;let De=null,an=null,Tt=null,ss=[],Zn=null,ga=!1,on=!1;var Pr,Br,ur,dr,mn,Ur,zr,is,ba,_a,zo,jo;const Gn=class Gn{constructor(){Ne(this,is);k(this,"committed",!1);k(this,"current",new Map);k(this,"previous",new Map);Ne(this,Pr,new Set);Ne(this,Br,new Set);Ne(this,ur,0);Ne(this,dr,0);Ne(this,mn,null);Ne(this,Ur,new Set);Ne(this,zr,new Set);k(this,"skipped_effects",new Set);k(this,"is_fork",!1)}is_deferred(){return this.is_fork||O(this,dr)>0}process(e){var n;ss=[],an=null,this.apply();var t=[],s=[];for(const a of e)kt(this,is,ba).call(this,a,t,s);this.is_fork||kt(this,is,zo).call(this),this.is_deferred()?(kt(this,is,_a).call(this,s),kt(this,is,_a).call(this,t)):(an=this,De=null,Di(s),Di(t),an=null,(n=O(this,mn))==null||n.resolve()),Tt=null}capture(e,t){t!==wt&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Xs||(this.current.set(e,e.v),Tt==null||Tt.set(e,e.v))}activate(){De=this,this.apply()}deactivate(){De===this&&(De=null,Tt=null)}flush(){if(this.activate(),ss.length>0){if(Yo(),De!==null&&De!==this)return}else O(this,ur)===0&&this.process([]);this.deactivate()}discard(){for(const e of O(this,Br))e(this);O(this,Br).clear()}increment(e){Me(this,ur,O(this,ur)+1),e&&Me(this,dr,O(this,dr)+1)}decrement(e){Me(this,ur,O(this,ur)-1),e&&Me(this,dr,O(this,dr)-1),this.revive()}revive(){for(const e of O(this,Ur))O(this,zr).delete(e),gt(e,Ft),qs(e);for(const e of O(this,zr))gt(e,Ps),qs(e);this.flush()}oncommit(e){O(this,Pr).add(e)}ondiscard(e){O(this,Br).add(e)}settled(){return(O(this,mn)??Me(this,mn,Eo())).promise}static ensure(){if(De===null){const e=De=new Gn;En.add(De),on||Gn.enqueue(()=>{De===e&&e.flush()})}return De}static enqueue(e){Zr(e)}apply(){}};Pr=new WeakMap,Br=new WeakMap,ur=new WeakMap,dr=new WeakMap,mn=new WeakMap,Ur=new WeakMap,zr=new WeakMap,is=new WeakSet,ba=function(e,t,s){e.f^=It;for(var n=e.first,a=null;n!==null;){var o=n.f,l=(o&(Fs|Tr))!==0,c=l&&(o&It)!==0,u=c||(o&Qt)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){l?n.f^=It:a!==null&&o&(Ln|Xn|Ao)?a.b.defer_effect(n):o&Ln?t.push(n):wn(n)&&(o&Ls&&O(this,Ur).add(n),hn(n));var h=n.first;if(h!==null){n=h;continue}}var p=n.parent;for(n=n.next;n===null&&p!==null;)p===a&&(a=null),n=p.next,p=p.parent}},_a=function(e){for(var t=0;t<e.length;t+=1)Uo(e[t],O(this,Ur),O(this,zr))},zo=function(){if(O(this,dr)===0){for(const e of O(this,Pr))e();O(this,Pr).clear()}O(this,ur)===0&&kt(this,is,jo).call(this)},jo=function(){var n;if(En.size>1){this.previous.clear();var e=Tt,t=!0;for(const a of En){if(a===this){t=!1;continue}const o=[];for(const[c,u]of this.current){if(a.current.has(c))if(t&&u!==a.current.get(c))a.current.set(c,u);else continue;o.push(c)}if(o.length===0)continue;const l=[...a.current.keys()].filter(c=>!this.current.has(c));if(l.length>0){var s=ss;ss=[];const c=new Set,u=new Map;for(const h of o)Ho(h,l,c,u);if(ss.length>0){De=a,a.apply();for(const h of ss)kt(n=a,is,ba).call(n,h,[],[]);a.deactivate()}ss=s}}De=null,Tt=e}this.committed=!0,En.delete(this)};let Is=Gn;function Pc(r){var e=on;on=!0;try{for(var t;;){if(Lc(),ss.length===0&&(De==null||De.flush(),ss.length===0))return Zn=null,t;Yo()}}finally{on=e}}function Yo(){var r=mr;ga=!0;var e=null;try{var t=0;for(Pn(!0);ss.length>0;){var s=Is.ensure();if(t++>1e3){var n,a;Bc()}s.process(ss),Zs.clear()}}finally{ga=!1,Pn(r),Zn=null}}function Bc(){try{vc()}catch(r){Wr(r,Zn)}}let cs=null;function Di(r){var e=r.length;if(e!==0){for(var t=0;t<e;){var s=r[t++];if(!(s.f&(Os|Qt))&&wn(s)&&(cs=new Set,hn(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?al(s):s.fn=null),(cs==null?void 0:cs.size)>0)){Zs.clear();for(const n of cs){if(n.f&(Os|Qt))continue;const a=[n];let o=n.parent;for(;o!==null;)cs.has(o)&&(cs.delete(o),a.push(o)),o=o.parent;for(let l=a.length-1;l>=0;l--){const c=a[l];c.f&(Os|Qt)||hn(c)}}cs.clear()}}cs=null}}function Ho(r,e,t,s){if(!t.has(r)&&(t.add(r),r.reactions!==null))for(const n of r.reactions){const a=n.f;a&Dt?Ho(n,e,t,s):a&(Xa|Ls)&&!(a&Ft)&&Ko(n,e,s)&&(gt(n,Ft),qs(n))}}function Ko(r,e,t){const s=t.get(r);if(s!==void 0)return s;if(r.deps!==null)for(const n of r.deps){if(e.includes(n))return!0;if(n.f&Dt&&Ko(n,e,t))return t.set(n,!0),!0}return t.set(r,!1),!1}function qs(r){for(var e=Zn=r;e.parent!==null;){e=e.parent;var t=e.f;if(ga&&e===je&&t&Ls&&!(t&Co))return;if(t&(Tr|Fs)){if(!(t&It))return;e.f^=It}}ss.push(e)}function Uc(r){let e=0,t=kr(0),s;return()=>{si()&&(i(t),kn(()=>(e===0&&(s=tr(()=>r(()=>ln(t)))),e+=1,()=>{Zr(()=>{e-=1,e===0&&(s==null||s(),s=void 0,ln(t))})})))}}var zc=Hr|Xr|$a;function jc(r,e,t){new Yc(r,e,t)}var es,Ka,gs,hr,bs,ts,Pt,_s,As,Ks,fr,Ws,vr,jr,Yr,Gs,Qn,mt,Hc,Kc,ka,On,Mn,wa;class Yc{constructor(e,t,s){Ne(this,mt);k(this,"parent");k(this,"is_pending",!1);Ne(this,es);Ne(this,Ka,null);Ne(this,gs);Ne(this,hr);Ne(this,bs);Ne(this,ts,null);Ne(this,Pt,null);Ne(this,_s,null);Ne(this,As,null);Ne(this,Ks,null);Ne(this,fr,0);Ne(this,Ws,0);Ne(this,vr,!1);Ne(this,jr,new Set);Ne(this,Yr,new Set);Ne(this,Gs,null);Ne(this,Qn,Uc(()=>(Me(this,Gs,kr(O(this,fr))),()=>{Me(this,Gs,null)})));Me(this,es,e),Me(this,gs,t),Me(this,hr,s),this.parent=je.b,this.is_pending=!!O(this,gs).pending,Me(this,bs,ai(()=>{je.b=this;{var n=kt(this,mt,ka).call(this);try{Me(this,ts,rs(()=>s(n)))}catch(a){this.error(a)}O(this,Ws)>0?kt(this,mt,Mn).call(this):this.is_pending=!1}return()=>{var a;(a=O(this,Ks))==null||a.remove()}},zc))}defer_effect(e){Uo(e,O(this,jr),O(this,Yr))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!O(this,gs).pending}update_pending_count(e){kt(this,mt,wa).call(this,e),Me(this,fr,O(this,fr)+e),O(this,Gs)&&Gr(O(this,Gs),O(this,fr))}get_effect_pending(){return O(this,Qn).call(this),i(O(this,Gs))}error(e){var t=O(this,gs).onerror;let s=O(this,gs).failed;if(O(this,vr)||!t&&!s)throw e;O(this,ts)&&(Ut(O(this,ts)),Me(this,ts,null)),O(this,Pt)&&(Ut(O(this,Pt)),Me(this,Pt,null)),O(this,_s)&&(Ut(O(this,_s)),Me(this,_s,null));var n=!1,a=!1;const o=()=>{if(n){Mc();return}n=!0,a&&bc(),Is.ensure(),Me(this,fr,0),O(this,_s)!==null&&yr(O(this,_s),()=>{Me(this,_s,null)}),this.is_pending=this.has_pending_snippet(),Me(this,ts,kt(this,mt,On).call(this,()=>(Me(this,vr,!1),rs(()=>O(this,hr).call(this,O(this,es)))))),O(this,Ws)>0?kt(this,mt,Mn).call(this):this.is_pending=!1};var l=xe;try{Bt(null),a=!0,t==null||t(e,o),a=!1}catch(c){Wr(c,O(this,bs)&&O(this,bs).parent)}finally{Bt(l)}s&&Zr(()=>{Me(this,_s,kt(this,mt,On).call(this,()=>{Is.ensure(),Me(this,vr,!0);try{return rs(()=>{s(O(this,es),()=>e,()=>o)})}catch(c){return Wr(c,O(this,bs).parent),null}finally{Me(this,vr,!1)}}))})}}es=new WeakMap,Ka=new WeakMap,gs=new WeakMap,hr=new WeakMap,bs=new WeakMap,ts=new WeakMap,Pt=new WeakMap,_s=new WeakMap,As=new WeakMap,Ks=new WeakMap,fr=new WeakMap,Ws=new WeakMap,vr=new WeakMap,jr=new WeakMap,Yr=new WeakMap,Gs=new WeakMap,Qn=new WeakMap,mt=new WeakSet,Hc=function(){try{Me(this,ts,rs(()=>O(this,hr).call(this,O(this,es))))}catch(e){this.error(e)}},Kc=function(){const e=O(this,gs).pending;e&&(Me(this,Pt,rs(()=>e(O(this,es)))),Is.enqueue(()=>{var t=kt(this,mt,ka).call(this);Me(this,ts,kt(this,mt,On).call(this,()=>(Is.ensure(),rs(()=>O(this,hr).call(this,t))))),O(this,Ws)>0?kt(this,mt,Mn).call(this):(yr(O(this,Pt),()=>{Me(this,Pt,null)}),this.is_pending=!1)}))},ka=function(){var e=O(this,es);return this.is_pending&&(Me(this,Ks,Ns()),O(this,es).before(O(this,Ks)),e=O(this,Ks)),e},On=function(e){var t=je,s=xe,n=dt;Ts(O(this,bs)),Bt(O(this,bs)),Kr(O(this,bs).ctx);try{return e()}catch(a){return Po(a),null}finally{Ts(t),Bt(s),Kr(n)}},Mn=function(){const e=O(this,gs).pending;O(this,ts)!==null&&(Me(this,As,document.createDocumentFragment()),O(this,As).append(O(this,Ks)),ll(O(this,ts),O(this,As))),O(this,Pt)===null&&Me(this,Pt,rs(()=>e(O(this,es))))},wa=function(e){var t;if(!this.has_pending_snippet()){this.parent&&kt(t=this.parent,mt,wa).call(t,e);return}if(Me(this,Ws,O(this,Ws)+e),O(this,Ws)===0){this.is_pending=!1;for(const s of O(this,jr))gt(s,Ft),qs(s);for(const s of O(this,Yr))gt(s,Ps),qs(s);O(this,jr).clear(),O(this,Yr).clear(),O(this,Pt)&&yr(O(this,Pt),()=>{Me(this,Pt,null)}),O(this,As)&&(O(this,es).before(O(this,As)),Me(this,As,null))}};function Wc(r,e,t,s){const n=Jn;if(t.length===0&&r.length===0){s(e.map(n));return}var a=De,o=je,l=Gc();function c(){Promise.all(t.map(u=>Qc(u))).then(u=>{l();try{s([...e.map(n),...u])}catch(h){o.f&Os||Wr(h,o)}a==null||a.deactivate(),Fn()}).catch(u=>{Wr(u,o)})}r.length>0?Promise.all(r).then(()=>{l();try{return c()}finally{a==null||a.deactivate(),Fn()}}):c()}function Gc(){var r=je,e=xe,t=dt,s=De;return function(a=!0){Ts(r),Bt(e),Kr(t),a&&(s==null||s.activate())}}function Fn(){Ts(null),Bt(null),Kr(null)}function Jn(r){var e=Dt|Ft,t=xe!==null&&xe.f&Dt?xe:null;return je!==null&&(je.f|=Xr),{ctx:dt,deps:null,effects:null,equals:Oo,f:e,fn:r,reactions:null,rv:0,v:wt,wv:0,parent:t??je,ac:null}}function Qc(r,e,t){let s=je;s===null&&uc();var n=s.b,a=void 0,o=kr(wt),l=!xe,c=new Map;return au(()=>{var y;var u=Eo();a=u.promise;try{Promise.resolve(r()).then(u.resolve,u.reject).then(()=>{h===De&&h.committed&&h.deactivate(),Fn()})}catch(w){u.reject(w),Fn()}var h=De;if(l){var p=n.is_rendered();n.update_pending_count(1),h.increment(p),(y=c.get(h))==null||y.reject(qr),c.delete(h),c.set(h,u)}const v=(w,m=void 0)=>{if(h.activate(),m)m!==qr&&(o.f|=Xs,Gr(o,m));else{o.f&Xs&&(o.f^=Xs),Gr(o,w);for(const[g,_]of c){if(c.delete(g),g===h)break;_.reject(qr)}}l&&(n.update_pending_count(-1),h.decrement(p))};u.promise.then(v,w=>v(null,w||"unknown"))}),ri(()=>{for(const u of c.values())u.reject(qr)}),new Promise(u=>{function h(p){function v(){p===a?u(o):h(a)}p.then(v,v)}h(a)})}function V(r){const e=Jn(r);return cl(e),e}function Wo(r){const e=Jn(r);return e.equals=No,e}function Go(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)Ut(e[t])}}function $c(r){for(var e=r.parent;e!==null;){if(!(e.f&Dt))return e.f&Os?null:e;e=e.parent}return null}function ei(r){var e,t=je;Ts($c(r));try{r.f&=~_r,Go(r),e=fl(r)}finally{Ts(t)}return e}function Qo(r){var e=ei(r);if(!r.equals(e)&&(r.wv=dl(),(!(De!=null&&De.is_fork)||r.deps===null)&&(r.v=e,r.deps===null))){gt(r,It);return}er||(Tt!==null?(si()||De!=null&&De.is_fork)&&Tt.set(r,e):Ja(r))}let Ta=new Set;const Zs=new Map;let $o=!1;function kr(r,e){var t={f:0,v:r,reactions:null,equals:Oo,rv:0,wv:0};return t}function K(r,e){const t=kr(r);return cl(t),t}function Vc(r,e=!1,t=!0){const s=kr(r);return e||(s.equals=No),s}function b(r,e,t=!1){xe!==null&&(!hs||xe.f&Si)&&Ro()&&xe.f&(Dt|Ls|Xa|Si)&&!(Lt!=null&&Lt.includes(r))&&gc();let s=t?ke(e):e;return Gr(r,s)}function Gr(r,e){if(!r.equals(e)){var t=r.v;er?Zs.set(r,e):Zs.set(r,t),r.v=e;var s=Is.ensure();if(s.capture(r,t),r.f&Dt){const n=r;r.f&Ft&&ei(n),Ja(n)}r.wv=dl(),Vo(r,Ft),je!==null&&je.f&It&&!(je.f&(Fs|Tr))&&(Jt===null?ou([r]):Jt.push(r)),!s.is_fork&&Ta.size>0&&!$o&&Xc()}return e}function Xc(){$o=!1;var r=mr;Pn(!0);const e=Array.from(Ta);try{for(const t of e)t.f&It&&gt(t,Ps),wn(t)&&hn(t)}finally{Pn(r)}Ta.clear()}function Ei(r,e=1){var t=i(r),s=e===1?t++:t--;return b(r,t),s}function ln(r){b(r,r.v+1)}function Vo(r,e){var t=r.reactions;if(t!==null)for(var s=t.length,n=0;n<s;n++){var a=t[n],o=a.f,l=(o&Ft)===0;if(l&&gt(a,e),o&Dt){var c=a;Tt==null||Tt.delete(c),o&_r||(o&as&&(a.f|=_r),Vo(c,Ps))}else l&&(o&Ls&&cs!==null&&cs.add(a),qs(a))}}function ke(r){if(typeof r!="object"||r===null||Ms in r)return r;const e=Qa(r);if(e!==nc&&e!==ac)return r;var t=new Map,s=Ga(r),n=K(0),a=gr,o=l=>{if(gr===a)return l();var c=xe,u=gr;Bt(null),Oi(a);var h=l();return Bt(c),Oi(u),h};return s&&t.set("length",K(r.length)),new Proxy(r,{defineProperty(l,c,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&yc();var h=t.get(c);return h===void 0?h=o(()=>{var p=K(u.value);return t.set(c,p),p}):b(h,u.value,!0),!0},deleteProperty(l,c){var u=t.get(c);if(u===void 0){if(c in l){const h=o(()=>K(wt));t.set(c,h),ln(n)}}else b(u,wt),ln(n);return!0},get(l,c,u){var y;if(c===Ms)return r;var h=t.get(c),p=c in l;if(h===void 0&&(!p||(y=Lr(l,c))!=null&&y.writable)&&(h=o(()=>{var w=ke(p?l[c]:wt),m=K(w);return m}),t.set(c,h)),h!==void 0){var v=i(h);return v===wt?void 0:v}return Reflect.get(l,c,u)},getOwnPropertyDescriptor(l,c){var u=Reflect.getOwnPropertyDescriptor(l,c);if(u&&"value"in u){var h=t.get(c);h&&(u.value=i(h))}else if(u===void 0){var p=t.get(c),v=p==null?void 0:p.v;if(p!==void 0&&v!==wt)return{enumerable:!0,configurable:!0,value:v,writable:!0}}return u},has(l,c){var v;if(c===Ms)return!0;var u=t.get(c),h=u!==void 0&&u.v!==wt||Reflect.has(l,c);if(u!==void 0||je!==null&&(!h||(v=Lr(l,c))!=null&&v.writable)){u===void 0&&(u=o(()=>{var y=h?ke(l[c]):wt,w=K(y);return w}),t.set(c,u));var p=i(u);if(p===wt)return!1}return h},set(l,c,u,h){var D;var p=t.get(c),v=c in l;if(s&&c==="length")for(var y=u;y<p.v;y+=1){var w=t.get(y+"");w!==void 0?b(w,wt):y in l&&(w=o(()=>K(wt)),t.set(y+"",w))}if(p===void 0)(!v||(D=Lr(l,c))!=null&&D.writable)&&(p=o(()=>K(void 0)),b(p,ke(u)),t.set(c,p));else{v=p.v!==wt;var m=o(()=>ke(u));b(p,m)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g!=null&&g.set&&g.set.call(h,u),!v){if(s&&typeof c=="string"){var _=t.get("length"),E=Number(c);Number.isInteger(E)&&E>=_.v&&b(_,E+1)}ln(n)}return!0},ownKeys(l){i(n);var c=Reflect.ownKeys(l).filter(p=>{var v=t.get(p);return v===void 0||v.v!==wt});for(var[u,h]of t)h.v!==wt&&!(u in l)&&c.push(u);return c},setPrototypeOf(){mc()}})}function xi(r){try{if(r!==null&&typeof r=="object"&&Ms in r)return r[Ms]}catch{}return r}function Zc(r,e){return Object.is(xi(r),xi(e))}var Ai,Xo,Zo,Jo;function Jc(){if(Ai===void 0){Ai=window,Xo=/Firefox/.test(navigator.userAgent);var r=Element.prototype,e=Node.prototype,t=Text.prototype;Zo=Lr(e,"firstChild").get,Jo=Lr(e,"nextSibling").get,Ti(r)&&(r.__click=void 0,r.__className=void 0,r.__attributes=null,r.__style=void 0,r.__e=void 0),Ti(t)&&(t.__t=void 0)}}function Ns(r=""){return document.createTextNode(r)}function Qs(r){return Zo.call(r)}function _n(r){return Jo.call(r)}function d(r,e){return Qs(r)}function Ge(r,e=!1){{var t=Qs(r);return t instanceof Comment&&t.data===""?_n(t):t}}function f(r,e=1,t=!1){let s=r;for(;e--;)s=_n(s);return s}function eu(r){r.textContent=""}function el(){return!1}let Ci=!1;function tu(){Ci||(Ci=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{var e;if(!r.defaultPrevented)for(const t of r.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function ea(r){var e=xe,t=je;Bt(null),Ts(null);try{return r()}finally{Bt(e),Ts(t)}}function ti(r,e,t,s=t){r.addEventListener(e,()=>ea(t));const n=r.__on_r;n?r.__on_r=()=>{n(),s(!0)}:r.__on_r=()=>s(!0),tu()}function su(r){je===null&&(xe===null&&fc(),hc()),er&&dc()}function ru(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function Bs(r,e,t){var s=je;s!==null&&s.f&Qt&&(r|=Qt);var n={ctx:dt,deps:null,nodes:null,f:r|Ft|as,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{hn(n),n.f|=Va}catch(l){throw Ut(n),l}else e!==null&&qs(n);var a=n;if(t&&a.deps===null&&a.teardown===null&&a.nodes===null&&a.first===a.last&&!(a.f&Xr)&&(a=a.first,r&Ls&&r&Hr&&a!==null&&(a.f|=Hr)),a!==null&&(a.parent=s,s!==null&&ru(a,s),xe!==null&&xe.f&Dt&&!(r&Tr))){var o=xe;(o.effects??(o.effects=[])).push(a)}return n}function si(){return xe!==null&&!hs}function ri(r){const e=Bs(Xn,null,!1);return gt(e,It),e.teardown=r,e}function yt(r){su();var e=je.f,t=!xe&&(e&Fs)!==0&&(e&Va)===0;if(t){var s=dt;(s.e??(s.e=[])).push(r)}else return tl(r)}function tl(r){return Bs(Ln|oc,r,!1)}function nu(r){Is.ensure();const e=Bs(Tr|Xr,r,!0);return(t={})=>new Promise(s=>{t.outro?yr(e,()=>{Ut(e),s(void 0)}):(Ut(e),s(void 0))})}function ni(r){return Bs(Ln,r,!1)}function au(r){return Bs(Xa|Xr,r,!0)}function kn(r,e=0){return Bs(Xn|e,r,!0)}function j(r,e=[],t=[],s=[]){Wc(s,e,t,n=>{Bs(Xn,()=>r(...n.map(i)),!0)})}function ai(r,e=0){var t=Bs(Ls|e,r,!0);return t}function rs(r){return Bs(Fs|Xr,r,!0)}function sl(r){var e=r.teardown;if(e!==null){const t=er,s=xe;Ii(!0),Bt(null);try{e.call(null)}finally{Ii(t),Bt(s)}}}function rl(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){const n=t.ac;n!==null&&ea(()=>{n.abort(qr)});var s=t.next;t.f&Tr?t.parent=null:Ut(t,e),t=s}}function iu(r){for(var e=r.first;e!==null;){var t=e.next;e.f&Fs||Ut(e),e=t}}function Ut(r,e=!0){var t=!1;(e||r.f&Co)&&r.nodes!==null&&r.nodes.end!==null&&(nl(r.nodes.start,r.nodes.end),t=!0),rl(r,e&&!t),Bn(r,0),gt(r,Os);var s=r.nodes&&r.nodes.t;if(s!==null)for(const a of s)a.stop();sl(r);var n=r.parent;n!==null&&n.first!==null&&al(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes=r.ac=null}function nl(r,e){for(;r!==null;){var t=r===e?null:_n(r);r.remove(),r=t}}function al(r){var e=r.parent,t=r.prev,s=r.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===r&&(e.first=s),e.last===r&&(e.last=t))}function yr(r,e,t=!0){var s=[];il(r,s,!0);var n=()=>{t&&Ut(r),e&&e()},a=s.length;if(a>0){var o=()=>--a||n();for(var l of s)l.out(o)}else n()}function il(r,e,t){if(!(r.f&Qt)){r.f^=Qt;var s=r.nodes&&r.nodes.t;if(s!==null)for(const l of s)(l.is_global||t)&&e.push(l);for(var n=r.first;n!==null;){var a=n.next,o=(n.f&Hr)!==0||(n.f&Fs)!==0&&(r.f&Ls)!==0;il(n,e,o?t:!1),n=a}}}function ii(r){ol(r,!0)}function ol(r,e){if(r.f&Qt){r.f^=Qt,r.f&It||(gt(r,Ft),qs(r));for(var t=r.first;t!==null;){var s=t.next,n=(t.f&Hr)!==0||(t.f&Fs)!==0;ol(t,n?e:!1),t=s}var a=r.nodes&&r.nodes.t;if(a!==null)for(const o of a)(o.is_global||e)&&o.in()}}function ll(r,e){if(r.nodes)for(var t=r.nodes.start,s=r.nodes.end;t!==null;){var n=t===s?null:_n(t);e.append(t),t=n}}let mr=!1;function Pn(r){mr=r}let er=!1;function Ii(r){er=r}let xe=null,hs=!1;function Bt(r){xe=r}let je=null;function Ts(r){je=r}let Lt=null;function cl(r){xe!==null&&(Lt===null?Lt=[r]:Lt.push(r))}let qt=null,Kt=0,Jt=null;function ou(r){Jt=r}let ul=1,dn=0,gr=dn;function Oi(r){gr=r}function dl(){return++ul}function wn(r){var e=r.f;if(e&Ft)return!0;if(e&Dt&&(r.f&=~_r),e&Ps){for(var t=r.deps,s=t.length,n=0;n<s;n++){var a=t[n];if(wn(a)&&Qo(a),a.wv>r.wv)return!0}e&as&&Tt===null&&gt(r,It)}return!1}function hl(r,e,t=!0){var s=r.reactions;if(s!==null&&!(Lt!=null&&Lt.includes(r)))for(var n=0;n<s.length;n++){var a=s[n];a.f&Dt?hl(a,e,!1):e===a&&(t?gt(a,Ft):a.f&It&&gt(a,Ps),qs(a))}}function fl(r){var w;var e=qt,t=Kt,s=Jt,n=xe,a=Lt,o=dt,l=hs,c=gr,u=r.f;qt=null,Kt=0,Jt=null,xe=u&(Fs|Tr)?null:r,Lt=null,Kr(r.ctx),hs=!1,gr=++dn,r.ac!==null&&(ea(()=>{r.ac.abort(qr)}),r.ac=null);try{r.f|=ma;var h=r.fn,p=h(),v=r.deps;if(qt!==null){var y;if(Bn(r,Kt),v!==null&&Kt>0)for(v.length=Kt+qt.length,y=0;y<qt.length;y++)v[Kt+y]=qt[y];else r.deps=v=qt;if(si()&&r.f&as)for(y=Kt;y<v.length;y++)((w=v[y]).reactions??(w.reactions=[])).push(r)}else v!==null&&Kt<v.length&&(Bn(r,Kt),v.length=Kt);if(Ro()&&Jt!==null&&!hs&&v!==null&&!(r.f&(Dt|Ps|Ft)))for(y=0;y<Jt.length;y++)hl(Jt[y],r);return n!==null&&n!==r&&(dn++,Jt!==null&&(s===null?s=Jt:s.push(...Jt))),r.f&Xs&&(r.f^=Xs),p}catch(m){return Po(m)}finally{r.f^=ma,qt=e,Kt=t,Jt=s,xe=n,Lt=a,Kr(o),hs=l,gr=c}}function lu(r,e){let t=e.reactions;if(t!==null){var s=sc.call(t,r);if(s!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[s]=t[n],t.pop())}}if(t===null&&e.f&Dt&&(qt===null||!qt.includes(e))){var a=e;a.f&as&&(a.f^=as,a.f&=~_r),Ja(a),Go(a),Bn(a,0)}}function Bn(r,e){var t=r.deps;if(t!==null)for(var s=e;s<t.length;s++)lu(r,t[s])}function hn(r){var e=r.f;if(!(e&Os)){gt(r,It);var t=je,s=mr;je=r,mr=!0;try{e&(Ls|Ao)?iu(r):rl(r),sl(r);var n=fl(r);r.teardown=typeof n=="function"?n:null,r.wv=ul;var a;ya&&Nc&&r.f&Ft&&r.deps}finally{mr=s,je=t}}}async function vl(){await Promise.resolve(),Pc()}function i(r){var e=r.f,t=(e&Dt)!==0;if(xe!==null&&!hs){var s=je!==null&&(je.f&Os)!==0;if(!s&&!(Lt!=null&&Lt.includes(r))){var n=xe.deps;if(xe.f&ma)r.rv<dn&&(r.rv=dn,qt===null&&n!==null&&n[Kt]===r?Kt++:qt===null?qt=[r]:qt.includes(r)||qt.push(r));else{(xe.deps??(xe.deps=[])).push(r);var a=r.reactions;a===null?r.reactions=[xe]:a.includes(xe)||a.push(xe)}}}if(er&&Zs.has(r))return Zs.get(r);if(t){var o=r;if(er){var l=o.v;return(!(o.f&It)&&o.reactions!==null||yl(o))&&(l=ei(o)),Zs.set(o,l),l}var c=(o.f&as)===0&&!hs&&xe!==null&&(mr||(xe.f&as)!==0),u=o.deps===null;wn(o)&&(c&&(o.f|=as),Qo(o)),c&&!u&&pl(o)}if(Tt!=null&&Tt.has(r))return Tt.get(r);if(r.f&Xs)throw r.v;return r.v}function pl(r){if(r.deps!==null){r.f|=as;for(const e of r.deps)(e.reactions??(e.reactions=[])).push(r),e.f&Dt&&!(e.f&as)&&pl(e)}}function yl(r){if(r.v===wt)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(Zs.has(e)||e.f&Dt&&yl(e))return!0;return!1}function tr(r){var e=hs;try{return hs=!0,r()}finally{hs=e}}function cu(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(Ms in r)Sa(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&Ms in t&&Sa(t)}}}function Sa(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let s in r)try{Sa(r[s],e)}catch{}const t=Qa(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const s=Do(t);for(let n in s){const a=s[n].get;if(a)try{a.call(r)}catch{}}}}}const uu=["touchstart","touchmove"];function du(r){return uu.includes(r)}const ml=new Set,Da=new Set;function hu(r,e,t,s={}){function n(a){if(s.capture||sn.call(e,a),!a.cancelBubble)return ea(()=>t==null?void 0:t.call(this,a))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?Zr(()=>{e.addEventListener(r,n,s)}):e.addEventListener(r,n,s),n}function St(r,e,t,s,n){var a={capture:s,passive:n},o=hu(r,e,t,a);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&ri(()=>{e.removeEventListener(r,o,a)})}function ht(r){for(var e=0;e<r.length;e++)ml.add(r[e]);for(var t of Da)t(r)}let Mi=null;function sn(r){var g;var e=this,t=e.ownerDocument,s=r.type,n=((g=r.composedPath)==null?void 0:g.call(r))||[],a=n[0]||r.target;Mi=r;var o=0,l=Mi===r&&r.__root;if(l){var c=n.indexOf(l);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var u=n.indexOf(e);if(u===-1)return;c<=u&&(o=c)}if(a=n[o]||r.target,a!==e){rc(r,"currentTarget",{configurable:!0,get(){return a||t}});var h=xe,p=je;Bt(null),Ts(null);try{for(var v,y=[];a!==null;){var w=a.assignedSlot||a.parentNode||a.host||null;try{var m=a["__"+s];m!=null&&(!a.disabled||r.target===a)&&m.call(a,r)}catch(_){v?y.push(_):v=_}if(r.cancelBubble||w===e||w===null)break;a=w}if(v){for(let _ of y)queueMicrotask(()=>{throw _});throw v}}finally{r.__root=e,delete r.currentTarget,Bt(h),Ts(p)}}}function gl(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function fn(r,e){var t=je;t.nodes===null&&(t.nodes={start:r,end:e,a:null,t:null})}function A(r,e){var t=(e&Ac)!==0,s=(e&Cc)!==0,n,a=!r.startsWith("<!>");return()=>{n===void 0&&(n=gl(a?r:"<!>"+r),t||(n=Qs(n)));var o=s||Xo?document.importNode(n,!0):n.cloneNode(!0);if(t){var l=Qs(o),c=o.lastChild;fn(l,c)}else fn(o,o);return o}}function na(r=""){{var e=Ns(r+"");return fn(e,e),e}}function rt(){var r=document.createDocumentFragment(),e=document.createComment(""),t=Ns();return r.append(e,t),fn(e,t),r}function S(r,e){r!==null&&r.before(e)}function P(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??(r.__t=r.nodeValue))&&(r.__t=t,r.nodeValue=t+"")}function xn(r,e){return fu(r,e)}const Cr=new Map;function fu(r,{target:e,anchor:t,props:s={},events:n,context:a,intro:o=!0}){Jc();var l=new Set,c=p=>{for(var v=0;v<p.length;v++){var y=p[v];if(!l.has(y)){l.add(y);var w=du(y);e.addEventListener(y,sn,{passive:w});var m=Cr.get(y);m===void 0?(document.addEventListener(y,sn,{passive:w}),Cr.set(y,1)):Cr.set(y,m+1)}}};c(Vn(ml)),Da.add(c);var u=void 0,h=nu(()=>{var p=t??e.appendChild(Ns());return jc(p,{pending:()=>{}},v=>{if(a){Je({});var y=dt;y.c=a}n&&(s.$$events=n),u=r(v,s)||{},a&&et()}),()=>{var w;for(var v of l){e.removeEventListener(v,sn);var y=Cr.get(v);--y===0?(document.removeEventListener(v,sn),Cr.delete(v)):Cr.set(v,y)}Da.delete(c),p!==t&&((w=p.parentNode)==null||w.removeChild(p))}});return Ea.set(u,h),u}let Ea=new WeakMap;function An(r,e){const t=Ea.get(r);return t?(Ea.delete(r),t(e)):Promise.resolve()}var us,ks,Wt,pr,gn,bn,$n;class vu{constructor(e,t=!0){k(this,"anchor");Ne(this,us,new Map);Ne(this,ks,new Map);Ne(this,Wt,new Map);Ne(this,pr,new Set);Ne(this,gn,!0);Ne(this,bn,()=>{var e=De;if(O(this,us).has(e)){var t=O(this,us).get(e),s=O(this,ks).get(t);if(s)ii(s),O(this,pr).delete(t);else{var n=O(this,Wt).get(t);n&&(O(this,ks).set(t,n.effect),O(this,Wt).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[a,o]of O(this,us)){if(O(this,us).delete(a),a===e)break;const l=O(this,Wt).get(o);l&&(Ut(l.effect),O(this,Wt).delete(o))}for(const[a,o]of O(this,ks)){if(a===t||O(this,pr).has(a))continue;const l=()=>{if(Array.from(O(this,us).values()).includes(a)){var u=document.createDocumentFragment();ll(o,u),u.append(Ns()),O(this,Wt).set(a,{effect:o,fragment:u})}else Ut(o);O(this,pr).delete(a),O(this,ks).delete(a)};O(this,gn)||!s?(O(this,pr).add(a),yr(o,l,!1)):l()}}});Ne(this,$n,e=>{O(this,us).delete(e);const t=Array.from(O(this,us).values());for(const[s,n]of O(this,Wt))t.includes(s)||(Ut(n.effect),O(this,Wt).delete(s))});this.anchor=e,Me(this,gn,t)}ensure(e,t){var s=De,n=el();if(t&&!O(this,ks).has(e)&&!O(this,Wt).has(e))if(n){var a=document.createDocumentFragment(),o=Ns();a.append(o),O(this,Wt).set(e,{effect:rs(()=>t(o)),fragment:a})}else O(this,ks).set(e,rs(()=>t(this.anchor)));if(O(this,us).set(s,e),n){for(const[l,c]of O(this,ks))l===e?s.skipped_effects.delete(c):s.skipped_effects.add(c);for(const[l,c]of O(this,Wt))l===e?s.skipped_effects.delete(c.effect):s.skipped_effects.add(c.effect);s.oncommit(O(this,bn)),s.ondiscard(O(this,$n))}else O(this,bn).call(this)}}us=new WeakMap,ks=new WeakMap,Wt=new WeakMap,pr=new WeakMap,gn=new WeakMap,bn=new WeakMap,$n=new WeakMap;function G(r,e,t=!1){var s=new vu(r),n=t?Hr:0;function a(o,l){s.ensure(o,l)}ai(()=>{var o=!1;e((l,c=!0)=>{o=!0,a(c,l)}),o||a(!1,null)},n)}function nt(r,e){return e}function pu(r,e,t){for(var s=[],n=e.length,a,o=e.length,l=0;l<n;l++){let p=e[l];yr(p,()=>{if(a){if(a.pending.delete(p),a.done.add(p),a.pending.size===0){var v=r.outrogroups;xa(Vn(a.done)),v.delete(a),v.size===0&&(r.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=s.length===0&&t!==null;if(c){var u=t,h=u.parentNode;eu(h),h.append(u),r.items.clear()}xa(e,!c)}else a={pending:new Set(e),done:new Set},(r.outrogroups??(r.outrogroups=new Set)).add(a)}function xa(r,e=!0){for(var t=0;t<r.length;t++)Ut(r[t],e)}var Ni;function Fe(r,e,t,s,n,a=null){var o=r,l=new Map,c=(e&Io)!==0;if(c){var u=r;o=u.appendChild(Ns())}var h=null,p=Wo(()=>{var _=t();return Ga(_)?_:_==null?[]:Vn(_)}),v,y=!0;function w(){g.fallback=h,yu(g,v,o,e,s),h!==null&&(v.length===0?h.f&Cs?(h.f^=Cs,rn(h,null,o)):ii(h):yr(h,()=>{h=null}))}var m=ai(()=>{v=i(p);for(var _=v.length,E=new Set,D=De,x=el(),R=0;R<_;R+=1){var U=v[R],N=s(U,R),W=y?null:l.get(N);W?(W.v&&Gr(W.v,U),W.i&&Gr(W.i,R),x&&D.skipped_effects.delete(W.e)):(W=mu(l,y?o:Ni??(Ni=Ns()),U,N,R,n,e,t),y||(W.e.f|=Cs),l.set(N,W)),E.add(N)}if(_===0&&a&&!h&&(y?h=rs(()=>a(o)):(h=rs(()=>a(Ni??(Ni=Ns()))),h.f|=Cs)),!y)if(x){for(const[Y,J]of l)E.has(Y)||D.skipped_effects.add(J.e);D.oncommit(w),D.ondiscard(()=>{})}else w();i(p)}),g={effect:m,items:l,outrogroups:null,fallback:h};y=!1}function yu(r,e,t,s,n){var J,re,te,le,ye,H,L,C,z;var a=(s&wc)!==0,o=e.length,l=r.items,c=r.effect.first,u,h=null,p,v=[],y=[],w,m,g,_;if(a)for(_=0;_<o;_+=1)w=e[_],m=n(w,_),g=l.get(m).e,g.f&Cs||((re=(J=g.nodes)==null?void 0:J.a)==null||re.measure(),(p??(p=new Set)).add(g));for(_=0;_<o;_+=1){if(w=e[_],m=n(w,_),g=l.get(m).e,r.outrogroups!==null)for(const se of r.outrogroups)se.pending.delete(g),se.done.delete(g);if(g.f&Cs)if(g.f^=Cs,g===c)rn(g,null,t);else{var E=h?h.next:c;g===r.effect.last&&(r.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),js(r,h,g),js(r,g,E),rn(g,E,t),h=g,v=[],y=[],c=h.next;continue}if(g.f&Qt&&(ii(g),a&&((le=(te=g.nodes)==null?void 0:te.a)==null||le.unfix(),(p??(p=new Set)).delete(g))),g!==c){if(u!==void 0&&u.has(g)){if(v.length<y.length){var D=y[0],x;h=D.prev;var R=v[0],U=v[v.length-1];for(x=0;x<v.length;x+=1)rn(v[x],D,t);for(x=0;x<y.length;x+=1)u.delete(y[x]);js(r,R.prev,U.next),js(r,h,R),js(r,U,D),c=D,h=U,_-=1,v=[],y=[]}else u.delete(g),rn(g,c,t),js(r,g.prev,g.next),js(r,g,h===null?r.effect.first:h.next),js(r,h,g),h=g;continue}for(v=[],y=[];c!==null&&c!==g;)(u??(u=new Set)).add(c),y.push(c),c=c.next;if(c===null)continue}g.f&Cs||v.push(g),h=g,c=g.next}if(r.outrogroups!==null){for(const se of r.outrogroups)se.pending.size===0&&(xa(Vn(se.done)),(ye=r.outrogroups)==null||ye.delete(se));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||u!==void 0){var N=[];if(u!==void 0)for(g of u)g.f&Qt||N.push(g);for(;c!==null;)!(c.f&Qt)&&c!==r.fallback&&N.push(c),c=c.next;var W=N.length;if(W>0){var Y=s&Io&&o===0?t:null;if(a){for(_=0;_<W;_+=1)(L=(H=N[_].nodes)==null?void 0:H.a)==null||L.measure();for(_=0;_<W;_+=1)(z=(C=N[_].nodes)==null?void 0:C.a)==null||z.fix()}pu(r,N,Y)}}a&&Zr(()=>{var se,X;if(p!==void 0)for(g of p)(X=(se=g.nodes)==null?void 0:se.a)==null||X.apply()})}function mu(r,e,t,s,n,a,o,l){var c=o&_c?o&Tc?kr(t):Vc(t,!1,!1):null,u=o&kc?kr(n):null;return{v:c,i:u,e:rs(()=>(a(e,c??t,u??n,l),()=>{r.delete(s)}))}}function rn(r,e,t){if(r.nodes)for(var s=r.nodes.start,n=r.nodes.end,a=e&&!(e.f&Cs)?e.nodes.start:t;s!==null;){var o=_n(s);if(a.before(s),s===n)return;s=o}}function js(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function gu(r,e,t=!1,s=!1,n=!1){var a=r,o="";j(()=>{var l=je;if(o!==(o=e()??"")&&(l.nodes!==null&&(nl(l.nodes.start,l.nodes.end),l.nodes=null),o!=="")){var c=o+"";t?c=`<svg>${c}</svg>`:s&&(c=`<math>${c}</math>`);var u=gl(c);if((t||s)&&(u=Qs(u)),fn(Qs(u),u.lastChild),t||s)for(;Qs(u);)a.before(Qs(u));else a.before(u)}})}function bu(r,e,t){ni(()=>{var s=tr(()=>e(r,t==null?void 0:t())||{});if(t&&(s!=null&&s.update)){var n=!1,a={};kn(()=>{var o=t();cu(o),n&&Mo(a,o)&&(a=o,s.update(o))}),n=!0}if(s!=null&&s.destroy)return()=>s.destroy()})}function bl(r){var e,t,s="";if(typeof r=="string"||typeof r=="number")s+=r;else if(typeof r=="object")if(Array.isArray(r)){var n=r.length;for(e=0;e<n;e++)r[e]&&(t=bl(r[e]))&&(s&&(s+=" "),s+=t)}else for(t in r)r[t]&&(s&&(s+=" "),s+=t);return s}function _u(){for(var r,e,t=0,s="",n=arguments.length;t<n;t++)(r=arguments[t])&&(e=bl(r))&&(s&&(s+=" "),s+=e);return s}function ku(r){return typeof r=="object"?_u(r):r??""}const qi=[...` 	
\r\f \v\uFEFF`];function wu(r,e,t){var s=r==null?"":""+r;if(e&&(s=s?s+" "+e:e),t){for(var n in t)if(t[n])s=s?s+" "+n:n;else if(s.length)for(var a=n.length,o=0;(o=s.indexOf(n,o))>=0;){var l=o+a;(o===0||qi.includes(s[o-1]))&&(l===s.length||qi.includes(s[l]))?s=(o===0?"":s.substring(0,o))+s.substring(l+1):o=l}}return s===""?null:s}function Tu(r,e){return r==null?null:String(r)}function Ke(r,e,t,s,n,a){var o=r.__className;if(o!==t||o===void 0){var l=wu(t,s,a);l==null?r.removeAttribute("class"):r.className=l,r.__className=t}else if(a&&n!==a)for(var c in a){var u=!!a[c];(n==null||u!==!!n[c])&&r.classList.toggle(c,u)}return a}function br(r,e,t,s){var n=r.__style;if(n!==e){var a=Tu(e);a==null?r.removeAttribute("style"):r.style.cssText=a,r.__style=e}return s}function _l(r,e,t=!1){if(r.multiple){if(e==null)return;if(!Ga(e))return Oc();for(var s of r.options)s.selected=e.includes(cn(s));return}for(s of r.options){var n=cn(s);if(Zc(n,e)){s.selected=!0;return}}(!t||e!==void 0)&&(r.selectedIndex=-1)}function Su(r){var e=new MutationObserver(()=>{_l(r,r.__value)});e.observe(r,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),ri(()=>{e.disconnect()})}function Du(r,e,t=e){var s=new WeakSet,n=!0;ti(r,"change",a=>{var o=a?"[selected]":":checked",l;if(r.multiple)l=[].map.call(r.querySelectorAll(o),cn);else{var c=r.querySelector(o)??r.querySelector("option:not([disabled])");l=c&&cn(c)}t(l),De!==null&&s.add(De)}),ni(()=>{var a=e();if(r===document.activeElement){var o=an??De;if(s.has(o))return}if(_l(r,a,n),n&&a===void 0){var l=r.querySelector(":checked");l!==null&&(a=cn(l),t(a))}r.__value=a,n=!1}),Su(r)}function cn(r){return"__value"in r?r.__value:r.value}const Eu=Symbol("is custom element"),xu=Symbol("is html");function oi(r,e){var t=li(r);t.value===(t.value=e??void 0)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e??"")}function Fr(r,e){var t=li(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function Ee(r,e,t,s){var n=li(r);n[e]!==(n[e]=t)&&(e==="loading"&&(r[cc]=t),t==null?r.removeAttribute(e):typeof t!="string"&&Au(r).includes(e)?r[e]=t:r.setAttribute(e,t))}function li(r){return r.__attributes??(r.__attributes={[Eu]:r.nodeName.includes("-"),[xu]:r.namespaceURI===Ic})}var Ri=new Map;function Au(r){var e=r.getAttribute("is")||r.nodeName,t=Ri.get(e);if(t)return t;Ri.set(e,t=[]);for(var s,n=r,a=Element.prototype;a!==n;){s=Do(n);for(var o in s)s[o].set&&t.push(o);n=Qa(n)}return t}function at(r,e,t=e){var s=new WeakSet;ti(r,"input",async n=>{var a=n?r.defaultValue:r.value;if(a=aa(r)?ia(a):a,t(a),De!==null&&s.add(De),await vl(),a!==(a=e())){var o=r.selectionStart,l=r.selectionEnd,c=r.value.length;if(r.value=a??"",l!==null){var u=r.value.length;o===l&&l===c&&u>c?(r.selectionStart=u,r.selectionEnd=u):(r.selectionStart=o,r.selectionEnd=Math.min(l,u))}}}),tr(e)==null&&r.value&&(t(aa(r)?ia(r.value):r.value),De!==null&&s.add(De)),kn(()=>{var n=e();if(r===document.activeElement){var a=an??De;if(s.has(a))return}aa(r)&&n===ia(r.value)||r.type==="date"&&!n&&!r.value||n!==r.value&&(r.value=n??"")})}function Aa(r,e,t=e){ti(r,"change",s=>{var n=s?r.defaultChecked:r.checked;t(n)}),tr(e)==null&&t(r.checked),kn(()=>{var s=e();r.checked=!!s})}function aa(r){var e=r.type;return e==="number"||e==="range"}function ia(r){return r===""?null:+r}function Li(r,e){return r===e||(r==null?void 0:r[Ms])===e}function fs(r={},e,t,s){return ni(()=>{var n,a;return kn(()=>{n=a,a=(s==null?void 0:s())||[],tr(()=>{r!==t(...a)&&(e(r,...a),n&&Li(t(...n),r)&&e(null,...n))})}),()=>{Zr(()=>{a&&Li(t(...a),r)&&e(null,...a)})}}),r}let Cn=!1;function Cu(r){var e=Cn;try{return Cn=!1,[r(),Cn]}finally{Cn=e}}function Rs(r,e,t,s){var E;var n=(t&Ec)!==0,a=(t&xc)!==0,o=s,l=!0,c=()=>(l&&(l=!1,o=a?tr(s):s),o),u;if(n){var h=Ms in r||lc in r;u=((E=Lr(r,e))==null?void 0:E.set)??(h&&e in r?D=>r[e]=D:void 0)}var p,v=!1;n?[p,v]=Cu(()=>r[e]):p=r[e],p===void 0&&s!==void 0&&(p=c(),u&&(pc(),u(p)));var y;if(y=()=>{var D=r[e];return D===void 0?c():(l=!0,D)},!(t&Dc))return y;if(u){var w=r.$$legacy;return function(D,x){return arguments.length>0?((!x||w||v)&&u(x?y():D),D):y()}}var m=!1,g=(t&Sc?Jn:Wo)(()=>(m=!1,y()));n&&i(g);var _=je;return function(D,x){if(arguments.length>0){const R=x?i(g):n?ke(D):D;return b(g,R),m=!0,o!==void 0&&(o=R),D}return er&&m||_.f&Os?g.v:i(g)}}function Tn(r){dt===null&&Za(),yt(()=>{const e=tr(r);if(typeof e=="function")return e})}function Iu(r){dt===null&&Za(),Tn(()=>()=>tr(r))}const Ou="5";var So;typeof window<"u"&&((So=window.__svelte??(window.__svelte={})).v??(So.v=new Set)).add(Ou);function Mu(){return{type:"daily",interval:1,time:"09:00"}}function kl(r){return!r||!r.type||!r.interval||r.interval<1?!1:r.type==="weekly"?Array.isArray(r.weekdays)&&r.weekdays.length>0&&r.weekdays.every(e=>e>=0&&e<=6):r.type==="monthly"?r.dayOfMonth>=1&&r.dayOfMonth<=31:r.type==="yearly"?r.month>=0&&r.month<=11&&r.dayOfMonth>=1&&r.dayOfMonth<=31:!0}const lr="recurring-tasks-active",Nn="recurring-tasks-archive",Fi="recurring-tasks",Pi="recurring-tasks.json.bak",Bi="n8n-event-settings",Ui="n8n-event-queue",Nu="notification-state",qu="recurring-tasks-dock",zi="scheduler-emitted-occurrences",Ys=4,Ca={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},ci=60*1e3,Ru=30*1e3,oa=2e3,ji="shehab-note-recurring-plugin",Yi="1.0.0",Lu=60*60*1e3,Fu=3,Hi=10,la=1e3,qn=100,Ki=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],Pu=[{label:"+1 day",minutes:60*24},{label:"+3 days",minutes:60*24*3},{label:"+1 week",minutes:60*24*7}],Bu={lowest:"#94a3b8",low:"#64748b",normal:"#3b82f6",medium:"#f59e0b",high:"#f97316",highest:"#ef4444"},Uu=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Wi="last-run-timestamp",Gi="custom-recurring-task-id",Qi="custom-recurring-task-due",$i="custom-recurring-task-enabled",In=3,Vi=[1e3,5e3,3e4],zu=1e4,ui={dueSoonScoreMax:100,dueSoonScoreMin:0,dueDateWeight:10,overdueBaseScore:110,overduePenaltyWeight:15,noDueDateScore:0,priorityMultipliers:{lowest:.8,low:1,normal:1.1,medium:1.2,high:1.5,highest:2},maxUrgency:200,minUrgency:0},wl=24*60*60*1e3,ju=(r,e,t)=>Math.min(t,Math.max(e,r)),Xi=r=>new Date(r.getFullYear(),r.getMonth(),r.getDate()),Yu=(r,e)=>{const t=Xi(r),s=Xi(e);return Math.round((s.getTime()-t.getTime())/wl)},Hu=(r,e)=>e.priorityMultipliers[r]??1;function di(r,e={}){return Ku(r,e).score}function Ku(r,e={}){const t=e.now??new Date,s=e.settings??ui;if(!hi(r))return{score:0,breakdown:{priorityContribution:0,dueDateContribution:0,overdueContribution:0}};const n=Qr(r.priority)??"normal",a=Hu(n,s);if(!r.dueAt){const w=s.noDueDateScore,m=w*a;return{score:ca(m,s),breakdown:{priorityContribution:m-w,dueDateContribution:w,overdueContribution:0}}}const o=new Date(r.dueAt);if(Number.isNaN(o.getTime())){const w=s.noDueDateScore,m=w*a;return{score:ca(m,s),breakdown:{priorityContribution:m-w,dueDateContribution:w,overdueContribution:0}}}const l=o.getTime()<t.getTime(),c=Yu(t,o),u=l?Math.max(1,Math.ceil((t.getTime()-o.getTime())/wl)):0,h=l?0:ju(s.dueSoonScoreMax-c*s.dueDateWeight,s.dueSoonScoreMin,s.dueSoonScoreMax),p=l?s.overdueBaseScore+u*s.overduePenaltyWeight:0,v=h+p,y=v*a;return{score:ca(y,s),breakdown:{priorityContribution:y-v,dueDateContribution:h,overdueContribution:p}}}function ca(r,e){const t=e.maxUrgency!==void 0?Math.min(e.maxUrgency,r):r;return Math.round(Math.max(e.minUrgency,t))}function Tl(r,e,t){const s=new Date().toISOString(),n=t||new Date;return{id:Sl(),name:r,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:Ys,createdAt:s,updatedAt:s}}const Wu=["lowest","low","normal","medium","high","highest"];function Qr(r){if(!r)return;const e=r.toLowerCase();if(e==="urgent")return"highest";if(e==="none")return"normal";if(Wu.includes(e))return e}function Sl(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Dl(r,e={}){const t=new Date().toISOString();return{...{...r,id:Sl(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Gu(r){const e=new Date().toISOString();r.completionCount=(r.completionCount||0)+1,r.currentStreak=(r.currentStreak||0)+1,r.bestStreak=Math.max(r.bestStreak||0,r.currentStreak),r.recentCompletions||(r.recentCompletions=[]),r.recentCompletions.push(e),r.recentCompletions.length>Hi&&(r.recentCompletions=r.recentCompletions.slice(-Hi)),r.snoozeCount=0,r.lastCompletedAt=e,r.updatedAt=e}function El(r){r.missCount=(r.missCount||0)+1,r.currentStreak=0,r.updatedAt=new Date().toISOString()}function xl(r){const e=r.completionCount||0,t=r.missCount||0,s=e+t;if(s===0)return 100;let a=e/s*70;const o=r.currentStreak||0,l=Math.min(30,o*3);return a+=l,Math.round(Math.min(100,a))}function Qu(r,e){const t=new Set([...r.blockedBy??[],...r.dependsOn??[]]);return t.size===0?!1:e.filter(n=>t.has(n.id)).some(n=>hi(n))}function $u(r,e){return e.some(t=>t.id===r.id||!new Set([...t.blockedBy??[],...t.dependsOn??[]]).has(r.id)?!1:hi(t))}function hi(r){return r.status?r.status==="todo":r.enabled}function cr(r){const{message:e,type:t="info",duration:s=3e3,actionLabel:n,onAction:a,showCountdown:o=!1}=r,l=document.createElement("div");l.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const c=document.createElement("span");c.textContent=e,l.appendChild(c);let u=null;if(n&&a){const p=document.createElement("button");p.type="button";let v=Math.max(1,Math.ceil(s/1e3));p.textContent=o?`${n} (${v}s)`:n,p.className="recurring-tasks-toast__action",p.addEventListener("click",()=>{a(),u!==null&&window.clearInterval(u),l.parentElement&&l.parentElement.removeChild(l)}),l.appendChild(p),o&&s>0&&(u=window.setInterval(()=>{v=Math.max(0,v-1),p.textContent=`${n} (${v}s)`,v<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(l.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:Vu(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(l);const h=()=>{u!==null&&window.clearInterval(u),l.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{l.parentElement&&l.parentElement.removeChild(l)},300)};s>0&&setTimeout(()=>{h()},s)}function Vu(r){switch(r){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const Q={success:(r,e)=>cr({message:r,type:"success",duration:e}),error:(r,e)=>cr({message:r,type:"error",duration:e}),warning:(r,e)=>cr({message:r,type:"warning",duration:e}),info:(r,e)=>cr({message:r,type:"info",duration:e})};if(typeof document<"u"){const r=document.createElement("style");r.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(r)}class Xu{constructor(){k(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(n=>n(t))}clear(){this.handlers.clear()}}const ze=new Xu;function ua(r,e){const t=r.findIndex(n=>n.id===e.id);if(t===-1)return[...r,e];const s=[...r];return s[t]=e,s}function Zi(r,e){const t=r.filter(s=>s.id!==e);return t.length===r.length?r:t}function da(r,e,t){let s=!1;const n=r.map(a=>a.id!==e?a:(s=!0,t(a)));return s?n:r}function Zu(r,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),r.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const fi=Symbol("urgency-settings"),Ju=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function ta(r,e,t){const s={timestamp:new Date().toISOString()},n=`[${r.toUpperCase()}] [${s.timestamp}]`;r==="error"?console.error(n,e,t||""):r==="warn"?console.warn(n,e,t||""):r==="debug"&&Ju?console.debug(n,e,t||""):r==="info"&&console.log(n,e,t||"")}function Al(r,e){ta("debug",r,e)}function de(r,e){ta("info",r,e)}function Qe(r,e){ta("warn",r,e)}function be(r,e){ta("error",r,e)}async function ed(r){return new Promise(e=>{try{Wa.fetchPost("/api/block/getBlockInfo",{id:r},t=>{var n,a,o;const s=((n=t==null?void 0:t.data)==null?void 0:n.content)??((a=t==null?void 0:t.data)==null?void 0:a.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){Qe("Failed to fetch block preview",t),e(null)}})}async function td(r){return new Promise(e=>{try{Wa.fetchPost("/api/block/getBlockHTML",{id:r},t=>{var n;const s=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(s?s.trim():null)})}catch(t){Qe("Failed to fetch block embed",t),e(null)}})}function Ia(r){const[e,t]=r.split(":").map(Number);return{hours:e,minutes:t}}function sd(r){const e=r.getHours().toString().padStart(2,"0"),t=r.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function rd(r){return r.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Oa(r){return r.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function vi(r){const e=new Date;return r.getDate()===e.getDate()&&r.getMonth()===e.getMonth()&&r.getFullYear()===e.getFullYear()}function nd(r){return r<new Date}function ad(r){return nd(r)&&!vi(r)}function vn(r,e){const t=new Date(r);return t.setDate(t.getDate()+e),t}function Ji(r,e){return vn(r,e*7)}function eo(r,e,t){const s=new Date(r);s.setHours(e,t,0,0);const n=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:n}}function Ma(r){const e=new Date(r);return e.setHours(0,0,0,0),e}function id(r){const e=new Date(r);return e.setHours(23,59,59,999),e}function od(r,e){const s=Math.abs(e.getTime()-r.getTime());return Math.floor(s/864e5)}function ld(r,e){const t=[];for(let s=0;s<e;s++)t.push(vn(r,s));return t}var cd=A('<span class="task-card__streak svelte-yjw1ud"> </span>'),ud=A('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">✏️</button>'),dd=A('<span class="task-card__relative svelte-yjw1ud"> </span>'),hd=A('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),fd=A('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),vd=A('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),pd=A('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),yd=A('<button class="task-card__snooze-chip"> </button>'),md=A('<button class="task-card__snooze-option" role="menuitem"> </button>'),gd=A('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),bd=A('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <div class="task-card__urgency svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Urgency:</span> <span class="task-card__value svelte-yjw1ud"> </span></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">🕒 Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">🕒 Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">⏭️ Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">✅ Done</button></div></div>');function Jr(r,e){Je(e,!0);const t=V(()=>new Date(e.task.dueAt)),s=V(()=>ad(i(t))),n=V(()=>vi(i(t))),a=V(()=>i(s)?od(new Date(e.task.dueAt),new Date):0),o=V(()=>i(s)?"task-card--overdue":i(n)?"task-card--today":""),l=V(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+i(a)*.05)})`:""),c=V(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+i(a)*.08)})`:""),u=V(()=>()=>{const ee=Qr(e.task.priority)||"normal";return Bu[ee]}),h=V(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(i(t)):""),p=V(()=>(e.task.currentStreak||0)>0),v=V(()=>()=>"🔥"),y=V(()=>xl(e.task)),w=V(()=>i(y)>=80?"health--good":i(y)>=50?"health--fair":"health--poor"),m=qo(fi),g=V(()=>di(e.task,{settings:m}));let _=K(!1),E=K(-1),D=[],x=K(!1),R=K(null),U=K(null),N=K(!1);const W=V(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}…`:e.task.linkedBlockId:""),Y=V(()=>()=>{if(!i(R))return"";const ee=i(R).replace(/\s+/g," ").trim();return ee.length>220?`${ee.slice(0,220)}…`:ee}),J=V(()=>()=>Ki.filter(ee=>[15,60,120].includes(ee.minutes))),re=V(()=>()=>`snooze-menu-${e.task.id}`);yt(()=>{b(R,e.task.linkedBlockContent??null,!0),b(U,null),b(N,!1)});function te(){e.onDone(e.task)}function le(){e.onDelay(e.task)}function ye(){e.onEdit&&e.onEdit(e.task)}function H(){e.onSkip(e.task)}async function L(){b(_,!i(_)),i(_)&&(await vl(),b(E,-1),D=[])}function C(ee){const ge=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ee}});window.dispatchEvent(ge),b(_,!1),b(E,-1)}function z(ee){var Be,ce,Se,Ue;const ge=i(J);ee.key==="ArrowDown"?(ee.preventDefault(),b(E,Math.min(i(E)+1,ge.length-1),!0),(Be=D[i(E)])==null||Be.focus()):ee.key==="ArrowUp"?(ee.preventDefault(),b(E,Math.max(i(E)-1,0),!0),(ce=D[i(E)])==null||ce.focus()):ee.key==="Escape"?(b(_,!1),b(E,-1)):ee.key==="Home"?(ee.preventDefault(),b(E,0),(Se=D[0])==null||Se.focus()):ee.key==="End"&&(ee.preventDefault(),b(E,ge.length-1),(Ue=D[i(E)])==null||Ue.focus())}function se(ee){if(ee.key==="Escape"&&i(_)){b(_,!1);return}(ee.key==="Enter"||ee.key===" ")&&(ee.preventDefault(),L())}async function X(){if(b(x,!0),!e.task.linkedBlockId||i(N)||i(U))return;b(N,!0);const[ee,ge]=await Promise.all([td(e.task.linkedBlockId),ed(e.task.linkedBlockId)]);b(U,ee,!0),b(R,ge,!0),b(N,!1)}function me(){b(x,!1)}const ve=V(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,ge=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[ge]||ge)}`);var he=bd();he.__keydown=ee=>{ee.key==="Escape"&&i(_)&&b(_,!1)};var Te=d(he),_e=d(Te),qe=d(_e),fe=f(qe,2),F=d(fe),T=f(fe,2);{var q=ee=>{var ge=cd(),Be=d(ge);j(ce=>{Ee(ge,"title",`${e.task.currentStreak??""} day streak`),P(Be,`${ce??""} ${e.task.currentStreak??""}`)},[()=>i(v)()]),S(ee,ge)};G(T,ee=>{i(p)&&ee(q)})}var Z=f(_e,2);{var ne=ee=>{var ge=ud();ge.__click=ye,S(ee,ge)};G(Z,ee=>{e.onEdit&&ee(ne)})}var I=f(Te,2),M=d(I),ie=f(d(M),2),Ae=d(ie),Ie=f(ie,2);{var Ce=ee=>{var ge=dd(),Be=d(ge);j(ce=>P(Be,ce),[()=>i(h)()]),S(ee,ge)};G(Ie,ee=>{e.timezoneHandler&&ee(Ce)})}var Ye=f(M,2),Pe=f(d(Ye),2),lt=d(Pe),bt=f(Ye,2);{var $e=ee=>{var ge=hd(),Be=f(d(ge),2),ce=d(Be);j(Se=>P(ce,Se),[()=>Oa(new Date(e.task.lastCompletedAt))]),S(ee,ge)};G(bt,ee=>{e.task.lastCompletedAt&&ee($e)})}var Et=f(bt,2);{var vt=ee=>{var ge=pd(),Be=d(ge),ce=d(Be),Se=f(Be,2);{var Ue=Ze=>{var ct=vd(),ut=d(ct);{var Nt=xt=>{var os=na("Loading preview…");S(xt,os)},Vt=xt=>{var os=rt(),jt=Ge(os);{var ls=Yt=>{var B=fd(),ue=d(B);gu(ue,()=>i(U)),S(Yt,B)},zs=Yt=>{var B=rt(),ue=Ge(B);{var it=Xt=>{var Sr=na();j(()=>P(Sr,i(Y))),S(Xt,Sr)},Ds=Xt=>{var Sr=na("No preview available.");S(Xt,Sr)};G(ue,Xt=>{i(R)?Xt(it):Xt(Ds,!1)},!0)}S(Yt,B)};G(jt,Yt=>{i(U)?Yt(ls):Yt(zs,!1)},!0)}S(xt,os)};G(ut,xt=>{i(N)?xt(Nt):xt(Vt,!1)})}S(Ze,ct)};G(Se,Ze=>{i(x)&&Ze(Ue)})}j(()=>{Ee(Be,"title",`Linked block: ${e.task.linkedBlockId}`),P(ce,`📝 Block ${i(W)??""}`)}),St("mouseenter",Be,X),St("mouseleave",Be,me),St("focus",Be,X),St("blur",Be,me),S(ee,ge)};G(Et,ee=>{e.task.linkedBlockId&&ee(vt)})}var Oe=f(I,2),_t=d(Oe),He=f(Oe,2),Ve=d(He),Xe=d(Ve);Xe.__click=L,Xe.__keydown=se;var Ot=f(Xe,2),Mt=d(Ot);Fe(Mt,17,()=>i(J),nt,(ee,ge)=>{var Be=yd();Be.__click=()=>C(i(ge).minutes);var ce=d(Be);j(()=>{Ee(Be,"aria-label",`Snooze for ${i(ge).label}`),P(ce,i(ge).label)}),S(ee,Be)});var zt=f(Mt,2);zt.__click=le;var ae=f(Ot,2);{var oe=ee=>{var ge=gd();ge.__keydown=z,Fe(ge,21,()=>Ki,nt,(Be,ce,Se)=>{var Ue=md();Ue.__click=()=>C(i(ce).minutes),Ee(Ue,"tabindex",Se===0?0:-1);var Ze=d(Ue);fs(Ue,(ct,ut)=>D[ut]=ct,ct=>D==null?void 0:D[ct],()=>[Se]),j(()=>P(Ze,i(ce).label)),S(Be,Ue)}),j(()=>Ee(ge,"id",i(re))),S(ee,ge)};G(ae,ee=>{i(_)&&ee(oe)})}var we=f(Ve,2);we.__click=le;var tt=f(we,2);tt.__click=H;var ps=f(tt,2);ps.__click=te,j((ee,ge)=>{Ke(he,1,`task-card ${i(o)??""}`,"svelte-yjw1ud"),br(he,`--overdue-tint: ${i(l)??""}; --overdue-border: ${i(c)??""};`),Ee(he,"aria-label",ee),Ee(he,"data-task-id",e.task.id),br(qe,`background-color: ${i(u)??""}`),Ee(qe,"title",`Priority:  ${(e.task.priority||"normal")??""}`),P(F,e.task.name),P(Ae,ge),Ee(Ye,"title",`Urgency score: ${i(g)??""}`),P(lt,i(g)),Ke(Oe,1,`task-card__health ${i(w)??""}`,"svelte-yjw1ud"),Ee(Oe,"title",`Task health:  ${i(y)??""}%`),br(_t,`width: ${i(y)??""}%`),Ee(Xe,"aria-expanded",i(_)),Ee(Xe,"aria-controls",i(re))},[()=>i(ve)(),()=>Oa(i(t))]),S(r,he),et()}ht(["keydown","click"]);var _d=A(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">🎉 No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),kd=A('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),wd=A('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function Td(r,e){Je(e,!0);const t=V(()=>[...e.tasks].sort((m,g)=>new Date(m.dueAt).getTime()-new Date(g.dueAt).getTime()));let s=K(0),n=ke([]);yt(()=>{i(s)>=i(t).length&&b(s,Math.max(0,i(t).length-1),!0)});function a(m){var _;if(i(t).length===0)return;const g=Math.max(0,Math.min(m,i(t).length-1));b(s,g,!0),(_=n[g])==null||_.focus()}function o(m,g){m.key==="ArrowDown"?(m.preventDefault(),a(g+1)):m.key==="ArrowUp"?(m.preventDefault(),a(g-1)):m.key==="Home"?(m.preventDefault(),a(0)):m.key==="End"&&(m.preventDefault(),a(i(t).length-1))}var l=wd(),c=d(l),u=f(d(c),2),h=d(u),p=f(c,2),v=d(p);{var y=m=>{var g=_d();S(m,g)},w=m=>{var g=rt(),_=Ge(g);Fe(_,19,()=>i(t),E=>E.id,(E,D,x)=>{var R=kd();R.__keydown=N=>o(N,i(x));var U=d(R);Jr(U,{get task(){return i(D)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),fs(R,(N,W)=>n[W]=N,N=>n==null?void 0:n[N],()=>[i(x)]),j(()=>Ee(R,"tabindex",i(x)===i(s)?0:-1)),St("focus",R,()=>b(s,i(x),!0)),S(E,R)}),S(m,g)};G(v,m=>{i(t).length===0?m(y):m(w,!1)})}j(()=>P(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),S(r,l),et()}ht(["keydown"]);var Sd=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Dd=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),Ed=A('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">✏️</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">📄</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">🗑️</button></div></td></tr>'),xd=A('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ad=A('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),Cd=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Id=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Od=A('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">🔍</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Md(r,e){Je(e,!0);let t=K(null),s=K(!1),n=K(""),a=K(""),o=K(ke(new Set)),l=K(0),c=ke([]),u=K(null);const h=V(()=>[...e.tasks].sort((I,M)=>new Date(I.dueAt).getTime()-new Date(M.dueAt).getTime())),p=V(()=>()=>{const I=i(a).trim().toLowerCase();return I?i(h).filter(M=>{var Ae;return[M.name,M.description,M.category,M.linkedBlockContent,(Ae=M.tags)==null?void 0:Ae.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(I)}):i(h)}),v=V(()=>i(p).map(I=>I.id)),y=V(()=>i(o).size>0),w=V(()=>i(p).length>0&&i(p).every(I=>i(o).has(I.id))),m=V(()=>i(p).some(I=>i(o).has(I.id))&&!i(w));yt(()=>{const I=new Set([...i(o)].filter(M=>e.tasks.some(ie=>ie.id===M)));I.size!==i(o).size&&b(o,I,!0)}),yt(()=>{i(u)&&(i(u).indeterminate=i(m))}),yt(()=>{i(l)>=i(p).length&&b(l,Math.max(0,i(p).length-1),!0)}),yt(()=>{const I=window.setTimeout(()=>{b(a,i(n),!0)},300);return()=>{window.clearTimeout(I)}});function g(I){b(t,I,!0)}function _(){i(t)&&(e.onDelete(i(t)),b(t,null))}function E(){b(t,null)}function D(I){const M=new Set(i(o));M.has(I)?M.delete(I):M.add(I),b(o,M,!0)}function x(){const I=new Set(i(o));i(w)?i(v).forEach(M=>I.delete(M)):i(v).forEach(M=>I.add(M)),b(o,I,!0)}function R(I){var ie;if(i(p).length===0)return;const M=Math.max(0,Math.min(I,i(p).length-1));b(l,M,!0),(ie=c[M])==null||ie.focus()}function U(I,M){I.key==="ArrowDown"?(I.preventDefault(),R(M+1)):I.key==="ArrowUp"?(I.preventDefault(),R(M-1)):I.key==="Home"?(I.preventDefault(),R(0)):I.key==="End"&&(I.preventDefault(),R(i(p).length-1))}function N(){if(i(o).size===0){b(s,!1);return}e.onBulkDelete([...i(o)]),b(o,new Set,!0),b(s,!1)}function W(){b(s,!1)}function Y(I){const{type:M,interval:ie}=I.frequency,Ae=M==="daily"?"day":M==="weekly"?"week":M==="monthly"?"month":"year",Ie=ie===1?`Every ${Ae}`:`Every ${ie} ${Ae}s`;if(M==="weekly")return`${Ie} on ${I.frequency.weekdays.map(Ce=>Uu[Ce]??Ce).join(", ")}`;if(M==="monthly")return`${Ie} on day ${I.frequency.dayOfMonth}`;if(M==="yearly"){const Ce=J[I.frequency.month]??`Month ${I.frequency.month+1}`;return`${Ie} on ${Ce} ${I.frequency.dayOfMonth}`}return Ie}const J=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var re=Od(),te=Ge(re),le=d(te),ye=f(d(le),2),H=d(ye),L=f(d(H),2),C=f(H,2);C.__click=function(...I){var M;(M=e.onCreate)==null||M.apply(this,I)};var z=f(le,2),se=d(z),X=d(se),me=d(X),ve=f(X,2),he=d(ve);he.__click=()=>e.onBulkEnable([...i(o)]);var Te=f(he,2);Te.__click=()=>e.onBulkDisable([...i(o)]);var _e=f(Te,2);_e.__click=()=>b(s,!0);var qe=f(se,2);{var fe=I=>{var M=Sd();S(I,M)},F=I=>{var M=Ad(),ie=d(M);{var Ae=Ce=>{var Ye=Dd(),Pe=d(Ye),lt=d(Pe);j(bt=>P(lt,`No tasks match "${bt??""}".`),[()=>i(a).trim()]),S(Ce,Ye)},Ie=Ce=>{var Ye=xd(),Pe=d(Ye),lt=d(Pe),bt=d(lt),$e=d(bt);$e.__click=x,fs($e,vt=>b(u,vt),()=>i(u));var Et=f(Pe);Fe(Et,23,()=>i(p),vt=>vt.id,(vt,Oe,_t)=>{var He=Ed();He.__keydown=Ze=>U(Ze,i(_t));var Ve=d(He),Xe=d(Ve);Xe.__click=()=>D(i(Oe).id);var Ot=f(Ve),Mt=d(Ot),zt=f(Ot),ae=d(zt),oe=f(zt),we=d(oe),tt=f(oe),ps=d(tt),ee=d(ps);ee.__change=()=>e.onToggleEnabled(i(Oe));var ge=f(tt),Be=d(ge),ce=d(Be);ce.__click=()=>e.onEdit(i(Oe));var Se=f(ce,2);Se.__click=()=>e.onDuplicate(i(Oe));var Ue=f(Se,2);Ue.__click=()=>g(i(Oe)),fs(He,(Ze,ct)=>c[ct]=Ze,Ze=>c==null?void 0:c[Ze],()=>[i(_t)]),j((Ze,ct,ut,Nt)=>{Ke(He,1,ku(i(Oe).enabled?"":"disabled"),"svelte-i091qn"),Ee(He,"tabindex",i(_t)===i(l)?0:-1),Ee(He,"aria-selected",Ze),Ee(Xe,"aria-label",`Select ${i(Oe).name}`),Fr(Xe,ct),P(Mt,i(Oe).name),P(ae,ut),P(we,Nt),Fr(ee,i(Oe).enabled)},[()=>i(o).has(i(Oe).id),()=>i(o).has(i(Oe).id),()=>Oa(new Date(i(Oe).dueAt)),()=>Y(i(Oe))]),St("focus",He,()=>b(l,i(_t),!0)),S(vt,He)}),j(()=>{Fr($e,i(w)),$e.disabled=i(p).length===0}),S(Ce,Ye)};G(ie,Ce=>{i(p).length===0?Ce(Ae):Ce(Ie,!1)})}S(I,M)};G(qe,I=>{i(h).length===0?I(fe):I(F,!1)})}var T=f(te,2);{var q=I=>{var M=Cd(),ie=d(M),Ae=f(d(ie),2),Ie=d(Ae),Ce=f(Ae,2),Ye=d(Ce);Ye.__click=E;var Pe=f(Ye,2);Pe.__click=_,j(()=>P(Ie,`Are you sure you want to delete "${i(t).name??""}"? This action cannot be undone.`)),S(I,M)};G(T,I=>{i(t)&&I(q)})}var Z=f(T,2);{var ne=I=>{var M=Id(),ie=d(M),Ae=f(d(ie),2),Ie=d(Ae),Ce=f(Ae,2),Ye=d(Ce);Ye.__click=W;var Pe=f(Ye,2);Pe.__click=N,j(()=>P(Ie,`Are you sure you want to delete ${i(o).size??""} task${i(o).size===1?"":"s"}? This action cannot be undone.`)),S(I,M)};G(Z,I=>{i(s)&&I(ne)})}j(()=>{L.disabled=i(h).length===0,P(me,`${i(o).size??""} selected`),he.disabled=!i(y),Te.disabled=!i(y),_e.disabled=!i(y)}),at(L,()=>i(n),I=>b(n,I)),S(r,re),et()}ht(["click","keydown","change"]);var Nd=A('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),qd=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Rd=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Ld=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Fd=A('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Pd=A('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Bd=A('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Ud=A('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function zd(r,e){Je(e,!0);let t=Rs(e,"days",3,30);function s(_){const{frequency:E}=_;if(E.type==="weekly"){const D=[...E.weekdays].sort((x,R)=>x-R).join(",");return`weekly:${E.interval}:${E.time??""}:${D}`}return E.type==="monthly"?`monthly:${E.interval}:${E.time??""}:${E.dayOfMonth}`:E.type==="yearly"?`yearly:${E.interval}:${E.time??""}:${E.month}:${E.dayOfMonth}`:`daily:${E.interval}:${E.time??""}`}function n(_,E){const D=_.map(x=>`${x.id}:${x.enabled}:${x.dueAt}:${s(x)}`).join("|");return`${E}:${D}`}function a(_,E){const D=Ma(new Date),x=id(vn(D,E-1)),R=24*60*60*1e3,N=ld(D,E).map(W=>({date:W,tasks:[]}));for(const W of _.filter(Y=>Y.enabled)){const Y=new Date(W.dueAt),J=e.recurrenceEngine.getOccurrencesInRange(D,x,W.frequency,Y);for(const re of J){const te=Ma(re),le=Math.floor((te.getTime()-D.getTime())/R);le>=0&&le<E&&N[le].tasks.push({task:W,occurrence:re})}}for(const W of N)W.tasks.sort((Y,J)=>Y.occurrence.getTime()-J.occurrence.getTime());return N}const o=(()=>{let _="",E=[];return{get(D,x){const R=n(D,x);return R===_||(_=R,E=a(D,x)),E}}})(),l=V(()=>o.get(e.tasks,t())),c=V(()=>i(l).some(_=>_.tasks.length>0));var u=Ud(),h=d(u),p=f(d(h),2),v=d(p),y=f(h,2),w=d(y);{var m=_=>{var E=Nd(),D=d(E),x=d(D);j(()=>P(x,`No tasks scheduled in the next ${t()??""} days.`)),S(_,E)},g=_=>{var E=Bd();Fe(E,21,()=>i(l),D=>D.date.toISOString(),(D,x)=>{var R=rt(),U=Ge(R);{var N=W=>{var Y=Pd(),J=d(Y),re=d(J),te=d(re),le=f(re,2),ye=d(le),H=f(J,2);Fe(H,21,()=>i(x).tasks,({task:L,occurrence:C})=>L.id+C.toISOString(),(L,C)=>{let z=()=>i(C).task,se=()=>i(C).occurrence;var X=Fd(),me=d(X),ve=d(me),he=f(me,2),Te=d(he),_e=d(Te),qe=f(Te,2),fe=d(qe);{var F=I=>{var M=qd(),ie=d(M);j(()=>P(ie,`🔗 ${z().linkedBlockId??""}`)),S(I,M)};G(fe,I=>{z().linkedBlockId&&I(F)})}var T=f(fe,2);{var q=I=>{var M=Rd(),ie=d(M);j(()=>P(ie,`⚡ ${z().priority??""}`)),S(I,M)};G(T,I=>{z().priority&&I(q)})}var Z=f(T,2);{var ne=I=>{var M=Ld(),ie=d(M);j(Ae=>P(ie,`🏷️ ${Ae??""}`),[()=>z().tags.join(", ")]),S(I,M)};G(Z,I=>{var M;(M=z().tags)!=null&&M.length&&I(ne)})}j(I=>{P(ve,I),P(_e,z().name)},[()=>sd(se())]),S(L,X)}),j((L,C)=>{P(te,L),P(ye,C)},[()=>rd(i(x).date),()=>i(x).date.toLocaleDateString(void 0,{weekday:"short"})]),S(W,Y)};G(U,W=>{i(x).tasks.length>0&&W(N)})}S(D,R)}),S(_,E)};G(w,_=>{i(c)?_(g,!1):_(m)})}j(()=>P(v,`Next ${t()??""} days`)),S(r,u),et()}var jd=A('<span class="leaderboard-item__badge svelte-1ptoc1q">🏆 Best</span>'),Yd=A('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Hd=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">🔥 Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Kd=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Wd=A('<h4 class="subsection-title svelte-1ptoc1q">✅ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Gd=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Qd=A('<h4 class="subsection-title svelte-1ptoc1q">⚠️ Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),$d=A('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">✅</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),Vd=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),Xd=A('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function Zd(r,e){Je(e,!0);const t=V(()=>()=>{let L=0,C=0;for(const X of e.tasks)L+=X.completionCount||0,C+=X.missCount||0;const z=L+C,se=z>0?L/z*100:100;return{totalCompletions:L,totalMisses:C,completionRate:Math.round(se)}}),s=V(()=>()=>[...e.tasks].filter(L=>(L.currentStreak||0)>0).sort((L,C)=>(C.currentStreak||0)-(L.currentStreak||0)).slice(0,10)),n=V(()=>()=>[...e.tasks].map(L=>({task:L,health:xl(L)})).sort((L,C)=>L.health-C.health)),a=V(()=>()=>i(n)().slice(-5).reverse()),o=V(()=>()=>i(n)().slice(0,5)),l=V(()=>()=>{const L=[];for(const C of e.tasks)if(C.recentCompletions&&C.recentCompletions.length>0)for(const z of C.recentCompletions)L.push({task:C,completedAt:z});return L.sort((C,z)=>new Date(z.completedAt).getTime()-new Date(C.completedAt).getTime()).slice(0,10)});function c(L){return new Date(L).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(L){return L>=80?"#10b981":L>=60?"#3b82f6":L>=40?"#f59e0b":"#ef4444"}var h=Xd(),p=f(d(h),2),v=d(p),y=f(d(v),2),w=d(y),m=d(w),g=d(m),_=f(w,2),E=d(_),D=d(E),x=f(_,2),R=d(x),U=d(R),N=f(v,2);{var W=L=>{var C=Hd(),z=f(d(C),2);Fe(z,21,()=>i(s)(),nt,(se,X,me)=>{var ve=Yd(),he=d(ve);he.textContent=`#${me+1}`;var Te=f(he,2),_e=d(Te),qe=f(Te,2),fe=d(qe),F=f(fe);{var T=q=>{var Z=jd();S(q,Z)};G(F,q=>{i(X).bestStreak&&i(X).currentStreak===i(X).bestStreak&&q(T)})}j(()=>{P(_e,i(X).name),P(fe,`${i(X).currentStreak??""} day${i(X).currentStreak!==1?"s":""} `)}),S(se,ve)}),S(L,C)};G(N,L=>{i(s)().length>0&&L(W)})}var Y=f(N,2),J=f(d(Y),2);{var re=L=>{var C=Wd(),z=f(Ge(C),2);Fe(z,21,()=>i(a)(),nt,(se,X)=>{let me=()=>i(X).task,ve=()=>i(X).health;var he=Kd(),Te=d(he),_e=d(Te),qe=f(Te,2),fe=d(qe),F=f(fe,2),T=d(F);j(q=>{P(_e,me().name),br(fe,`width: ${ve()??""}%; background-color: ${q??""}`),P(T,`${ve()??""}/100`)},[()=>u(ve())]),S(se,he)}),S(L,C)};G(J,L=>{i(a)().length>0&&L(re)})}var te=f(J,2);{var le=L=>{var C=Qd(),z=f(Ge(C),2);Fe(z,21,()=>i(o)(),nt,(se,X)=>{let me=()=>i(X).task,ve=()=>i(X).health;var he=Gd(),Te=d(he),_e=d(Te),qe=f(Te,2),fe=d(qe),F=f(fe,2),T=d(F);j(q=>{P(_e,me().name),br(fe,`width: ${ve()??""}%; background-color: ${q??""}`),P(T,`${ve()??""}/100`)},[()=>u(ve())]),S(se,he)}),S(L,C)};G(te,L=>{i(o)().length>0&&i(o)()[0].health<80&&L(le)})}var ye=f(Y,2);{var H=L=>{var C=Vd(),z=f(d(C),2);Fe(z,21,()=>i(l)(),nt,(se,X)=>{let me=()=>i(X).task,ve=()=>i(X).completedAt;var he=$d(),Te=f(d(he),2),_e=d(Te),qe=d(_e),fe=f(_e,2),F=d(fe);j(T=>{P(qe,me().name),P(F,T)},[()=>c(ve())]),S(se,he)}),S(L,C)};G(ye,L=>{i(l)().length>0&&L(H)})}j((L,C,z)=>{P(g,L),P(D,C),P(U,`${z??""}%`)},[()=>i(t)().totalCompletions,()=>i(t)().totalMisses,()=>i(t)().completionRate]),S(r,h),et()}var Jd=A('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">📥 No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),eh=A('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),th=A('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function sh(r,e){Je(e,!0);const t=V(()=>e.tasks.filter(m=>m.status!=="done"&&m.status!=="cancelled"&&!m.dueAt&&!m.scheduledAt&&!m.startAt).sort((m,g)=>new Date(g.createdAt).getTime()-new Date(m.createdAt).getTime()));let s=K(0),n=ke([]);yt(()=>{i(s)>=i(t).length&&b(s,Math.max(0,i(t).length-1),!0)});function a(m){var _;if(i(t).length===0)return;const g=Math.max(0,Math.min(m,i(t).length-1));b(s,g,!0),(_=n[g])==null||_.focus()}function o(m,g){m.key==="ArrowDown"?(m.preventDefault(),a(g+1)):m.key==="ArrowUp"?(m.preventDefault(),a(g-1)):m.key==="Enter"&&e.onEdit?(m.preventDefault(),e.onEdit(i(t)[g])):m.key===" "&&e.onDone&&(m.preventDefault(),e.onDone(i(t)[g]))}var l=th(),c=d(l),u=f(d(c),2),h=d(u),p=f(c,2),v=d(p);{var y=m=>{var g=Jd();S(m,g)},w=m=>{var g=rt(),_=Ge(g);Fe(_,19,()=>i(t),E=>E.id,(E,D,x)=>{var R=eh();R.__keydown=N=>o(N,i(x));var U=d(R);Jr(U,{get task(){return i(D)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fs(R,(N,W)=>n[W]=N,N=>n==null?void 0:n[N],()=>[i(x)]),j(()=>Ee(R,"tabindex",i(x)===i(s)?0:-1)),St("focus",R,()=>b(s,i(x),!0)),S(E,R)}),S(m,g)};G(v,m=>{i(t).length===0?m(y):m(w,!1)})}j(()=>P(h,`${i(t).length??""} task${i(t).length!==1?"s":""} without dates`)),S(r,l),et()}ht(["keydown"]);var rh=A('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),nh=A('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),ah=A('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),ih=A('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function oh(r,e){Je(e,!0);let t=Rs(e,"daysAhead",3,7);const s=new Date;s.setHours(0,0,0,0);const n=new Date(s);n.setDate(n.getDate()+t());const a=V(()=>e.tasks.filter(D=>{if(D.status==="done"||D.status==="cancelled"||!D.dueAt)return!1;const x=new Date(D.dueAt);return x.setHours(0,0,0,0),x>s&&x<=n}).sort((D,x)=>new Date(D.dueAt).getTime()-new Date(x.dueAt).getTime())),o=V(()=>()=>{const D=new Map;return i(a).forEach(x=>{const R=new Date(x.dueAt);R.setHours(0,0,0,0);const U=R.toISOString().split("T")[0];D.has(U)||D.set(U,[]),D.get(U).push(x)}),D});function l(D){const x=new Date(D),R=Math.floor((x.getTime()-s.getTime())/(1e3*60*60*24)),U=x.toLocaleDateString("en-US",{weekday:"long"}),N=x.toLocaleDateString("en-US",{month:"short",day:"numeric"});return R===1?`Tomorrow - ${U}, ${N}`:`${U}, ${N} (in ${R} days)`}let c=K(0),u=ke([]);yt(()=>{i(c)>=i(a).length&&b(c,Math.max(0,i(a).length-1),!0)});function h(D,x){D.key==="ArrowDown"?(D.preventDefault(),b(c,Math.min(i(c)+1,i(a).length-1),!0)):D.key==="ArrowUp"?(D.preventDefault(),b(c,Math.max(i(c)-1,0),!0)):D.key==="Enter"&&e.onEdit?(D.preventDefault(),e.onEdit(i(a)[x])):D.key===" "&&e.onDone&&(D.preventDefault(),e.onDone(i(a)[x]))}var p=ih(),v=d(p),y=f(d(v),2),w=d(y),m=f(v,2),g=d(m);{var _=D=>{var x=rh(),R=d(x),U=d(R);j(()=>P(U,`📅 No tasks scheduled for the next ${t()??""} days`)),S(D,x)},E=D=>{var x=rt(),R=Ge(x);Fe(R,17,()=>[...i(o).entries()],nt,(U,N)=>{var W=V(()=>xo(i(N),2));let Y=()=>i(W)[0],J=()=>i(W)[1];var re=ah(),te=d(re),le=d(te),ye=f(te,2);Fe(ye,19,J,H=>H.id,(H,L)=>{const C=V(()=>i(a).indexOf(i(L)));var z=nh();z.__keydown=X=>h(X,i(C));var se=d(z);Jr(se,{get task(){return i(L)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fs(z,(X,me)=>u[me]=X,X=>u==null?void 0:u[X],()=>[i(C)]),j(()=>Ee(z,"tabindex",i(C)===i(c)?0:-1)),St("focus",z,()=>b(c,i(C),!0)),S(H,z)}),j(H=>P(le,H),[()=>l(Y())]),S(U,re)}),S(D,x)};G(g,D=>{i(a).length===0?D(_):D(E,!1)})}j(()=>P(w,`${i(a).length??""} task${i(a).length!==1?"s":""} in the next ${t()??""} days`)),S(r,p),et()}ht(["keydown"]);var lh=A('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">✅ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),ch=A('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),uh=A('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),dh=A('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">← Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next →</button></div>'),hh=A("<!> <!>",1),fh=A('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function vh(r,e){Je(e,!0);let t=Rs(e,"daysBack",3,30),s=K(0);const n=50,a=new Date;a.setDate(a.getDate()-t()),a.setHours(0,0,0,0);const o=V(()=>e.tasks.filter(N=>N.status!=="done"||!N.doneAt?!1:new Date(N.doneAt)>=a).sort((N,W)=>new Date(W.doneAt).getTime()-new Date(N.doneAt).getTime())),l=V(()=>Math.ceil(i(o).length/n)),c=V(()=>i(o).slice(i(s)*n,(i(s)+1)*n));yt(()=>{i(s)>=i(l)&&i(l)>0&&b(s,i(l)-1)});function u(){i(s)<i(l)-1&&Ei(s)}function h(){i(s)>0&&Ei(s,-1)}function p(N){const W=new Date(N),Y=new Date,J=Y.getTime()-W.getTime(),re=Math.floor(J/(1e3*60*60*24));return re===0?"Today":re===1?"Yesterday":re<7?`${re} days ago`:W.toLocaleDateString("en-US",{month:"short",day:"numeric",year:W.getFullYear()!==Y.getFullYear()?"numeric":void 0})}let v=K(0),y=ke([]);yt(()=>{i(v)>=i(c).length&&b(v,Math.max(0,i(c).length-1),!0)});function w(N,W){N.key==="ArrowDown"?(N.preventDefault(),b(v,Math.min(i(v)+1,i(c).length-1),!0)):N.key==="ArrowUp"?(N.preventDefault(),b(v,Math.max(i(v)-1,0),!0)):N.key==="Enter"&&e.onEdit&&(N.preventDefault(),e.onEdit(i(c)[W]))}var m=fh(),g=d(m),_=f(d(g),2),E=d(_),D=f(g,2),x=d(D);{var R=N=>{var W=lh();S(N,W)},U=N=>{var W=hh(),Y=Ge(W);Fe(Y,19,()=>i(c),te=>te.id,(te,le,ye)=>{var H=uh();H.__keydown=ve=>w(ve,i(ye));var L=d(H),C=d(L),z=d(C),se=f(C,2);{var X=ve=>{var he=ch();he.__click=()=>e.onUncomplete(i(le)),S(ve,he)};G(se,ve=>{e.onUncomplete&&ve(X)})}var me=f(L,2);Jr(me,{get task(){return i(le)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),fs(H,(ve,he)=>y[he]=ve,ve=>y==null?void 0:y[ve],()=>[i(ye)]),j(ve=>{Ee(H,"tabindex",i(ye)===i(v)?0:-1),P(z,`Completed ${ve??""}`)},[()=>p(i(le).doneAt)]),St("focus",H,()=>b(v,i(ye),!0)),S(te,H)});var J=f(Y,2);{var re=te=>{var le=dh(),ye=d(le);ye.__click=h;var H=f(ye,2),L=d(H),C=f(H,2);C.__click=u,j(()=>{ye.disabled=i(s)===0,P(L,`Page ${i(s)+1} of ${i(l)??""}`),C.disabled=i(s)>=i(l)-1}),S(te,le)};G(J,te=>{i(l)>1&&te(re)})}S(N,W)};G(x,N=>{i(o).length===0?N(R):N(U,!1)})}j(()=>P(E,`${i(o).length??""} completed task${i(o).length!==1?"s":""} in the last ${t()??""} days`)),S(r,m),et()}ht(["keydown","click"]);var ph=A('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">📁 No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),yh=A('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),mh=A('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),gh=A('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),bh=A('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function _h(r,e){Je(e,!0);const t=V(()=>()=>{const Y=new Map;return e.tasks.filter(re=>re.status!=="done"&&re.status!=="cancelled").forEach(re=>{const te=re.linkedBlockPath||"Uncategorized";Y.has(te)||Y.set(te,[]),Y.get(te).push(re)}),Y.forEach(re=>{re.sort((te,le)=>!te.dueAt&&!le.dueAt?0:te.dueAt?le.dueAt?new Date(te.dueAt).getTime()-new Date(le.dueAt).getTime():-1:1)}),new Map([...Y.entries()].sort(([re],[te])=>re.localeCompare(te)))}),s=V(()=>[...i(t).values()].reduce((Y,J)=>Y+J.length,0));let n=K(ke(new Set([...i(t).keys()])));function a(Y){const J=new Set(i(n));J.has(Y)?J.delete(Y):J.add(Y),b(n,J,!0)}function o(){b(n,new Set([...i(t).keys()]),!0)}function l(){b(n,new Set,!0)}let c=K(0),u=ke([]);const h=V(()=>()=>{const Y=[];return i(t).forEach((J,re)=>{i(n).has(re)&&Y.push(...J)}),Y});yt(()=>{i(c)>=i(h).length&&b(c,Math.max(0,i(h).length-1),!0)});function p(Y,J){Y.key==="ArrowDown"?(Y.preventDefault(),b(c,Math.min(i(c)+1,i(h).length-1),!0)):Y.key==="ArrowUp"?(Y.preventDefault(),b(c,Math.max(i(c)-1,0),!0)):Y.key==="Enter"&&e.onEdit?(Y.preventDefault(),e.onEdit(i(h)[J])):Y.key===" "&&e.onDone&&(Y.preventDefault(),e.onDone(i(h)[J]))}function v(Y){const J=Y.split("/");return J[J.length-1]||Y}var y=bh(),w=d(y),m=d(w),g=f(d(m),2),_=d(g),E=f(m,2),D=d(E);D.__click=o;var x=f(D,2);x.__click=l;var R=f(w,2),U=d(R);{var N=Y=>{var J=ph();S(Y,J)},W=Y=>{var J=rt(),re=Ge(J);Fe(re,17,()=>[...i(t).entries()],nt,(te,le)=>{var ye=V(()=>xo(i(le),2));let H=()=>i(ye)[0],L=()=>i(ye)[1];var C=gh(),z=d(C);z.__click=()=>a(H());var se=d(z),X=d(se),me=f(se,2),ve=d(me),he=f(me,2),Te=d(he),_e=f(z,2);{var qe=fe=>{var F=mh();Fe(F,23,L,T=>T.id,(T,q)=>{const Z=V(()=>i(h).indexOf(i(q)));var ne=yh();ne.__keydown=M=>p(M,i(Z));var I=d(ne);Jr(I,{get task(){return i(q)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fs(ne,(M,ie)=>u[ie]=M,M=>u==null?void 0:u[M],()=>[i(Z)]),j(()=>Ee(ne,"tabindex",i(Z)===i(c)?0:-1)),St("focus",ne,()=>b(c,i(Z),!0)),S(T,ne)}),j(T=>Ee(F,"aria-label",T),[()=>`Tasks for ${v(H())}`]),S(fe,F)};G(_e,fe=>{i(n).has(H())&&fe(qe)})}j((fe,F)=>{P(X,fe),Ee(me,"title",H()),P(ve,F),P(Te,L().length)},[()=>i(n).has(H())?"▼":"▶",()=>v(H())]),S(te,C)}),S(Y,J)};G(U,Y=>{i(t).size===0?Y(N):Y(W,!1)})}j(()=>P(_,`${i(s)??""} task${i(s)!==1?"s":""} in ${i(t).size??""} project${i(t).size!==1?"s":""}`)),S(r,y),et()}ht(["click","keydown"]);class Zt extends Error{constructor(e,t,s,n){super(e),this.line=t,this.column=s,this.suggestion=n,this.name="QuerySyntaxError"}}class Ir extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var st=(r=>(r.TODO="TODO",r.IN_PROGRESS="IN_PROGRESS",r.DONE="DONE",r.CANCELLED="CANCELLED",r.NON_TASK="NON_TASK",r.EMPTY="EMPTY",r))(st||{});const ms=class ms{constructor(e){k(this,"symbol");k(this,"name");k(this,"nextStatusSymbol");k(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};k(ms,"TODO",new ms({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),k(ms,"DONE",new ms({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),k(ms,"IN_PROGRESS",new ms({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),k(ms,"CANCELLED",new ms({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let xs=ms;class kh{static parse(e,t=new Date){const s=e.trim().toLowerCase(),n=e;if(!s)return{date:null,isValid:!1,error:"Empty date string",original:n};if(s.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const y=new Date(s);if(!isNaN(y.getTime()))return{date:y,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),s==="today")return{date:o,isValid:!0,original:n};if(s==="tomorrow"){const y=new Date(o);return y.setDate(y.getDate()+1),{date:y,isValid:!0,original:n}}if(s==="yesterday"){const y=new Date(o);return y.setDate(y.getDate()-1),{date:y,isValid:!0,original:n}}const l=s.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(l){const y=parseInt(l[1]),w=l[2],m=new Date(o);return w.startsWith("day")?m.setDate(m.getDate()+y):w.startsWith("week")?m.setDate(m.getDate()+y*7):w.startsWith("month")&&m.setMonth(m.getMonth()+y),{date:m,isValid:!0,original:n}}const c=s.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(c){const y=parseInt(c[1]),w=c[2],m=new Date(o);return w.startsWith("day")?m.setDate(m.getDate()-y):w.startsWith("week")?m.setDate(m.getDate()-y*7):w.startsWith("month")&&m.setMonth(m.getMonth()-y),{date:m,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=s.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const y=h[1],w=u.indexOf(h[2]),m=o.getDay();let g=w-m;y==="next"?g<=0&&(g+=7):g>=0&&(g-=7);const _=new Date(o);return _.setDate(_.getDate()+g),{date:_,isValid:!0,original:n}}const p=s.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(p){const y=u.indexOf(p[1]),w=o.getDay();let m=y-w;m<0&&(m+=7);const g=new Date(o);return g.setDate(g.getDate()+m),{date:g,isValid:!0,original:n}}const v=s.match(/^(this|next|last)\s+(week|month)$/);if(v){const y=v[1],w=v[2],m=new Date(o);if(w==="week"){const g=m.getDay(),_=g===0?-6:1-g;m.setDate(m.getDate()+_),y==="next"?m.setDate(m.getDate()+7):y==="last"&&m.setDate(m.getDate()-7)}else w==="month"&&(m.setDate(1),y==="next"?m.setMonth(m.getMonth()+1):y==="last"&&m.setMonth(m.getMonth()-1));return{date:m,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class Js{constructor(){k(this,"input","");k(this,"position",0);k(this,"line",1);k(this,"column",1);k(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const s={filters:[]},n=this.input.split(`
`).map(a=>a.trim()).filter(a=>a.length>0);for(let a=0;a<n.length;a++){this.line=a+1,this.column=1;const o=n[a];if(o.startsWith("sort by "))s.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))s.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))s.limit=this.parseLimitInstruction(o);else if(/^explain$/i.test(o))s.explain=!0;else{const l=this.parseFilterInstruction(o);l&&s.filters.push(l)}}return s}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Zt?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(/\s+(and|AND)\s+/i.test(e))return this.parseAndFilter(e);if(/\s+(or|OR)\s+/i.test(e))return this.parseOrFilter(e);if(/^(not|NOT)\s+/i.test(e))return this.parseNotFilter(e);if(e.startsWith("status.type is ")){const s=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(s)}}if(e.startsWith("status.name includes ")){const s=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(s)}}if(e.startsWith("status.symbol is ")){const s=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(s)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("urgency is ")){const s=e.substring(11).trim();return{type:"urgency",operator:"is",value:this.parseNumericValue(s,"urgency")}}if(e.startsWith("urgency above ")){const s=e.substring(14).trim();return{type:"urgency",operator:"above",value:this.parseNumericValue(s,"urgency")}}if(e.startsWith("urgency below ")){const s=e.substring(14).trim();return{type:"urgency",operator:"below",value:this.parseNumericValue(s,"urgency")}}if(e.startsWith("tag includes ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e.startsWith("tag does not include ")){const s=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(s),negate:!0}}if(e.startsWith("tags include ")){const s=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(s)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const s=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(s)}}if(e.startsWith("path does not include ")){const s=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(s),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};if(e.startsWith("description includes ")){const s=e.substring(21).trim();return{type:"description",operator:"includes",value:this.unquote(s)}}if(e.startsWith("description does not include ")){const s=e.substring(29).trim();return{type:"description",operator:"does not include",value:this.unquote(s)}}if(e.startsWith("description regex ")){const s=e.substring(18).trim();return{type:"description",operator:"regex",value:this.unquote(s)}}throw new Zt(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const s of t){if(e===`has ${s} date`)return{type:"date",operator:"has",value:{field:s}};if(e===`no ${s} date`)return{type:"date",operator:"has",value:{field:s},negate:!0};const n=["before","after","on","on or before","on or after"];for(const a of n){const o=`${s} ${a} `;if(e.startsWith(o)){const l=e.substring(o.length).trim(),c=kh.parse(l,this.referenceDate);if(!c.isValid||!c.date)throw new Zt(`Invalid date value: "${l}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:a,value:{field:s,date:c.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Zt(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Zt(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Zt(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return st.TODO;case"IN_PROGRESS":return st.IN_PROGRESS;case"DONE":return st.DONE;case"CANCELLED":return st.CANCELLED;case"NON_TASK":return st.NON_TASK;default:throw new Zt(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}parseNumericValue(e,t){const s=Number(e);if(Number.isNaN(s))throw new Zt(`Invalid ${t} value: "${e}"`,this.line,this.column,`Use a numeric ${t} value (e.g., "${t} above 75")`);return s}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}parseAndFilter(e){const s=e.split(/\s+(and|AND)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(s.length===0)throw new Zt("Empty AND expression",this.line,this.column,"AND must have filters on both sides");if(s.length===1)return s[0];let n=s[0];for(let a=1;a<s.length;a++)n={type:"boolean",operator:"AND",value:null,left:n,right:s[a]};return n}parseOrFilter(e){const s=e.split(/\s+(or|OR)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(s.length===0)throw new Zt("Empty OR expression",this.line,this.column,"OR must have filters on both sides");if(s.length===1)return s[0];let n=s[0];for(let a=1;a<s.length;a++)n={type:"boolean",operator:"OR",value:null,left:n,right:s[a]};return n}parseNotFilter(e){const t=e.replace(/^NOT\s+/i,"").trim();if(!t)throw new Zt("Empty NOT expression",this.line,this.column,"NOT must have a filter after it");const s=this.parseFilterInstruction(t);if(!s)throw new Zt("Invalid filter after NOT",this.line,this.column,"NOT must be followed by a valid filter");return{type:"boolean",operator:"NOT",value:null,inner:s}}}class ft{}const nr=class nr{constructor(){k(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return nr.instance||(nr.instance=new nr),nr.instance}addDefaultStatuses(){this.add(xs.TODO),this.add(xs.IN_PROGRESS),this.add(xs.DONE),this.add(xs.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new xs({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:xs.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};k(nr,"instance",null);let vs=nr;class wh extends ft{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=vs.getInstance(),s=e.statusSymbol||" ",a=t.get(s).type===this.statusType;return this.negate?!a:a}}class Th extends ft{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=vs.getInstance(),s=e.statusSymbol||" ",a=t.get(s).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!a:a}}class Sh extends ft{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const s=(e.statusSymbol||" ")===this.symbol;return this.negate?!s:s}}class Dh extends ft{matches(e){const t=vs.getInstance(),s=e.statusSymbol||" ";return t.get(s).type===st.DONE}}class Eh extends ft{matches(e){const t=vs.getInstance(),s=e.statusSymbol||" ";return t.get(s).type!==st.DONE}}class xh extends ft{constructor(e,t,s){super(),this.field=e,this.comparator=t,this.targetDate=s}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const s=new Date(this.targetDate);s.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<s;case"after":return n>s;case"on":return n.getTime()===s.getTime();case"on or before":return n<=s;case"on or after":return n>=s;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class Ah extends ft{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const to={lowest:0,low:1,normal:2,medium:3,high:4,highest:5};function Ch(r){return Qr(r)??"normal"}function Ih(r){return r==="urgent"?"highest":r==="none"?"normal":r}class Oh extends ft{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=Ch(e.priority),s=to[t],n=to[Ih(this.level)];switch(this.operator){case"is":return s===n;case"above":return s>n;case"below":return s<n;default:return!1}}}class Mh extends ft{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],s=this.tag.toLowerCase(),n=t.some(a=>a.toLowerCase().includes(s));return this.negate?!n:n}}class Nh extends ft{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class qh extends ft{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const s=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!s:s}}class Rh extends ft{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const s=e.blockedBy&&e.blockedBy.length>0;return this.negate?!s:!!s}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Lh extends ft{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Fh extends ft{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class Ph extends ft{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Bh extends ft{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class Uh extends ft{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class zh extends ft{constructor(e,t,s=!1){super(),this.operator=e,this.pattern=t,this.caseSensitive=s}matches(e){const t=e.name||"",s=e.description||"",n=`${t} ${s}`.trim();switch(this.operator){case"includes":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"does not include":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return!(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"regex":try{const a=this.caseSensitive?"":"i";return new RegExp(this.pattern,a).test(n)}catch{return!1}}}}class jh extends ft{constructor(e,t,s,n){super(),this.comparator=e,this.threshold=t,this.referenceDate=s,this.settings=n}matches(e){const t=di(e,{now:this.referenceDate,settings:this.settings});switch(this.comparator){case"above":return t>this.threshold;case"below":return t<this.threshold;case"is":return t===this.threshold;default:return!1}}}class sr{group(e){const t=new Map;for(const s of e){const n=this.getGroupKey(s);this.addToGroup(t,n,s)}return t}addToGroup(e,t,s){e.has(t)||e.set(t,[]),e.get(t).push(s)}}class Yh extends sr{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.dueAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Overdue":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Hh extends sr{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const s=new Date(e.scheduledAt);s.setHours(0,0,0,0);const n=s.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Past":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Kh extends sr{getGroupKey(e){const t=vs.getInstance(),s=e.statusSymbol||" ";return t.get(s).type}}class Wh extends sr{getGroupKey(e){const t=vs.getInstance(),s=e.statusSymbol||" ";return t.get(s).name}}class Gh extends sr{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class Qh extends sr{getGroupKey(e){return e.path||""||"No path"}}class $h extends sr{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const s=t.lastIndexOf("/");return s===-1?"Root":t.substring(0,s)||"Root"}}class Vh extends sr{group(e){const t=new Map;for(const s of e){const n=s.tags||[];if(n.length===0)this.addToGroup(t,"No tags",s);else for(const a of n)this.addToGroup(t,a,s)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}function Cl(r){const e=[];if(r.filters.length>0){e.push("**Filters:**");for(const t of r.filters)e.push(`- ${Mr(t)}`)}else e.push("**Filters:** None (showing all tasks)");if(r.sort){const t=r.sort.reverse?"descending":"ascending";e.push(`
**Sort:** By ${r.sort.field} (${t})`)}return r.group&&e.push(`
**Group:** By ${r.group.field}`),r.limit!==void 0&&r.limit>0&&e.push(`
**Limit:** First ${r.limit} tasks`),e.join(`
`)}function Mr(r){const e=r.negate?"NOT ":"";switch(r.type){case"status":return`${e}Status ${r.operator} "${r.value}"`;case"date":return`${e}${r.value.field} ${r.value.comparator} ${r.value.date}`;case"priority":return`${e}Priority ${r.operator} ${r.value}`;case"urgency":return`${e}Urgency ${r.operator} ${r.value}`;case"tag":return r.operator==="includes"?`${e}Tag includes "${r.value}"`:r.operator==="has"?`${e}Has tags`:`${e}Tag ${r.operator} "${r.value}"`;case"path":return`${e}Path ${r.operator} "${r.value}"`;case"dependency":return r.value==="blocked"?`${e}Is blocked by another task`:r.value==="blocking"?`${e}Is blocking another task`:`${e}Dependency ${r.operator} ${r.value}`;case"recurrence":return`${e}Recurrence ${r.operator} ${r.value}`;case"boolean":return r.operator==="and"?`(${Mr(r.left)} AND ${Mr(r.right)})`:r.operator==="or"?`(${Mr(r.left)} OR ${Mr(r.right)})`:r.operator==="not"?`(NOT ${Mr(r.inner)})`:"Unknown boolean filter";case"done":return r.value?`${e}Done`:`${e}Not done`;case"description":return`${e}Description ${r.operator} "${r.value}"`;default:return`${e}Unknown filter`}}class Il{constructor(e,t={}){k(this,"dependencyGraph",null);k(this,"globalFilterAST",null);k(this,"urgencySettings");this.taskIndex=e,this.urgencySettings=t.urgencySettings??ui}setDependencyGraph(e){this.dependencyGraph=e}setGlobalFilter(e){if(!e){this.globalFilterAST=null;return}try{const t=new Js;this.globalFilterAST=t.parse(e)}catch(t){console.error("Failed to parse global filter:",t),this.globalFilterAST=null}}execute(e){const t=performance.now(),s=new Date;try{const n=e.explain?this.generateExplanation(e):void 0;let a=this.taskIndex.getAllTasks();const o=a.length;this.globalFilterAST&&this.globalFilterAST.filters.length>0&&(a=this.applyFilters(a,this.globalFilterAST.filters,s)),e.filters.length>0&&(a=this.applyFilters(a,e.filters,s)),e.sort&&(a=this.applySort(a,e.sort,s)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let l;e.group&&(l=this.applyGrouping(a,e.group));const u=performance.now()-t;return{tasks:a,groups:l,totalCount:o,executionTimeMs:u,explanation:n}}catch(n){throw new Ir(`Failed to execute query: ${n instanceof Error?n.message:String(n)}`,n instanceof Error?n:void 0)}}executeString(e){const s=new Js().parse(e);return this.execute(s)}validateQuery(e){try{return{valid:!0,parsedFilters:new Js().parse(e).filters.map(n=>`${n.type}:${n.operator}`)}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}applyFilters(e,t,s){let n=e;for(const a of t){const o=this.createFilter(a,s);n=n.filter(l=>o.matches(l))}return n}createFilter(e,t){switch(e.type){case"done":return e.value?new Dh:new Eh;case"status":if(e.operator==="type-is")return new wh(e.value,e.negate);if(e.operator==="name-includes")return new Th(e.value,e.negate);if(e.operator==="symbol-is")return new Sh(e.value,e.negate);throw new Ir(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new Ah(e.value.field,e.negate):new xh(e.value.field,e.operator,e.value.date);case"priority":return new Oh(e.operator,e.value);case"urgency":return new jh(e.operator,e.value,t,this.urgencySettings);case"tag":return e.operator==="has"?new Nh(!e.value):new Mh(e.value,e.negate);case"path":return new qh(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new Rh(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Lh(this.dependencyGraph,!e.value);throw new Ir(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Fh(!e.value);case"description":return new zh(e.operator,e.value,e.negate);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new Ph(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="OR"&&e.left&&e.right)return new Bh(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="NOT"&&e.inner)return new Uh(this.createFilter(e.inner,t));throw new Ir(`Invalid boolean operator: ${e.operator}`);default:throw new Ir(`Unknown filter type: ${e.type}`)}}applySort(e,t,s){const n=[...e];return n.sort((a,o)=>{let l=0;switch(t.field){case"due":l=this.compareDates(a.dueAt,o.dueAt);break;case"scheduled":l=this.compareDates(a.scheduledAt,o.scheduledAt);break;case"start":l=this.compareDates(a.startAt,o.startAt);break;case"created":l=this.compareDates(a.createdAt,o.createdAt);break;case"done":l=this.compareDates(a.doneAt,o.doneAt);break;case"priority":l=this.comparePriorities(a.priority,o.priority);break;case"urgency":l=this.getUrgencyScore(o,s)-this.getUrgencyScore(a,s);break;case"status.type":l=this.compareStatusTypes(a,o);break;case"description":l=(a.description||"").localeCompare(o.description||"");break;case"path":l=(a.path||"").localeCompare(o.path||"");break;default:l=a.name.localeCompare(o.name)}return t.reverse?-l:l}),n}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const s={lowest:0,low:1,normal:2,medium:3,high:4,highest:5},n=s[Qr(e)||"normal"]||2,a=s[Qr(t)||"normal"]||2;return n-a}compareStatusTypes(e,t){const s=n=>{const a=n.statusSymbol||" ";return a===" "?0:a==="/"?1:a==="x"?2:a==="-"?3:0};return s(e)-s(t)}getUrgencyScore(e,t){return di(e,{now:t,settings:this.urgencySettings})}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new Yh;case"scheduled":return new Hh;case"status.type":return new Kh;case"status.name":return new Wh;case"priority":return new Gh;case"path":return new Qh;case"folder":return new $h;case"tags":return new Vh;default:throw new Ir(`Unknown grouping field: ${e}`)}}generateExplanation(e){return Cl(e)}}class Ol{constructor(e){k(this,"parser");this.parser=e??new Js}compose(e,t){const{query:s,ignoreGlobal:n}=this.stripIgnoreDirective(e),a=this.parser.parse(s);return!n&&t&&t.filters.length>0?{ast:{...a,filters:[...t.filters,...a.filters]},ignoredGlobal:!1}:{ast:a,ignoredGlobal:n}}stripIgnoreDirective(e){const t=e.split(`
`),s=[];let n=!1;for(const a of t){if(/^ignore global query$/i.test(a.trim())){n=!0;continue}s.push(a)}return{query:s.join(`
`),ignoreGlobal:n}}}const Un={enabled:!1,query:""},ar=class ar{constructor(e=Un){k(this,"config");k(this,"ast",null);k(this,"error",null);this.config=e,this.parse()}static getInstance(){return ar.instance||(ar.instance=new ar),ar.instance}initialize(e){this.config=e,this.parse()}updateConfig(e){this.config=e,this.parse()}getConfig(){return this.config}isEnabled(){return this.config.enabled&&this.config.query.trim().length>0}getAST(){return this.ast}getError(){return this.error}parse(){if(!this.isEnabled()){this.ast=null,this.error=null;return}try{const e=new Js;this.ast=e.parse(this.config.query),this.error=null}catch(e){this.ast=null,this.error=e instanceof Error?e.message:String(e)}}};k(ar,"instance",null);let $r=ar;var Xh=A('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Zh=A('<div class="search-tab__error svelte-1yjlv38"> </div>'),Jh=A('<div class="search-tab__stats svelte-1yjlv38"> </div>'),ef=A('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),tf=A('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),sf=A('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),rf=A('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">🔍 No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),nf=A('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),af=A(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function of(r,e){Je(e,!0);let t=K(""),s=K(ke([])),n=K(""),a=K(0),o=K(ke([])),l=K(!1),c=K(!1);const u=["not done","priority is high","due before tomorrow","not done AND priority above medium","is blocked","description includes meeting","tag includes #work","is recurring","priority is high OR priority is medium","NOT is blocked","not done AND priority is high AND description includes priority","sort by priority","sort by urgency","urgency above 80","group by priority"],h={getAllTasks:()=>e.tasks},p=qo(fi),v=new Il(h,{urgencySettings:p}),y=new Ol(new Js);function w(){if(!i(t).trim()){b(s,[],!0),b(n,"");return}b(c,!0),b(n,"");try{const F=$r.getInstance();if(F.isEnabled()&&F.getError())throw new Error(`Global query error: ${F.getError()}`);const T=y.compose(i(t),F.getAST()).ast,q=v.execute(T);if(b(s,q.tasks,!0),b(a,q.executionTimeMs,!0),!i(o).includes(i(t))){b(o,[i(t),...i(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(i(o)))}catch{}}}catch(F){b(n,F instanceof Error?F.message:String(F),!0),b(s,[],!0),Q.error(`Query error: ${i(n)}`)}finally{b(c,!1)}}function m(){try{const F=localStorage.getItem("query-history");F&&b(o,JSON.parse(F),!0)}catch{}}function g(F){b(t,F,!0),w()}function _(F){b(t,F,!0),b(l,!1),w()}function E(){b(o,[],!0);try{localStorage.removeItem("query-history")}catch{}b(l,!1)}function D(F){F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),w())}yt(()=>{m()});let x=K(0),R=ke([]);yt(()=>{i(x)>=i(s).length&&b(x,Math.max(0,i(s).length-1),!0)});function U(F,T){F.key==="ArrowDown"?(F.preventDefault(),b(x,Math.min(i(x)+1,i(s).length-1),!0)):F.key==="ArrowUp"?(F.preventDefault(),b(x,Math.max(i(x)-1,0),!0)):F.key==="Enter"&&e.onEdit?(F.preventDefault(),e.onEdit(i(s)[T])):F.key===" "&&e.onDone&&(F.preventDefault(),e.onDone(i(s)[T]))}var N=af(),W=f(d(N),2),Y=d(W),J=d(Y);J.__keydown=D;var re=f(J,2),te=d(re);te.__click=w;var le=d(te),ye=f(te,2);{var H=F=>{var T=Xh();T.__click=()=>b(l,!i(l));var q=d(T);j(()=>P(q,`History (${i(o).length??""})`)),S(F,T)};G(ye,F=>{i(o).length>0&&F(H)})}var L=f(Y,2);{var C=F=>{var T=Zh(),q=d(T);j(()=>P(q,`⚠️ ${i(n)??""}`)),S(F,T)};G(L,F=>{i(n)&&F(C)})}var z=f(L,2);{var se=F=>{var T=Jh(),q=d(T);j(Z=>P(q,`Found ${i(s).length??""} task${i(s).length!==1?"s":""} in ${Z??""}ms`),[()=>i(a).toFixed(2)]),S(F,T)};G(z,F=>{i(a)>0&&!i(n)&&F(se)})}var X=f(W,2);{var me=F=>{var T=tf(),q=d(T),Z=f(d(q),2);Z.__click=E;var ne=f(q,2);Fe(ne,21,()=>i(o),nt,(I,M)=>{var ie=ef(),Ae=d(ie);Ae.__click=()=>_(i(M));var Ie=d(Ae);j(()=>P(Ie,i(M))),S(I,ie)}),S(F,T)};G(X,F=>{i(l)&&i(o).length>0&&F(me)})}var ve=f(X,2),he=f(d(ve),2);Fe(he,21,()=>u,nt,(F,T)=>{var q=sf();q.__click=()=>g(i(T));var Z=d(q),ne=d(Z);j(()=>P(ne,i(T))),S(F,q)});var Te=f(ve,2),_e=d(Te);{var qe=F=>{var T=rf();S(F,T)},fe=F=>{var T=rt(),q=Ge(T);{var Z=ne=>{var I=rt(),M=Ge(I);Fe(M,19,()=>i(s),ie=>ie.id,(ie,Ae,Ie)=>{var Ce=nf();Ce.__keydown=Pe=>U(Pe,i(Ie));var Ye=d(Ce);Jr(Ye,{get task(){return i(Ae)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fs(Ce,(Pe,lt)=>R[lt]=Pe,Pe=>R==null?void 0:R[Pe],()=>[i(Ie)]),j(()=>Ee(Ce,"tabindex",i(Ie)===i(x)?0:-1)),St("focus",Ce,()=>b(x,i(Ie),!0)),S(ie,Ce)}),S(ne,I)};G(q,ne=>{i(s).length>0&&ne(Z)},!0)}S(F,T)};G(_e,F=>{i(s).length===0&&i(t).trim()&&!i(n)?F(qe):F(fe,!1)})}j(()=>{te.disabled=i(c),P(le,i(c)?"Searching...":"Search")}),at(J,()=>i(t),F=>b(t,F)),S(r,N),et()}ht(["keydown","click"]);class Na{static parse(e){const t=e,s=e.trim().toLowerCase().replace(/\s+/g," ");if(!s)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=s.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let a=n[1],o;const l=a.match(/^(.+?)\s+when\s+done$/),c=a.match(/^(.+?)\s+when\s+due$/);if(l?(a=l[1],o=!0):c&&(a=c[1],o=!1),a==="weekday"||a==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(a==="weekend"||a==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=this.parseOrdinalWeekdayPattern(a);if(u.matched)return u.error||u.ordinal===void 0||u.weekday===void 0?{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:u.error||"Invalid ordinal weekday pattern"}:{frequency:{type:"monthly",interval:1,dayOfMonth:1,whenDone:o,rruleString:this.buildOrdinalRRuleString(u.weekday,u.ordinal),naturalLanguage:t},raw:t,isValid:!0};const h=a.match(/^(\d+\s+)?days?$/);if(h)return{frequency:{type:"daily",interval:h[1]?parseInt(h[1]):1,whenDone:o},raw:t,isValid:!0};const p=a.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(p){const w=p[1]?parseInt(p[1]):1,m=p[2];if(!m)return{frequency:{type:"weekly",interval:w,weekdays:[1],whenDone:o},raw:t,isValid:!0};const g=this.parseDayNames(m);return g.length===0?{frequency:{type:"weekly",interval:w,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:w,weekdays:g,whenDone:o},raw:t,isValid:!0}}const v=a.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(v){const w=v[1]?parseInt(v[1]):1,m=v[2]?parseInt(v[2]):1;return m<1||m>31?{frequency:{type:"monthly",interval:w,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:w,dayOfMonth:m,whenDone:o},raw:t,isValid:!0}}const y=a.match(/^(\d+\s+)?years?$/);return y?{frequency:{type:"yearly",interval:y[1]?parseInt(y[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=this.stringifyOrdinalWeekday(e.rruleString);if(t)return e.whenDone?`${t} when done`:t;const s=e.interval;let n;switch(e.type){case"daily":n=s===1?"every day":`every ${s} days`;break;case"weekly":{const a=s===1?"week":`${s} weeks`;if(e.weekdays.length===0)n=`every ${a}`;else{const o=e.weekdays.map(l=>this.getDayName(l)).join(", ");n=`every ${a} on ${o}`}break}case"monthly":{const a=s===1?"month":`${s} months`,o=this.getDaySuffix(e.dayOfMonth);n=`every ${a} on the ${e.dayOfMonth}${o}`;break}case"yearly":{n=`every ${s===1?"year":`${s} years`}`;break}default:n="every day"}return e.whenDone?`${n} when done`:n}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},s=e.split(",").map(a=>a.trim().toLowerCase()),n=[];for(const a of s)a in t&&n.push(t[a]);return n}static parseOrdinalWeekdayPattern(e){const t=e.split(" ");if(t.length<2)return{matched:!1};const s=this.parseOrdinalToken(t[0]);if(!s.matched)return{matched:!1};if(s.error)return{matched:!0,error:s.error};const n=this.parseSingleDay(t[1]);return n===null?{matched:!0,error:"Invalid weekday name"}:t.length===2?{matched:!0,ordinal:s.value,weekday:n}:t.length===5&&t[2]==="of"&&t[3]==="the"&&t[4]==="month"?{matched:!0,ordinal:s.value,weekday:n}:{matched:!0,error:"Ordinal weekday pattern must be 'every <ordinal> <weekday>' optionally followed by 'of the month'"}}static parseOrdinalToken(e){const t={first:1,second:2,third:3,fourth:4,last:-1};if(e in t)return{matched:!0,value:t[e]};const s=e.match(/^(\d+)(st|nd|rd|th)$/);if(!s)return{matched:!1};const n=parseInt(s[1],10);return n>=1&&n<=4?{matched:!0,value:n}:{matched:!0,error:"Ordinal weekday must be first, second, third, fourth, or last"}}static parseSingleDay(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6};return e in t?t[e]:null}static stringifyOrdinalWeekday(e){if(!e)return null;const t=this.parseRRuleString(e);if(!t||t.FREQ!=="MONTHLY"||!t.BYDAY||!t.BYSETPOS)return null;const s=this.fromRRuleWeekday(t.BYDAY);if(s===null)return null;const n=Number.parseInt(t.BYSETPOS,10);if(!Number.isFinite(n))return null;const a=this.ordinalWord(n);return a?`every ${a} ${this.getDayName(s)}`:null}static ordinalWord(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";case 4:return"fourth";case-1:return"last";default:return null}}static buildOrdinalRRuleString(e,t){return`RRULE:FREQ=MONTHLY;BYDAY=${this.toRRuleWeekday(e)};BYSETPOS=${t}`}static toRRuleWeekday(e){return["MO","TU","WE","TH","FR","SA","SU"][e]||"MO"}static fromRRuleWeekday(e){const s=["MO","TU","WE","TH","FR","SA","SU"].indexOf(e);return s>=0?s:null}static parseRRuleString(e){const t=e.trim().toUpperCase(),s=t.startsWith("RRULE:")?t.slice(6):t;if(!s)return null;const n=s.split(";"),a={};for(const o of n){if(!o)continue;const[l,c]=o.split("=");if(!l||!c)return null;a[l]=c}return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var lf=A('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),cf=A('<div class="priority-selector svelte-1w15n9q"></div>');function uf(r,e){Je(e,!0);let t=Rs(e,"value",15,"normal");const s=[{value:"highest",label:"Highest",emoji:"🔺",color:"var(--b3-theme-error, #ef4444)"},{value:"high",label:"High",emoji:"⏫",color:"#f97316"},{value:"medium",label:"Medium",emoji:"🔼",color:"#f59e0b"},{value:"normal",label:"Normal",emoji:"🟡",color:"#eab308"},{value:"low",label:"Low",emoji:"🔽",color:"#22c55e"},{value:"lowest",label:"Lowest",emoji:"⏬",color:"#64748b"}];function n(o){t(o),e.onchange(o)}var a=cf();Fe(a,21,()=>s,nt,(o,l)=>{var c=lf();let u;var h=d(c);h.__change=()=>n(i(l).value);var p=f(h,2),v=d(p),y=f(p,2),w=d(y);j(()=>{u=Ke(c,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===i(l).value}),br(c,`--priority-color: ${i(l).color??""}`),oi(h,i(l).value),Fr(h,t()===i(l).value),P(v,i(l).emoji),P(w,i(l).label)}),S(o,c)}),S(r,a),et()}ht(["change"]);var df=A('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),hf=A('<div class="status-selector svelte-v9ezc0"></div>');function ff(r,e){Je(e,!0);let t=Rs(e,"value",15,"todo");const s=[{value:"todo",label:"Todo",icon:"○",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"✓",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"✕",color:"#999"}];function n(o){t(o),e.onchange(o)}var a=hf();Fe(a,21,()=>s,nt,(o,l)=>{var c=df();let u;var h=d(c);h.__change=()=>n(i(l).value);var p=f(h,2),v=d(p),y=f(p,2),w=d(y);j(()=>{u=Ke(c,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===i(l).value}),br(c,`--status-color: ${i(l).color??""}`),oi(h,i(l).value),Fr(h,t()===i(l).value),P(v,i(l).icon),P(w,i(l).label)}),S(o,c)}),S(r,a),et()}ht(["change"]);var vf=A('<div class="recurrence-input__valid svelte-787fjp">✓ Valid recurrence pattern</div>'),pf=A('<div class="recurrence-input__error svelte-787fjp"> </div>'),yf=A('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),mf=A('<li class="svelte-787fjp"> </li>'),gf=A('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),bf=A('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function _f(r,e){Je(e,!0);let t=Rs(e,"value",15,""),s=Rs(e,"showPreview",3,!0);const n=V(()=>Na.parse(t())),a=V(()=>i(n).isValid),o=V(()=>i(n).error);function l(_,E=3){const D=[],x=new Date;for(let R=0;R<E;R++){const U=new Date(x);switch(_.type){case"daily":U.setDate(x.getDate()+R*_.interval);break;case"weekly":U.setDate(x.getDate()+R*_.interval*7);break;case"monthly":U.setMonth(x.getMonth()+R*_.interval);break;case"yearly":U.setFullYear(x.getFullYear()+R*_.interval);break}D.push(U.toLocaleDateString())}return D}const c=V(()=>i(a)&&s()?l(i(n).frequency):[]);function u(_){const D=_.target.value;t(D);const x=Na.parse(D);e.onchange(D,x.isValid?x.frequency:null,x.isValid)}var h=bf(),p=d(h);let v;p.__input=u;var y=f(p,2);{var w=_=>{var E=yf(),D=d(E);{var x=U=>{var N=vf();S(U,N)},R=U=>{var N=pf(),W=d(N);j(()=>P(W,`⚠ ${(i(o)||"Invalid recurrence pattern")??""}`)),S(U,N)};G(D,U=>{i(a)?U(x):U(R,!1)})}S(_,E)};G(y,_=>{t().length>0&&_(w)})}var m=f(y,2);{var g=_=>{var E=gf(),D=f(d(E),2);Fe(D,21,()=>i(c),nt,(x,R)=>{var U=mf(),N=d(U);j(()=>P(N,i(R))),S(x,U)}),S(_,E)};G(m,_=>{i(a)&&s()&&i(c).length>0&&_(g)})}j(()=>{v=Ke(p,1,"recurrence-input__field svelte-787fjp",null,v,{valid:i(a),invalid:!i(a)&&t().length>0}),Ee(p,"aria-invalid",!i(a)&&t().length>0)}),at(p,t),S(r,h),et()}ht(["input"]);var kf=A('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">✕</button></div>'),wf=A('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),Tf=A('<span class="dependency-picker__option-check svelte-10ls0lk">✓</span>'),Sf=A('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Df=A('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),Ef=A('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function so(r,e){Je(e,!0);let t=Rs(e,"selected",31,()=>ke([])),s=Rs(e,"label",3,"Select tasks"),n=K(""),a=K(!1);const o=V(()=>e.repository.getAllTasks().filter(U=>U.id!==e.excludeId)),l=V(()=>i(n).trim()?i(o).filter(U=>U.name.toLowerCase().includes(i(n).toLowerCase())):i(o)),c=V(()=>i(o).filter(U=>t().includes(U.id)));function u(U){if(!t().includes(U)){const N=[...t(),U];t(N),e.onchange(N)}b(n,""),b(a,!1)}function h(U){const N=t().filter(W=>W!==U);t(N),e.onchange(N)}function p(){b(a,!0)}function v(){setTimeout(()=>{b(a,!1)},200)}var y=Ef(),w=d(y),m=d(w),g=f(w,2);{var _=U=>{var N=wf();Fe(N,21,()=>i(c),W=>W.id,(W,Y)=>{var J=kf(),re=d(J),te=d(re),le=f(re,2);le.__click=()=>h(i(Y).id),j(()=>{P(te,i(Y).name),Ee(le,"aria-label",`Remove ${i(Y).name??""}`)}),S(W,J)}),S(U,N)};G(g,U=>{i(c).length>0&&U(_)})}var E=f(g,2),D=d(E),x=f(D,2);{var R=U=>{var N=Df();Fe(N,21,()=>i(l).slice(0,10),W=>W.id,(W,Y)=>{var J=Sf();let re;J.__click=()=>u(i(Y).id);var te=d(J),le=d(te),ye=f(te,2);{var H=L=>{var C=Tf();S(L,C)};G(ye,L=>{t().includes(i(Y).id)&&L(H)})}j((L,C)=>{re=Ke(J,1,"dependency-picker__option svelte-10ls0lk",null,re,L),J.disabled=C,P(le,i(Y).name)},[()=>({selected:t().includes(i(Y).id)}),()=>t().includes(i(Y).id)]),S(W,J)}),S(U,N)};G(x,U=>{i(a)&&i(l).length>0&&U(R)})}j(()=>P(m,s())),St("focus",D,p),St("blur",D,v),at(D,()=>i(n),U=>b(n,U)),S(r,y),et()}ht(["click"]);var xf=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Af=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Cf=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),If=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Of=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Mf=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Nf=A('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">✕</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">💡 Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">⌘/Ctrl+Enter</kbd> to save</div></div></div>');function Ml(r,e){var Ue,Ze,ct,ut,Nt,Vt,xt,os,jt,ls,zs,Yt;Je(e,!0);const t="every day",s="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",a=!e.task;let o=K(ke(((Ue=e.task)==null?void 0:Ue.name)||"")),l=K(ke(((Ze=e.task)==null?void 0:Ze.description)||"")),c=K(ke(((ct=e.task)==null?void 0:ct.priority)||"normal")),u=K(ke(((ut=e.task)==null?void 0:ut.status)||"todo")),h=K(ke((Nt=e.task)!=null&&Nt.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),p=K(ke((Vt=e.task)!=null&&Vt.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),v=K(ke((xt=e.task)!=null&&xt.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),y=K(ke(((os=e.task)==null?void 0:os.recurrenceText)||((jt=e.task)!=null&&jt.frequency?Na.stringify(e.task.frequency):t))),w=K(ke(((ls=e.task)==null?void 0:ls.frequency)||null)),m=K(!0),g=K(ke(((zs=e.task)==null?void 0:zs.blockedBy)||[])),_=K(ke(((Yt=e.task)==null?void 0:Yt.dependsOn)||[])),E=K(ke({name:!1,dueAt:!1,recurrence:!1})),D=K(!1),x=K(null);const R=V(()=>i(E).name&&!i(o).trim()?"Task name is required":""),U=V(()=>i(E).dueAt?i(h)?Number.isNaN(new Date(i(h)).getTime())?"Invalid due date":"":"Due date is required":""),N=V(()=>i(E).recurrence&&!i(m)?"Invalid recurrence pattern":""),W=V(()=>!!(i(R)||i(U)||i(N)));Tn(()=>{requestAnimationFrame(()=>{var B;(B=i(x))==null||B.focus()})});function Y(B,ue,it){b(y,B,!0),b(w,ue,!0),b(m,it,!0),i(E).recurrence=!0}function J(B){b(c,B,!0)}function re(B){b(u,B,!0)}function te(B){b(g,B,!0)}function le(B){b(_,B,!0)}async function ye(){if(b(E,{name:!0,dueAt:!0,recurrence:!0},!0),i(W)){Q.warning("Please fix validation errors");return}if(!i(w)){Q.error("Invalid recurrence pattern");return}b(D,!0);try{let B;a?B=Tl(i(o).trim(),i(w),new Date(i(h))):(B={...e.task},B.name=i(o).trim(),B.frequency=i(w),B.dueAt=new Date(i(h)).toISOString()),B.description=i(l).trim()||void 0,B.priority=i(c),B.status=i(u),B.recurrenceText=i(y),B.scheduledAt=i(p)?new Date(i(p)).toISOString():void 0,B.startAt=i(v)?new Date(i(v)).toISOString():void 0,B.blockedBy=i(g).length>0?i(g):void 0,B.dependsOn=i(_).length>0?i(_):void 0,B.updatedAt=new Date().toISOString(),i(u)==="done"&&!B.lastCompletedAt&&(B.lastCompletedAt=new Date().toISOString()),i(u)==="cancelled"&&!B.cancelledAt&&(B.cancelledAt=new Date().toISOString()),await e.repository.saveTask(B),e.onSave&&e.onSave(B),Q.success(`Task "${B.name}" ${a?"created":"updated"}`),ze.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(B){Q.error(`Failed to save task: ${B}`)}finally{b(D,!1)}}function H(B){B.key==="Escape"&&e.onClose(),(B.metaKey||B.ctrlKey)&&B.key==="Enter"&&(B.preventDefault(),ye())}function L(B){return B?new Date(B).toLocaleString():"—"}var C=Nf();C.__keydown=H;var z=d(C),se=d(z),X=d(se),me=d(X),ve=f(X,2);ve.__click=function(...B){var ue;(ue=e.onClose)==null||ue.apply(this,B)};var he=f(se,2),Te=d(he),_e=f(d(Te),2);_e.__input=()=>i(E).name=!0,fs(_e,B=>b(x,B),()=>i(x));var qe=f(_e,2);{var fe=B=>{var ue=xf(),it=d(ue);j(()=>P(it,i(R))),S(B,ue)};G(qe,B=>{i(R)&&B(fe)})}var F=f(Te,2),T=f(d(F),2),q=f(F,2),Z=f(d(q),2);uf(Z,{get value(){return i(c)},onchange:J});var ne=f(q,2),I=f(d(ne),2);ff(I,{get value(){return i(u)},onchange:re});var M=f(ne,2),ie=f(d(M),2);ie.__input=()=>i(E).dueAt=!0;var Ae=f(ie,2);{var Ie=B=>{var ue=Af(),it=d(ue);j(()=>P(it,i(U))),S(B,ue)};G(Ae,B=>{i(U)&&B(Ie)})}var Ce=f(M,2),Ye=f(d(Ce),2),Pe=f(Ce,2),lt=f(d(Pe),2),bt=f(Pe,2),$e=f(d(bt),2);_f($e,{get value(){return i(y)},onchange:Y,showPreview:!0});var Et=f($e,2);{var vt=B=>{var ue=Cf(),it=d(ue);j(()=>P(it,i(N))),S(B,ue)};G(Et,B=>{i(N)&&B(vt)})}var Oe=f(bt,2),_t=d(Oe);{let B=V(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});so(_t,{get repository(){return e.repository},get selected(){return i(g)},get excludeId(){return i(B)},onchange:te,label:s})}var He=f(Oe,2),Ve=d(He);{let B=V(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});so(Ve,{get repository(){return e.repository},get selected(){return i(_)},get excludeId(){return i(B)},onchange:le,label:n})}var Xe=f(He,2),Ot=d(Xe),Mt=f(d(Ot),2),zt=d(Mt),ae=f(Ot,2);{var oe=B=>{var ue=If(),it=f(d(ue),2),Ds=d(it);j(Xt=>P(Ds,Xt),[()=>L(e.task.lastCompletedAt)]),S(B,ue)};G(ae,B=>{var ue;(ue=e.task)!=null&&ue.lastCompletedAt&&B(oe)})}var we=f(ae,2);{var tt=B=>{var ue=Of(),it=f(d(ue),2),Ds=d(it);j(Xt=>P(Ds,Xt),[()=>L(e.task.cancelledAt)]),S(B,ue)};G(we,B=>{var ue;(ue=e.task)!=null&&ue.cancelledAt&&B(tt)})}var ps=f(we,2);{var ee=B=>{var ue=Mf(),it=f(d(ue),2),Ds=d(it);j(()=>P(Ds,e.task.linkedBlockId)),S(B,ue)};G(ps,B=>{var ue;(ue=e.task)!=null&&ue.linkedBlockId&&B(ee)})}var ge=f(he,2),Be=d(ge);Be.__click=function(...B){var ue;(ue=e.onClose)==null||ue.apply(this,B)};var ce=f(Be,2);ce.__click=ye;var Se=d(ce);j(B=>{P(me,a?"Create Task":"Edit Task"),Ee(_e,"aria-invalid",!!i(R)),Ee(ie,"aria-invalid",!!i(U)),P(zt,B),ce.disabled=i(D),P(Se,i(D)?"Saving...":a?"Create Task":"Save Changes")},[()=>{var B;return L((B=e.task)==null?void 0:B.createdAt)}]),St("blur",_e,()=>i(E).name=!0),at(_e,()=>i(o),B=>b(o,B)),at(T,()=>i(l),B=>b(l,B)),St("blur",ie,()=>i(E).dueAt=!0),at(ie,()=>i(h),B=>b(h,B)),at(Ye,()=>i(p),B=>b(p,B)),at(lt,()=>i(v),B=>b(v,B)),S(r,C),et()}ht(["keydown","click","input"]);class qf{constructor(e){k(this,"config");k(this,"compiledExcludeFolders",[]);k(this,"compiledExcludeNotebooks",[]);k(this,"compiledExcludeTags",[]);k(this,"compiledExcludeFilePatterns",[]);k(this,"statusRegistry",vs.getInstance());this.config=e,this.compileExclusions()}evaluate(e,t){if(!this.config.enabled)return!0;if(!this.passesExclusions(e,t))return!1;if(this.config.mode==="all")return!0;const s=this.config.rules.filter(o=>o.enabled);if(s.length===0)return!0;const a=s.map(o=>this.evaluateRule(o,e,t)).some(o=>o);return this.config.mode==="include"?a:!a}updateConfig(e){this.config=e,this.compileExclusions()}getConfig(){return this.config}evaluateRule(e,t,s){switch(e.type){case"tag":const n=this.extractTags(t),a=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${a}$`);return n.some(l=>o.test(l));case"regex":try{return new RegExp(e.pattern).test(t)}catch{return!1}case"path":return s?s.includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}evaluateTask(e){if(!this.config.enabled)return!0;const t=e.linkedBlockContent??e.name??"",s=e.path;if(!this.passesExclusions(t,s,e.statusSymbol,e.tags))return!1;if(this.config.mode==="all")return!0;const n=this.config.rules.filter(l=>l.enabled);if(n.length===0)return!0;const o=n.map(l=>this.evaluateRule(l,t,s)).some(l=>l);return this.config.mode==="include"?o:!o}extractTags(e){return e.match(/#[\w/-]+/g)||[]}passesExclusions(e,t,s,n){const a=t?this.normalizePath(t):void 0,o=n??this.extractTags(e);if(a&&(this.compiledExcludeFolders.some(l=>l.test(a))||this.compiledExcludeNotebooks.some(l=>l.test(a))||this.compiledExcludeFilePatterns.some(l=>l.test(a)))||o.length>0&&this.compiledExcludeTags.length>0&&o.some(l=>this.compiledExcludeTags.some(c=>c.test(l))))return!1;if(this.config.excludeStatusTypes.length>0){const l=this.resolveStatusType(s,e);if(l&&this.config.excludeStatusTypes.includes(l))return!1}return!0}resolveStatusType(e,t){const s=e??this.extractStatusSymbol(t??"");return s?this.statusRegistry.get(s).type:null}extractStatusSymbol(e){const t=e.match(/^\s*-\s*\[(.)\]/);return t?t[1]:null}compileExclusions(){this.compiledExcludeFolders=this.config.excludeFolders.map(e=>this.compilePathPattern(e)),this.compiledExcludeNotebooks=this.config.excludeNotebooks.map(e=>this.compilePathPattern(e)),this.compiledExcludeFilePatterns=this.config.excludeFilePatterns.map(e=>this.compilePathPattern(e)),this.compiledExcludeTags=this.config.excludeTags.map(e=>this.compileTagPattern(e))}compileTagPattern(e){const t=e.trim();if(!t)return/^$/;const s=t.replace(/\*/g,".*");return new RegExp(`^${s}$`,"i")}compilePathPattern(e){const t=e.trim();if(!t)return/^$/;const s=t.match(/^\/(.+)\/([gimsuy]*)$/);if(s)try{return new RegExp(s[1],s[2])}catch{return/^$/}return this.globToRegExp(t)}globToRegExp(e){let s=this.normalizePath(e).replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*\*/g,"::DOUBLE_STAR::").replace(/\*/g,"[^/]*").replace(/::DOUBLE_STAR::/g,".*");return s.startsWith(".*")||(s=`.*${s}`),new RegExp(s)}normalizePath(e){return e.replace(/\\/g,"/")}}const pn={enabled:!1,mode:"all",rules:[],excludeFolders:[],excludeNotebooks:[],excludeTags:[],excludeFilePatterns:[],excludeStatusTypes:[]},ir=class ir{constructor(){k(this,"engine");this.engine=new qf(pn)}static getInstance(){return ir.instance||(ir.instance=new ir),ir.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}shouldIncludeTask(e){return this.engine.evaluateTask(e)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(pn)}};k(ir,"instance",null);let zn=ir;var Rf=A("<span> </span>"),Lf=A("<span>Preview unavailable</span>"),Ff=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Pf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Bf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Uf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),zf=A('<label class="status-toggle svelte-b8rwae"><input type="checkbox"/> <span> </span></label>'),jf=A("<div> </div>"),Yf=A('<pre class="query-explanation svelte-b8rwae"> </pre>'),Hf=A('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Filtering &amp; Query</h3> <p class="description svelte-b8rwae">Apply a hard exclusion filter before indexing, plus a default query fragment applied to every query.</p> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Filter (Hard Exclusions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Filter</span></label></div> <div class="preview svelte-b8rwae"><!></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Folders</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/archive/**"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Notebooks</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="Personal"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Tags</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="#log"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude File Patterns (glob or /regex/)</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/templates/** or /daily/.+\\.md/"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Status Types</label> <div class="status-toggle-list svelte-b8rwae"></div></div> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Filter</button></section> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Query (Default Conditions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Query</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Global Query DSL</label> <textarea class="settings__input svelte-b8rwae" rows="4" placeholder="not done\\nnot blocked\\ndue before next 30 days"></textarea></div> <div class="query-actions svelte-b8rwae"><button class="add-btn svelte-b8rwae" type="button">Save Global Query</button> <button class="add-btn svelte-b8rwae" type="button">Validate / Explain</button> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Query</button></div> <!> <!> <p class="hint svelte-b8rwae">Use <code>ignore global query</code> on a local query line to bypass the global query for that block.</p></section></div>');function Kf(r,e){Je(e,!0);const t=zn.getInstance(),s=$r.getInstance();let n=K(ke(e.settingsService.get().globalFilter??pn)),a=K(ke(e.settingsService.get().globalQuery??Un)),o=K(""),l=K(""),c=K(""),u=K(""),h=K(null),p=K(null),v=K(null);const y=Object.values(st);yt(()=>{x()});function w(ae){return Array.from(new Set(ae.map(oe=>oe.trim()).filter(Boolean)))}function m(ae,oe){const we=oe.trim();we&&(b(n,{...i(n),[ae]:w([...i(n)[ae],we])},!0),E())}function g(ae,oe){b(n,{...i(n),[ae]:i(n)[ae].filter(we=>we!==oe)},!0),E()}function _(ae){const oe=new Set(i(n).excludeStatusTypes);oe.has(ae)?oe.delete(ae):oe.add(ae),b(n,{...i(n),excludeStatusTypes:Array.from(oe)},!0),E()}async function E(){t.updateConfig(i(n)),await e.settingsService.update({globalFilter:i(n)}),ze.emit("task:settings",{source:"global-filter"}),x()}async function D(){s.updateConfig(i(a)),await e.settingsService.update({globalQuery:i(a)}),ze.emit("task:settings",{source:"global-query"})}function x(){if(!e.repository){b(h,null);return}const ae=e.repository.getAllTasks();b(h,ae.filter(oe=>!t.shouldIncludeTask(oe)).length,!0)}async function R(){b(n,{...pn},!0),await E(),Q.success("Global filter reset to defaults")}async function U(){b(a,{...Un},!0),b(p,null),b(v,null),await D(),Q.success("Global query reset to defaults")}function N(){const ae=new Js;try{const oe=ae.parse(i(a).query||"");b(p,{valid:!0,message:"Global query is valid."},!0),b(v,Cl(oe),!0)}catch(oe){const we=oe instanceof Error?oe.message:String(oe);b(p,{valid:!1,message:we},!0),b(v,null)}}var W=Hf(),Y=f(d(W),4),J=d(Y),re=f(d(J),2),te=d(re);te.__change=E;var le=f(J,2),ye=d(le);{var H=ae=>{var oe=Rf(),we=d(oe);j(()=>P(we,`Preview: ${i(h)??""} tasks excluded (from current index)`)),S(ae,oe)},L=ae=>{var oe=Lf();S(ae,oe)};G(ye,ae=>{i(h)!==null?ae(H):ae(L,!1)})}var C=f(le,2),z=f(d(C),2);Fe(z,21,()=>i(n).excludeFolders,nt,(ae,oe)=>{var we=Ff();we.__click=()=>g("excludeFolders",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var se=f(z,2),X=d(se),me=f(X,2);me.__click=()=>{m("excludeFolders",i(o)),b(o,"")};var ve=f(C,2),he=f(d(ve),2);Fe(he,21,()=>i(n).excludeNotebooks,nt,(ae,oe)=>{var we=Pf();we.__click=()=>g("excludeNotebooks",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var Te=f(he,2),_e=d(Te),qe=f(_e,2);qe.__click=()=>{m("excludeNotebooks",i(l)),b(l,"")};var fe=f(ve,2),F=f(d(fe),2);Fe(F,21,()=>i(n).excludeTags,nt,(ae,oe)=>{var we=Bf();we.__click=()=>g("excludeTags",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var T=f(F,2),q=d(T),Z=f(q,2);Z.__click=()=>{m("excludeTags",i(c)),b(c,"")};var ne=f(fe,2),I=f(d(ne),2);Fe(I,21,()=>i(n).excludeFilePatterns,nt,(ae,oe)=>{var we=Uf();we.__click=()=>g("excludeFilePatterns",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var M=f(I,2),ie=d(M),Ae=f(ie,2);Ae.__click=()=>{m("excludeFilePatterns",i(u)),b(u,"")};var Ie=f(ne,2),Ce=f(d(Ie),2);Fe(Ce,21,()=>y,nt,(ae,oe)=>{var we=zf(),tt=d(we);tt.__change=()=>_(i(oe));var ps=f(tt,2),ee=d(ps);j(ge=>{Fr(tt,ge),P(ee,i(oe))},[()=>i(n).excludeStatusTypes.includes(i(oe))]),S(ae,we)});var Ye=f(Ie,2);Ye.__click=R;var Pe=f(Y,2),lt=d(Pe),bt=f(d(lt),2),$e=d(bt);$e.__change=D;var Et=f(lt,2),vt=f(d(Et),2),Oe=f(Et,2),_t=d(Oe);_t.__click=D;var He=f(_t,2);He.__click=N;var Ve=f(He,2);Ve.__click=U;var Xe=f(Oe,2);{var Ot=ae=>{var oe=jf(),we=d(oe);j(()=>{Ke(oe,1,`validation ${i(p).valid?"success":"error"}`,"svelte-b8rwae"),P(we,i(p).message)}),S(ae,oe)};G(Xe,ae=>{i(p)&&ae(Ot)})}var Mt=f(Xe,2);{var zt=ae=>{var oe=Yf(),we=d(oe);j(()=>P(we,i(v))),S(ae,oe)};G(Mt,ae=>{i(v)&&ae(zt)})}Aa(te,()=>i(n).enabled,ae=>i(n).enabled=ae),at(X,()=>i(o),ae=>b(o,ae)),at(_e,()=>i(l),ae=>b(l,ae)),at(q,()=>i(c),ae=>b(c,ae)),at(ie,()=>i(u),ae=>b(u,ae)),Aa($e,()=>i(a).enabled,ae=>i(a).enabled=ae),at(vt,()=>i(a).query,ae=>i(a).query=ae),S(r,W),et()}ht(["change","click"]);var Wf=A('<button class="delete-btn svelte-1qw3eru">Delete</button>'),Gf=A('<span class="default-badge svelte-1qw3eru">Default</span>'),Qf=A('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),$f=A('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function Vf(r,e){Je(e,!0);let t=vs.getInstance(),s=K(ke([])),n=K(""),a=K(""),o=K(ke(st.TODO)),l=K("x");function c(){b(s,t.getAll(),!0)}function u(){if(!i(n).trim()||!i(a).trim()){Q.error("Symbol and name are required");return}if(i(n).length!==1){Q.error("Symbol must be a single character");return}const fe={symbol:i(n),name:i(a),type:i(o),nextStatusSymbol:i(l)},F=new xs(fe);t.register(F),c(),v(),Q.success(`Status "${i(a)}" added`)}function h(fe){if([" ","x","/","-"].includes(fe)){Q.error("Cannot delete default status");return}t.unregister(fe),c(),Q.success("Status deleted")}function p(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),c(),Q.success("Statuses reset to defaults"))}function v(){b(n,""),b(a,""),b(o,st.TODO,!0),b(l,"x")}yt(()=>{c()});var y=$f(),w=f(d(y),4),m=d(w),g=d(m),_=f(d(g));Fe(_,21,()=>i(s),nt,(fe,F)=>{var T=Qf(),q=d(T),Z=d(q),ne=d(Z),I=f(q),M=d(I),ie=f(I),Ae=d(ie),Ie=d(Ae),Ce=f(ie),Ye=d(Ce),Pe=d(Ye),lt=f(Ce),bt=d(lt),$e=d(bt),Et=f(lt),vt=d(Et);{var Oe=He=>{var Ve=Wf();Ve.__click=()=>h(i(F).symbol),S(He,Ve)},_t=He=>{var Ve=Gf();S(He,Ve)};G(vt,He=>{[" ","x","/","-"].includes(i(F).symbol)?He(_t,!1):He(Oe)})}j(()=>{P(ne,`[${i(F).symbol??""}]`),P(M,i(F).name),P(Ie,i(F).type),P(Pe,`[${i(F).nextStatusSymbol??""}]`),P($e,`- [${i(F).symbol??""}] Task example`)}),S(fe,T)});var E=f(w,2),D=f(d(E),2),x=d(D),R=d(x),U=f(d(R),2),N=f(R,2),W=f(d(N),2),Y=f(N,2),J=f(d(Y),2),re=d(J),te={},le=f(re),ye={},H=f(le),L={},C=f(H),z={},se=f(C),X={},me=f(Y,2),ve=f(d(me),2),he=f(me,2),Te=f(d(he),2);Te.__click=u;var _e=f(E,2),qe=d(_e);qe.__click=p,j(()=>{te!==(te=st.TODO)&&(re.value=(re.__value=st.TODO)??""),ye!==(ye=st.IN_PROGRESS)&&(le.value=(le.__value=st.IN_PROGRESS)??""),L!==(L=st.DONE)&&(H.value=(H.__value=st.DONE)??""),z!==(z=st.CANCELLED)&&(C.value=(C.__value=st.CANCELLED)??""),X!==(X=st.NON_TASK)&&(se.value=(se.__value=st.NON_TASK)??"")}),at(U,()=>i(n),fe=>b(n,fe)),at(W,()=>i(a),fe=>b(a,fe)),Du(J,()=>i(o),fe=>b(o,fe)),at(ve,()=>i(l),fe=>b(l,fe)),S(r,y),et()}ht(["click"]);var Xf=A('<button class="settings__close-btn svelte-1ke3hir">✕</button>'),Zf=A("<div> </div>"),Jf=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),ev=A('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),tv=A('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"><input class="settings__shortcut-input svelte-1ke3hir" type="text" placeholder="Unassigned"/> <div class="settings__shortcut-actions svelte-1ke3hir"><button class="settings__shortcut-btn svelte-1ke3hir" type="button">Save</button> <button class="settings__shortcut-btn settings__shortcut-btn--ghost svelte-1ke3hir" type="button">Reset</button></div> <div class="settings__shortcut-default svelte-1ke3hir"> </div></div></div>'),sv=A(`<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div> <button class="settings__shortcut-reset-all svelte-1ke3hir" type="button">Reset all shortcuts</button> <p class="settings__shortcut-note svelte-1ke3hir">Tip: You can also customize these in SiYuan's native shortcut settings.</p></section>`),rv=A('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),nv=A('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filtering & Query</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function av(r,e){Je(e,!0);let t=K(ke(Ca)),s=K(null),n=ke({}),a=K("general"),o=K(ke([])),l=K(ke({}));function c(){if(!e.shortcutManager){b(o,[],!0),b(l,{},!0);return}b(o,e.shortcutManager.getShortcutDisplay(),!0),b(l,i(o).reduce((H,L)=>(H[L.id]=L.currentHotkey||"",H),{}),!0)}function u(H,L){b(l,{...i(l),[H]:L},!0)}async function h(H){if(!e.shortcutManager)return;const L=await e.shortcutManager.updateShortcut(H,i(l)[H]??"");if(!L.success){Q.error(L.message||"Failed to update shortcut.");return}Q.success("Shortcut updated."),c()}async function p(H){e.shortcutManager&&(await e.shortcutManager.resetShortcut(H),Q.success("Shortcut reset."),c())}async function v(){e.shortcutManager&&(await e.shortcutManager.resetAllShortcuts(),Q.success("Shortcuts reset to defaults."),c())}yt(()=>{b(t,e.eventService.getConfig(),!0)}),yt(()=>{c()});async function y(){try{await e.eventService.saveConfig(i(t)),Q.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(H){Q.error("Failed to save settings: "+H)}}async function w(){b(s,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const H=await e.eventService.testConnection();n.n8n={success:H.success,message:H.success?"Test successful!":H.message||"Test failed. Check configuration."}}catch(H){n.n8n={success:!1,message:"Error: "+(H instanceof Error?H.message:String(H))}}finally{b(s,null)}}var m=nv(),g=d(m),_=f(d(g),2);{var E=H=>{var L=Xf();L.__click=function(...C){var z;(z=e.onClose)==null||z.apply(this,C)},S(H,L)};G(_,H=>{e.onClose&&H(E)})}var D=f(g,2),x=d(D),R=d(x);R.__click=()=>b(a,"general");var U=f(R,2);U.__click=()=>b(a,"filter");var N=f(U,2);N.__click=()=>b(a,"statuses");var W=f(N,2);W.__click=()=>b(a,"shortcuts");var Y=f(x,2),J=d(Y);{var re=H=>{var L=Jf(),C=d(L),z=f(d(C),2),se=d(z),X=f(C,2),me=f(d(X),2),ve=f(X,2),he=f(d(ve),2),Te=f(ve,2);Te.__click=w;var _e=d(Te),qe=f(Te,2);{var fe=F=>{var T=Zf(),q=d(T);j(()=>{Ke(T,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),P(q,n.n8n.message)}),S(F,T)};G(qe,F=>{n.n8n&&F(fe)})}j(()=>{me.disabled=!i(t).n8n.enabled,he.disabled=!i(t).n8n.enabled,Te.disabled=!i(t).n8n.enabled||i(s)==="n8n",P(_e,i(s)==="n8n"?"Testing...":"Test Connection")}),Aa(se,()=>i(t).n8n.enabled,F=>i(t).n8n.enabled=F),at(me,()=>i(t).n8n.webhookUrl,F=>i(t).n8n.webhookUrl=F),at(he,()=>i(t).n8n.sharedSecret,F=>i(t).n8n.sharedSecret=F),S(H,L)},te=H=>{var L=rt(),C=Ge(L);{var z=X=>{Kf(X,{get settingsService(){return e.settingsService},get repository(){return e.repository}})},se=X=>{var me=rt(),ve=Ge(me);{var he=_e=>{Vf(_e,{})},Te=_e=>{var qe=rt(),fe=Ge(qe);{var F=T=>{var q=sv(),Z=f(d(q),2);Fe(Z,21,()=>i(o),nt,(I,M)=>{var ie=tv(),Ae=d(ie),Ie=d(Ae),Ce=d(Ie),Ye=f(Ie,2),Pe=d(Ye),lt=f(Ye,2);{var bt=Xe=>{var Ot=ev(),Mt=d(Ot);j(()=>P(Mt,i(M).context)),S(Xe,Ot)};G(lt,Xe=>{i(M).context&&Xe(bt)})}var $e=f(Ae,2),Et=d($e);Et.__input=Xe=>u(i(M).id,Xe.currentTarget.value);var vt=f(Et,2),Oe=d(vt);Oe.__click=()=>h(i(M).id);var _t=f(Oe,2);_t.__click=()=>p(i(M).id);var He=f(vt,2),Ve=d(He);j(()=>{P(Ce,i(M).label),P(Pe,i(M).description),oi(Et,i(l)[i(M).id]??""),P(Ve,`Default: ${(i(M).defaultHotkey||"Unassigned")??""}`)}),S(I,ie)});var ne=f(Z,2);ne.__click=v,S(T,q)};G(fe,T=>{i(a)==="shortcuts"&&T(F)},!0)}S(_e,qe)};G(ve,_e=>{i(a)==="statuses"?_e(he):_e(Te,!1)},!0)}S(X,me)};G(C,X=>{i(a)==="filter"?X(z):X(se,!1)},!0)}S(H,L)};G(J,H=>{i(a)==="general"?H(re):H(te,!1)})}var le=f(D,2);{var ye=H=>{var L=rv(),C=d(L);C.__click=y,S(H,L)};G(le,H=>{i(a)==="general"&&H(ye)})}j(()=>{Ke(R,1,`settings__nav-btn ${i(a)==="general"?"active":""}`,"svelte-1ke3hir"),Ke(U,1,`settings__nav-btn ${i(a)==="filter"?"active":""}`,"svelte-1ke3hir"),Ke(N,1,`settings__nav-btn ${i(a)==="statuses"?"active":""}`,"svelte-1ke3hir"),Ke(W,1,`settings__nav-btn ${i(a)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),S(r,m),et()}ht(["click","input"]);var iv=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),ov=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),lv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),cv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),uv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),dv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),hv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),fv=A('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>Blocking</button> <button>High Priority</button></div>'),vv=A('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">📥 Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">📋 Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">📅 Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">✅ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">📁 Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">🔍 Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">📝 All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),pv=A('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">⚙️ Settings</button></div></div> <!></div>');function yv(r,e){Je(e,!0),qc(fi,e.settingsService.get().urgency);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let n=K("today"),a=K(!1),o=K(!1),l=K(void 0),c=K(ke(new Set)),u=K(ke([])),h=V(()=>Zu(i(u))),p=K(!1);const v=V(()=>["inbox","today","upcoming","done","projects","search","all"].includes(i(n))?`dashboard-tab-${i(n)}`:void 0),y=V(()=>()=>{let T=i(u);if(i(c).has("notDone")&&(T=T.filter(q=>q.status!=="done"&&q.status!=="cancelled")),i(c).has("dueToday")){const q=new Date;q.setHours(0,0,0,0);const Z=new Date(q);Z.setDate(Z.getDate()+1),T=T.filter(ne=>{if(!ne.dueAt)return!1;const I=new Date(ne.dueAt);return I>=q&&I<Z})}if(i(c).has("overdue")){const q=new Date;q.setHours(0,0,0,0),T=T.filter(Z=>!Z.dueAt||Z.status==="done"||Z.status==="cancelled"?!1:new Date(Z.dueAt)<q)}return i(c).has("inProgress")&&(T=T.filter(q=>q.status==="todo"&&q.statusSymbol&&q.statusSymbol!==" ")),i(c).has("blocked")&&(T=T.filter(q=>Qu(q,i(u)))),i(c).has("blocking")&&(T=T.filter(q=>$u(q,i(u)))),i(c).has("highPriority")&&(T=T.filter(q=>{const Z=Qr(q.priority)||"normal";return Z==="high"||Z==="highest"})),T}),w=V(()=>i(u).filter(T=>T.status!=="done"&&T.status!=="cancelled"&&!T.dueAt&&!T.scheduledAt&&!T.startAt).length),m=V(()=>()=>{const T=new Date;T.setHours(0,0,0,0);const q=new Date(T);return q.setDate(q.getDate()+7),i(u).filter(Z=>{if(Z.status==="done"||Z.status==="cancelled"||!Z.dueAt)return!1;const ne=new Date(Z.dueAt);return ne.setHours(0,0,0,0),ne>T&&ne<=q}).length}),g=V(()=>()=>{const T=new Date;return T.setDate(T.getDate()-30),T.setHours(0,0,0,0),i(u).filter(q=>q.status!=="done"||!q.doneAt?!1:new Date(q.doneAt)>=T).length}),_=V(()=>i(u).filter(T=>T.status!=="done"&&T.status!=="cancelled").length);function E(T="initial"){b(p,!0),b(u,e.repository.getAllTasks().map(q=>({...q})),!0),b(p,!1),T!=="initial"&&Q.info("Task list reloaded")}E();const D=()=>E("reload");Tn(()=>{window.addEventListener("recurring-task-refresh",D)}),Iu(()=>{window.removeEventListener("recurring-task-refresh",D)});async function x(T){ze.emit("task: complete",{taskId:T.id})}async function R(T){const q=i(u),Z=da(i(u),T.id,ne=>{const I={...ne},M=new Date(I.dueAt),ie=t.tomorrow();return ie.setHours(M.getHours(),M.getMinutes(),0,0),I.dueAt=ie.toISOString(),I.snoozeCount=(I.snoozeCount||0)+1,I.updatedAt=new Date().toISOString(),I});b(u,Z,!0),Q.info(`Task "${T.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",T),await e.scheduler.delayToTomorrow(T.id)}catch(ne){b(u,q,!0),Q.error("Failed to delay task:  "+ne),E("external")}}async function U(T){var Z;if(!((Z=T.name)!=null&&Z.trim())){Q.error("Task name is required");return}if(!kl(T.frequency)){Q.error("Invalid frequency configuration");return}const q={...T};b(u,ua(i(u),q),!0),b(a,!1),b(l,void 0),Q.success(`Task "${T.name}" saved successfully`),e.repository.saveTask(q).catch(ne=>{Q.error("Failed to save task: "+ne),E("external")})}async function N(T){const q=i(u);b(u,Zi(i(u),T.id),!0);const Z=window.setTimeout(async()=>{try{await e.repository.deleteTask(T.id)}catch(ne){b(u,q,!0),Q.error("Failed to delete task: "+ne),E("external")}},5e3);cr({message:`Task "${T.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(Z),b(u,q,!0),Q.info(`Restored "${T.name}"`)},showCountdown:!0})}async function W(T){const q=T.name.endsWith(" (copy)")?`${T.name} ${new Date().toLocaleDateString()}`:`${T.name} (copy)`,Z=Dl(T,{name:q});b(u,ua(i(u),Z),!0),Q.success(`Duplicated "${T.name}"`),e.repository.saveTask(Z).catch(ne=>{b(u,Zi(i(u),Z.id),!0),Q.error("Failed to duplicate task: "+ne),E("external")})}async function Y(T){const q=!T.enabled,Z={...T,enabled:q},ne=da(i(u),T.id,()=>Z);b(u,ne,!0),Q.info(`Task ${q?"enabled":"disabled"}`),e.repository.saveTask(Z).catch(I=>{Q.error("Failed to update task: "+I),E("external")})}async function J(T,q){if(T.length===0)return;const Z=i(u),ne=new Set(T),I=i(u).map(M=>ne.has(M.id)?{...M,enabled:q}:M);b(u,I,!0),Q.info(`${q?"Enabled":"Disabled"} ${T.length} task${T.length===1?"":"s"}`);try{const M=I.filter(ie=>ne.has(ie.id));await Promise.all(M.map(ie=>e.repository.saveTask(ie)))}catch(M){b(u,Z,!0),Q.error(`Failed to ${q?"enable":"disable"} tasks: ${M}`),E("external")}}async function re(T){if(T.length===0)return;const q=i(u),Z=new Set(T),ne=i(u).filter(M=>Z.has(M.id));b(u,i(u).filter(M=>!Z.has(M.id)),!0);const I=window.setTimeout(async()=>{try{await Promise.all(ne.map(M=>e.repository.deleteTask(M.id)))}catch(M){b(u,q,!0),Q.error("Failed to delete tasks: "+M),E("external")}},5e3);cr({message:`${ne.length} task${ne.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(I),b(u,q,!0),Q.info("Bulk delete undone")},showCountdown:!0})}function te(T){b(l,T,!0),b(a,!0)}function le(){b(l,void 0),b(a,!0)}function ye(){b(a,!1),b(l,void 0)}function H(){b(o,!0)}function L(){b(o,!1)}async function C(T){const q=i(u),Z=da(i(u),T.id,ne=>{const I={...ne};El(I);const M=s.calculateNext(new Date(I.dueAt),I.frequency);return I.dueAt=M.toISOString(),I});b(u,Z,!0),Q.info(`Task "${T.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",T),await e.scheduler.skipTaskOccurrence(T.id)}catch(ne){b(u,q,!0),Q.error("Failed to skip task: "+ne),E("external")}}function z(T){const q=new Set(i(c));q.has(T)?q.delete(T):q.add(T),b(c,q,!0)}async function se(T){const q={...T,status:"todo",doneAt:void 0};b(u,ua(i(u),q),!0),Q.success(`Task "${T.name}" marked as not done`),e.repository.saveTask(q).catch(Z=>{Q.error("Failed to update task: "+Z),E("external")})}var X=pv(),me=d(X),ve=f(d(me),2),he=d(ve);he.__click=()=>E("reload");var Te=d(he),_e=f(he,2);_e.__click=H;var qe=f(me,2);{var fe=T=>{var q=iv(),Z=d(q);av(Z,{get eventService(){return e.eventService},get shortcutManager(){return e.shortcutManager},get settingsService(){return e.settingsService},get repository(){return e.repository},onClose:L}),S(T,q)},F=T=>{var q=rt(),Z=Ge(q);{var ne=M=>{var ie=ov(),Ae=d(ie);Ml(Ae,{get task(){return i(l)},get repository(){return e.repository},onSave:U,onClose:ye}),S(M,ie)},I=M=>{var ie=vv(),Ae=Ge(ie),Ie=d(Ae);Ie.__click=()=>b(n,"inbox");var Ce=f(d(Ie));{var Ye=ce=>{var Se=lv(),Ue=d(Se);j(()=>P(Ue,i(w))),S(ce,Se)};G(Ce,ce=>{i(w)>0&&ce(Ye)})}var Pe=f(Ie,2);Pe.__click=()=>b(n,"today");var lt=f(d(Pe));{var bt=ce=>{var Se=cv(),Ue=d(Se);j(()=>P(Ue,i(h).length)),S(ce,Se)};G(lt,ce=>{i(h).length>0&&ce(bt)})}var $e=f(Pe,2);$e.__click=()=>b(n,"upcoming");var Et=f(d($e));{var vt=ce=>{var Se=uv(),Ue=d(Se);j(()=>P(Ue,i(m))),S(ce,Se)};G(Et,ce=>{i(m)>0&&ce(vt)})}var Oe=f($e,2);Oe.__click=()=>b(n,"done");var _t=f(d(Oe));{var He=ce=>{var Se=dv(),Ue=d(Se);j(()=>P(Ue,i(g))),S(ce,Se)};G(_t,ce=>{i(g)>0&&ce(He)})}var Ve=f(Oe,2);Ve.__click=()=>b(n,"projects");var Xe=f(d(Ve));{var Ot=ce=>{var Se=hv(),Ue=d(Se);j(()=>P(Ue,i(_))),S(ce,Se)};G(Xe,ce=>{i(_)>0&&ce(Ot)})}var Mt=f(Ve,2);Mt.__click=()=>b(n,"search");var zt=f(Mt,2);zt.__click=()=>b(n,"all");var ae=f(d(zt)),oe=d(ae),we=f(Ae,2);{var tt=ce=>{var Se=fv(),Ue=f(d(Se),2);Ue.__click=()=>z("notDone");var Ze=f(Ue,2);Ze.__click=()=>z("dueToday");var ct=f(Ze,2);ct.__click=()=>z("overdue");var ut=f(ct,2);ut.__click=()=>z("inProgress");var Nt=f(ut,2);Nt.__click=()=>z("blocked");var Vt=f(Nt,2);Vt.__click=()=>z("blocking");var xt=f(Vt,2);xt.__click=()=>z("highPriority"),j((os,jt,ls,zs,Yt,B,ue)=>{Ke(Ue,1,`dashboard__filter-btn ${os??""}`,"svelte-1y1a8hs"),Ke(Ze,1,`dashboard__filter-btn ${jt??""}`,"svelte-1y1a8hs"),Ke(ct,1,`dashboard__filter-btn ${ls??""}`,"svelte-1y1a8hs"),Ke(ut,1,`dashboard__filter-btn ${zs??""}`,"svelte-1y1a8hs"),Ke(Nt,1,`dashboard__filter-btn ${Yt??""}`,"svelte-1y1a8hs"),Ke(Vt,1,`dashboard__filter-btn ${B??""}`,"svelte-1y1a8hs"),Ke(xt,1,`dashboard__filter-btn ${ue??""}`,"svelte-1y1a8hs")},[()=>i(c).has("notDone")?"active":"",()=>i(c).has("dueToday")?"active":"",()=>i(c).has("overdue")?"active":"",()=>i(c).has("inProgress")?"active":"",()=>i(c).has("blocked")?"active":"",()=>i(c).has("blocking")?"active":"",()=>i(c).has("highPriority")?"active":""]),S(ce,Se)};G(we,ce=>{i(n)!=="search"&&i(n)!=="timeline"&&i(n)!=="analytics"&&ce(tt)})}var ps=f(we,2),ee=d(ps);{var ge=ce=>{{let Se=V(()=>i(c).size>0?i(y):i(u));sh(ce,{get tasks(){return i(Se)},onEdit:te,onDone:x,onDelete:N})}},Be=ce=>{var Se=rt(),Ue=Ge(Se);{var Ze=ut=>{{let Nt=V(()=>i(c).size>0?i(y).filter(Vt=>i(h).some(xt=>xt.id===Vt.id)):i(h));Td(ut,{get tasks(){return i(Nt)},onDone:x,onDelay:R,onSkip:C,onEdit:te,get timezoneHandler(){return t}})}},ct=ut=>{var Nt=rt(),Vt=Ge(Nt);{var xt=jt=>{{let ls=V(()=>i(c).size>0?i(y):i(u));oh(jt,{get tasks(){return i(ls)},onEdit:te,onDone:x,onDelete:N})}},os=jt=>{var ls=rt(),zs=Ge(ls);{var Yt=ue=>{{let it=V(()=>i(c).size>0?i(y):i(u));vh(ue,{get tasks(){return i(it)},onEdit:te,onDelete:N,onUncomplete:se})}},B=ue=>{var it=rt(),Ds=Ge(it);{var Xt=Dr=>{{let Sn=V(()=>i(c).size>0?i(y):i(u));_h(Dr,{get tasks(){return i(Sn)},onEdit:te,onDone:x,onDelete:N})}},Sr=Dr=>{var Sn=rt(),Hl=Ge(Sn);{var Kl=Er=>{of(Er,{get tasks(){return i(u)},onEdit:te,onDone:x,onDelete:N})},Wl=Er=>{var _i=rt(),Gl=Ge(_i);{var Ql=xr=>{{let Dn=V(()=>i(c).size>0?i(y):i(u));Md(xr,{get tasks(){return i(Dn)},onEdit:te,onDelete:N,onDuplicate:W,onToggleEnabled:Y,onBulkEnable:tn=>J(tn,!0),onBulkDisable:tn=>J(tn,!1),onBulkDelete:re,onCreate:le})}},$l=xr=>{var Dn=rt(),tn=Ge(Dn);{var Vl=Ar=>{zd(Ar,{get tasks(){return i(u)},get recurrenceEngine(){return s}})},Xl=Ar=>{var ki=rt(),Zl=Ge(ki);{var Jl=sa=>{Zd(sa,{get tasks(){return i(u)}})};G(Zl,sa=>{i(n)==="analytics"&&sa(Jl)},!0)}S(Ar,ki)};G(tn,Ar=>{i(n)==="timeline"?Ar(Vl):Ar(Xl,!1)},!0)}S(xr,Dn)};G(Gl,xr=>{i(n)==="all"?xr(Ql):xr($l,!1)},!0)}S(Er,_i)};G(Hl,Er=>{i(n)==="search"?Er(Kl):Er(Wl,!1)},!0)}S(Dr,Sn)};G(Ds,Dr=>{i(n)==="projects"?Dr(Xt):Dr(Sr,!1)},!0)}S(ue,it)};G(zs,ue=>{i(n)==="done"?ue(Yt):ue(B,!1)},!0)}S(jt,ls)};G(Vt,jt=>{i(n)==="upcoming"?jt(xt):jt(os,!1)},!0)}S(ut,Nt)};G(Ue,ut=>{i(n)==="today"?ut(Ze):ut(ct,!1)},!0)}S(ce,Se)};G(ee,ce=>{i(n)==="inbox"?ce(ge):ce(Be,!1)})}j(()=>{Ke(Ie,1,`dashboard__tab ${i(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),Ee(Ie,"aria-selected",i(n)==="inbox"),Ke(Pe,1,`dashboard__tab ${i(n)==="today"?"active":""}`,"svelte-1y1a8hs"),Ee(Pe,"aria-selected",i(n)==="today"),Ke($e,1,`dashboard__tab ${i(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),Ee($e,"aria-selected",i(n)==="upcoming"),Ke(Oe,1,`dashboard__tab ${i(n)==="done"?"active":""}`,"svelte-1y1a8hs"),Ee(Oe,"aria-selected",i(n)==="done"),Ke(Ve,1,`dashboard__tab ${i(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),Ee(Ve,"aria-selected",i(n)==="projects"),Ke(Mt,1,`dashboard__tab ${i(n)==="search"?"active":""}`,"svelte-1y1a8hs"),Ee(Mt,"aria-selected",i(n)==="search"),Ke(zt,1,`dashboard__tab ${i(n)==="all"?"active":""}`,"svelte-1y1a8hs"),Ee(zt,"aria-selected",i(n)==="all"),P(oe,i(u).length),Ee(ps,"aria-labelledby",i(v))}),S(M,ie)};G(Z,M=>{i(a)?M(ne):M(I,!1)},!0)}S(T,q)};G(qe,T=>{i(o)?T(fe):T(F,!1)})}j(()=>{he.disabled=i(p),P(Te,i(p)?"⟳":"↻")}),S(r,X),et()}ht(["click"]);var mv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),gv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),bv=A('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),_v=A('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),kv=A('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">✕</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ⌘/Ctrl + Enter to save.</p></div></div>');function wv(r,e){var L;Je(e,!0);let t=K(ke(((L=e.prefill)==null?void 0:L.suggestedName)??"")),s=K(ke(new Date().toISOString().slice(0,16))),n=K(ke({name:!1,dueAt:!1})),a=K(!1),o=K(null);const l=V(()=>i(n).name&&!i(t).trim()?"Task name is required.":""),c=V(()=>i(n).dueAt?i(s)?Number.isNaN(new Date(i(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=V(()=>!!(i(l)||i(c)));Tn(()=>{var C;if((C=e.prefill)!=null&&C.suggestedTime){const z=new Date,[se,X]=e.prefill.suggestedTime.split(":").map(Number);z.setHours(se,X,0,0),b(s,z.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var z;(z=i(o))==null||z.focus()})});async function h(){var X,me;if(b(n,{name:!0,dueAt:!0},!0),i(u)){Q.warning("Please fill out the required fields.");return}const C=Mu(),z=i(s).slice(11,16);if(C.time=z,!kl(C)){Q.error("Invalid frequency configuration.");return}const se=Tl(i(t).trim(),C,new Date(i(s)));se.linkedBlockId=((X=e.prefill)==null?void 0:X.linkedBlockId)||void 0,se.linkedBlockContent=((me=e.prefill)==null?void 0:me.linkedBlockContent)||void 0,b(a,!0);try{await e.repository.saveTask(se),Q.success(`Task "${se.name}" created`),ze.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(ve){Q.error("Failed to create task: "+ve)}finally{b(a,!1)}}function p(C){C.key==="Escape"&&e.onClose(),(C.metaKey||C.ctrlKey)&&C.key==="Enter"&&(C.preventDefault(),h())}var v=kv();v.__keydown=p;var y=d(v),w=d(y),m=f(d(w),2);m.__click=function(...C){var z;(z=e.onClose)==null||z.apply(this,C)};var g=f(w,2),_=f(d(g),2);_.__input=()=>i(n).name=!0,fs(_,C=>b(o,C),()=>i(o));var E=f(_,2);{var D=C=>{var z=mv(),se=d(z);j(()=>P(se,i(l))),S(C,z)};G(E,C=>{i(l)&&C(D)})}var x=f(g,2),R=f(d(x),2);R.__input=()=>i(n).dueAt=!0;var U=f(R,2);{var N=C=>{var z=gv(),se=d(z);j(()=>P(se,i(c))),S(C,z)};G(U,C=>{i(c)&&C(N)})}var W=f(x,2);{var Y=C=>{var z=bv(),se=f(d(z)),X=d(se);j(()=>P(X,e.prefill.linkedBlockId)),S(C,z)};G(W,C=>{var z;(z=e.prefill)!=null&&z.linkedBlockId&&C(Y)})}var J=f(W,2),re=d(J);re.__click=function(...C){var z;(z=e.onClose)==null||z.apply(this,C)};var te=f(re,2);{var le=C=>{var z=_v();z.__click=function(...se){var X;(X=e.onAdvanced)==null||X.apply(this,se)},S(C,z)};G(te,C=>{e.onAdvanced&&C(le)})}var ye=f(te,2);ye.__click=h;var H=d(ye);j(()=>{Ee(_,"aria-invalid",!!i(l)),Ee(R,"aria-invalid",!!i(c)),ye.disabled=i(a),P(H,i(a)?"Saving…":"Create Task")}),St("blur",_,()=>i(n).name=!0),at(_,()=>i(t),C=>b(t,C)),St("blur",R,()=>i(n).dueAt=!0),at(R,()=>i(s),C=>b(s,C)),S(r,v),et()}ht(["keydown","click","input"]);var Tv=A('<button class="postpone-card__option svelte-tkdeu6" type="button" role="listitem"> </button>'),Sv=A('<div class="postpone-overlay svelte-tkdeu6" role="dialog" aria-modal="true" aria-labelledby="postpone-title"><div class="postpone-card svelte-tkdeu6" role="document"><div class="postpone-card__header svelte-tkdeu6"><h2 id="postpone-title" class="svelte-tkdeu6">Postpone task</h2> <button class="postpone-card__close svelte-tkdeu6" type="button" aria-label="Close">✕</button></div> <p class="postpone-card__summary svelte-tkdeu6">Choose a new due offset for <strong> </strong>.</p> <div class="postpone-card__options svelte-tkdeu6" role="list"></div> <div class="postpone-card__actions svelte-tkdeu6"><button class="postpone-card__cancel svelte-tkdeu6" type="button">Cancel</button></div></div></div>');function Dv(r,e){Je(e,!0);let t=K(null);function s(m,g){g&&b(t,m,!0)}Tn(()=>{requestAnimationFrame(()=>{var m;(m=i(t))==null||m.focus()})});function n(m){m.key==="Escape"&&e.onClose()}var a=Sv();a.__keydown=n;var o=d(a),l=d(o),c=f(d(l),2);c.__click=function(...m){var g;(g=e.onClose)==null||g.apply(this,m)};var u=f(l,2),h=f(d(u)),p=d(h),v=f(u,2);Fe(v,21,()=>Pu,nt,(m,g,_)=>{var E=Tv();E.__click=()=>e.onSelect(i(g).minutes);var D=d(E);bu(E,(x,R)=>s==null?void 0:s(x,R),()=>_===0),j(()=>P(D,i(g).label)),S(m,E)});var y=f(v,2),w=d(y);w.__click=function(...m){var g;(g=e.onClose)==null||g.apply(this,m)},j(()=>P(p,e.taskName)),S(r,a),et()}ht(["keydown","click"]);class Ev{constructor(e){k(this,"plugin");this.plugin=e}getCurrentVersion(){return Ys}async createBackup(e,t){try{const s=await this.plugin.loadData(e);if(s){const n=new Date().toISOString().replace(/[:.]/g,"-"),a=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${a}-${n}`;return await this.plugin.saveData(o,s),de(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(s){throw be("Failed to create backup",s),s}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return de("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Ys};const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0)return de("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Ys};let n=!1,a,o,l=0;for(let c=0;c<s.length;c++){const u=s[c],h=u.version||0;h<Ys&&(n||(o=h,a=await this.createBackup(e,h),n=!0),s[c]=this.migrateTask(u,h),l++,de(`Migrated task ${u.id} from v${h} to v${Ys}`))}if(n){const c=Array.isArray(t)?s:{...t,tasks:s};return await this.plugin.saveData(e,c),de(`Migration complete: ${l} tasks migrated`),{migrated:!0,tasksAffected:l,fromVersion:o,toVersion:Ys,backupKey:a}}else return de("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:Ys}}catch(t){throw be("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),t<4&&(s={...s,version:4,onCompletion:s.onCompletion||"keep",dependsOn:s.dependsOn||[],blockedBy:s.blockedBy||[]}),s}}class xv{constructor(e,t=50){k(this,"pendingState",null);k(this,"writeInProgress",!1);k(this,"scheduledTimer",null);k(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){be("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return be("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const qa={},Av=Object.freeze(Object.defineProperty({__proto__:null,default:qa},Symbol.toStringTag,{value:"Module"})),ro=new Set;function Rn(r){const e=`${r.feature}:${r.capability}:${r.message}`;ro.has(e)||(ro.add(e),Qe(r.message,{feature:r.feature,capability:r.capability,cause:r.cause}))}class Nl extends Error{constructor(t,s,n){super(n);k(this,"capability");k(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class ql extends Error{constructor(t,s,n,a){super(n);k(this,"capability");k(this,"feature");k(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=a}}class Cv{constructor(e=globalThis){k(this,"supportedCapabilities");k(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,n;return typeof((n=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(n){throw new ql("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new Nl("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Iv=".tmp";class Ov{constructor(e,t){k(this,"plugin");k(this,"apiAdapter");k(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(lr);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){be("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),de(`Saved ${e.tasks.length} active tasks`)}catch(t){throw be("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(lr,e);return}const s=this.resolveStoragePath(lr);if(!s){await this.plugin.saveData(lr,e);return}const n=qa.dirname(s);await t.mkdir(n,{recursive:!0});const a=`${s}${Iv}`,o=JSON.stringify(e),l=await t.open(a,"w");try{await l.writeFile(o,"utf8"),await l.sync()}finally{await l.close()}try{await t.rename(a,s)}catch{await t.rm(s,{force:!0}),await t.rename(a,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>Av);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Qe("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Rn({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):qa.join(t,"storage",`p${s}`,`${e}.json`)}}const no=1,ao=1e3;class Mv{constructor(e){k(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[n,a]of s.entries())await this.appendTasksToYear(t,n,a);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),n=[];for(const l of s){const c=await this.loadChunk(l.key);if(c)for(const u of c.tasks)this.matchesQuery(u,e)&&n.push(u)}const a=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(a,a+o)}async loadIndex(){try{const e=await this.plugin.loadData(Nn);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??no,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){be("Failed to load archive index",e)}return{version:no,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Nn,e)}catch(t){throw be("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Nn}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){be("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw be("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const n=this.getCompletionTimestamp(s),a=new Date(n).getFullYear(),o=t.get(a);o?o.push(s):t.set(a,[s])}return t}async appendTasksToYear(e,t,s){let n=[...s];for(;n.length>0;){const a=this.findOrCreateChunk(e,t),o=await this.loadChunk(a.key)||{tasks:[]},l=ao-o.tasks.length,c=n.slice(0,l);o.tasks.push(...c),n=n.slice(c.length);const u=this.updateChunkMeta(a,c);a.count=u.count,a.start=u.start,a.end=u.end,await this.saveChunk(a.key,o),e.totalCount+=c.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(l=>l.year===t).sort((l,c)=>l.sequence-c.sequence).at(-1);if(n&&n.count<ao)return n;const a=n?n.sequence+1:1,o={key:this.buildChunkKey(t,a),year:t,sequence:a,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,n=e.end;for(const a of t){const o=this.getCompletionTimestamp(a);(!s||o<s)&&(s=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:s,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(a=>{const o=a.start?new Date(a.start).getTime():null,l=a.end?new Date(a.end).getTime():null;return!(s&&l&&l<s||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),n=new Date(s).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Nv{constructor(e,t=new Cv){k(this,"plugin");k(this,"activeTasks");k(this,"blockIndex",new Map);k(this,"taskBlockIndex",new Map);k(this,"dueIndex",new Map);k(this,"activeStore");k(this,"archiveStore");k(this,"persistence");k(this,"blockAttrSyncEnabled",!0);k(this,"blockApi");k(this,"apiAdapter");k(this,"syncRetryQueue",new Map);k(this,"retryProcessorInterval");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Ov(e,t),this.archiveStore=new Mv(e),this.persistence=new xv(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),de(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex(),this.startSyncRetryProcessor()}async loadActiveTasks(e=1e3,t){const s=await this.activeStore.loadActive(),n=Array.from(s.values()),a=n.length;if(a===0)return[];const o=[];for(let l=0;l<a;l+=e){const c=n.slice(l,Math.min(l+e,a));o.push(...c),t&&t(o.length,a),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));de(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);de(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[n]of this.dueIndex)n<=t&&s.push(...this.getTasksForDueKey(n));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const n of t){const a=this.activeTasks.get(n);if(!a){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!a.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(a.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}s.push(a)}return s}removeStaleDueIndexEntry(e,t,s){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),Qe("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id);if(t&&e.version!==void 0&&t.version!==void 0&&e.version<t.version)throw new Error(`Concurrent modification detected for task "${e.name}". Please refresh and try again.`);e.version=(e.version??0)+1;const s=this.activeTasks.get(e.id),n=this.taskBlockIndex.get(e.id);n&&n!==e.linkedBlockId&&(this.blockIndex.delete(n),this.taskBlockIndex.delete(e.id)),s&&s.enabled&&(s.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(s),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrsWithRetry(e),n&&n!==e.linkedBlockId&&await this.clearBlockAttrs(n)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Gi]:e.id,[Qi]:e.dueAt,[$i]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Gi]:"",[Qi]:"",[$i]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Rn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof Nl||s instanceof ql?Rn({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Rn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const n=new Date(s.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(lr);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(Fi);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(Pi,t),de(`Created legacy backup at ${Pi}`);const n=s.filter(l=>!l.enabled&&l.lastCompletedAt),a=s.filter(l=>!n.includes(l)),o=new Map(a.map(l=>[l.id,l]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),de("Legacy storage migration complete",{activeCount:a.length,archivedCount:n.length,legacyKey:Fi,activeKey:lr,archiveIndexKey:Nn})}async syncTaskToBlockAttrsWithRetry(e){try{await this.syncTaskToBlockAttrs(e),this.syncRetryQueue.delete(e.id)}catch(t){const s=this.syncRetryQueue.get(e.id)||{task:e,attempts:0,nextRetry:Date.now()};s.attempts<In?(s.attempts++,s.nextRetry=Date.now()+Vi[s.attempts-1],s.task=e,this.syncRetryQueue.set(e.id,s),Qe(`Block sync failed for task ${e.id}, added to retry queue`,{taskId:e.id,attempts:s.attempts,nextRetry:new Date(s.nextRetry).toISOString(),error:t instanceof Error?t.message:String(t)})):(be(`Block sync failed for task ${e.id} after ${In} attempts`,{taskId:e.id,error:t instanceof Error?t.message:String(t)}),this.syncRetryQueue.delete(e.id))}}startSyncRetryProcessor(){this.retryProcessorInterval&&clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=setInterval(async()=>{const e=Date.now(),t=[];for(const[s,n]of this.syncRetryQueue.entries())n.nextRetry<=e&&t.push({id:s,entry:n});for(const{id:s,entry:n}of t)try{await this.syncTaskToBlockAttrs(n.task),this.syncRetryQueue.delete(s),de(`Block sync retry succeeded for task ${s}`,{taskId:s,attempts:n.attempts})}catch(a){n.attempts<In?(n.attempts++,n.nextRetry=Date.now()+Vi[n.attempts-1],this.syncRetryQueue.set(s,n),Qe(`Block sync retry failed for task ${s}`,{taskId:s,attempts:n.attempts,nextRetry:new Date(n.nextRetry).toISOString(),error:a instanceof Error?a.message:String(a)})):(be(`Block sync retry exhausted for task ${s} after ${In} attempts`,{taskId:s,error:a instanceof Error?a.message:String(a)}),this.syncRetryQueue.delete(s))}},zu)}stopSyncRetryProcessor(){this.retryProcessorInterval&&(clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=void 0)}}class qv{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}var Ra=["MO","TU","WE","TH","FR","SA","SU"],Rt=function(){function r(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return r.fromStr=function(e){return new r(Ra.indexOf(e))},r.prototype.nth=function(e){return this.n===e?this:new r(this.weekday,e)},r.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},r.prototype.toString=function(){var e=Ra[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},r.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},r}(),ot=function(r){return r!=null},ys=function(r){return typeof r=="number"},io=function(r){return typeof r=="string"&&Ra.includes(r)},Gt=Array.isArray,Ss=function(r,e){e===void 0&&(e=r),arguments.length===1&&(e=r,r=0);for(var t=[],s=r;s<e;s++)t.push(s);return t},Re=function(r,e){var t=0,s=[];if(Gt(r))for(;t<e;t++)s[t]=[].concat(r);else for(;t<e;t++)s[t]=r;return s},Rv=function(r){return Gt(r)?r:[r]};function Or(r,e,t){t===void 0&&(t=" ");var s=String(r);return e=e>>0,s.length>e?String(s):(e=e-s.length,e>t.length&&(t+=Re(t,e/t.length)),t.slice(0,e)+String(s))}var Lv=function(r,e,t){var s=r.split(e);return t?s.slice(0,t).concat([s.slice(t).join(e)]):s},ns=function(r,e){var t=r%e;return t*e<0?t+e:t},ha=function(r,e){return{div:Math.floor(r/e),mod:ns(r,e)}},ws=function(r){return!ot(r)||r.length===0},pt=function(r){return!ws(r)},We=function(r,e){return pt(r)&&r.indexOf(e)!==-1},wr=function(r,e,t,s,n,a){return s===void 0&&(s=0),n===void 0&&(n=0),a===void 0&&(a=0),new Date(Date.UTC(r,e-1,t,s,n,a))},Fv=[31,28,31,30,31,30,31,31,30,31,30,31],Rl=1e3*60*60*24,Ll=9999,Fl=wr(1970,1,1),Pv=[6,0,1,2,3,4,5],un=function(r){return r%4===0&&r%100!==0||r%400===0},Pl=function(r){return r instanceof Date},nn=function(r){return Pl(r)&&!isNaN(r.getTime())},Bv=function(r,e){var t=r.getTime(),s=e.getTime(),n=t-s;return Math.round(n/Rl)},La=function(r){return Bv(r,Fl)},Bl=function(r){return new Date(Fl.getTime()+r*Rl)},Uv=function(r){var e=r.getUTCMonth();return e===1&&un(r.getUTCFullYear())?29:Fv[e]},Vr=function(r){return Pv[r.getUTCDay()]},oo=function(r,e){var t=wr(r,e+1,1);return[Vr(t),Uv(t)]},Ul=function(r,e){return e=e||r,new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Fa=function(r){var e=new Date(r.getTime());return e},lo=function(r){for(var e=[],t=0;t<r.length;t++)e.push(Fa(r[t]));return e},yn=function(r){r.sort(function(e,t){return e.getTime()-t.getTime()})},pi=function(r,e){e===void 0&&(e=!0);var t=new Date(r);return[Or(t.getUTCFullYear().toString(),4,"0"),Or(t.getUTCMonth()+1,2,"0"),Or(t.getUTCDate(),2,"0"),"T",Or(t.getUTCHours(),2,"0"),Or(t.getUTCMinutes(),2,"0"),Or(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},yi=function(r){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(r);if(!t)throw new Error("Invalid UNTIL value: ".concat(r));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},co=function(r,e){var t=r.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},zv=function(r,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,s=new Date(co(r,t)),n=new Date(co(r,e??"UTC")),a=n.getTime()-s.getTime();return new Date(r.getTime()-a)},Rr=function(){function r(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return r.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,s=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(s)return!1}else if(this.method==="before"){if(s)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},r.prototype.add=function(e){return this._result.push(e),!0},r.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},r.prototype.clone=function(){return new r(this.method,this.args)},r}(),Pa=function(r,e){return Pa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])},Pa(r,e)};function mi(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Pa(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var $t=function(){return $t=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},$t.apply(this,arguments)};function $(r,e,t){if(t||arguments.length===2)for(var s=0,n=e.length,a;s<n;s++)(a||!(s in e))&&(a||(a=Array.prototype.slice.call(e,0,s)),a[s]=e[s]);return r.concat(a||Array.prototype.slice.call(e))}var uo=function(r){mi(e,r);function e(t,s,n){var a=r.call(this,t,s)||this;return a.iterator=n,a}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Rr),jn={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},ho=function(r,e){return r.indexOf(e)!==-1},jv=function(r){return r.toString()},Yv=function(r,e,t){return"".concat(e," ").concat(t,", ").concat(r)},Us=function(){function r(e,t,s,n){if(t===void 0&&(t=jv),s===void 0&&(s=jn),n===void 0&&(n=Yv),this.text=[],this.language=s||jn,this.gettext=t,this.dateFormatter=n,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var a=[].concat(this.options.bymonthday),o=[].concat(this.options.bynmonthday);a.sort(function(h,p){return h-p}),o.sort(function(h,p){return p-h}),this.bymonthday=a.concat(o),this.bymonthday.length||(this.bymonthday=null)}if(ot(this.origOptions.byweekday)){var l=Gt(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],c=String(l);this.byweekday={allWeeks:l.filter(function(h){return!h.n}),someWeeks:l.filter(function(h){return!!h.n}),isWeekdays:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")===-1&&c.indexOf("SU")===-1,isEveryDay:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")!==-1&&c.indexOf("SU")!==-1};var u=function(h,p){return h.weekday-p.weekday};this.byweekday.allWeeks.sort(u),this.byweekday.someWeeks.sort(u),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return r.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in r.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var s in e.origOptions){if(ho(["dtstart","tzid","wkst","freq"],s))return!0;if(!ho(r.IMPLEMENTED[e.options.freq],s))return!1}return t},r.prototype.isFullyConvertible=function(){return r.isFullyConvertible(this.rrule)},r.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in r.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[pe.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},r.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},r.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},r.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},r.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},r.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},r.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},r.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},r.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},r.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},r.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},r.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,s=this.gettext;if(e===-1)return s("last");var n=Math.abs(e);switch(n){case 1:case 21:case 31:t=n+s("st");break;case 2:case 22:t=n+s("nd");break;case 3:case 23:t=n+s("rd");break;default:t=n+s("th")}return e<0?t+" "+s("last"):t},r.prototype.monthtext=function(e){return this.language.monthNames[e-1]},r.prototype.weekdaytext=function(e){var t=ys(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},r.prototype.plural=function(e){return e%100!==1},r.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},r.prototype.list=function(e,t,s,n){var a=this;n===void 0&&(n=","),Gt(e)||(e=[e]);var o=function(c,u,h){for(var p="",v=0;v<c.length;v++)v!==0&&(v===c.length-1?p+=" "+h+" ":p+=u+" "),p+=c[v];return p};t=t||function(c){return c.toString()};var l=function(c){return t&&t.call(a,c)};return s?o(e.map(l),n,s):e.map(l).join(n+" ")},r}(),Hv=function(){function r(e){this.done=!0,this.rules=e}return r.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},r.prototype.isDone=function(){return this.done&&this.symbol===null},r.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var s=void 0;e=null;for(var n in this.rules){s=this.rules[n];var a=s.exec(this.text);a&&(e===null||a[0].length>e[0].length)&&(e=a,t=n)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},r.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},r.prototype.acceptNumber=function(){return this.accept("number")},r.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},r}();function zl(r,e){e===void 0&&(e=jn);var t={},s=new Hv(e.tokens);if(!s.start(r))return null;return n(),t;function n(){s.expect("every");var v=s.acceptNumber();if(v&&(t.interval=parseInt(v[0],10)),s.isDone())throw new Error("Unexpected end");switch(s.symbol){case"day(s)":t.freq=pe.DAILY,s.nextSymbol()&&(o(),p());break;case"weekday(s)":t.freq=pe.WEEKLY,t.byweekday=[pe.MO,pe.TU,pe.WE,pe.TH,pe.FR],s.nextSymbol(),o(),p();break;case"week(s)":t.freq=pe.WEEKLY,s.nextSymbol()&&(a(),o(),p());break;case"hour(s)":t.freq=pe.HOURLY,s.nextSymbol()&&(a(),p());break;case"minute(s)":t.freq=pe.MINUTELY,s.nextSymbol()&&(a(),p());break;case"month(s)":t.freq=pe.MONTHLY,s.nextSymbol()&&(a(),p());break;case"year(s)":t.freq=pe.YEARLY,s.nextSymbol()&&(a(),p());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=pe.WEEKLY;var y=s.symbol.substr(0,2).toUpperCase();if(t.byweekday=[pe[y]],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");var w=c();if(!w)throw new Error("Unexpected symbol "+s.symbol+", expected weekday");t.byweekday.push(pe[w]),s.nextSymbol()}o(),h(),p();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=pe.YEARLY,t.bymonth=[l()],!s.nextSymbol())return;for(;s.accept("comma");){if(s.isDone())throw new Error("Unexpected end");var m=l();if(!m)throw new Error("Unexpected symbol "+s.symbol+", expected month");t.bymonth.push(m),s.nextSymbol()}a(),p();break;default:throw new Error("Unknown symbol")}}function a(){var v=s.accept("on"),y=s.accept("the");if(v||y)do{var w=u(),m=c(),g=l();if(w)m?(s.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(pe[m].nth(w))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(w),s.accept("day(s)"));else if(m)s.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(pe[m]);else if(s.symbol==="weekday(s)")s.nextSymbol(),t.byweekday||(t.byweekday=[pe.MO,pe.TU,pe.WE,pe.TH,pe.FR]);else if(s.symbol==="week(s)"){s.nextSymbol();var _=s.acceptNumber();if(!_)throw new Error("Unexpected symbol "+s.symbol+", expected week number");for(t.byweekno=[parseInt(_[0],10)];s.accept("comma");){if(_=s.acceptNumber(),!_)throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");t.byweekno.push(parseInt(_[0],10))}}else if(g)s.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(g);else return}while(s.accept("comma")||s.accept("the")||s.accept("on"))}function o(){var v=s.accept("at");if(v)do{var y=s.acceptNumber();if(!y)throw new Error("Unexpected symbol "+s.symbol+", expected hour");for(t.byhour=[parseInt(y[0],10)];s.accept("comma");){if(y=s.acceptNumber(),!y)throw new Error("Unexpected symbol "+s.symbol+"; expected hour");t.byhour.push(parseInt(y[0],10))}}while(s.accept("comma")||s.accept("at"))}function l(){switch(s.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function c(){switch(s.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return s.symbol.substr(0,2).toUpperCase();default:return!1}}function u(){switch(s.symbol){case"last":return s.nextSymbol(),-1;case"first":return s.nextSymbol(),1;case"second":return s.nextSymbol(),s.accept("last")?-2:2;case"third":return s.nextSymbol(),s.accept("last")?-3:3;case"nth":var v=parseInt(s.value[1],10);if(v<-366||v>366)throw new Error("Nth out of range: "+v);return s.nextSymbol(),s.accept("last")?-v:v;default:return!1}}function h(){s.accept("on"),s.accept("the");var v=u();if(v)for(t.bymonthday=[v],s.nextSymbol();s.accept("comma");){if(v=u(),!v)throw new Error("Unexpected symbol "+s.symbol+"; expected monthday");t.bymonthday.push(v),s.nextSymbol()}}function p(){if(s.symbol==="until"){var v=Date.parse(s.text);if(!v)throw new Error("Cannot parse until date:"+s.text);t.until=new Date(v)}else s.accept("for")&&(t.count=parseInt(s.value[0],10),s.expect("number"))}}var Le;(function(r){r[r.YEARLY=0]="YEARLY",r[r.MONTHLY=1]="MONTHLY",r[r.WEEKLY=2]="WEEKLY",r[r.DAILY=3]="DAILY",r[r.HOURLY=4]="HOURLY",r[r.MINUTELY=5]="MINUTELY",r[r.SECONDLY=6]="SECONDLY"})(Le||(Le={}));function gi(r){return r<Le.HOURLY}var Kv=function(r,e){return e===void 0&&(e=jn),new pe(zl(r,e)||void 0)},en=["count","until","interval","byweekday","bymonthday","bymonth"];Us.IMPLEMENTED=[];Us.IMPLEMENTED[Le.HOURLY]=en;Us.IMPLEMENTED[Le.MINUTELY]=en;Us.IMPLEMENTED[Le.DAILY]=["byhour"].concat(en);Us.IMPLEMENTED[Le.WEEKLY]=en;Us.IMPLEMENTED[Le.MONTHLY]=en;Us.IMPLEMENTED[Le.YEARLY]=["byweekno","byyearday"].concat(en);var Wv=function(r,e,t,s){return new Us(r,e,t,s).toString()},Gv=Us.isFullyConvertible,Yn=function(){function r(e,t,s,n){this.hour=e,this.minute=t,this.second=s,this.millisecond=n||0}return r.prototype.getHours=function(){return this.hour},r.prototype.getMinutes=function(){return this.minute},r.prototype.getSeconds=function(){return this.second},r.prototype.getMilliseconds=function(){return this.millisecond},r.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},r}(),Qv=function(r){mi(e,r);function e(t,s,n,a,o,l,c){var u=r.call(this,a,o,l,c)||this;return u.year=t,u.month=s,u.day=n,u}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return Vr(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var s=Math.floor(this.month/12),n=ns(this.month,12);this.month=n,this.year+=s,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,s){s>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-s))+t*7:this.day+=-(this.getWeekday()-s)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,s,n){for(s&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var a=ha(this.hour,24),o=a.div,l=a.mod;if(o&&(this.hour=l,this.addDaily(o)),ws(n)||We(n,this.hour))break}},e.prototype.addMinutes=function(t,s,n,a){for(s&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var o=ha(this.minute,60),l=o.div,c=o.mod;if(l&&(this.minute=c,this.addHours(l,!1,n)),(ws(n)||We(n,this.hour))&&(ws(a)||We(a,this.minute)))break}},e.prototype.addSeconds=function(t,s,n,a,o){for(s&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var l=ha(this.second,60),c=l.div,u=l.mod;if(c&&(this.second=u,this.addMinutes(c,!1,n,a)),(ws(n)||We(n,this.hour))&&(ws(a)||We(a,this.minute))&&(ws(o)||We(o,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=oo(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>Ll))return;t=oo(this.year,this.month-1)[1]}}},e.prototype.add=function(t,s){var n=t.freq,a=t.interval,o=t.wkst,l=t.byhour,c=t.byminute,u=t.bysecond;switch(n){case Le.YEARLY:return this.addYears(a);case Le.MONTHLY:return this.addMonths(a);case Le.WEEKLY:return this.addWeekly(a,o);case Le.DAILY:return this.addDaily(a);case Le.HOURLY:return this.addHours(a,s,l);case Le.MINUTELY:return this.addMinutes(a,s,l,c);case Le.SECONDLY:return this.addSeconds(a,s,l,c,u)}},e}(Yn);function jl(r){for(var e=[],t=Object.keys(r),s=0,n=t;s<n.length;s++){var a=n[s];We(Sp,a)||e.push(a),Pl(r[a])&&!nn(r[a])&&e.push(a)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return $t({},r)}function $v(r){var e=$t($t({},bi),jl(r));if(ot(e.byeaster)&&(e.freq=pe.YEARLY),!(ot(e.freq)&&pe.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(r.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),ot(e.wkst)?ys(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=pe.MO.weekday,ot(e.bysetpos)){ys(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var s=e.bysetpos[t];if(s===0||!(s>=-366&&s<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||pt(e.byweekno)||pt(e.byyearday)||e.bymonthday||pt(e.bymonthday)||ot(e.byweekday)||ot(e.byeaster)))switch(e.freq){case pe.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case pe.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case pe.WEEKLY:e.byweekday=[Vr(e.dtstart)];break}if(ot(e.bymonth)&&!Gt(e.bymonth)&&(e.bymonth=[e.bymonth]),ot(e.byyearday)&&!Gt(e.byyearday)&&ys(e.byyearday)&&(e.byyearday=[e.byyearday]),!ot(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(Gt(e.bymonthday)){for(var n=[],a=[],t=0;t<e.bymonthday.length;t++){var s=e.bymonthday[t];s>0?n.push(s):s<0&&a.push(s)}e.bymonthday=n,e.bynmonthday=a}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(ot(e.byweekno)&&!Gt(e.byweekno)&&(e.byweekno=[e.byweekno]),!ot(e.byweekday))e.bynweekday=null;else if(ys(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(io(e.byweekday))e.byweekday=[Rt.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof Rt)!e.byweekday.n||e.freq>pe.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var o=[],l=[],t=0;t<e.byweekday.length;t++){var c=e.byweekday[t];if(ys(c)){o.push(c);continue}else if(io(c)){o.push(Rt.fromStr(c).weekday);continue}!c.n||e.freq>pe.MONTHLY?o.push(c.weekday):l.push([c.weekday,c.n])}e.byweekday=pt(o)?o:null,e.bynweekday=pt(l)?l:null}return ot(e.byhour)?ys(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<pe.HOURLY?[e.dtstart.getUTCHours()]:null,ot(e.byminute)?ys(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<pe.MINUTELY?[e.dtstart.getUTCMinutes()]:null,ot(e.bysecond)?ys(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<pe.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function Vv(r){var e=r.dtstart.getTime()%1e3;if(!gi(r.freq))return[];var t=[];return r.byhour.forEach(function(s){r.byminute.forEach(function(n){r.bysecond.forEach(function(a){t.push(new Yn(s,n,a,e))})})}),t}function Ba(r){var e=r.split(`
`).map(Xv).filter(function(t){return t!==null});return $t($t({},e[0]),e[1])}function Hn(r){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(r);if(!t)return e;var s=t[1],n=t[2];return s&&(e.tzid=s),e.dtstart=yi(n),e}function Xv(r){if(r=r.replace(/^\s+|\s+$/,""),!r.length)return null;var e=/^([A-Z]+?)[:;]/.exec(r.toUpperCase());if(!e)return fo(r);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return fo(r);case"DTSTART":return Hn(r);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(r))}}function fo(r){var e=r.replace(/^RRULE:/i,""),t=Hn(e),s=r.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return s.forEach(function(n){var a=n.split("="),o=a[0],l=a[1];switch(o.toUpperCase()){case"FREQ":t.freq=Le[l.toUpperCase()];break;case"WKST":t.wkst=ds[l.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var c=Zv(l),u=o.toLowerCase();t[u]=c;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=Jv(l);break;case"DTSTART":case"TZID":var h=Hn(r);t.tzid=h.tzid,t.dtstart=h.dtstart;break;case"UNTIL":t.until=yi(l);break;case"BYEASTER":t.byeaster=Number(l);break;default:throw new Error("Unknown RRULE property '"+o+"'")}}),t}function Zv(r){if(r.indexOf(",")!==-1){var e=r.split(",");return e.map(vo)}return vo(r)}function vo(r){return/^[+-]?\d+$/.test(r)?Number(r):r}function Jv(r){var e=r.split(",");return e.map(function(t){if(t.length===2)return ds[t];var s=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!s||s.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var n=Number(s[1]),a=s[2],o=ds[a].weekday;return new Rt(o,n)})}var Kn=function(){function r(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(r.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),r.prototype.toString=function(){var e=pi(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},r.prototype.getTime=function(){return this.date.getTime()},r.prototype.rezonedDate=function(){return this.isUTC?this.date:zv(this.date,this.tzid)},r}();function Ua(r){for(var e=[],t="",s=Object.keys(r),n=Object.keys(bi),a=0;a<s.length;a++)if(s[a]!=="tzid"&&We(n,s[a])){var o=s[a].toUpperCase(),l=r[s[a]],c="";if(!(!ot(l)||Gt(l)&&!l.length)){switch(o){case"FREQ":c=pe.FREQUENCIES[r.freq];break;case"WKST":ys(l)?c=new Rt(l).toString():c=l.toString();break;case"BYWEEKDAY":o="BYDAY",c=Rv(l).map(function(y){return y instanceof Rt?y:Gt(y)?new Rt(y[0],y[1]):new Rt(y)}).toString();break;case"DTSTART":t=ep(l,r.tzid);break;case"UNTIL":c=pi(l,!r.tzid);break;default:if(Gt(l)){for(var u=[],h=0;h<l.length;h++)u[h]=String(l[h]);c=u.toString()}else c=String(l)}c&&e.push([o,c])}}var p=e.map(function(y){var w=y[0],m=y[1];return"".concat(w,"=").concat(m.toString())}).join(";"),v="";return p!==""&&(v="RRULE:".concat(p)),[t,v].filter(function(y){return!!y}).join(`
`)}function ep(r,e){return r?"DTSTART"+new Kn(new Date(r),e).toString():""}function tp(r,e){return Array.isArray(r)?!Array.isArray(e)||r.length!==e.length?!1:r.every(function(t,s){return t.getTime()===e[s].getTime()}):r instanceof Date?e instanceof Date&&r.getTime()===e.getTime():r===e}var sp=function(){function r(){this.all=!1,this.before=[],this.after=[],this.between=[]}return r.prototype._cacheAdd=function(e,t,s){t&&(t=t instanceof Date?Fa(t):lo(t)),e==="all"?this.all=t:(s._value=t,this[e].push(s))},r.prototype._cacheGet=function(e,t){var s=!1,n=t?Object.keys(t):[],a=function(h){for(var p=0;p<n.length;p++){var v=n[p];if(!tp(t[v],h[v]))return!0}return!1},o=this[e];if(e==="all")s=this.all;else if(Gt(o))for(var l=0;l<o.length;l++){var c=o[l];if(!(n.length&&a(c))){s=c._value;break}}if(!s&&this.all){for(var u=new Rr(e,t),l=0;l<this.all.length&&u.accept(this.all[l]);l++);s=u.getValue(),this._cacheAdd(e,s,t)}return Gt(s)?lo(s):s instanceof Date?Fa(s):s},r}(),rp=$($($($($($($($($($($($($([],Re(1,31),!0),Re(2,28),!0),Re(3,31),!0),Re(4,30),!0),Re(5,31),!0),Re(6,30),!0),Re(7,31),!0),Re(8,31),!0),Re(9,30),!0),Re(10,31),!0),Re(11,30),!0),Re(12,31),!0),Re(1,7),!0),np=$($($($($($($($($($($($($([],Re(1,31),!0),Re(2,29),!0),Re(3,31),!0),Re(4,30),!0),Re(5,31),!0),Re(6,30),!0),Re(7,31),!0),Re(8,31),!0),Re(9,30),!0),Re(10,31),!0),Re(11,30),!0),Re(12,31),!0),Re(1,7),!0),ap=Ss(1,29),ip=Ss(1,30),$s=Ss(1,31),At=Ss(1,32),op=$($($($($($($($($($($($($([],At,!0),ip,!0),At,!0),$s,!0),At,!0),$s,!0),At,!0),At,!0),$s,!0),At,!0),$s,!0),At,!0),At.slice(0,7),!0),lp=$($($($($($($($($($($($($([],At,!0),ap,!0),At,!0),$s,!0),At,!0),$s,!0),At,!0),At,!0),$s,!0),At,!0),$s,!0),At,!0),At.slice(0,7),!0),cp=Ss(-28,0),up=Ss(-29,0),Vs=Ss(-30,0),Ct=Ss(-31,0),dp=$($($($($($($($($($($($($([],Ct,!0),up,!0),Ct,!0),Vs,!0),Ct,!0),Vs,!0),Ct,!0),Ct,!0),Vs,!0),Ct,!0),Vs,!0),Ct,!0),Ct.slice(0,7),!0),hp=$($($($($($($($($($($($($([],Ct,!0),cp,!0),Ct,!0),Vs,!0),Ct,!0),Vs,!0),Ct,!0),Ct,!0),Vs,!0),Ct,!0),Vs,!0),Ct,!0),Ct.slice(0,7),!0),fp=[0,31,60,91,121,152,182,213,244,274,305,335,366],vp=[0,31,59,90,120,151,181,212,243,273,304,334,365],po=function(){for(var r=[],e=0;e<55;e++)r=r.concat(Ss(7));return r}();function pp(r,e){var t=wr(r,1,1),s=un(r)?366:365,n=un(r+1)?366:365,a=La(t),o=Vr(t),l=$t($t({yearlen:s,nextyearlen:n,yearordinal:a,yearweekday:o},yp(r)),{wnomask:null});if(ws(e.byweekno))return l;l.wnomask=Re(0,s+7);var c,u,h=c=ns(7-o+e.wkst,7);h>=4?(h=0,u=l.yearlen+ns(o-e.wkst,7)):u=s-h;for(var p=Math.floor(u/7),v=ns(u,7),y=Math.floor(p+v/4),w=0;w<e.byweekno.length;w++){var m=e.byweekno[w];if(m<0&&(m+=y+1),m>0&&m<=y){var g=void 0;m>1?(g=h+(m-1)*7,h!==c&&(g-=7-c)):g=h;for(var _=0;_<7&&(l.wnomask[g]=1,g++,l.wdaymask[g]!==e.wkst);_++);}}if(We(e.byweekno,1)){var g=h+y*7;if(h!==c&&(g-=7-c),g<s)for(var w=0;w<7&&(l.wnomask[g]=1,g+=1,l.wdaymask[g]!==e.wkst);w++);}if(h){var E=void 0;if(We(e.byweekno,-1))E=-1;else{var D=Vr(wr(r-1,1,1)),x=ns(7-D.valueOf()+e.wkst,7),R=un(r-1)?366:365,U=void 0;x>=4?(x=0,U=R+ns(D-e.wkst,7)):U=s-h,E=Math.floor(52+ns(U,7)/4)}if(We(e.byweekno,E))for(var g=0;g<h;g++)l.wnomask[g]=1}return l}function yp(r){var e=un(r)?366:365,t=wr(r,1,1),s=Vr(t);return e===365?{mmask:rp,mdaymask:lp,nmdaymask:hp,wdaymask:po.slice(s),mrange:vp}:{mmask:np,mdaymask:op,nmdaymask:dp,wdaymask:po.slice(s),mrange:fp}}function mp(r,e,t,s,n,a){var o={lastyear:r,lastmonth:e,nwdaymask:[]},l=[];if(a.freq===pe.YEARLY)if(ws(a.bymonth))l=[[0,t]];else for(var c=0;c<a.bymonth.length;c++)e=a.bymonth[c],l.push(s.slice(e-1,e+1));else a.freq===pe.MONTHLY&&(l=[s.slice(e-1,e+1)]);if(ws(l))return o;o.nwdaymask=Re(0,t);for(var c=0;c<l.length;c++)for(var u=l[c],h=u[0],p=u[1]-1,v=0;v<a.bynweekday.length;v++){var y=void 0,w=a.bynweekday[v],m=w[0],g=w[1];g<0?(y=p+(g+1)*7,y-=ns(n[y]-m,7)):(y=h+(g-1)*7,y+=ns(7-n[y]+m,7)),h<=y&&y<=p&&(o.nwdaymask[y]=1)}return o}function gp(r,e){e===void 0&&(e=0);var t=r%19,s=Math.floor(r/100),n=r%100,a=Math.floor(s/4),o=s%4,l=Math.floor((s+8)/25),c=Math.floor((s-l+1)/3),u=Math.floor(19*t+s-a-c+15)%30,h=Math.floor(n/4),p=n%4,v=Math.floor(32+2*o+2*h-u-p)%7,y=Math.floor((t+11*u+22*v)/451),w=Math.floor((u+v-7*y+114)/31),m=(u+v-7*y+114)%31+1,g=Date.UTC(r,w-1,m+e),_=Date.UTC(r,0,1);return[Math.ceil((g-_)/(1e3*60*60*24))]}var bp=function(){function r(e){this.options=e}return r.prototype.rebuild=function(e,t){var s=this.options;if(e!==this.lastyear&&(this.yearinfo=pp(e,s)),pt(s.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var n=this.yearinfo,a=n.yearlen,o=n.mrange,l=n.wdaymask;this.monthinfo=mp(e,t,a,o,l,s)}ot(s.byeaster)&&(this.eastermask=gp(e,s.byeaster))},Object.defineProperty(r.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),r.prototype.ydayset=function(){return[Ss(this.yearlen),0,this.yearlen]},r.prototype.mdayset=function(e,t){for(var s=this.mrange[t-1],n=this.mrange[t],a=Re(null,this.yearlen),o=s;o<n;o++)a[o]=o;return[a,s,n]},r.prototype.wdayset=function(e,t,s){for(var n=Re(null,this.yearlen+7),a=La(wr(e,t,s))-this.yearordinal,o=a,l=0;l<7&&(n[a]=a,++a,this.wdaymask[a]!==this.options.wkst);l++);return[n,o,a]},r.prototype.ddayset=function(e,t,s){var n=Re(null,this.yearlen),a=La(wr(e,t,s))-this.yearordinal;return n[a]=a,[n,a,a+1]},r.prototype.htimeset=function(e,t,s,n){var a=this,o=[];return this.options.byminute.forEach(function(l){o=o.concat(a.mtimeset(e,l,s,n))}),yn(o),o},r.prototype.mtimeset=function(e,t,s,n){var a=this.options.bysecond.map(function(o){return new Yn(e,t,o,n)});return yn(a),a},r.prototype.stimeset=function(e,t,s,n){return[new Yn(e,t,s,n)]},r.prototype.getdayset=function(e){switch(e){case Le.YEARLY:return this.ydayset.bind(this);case Le.MONTHLY:return this.mdayset.bind(this);case Le.WEEKLY:return this.wdayset.bind(this);case Le.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},r.prototype.gettimeset=function(e){switch(e){case Le.HOURLY:return this.htimeset.bind(this);case Le.MINUTELY:return this.mtimeset.bind(this);case Le.SECONDLY:return this.stimeset.bind(this)}},r}();function _p(r,e,t,s,n,a){for(var o=[],l=0;l<r.length;l++){var c=void 0,u=void 0,h=r[l];h<0?(c=Math.floor(h/e.length),u=ns(h,e.length)):(c=Math.floor((h-1)/e.length),u=ns(h-1,e.length));for(var p=[],v=t;v<s;v++){var y=a[v];ot(y)&&p.push(y)}var w=void 0;c<0?w=p.slice(c)[0]:w=p[c];var m=e[u],g=Bl(n.yearordinal+w),_=Ul(g,m);We(o,_)||o.push(_)}return yn(o),o}function Yl(r,e){var t=e.dtstart,s=e.freq,n=e.interval,a=e.until,o=e.bysetpos,l=e.count;if(l===0||n===0)return Es(r);var c=Qv.fromDate(t),u=new bp(e);u.rebuild(c.year,c.month);for(var h=Tp(u,c,e);;){var p=u.getdayset(s)(c.year,c.month,c.day),v=p[0],y=p[1],w=p[2],m=wp(v,y,w,u,e);if(pt(o))for(var g=_p(o,h,y,w,u,v),_=0;_<g.length;_++){var E=g[_];if(a&&E>a)return Es(r);if(E>=t){var D=yo(E,e);if(!r.accept(D)||l&&(--l,!l))return Es(r)}}else for(var _=y;_<w;_++){var x=v[_];if(ot(x))for(var R=Bl(u.yearordinal+x),U=0;U<h.length;U++){var N=h[U],E=Ul(R,N);if(a&&E>a)return Es(r);if(E>=t){var D=yo(E,e);if(!r.accept(D)||l&&(--l,!l))return Es(r)}}}if(e.interval===0||(c.add(e,m),c.year>Ll))return Es(r);gi(s)||(h=u.gettimeset(s)(c.hour,c.minute,c.second,0)),u.rebuild(c.year,c.month)}}function kp(r,e,t){var s=t.bymonth,n=t.byweekno,a=t.byweekday,o=t.byeaster,l=t.bymonthday,c=t.bynmonthday,u=t.byyearday;return pt(s)&&!We(s,r.mmask[e])||pt(n)&&!r.wnomask[e]||pt(a)&&!We(a,r.wdaymask[e])||pt(r.nwdaymask)&&!r.nwdaymask[e]||o!==null&&!We(r.eastermask,e)||(pt(l)||pt(c))&&!We(l,r.mdaymask[e])&&!We(c,r.nmdaymask[e])||pt(u)&&(e<r.yearlen&&!We(u,e+1)&&!We(u,-r.yearlen+e)||e>=r.yearlen&&!We(u,e+1-r.yearlen)&&!We(u,-r.nextyearlen+e-r.yearlen))}function yo(r,e){return new Kn(r,e.tzid).rezonedDate()}function Es(r){return r.getValue()}function wp(r,e,t,s,n){for(var a=!1,o=e;o<t;o++){var l=r[o];a=kp(s,l,n),a&&(r[l]=null)}return a}function Tp(r,e,t){var s=t.freq,n=t.byhour,a=t.byminute,o=t.bysecond;return gi(s)?Vv(t):s>=pe.HOURLY&&pt(n)&&!We(n,e.hour)||s>=pe.MINUTELY&&pt(a)&&!We(a,e.minute)||s>=pe.SECONDLY&&pt(o)&&!We(o,e.second)?[]:r.gettimeset(s)(e.hour,e.minute,e.second,e.millisecond)}var ds={MO:new Rt(0),TU:new Rt(1),WE:new Rt(2),TH:new Rt(3),FR:new Rt(4),SA:new Rt(5),SU:new Rt(6)},bi={freq:Le.YEARLY,dtstart:null,interval:1,wkst:ds.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},Sp=Object.keys(bi),pe=function(){function r(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new sp,this.origOptions=jl(e);var s=$v(e).parsedOptions;this.options=s}return r.parseText=function(e,t){return zl(e,t)},r.fromText=function(e,t){return Kv(e,t)},r.fromString=function(e){return new r(r.parseString(e)||void 0)},r.prototype._iter=function(e){return Yl(e,this.options)},r.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},r.prototype._cacheAdd=function(e,t,s){if(this._cache)return this._cache._cacheAdd(e,t,s)},r.prototype.all=function(e){if(e)return this._iter(new uo("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Rr("all",{})),this._cacheAdd("all",t)),t},r.prototype.between=function(e,t,s,n){if(s===void 0&&(s=!1),!nn(e)||!nn(t))throw new Error("Invalid date passed in to RRule.between");var a={before:t,after:e,inc:s};if(n)return this._iter(new uo("between",a,n));var o=this._cacheGet("between",a);return o===!1&&(o=this._iter(new Rr("between",a)),this._cacheAdd("between",o,a)),o},r.prototype.before=function(e,t){if(t===void 0&&(t=!1),!nn(e))throw new Error("Invalid date passed in to RRule.before");var s={dt:e,inc:t},n=this._cacheGet("before",s);return n===!1&&(n=this._iter(new Rr("before",s)),this._cacheAdd("before",n,s)),n},r.prototype.after=function(e,t){if(t===void 0&&(t=!1),!nn(e))throw new Error("Invalid date passed in to RRule.after");var s={dt:e,inc:t},n=this._cacheGet("after",s);return n===!1&&(n=this._iter(new Rr("after",s)),this._cacheAdd("after",n,s)),n},r.prototype.count=function(){return this.all().length},r.prototype.toString=function(){return Ua(this.origOptions)},r.prototype.toText=function(e,t,s){return Wv(this,e,t,s)},r.prototype.isFullyConvertibleToText=function(){return Gv(this)},r.prototype.clone=function(){return new r(this.origOptions)},r.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],r.YEARLY=Le.YEARLY,r.MONTHLY=Le.MONTHLY,r.WEEKLY=Le.WEEKLY,r.DAILY=Le.DAILY,r.HOURLY=Le.HOURLY,r.MINUTELY=Le.MINUTELY,r.SECONDLY=Le.SECONDLY,r.MO=ds.MO,r.TU=ds.TU,r.WE=ds.WE,r.TH=ds.TH,r.FR=ds.FR,r.SA=ds.SA,r.SU=ds.SU,r.parseString=Ba,r.optionsToString=Ua,r}();function Dp(r,e,t,s,n,a){var o={},l=r.accept;function c(v,y){t.forEach(function(w){w.between(v,y,!0).forEach(function(m){o[Number(m)]=!0})})}n.forEach(function(v){var y=new Kn(v,a).rezonedDate();o[Number(y)]=!0}),r.accept=function(v){var y=Number(v);return isNaN(y)?l.call(this,v):!o[y]&&(c(new Date(y-1),new Date(y+1)),!o[y])?(o[y]=!0,l.call(this,v)):!0},r.method==="between"&&(c(r.args.after,r.args.before),r.accept=function(v){var y=Number(v);return o[y]?!0:(o[y]=!0,l.call(this,v))});for(var u=0;u<s.length;u++){var h=new Kn(s[u],a).rezonedDate();if(!r.accept(new Date(h.getTime())))break}e.forEach(function(v){Yl(r,v.options)});var p=r._result;switch(yn(p),r.method){case"all":case"between":return p;case"before":return p.length&&p[p.length-1]||null;case"after":default:return p.length&&p[0]||null}}var mo={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function Ep(r,e){var t=[],s=[],n=[],a=[],o=Hn(r),l=o.dtstart,c=o.tzid,u=Op(r,e.unfold);return u.forEach(function(h){var p;if(h){var v=Ip(h),y=v.name,w=v.parms,m=v.value;switch(y.toUpperCase()){case"RRULE":if(w.length)throw new Error("unsupported RRULE parm: ".concat(w.join(",")));t.push(Ba(h));break;case"RDATE":var g=(p=/RDATE(?:;TZID=([^:=]+))?/i.exec(h))!==null&&p!==void 0?p:[],_=g[1];_&&!c&&(c=_),s=s.concat(go(m,w));break;case"EXRULE":if(w.length)throw new Error("unsupported EXRULE parm: ".concat(w.join(",")));n.push(Ba(m));break;case"EXDATE":a=a.concat(go(m,w));break;case"DTSTART":break;default:throw new Error("unsupported property: "+y)}}}),{dtstart:l,tzid:c,rrulevals:t,rdatevals:s,exrulevals:n,exdatevals:a}}function xp(r,e){var t=Ep(r,e),s=t.rrulevals,n=t.rdatevals,a=t.exrulevals,o=t.exdatevals,l=t.dtstart,c=t.tzid,u=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||s.length>1||n.length||a.length||o.length){var h=new Np(u);return h.dtstart(l),h.tzid(c||void 0),s.forEach(function(v){h.rrule(new pe(fa(v,l,c),u))}),n.forEach(function(v){h.rdate(v)}),a.forEach(function(v){h.exrule(new pe(fa(v,l,c),u))}),o.forEach(function(v){h.exdate(v)}),e.compatible&&e.dtstart&&h.rdate(l),h}var p=s[0]||{};return new pe(fa(p,p.dtstart||e.dtstart||l,p.tzid||e.tzid||c),u)}function za(r,e){return e===void 0&&(e={}),xp(r,Ap(e))}function fa(r,e,t){return $t($t({},r),{dtstart:e,tzid:t})}function Ap(r){var e=[],t=Object.keys(r),s=Object.keys(mo);if(t.forEach(function(n){We(s,n)||e.push(n)}),e.length)throw new Error("Invalid options: "+e.join(", "));return $t($t({},mo),r)}function Cp(r){if(r.indexOf(":")===-1)return{name:"RRULE",value:r};var e=Lv(r,":",1),t=e[0],s=e[1];return{name:t,value:s}}function Ip(r){var e=Cp(r),t=e.name,s=e.value,n=t.split(";");if(!n)throw new Error("empty property name");return{name:n[0].toUpperCase(),parms:n.slice(1),value:s}}function Op(r,e){if(e===void 0&&(e=!1),r=r&&r.trim(),!r)throw new Error("Invalid empty string");if(!e)return r.split(/\s/);for(var t=r.split(`
`),s=0;s<t.length;){var n=t[s]=t[s].replace(/\s+$/g,"");n?s>0&&n[0]===" "?(t[s-1]+=n.slice(1),t.splice(s,1)):s+=1:t.splice(s,1)}return t}function Mp(r){r.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function go(r,e){return Mp(e),r.split(",").map(function(t){return yi(t)})}function bo(r){var e=this;return function(t){if(t!==void 0&&(e["_".concat(r)]=t),e["_".concat(r)]!==void 0)return e["_".concat(r)];for(var s=0;s<e._rrule.length;s++){var n=e._rrule[s].origOptions[r];if(n)return n}}}var Np=function(r){mi(e,r);function e(t){t===void 0&&(t=!1);var s=r.call(this,{},t)||this;return s.dtstart=bo.apply(s,["dtstart"]),s.tzid=bo.apply(s,["tzid"]),s._rrule=[],s._rdate=[],s._exrule=[],s._exdate=[],s}return e.prototype._iter=function(t){return Dp(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){_o(t,this._rrule)},e.prototype.exrule=function(t){_o(t,this._exrule)},e.prototype.rdate=function(t){ko(t,this._rdate)},e.prototype.exdate=function(t){ko(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return za(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return za(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(Ua({dtstart:this._dtstart}))),this._rrule.forEach(function(s){t=t.concat(s.toString().split(`
`))}),this._exrule.forEach(function(s){t=t.concat(s.toString().split(`
`).map(function(n){return n.replace(/^RRULE:/,"EXRULE:")}).filter(function(n){return!/^DTSTART/.test(n)}))}),this._rdate.length&&t.push(wo("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(wo("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(s){return t.rrule(s.clone())}),this._exrule.forEach(function(s){return t.exrule(s.clone())}),this._rdate.forEach(function(s){return t.rdate(new Date(s.getTime()))}),this._exdate.forEach(function(s){return t.exdate(new Date(s.getTime()))}),t},e}(pe);function _o(r,e){if(!(r instanceof pe))throw new TypeError(String(r)+" is not RRule instance");We(e.map(String),String(r))||e.push(r)}function ko(r,e){if(!(r instanceof Date))throw new TypeError(String(r)+" is not Date instance");We(e.map(Number),Number(r))||(e.push(r),yn(e))}function wo(r,e,t){var s=!t||t.toUpperCase()==="UTC",n=s?"".concat(r,":"):"".concat(r,";TZID=").concat(t,":"),a=e.map(function(o){return pi(o.valueOf(),s)}).join(",");return"".concat(n).concat(a)}function qp(){return Intl.DateTimeFormat().resolvedOptions().timeZone}class Rp{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,n)=>s-n)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t,s){if(s!=null&&s.timezone||qp(),t.rruleString)return this.calculateNextWithRRule(e,t,s);const a=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,{type:o,time:l}=t,c=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(a,c);break;case"weekly":u=this.calculateNextWeekly(a,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(a,c,this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;case"yearly":u=this.calculateNextYearly(a,c,this.normalizeMonth(t.month,a.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(l){const{hours:h,minutes:p}=Ia(l);if(Number.isFinite(h)&&Number.isFinite(p)){const{date:v,shifted:y}=eo(u,h,p);y&&Qe("DST shift detected while applying recurrence time",{requestedTime:l,original:u.toISOString(),adjusted:v.toISOString()}),u=v}}return u}calculateNextWithRRule(e,t,s){try{const a=((s==null?void 0:s.whenDone)??t.whenDone??!1)&&(s!=null&&s.completionDate)?s.completionDate:e,l=za(t.rruleString).after(a,!1);if(!l){Qe("RRule returned no next occurrence, falling back to legacy logic",{rruleString:t.rruleString,baseDate:a.toISOString()});const{rruleString:u,naturalLanguage:h,...p}=t;return this.calculateNext(a,p,s)}let c=l;if(t.time){const{hours:u,minutes:h}=Ia(t.time);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:p,shifted:v}=eo(c,u,h);v&&Qe("DST shift detected while applying recurrence time",{requestedTime:t.time,original:c.toISOString(),adjusted:p.toISOString()}),c=p}}return c}catch(n){be("Failed to parse rrule, falling back to legacy logic",{error:n instanceof Error?n.message:String(n),rruleString:t.rruleString});const{rruleString:a,naturalLanguage:o,...l}=t;return this.calculateNext(e,l,s)}}calculateNextDaily(e,t){return vn(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return Ji(e,t);const n=this.getMondayIndex(e),a=Math.min(la,t*14);for(let o=1;o<=a;o++){if(Math.floor((n+o)/7)%t!==0)continue;const c=vn(e,o),u=this.getMondayIndex(c);if(s.includes(u))return c}return Qe("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),Ji(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const n=s??e.getDate(),a=e.getFullYear(),l=e.getMonth()+t,c=a+Math.floor(l/12),u=(l%12+12)%12,h=new Date(c,u+1,0).getDate(),p=Math.min(n,h),v=new Date(e);return v.setFullYear(c,u,p),v}calculateNextYearly(e,t,s,n){const a=n??e.getDate(),o=e.getFullYear()+t,l=new Date(o,s+1,0).getDate(),c=Math.min(a,l),u=new Date(e);return u.setFullYear(o,s,c),u}getOccurrencesInRange(e,t,s,n){const a=[];let o=new Date(n),l=0;for(;o<=t&&l<la;)o>=e&&a.push(new Date(o)),o=this.calculateNext(o,s),l++;return a}getMissedOccurrences(e,t,s,n){const a=[];let o=new Date(n),l=0;for(;o<=e&&l<la;)o=this.calculateNext(o,s),l++;let c=0;for(;o<t&&c<qn;)a.push(new Date(o)),o=this.calculateNext(o,s),c++;return c>=qn&&Qe("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:n.toISOString(),cap:qn}),a}}class Lp{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:n}=Ia(t);if(!Number.isFinite(s)||!Number.isFinite(n))return new Date(e);const a=new Date(e);return a.setHours(s,n,0,0),a}isSameLocalDay(e,t){const s=new Date(e),n=new Date(t);return s.getFullYear()===n.getFullYear()&&s.getMonth()===n.getMonth()&&s.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),n=Math.trunc(s/(1e3*60)),a=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(a)<24?a>0?`in ${a}h`:`${-a}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class Fp{constructor(e){k(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return de(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return Qe(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return Qe("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),de(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return Qe("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(s){return be("Failed to execute onCompletion action",{taskId:e.id,action:t,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return Qe("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return be("Failed to check for nested items",{blockId:e,error:t}),!0}}}class Pp{constructor(e,t){k(this,"intervalMs");k(this,"timeoutId",null);k(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:ci,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class Bp{constructor(e,t=ci,s){k(this,"storage");k(this,"recurrenceEngine");k(this,"onCompletionHandler");k(this,"emittedDue",new Set);k(this,"emittedMissed",new Set);k(this,"timezoneHandler");k(this,"isChecking",!1);k(this,"lastCheckStartTime",0);k(this,"plugin",null);k(this,"listeners",{"task:due":new Set,"task:overdue":new Set});k(this,"MAX_EMITTED_ENTRIES",1e3);k(this,"EMITTED_RETENTION_DAYS",30);k(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);k(this,"persistTimeoutId",null);k(this,"emittedStateReady",null);k(this,"timer");this.storage=e,this.recurrenceEngine=new Rp,this.onCompletionHandler=new Fp(s),this.timezoneHandler=new Lp,this.plugin=s||null,this.timer=new Pp(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),de("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),de("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Qe("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const n=new Date(s.dueAt),a=n<=e;if(a){const l=this.buildOccurrenceKey(s.id,n,"hour");this.emittedDue.has(l)||(this.emitEvent("task:due",{taskId:s.id,dueAt:n,context:"today",task:s}),this.registerEmittedKey("due",l),de(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(a&&e.getTime()-n.getTime()>=Lu&&(!o||o<n)){const l=this.buildOccurrenceKey(s.id,n,"hour");this.emittedMissed.has(l)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:n,context:"overdue",task:s}),this.registerEmittedKey("missed",l),Qe(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),s=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=s.set,(t.didTrim||s.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,s){const n=s.getTime(),a=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=a.filter(({time:u})=>u===null||u>=n),l=o.length!==a.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),l=!0);const c=new Set(o.map(({entry:u})=>u));return l&&de(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${c.size}`),{set:c,didTrim:l}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const s=e.slice(t+1);if(!s)return null;const n=s.length===13?`${s}:00:00.000Z`:s,a=new Date(n);return Number.isNaN(a.getTime())?null:a.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const s=new Date;t.doneAt=s.toISOString(),Gu(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const a=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,a);if(o.success||be(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:a,error:o.error}),o.warnings)for(const u of o.warnings)Qe(u,{taskId:t.id});const l=new Date(t.dueAt),c=this.recurrenceEngine.calculateNext(l,t.frequency,{completionDate:s,whenDone:t.whenDone});t.dueAt=c.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),de(`Task "${t.name}" completed and rescheduled to ${c.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const n=new Date(s.dueAt),a=new Date(n.getTime()+t*60*1e3);s.dueAt=a.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),de(`Task "${s.name}" delayed by ${t} minutes to ${a.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),de(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);El(t);const s=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),de(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),de("First run detected, no recovery needed");return}de(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const a of n){const o=this.buildOccurrenceKey(s.id,a,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:a,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(n){be(`Failed to recover task ${s.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),de("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let n=s,a=0;for(;n<t&&a<qn;)n=this.recurrenceEngine.calculateNext(n,e.frequency),a++;n>s&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),de(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Wi);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){be("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Wi,{timestamp:e.toISOString()})}catch(t){be("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const n of s)try{const a=n(t);a instanceof Promise&&a.catch(o=>{be(`Scheduler listener error for ${e}:`,o)})}catch(a){be(`Scheduler listener error for ${e}:`,a)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Fu,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(zi),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),de("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){be("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(zi,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){be("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const Up=7,zp=2e3;class jp{constructor(e,t){k(this,"plugin");k(this,"storageKey");k(this,"notifications",new Map);k(this,"escalations",new Map);k(this,"lastCleanup",new Date);k(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),de(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){be("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Al("Saved notification state")}catch(e){be("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>zp&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-Up*24*60*60*1e3);let n=0;for(const[a,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(a),n++);n>0&&(de(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function Yp(r){return{id:r.id,name:r.name,dueAt:r.dueAt,frequency:r.frequency,linkedBlockId:r.linkedBlockId,linkedBlockContent:r.linkedBlockContent,priority:r.priority,tags:r.tags,notificationChannels:r.notificationChannels,completionCount:r.completionCount,missCount:r.missCount,currentStreak:r.currentStreak,bestStreak:r.bestStreak}}const Hp=30*1e3,Kp=30*60*1e3,rr=500;class Wp{constructor(e,t={}){k(this,"plugin");k(this,"config");k(this,"queue",[]);k(this,"dedupeKeys",new Set);k(this,"flushIntervalId",null);k(this,"fetcher");k(this,"notificationState");k(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...Ca},this.notificationState=t.notificationState??new jp(this.plugin,Nu)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(Bi);e&&(this.config={...Ca,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(Bi,e)}async loadQueue(){try{const e=await this.plugin.loadData(Ui);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>rr){const s=this.queue.length-rr;this.queue=this.queue.slice(-rr),console.warn(`Event queue trimmed to ${rr} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-oa);await this.plugin.saveData(Ui,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Ru))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const a=this.buildPayload(e,t,n,1,s);await this.sendPayload(a)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(a)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:ji,version:Yi,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){s.push(n);continue}const a={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(a))this.markDelivered(a.delivery.dedupeKey),t=!0;else{const l=n.attempt+1,c=this.getRetryDelay(l);s.push({...n,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,n,a=0){const o=new Date,l=new Date(t.dueAt),c=o.getTime()-l.getTime();return{event:e,source:ji,version:Yi,occurredAt:o.toISOString(),task:Yp(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:c>0?c:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:a,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:n}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>oa){const t=Array.from(this.dedupeKeys).slice(-oa);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=rr){const s=this.queue.length-rr+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${rr}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=Hp*Math.pow(2,e-1);return Math.min(t,Kp)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,n=s.encode(t),a=s.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),l=await crypto.subtle.sign("HMAC",o,a);return Array.from(new Uint8Array(l)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const a={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return n&&(a["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(a["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),a}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),n=await this.buildHeaders(e),a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:s});if(!a.ok)return console.error("n8n webhook failed:",a.statusText),!1;if(t){const o=await a.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const Ht={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:pn,globalQuery:Un,urgency:ui};function To(r){var e,t,s,n,a;return{dates:{...Ht.dates,...r.dates},recurrence:{...Ht.recurrence,...r.recurrence},dependencies:{...Ht.dependencies,...r.dependencies},filenameDate:{...Ht.filenameDate,...r.filenameDate},globalFilter:{...Ht.globalFilter,...r.globalFilter,excludeFolders:((e=r.globalFilter)==null?void 0:e.excludeFolders)??Ht.globalFilter.excludeFolders,excludeNotebooks:((t=r.globalFilter)==null?void 0:t.excludeNotebooks)??Ht.globalFilter.excludeNotebooks,excludeTags:((s=r.globalFilter)==null?void 0:s.excludeTags)??Ht.globalFilter.excludeTags,excludeFilePatterns:((n=r.globalFilter)==null?void 0:n.excludeFilePatterns)??Ht.globalFilter.excludeFilePatterns,excludeStatusTypes:((a=r.globalFilter)==null?void 0:a.excludeStatusTypes)??Ht.globalFilter.excludeStatusTypes},globalQuery:{...Ht.globalQuery,...r.globalQuery},urgency:{...Ht.urgency,...r.urgency}}}const va="plugin-settings";class Gp{constructor(e){k(this,"plugin");k(this,"settings");this.plugin=e,this.settings=Ht}async load(){try{const e=await this.plugin.loadData(va);e&&typeof e=="object"&&(this.settings=To(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(va,e),ze.emit("task:refresh",void 0)}get(){return this.settings}async update(e){this.settings=To(e),await this.plugin.saveData(va,this.settings),ze.emit("task:refresh",void 0)}}const Hs=class Hs{constructor(e){k(this,"plugin");k(this,"isInitialized",!1);k(this,"storage");k(this,"repository");k(this,"scheduler");k(this,"eventService");k(this,"settingsService");this.plugin=e}static getInstance(e){if(!Hs.instance){if(!e)return null;Hs.instance=new Hs(e)}return Hs.instance}async initialize(){if(this.isInitialized){Qe("TaskManager already initialized");return}de("Initializing TaskManager"),this.settingsService=new Gp(this.plugin),await this.settingsService.load();const e=this.settingsService.get();zn.getInstance().initialize(e.globalFilter),$r.getInstance().initialize(e.globalQuery),this.storage=new Nv(this.plugin),await this.storage.init(),this.repository=new qv(this.storage),this.eventService=new Wp(this.plugin),await this.eventService.init(),this.scheduler=new Bp(this.storage,ci,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,de("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),de("TaskManager started")}async destroy(){de("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,Hs.instance=null,de("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};k(Hs,"instance",null);let Wn=Hs;function Qp(r){let t=`- [${r.status==="done"?"x":" "}] ${r.name}`;if(r.dueAt){const s=new Date(r.dueAt);t+=` 📅 ${s.toISOString().split("T")[0]}`}return r.frequency&&(t+=` 🔁 every ${r.frequency.interval} ${r.frequency.type}${r.frequency.interval>1?"s":""}`),t}class $p{constructor(e,t,s,n){this.storage=e,this.recurrenceEngine=t,this.settings=s,this.siyuanApi=n}async onComplete(e,t){try{const s=[],n=this.addCompletionDate(e,t);let a;return e.frequency&&(a=await this.generateNextInstance(n,t),a&&(await this.placeNextInstance(n,a)||s.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(a))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(Qe("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(n),s.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(n),{success:!0,nextTask:a,warnings:s.length>0?s:void 0}}catch(s){return be("Failed to handle task completion",{taskId:e.id,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}addCompletionDate(e,t){const s={...e},n=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(s.doneAt=n,s.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(s.cancelledAt=n,s.doneAt=void 0),s}async generateNextInstance(e,t){if(e.frequency)try{const s=new Date(e.dueAt),n=this.recurrenceEngine.calculateNext(s,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),a=Dl(e,{dueAt:n.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(a.scheduledAt=void 0),a}catch(s){be("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:s});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return Qe("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return Qe("SiYuan API not available, cannot place next instance"),!1;const s=this.settings.recurrence.newTaskPosition,n=Qp(t);try{let a;return s==="above"&&this.siyuanApi.insertBlockAbove?a=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,n):s==="below"&&this.siyuanApi.insertBlockBelow&&(a=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,n)),a!=null&&a.id?(t.linkedBlockId=a.id,t.linkedBlockContent=n,!0):!1}catch(a){return be("Failed to place next instance in document",{taskId:e.id,placement:s,error:a}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const s=await this.siyuanApi.getChildBlocks({id:e});return s&&s.length>0}catch(s){return be("Failed to check for nested items",{blockId:e,error:s}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),de("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(s){be("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:s})}else de("Task deleted from storage only (no linked block)",{taskId:e.id})}}class Vp{constructor(e,t,s,n){k(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=s,this.siyuanApi=n,t&&s&&(this.completionHandler=new $p(e,t,s(),n))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,s;try{const n=this.repository.getTask(e);if(!n){Q.error("Task not found");return}const a=vs.getInstance(),o=n.statusSymbol||" ",l=a.getNextSymbol(o),c={...n,statusSymbol:l},u=a.getStatus(l);if(u.type==="DONE"){if(c.status="done",n.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(c,new Date);h.success?(h.nextTask?(de("Next recurrence created",{taskId:c.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),Q.success("Task completed - next occurrence scheduled")):Q.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(p=>Q.warning(p))):Q.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!c.doneAt&&(c.doneAt=new Date().toISOString()),await this.repository.saveTask(c),Q.success(`Task status updated to ${u.name}`);ze.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(c.status="cancelled",(s=this.settings)!=null&&s.dates.autoAddCancelled&&!c.cancelledAt&&(c.cancelledAt=new Date().toISOString()),await this.repository.saveTask(c),ze.emit("task:updated",{taskId:e}),Q.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(c.status="todo",await this.repository.saveTask(c),ze.emit("task:updated",{taskId:e}),Q.success(`Task status updated to ${u.name}`))}catch(n){be("Failed to toggle task status",n),Q.error("Failed to toggle status")}}async completeTask(e){var t;try{const s=this.repository.getTask(e);if(!s){Q.error("Task not found");return}const n={...s,status:"done"};if(s.frequency&&this.completionHandler){const a=await this.completionHandler.onComplete(n,new Date);a.success?(a.nextTask?(de("Next recurrence created",{taskId:n.id,nextTaskId:a.nextTask.id,nextDue:a.nextTask.dueAt}),Q.success(`Task "${s.name}" completed - next occurrence scheduled`)):Q.success(`Task "${s.name}" completed`),a.warnings&&a.warnings.forEach(o=>Q.warning(o))):Q.error(`Failed to complete task: ${a.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),Q.success(`Task "${s.name}" completed`);ze.emit("task:complete",{taskId:e})}catch(s){be("Failed to complete task",s),Q.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){Q.error("Task not found");return}const n=this.repository.getAllTasks().filter(a=>{var o,l;return((o=a.blockedBy)==null?void 0:o.includes(e))||((l=a.dependsOn)==null?void 0:l.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),ze.emit("task:deleted",{taskId:e}),Q.success(`Task "${t.name}" deleted`)}catch(t){be("Failed to delete task",t),Q.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){Q.error("Task not found");return}const s=new Date;s.setHours(12,0,0,0);const n={...t,scheduledAt:s.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),ze.emit("task:updated",{taskId:e}),Q.success("Task rescheduled to today")}catch(t){be("Failed to reschedule task",t),Q.error("Failed to reschedule task")}}async deferTask(e,t){try{const s=this.repository.getTask(e);if(!s){Q.error("Task not found");return}const n={...s,updatedAt:new Date().toISOString()};if(s.dueAt){const a=new Date(s.dueAt);a.setDate(a.getDate()+t),n.dueAt=a.toISOString()}if(s.scheduledAt){const a=new Date(s.scheduledAt);a.setDate(a.getDate()+t),n.scheduledAt=a.toISOString()}await this.repository.saveTask(n),ze.emit("task:updated",{taskId:e}),Q.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(s){be("Failed to defer task",s),Q.error("Failed to defer task")}}}class Xp{constructor(e,t,s){k(this,"plugin");k(this,"storageKey");k(this,"settings");k(this,"defaults");this.plugin=e,this.storageKey=t,this.defaults={...s},this.settings={...s}}async load(){try{const e=await this.plugin.loadData(this.storageKey);e&&(this.settings={...this.defaults,...e})}catch(e){console.error(`Failed to load settings from ${this.storageKey}:`,e),this.settings={...this.defaults}}return this.settings}async save(e){e&&(this.settings=e);try{await this.plugin.saveData(this.storageKey,this.settings)}catch(t){throw console.error(`Failed to save settings to ${this.storageKey}:`,t),t}}get(){return{...this.settings}}async set(e,t){this.settings[e]=t,await this.save()}async reset(){this.settings={...this.defaults},await this.save()}has(e){return e in this.settings}getValue(e){return this.settings[e]}}const Nr=[{id:"quickAddTask",langKey:"quickAddTask",label:"Quick add recurring task",description:"Open the quick add dialog with focus on the task title.",defaultHotkey:"Ctrl+Shift+T",context:"Global / Editor"},{id:"markTaskDone",langKey:"markTaskDone",label:"Mark task as done",description:"Complete the focused task and trigger recurrence.",defaultHotkey:"Ctrl+Enter",context:"Task focus / Task block"},{id:"postponeTask",langKey:"postponeTask",label:"Postpone task",description:"Open the snooze selector for the focused task.",defaultHotkey:"Ctrl+Shift+P",context:"Task focus"},{id:"openRecurringTasksDock",langKey:"openRecurringTasksDock",label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",defaultHotkey:"Ctrl+Shift+O",context:"Global"},{id:"createRecurringTask",langKey:"createRecurringTask",label:"Create recurring task from selection",description:"Create a recurring task based on the current editor block.",defaultHotkey:"Ctrl+Shift+R",context:"Editor"},{id:"quickCompleteNextTask",langKey:"quickCompleteNextTask",label:"Quick complete next task",description:"Marks the most overdue task as complete.",defaultHotkey:"Ctrl+Shift+D",context:"Global"},{id:"toggleTaskStatus",langKey:"toggleTaskStatus",label:"Toggle task status",description:"Cycle the status of the focused task.",defaultHotkey:"Ctrl+Shift+X",context:"Task focus"},{id:"openTaskEditor",langKey:"openTaskEditor",label:"Open task editor",description:"Open the full task editor modal.",defaultHotkey:"Ctrl+Shift+E",context:"Global"}],pa=Nr.reduce((r,e)=>(r[e.id]=e.defaultHotkey,r),{});function ja(r,e){ze.emit("task:snooze",{taskId:r,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:r,minutes:e}})),de(`Snoozing task ${r} for ${e} minutes`)}function Zp(r){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=Ma(t),n=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));ze.emit("task:snooze",{taskId:r,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:r,minutes:n}})),de(`Snoozing task ${r} to tomorrow`)}function Jp(r){r.eventBus.on("click-blockicon",({detail:e})=>{var o,l,c;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],n=s==null?void 0:s.getAttribute("data-node-id");if(!n)return;const a=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=r.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{ze.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Ya(a),suggestedTime:Ha(a)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Ya(a),suggestedTime:Ha(a)}}))}});try{const u=Wn.getInstance();if(u&&u.isReady()){const p=u.getRepository().getTaskByBlockId(n);if(p){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((l=r.i18n)==null?void 0:l.completeTask)||"Complete Task",click:()=>{ze.emit("task:complete",{taskId:p.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:p.id}}))}});const v=[{label:"15 minutes",click:()=>ja(p.id,15)},{label:"1 hour",click:()=>ja(p.id,60)},{label:"Tomorrow",click:()=>Zp(p.id)}];e.menu.addItem({icon:"iconClock",label:((c=r.i18n)==null?void 0:c.snoozeTask)||"Snooze Task",submenu:v})}}}catch{Al("TaskManager not available for quick actions")}}),de("Registered block context menu")}function Ya(r){const e=r.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function Ha(r){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=r.match(e);if(t){let n=parseInt(t[1],10);const a=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${a}`}return null}const ey="recurring-task-shortcuts",ty=350;class sy{constructor(e,t,s,n,a){k(this,"settingsStore");k(this,"settings",{...pa});k(this,"taskCommands");k(this,"cooldownTimers",new Map);this.plugin=e,this.repository=t,this.handlers=a,this.settingsStore=new Xp(e,ey,pa),this.taskCommands=new Vp(t,s,n,void 0)}async initialize(){this.settings=await this.settingsStore.load()}registerShortcuts(){Nr.forEach(e=>{const t=this.settings[e.id]||e.defaultHotkey;this.plugin.addCommand({langKey:e.langKey,hotkey:t,callback:()=>{this.handleShortcut(e.id)}})}),de("Registered shortcut commands",{shortcuts:Nr.map(e=>({id:e.id,hotkey:this.settings[e.id]}))})}getShortcutDisplay(){return Nr.map(e=>({id:e.id,label:e.label,description:e.description,context:e.context,currentHotkey:this.settings[e.id]||"",defaultHotkey:e.defaultHotkey}))}async updateShortcut(e,t){const s=t.trim(),n=this.findDuplicateHotkey(e,s);return n?{success:!1,message:`Hotkey already assigned to "${n.label}".`}:(this.settings={...this.settings,[e]:s},await this.settingsStore.save(this.settings),this.registerShortcuts(),{success:!0})}async resetShortcut(e){const t=this.getDefinition(e);t&&(this.settings={...this.settings,[e]:t.defaultHotkey},await this.settingsStore.save(this.settings),this.registerShortcuts())}async resetAllShortcuts(){this.settings={...pa},await this.settingsStore.save(this.settings),this.registerShortcuts()}destroy(){this.cooldownTimers.forEach(e=>globalThis.clearTimeout(e)),this.cooldownTimers.clear()}async handleShortcut(e){if(!this.shouldIgnoreShortcut(e))switch(e){case"quickAddTask":this.guardCooldown(e,ty,()=>{this.handlers.createTask(this.buildCreatePayload("shortcut"))});break;case"createRecurringTask":this.handlers.createTask(this.buildCreatePayload("shortcut"));break;case"openRecurringTasksDock":this.handlers.openDock();break;case"markTaskDone":{const t=this.resolveTaskId();if(!t)return;await this.handlers.completeTask(t);break}case"postponeTask":{const t=this.resolveTaskId();if(!t)return;this.handlers.postponeTask(t);break}case"quickCompleteNextTask":await this.quickCompleteNextTask();break;case"toggleTaskStatus":{const t=this.resolveTaskId();if(!t)return;await this.taskCommands.toggleStatus(t);break}case"openTaskEditor":this.handlers.openTaskEditor();break}}guardCooldown(e,t,s){if(this.cooldownTimers.has(e))return;s();const n=globalThis.setTimeout(()=>{this.cooldownTimers.delete(e)},t);this.cooldownTimers.set(e,n)}shouldIgnoreShortcut(e){const t=document.activeElement;if(!t)return!1;const s=t.tagName.toLowerCase();return["input","textarea","select"].includes(s)?!0:t.isContentEditable?!this.isEditorAllowedShortcut(e):!1}isEditorAllowedShortcut(e){return e==="quickAddTask"||e==="createRecurringTask"}resolveTaskId(){const e=this.getFocusedTaskId();if(e)return e;const t=this.getSelectedBlockContext();if(!t)return null;const s=this.repository.getTaskByBlockId(t.blockId);return(s==null?void 0:s.id)??null}getFocusedTaskId(){const e=document.activeElement;if(!e)return null;const t=e.closest("[data-task-id]");return(t==null?void 0:t.dataset.taskId)??null}getSelectedBlockContext(){const e=window.getSelection(),t=e==null?void 0:e.anchorNode;if(!t)return null;const s=t instanceof HTMLElement?t:t.parentElement;if(!s)return null;const n=s.closest("[data-node-id]");if(!n)return null;const a=n.getAttribute("data-node-id");return a?{blockId:a,blockContent:n.textContent||""}:null}buildCreatePayload(e){const t=this.getSelectedBlockContext();return t?{source:e,linkedBlockId:t.blockId,linkedBlockContent:t.blockContent,suggestedName:Ya(t.blockContent),suggestedTime:Ha(t.blockContent)}:{source:e}}async quickCompleteNextTask(){try{const e=this.repository.getTodayAndOverdueTasks();if(e.length===0)return;const t=e[0];await this.taskCommands.completeTask(t.id)}catch(e){be("Failed to quick complete task",e),Q.error("Failed to complete task")}}getDefinition(e){return Nr.find(t=>t.id===e)}findDuplicateHotkey(e,t){if(!t)return null;const s=t.toLowerCase(),n=Nr.find(a=>a.id===e?!1:(this.settings[a.id]||"").toLowerCase()===s);return n?{id:n.id,label:n.label,description:n.description,context:n.context,currentHotkey:this.settings[n.id],defaultHotkey:n.defaultHotkey}:null}}async function ry(r,e,t,s,n){const a=new sy(r,e,s,n,t);return await a.initialize(),a.registerShortcuts(),a}class ny{constructor(e,t){k(this,"plugin");k(this,"repository");k(this,"topbarElement",null);k(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),de("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),de("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const n=new Date(s.dueAt);return n<new Date&&!vi(n)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){ze.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class ay{constructor(e="tasks"){k(this,"codeLanguage");k(this,"cachedCodeBlocks",new WeakMap);k(this,"cachedAttributeBlocks",new WeakMap);this.codeLanguage=e.toLowerCase()}parse(e){const t=[];let s=this.cachedCodeBlocks.get(e);s||(s=e.querySelectorAll('[data-type="NodeCodeBlock"]'),this.cachedCodeBlocks.set(e,s)),s.forEach(a=>{var h;if((a.dataset.subtype||a.getAttribute("data-subtype")||"").toLowerCase()!==this.codeLanguage)return;const l=a.querySelector("code")||a.querySelector("textarea")||a.querySelector(".hljs")||a,c=((h=l==null?void 0:l.textContent)==null?void 0:h.trim())??"";if(!c)return;const u=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:u,query:c,element:a,source:"code"})});let n=this.cachedAttributeBlocks.get(e);return n||(n=e.querySelectorAll("[data-node-id]"),this.cachedAttributeBlocks.set(e,n)),n.forEach(a=>{if(a.classList.contains("rt-inline-query")||a.getAttribute("data-type")==="NodeCodeBlock")return;const o=this.parseAttributes(a);if(!o.query)return;const l=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:l,query:o.query,view:o.view,element:a,source:"attribute"})}),t}parseAttributes(e){var a;const t=e.getAttribute("custom-task-query")||e.getAttribute("data-attr-custom-task-query")||e.dataset.customTaskQuery||e.dataset.attrCustomTaskQuery,s=e.getAttribute("custom-task-view")||e.getAttribute("data-attr-custom-task-view")||e.dataset.customTaskView||e.dataset.attrCustomTaskView;if(t)return{query:t.trim(),view:s};const n=e.getAttribute("data-attrs");if(!n)return{};try{const o=JSON.parse(n),l=(a=o["custom-task-query"])==null?void 0:a.trim(),c=o["custom-task-view"];return{query:l,view:c}}catch{return{}}}}class iy{constructor(e=6e4,t=100){k(this,"cache",new Map);k(this,"metrics",{hits:0,misses:0,evictions:0});k(this,"maxSize");this.ttlMs=e,this.maxSize=t}buildKey(e,t){return`${e}::${t}`}get(e){const t=this.cache.get(e);return t?this.ttlMs>0&&Date.now()-t.updatedAt>this.ttlMs?(this.cache.delete(e),this.metrics.misses++,null):(t.lastAccessedAt=Date.now(),this.metrics.hits++,t):(this.metrics.misses++,null)}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictLRU();const s=Date.now();this.cache.set(e,{result:t,updatedAt:s,lastAccessedAt:s})}clear(){this.cache.clear()}evictLRU(){let e=null,t=1/0;for(const[s,n]of this.cache.entries())n.lastAccessedAt<t&&(t=n.lastAccessedAt,e=s);e&&(this.cache.delete(e),this.metrics.evictions++)}getMetrics(){return{hits:this.metrics.hits,misses:this.metrics.misses,size:this.cache.size,evictions:this.metrics.evictions}}resetMetrics(){this.metrics.hits=0,this.metrics.misses=0,this.metrics.evictions=0}}class oy{render(e,t){if(e.innerHTML="",e.classList.add("rt-inline-query"),e.dataset.query=t.query,e.dataset.view=t.view,t.isIndexing){e.appendChild(this.renderLoadingState());return}if(t.error){e.appendChild(this.renderErrorState(t.error));return}if(!t.result){e.appendChild(this.renderState("No results yet."));return}const s=t.result.tasks,n=s.length;if(n===0||s.length===0){e.appendChild(this.renderEmptyState());return}const a=document.createElement("div");a.className="rt-inline-query__header",a.textContent=`Inline Tasks · ${n}`,e.appendChild(a);const o=t.view||"list",l=t.result.groups;if(l&&l.size>0?l.forEach((c,u)=>{const h=this.renderGroupSection(u,c,o,t);e.appendChild(h)}):e.appendChild(this.renderTaskCollection(s,o,t)),typeof t.maxItems=="number"&&typeof t.renderedCount=="number"&&t.renderedCount<n){const c=document.createElement("div");c.className="rt-inline-query__footer";const u=document.createElement("button");u.type="button",u.className="rt-inline-query__more",u.dataset.rtAction="more",u.textContent=`Show more (${t.renderedCount}/${n})`,c.appendChild(u),e.appendChild(c)}}renderGroupSection(e,t,s,n){const a=document.createElement("section");a.className="rt-inline-query__group";const o=document.createElement("div");return o.className="rt-inline-query__group-title",o.textContent=e||"Untitled",a.appendChild(o),a.appendChild(this.renderTaskCollection(t,s,n)),a}renderTaskCollection(e,t,s){return t==="table"?this.renderTable(e,s):this.renderList(e,s)}renderList(e,t){const s=document.createElement("ul");s.className="rt-inline-query__list";const n=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(o=>{const l=document.createElement("li");l.className="rt-inline-query__item",l.dataset.taskId=o.id;const c=document.createElement("button");c.type="button",c.className="rt-inline-query__checkbox",c.dataset.rtAction="toggle",c.setAttribute("aria-pressed",String(o.status==="done")),c.textContent=o.status==="done"?"☑":"☐";const u=document.createElement("span");u.className="rt-inline-query__title",u.textContent=o.name,o.status==="done"&&u.classList.add("rt-inline-query__title--done");const h=document.createElement("span");h.className="rt-inline-query__meta",h.textContent=this.formatTaskMeta(o);const p=this.renderSource(o),v=document.createElement("button");v.type="button",v.className="rt-inline-query__edit",v.dataset.rtAction="edit",v.textContent="Edit",l.appendChild(c),l.appendChild(u),l.appendChild(h),p&&l.appendChild(p),l.appendChild(v),n.appendChild(l)}),s.appendChild(n),s}renderTable(e,t){const s=document.createElement("table");s.className="rt-inline-query__table";const n=document.createElement("thead"),a=document.createElement("tr");["Status","Task","Dates","Priority","Source",""].forEach(u=>{const h=document.createElement("th");h.textContent=u,a.appendChild(h)}),n.appendChild(a),s.appendChild(n);const o=document.createElement("tbody"),l=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(u=>{const h=document.createElement("tr");h.dataset.taskId=u.id;const p=document.createElement("td"),v=document.createElement("button");v.type="button",v.className="rt-inline-query__checkbox",v.dataset.rtAction="toggle",v.setAttribute("aria-pressed",String(u.status==="done")),v.textContent=u.status==="done"?"☑":"☐",p.appendChild(v);const y=document.createElement("td");y.textContent=u.name,u.status==="done"&&y.classList.add("rt-inline-query__title--done");const w=document.createElement("td");w.textContent=this.formatTaskDates(u);const m=document.createElement("td");m.textContent=u.priority??"—";const g=document.createElement("td"),_=this.renderSource(u);_?g.appendChild(_):g.textContent="—";const E=document.createElement("td"),D=document.createElement("button");D.type="button",D.className="rt-inline-query__edit",D.dataset.rtAction="edit",D.textContent="Edit",E.appendChild(D),h.appendChild(p),h.appendChild(y),h.appendChild(w),h.appendChild(m),h.appendChild(g),h.appendChild(E),l.appendChild(h)}),o.appendChild(l),s.appendChild(o),s}getRenderedTasks(e,t){return t.maxItems?e.slice(0,t.maxItems):e}formatTaskDates(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),t.length>0?t.join(" · "):"—"}formatTaskMeta(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),e.priority&&t.push(`Priority ${e.priority}`),t.length>0?t.join(" · "):"No dates"}formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString()}catch{return e}}renderSource(e){if(!e.linkedBlockId&&!e.path)return null;const t=document.createElement("a");return t.className="rt-inline-query__source",t.dataset.rtAction="jump",t.dataset.blockId=e.linkedBlockId??"",e.linkedBlockId&&(t.href=`siyuan://blocks/${e.linkedBlockId}`),t.textContent=this.formatSourceLabel(e),t.title=e.path??e.linkedBlockId??"",t}formatSourceLabel(e){if(e.path){const t=e.path.split("/");return t[t.length-1]||e.path}return e.linkedBlockId?"Block":"Source"}renderState(e,t="info"){const s=document.createElement("div");return s.className=`rt-inline-query__state rt-inline-query__state--${t}`,s.textContent=e,s}renderLoadingState(){const e=document.createElement("div");e.className="rt-inline-query__loading",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Loading tasks");const t=document.createElement("div");t.className="rt-inline-query__spinner";const s=document.createElement("div");return s.className="rt-inline-query__loading-text",s.textContent="Building index…",e.appendChild(t),e.appendChild(s),e}renderErrorState(e){const t=document.createElement("div");t.className="rt-inline-query__state rt-inline-query__state--error",t.setAttribute("role","alert");const s=document.createElement("div");s.className="rt-inline-query__error-icon",s.textContent="⚠";const n=document.createElement("div");n.className="rt-inline-query__error-message",n.textContent=e;const a=document.createElement("div");return a.className="rt-inline-query__error-hint",a.textContent="Check your query syntax and try again.",t.appendChild(s),t.appendChild(n),t.appendChild(a),t}renderEmptyState(){const e=document.createElement("div");e.className="rt-inline-query__state rt-inline-query__state--empty";const t=document.createElement("div");t.className="rt-inline-query__empty-icon",t.textContent="📋";const s=document.createElement("div");s.className="rt-inline-query__empty-message",s.textContent="No tasks match this query";const n=document.createElement("div");return n.className="rt-inline-query__empty-hint",n.textContent="Try adjusting your filters or create a new task.",e.appendChild(t),e.appendChild(s),e.appendChild(n),e}}class ly{constructor(e){k(this,"parser",new ay);k(this,"renderer",new oy);k(this,"cache",new iy);k(this,"queryComposer",new Ol(new Js));k(this,"blocks",new Map);k(this,"refreshTimer");k(this,"indexReady",!1);k(this,"unsubs",[]);k(this,"debounceMs");k(this,"pageSize");this.options=e,this.debounceMs=e.debounceMs??300,this.pageSize=e.pageSize??50}mount(){var n,a,o,l;this.refreshAll();const{plugin:e}=this.options,t=()=>this.scheduleRefresh(),s=()=>this.scheduleRefresh();try{const c=(a=(n=e.eventBus).on)==null?void 0:a.call(n,"loaded-protyle",t),u=(l=(o=e.eventBus).on)==null?void 0:l.call(o,"switch-protyle",s);typeof c=="function"&&this.unsubs.push(c),typeof u=="function"&&this.unsubs.push(u)}catch(c){Qe("Inline query controller failed to bind protyle events",c)}this.unsubs.push(ze.on("task:refresh",()=>{this.cache.clear(),this.scheduleRefresh()})),this.unsubs.push(ze.on("task:settings",()=>{this.cache.clear(),this.scheduleRefresh()}))}destroy(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.blocks.forEach(({container:e})=>e.remove()),this.blocks.clear(),this.unsubs.forEach(e=>e()),this.unsubs=[]}scheduleRefresh(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.refreshTimer=globalThis.setTimeout(()=>{this.refreshAll()},this.debounceMs)}refreshAll(){const e=this.getProtyleRoots();if(e.length===0)return;const t=new Set;e.forEach(s=>{this.parser.parse(s).forEach(a=>{t.add(a.id);const o=this.getOrCreateBlockState(a);this.renderBlock(o)})}),Array.from(this.blocks.keys()).forEach(s=>{if(!t.has(s)){const n=this.blocks.get(s);n==null||n.container.remove(),this.blocks.delete(s)}}),this.indexReady=!0}renderBlock(e){const{block:t}=e,s=t.view??"list";if(!this.indexReady){this.renderer.render(e.container,{query:t.query,view:s,isIndexing:!0});return}let n,a;try{a=this.executeQuery(t.query)}catch(l){n=l instanceof Error?l.message:String(l)}const o=a?Math.min(e.renderLimit,a.tasks.length):0;this.renderer.render(e.container,{query:t.query,view:s,result:a,error:n,maxItems:e.renderLimit,renderedCount:o})}executeQuery(e){const t=this.options.settingsService.get(),s=this.buildSettingsHash(t),n=this.cache.buildKey(e,s),a=this.cache.get(n);if(a)return a.result;const o={getAllTasks:()=>this.options.repository.getAllTasks()},l=new Il(o,{urgencySettings:t.urgency}),c=$r.getInstance();if(c.isEnabled()&&c.getError())throw new Error(`Global query error: ${c.getError()}`);const u=this.queryComposer.compose(e,c.getAST()).ast,h=l.execute(u);return this.cache.set(n,h),h}buildSettingsHash(e){try{return JSON.stringify(e)}catch{return String(Date.now())}}getOrCreateBlockState(e){const t=this.blocks.get(e.id);if(t)return t.block=e,t;const s=document.createElement("div");s.dataset.rtInlineQuery=e.id,s.className="rt-inline-query",e.element.insertAdjacentElement("afterend",s),s.addEventListener("click",a=>this.handleContainerClick(a));const n={block:e,container:s,renderLimit:this.pageSize};return this.blocks.set(e.id,n),n}handleContainerClick(e){const t=e.target;if(!t)return;const s=t.closest("[data-rt-action]");if(!s)return;const n=s.dataset.rtAction,a=t.closest(".rt-inline-query");if(!a)return;const o=a.dataset.rtInlineQuery;if(!o)return;const l=this.blocks.get(o);if(!l)return;if(n==="more"){l.renderLimit+=this.pageSize,this.renderBlock(l);return}const c=t.closest("[data-task-id]"),u=c==null?void 0:c.dataset.taskId;if(u){if(n==="toggle"){this.options.onToggleTask(u);return}if(n==="edit"){const h=this.options.repository.getTask(u);h&&this.options.onEditTask(h)}}}getProtyleRoots(){return Array.from(document.querySelectorAll(".protyle-wysiwyg"))}}class cy extends Wa.Plugin{constructor(){super(...arguments);k(this,"taskManager");k(this,"repository");k(this,"scheduler");k(this,"eventService");k(this,"migrationManager");k(this,"topbarMenu");k(this,"settingsService");k(this,"dashboardComponent",null);k(this,"dockEl");k(this,"quickAddComponent",null);k(this,"quickAddContainer",null);k(this,"taskEditorComponent",null);k(this,"taskEditorContainer",null);k(this,"postponeComponent",null);k(this,"postponeContainer",null);k(this,"pendingCompletionTimeouts",new Map);k(this,"shortcutManager",null);k(this,"inlineQueryController",null);k(this,"handleCreateTaskEvent",t=>{try{const s=t;de("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){be("Failed to handle create task event",s),Q.error("Failed to open task creator.")}});k(this,"handleSettingsEvent",t=>{try{de("Settings event received",t.detail),this.openDock()}catch(s){be("Failed to handle settings event",s),Q.error("Failed to open settings.")}});k(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:n}=s.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(s){be("Failed to complete task",s),Q.error("Failed to complete task.")}});k(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:n,minutes:a}=s.detail??{};if(!n||typeof a!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,a)}catch(s){be("Failed to snooze task",s),Q.error("Failed to snooze task.")}})}async onload(){de("Loading Recurring Tasks Plugin"),this.migrationManager=new Ev(this);try{await this.migrationManager.migrate(lr)}catch(n){be("Migration failed, continuing with existing data",n)}const t=Wn.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const s=this.taskManager.getSettingsService();this.settingsService=s;try{await this.taskManager.start()}catch(n){be("Failed to start TaskManager",n)}this.shortcutManager=await ry(this,this.repository,{createTask:n=>this.dispatchCreateTask(n),completeTask:n=>ze.emit("task:complete",{taskId:n}),postponeTask:n=>this.openPostponePicker(n),openDock:()=>this.openDock(),openTaskEditor:()=>this.openTaskEditor()},this.scheduler.getRecurrenceEngine(),()=>s.get()),Jp(this),this.topbarMenu=new ny(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:qu,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),this.inlineQueryController=new ly({plugin:this,repository:this.repository,settingsService:this.settingsService,onEditTask:n=>this.openTaskEditor(n),onToggleTask:n=>ze.emit("task:complete",{taskId:n})}),this.inlineQueryController.mount(),de("Recurring Tasks Plugin loaded successfully")}async onunload(){de("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.closePostponePicker(),this.removeEventListeners(),this.shortcutManager&&(this.shortcutManager.destroy(),this.shortcutManager=null),this.inlineQueryController&&(this.inlineQueryController.destroy(),this.inlineQueryController=null)}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=xn(yv,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService,shortcutManager:this.shortcutManager,settingsService:this.settingsService}}))}destroyDashboard(){this.dashboardComponent&&(An(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{ze.on("task:create",t=>{de("Create task event received",t),this.openQuickAdd(t)}),ze.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),ze.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),ze.on("task:settings",()=>{this.openDock()}),ze.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){be("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){ze.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){Q.info(`Completion already pending for "${s.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),ze.emit("task:refresh",void 0),de(`Task completed: ${s.name}`)}catch(o){be("Failed to finalize task completion",o),Q.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const a=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),Q.info(`Undo: "${s.name}" restored`))};cr({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:a,showCountdown:!0})}}async handleSnoozeTask(t,s){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),de(`Task snoozed: ${n.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=xn(wv,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}openPostponePicker(t){const s=this.repository.getTask(t);if(!s){Q.error("Task not found");return}this.postponeComponent&&this.closePostponePicker(),this.postponeContainer=document.createElement("div"),document.body.appendChild(this.postponeContainer),this.postponeComponent=xn(Dv,{target:this.postponeContainer,props:{taskName:s.name,onClose:()=>this.closePostponePicker(),onSelect:n=>{ja(t,n),this.closePostponePicker()}}})}closePostponePicker(){this.postponeComponent&&(An(this.postponeComponent),this.postponeComponent=null),this.postponeContainer&&(this.postponeContainer.remove(),this.postponeContainer=null)}dispatchCreateTask(t){ze.emit("task:create",t),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:t}))}closeQuickAdd(){this.quickAddComponent&&(An(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=xn(Ml,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(An(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=cy;

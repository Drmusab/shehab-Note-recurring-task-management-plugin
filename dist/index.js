"use strict";var ho=Object.defineProperty;var nr=s=>{throw TypeError(s)};var fo=(s,e,t)=>e in s?ho(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var E=(s,e,t)=>fo(s,typeof e!="symbol"?e+"":e,t),vn=(s,e,t)=>e.has(s)||nr("Cannot "+t);var I=(s,e,t)=>(vn(s,e,"read from private field"),t?t.call(s):e.get(s)),Ee=(s,e,t)=>e.has(s)?nr("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Te=(s,e,t,a)=>(vn(s,e,"write to private field"),a?a.call(s,t):e.set(s,t),t),at=(s,e,t)=>(vn(s,e,"access private method"),t);const jn=require("siyuan"),wn=!1;var Kn=Array.isArray,_o=Array.prototype.indexOf,sn=Array.from,po=Object.defineProperty,ia=Object.getOwnPropertyDescriptor,go=Object.getOwnPropertyDescriptors,mo=Object.prototype,yo=Array.prototype,Vr=Object.getPrototypeOf,rr=Object.isExtensible;function ko(s){for(var e=0;e<s.length;e++)s[e]()}function Wr(){var s,e,t=new Promise((a,n)=>{s=a,e=n});return{promise:t,resolve:s,reject:e}}function Qr(s,e){if(Array.isArray(s))return s;if(!(Symbol.iterator in s))return Array.from(s);const t=[];for(const a of s)if(t.push(a),t.length===e)break;return t}const ot=2,Wa=4,an=8,Xr=1<<24,hs=16,fs=32,Xs=64,Un=128,Pt=512,ht=1024,kt=2048,_s=4096,It=8192,cs=16384,Hn=32768,_a=65536,ir=1<<17,Jr=1<<18,ya=1<<19,bo=1<<20,os=1<<25,Ws=32768,Sn=1<<21,Gn=1<<22,Ds=1<<23,Us=Symbol("$state"),wo=Symbol("legacy props"),So=Symbol(""),ra=new class extends Error{constructor(){super(...arguments);E(this,"name","StaleReactionError");E(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function Zr(s){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function To(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Do(s){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Eo(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Ao(s){throw new Error("https://svelte.dev/e/effect_orphan")}function xo(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Co(s){throw new Error("https://svelte.dev/e/props_invalid_value")}function Io(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function qo(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Oo(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Mo(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const No=1,Ro=2,$r=4,Fo=8,Bo=16,Po=1,zo=4,Lo=8,jo=16,Ko=1,Uo=2,nt=Symbol(),Ho="http://www.w3.org/1999/xhtml";function Go(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Yo(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function ei(s){return s===this.v}function Vo(s,e){return s!=s?e==e:s!==e||s!==null&&typeof s=="object"||typeof s=="function"}function ti(s){return!Vo(s,this.v)}let Wo=!1,Tt=null;function pa(s){Tt=s}function Ke(s,e=!1,t){Tt={p:Tt,i:!1,c:null,e:null,s,x:null,l:null}}function Ue(s){var e=Tt,t=e.e;if(t!==null){e.e=null;for(var a of t)bi(a)}return e.i=!0,Tt=e.p,{}}function si(){return!0}let Ns=[];function ai(){var s=Ns;Ns=[],ko(s)}function ka(s){if(Ns.length===0&&!Aa){var e=Ns;queueMicrotask(()=>{e===Ns&&ai()})}Ns.push(s)}function Qo(){for(;Ns.length>0;)ai()}function ni(s){var e=Ce;if(e===null)return we.f|=Ds,s;if(e.f&Hn)ga(s,e);else{if(!(e.f&Un))throw s;e.b.error(s)}}function ga(s,e){for(;e!==null;){if(e.f&Un)try{e.b.error(s);return}catch(t){s=t}e=e.parent}throw s}const Xo=-7169;function Qe(s,e){s.f=s.f&Xo|e}function Yn(s){s.f&Pt||s.deps===null?Qe(s,ht):Qe(s,_s)}function ri(s){if(s!==null)for(const e of s)!(e.f&ot)||!(e.f&Ws)||(e.f^=Ws,ri(e.deps))}function ii(s,e,t){s.f&kt?e.add(s):s.f&_s&&t.add(s),ri(s.deps),Qe(s,ht)}const ja=new Set;let be=null,Ea=null,rt=null,Ft=[],nn=null,Tn=!1,Aa=!1;var ca,da,Bs,Ps,Na,ua,va,zt,Dn,En,oi,li;const $a=class $a{constructor(){Ee(this,zt);E(this,"committed",!1);E(this,"current",new Map);E(this,"previous",new Map);Ee(this,ca,new Set);Ee(this,da,new Set);Ee(this,Bs,0);Ee(this,Ps,0);Ee(this,Na,null);Ee(this,ua,new Set);Ee(this,va,new Set);E(this,"skipped_effects",new Set);E(this,"is_fork",!1)}is_deferred(){return this.is_fork||I(this,Ps)>0}process(e){var n;Ft=[],Ea=null,this.apply();var t=[],a=[];for(const i of e)at(this,zt,Dn).call(this,i,t,a);this.is_fork||at(this,zt,oi).call(this),this.is_deferred()?(at(this,zt,En).call(this,a),at(this,zt,En).call(this,t)):(Ea=this,be=null,or(a),or(t),Ea=null,(n=I(this,Na))==null||n.resolve()),rt=null}capture(e,t){t!==nt&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Ds||(this.current.set(e,e.v),rt==null||rt.set(e,e.v))}activate(){be=this,this.apply()}deactivate(){be===this&&(be=null,rt=null)}flush(){if(this.activate(),Ft.length>0){if(ci(),be!==null&&be!==this)return}else I(this,Bs)===0&&this.process([]);this.deactivate()}discard(){for(const e of I(this,da))e(this);I(this,da).clear()}increment(e){Te(this,Bs,I(this,Bs)+1),e&&Te(this,Ps,I(this,Ps)+1)}decrement(e){Te(this,Bs,I(this,Bs)-1),e&&Te(this,Ps,I(this,Ps)-1),this.revive()}revive(){for(const e of I(this,ua))I(this,va).delete(e),Qe(e,kt),us(e);for(const e of I(this,va))Qe(e,_s),us(e);this.flush()}oncommit(e){I(this,ca).add(e)}ondiscard(e){I(this,da).add(e)}settled(){return(I(this,Na)??Te(this,Na,Wr())).promise}static ensure(){if(be===null){const e=be=new $a;ja.add(be),Aa||$a.enqueue(()=>{be===e&&e.flush()})}return be}static enqueue(e){ka(e)}apply(){}};ca=new WeakMap,da=new WeakMap,Bs=new WeakMap,Ps=new WeakMap,Na=new WeakMap,ua=new WeakMap,va=new WeakMap,zt=new WeakSet,Dn=function(e,t,a){e.f^=ht;for(var n=e.first,i=null;n!==null;){var o=n.f,c=(o&(fs|Xs))!==0,l=c&&(o&ht)!==0,u=l||(o&It)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){c?n.f^=ht:i!==null&&o&(Wa|an|Xr)?i.b.defer_effect(n):o&Wa?t.push(n):Pa(n)&&(o&hs&&I(this,ua).add(n),qa(n));var h=n.first;if(h!==null){n=h;continue}}var m=n.parent;for(n=n.next;n===null&&m!==null;)m===i&&(i=null),n=m.next,m=m.parent}},En=function(e){for(var t=0;t<e.length;t+=1)ii(e[t],I(this,ua),I(this,va))},oi=function(){if(I(this,Ps)===0){for(const e of I(this,ca))e();I(this,ca).clear()}I(this,Bs)===0&&at(this,zt,li).call(this)},li=function(){var n;if(ja.size>1){this.previous.clear();var e=rt,t=!0;for(const i of ja){if(i===this){t=!1;continue}const o=[];for(const[l,u]of this.current){if(i.current.has(l))if(t&&u!==i.current.get(l))i.current.set(l,u);else continue;o.push(l)}if(o.length===0)continue;const c=[...i.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var a=Ft;Ft=[];const l=new Set,u=new Map;for(const h of o)di(h,c,l,u);if(Ft.length>0){be=i,i.apply();for(const h of Ft)at(n=i,zt,Dn).call(n,h,[],[]);i.deactivate()}Ft=a}}be=null,rt=e}this.committed=!0,ja.delete(this)};let ls=$a;function Jo(s){var e=Aa;Aa=!0;try{for(var t;;){if(Qo(),Ft.length===0&&(be==null||be.flush(),Ft.length===0))return nn=null,t;ci()}}finally{Aa=e}}function ci(){var s=Gs;Tn=!0;var e=null;try{var t=0;for(Xa(!0);Ft.length>0;){var a=ls.ensure();if(t++>1e3){var n,i;Zo()}a.process(Ft),Es.clear()}}finally{Tn=!1,Xa(s),nn=null}}function Zo(){try{xo()}catch(s){ga(s,nn)}}let Gt=null;function or(s){var e=s.length;if(e!==0){for(var t=0;t<e;){var a=s[t++];if(!(a.f&(cs|It))&&Pa(a)&&(Gt=new Set,qa(a),a.deps===null&&a.first===null&&a.nodes===null&&(a.teardown===null&&a.ac===null?Ei(a):a.fn=null),(Gt==null?void 0:Gt.size)>0)){Es.clear();for(const n of Gt){if(n.f&(cs|It))continue;const i=[n];let o=n.parent;for(;o!==null;)Gt.has(o)&&(Gt.delete(o),i.push(o)),o=o.parent;for(let c=i.length-1;c>=0;c--){const l=i[c];l.f&(cs|It)||qa(l)}}Gt.clear()}}Gt=null}}function di(s,e,t,a){if(!t.has(s)&&(t.add(s),s.reactions!==null))for(const n of s.reactions){const i=n.f;i&ot?di(n,e,t,a):i&(Gn|hs)&&!(i&kt)&&ui(n,e,a)&&(Qe(n,kt),us(n))}}function ui(s,e,t){const a=t.get(s);if(a!==void 0)return a;if(s.deps!==null)for(const n of s.deps){if(e.includes(n))return!0;if(n.f&ot&&ui(n,e,t))return t.set(n,!0),!0}return t.set(s,!1),!1}function us(s){for(var e=nn=s;e.parent!==null;){e=e.parent;var t=e.f;if(Tn&&e===Ce&&t&hs&&!(t&Jr))return;if(t&(Xs|fs)){if(!(t&ht))return;e.f^=ht}}Ft.push(e)}function $o(s){let e=0,t=Qs(0),a;return()=>{Qn()&&(r(t),ln(()=>(e===0&&(a=Js(()=>s(()=>xa(t)))),e+=1,()=>{ka(()=>{e-=1,e===0&&(a==null||a(),a=void 0,xa(t))})})))}}var el=_a|ya|Un;function tl(s,e,t){new sl(s,e,t)}var Nt,Ln,Zt,zs,$t,Rt,bt,es,is,bs,Ls,ws,js,ha,fa,Ss,en,We,al,nl,An,Ua,Ha,xn;class sl{constructor(e,t,a){Ee(this,We);E(this,"parent");E(this,"is_pending",!1);Ee(this,Nt);Ee(this,Ln,null);Ee(this,Zt);Ee(this,zs);Ee(this,$t);Ee(this,Rt,null);Ee(this,bt,null);Ee(this,es,null);Ee(this,is,null);Ee(this,bs,null);Ee(this,Ls,0);Ee(this,ws,0);Ee(this,js,!1);Ee(this,ha,new Set);Ee(this,fa,new Set);Ee(this,Ss,null);Ee(this,en,$o(()=>(Te(this,Ss,Qs(I(this,Ls))),()=>{Te(this,Ss,null)})));Te(this,Nt,e),Te(this,Zt,t),Te(this,zs,a),this.parent=Ce.b,this.is_pending=!!I(this,Zt).pending,Te(this,$t,Jn(()=>{Ce.b=this;{var n=at(this,We,An).call(this);try{Te(this,Rt,Bt(()=>a(n)))}catch(i){this.error(i)}I(this,ws)>0?at(this,We,Ha).call(this):this.is_pending=!1}return()=>{var i;(i=I(this,bs))==null||i.remove()}},el))}defer_effect(e){ii(e,I(this,ha),I(this,fa))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!I(this,Zt).pending}update_pending_count(e){at(this,We,xn).call(this,e),Te(this,Ls,I(this,Ls)+e),I(this,Ss)&&ma(I(this,Ss),I(this,Ls))}get_effect_pending(){return I(this,en).call(this),r(I(this,Ss))}error(e){var t=I(this,Zt).onerror;let a=I(this,Zt).failed;if(I(this,js)||!t&&!a)throw e;I(this,Rt)&&(St(I(this,Rt)),Te(this,Rt,null)),I(this,bt)&&(St(I(this,bt)),Te(this,bt,null)),I(this,es)&&(St(I(this,es)),Te(this,es,null));var n=!1,i=!1;const o=()=>{if(n){Yo();return}n=!0,i&&Mo(),ls.ensure(),Te(this,Ls,0),I(this,es)!==null&&Hs(I(this,es),()=>{Te(this,es,null)}),this.is_pending=this.has_pending_snippet(),Te(this,Rt,at(this,We,Ua).call(this,()=>(Te(this,js,!1),Bt(()=>I(this,zs).call(this,I(this,Nt)))))),I(this,ws)>0?at(this,We,Ha).call(this):this.is_pending=!1};var c=we;try{wt(null),i=!0,t==null||t(e,o),i=!1}catch(l){ga(l,I(this,$t)&&I(this,$t).parent)}finally{wt(c)}a&&ka(()=>{Te(this,es,at(this,We,Ua).call(this,()=>{ls.ensure(),Te(this,js,!0);try{return Bt(()=>{a(I(this,Nt),()=>e,()=>o)})}catch(l){return ga(l,I(this,$t).parent),null}finally{Te(this,js,!1)}}))})}}Nt=new WeakMap,Ln=new WeakMap,Zt=new WeakMap,zs=new WeakMap,$t=new WeakMap,Rt=new WeakMap,bt=new WeakMap,es=new WeakMap,is=new WeakMap,bs=new WeakMap,Ls=new WeakMap,ws=new WeakMap,js=new WeakMap,ha=new WeakMap,fa=new WeakMap,Ss=new WeakMap,en=new WeakMap,We=new WeakSet,al=function(){try{Te(this,Rt,Bt(()=>I(this,zs).call(this,I(this,Nt))))}catch(e){this.error(e)}},nl=function(){const e=I(this,Zt).pending;e&&(Te(this,bt,Bt(()=>e(I(this,Nt)))),ls.enqueue(()=>{var t=at(this,We,An).call(this);Te(this,Rt,at(this,We,Ua).call(this,()=>(ls.ensure(),Bt(()=>I(this,zs).call(this,t))))),I(this,ws)>0?at(this,We,Ha).call(this):(Hs(I(this,bt),()=>{Te(this,bt,null)}),this.is_pending=!1)}))},An=function(){var e=I(this,Nt);return this.is_pending&&(Te(this,bs,ds()),I(this,Nt).before(I(this,bs)),e=I(this,bs)),e},Ua=function(e){var t=Ce,a=we,n=Tt;ss(I(this,$t)),wt(I(this,$t)),pa(I(this,$t).ctx);try{return e()}catch(i){return ni(i),null}finally{ss(t),wt(a),pa(n)}},Ha=function(){const e=I(this,Zt).pending;I(this,Rt)!==null&&(Te(this,is,document.createDocumentFragment()),I(this,is).append(I(this,bs)),Ci(I(this,Rt),I(this,is))),I(this,bt)===null&&Te(this,bt,Bt(()=>e(I(this,Nt))))},xn=function(e){var t;if(!this.has_pending_snippet()){this.parent&&at(t=this.parent,We,xn).call(t,e);return}if(Te(this,ws,I(this,ws)+e),I(this,ws)===0){this.is_pending=!1;for(const a of I(this,ha))Qe(a,kt),us(a);for(const a of I(this,fa))Qe(a,_s),us(a);I(this,ha).clear(),I(this,fa).clear(),I(this,bt)&&Hs(I(this,bt),()=>{Te(this,bt,null)}),I(this,is)&&(I(this,Nt).before(I(this,is)),Te(this,is,null))}};function rl(s,e,t,a){const n=rn;if(t.length===0&&s.length===0){a(e.map(n));return}var i=be,o=Ce,c=il();function l(){Promise.all(t.map(u=>ol(u))).then(u=>{c();try{a([...e.map(n),...u])}catch(h){o.f&cs||ga(h,o)}i==null||i.deactivate(),Qa()}).catch(u=>{ga(u,o)})}s.length>0?Promise.all(s).then(()=>{c();try{return l()}finally{i==null||i.deactivate(),Qa()}}):l()}function il(){var s=Ce,e=we,t=Tt,a=be;return function(i=!0){ss(s),wt(e),pa(t),i&&(a==null||a.activate())}}function Qa(){ss(null),wt(null),pa(null)}function rn(s){var e=ot|kt,t=we!==null&&we.f&ot?we:null;return Ce!==null&&(Ce.f|=ya),{ctx:Tt,deps:null,effects:null,equals:ei,f:e,fn:s,reactions:null,rv:0,v:nt,wv:0,parent:t??Ce,ac:null}}function ol(s,e,t){let a=Ce;a===null&&To();var n=a.b,i=void 0,o=Qs(nt),c=!we,l=new Map;return ml(()=>{var _;var u=Wr();i=u.promise;try{Promise.resolve(s()).then(u.resolve,u.reject).then(()=>{h===be&&h.committed&&h.deactivate(),Qa()})}catch(q){u.reject(q),Qa()}var h=be;if(c){var m=n.is_rendered();n.update_pending_count(1),h.increment(m),(_=l.get(h))==null||_.reject(ra),l.delete(h),l.set(h,u)}const y=(q,g=void 0)=>{if(h.activate(),g)g!==ra&&(o.f|=Ds,ma(o,g));else{o.f&Ds&&(o.f^=Ds),ma(o,q);for(const[p,w]of l){if(l.delete(p),p===h)break;w.reject(ra)}}c&&(n.update_pending_count(-1),h.decrement(m))};u.promise.then(y,q=>y(null,q||"unknown"))}),Xn(()=>{for(const u of l.values())u.reject(ra)}),new Promise(u=>{function h(m){function y(){m===i?u(o):h(i)}m.then(y,y)}h(i)})}function Q(s){const e=rn(s);return Ii(e),e}function vi(s){const e=rn(s);return e.equals=ti,e}function hi(s){var e=s.effects;if(e!==null){s.effects=null;for(var t=0;t<e.length;t+=1)St(e[t])}}function ll(s){for(var e=s.parent;e!==null;){if(!(e.f&ot))return e.f&cs?null:e;e=e.parent}return null}function Vn(s){var e,t=Ce;ss(ll(s));try{s.f&=~Ws,hi(s),e=Ni(s)}finally{ss(t)}return e}function fi(s){var e=Vn(s);if(!s.equals(e)&&(s.wv=Oi(),(!(be!=null&&be.is_fork)||s.deps===null)&&(s.v=e,s.deps===null))){Qe(s,ht);return}As||(rt!==null?(Qn()||be!=null&&be.is_fork)&&rt.set(s,e):Yn(s))}let Cn=new Set;const Es=new Map;let _i=!1;function Qs(s,e){var t={f:0,v:s,reactions:null,equals:ei,rv:0,wv:0};return t}function W(s,e){const t=Qs(s);return Ii(t),t}function cl(s,e=!1,t=!0){const a=Qs(s);return e||(a.equals=ti),a}function f(s,e,t=!1){we!==null&&(!Vt||we.f&ir)&&si()&&we.f&(ot|hs|Gn|ir)&&!(yt!=null&&yt.includes(s))&&Oo();let a=t?me(e):e;return ma(s,a)}function ma(s,e){if(!s.equals(e)){var t=s.v;As?Es.set(s,e):Es.set(s,t),s.v=e;var a=ls.ensure();if(a.capture(s,t),s.f&ot){const n=s;s.f&kt&&Vn(n),Yn(n)}s.wv=Oi(),pi(s,kt),Ce!==null&&Ce.f&ht&&!(Ce.f&(fs|Xs))&&(Mt===null?kl([s]):Mt.push(s)),!a.is_fork&&Cn.size>0&&!_i&&dl()}return e}function dl(){_i=!1;var s=Gs;Xa(!0);const e=Array.from(Cn);try{for(const t of e)t.f&ht&&Qe(t,_s),Pa(t)&&qa(t)}finally{Xa(s)}Cn.clear()}function lr(s,e=1){var t=r(s),a=e===1?t++:t--;return f(s,t),a}function xa(s){f(s,s.v+1)}function pi(s,e){var t=s.reactions;if(t!==null)for(var a=t.length,n=0;n<a;n++){var i=t[n],o=i.f,c=(o&kt)===0;if(c&&Qe(i,e),o&ot){var l=i;rt==null||rt.delete(l),o&Ws||(o&Pt&&(i.f|=Ws),pi(l,_s))}else c&&(o&hs&&Gt!==null&&Gt.add(i),us(i))}}function me(s){if(typeof s!="object"||s===null||Us in s)return s;const e=Vr(s);if(e!==mo&&e!==yo)return s;var t=new Map,a=Kn(s),n=W(0),i=Ys,o=c=>{if(Ys===i)return c();var l=we,u=Ys;wt(null),hr(i);var h=c();return wt(l),hr(u),h};return a&&t.set("length",W(s.length)),new Proxy(s,{defineProperty(c,l,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&Io();var h=t.get(l);return h===void 0?h=o(()=>{var m=W(u.value);return t.set(l,m),m}):f(h,u.value,!0),!0},deleteProperty(c,l){var u=t.get(l);if(u===void 0){if(l in c){const h=o(()=>W(nt));t.set(l,h),xa(n)}}else f(u,nt),xa(n);return!0},get(c,l,u){var _;if(l===Us)return s;var h=t.get(l),m=l in c;if(h===void 0&&(!m||(_=ia(c,l))!=null&&_.writable)&&(h=o(()=>{var q=me(m?c[l]:nt),g=W(q);return g}),t.set(l,h)),h!==void 0){var y=r(h);return y===nt?void 0:y}return Reflect.get(c,l,u)},getOwnPropertyDescriptor(c,l){var u=Reflect.getOwnPropertyDescriptor(c,l);if(u&&"value"in u){var h=t.get(l);h&&(u.value=r(h))}else if(u===void 0){var m=t.get(l),y=m==null?void 0:m.v;if(m!==void 0&&y!==nt)return{enumerable:!0,configurable:!0,value:y,writable:!0}}return u},has(c,l){var y;if(l===Us)return!0;var u=t.get(l),h=u!==void 0&&u.v!==nt||Reflect.has(c,l);if(u!==void 0||Ce!==null&&(!h||(y=ia(c,l))!=null&&y.writable)){u===void 0&&(u=o(()=>{var _=h?me(c[l]):nt,q=W(_);return q}),t.set(l,u));var m=r(u);if(m===nt)return!1}return h},set(c,l,u,h){var S;var m=t.get(l),y=l in c;if(a&&l==="length")for(var _=u;_<m.v;_+=1){var q=t.get(_+"");q!==void 0?f(q,nt):_ in c&&(q=o(()=>W(nt)),t.set(_+"",q))}if(m===void 0)(!y||(S=ia(c,l))!=null&&S.writable)&&(m=o(()=>W(void 0)),f(m,me(u)),t.set(l,m));else{y=m.v!==nt;var g=o(()=>me(u));f(m,g)}var p=Reflect.getOwnPropertyDescriptor(c,l);if(p!=null&&p.set&&p.set.call(h,u),!y){if(a&&typeof l=="string"){var w=t.get("length"),x=Number(l);Number.isInteger(x)&&x>=w.v&&f(w,x+1)}xa(n)}return!0},ownKeys(c){r(n);var l=Reflect.ownKeys(c).filter(m=>{var y=t.get(m);return y===void 0||y.v!==nt});for(var[u,h]of t)h.v!==nt&&!(u in c)&&l.push(u);return l},setPrototypeOf(){qo()}})}function cr(s){try{if(s!==null&&typeof s=="object"&&Us in s)return s[Us]}catch{}return s}function ul(s,e){return Object.is(cr(s),cr(e))}var dr,gi,mi,yi;function vl(){if(dr===void 0){dr=window,gi=/Firefox/.test(navigator.userAgent);var s=Element.prototype,e=Node.prototype,t=Text.prototype;mi=ia(e,"firstChild").get,yi=ia(e,"nextSibling").get,rr(s)&&(s.__click=void 0,s.__className=void 0,s.__attributes=null,s.__style=void 0,s.__e=void 0),rr(t)&&(t.__t=void 0)}}function ds(s=""){return document.createTextNode(s)}function Ts(s){return mi.call(s)}function Ba(s){return yi.call(s)}function d(s,e){return Ts(s)}function qe(s,e=!1){{var t=Ts(s);return t instanceof Comment&&t.data===""?Ba(t):t}}function v(s,e=1,t=!1){let a=s;for(;e--;)a=Ba(a);return a}function hl(s){s.textContent=""}function ki(){return!1}let ur=!1;function fl(){ur||(ur=!0,document.addEventListener("reset",s=>{Promise.resolve().then(()=>{var e;if(!s.defaultPrevented)for(const t of s.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function on(s){var e=we,t=Ce;wt(null),ss(null);try{return s()}finally{wt(e),ss(t)}}function Wn(s,e,t,a=t){s.addEventListener(e,()=>on(t));const n=s.__on_r;n?s.__on_r=()=>{n(),a(!0)}:s.__on_r=()=>a(!0),fl()}function _l(s){Ce===null&&(we===null&&Ao(),Eo()),As&&Do()}function pl(s,e){var t=e.last;t===null?e.last=e.first=s:(t.next=s,s.prev=t,e.last=s)}function ps(s,e,t){var a=Ce;a!==null&&a.f&It&&(s|=It);var n={ctx:Tt,deps:null,nodes:null,f:s|kt|Pt,first:null,fn:e,last:null,next:null,parent:a,b:a&&a.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{qa(n),n.f|=Hn}catch(c){throw St(n),c}else e!==null&&us(n);var i=n;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&!(i.f&ya)&&(i=i.first,s&hs&&s&_a&&i!==null&&(i.f|=_a)),i!==null&&(i.parent=a,a!==null&&pl(i,a),we!==null&&we.f&ot&&!(s&Xs))){var o=we;(o.effects??(o.effects=[])).push(i)}return n}function Qn(){return we!==null&&!Vt}function Xn(s){const e=ps(an,null,!1);return Qe(e,ht),e.teardown=s,e}function dt(s){_l();var e=Ce.f,t=!we&&(e&fs)!==0&&(e&Hn)===0;if(t){var a=Tt;(a.e??(a.e=[])).push(s)}else return bi(s)}function bi(s){return ps(Wa|bo,s,!1)}function gl(s){ls.ensure();const e=ps(Xs|ya,s,!0);return(t={})=>new Promise(a=>{t.outro?Hs(e,()=>{St(e),a(void 0)}):(St(e),a(void 0))})}function wi(s){return ps(Wa,s,!1)}function ml(s){return ps(Gn|ya,s,!0)}function ln(s,e=0){return ps(an|e,s,!0)}function H(s,e=[],t=[],a=[]){rl(a,e,t,n=>{ps(an,()=>s(...n.map(r)),!0)})}function Jn(s,e=0){var t=ps(hs|e,s,!0);return t}function Bt(s){return ps(fs|ya,s,!0)}function Si(s){var e=s.teardown;if(e!==null){const t=As,a=we;vr(!0),wt(null);try{e.call(null)}finally{vr(t),wt(a)}}}function Ti(s,e=!1){var t=s.first;for(s.first=s.last=null;t!==null;){const n=t.ac;n!==null&&on(()=>{n.abort(ra)});var a=t.next;t.f&Xs?t.parent=null:St(t,e),t=a}}function yl(s){for(var e=s.first;e!==null;){var t=e.next;e.f&fs||St(e),e=t}}function St(s,e=!0){var t=!1;(e||s.f&Jr)&&s.nodes!==null&&s.nodes.end!==null&&(Di(s.nodes.start,s.nodes.end),t=!0),Ti(s,e&&!t),Ja(s,0),Qe(s,cs);var a=s.nodes&&s.nodes.t;if(a!==null)for(const i of a)i.stop();Si(s);var n=s.parent;n!==null&&n.first!==null&&Ei(s),s.next=s.prev=s.teardown=s.ctx=s.deps=s.fn=s.nodes=s.ac=null}function Di(s,e){for(;s!==null;){var t=s===e?null:Ba(s);s.remove(),s=t}}function Ei(s){var e=s.parent,t=s.prev,a=s.next;t!==null&&(t.next=a),a!==null&&(a.prev=t),e!==null&&(e.first===s&&(e.first=a),e.last===s&&(e.last=t))}function Hs(s,e,t=!0){var a=[];Ai(s,a,!0);var n=()=>{t&&St(s),e&&e()},i=a.length;if(i>0){var o=()=>--i||n();for(var c of a)c.out(o)}else n()}function Ai(s,e,t){if(!(s.f&It)){s.f^=It;var a=s.nodes&&s.nodes.t;if(a!==null)for(const c of a)(c.is_global||t)&&e.push(c);for(var n=s.first;n!==null;){var i=n.next,o=(n.f&_a)!==0||(n.f&fs)!==0&&(s.f&hs)!==0;Ai(n,e,o?t:!1),n=i}}}function Zn(s){xi(s,!0)}function xi(s,e){if(s.f&It){s.f^=It,s.f&ht||(Qe(s,kt),us(s));for(var t=s.first;t!==null;){var a=t.next,n=(t.f&_a)!==0||(t.f&fs)!==0;xi(t,n?e:!1),t=a}var i=s.nodes&&s.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Ci(s,e){if(s.nodes)for(var t=s.nodes.start,a=s.nodes.end;t!==null;){var n=t===a?null:Ba(t);e.append(t),t=n}}let Gs=!1;function Xa(s){Gs=s}let As=!1;function vr(s){As=s}let we=null,Vt=!1;function wt(s){we=s}let Ce=null;function ss(s){Ce=s}let yt=null;function Ii(s){we!==null&&(yt===null?yt=[s]:yt.push(s))}let mt=null,xt=0,Mt=null;function kl(s){Mt=s}let qi=1,Ia=0,Ys=Ia;function hr(s){Ys=s}function Oi(){return++qi}function Pa(s){var e=s.f;if(e&kt)return!0;if(e&ot&&(s.f&=~Ws),e&_s){for(var t=s.deps,a=t.length,n=0;n<a;n++){var i=t[n];if(Pa(i)&&fi(i),i.wv>s.wv)return!0}e&Pt&&rt===null&&Qe(s,ht)}return!1}function Mi(s,e,t=!0){var a=s.reactions;if(a!==null&&!(yt!=null&&yt.includes(s)))for(var n=0;n<a.length;n++){var i=a[n];i.f&ot?Mi(i,e,!1):e===i&&(t?Qe(i,kt):i.f&ht&&Qe(i,_s),us(i))}}function Ni(s){var q;var e=mt,t=xt,a=Mt,n=we,i=yt,o=Tt,c=Vt,l=Ys,u=s.f;mt=null,xt=0,Mt=null,we=u&(fs|Xs)?null:s,yt=null,pa(s.ctx),Vt=!1,Ys=++Ia,s.ac!==null&&(on(()=>{s.ac.abort(ra)}),s.ac=null);try{s.f|=Sn;var h=s.fn,m=h(),y=s.deps;if(mt!==null){var _;if(Ja(s,xt),y!==null&&xt>0)for(y.length=xt+mt.length,_=0;_<mt.length;_++)y[xt+_]=mt[_];else s.deps=y=mt;if(Qn()&&s.f&Pt)for(_=xt;_<y.length;_++)((q=y[_]).reactions??(q.reactions=[])).push(s)}else y!==null&&xt<y.length&&(Ja(s,xt),y.length=xt);if(si()&&Mt!==null&&!Vt&&y!==null&&!(s.f&(ot|_s|kt)))for(_=0;_<Mt.length;_++)Mi(Mt[_],s);return n!==null&&n!==s&&(Ia++,Mt!==null&&(a===null?a=Mt:a.push(...Mt))),s.f&Ds&&(s.f^=Ds),m}catch(g){return ni(g)}finally{s.f^=Sn,mt=e,xt=t,Mt=a,we=n,yt=i,pa(o),Vt=c,Ys=l}}function bl(s,e){let t=e.reactions;if(t!==null){var a=_o.call(t,s);if(a!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[a]=t[n],t.pop())}}if(t===null&&e.f&ot&&(mt===null||!mt.includes(e))){var i=e;i.f&Pt&&(i.f^=Pt,i.f&=~Ws),Yn(i),hi(i),Ja(i,0)}}function Ja(s,e){var t=s.deps;if(t!==null)for(var a=e;a<t.length;a++)bl(s,t[a])}function qa(s){var e=s.f;if(!(e&cs)){Qe(s,ht);var t=Ce,a=Gs;Ce=s,Gs=!0;try{e&(hs|Xr)?yl(s):Ti(s),Si(s);var n=Ni(s);s.teardown=typeof n=="function"?n:null,s.wv=qi;var i;wn&&Wo&&s.f&kt&&s.deps}finally{Gs=a,Ce=t}}}async function Ri(){await Promise.resolve(),Jo()}function r(s){var e=s.f,t=(e&ot)!==0;if(we!==null&&!Vt){var a=Ce!==null&&(Ce.f&cs)!==0;if(!a&&!(yt!=null&&yt.includes(s))){var n=we.deps;if(we.f&Sn)s.rv<Ia&&(s.rv=Ia,mt===null&&n!==null&&n[xt]===s?xt++:mt===null?mt=[s]:mt.includes(s)||mt.push(s));else{(we.deps??(we.deps=[])).push(s);var i=s.reactions;i===null?s.reactions=[we]:i.includes(we)||i.push(we)}}}if(As&&Es.has(s))return Es.get(s);if(t){var o=s;if(As){var c=o.v;return(!(o.f&ht)&&o.reactions!==null||Bi(o))&&(c=Vn(o)),Es.set(o,c),c}var l=(o.f&Pt)===0&&!Vt&&we!==null&&(Gs||(we.f&Pt)!==0),u=o.deps===null;Pa(o)&&(l&&(o.f|=Pt),fi(o)),l&&!u&&Fi(o)}if(rt!=null&&rt.has(s))return rt.get(s);if(s.f&Ds)throw s.v;return s.v}function Fi(s){if(s.deps!==null){s.f|=Pt;for(const e of s.deps)(e.reactions??(e.reactions=[])).push(s),e.f&ot&&!(e.f&Pt)&&Fi(e)}}function Bi(s){if(s.v===nt)return!0;if(s.deps===null)return!1;for(const e of s.deps)if(Es.has(e)||e.f&ot&&Bi(e))return!0;return!1}function Js(s){var e=Vt;try{return Vt=!0,s()}finally{Vt=e}}const wl=["touchstart","touchmove"];function Sl(s){return wl.includes(s)}const Pi=new Set,In=new Set;function Tl(s,e,t,a={}){function n(i){if(a.capture||Ta.call(e,i),!i.cancelBubble)return on(()=>t==null?void 0:t.call(this,i))}return s.startsWith("pointer")||s.startsWith("touch")||s==="wheel"?ka(()=>{e.addEventListener(s,n,a)}):e.addEventListener(s,n,a),n}function it(s,e,t,a,n){var i={capture:a,passive:n},o=Tl(s,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Xn(()=>{e.removeEventListener(s,o,i)})}function Xe(s){for(var e=0;e<s.length;e++)Pi.add(s[e]);for(var t of In)t(s)}let fr=null;function Ta(s){var p;var e=this,t=e.ownerDocument,a=s.type,n=((p=s.composedPath)==null?void 0:p.call(s))||[],i=n[0]||s.target;fr=s;var o=0,c=fr===s&&s.__root;if(c){var l=n.indexOf(c);if(l!==-1&&(e===document||e===window)){s.__root=e;return}var u=n.indexOf(e);if(u===-1)return;l<=u&&(o=l)}if(i=n[o]||s.target,i!==e){po(s,"currentTarget",{configurable:!0,get(){return i||t}});var h=we,m=Ce;wt(null),ss(null);try{for(var y,_=[];i!==null;){var q=i.assignedSlot||i.parentNode||i.host||null;try{var g=i["__"+a];g!=null&&(!i.disabled||s.target===i)&&g.call(i,s)}catch(w){y?_.push(w):y=w}if(s.cancelBubble||q===e||q===null)break;i=q}if(y){for(let w of _)queueMicrotask(()=>{throw w});throw y}}finally{s.__root=e,delete s.currentTarget,wt(h),ss(m)}}}function zi(s){var e=document.createElement("template");return e.innerHTML=s.replaceAll("<!>","<!---->"),e.content}function Oa(s,e){var t=Ce;t.nodes===null&&(t.nodes={start:s,end:e,a:null,t:null})}function A(s,e){var t=(e&Ko)!==0,a=(e&Uo)!==0,n,i=!s.startsWith("<!>");return()=>{n===void 0&&(n=zi(i?s:"<!>"+s),t||(n=Ts(n)));var o=a||gi?document.importNode(n,!0):n.cloneNode(!0);if(t){var c=Ts(o),l=o.lastChild;Oa(c,l)}else Oa(o,o);return o}}function oa(s=""){{var e=ds(s+"");return Oa(e,e),e}}function Pe(){var s=document.createDocumentFragment(),e=document.createComment(""),t=ds();return s.append(e,t),Oa(e,t),s}function k(s,e){s!==null&&s.before(e)}function L(s,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(s.__t??(s.__t=s.nodeValue))&&(s.__t=t,s.nodeValue=t+"")}function hn(s,e){return Dl(s,e)}const sa=new Map;function Dl(s,{target:e,anchor:t,props:a={},events:n,context:i,intro:o=!0}){vl();var c=new Set,l=m=>{for(var y=0;y<m.length;y++){var _=m[y];if(!c.has(_)){c.add(_);var q=Sl(_);e.addEventListener(_,Ta,{passive:q});var g=sa.get(_);g===void 0?(document.addEventListener(_,Ta,{passive:q}),sa.set(_,1)):sa.set(_,g+1)}}};l(sn(Pi)),In.add(l);var u=void 0,h=gl(()=>{var m=t??e.appendChild(ds());return tl(m,{pending:()=>{}},y=>{if(i){Ke({});var _=Tt;_.c=i}n&&(a.$$events=n),u=s(y,a)||{},i&&Ue()}),()=>{var q;for(var y of c){e.removeEventListener(y,Ta);var _=sa.get(y);--_===0?(document.removeEventListener(y,Ta),sa.delete(y)):sa.set(y,_)}In.delete(l),m!==t&&((q=m.parentNode)==null||q.removeChild(m))}});return qn.set(u,h),u}let qn=new WeakMap;function fn(s,e){const t=qn.get(s);return t?(qn.delete(s),t(e)):Promise.resolve()}var Yt,ts,Ct,Ks,Ra,Fa,tn;class El{constructor(e,t=!0){E(this,"anchor");Ee(this,Yt,new Map);Ee(this,ts,new Map);Ee(this,Ct,new Map);Ee(this,Ks,new Set);Ee(this,Ra,!0);Ee(this,Fa,()=>{var e=be;if(I(this,Yt).has(e)){var t=I(this,Yt).get(e),a=I(this,ts).get(t);if(a)Zn(a),I(this,Ks).delete(t);else{var n=I(this,Ct).get(t);n&&(I(this,ts).set(t,n.effect),I(this,Ct).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),a=n.effect)}for(const[i,o]of I(this,Yt)){if(I(this,Yt).delete(i),i===e)break;const c=I(this,Ct).get(o);c&&(St(c.effect),I(this,Ct).delete(o))}for(const[i,o]of I(this,ts)){if(i===t||I(this,Ks).has(i))continue;const c=()=>{if(Array.from(I(this,Yt).values()).includes(i)){var u=document.createDocumentFragment();Ci(o,u),u.append(ds()),I(this,Ct).set(i,{effect:o,fragment:u})}else St(o);I(this,Ks).delete(i),I(this,ts).delete(i)};I(this,Ra)||!a?(I(this,Ks).add(i),Hs(o,c,!1)):c()}}});Ee(this,tn,e=>{I(this,Yt).delete(e);const t=Array.from(I(this,Yt).values());for(const[a,n]of I(this,Ct))t.includes(a)||(St(n.effect),I(this,Ct).delete(a))});this.anchor=e,Te(this,Ra,t)}ensure(e,t){var a=be,n=ki();if(t&&!I(this,ts).has(e)&&!I(this,Ct).has(e))if(n){var i=document.createDocumentFragment(),o=ds();i.append(o),I(this,Ct).set(e,{effect:Bt(()=>t(o)),fragment:i})}else I(this,ts).set(e,Bt(()=>t(this.anchor)));if(I(this,Yt).set(a,e),n){for(const[c,l]of I(this,ts))c===e?a.skipped_effects.delete(l):a.skipped_effects.add(l);for(const[c,l]of I(this,Ct))c===e?a.skipped_effects.delete(l.effect):a.skipped_effects.add(l.effect);a.oncommit(I(this,Fa)),a.ondiscard(I(this,tn))}else I(this,Fa).call(this)}}Yt=new WeakMap,ts=new WeakMap,Ct=new WeakMap,Ks=new WeakMap,Ra=new WeakMap,Fa=new WeakMap,tn=new WeakMap;function G(s,e,t=!1){var a=new El(s),n=t?_a:0;function i(o,c){a.ensure(o,c)}Jn(()=>{var o=!1;e((c,l=!0)=>{o=!0,i(l,c)}),o||i(!1,null)},n)}function ut(s,e){return e}function Al(s,e,t){for(var a=[],n=e.length,i,o=e.length,c=0;c<n;c++){let m=e[c];Hs(m,()=>{if(i){if(i.pending.delete(m),i.done.add(m),i.pending.size===0){var y=s.outrogroups;On(sn(i.done)),y.delete(i),y.size===0&&(s.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=a.length===0&&t!==null;if(l){var u=t,h=u.parentNode;hl(h),h.append(u),s.items.clear()}On(e,!l)}else i={pending:new Set(e),done:new Set},(s.outrogroups??(s.outrogroups=new Set)).add(i)}function On(s,e=!0){for(var t=0;t<s.length;t++)St(s[t],e)}var _r;function Me(s,e,t,a,n,i=null){var o=s,c=new Map,l=(e&$r)!==0;if(l){var u=s;o=u.appendChild(ds())}var h=null,m=vi(()=>{var w=t();return Kn(w)?w:w==null?[]:sn(w)}),y,_=!0;function q(){p.fallback=h,xl(p,y,o,e,a),h!==null&&(y.length===0?h.f&os?(h.f^=os,Da(h,null,o)):Zn(h):Hs(h,()=>{h=null}))}var g=Jn(()=>{y=r(m);for(var w=y.length,x=new Set,S=be,C=ki(),P=0;P<w;P+=1){var K=y[P],M=a(K,P),N=_?null:c.get(M);N?(N.v&&ma(N.v,K),N.i&&ma(N.i,P),C&&S.skipped_effects.delete(N.e)):(N=Cl(c,_?o:_r??(_r=ds()),K,M,P,n,e,t),_||(N.e.f|=os),c.set(M,N)),x.add(M)}if(w===0&&i&&!h&&(_?h=Bt(()=>i(o)):(h=Bt(()=>i(_r??(_r=ds()))),h.f|=os)),!_)if(C){for(const[z,Y]of c)x.has(z)||S.skipped_effects.add(Y.e);S.oncommit(q),S.ondiscard(()=>{})}else q();r(m)}),p={effect:g,items:c,outrogroups:null,fallback:h};_=!1}function xl(s,e,t,a,n){var Y,J,te,ie,he,le,j,D,F;var i=(a&Fo)!==0,o=e.length,c=s.items,l=s.effect.first,u,h=null,m,y=[],_=[],q,g,p,w;if(i)for(w=0;w<o;w+=1)q=e[w],g=n(q,w),p=c.get(g).e,p.f&os||((J=(Y=p.nodes)==null?void 0:Y.a)==null||J.measure(),(m??(m=new Set)).add(p));for(w=0;w<o;w+=1){if(q=e[w],g=n(q,w),p=c.get(g).e,s.outrogroups!==null)for(const Z of s.outrogroups)Z.pending.delete(p),Z.done.delete(p);if(p.f&os)if(p.f^=os,p===l)Da(p,null,t);else{var x=h?h.next:l;p===s.effect.last&&(s.effect.last=p.prev),p.prev&&(p.prev.next=p.next),p.next&&(p.next.prev=p.prev),ms(s,h,p),ms(s,p,x),Da(p,x,t),h=p,y=[],_=[],l=h.next;continue}if(p.f&It&&(Zn(p),i&&((ie=(te=p.nodes)==null?void 0:te.a)==null||ie.unfix(),(m??(m=new Set)).delete(p))),p!==l){if(u!==void 0&&u.has(p)){if(y.length<_.length){var S=_[0],C;h=S.prev;var P=y[0],K=y[y.length-1];for(C=0;C<y.length;C+=1)Da(y[C],S,t);for(C=0;C<_.length;C+=1)u.delete(_[C]);ms(s,P.prev,K.next),ms(s,h,P),ms(s,K,S),l=S,h=K,w-=1,y=[],_=[]}else u.delete(p),Da(p,l,t),ms(s,p.prev,p.next),ms(s,p,h===null?s.effect.first:h.next),ms(s,h,p),h=p;continue}for(y=[],_=[];l!==null&&l!==p;)(u??(u=new Set)).add(l),_.push(l),l=l.next;if(l===null)continue}p.f&os||y.push(p),h=p,l=p.next}if(s.outrogroups!==null){for(const Z of s.outrogroups)Z.pending.size===0&&(On(sn(Z.done)),(he=s.outrogroups)==null||he.delete(Z));s.outrogroups.size===0&&(s.outrogroups=null)}if(l!==null||u!==void 0){var M=[];if(u!==void 0)for(p of u)p.f&It||M.push(p);for(;l!==null;)!(l.f&It)&&l!==s.fallback&&M.push(l),l=l.next;var N=M.length;if(N>0){var z=a&$r&&o===0?t:null;if(i){for(w=0;w<N;w+=1)(j=(le=M[w].nodes)==null?void 0:le.a)==null||j.measure();for(w=0;w<N;w+=1)(F=(D=M[w].nodes)==null?void 0:D.a)==null||F.fix()}Al(s,M,z)}}i&&ka(()=>{var Z,$;if(m!==void 0)for(p of m)($=(Z=p.nodes)==null?void 0:Z.a)==null||$.apply()})}function Cl(s,e,t,a,n,i,o,c){var l=o&No?o&Bo?Qs(t):cl(t,!1,!1):null,u=o&Ro?Qs(n):null;return{v:l,i:u,e:Bt(()=>(i(e,l??t,u??n,c),()=>{s.delete(a)}))}}function Da(s,e,t){if(s.nodes)for(var a=s.nodes.start,n=s.nodes.end,i=e&&!(e.f&os)?e.nodes.start:t;a!==null;){var o=Ba(a);if(i.before(a),a===n)return;a=o}}function ms(s,e,t){e===null?s.effect.first=t:e.next=t,t===null?s.effect.last=e:t.prev=e}function Il(s,e,t=!1,a=!1,n=!1){var i=s,o="";H(()=>{var c=Ce;if(o!==(o=e()??"")&&(c.nodes!==null&&(Di(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:a&&(l=`<math>${l}</math>`);var u=zi(l);if((t||a)&&(u=Ts(u)),Oa(Ts(u),u.lastChild),t||a)for(;Ts(u);)i.before(Ts(u));else i.before(u)}})}function Li(s){var e,t,a="";if(typeof s=="string"||typeof s=="number")a+=s;else if(typeof s=="object")if(Array.isArray(s)){var n=s.length;for(e=0;e<n;e++)s[e]&&(t=Li(s[e]))&&(a&&(a+=" "),a+=t)}else for(t in s)s[t]&&(a&&(a+=" "),a+=t);return a}function ql(){for(var s,e,t=0,a="",n=arguments.length;t<n;t++)(s=arguments[t])&&(e=Li(s))&&(a&&(a+=" "),a+=e);return a}function Ol(s){return typeof s=="object"?ql(s):s??""}const pr=[...` 	
\r\f¬†\v\uFEFF`];function Ml(s,e,t){var a=s==null?"":""+s;if(e&&(a=a?a+" "+e:e),t){for(var n in t)if(t[n])a=a?a+" "+n:n;else if(a.length)for(var i=n.length,o=0;(o=a.indexOf(n,o))>=0;){var c=o+i;(o===0||pr.includes(a[o-1]))&&(c===a.length||pr.includes(a[c]))?a=(o===0?"":a.substring(0,o))+a.substring(c+1):o=c}}return a===""?null:a}function Nl(s,e){return s==null?null:String(s)}function Re(s,e,t,a,n,i){var o=s.__className;if(o!==t||o===void 0){var c=Ml(t,a,i);c==null?s.removeAttribute("class"):s.className=c,s.__className=t}else if(i&&n!==i)for(var l in i){var u=!!i[l];(n==null||u!==!!n[l])&&s.classList.toggle(l,u)}return i}function Vs(s,e,t,a){var n=s.__style;if(n!==e){var i=Nl(e);i==null?s.removeAttribute("style"):s.style.cssText=i,s.__style=e}return a}function ji(s,e,t=!1){if(s.multiple){if(e==null)return;if(!Kn(e))return Go();for(var a of s.options)a.selected=e.includes(Ca(a));return}for(a of s.options){var n=Ca(a);if(ul(n,e)){a.selected=!0;return}}(!t||e!==void 0)&&(s.selectedIndex=-1)}function Rl(s){var e=new MutationObserver(()=>{ji(s,s.__value)});e.observe(s,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Xn(()=>{e.disconnect()})}function Mn(s,e,t=e){var a=new WeakSet,n=!0;Wn(s,"change",i=>{var o=i?"[selected]":":checked",c;if(s.multiple)c=[].map.call(s.querySelectorAll(o),Ca);else{var l=s.querySelector(o)??s.querySelector("option:not([disabled])");c=l&&Ca(l)}t(c),be!==null&&a.add(be)}),wi(()=>{var i=e();if(s===document.activeElement){var o=Ea??be;if(a.has(o))return}if(ji(s,i,n),n&&i===void 0){var c=s.querySelector(":checked");c!==null&&(i=Ca(c),t(i))}s.__value=i,n=!1}),Rl(s)}function Ca(s){return"__value"in s?s.__value:s.value}const Fl=Symbol("is custom element"),Bl=Symbol("is html");function Ki(s,e){var t=$n(s);t.value===(t.value=e??void 0)||s.value===e&&(e!==0||s.nodeName!=="PROGRESS")||(s.value=e??"")}function la(s,e){var t=$n(s);t.checked!==(t.checked=e??void 0)&&(s.checked=e)}function De(s,e,t,a){var n=$n(s);n[e]!==(n[e]=t)&&(e==="loading"&&(s[So]=t),t==null?s.removeAttribute(e):typeof t!="string"&&Pl(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function $n(s){return s.__attributes??(s.__attributes={[Fl]:s.nodeName.includes("-"),[Bl]:s.namespaceURI===Ho})}var gr=new Map;function Pl(s){var e=s.getAttribute("is")||s.nodeName,t=gr.get(e);if(t)return t;gr.set(e,t=[]);for(var a,n=s,i=Element.prototype;i!==n;){a=go(n);for(var o in a)a[o].set&&t.push(o);n=Vr(n)}return t}function Ve(s,e,t=e){var a=new WeakSet;Wn(s,"input",async n=>{var i=n?s.defaultValue:s.value;if(i=_n(s)?pn(i):i,t(i),be!==null&&a.add(be),await Ri(),i!==(i=e())){var o=s.selectionStart,c=s.selectionEnd,l=s.value.length;if(s.value=i??"",c!==null){var u=s.value.length;o===c&&c===l&&u>l?(s.selectionStart=u,s.selectionEnd=u):(s.selectionStart=o,s.selectionEnd=Math.min(c,u))}}}),Js(e)==null&&s.value&&(t(_n(s)?pn(s.value):s.value),be!==null&&a.add(be)),ln(()=>{var n=e();if(s===document.activeElement){var i=Ea??be;if(a.has(i))return}_n(s)&&n===pn(s.value)||s.type==="date"&&!n&&!s.value||n!==s.value&&(s.value=n??"")})}function Ui(s,e,t=e){Wn(s,"change",a=>{var n=a?s.defaultChecked:s.checked;t(n)}),Js(e)==null&&t(s.checked),ln(()=>{var a=e();s.checked=!!a})}function _n(s){var e=s.type;return e==="number"||e==="range"}function pn(s){return s===""?null:+s}function mr(s,e){return s===e||(s==null?void 0:s[Us])===e}function Wt(s={},e,t,a){return wi(()=>{var n,i;return ln(()=>{n=i,i=(a==null?void 0:a())||[],Js(()=>{s!==t(...i)&&(e(s,...i),n&&mr(t(...n),s)&&e(null,...n))})}),()=>{ka(()=>{i&&mr(t(...i),s)&&e(null,...i)})}}),s}let Ka=!1;function zl(s){var e=Ka;try{return Ka=!1,[s(),Ka]}finally{Ka=e}}function vs(s,e,t,a){var x;var n=(t&Lo)!==0,i=(t&jo)!==0,o=a,c=!0,l=()=>(c&&(c=!1,o=i?Js(a):a),o),u;if(n){var h=Us in s||wo in s;u=((x=ia(s,e))==null?void 0:x.set)??(h&&e in s?S=>s[e]=S:void 0)}var m,y=!1;n?[m,y]=zl(()=>s[e]):m=s[e],m===void 0&&a!==void 0&&(m=l(),u&&(Co(),u(m)));var _;if(_=()=>{var S=s[e];return S===void 0?l():(c=!0,S)},!(t&zo))return _;if(u){var q=s.$$legacy;return function(S,C){return arguments.length>0?((!C||q||y)&&u(C?_():S),S):_()}}var g=!1,p=(t&Po?rn:vi)(()=>(g=!1,_()));n&&r(p);var w=Ce;return function(S,C){if(arguments.length>0){const P=C?r(p):n?me(S):S;return f(p,P),g=!0,o!==void 0&&(o=P),S}return As&&g||w.f&cs?p.v:r(p)}}function cn(s){Tt===null&&Zr(),dt(()=>{const e=Js(s);if(typeof e=="function")return e})}function Ll(s){Tt===null&&Zr(),cn(()=>()=>Js(s))}const jl="5";var Yr;typeof window<"u"&&((Yr=window.__svelte??(window.__svelte={})).v??(Yr.v=new Set)).add(jl);function Kl(){return{type:"daily",interval:1,time:"09:00"}}function Hi(s){return!s||!s.type||!s.interval||s.interval<1?!1:s.type==="weekly"?Array.isArray(s.weekdays)&&s.weekdays.length>0&&s.weekdays.every(e=>e>=0&&e<=6):s.type==="monthly"?s.dayOfMonth>=1&&s.dayOfMonth<=31:s.type==="yearly"?s.month>=0&&s.month<=11&&s.dayOfMonth>=1&&s.dayOfMonth<=31:!0}const Rs="recurring-tasks-active",Ga="recurring-tasks-archive",yr="recurring-tasks",kr="recurring-tasks.json.bak",br="n8n-event-settings",wr="n8n-event-queue",Ul="notification-state",Hl="recurring-tasks-dock",Sr="scheduler-emitted-occurrences",ys=4,Nn={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},er=60*1e3,Gl=30*1e3,gn=2e3,Tr="shehab-note-recurring-plugin",Dr="1.0.0",Yl=60*60*1e3,Vl=3,Er=10,mn=1e3,Ya=100,Ar=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],xr={low:"#64748b",normal:"#3b82f6",high:"#f59e0b",urgent:"#ef4444"},Wl=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Cr="last-run-timestamp",Ir="custom-recurring-task-id",qr="custom-recurring-task-due",Or="custom-recurring-task-enabled";function Gi(s,e,t){const a=new Date().toISOString(),n=t||new Date;return{id:Yi(),name:s,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:ys,createdAt:a,updatedAt:a}}function Yi(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Ql(s,e={}){const t=new Date().toISOString();return{...{...s,id:Yi(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Xl(s){const e=new Date().toISOString();s.completionCount=(s.completionCount||0)+1,s.currentStreak=(s.currentStreak||0)+1,s.bestStreak=Math.max(s.bestStreak||0,s.currentStreak),s.recentCompletions||(s.recentCompletions=[]),s.recentCompletions.push(e),s.recentCompletions.length>Er&&(s.recentCompletions=s.recentCompletions.slice(-Er)),s.snoozeCount=0,s.lastCompletedAt=e,s.updatedAt=e}function Vi(s){s.missCount=(s.missCount||0)+1,s.currentStreak=0,s.updatedAt=new Date().toISOString()}function Wi(s){const e=s.completionCount||0,t=s.missCount||0,a=e+t;if(a===0)return 100;let i=e/a*70;const o=s.currentStreak||0,c=Math.min(30,o*3);return i+=c,Math.round(Math.min(100,i))}function Fs(s){const{message:e,type:t="info",duration:a=3e3,actionLabel:n,onAction:i,showCountdown:o=!1}=s,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let u=null;if(n&&i){const m=document.createElement("button");m.type="button";let y=Math.max(1,Math.ceil(a/1e3));m.textContent=o?`${n} (${y}s)`:n,m.className="recurring-tasks-toast__action",m.addEventListener("click",()=>{i(),u!==null&&window.clearInterval(u),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(m),o&&a>0&&(u=window.setInterval(()=>{y=Math.max(0,y-1),m.textContent=`${n} (${y}s)`,y<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:Jl(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const h=()=>{u!==null&&window.clearInterval(u),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};a>0&&setTimeout(()=>{h()},a)}function Jl(s){switch(s){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const ee={success:(s,e)=>Fs({message:s,type:"success",duration:e}),error:(s,e)=>Fs({message:s,type:"error",duration:e}),warning:(s,e)=>Fs({message:s,type:"warning",duration:e}),info:(s,e)=>Fs({message:s,type:"info",duration:e})};if(typeof document<"u"){const s=document.createElement("style");s.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(s)}class Zl{constructor(){E(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var a;return(a=this.handlers.get(e))==null?void 0:a.delete(t)}}emit(e,t){var a;(a=this.handlers.get(e))==null||a.forEach(n=>n(t))}clear(){this.handlers.clear()}}const Ge=new Zl;function yn(s,e){const t=s.findIndex(n=>n.id===e.id);if(t===-1)return[...s,e];const a=[...s];return a[t]=e,a}function Mr(s,e){const t=s.filter(a=>a.id!==e);return t.length===s.length?s:t}function kn(s,e,t){let a=!1;const n=s.map(i=>i.id!==e?i:(a=!0,t(i)));return a?n:s}function $l(s,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),s.filter(a=>a.enabled?new Date(a.dueAt)<=t:!1)}const ec=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function dn(s,e,t){const a={timestamp:new Date().toISOString()},n=`[${s.toUpperCase()}] [${a.timestamp}]`;s==="error"?console.error(n,e,t||""):s==="warn"?console.warn(n,e,t||""):s==="debug"&&ec?console.debug(n,e,t||""):s==="info"&&console.log(n,e,t||"")}function Qi(s,e){dn("debug",s,e)}function ve(s,e){dn("info",s,e)}function vt(s,e){dn("warn",s,e)}function Se(s,e){dn("error",s,e)}async function tc(s){return new Promise(e=>{try{jn.fetchPost("/api/block/getBlockInfo",{id:s},t=>{var n,i,o;const a=((n=t==null?void 0:t.data)==null?void 0:n.content)??((i=t==null?void 0:t.data)==null?void 0:i.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(a?a.trim():null)})}catch(t){vt("Failed to fetch block preview",t),e(null)}})}async function sc(s){return new Promise(e=>{try{jn.fetchPost("/api/block/getBlockHTML",{id:s},t=>{var n;const a=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(a?a.trim():null)})}catch(t){vt("Failed to fetch block embed",t),e(null)}})}function Xi(s){const[e,t]=s.split(":").map(Number);return{hours:e,minutes:t}}function ac(s){const e=s.getHours().toString().padStart(2,"0"),t=s.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function nc(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Rn(s){return s.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function tr(s){const e=new Date;return s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()}function rc(s){return s<new Date}function ic(s){return rc(s)&&!tr(s)}function Ma(s,e){const t=new Date(s);return t.setDate(t.getDate()+e),t}function Nr(s,e){return Ma(s,e*7)}function oc(s,e,t){const a=new Date(s);a.setHours(e,t,0,0);const n=a.getHours()!==e||a.getMinutes()!==t;return{date:a,shifted:n}}function Fn(s){const e=new Date(s);return e.setHours(0,0,0,0),e}function lc(s){const e=new Date(s);return e.setHours(23,59,59,999),e}function cc(s,e){const a=Math.abs(e.getTime()-s.getTime());return Math.floor(a/864e5)}function dc(s,e){const t=[];for(let a=0;a<e;a++)t.push(Ma(s,a));return t}var uc=A('<span class="task-card__streak svelte-yjw1ud"> </span>'),vc=A('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),hc=A('<span class="task-card__relative svelte-yjw1ud"> </span>'),fc=A('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),_c=A('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),pc=A('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),gc=A('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),mc=A('<button class="task-card__snooze-chip"> </button>'),yc=A('<button class="task-card__snooze-option" role="menuitem"> </button>'),kc=A('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),bc=A('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">üïí Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function ba(s,e){Ke(e,!0);const t=Q(()=>new Date(e.task.dueAt)),a=Q(()=>ic(r(t))),n=Q(()=>tr(r(t))),i=Q(()=>r(a)?cc(new Date(e.task.dueAt),new Date):0),o=Q(()=>r(a)?"task-card--overdue":r(n)?"task-card--today":""),c=Q(()=>()=>r(a)?`rgba(244, 67, 54, ${Math.min(.45,.12+r(i)*.05)})`:""),l=Q(()=>()=>r(a)?`rgba(244, 67, 54, ${Math.min(.8,.3+r(i)*.08)})`:""),u=Q(()=>e.task.priority?xr[e.task.priority]:xr.normal),h=Q(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(r(t)):""),m=Q(()=>(e.task.currentStreak||0)>0),y=Q(()=>()=>"üî•"),_=Q(()=>Wi(e.task)),q=Q(()=>r(_)>=80?"health--good":r(_)>=50?"health--fair":"health--poor");let g=W(!1),p=W(-1),w=[],x=W(!1),S=W(null),C=W(null),P=W(!1);const K=Q(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),M=Q(()=>()=>{if(!r(S))return"";const ae=r(S).replace(/\s+/g," ").trim();return ae.length>220?`${ae.slice(0,220)}‚Ä¶`:ae}),N=Q(()=>()=>Ar.filter(ae=>[15,60,120].includes(ae.minutes))),z=Q(()=>()=>`snooze-menu-${e.task.id}`);dt(()=>{f(S,e.task.linkedBlockContent??null,!0),f(C,null),f(P,!1)});function Y(){e.onDone(e.task)}function J(){e.onDelay(e.task)}function te(){e.onEdit&&e.onEdit(e.task)}function ie(){e.onSkip(e.task)}async function he(){f(g,!r(g)),r(g)&&(await Ri(),f(p,-1),w=[])}function le(ae){const pe=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ae}});window.dispatchEvent(pe),f(g,!1),f(p,-1)}function j(ae){var Ae,Le,ct,et;const pe=r(N);ae.key==="ArrowDown"?(ae.preventDefault(),f(p,Math.min(r(p)+1,pe.length-1),!0),(Ae=w[r(p)])==null||Ae.focus()):ae.key==="ArrowUp"?(ae.preventDefault(),f(p,Math.max(r(p)-1,0),!0),(Le=w[r(p)])==null||Le.focus()):ae.key==="Escape"?(f(g,!1),f(p,-1)):ae.key==="Home"?(ae.preventDefault(),f(p,0),(ct=w[0])==null||ct.focus()):ae.key==="End"&&(ae.preventDefault(),f(p,pe.length-1),(et=w[r(p)])==null||et.focus())}function D(ae){if(ae.key==="Escape"&&r(g)){f(g,!1);return}(ae.key==="Enter"||ae.key===" ")&&(ae.preventDefault(),he())}async function F(){if(f(x,!0),!e.task.linkedBlockId||r(P)||r(C))return;f(P,!0);const[ae,pe]=await Promise.all([sc(e.task.linkedBlockId),tc(e.task.linkedBlockId)]);f(C,ae,!0),f(S,pe,!0),f(P,!1)}function Z(){f(x,!1)}const $=Q(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,pe=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[pe]||pe)}`);var ce=bc();ce.__keydown=ae=>{ae.key==="Escape"&&r(g)&&f(g,!1)};var de=d(ce),_e=d(de),se=d(_e),ue=v(se,2),U=d(ue),V=v(ue,2);{var re=ae=>{var pe=uc(),Ae=d(pe);H(Le=>{De(pe,"title",`${e.task.currentStreak??""} day streak`),L(Ae,`${Le??""} ${e.task.currentStreak??""}`)},[()=>r(y)()]),k(ae,pe)};G(V,ae=>{r(m)&&ae(re)})}var b=v(_e,2);{var R=ae=>{var pe=vc();pe.__click=te,k(ae,pe)};G(b,ae=>{e.onEdit&&ae(R)})}var X=v(de,2),ne=d(X),T=v(d(ne),2),O=d(T),oe=v(T,2);{var ke=ae=>{var pe=hc(),Ae=d(pe);H(Le=>L(Ae,Le),[()=>r(h)()]),k(ae,pe)};G(oe,ae=>{e.timezoneHandler&&ae(ke)})}var xe=v(ne,2);{var ye=ae=>{var pe=fc(),Ae=v(d(pe),2),Le=d(Ae);H(ct=>L(Le,ct),[()=>Rn(new Date(e.task.lastCompletedAt))]),k(ae,pe)};G(xe,ae=>{e.task.lastCompletedAt&&ae(ye)})}var Ne=v(xe,2);{var Fe=ae=>{var pe=gc(),Ae=d(pe),Le=d(Ae),ct=v(Ae,2);{var et=Kt=>{var Et=pc(),ge=d(Et);{var Ie=Be=>{var tt=oa("Loading preview‚Ä¶");k(Be,tt)},je=Be=>{var tt=Pe(),st=qe(tt);{var _t=pt=>{var Ot=_c(),gt=d(Ot);Il(gt,()=>r(C)),k(pt,Ot)},Ut=pt=>{var Ot=Pe(),gt=qe(Ot);{var Ht=At=>{var B=oa();H(()=>L(B,r(M))),k(At,B)},gs=At=>{var B=oa("No preview available.");k(At,B)};G(gt,At=>{r(S)?At(Ht):At(gs,!1)},!0)}k(pt,Ot)};G(st,pt=>{r(C)?pt(_t):pt(Ut,!1)},!0)}k(Be,tt)};G(ge,Be=>{r(P)?Be(Ie):Be(je,!1)})}k(Kt,Et)};G(ct,Kt=>{r(x)&&Kt(et)})}H(()=>{De(Ae,"title",`Linked block: ${e.task.linkedBlockId}`),L(Le,`üìù Block ${r(K)??""}`)}),it("mouseenter",Ae,F),it("mouseleave",Ae,Z),it("focus",Ae,F),it("blur",Ae,Z),k(ae,pe)};G(Ne,ae=>{e.task.linkedBlockId&&ae(Fe)})}var ft=v(X,2),qt=d(ft),Je=v(ft,2),Qt=d(Je),Ze=d(Qt);Ze.__click=he,Ze.__keydown=D;var Oe=v(Ze,2),Dt=d(Oe);Me(Dt,17,()=>r(N),ut,(ae,pe)=>{var Ae=mc();Ae.__click=()=>le(r(pe).minutes);var Le=d(Ae);H(()=>{De(Ae,"aria-label",`Snooze for ${r(pe).label}`),L(Le,r(pe).label)}),k(ae,Ae)});var ze=v(Dt,2);ze.__click=J;var $e=v(Oe,2);{var ns=ae=>{var pe=kc();pe.__keydown=j,Me(pe,21,()=>Ar,ut,(Ae,Le,ct)=>{var et=yc();et.__click=()=>le(r(Le).minutes),De(et,"tabindex",ct===0?0:-1);var Kt=d(et);Wt(et,(Et,ge)=>w[ge]=Et,Et=>w==null?void 0:w[Et],()=>[ct]),H(()=>L(Kt,r(Le).label)),k(Ae,et)}),H(()=>De(pe,"id",r(z))),k(ae,pe)};G($e,ae=>{r(g)&&ae(ns)})}var Xt=v(Qt,2);Xt.__click=J;var Lt=v(Xt,2);Lt.__click=ie;var jt=v(Lt,2);jt.__click=Y,H((ae,pe)=>{Re(ce,1,`task-card ${r(o)??""}`,"svelte-yjw1ud"),Vs(ce,`--overdue-tint: ${r(c)??""}; --overdue-border: ${r(l)??""};`),De(ce,"aria-label",ae),Vs(se,`background-color: ${r(u)??""}`),De(se,"title",`Priority:  ${(e.task.priority||"normal")??""}`),L(U,e.task.name),L(O,pe),Re(ft,1,`task-card__health ${r(q)??""}`,"svelte-yjw1ud"),De(ft,"title",`Task health:  ${r(_)??""}%`),Vs(qt,`width: ${r(_)??""}%`),De(Ze,"aria-expanded",r(g)),De(Ze,"aria-controls",r(z))},[()=>r($)(),()=>Rn(r(t))]),k(s,ce),Ue()}Xe(["keydown","click"]);var wc=A(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),Sc=A('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),Tc=A('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function Dc(s,e){Ke(e,!0);const t=Q(()=>[...e.tasks].sort((g,p)=>new Date(g.dueAt).getTime()-new Date(p.dueAt).getTime()));let a=W(0),n=me([]);dt(()=>{r(a)>=r(t).length&&f(a,Math.max(0,r(t).length-1),!0)});function i(g){var w;if(r(t).length===0)return;const p=Math.max(0,Math.min(g,r(t).length-1));f(a,p,!0),(w=n[p])==null||w.focus()}function o(g,p){g.key==="ArrowDown"?(g.preventDefault(),i(p+1)):g.key==="ArrowUp"?(g.preventDefault(),i(p-1)):g.key==="Home"?(g.preventDefault(),i(0)):g.key==="End"&&(g.preventDefault(),i(r(t).length-1))}var c=Tc(),l=d(c),u=v(d(l),2),h=d(u),m=v(l,2),y=d(m);{var _=g=>{var p=wc();k(g,p)},q=g=>{var p=Pe(),w=qe(p);Me(w,19,()=>r(t),x=>x.id,(x,S,C)=>{var P=Sc();P.__keydown=M=>o(M,r(C));var K=d(P);ba(K,{get task(){return r(S)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),Wt(P,(M,N)=>n[N]=M,M=>n==null?void 0:n[M],()=>[r(C)]),H(()=>De(P,"tabindex",r(C)===r(a)?0:-1)),it("focus",P,()=>f(a,r(C),!0)),k(x,P)}),k(g,p)};G(y,g=>{r(t).length===0?g(_):g(q,!1)})}H(()=>L(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),k(s,c),Ue()}Xe(["keydown"]);var Ec=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Ac=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),xc=A('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),Cc=A('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ic=A('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),qc=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Oc=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Mc=A('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Nc(s,e){Ke(e,!0);let t=W(null),a=W(!1),n=W(""),i=W(""),o=W(me(new Set)),c=W(0),l=me([]),u=W(null);const h=Q(()=>[...e.tasks].sort((T,O)=>new Date(T.dueAt).getTime()-new Date(O.dueAt).getTime())),m=Q(()=>()=>{const T=r(i).trim().toLowerCase();return T?r(h).filter(O=>{var ke;return[O.name,O.description,O.category,O.linkedBlockContent,(ke=O.tags)==null?void 0:ke.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(T)}):r(h)}),y=Q(()=>r(m).map(T=>T.id)),_=Q(()=>r(o).size>0),q=Q(()=>r(m).length>0&&r(m).every(T=>r(o).has(T.id))),g=Q(()=>r(m).some(T=>r(o).has(T.id))&&!r(q));dt(()=>{const T=new Set([...r(o)].filter(O=>e.tasks.some(oe=>oe.id===O)));T.size!==r(o).size&&f(o,T,!0)}),dt(()=>{r(u)&&(r(u).indeterminate=r(g))}),dt(()=>{r(c)>=r(m).length&&f(c,Math.max(0,r(m).length-1),!0)}),dt(()=>{const T=window.setTimeout(()=>{f(i,r(n),!0)},300);return()=>{window.clearTimeout(T)}});function p(T){f(t,T,!0)}function w(){r(t)&&(e.onDelete(r(t)),f(t,null))}function x(){f(t,null)}function S(T){const O=new Set(r(o));O.has(T)?O.delete(T):O.add(T),f(o,O,!0)}function C(){const T=new Set(r(o));r(q)?r(y).forEach(O=>T.delete(O)):r(y).forEach(O=>T.add(O)),f(o,T,!0)}function P(T){var oe;if(r(m).length===0)return;const O=Math.max(0,Math.min(T,r(m).length-1));f(c,O,!0),(oe=l[O])==null||oe.focus()}function K(T,O){T.key==="ArrowDown"?(T.preventDefault(),P(O+1)):T.key==="ArrowUp"?(T.preventDefault(),P(O-1)):T.key==="Home"?(T.preventDefault(),P(0)):T.key==="End"&&(T.preventDefault(),P(r(m).length-1))}function M(){if(r(o).size===0){f(a,!1);return}e.onBulkDelete([...r(o)]),f(o,new Set,!0),f(a,!1)}function N(){f(a,!1)}function z(T){const{type:O,interval:oe}=T.frequency,ke=O==="daily"?"day":O==="weekly"?"week":O==="monthly"?"month":"year",xe=oe===1?`Every ${ke}`:`Every ${oe} ${ke}s`;if(O==="weekly")return`${xe} on ${T.frequency.weekdays.map(ye=>Wl[ye]??ye).join(", ")}`;if(O==="monthly")return`${xe} on day ${T.frequency.dayOfMonth}`;if(O==="yearly"){const ye=Y[T.frequency.month]??`Month ${T.frequency.month+1}`;return`${xe} on ${ye} ${T.frequency.dayOfMonth}`}return xe}const Y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var J=Mc(),te=qe(J),ie=d(te),he=v(d(ie),2),le=d(he),j=v(d(le),2),D=v(le,2);D.__click=function(...T){var O;(O=e.onCreate)==null||O.apply(this,T)};var F=v(ie,2),Z=d(F),$=d(Z),ce=d($),de=v($,2),_e=d(de);_e.__click=()=>e.onBulkEnable([...r(o)]);var se=v(_e,2);se.__click=()=>e.onBulkDisable([...r(o)]);var ue=v(se,2);ue.__click=()=>f(a,!0);var U=v(Z,2);{var V=T=>{var O=Ec();k(T,O)},re=T=>{var O=Ic(),oe=d(O);{var ke=ye=>{var Ne=Ac(),Fe=d(Ne),ft=d(Fe);H(qt=>L(ft,`No tasks match "${qt??""}".`),[()=>r(i).trim()]),k(ye,Ne)},xe=ye=>{var Ne=Cc(),Fe=d(Ne),ft=d(Fe),qt=d(ft),Je=d(qt);Je.__click=C,Wt(Je,Ze=>f(u,Ze),()=>r(u));var Qt=v(Fe);Me(Qt,23,()=>r(m),Ze=>Ze.id,(Ze,Oe,Dt)=>{var ze=xc();ze.__keydown=Be=>K(Be,r(Dt));var $e=d(ze),ns=d($e);ns.__click=()=>S(r(Oe).id);var Xt=v($e),Lt=d(Xt),jt=v(Xt),ae=d(jt),pe=v(jt),Ae=d(pe),Le=v(pe),ct=d(Le),et=d(ct);et.__change=()=>e.onToggleEnabled(r(Oe));var Kt=v(Le),Et=d(Kt),ge=d(Et);ge.__click=()=>e.onEdit(r(Oe));var Ie=v(ge,2);Ie.__click=()=>e.onDuplicate(r(Oe));var je=v(Ie,2);je.__click=()=>p(r(Oe)),Wt(ze,(Be,tt)=>l[tt]=Be,Be=>l==null?void 0:l[Be],()=>[r(Dt)]),H((Be,tt,st,_t)=>{Re(ze,1,Ol(r(Oe).enabled?"":"disabled"),"svelte-i091qn"),De(ze,"tabindex",r(Dt)===r(c)?0:-1),De(ze,"aria-selected",Be),De(ns,"aria-label",`Select ${r(Oe).name}`),la(ns,tt),L(Lt,r(Oe).name),L(ae,st),L(Ae,_t),la(et,r(Oe).enabled)},[()=>r(o).has(r(Oe).id),()=>r(o).has(r(Oe).id),()=>Rn(new Date(r(Oe).dueAt)),()=>z(r(Oe))]),it("focus",ze,()=>f(c,r(Dt),!0)),k(Ze,ze)}),H(()=>{la(Je,r(q)),Je.disabled=r(m).length===0}),k(ye,Ne)};G(oe,ye=>{r(m).length===0?ye(ke):ye(xe,!1)})}k(T,O)};G(U,T=>{r(h).length===0?T(V):T(re,!1)})}var b=v(te,2);{var R=T=>{var O=qc(),oe=d(O),ke=v(d(oe),2),xe=d(ke),ye=v(ke,2),Ne=d(ye);Ne.__click=x;var Fe=v(Ne,2);Fe.__click=w,H(()=>L(xe,`Are you sure you want to delete "${r(t).name??""}"? This action cannot be undone.`)),k(T,O)};G(b,T=>{r(t)&&T(R)})}var X=v(b,2);{var ne=T=>{var O=Oc(),oe=d(O),ke=v(d(oe),2),xe=d(ke),ye=v(ke,2),Ne=d(ye);Ne.__click=N;var Fe=v(Ne,2);Fe.__click=M,H(()=>L(xe,`Are you sure you want to delete ${r(o).size??""} task${r(o).size===1?"":"s"}? This action cannot be undone.`)),k(T,O)};G(X,T=>{r(a)&&T(ne)})}H(()=>{j.disabled=r(h).length===0,L(ce,`${r(o).size??""} selected`),_e.disabled=!r(_),se.disabled=!r(_),ue.disabled=!r(_)}),Ve(j,()=>r(n),T=>f(n,T)),k(s,J),Ue()}Xe(["click","keydown","change"]);var Rc=A('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Fc=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Bc=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Pc=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),zc=A('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Lc=A('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),jc=A('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Kc=A('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Uc(s,e){Ke(e,!0);let t=vs(e,"days",3,30);function a(w){const{frequency:x}=w;if(x.type==="weekly"){const S=[...x.weekdays].sort((C,P)=>C-P).join(",");return`weekly:${x.interval}:${x.time??""}:${S}`}return x.type==="monthly"?`monthly:${x.interval}:${x.time??""}:${x.dayOfMonth}`:x.type==="yearly"?`yearly:${x.interval}:${x.time??""}:${x.month}:${x.dayOfMonth}`:`daily:${x.interval}:${x.time??""}`}function n(w,x){const S=w.map(C=>`${C.id}:${C.enabled}:${C.dueAt}:${a(C)}`).join("|");return`${x}:${S}`}function i(w,x){const S=Fn(new Date),C=lc(Ma(S,x-1)),P=24*60*60*1e3,M=dc(S,x).map(N=>({date:N,tasks:[]}));for(const N of w.filter(z=>z.enabled)){const z=new Date(N.dueAt),Y=e.recurrenceEngine.getOccurrencesInRange(S,C,N.frequency,z);for(const J of Y){const te=Fn(J),ie=Math.floor((te.getTime()-S.getTime())/P);ie>=0&&ie<x&&M[ie].tasks.push({task:N,occurrence:J})}}for(const N of M)N.tasks.sort((z,Y)=>z.occurrence.getTime()-Y.occurrence.getTime());return M}const o=(()=>{let w="",x=[];return{get(S,C){const P=n(S,C);return P===w||(w=P,x=i(S,C)),x}}})(),c=Q(()=>o.get(e.tasks,t())),l=Q(()=>r(c).some(w=>w.tasks.length>0));var u=Kc(),h=d(u),m=v(d(h),2),y=d(m),_=v(h,2),q=d(_);{var g=w=>{var x=Rc(),S=d(x),C=d(S);H(()=>L(C,`No tasks scheduled in the next ${t()??""} days.`)),k(w,x)},p=w=>{var x=jc();Me(x,21,()=>r(c),S=>S.date.toISOString(),(S,C)=>{var P=Pe(),K=qe(P);{var M=N=>{var z=Lc(),Y=d(z),J=d(Y),te=d(J),ie=v(J,2),he=d(ie),le=v(Y,2);Me(le,21,()=>r(C).tasks,({task:j,occurrence:D})=>j.id+D.toISOString(),(j,D)=>{let F=()=>r(D).task,Z=()=>r(D).occurrence;var $=zc(),ce=d($),de=d(ce),_e=v(ce,2),se=d(_e),ue=d(se),U=v(se,2),V=d(U);{var re=T=>{var O=Fc(),oe=d(O);H(()=>L(oe,`üîó ${F().linkedBlockId??""}`)),k(T,O)};G(V,T=>{F().linkedBlockId&&T(re)})}var b=v(V,2);{var R=T=>{var O=Bc(),oe=d(O);H(()=>L(oe,`‚ö° ${F().priority??""}`)),k(T,O)};G(b,T=>{F().priority&&T(R)})}var X=v(b,2);{var ne=T=>{var O=Pc(),oe=d(O);H(ke=>L(oe,`üè∑Ô∏è ${ke??""}`),[()=>F().tags.join(", ")]),k(T,O)};G(X,T=>{var O;(O=F().tags)!=null&&O.length&&T(ne)})}H(T=>{L(de,T),L(ue,F().name)},[()=>ac(Z())]),k(j,$)}),H((j,D)=>{L(te,j),L(he,D)},[()=>nc(r(C).date),()=>r(C).date.toLocaleDateString(void 0,{weekday:"short"})]),k(N,z)};G(K,N=>{r(C).tasks.length>0&&N(M)})}k(S,P)}),k(w,x)};G(q,w=>{r(l)?w(p,!1):w(g)})}H(()=>L(y,`Next ${t()??""} days`)),k(s,u),Ue()}var Hc=A('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),Gc=A('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Yc=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Vc=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Wc=A('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Qc=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Xc=A('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Jc=A('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),Zc=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),$c=A('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function ed(s,e){Ke(e,!0);const t=Q(()=>()=>{let j=0,D=0;for(const $ of e.tasks)j+=$.completionCount||0,D+=$.missCount||0;const F=j+D,Z=F>0?j/F*100:100;return{totalCompletions:j,totalMisses:D,completionRate:Math.round(Z)}}),a=Q(()=>()=>[...e.tasks].filter(j=>(j.currentStreak||0)>0).sort((j,D)=>(D.currentStreak||0)-(j.currentStreak||0)).slice(0,10)),n=Q(()=>()=>[...e.tasks].map(j=>({task:j,health:Wi(j)})).sort((j,D)=>j.health-D.health)),i=Q(()=>()=>r(n)().slice(-5).reverse()),o=Q(()=>()=>r(n)().slice(0,5)),c=Q(()=>()=>{const j=[];for(const D of e.tasks)if(D.recentCompletions&&D.recentCompletions.length>0)for(const F of D.recentCompletions)j.push({task:D,completedAt:F});return j.sort((D,F)=>new Date(F.completedAt).getTime()-new Date(D.completedAt).getTime()).slice(0,10)});function l(j){return new Date(j).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(j){return j>=80?"#10b981":j>=60?"#3b82f6":j>=40?"#f59e0b":"#ef4444"}var h=$c(),m=v(d(h),2),y=d(m),_=v(d(y),2),q=d(_),g=d(q),p=d(g),w=v(q,2),x=d(w),S=d(x),C=v(w,2),P=d(C),K=d(P),M=v(y,2);{var N=j=>{var D=Yc(),F=v(d(D),2);Me(F,21,()=>r(a)(),ut,(Z,$,ce)=>{var de=Gc(),_e=d(de);_e.textContent=`#${ce+1}`;var se=v(_e,2),ue=d(se),U=v(se,2),V=d(U),re=v(V);{var b=R=>{var X=Hc();k(R,X)};G(re,R=>{r($).bestStreak&&r($).currentStreak===r($).bestStreak&&R(b)})}H(()=>{L(ue,r($).name),L(V,`${r($).currentStreak??""} day${r($).currentStreak!==1?"s":""} `)}),k(Z,de)}),k(j,D)};G(M,j=>{r(a)().length>0&&j(N)})}var z=v(M,2),Y=v(d(z),2);{var J=j=>{var D=Wc(),F=v(qe(D),2);Me(F,21,()=>r(i)(),ut,(Z,$)=>{let ce=()=>r($).task,de=()=>r($).health;var _e=Vc(),se=d(_e),ue=d(se),U=v(se,2),V=d(U),re=v(V,2),b=d(re);H(R=>{L(ue,ce().name),Vs(V,`width: ${de()??""}%; background-color: ${R??""}`),L(b,`${de()??""}/100`)},[()=>u(de())]),k(Z,_e)}),k(j,D)};G(Y,j=>{r(i)().length>0&&j(J)})}var te=v(Y,2);{var ie=j=>{var D=Xc(),F=v(qe(D),2);Me(F,21,()=>r(o)(),ut,(Z,$)=>{let ce=()=>r($).task,de=()=>r($).health;var _e=Qc(),se=d(_e),ue=d(se),U=v(se,2),V=d(U),re=v(V,2),b=d(re);H(R=>{L(ue,ce().name),Vs(V,`width: ${de()??""}%; background-color: ${R??""}`),L(b,`${de()??""}/100`)},[()=>u(de())]),k(Z,_e)}),k(j,D)};G(te,j=>{r(o)().length>0&&r(o)()[0].health<80&&j(ie)})}var he=v(z,2);{var le=j=>{var D=Zc(),F=v(d(D),2);Me(F,21,()=>r(c)(),ut,(Z,$)=>{let ce=()=>r($).task,de=()=>r($).completedAt;var _e=Jc(),se=v(d(_e),2),ue=d(se),U=d(ue),V=v(ue,2),re=d(V);H(b=>{L(U,ce().name),L(re,b)},[()=>l(de())]),k(Z,_e)}),k(j,D)};G(he,j=>{r(c)().length>0&&j(le)})}H((j,D,F)=>{L(p,j),L(S,D),L(K,`${F??""}%`)},[()=>r(t)().totalCompletions,()=>r(t)().totalMisses,()=>r(t)().completionRate]),k(s,h),Ue()}var td=A('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">üì• No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),sd=A('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),ad=A('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function nd(s,e){Ke(e,!0);const t=Q(()=>e.tasks.filter(g=>g.status!=="done"&&g.status!=="cancelled"&&!g.dueAt&&!g.scheduledAt&&!g.startAt).sort((g,p)=>new Date(p.createdAt).getTime()-new Date(g.createdAt).getTime()));let a=W(0),n=me([]);dt(()=>{r(a)>=r(t).length&&f(a,Math.max(0,r(t).length-1),!0)});function i(g){var w;if(r(t).length===0)return;const p=Math.max(0,Math.min(g,r(t).length-1));f(a,p,!0),(w=n[p])==null||w.focus()}function o(g,p){g.key==="ArrowDown"?(g.preventDefault(),i(p+1)):g.key==="ArrowUp"?(g.preventDefault(),i(p-1)):g.key==="Enter"&&e.onEdit?(g.preventDefault(),e.onEdit(r(t)[p])):g.key===" "&&e.onDone&&(g.preventDefault(),e.onDone(r(t)[p]))}var c=ad(),l=d(c),u=v(d(l),2),h=d(u),m=v(l,2),y=d(m);{var _=g=>{var p=td();k(g,p)},q=g=>{var p=Pe(),w=qe(p);Me(w,19,()=>r(t),x=>x.id,(x,S,C)=>{var P=sd();P.__keydown=M=>o(M,r(C));var K=d(P);ba(K,{get task(){return r(S)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(P,(M,N)=>n[N]=M,M=>n==null?void 0:n[M],()=>[r(C)]),H(()=>De(P,"tabindex",r(C)===r(a)?0:-1)),it("focus",P,()=>f(a,r(C),!0)),k(x,P)}),k(g,p)};G(y,g=>{r(t).length===0?g(_):g(q,!1)})}H(()=>L(h,`${r(t).length??""} task${r(t).length!==1?"s":""} without dates`)),k(s,c),Ue()}Xe(["keydown"]);var rd=A('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),id=A('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),od=A('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),ld=A('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function cd(s,e){Ke(e,!0);let t=vs(e,"daysAhead",3,7);const a=new Date;a.setHours(0,0,0,0);const n=new Date(a);n.setDate(n.getDate()+t());const i=Q(()=>e.tasks.filter(S=>{if(S.status==="done"||S.status==="cancelled"||!S.dueAt)return!1;const C=new Date(S.dueAt);return C.setHours(0,0,0,0),C>a&&C<=n}).sort((S,C)=>new Date(S.dueAt).getTime()-new Date(C.dueAt).getTime())),o=Q(()=>()=>{const S=new Map;return r(i).forEach(C=>{const P=new Date(C.dueAt);P.setHours(0,0,0,0);const K=P.toISOString().split("T")[0];S.has(K)||S.set(K,[]),S.get(K).push(C)}),S});function c(S){const C=new Date(S),P=Math.floor((C.getTime()-a.getTime())/(1e3*60*60*24)),K=C.toLocaleDateString("en-US",{weekday:"long"}),M=C.toLocaleDateString("en-US",{month:"short",day:"numeric"});return P===1?`Tomorrow - ${K}, ${M}`:`${K}, ${M} (in ${P} days)`}let l=W(0),u=me([]);dt(()=>{r(l)>=r(i).length&&f(l,Math.max(0,r(i).length-1),!0)});function h(S,C){S.key==="ArrowDown"?(S.preventDefault(),f(l,Math.min(r(l)+1,r(i).length-1),!0)):S.key==="ArrowUp"?(S.preventDefault(),f(l,Math.max(r(l)-1,0),!0)):S.key==="Enter"&&e.onEdit?(S.preventDefault(),e.onEdit(r(i)[C])):S.key===" "&&e.onDone&&(S.preventDefault(),e.onDone(r(i)[C]))}var m=ld(),y=d(m),_=v(d(y),2),q=d(_),g=v(y,2),p=d(g);{var w=S=>{var C=rd(),P=d(C),K=d(P);H(()=>L(K,`üìÖ No tasks scheduled for the next ${t()??""} days`)),k(S,C)},x=S=>{var C=Pe(),P=qe(C);Me(P,17,()=>[...r(o).entries()],ut,(K,M)=>{var N=Q(()=>Qr(r(M),2));let z=()=>r(N)[0],Y=()=>r(N)[1];var J=od(),te=d(J),ie=d(te),he=v(te,2);Me(he,19,Y,le=>le.id,(le,j)=>{const D=Q(()=>r(i).indexOf(r(j)));var F=id();F.__keydown=$=>h($,r(D));var Z=d(F);ba(Z,{get task(){return r(j)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(F,($,ce)=>u[ce]=$,$=>u==null?void 0:u[$],()=>[r(D)]),H(()=>De(F,"tabindex",r(D)===r(l)?0:-1)),it("focus",F,()=>f(l,r(D),!0)),k(le,F)}),H(le=>L(ie,le),[()=>c(z())]),k(K,J)}),k(S,C)};G(p,S=>{r(i).length===0?S(w):S(x,!1)})}H(()=>L(q,`${r(i).length??""} task${r(i).length!==1?"s":""} in the next ${t()??""} days`)),k(s,m),Ue()}Xe(["keydown"]);var dd=A('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">‚úÖ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),ud=A('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),vd=A('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),hd=A('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">‚Üê Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next ‚Üí</button></div>'),fd=A("<!> <!>",1),_d=A('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function pd(s,e){Ke(e,!0);let t=vs(e,"daysBack",3,30),a=W(0);const n=50,i=new Date;i.setDate(i.getDate()-t()),i.setHours(0,0,0,0);const o=Q(()=>e.tasks.filter(M=>M.status!=="done"||!M.doneAt?!1:new Date(M.doneAt)>=i).sort((M,N)=>new Date(N.doneAt).getTime()-new Date(M.doneAt).getTime())),c=Q(()=>Math.ceil(r(o).length/n)),l=Q(()=>r(o).slice(r(a)*n,(r(a)+1)*n));dt(()=>{r(a)>=r(c)&&r(c)>0&&f(a,r(c)-1)});function u(){r(a)<r(c)-1&&lr(a)}function h(){r(a)>0&&lr(a,-1)}function m(M){const N=new Date(M),z=new Date,Y=z.getTime()-N.getTime(),J=Math.floor(Y/(1e3*60*60*24));return J===0?"Today":J===1?"Yesterday":J<7?`${J} days ago`:N.toLocaleDateString("en-US",{month:"short",day:"numeric",year:N.getFullYear()!==z.getFullYear()?"numeric":void 0})}let y=W(0),_=me([]);dt(()=>{r(y)>=r(l).length&&f(y,Math.max(0,r(l).length-1),!0)});function q(M,N){M.key==="ArrowDown"?(M.preventDefault(),f(y,Math.min(r(y)+1,r(l).length-1),!0)):M.key==="ArrowUp"?(M.preventDefault(),f(y,Math.max(r(y)-1,0),!0)):M.key==="Enter"&&e.onEdit&&(M.preventDefault(),e.onEdit(r(l)[N]))}var g=_d(),p=d(g),w=v(d(p),2),x=d(w),S=v(p,2),C=d(S);{var P=M=>{var N=dd();k(M,N)},K=M=>{var N=fd(),z=qe(N);Me(z,19,()=>r(l),te=>te.id,(te,ie,he)=>{var le=vd();le.__keydown=de=>q(de,r(he));var j=d(le),D=d(j),F=d(D),Z=v(D,2);{var $=de=>{var _e=ud();_e.__click=()=>e.onUncomplete(r(ie)),k(de,_e)};G(Z,de=>{e.onUncomplete&&de($)})}var ce=v(j,2);ba(ce,{get task(){return r(ie)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),Wt(le,(de,_e)=>_[_e]=de,de=>_==null?void 0:_[de],()=>[r(he)]),H(de=>{De(le,"tabindex",r(he)===r(y)?0:-1),L(F,`Completed ${de??""}`)},[()=>m(r(ie).doneAt)]),it("focus",le,()=>f(y,r(he),!0)),k(te,le)});var Y=v(z,2);{var J=te=>{var ie=hd(),he=d(ie);he.__click=h;var le=v(he,2),j=d(le),D=v(le,2);D.__click=u,H(()=>{he.disabled=r(a)===0,L(j,`Page ${r(a)+1} of ${r(c)??""}`),D.disabled=r(a)>=r(c)-1}),k(te,ie)};G(Y,te=>{r(c)>1&&te(J)})}k(M,N)};G(C,M=>{r(o).length===0?M(P):M(K,!1)})}H(()=>L(x,`${r(o).length??""} completed task${r(o).length!==1?"s":""} in the last ${t()??""} days`)),k(s,g),Ue()}Xe(["keydown","click"]);var gd=A('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">üìÅ No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),md=A('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),yd=A('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),kd=A('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),bd=A('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function wd(s,e){Ke(e,!0);const t=Q(()=>()=>{const z=new Map;return e.tasks.filter(J=>J.status!=="done"&&J.status!=="cancelled").forEach(J=>{const te=J.linkedBlockPath||"Uncategorized";z.has(te)||z.set(te,[]),z.get(te).push(J)}),z.forEach(J=>{J.sort((te,ie)=>!te.dueAt&&!ie.dueAt?0:te.dueAt?ie.dueAt?new Date(te.dueAt).getTime()-new Date(ie.dueAt).getTime():-1:1)}),new Map([...z.entries()].sort(([J],[te])=>J.localeCompare(te)))}),a=Q(()=>[...r(t).values()].reduce((z,Y)=>z+Y.length,0));let n=W(me(new Set([...r(t).keys()])));function i(z){const Y=new Set(r(n));Y.has(z)?Y.delete(z):Y.add(z),f(n,Y,!0)}function o(){f(n,new Set([...r(t).keys()]),!0)}function c(){f(n,new Set,!0)}let l=W(0),u=me([]);const h=Q(()=>()=>{const z=[];return r(t).forEach((Y,J)=>{r(n).has(J)&&z.push(...Y)}),z});dt(()=>{r(l)>=r(h).length&&f(l,Math.max(0,r(h).length-1),!0)});function m(z,Y){z.key==="ArrowDown"?(z.preventDefault(),f(l,Math.min(r(l)+1,r(h).length-1),!0)):z.key==="ArrowUp"?(z.preventDefault(),f(l,Math.max(r(l)-1,0),!0)):z.key==="Enter"&&e.onEdit?(z.preventDefault(),e.onEdit(r(h)[Y])):z.key===" "&&e.onDone&&(z.preventDefault(),e.onDone(r(h)[Y]))}function y(z){const Y=z.split("/");return Y[Y.length-1]||z}var _=bd(),q=d(_),g=d(q),p=v(d(g),2),w=d(p),x=v(g,2),S=d(x);S.__click=o;var C=v(S,2);C.__click=c;var P=v(q,2),K=d(P);{var M=z=>{var Y=gd();k(z,Y)},N=z=>{var Y=Pe(),J=qe(Y);Me(J,17,()=>[...r(t).entries()],ut,(te,ie)=>{var he=Q(()=>Qr(r(ie),2));let le=()=>r(he)[0],j=()=>r(he)[1];var D=kd(),F=d(D);F.__click=()=>i(le());var Z=d(F),$=d(Z),ce=v(Z,2),de=d(ce),_e=v(ce,2),se=d(_e),ue=v(F,2);{var U=V=>{var re=yd();Me(re,23,j,b=>b.id,(b,R)=>{const X=Q(()=>r(h).indexOf(r(R)));var ne=md();ne.__keydown=O=>m(O,r(X));var T=d(ne);ba(T,{get task(){return r(R)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(ne,(O,oe)=>u[oe]=O,O=>u==null?void 0:u[O],()=>[r(X)]),H(()=>De(ne,"tabindex",r(X)===r(l)?0:-1)),it("focus",ne,()=>f(l,r(X),!0)),k(b,ne)}),H(b=>De(re,"aria-label",b),[()=>`Tasks for ${y(le())}`]),k(V,re)};G(ue,V=>{r(n).has(le())&&V(U)})}H((V,re)=>{L($,V),De(ce,"title",le()),L(de,re),L(se,j().length)},[()=>r(n).has(le())?"‚ñº":"‚ñ∂",()=>y(le())]),k(te,D)}),k(z,Y)};G(K,z=>{r(t).size===0?z(M):z(N,!1)})}H(()=>L(w,`${r(a)??""} task${r(a)!==1?"s":""} in ${r(t).size??""} project${r(t).size!==1?"s":""}`)),k(s,_),Ue()}Xe(["click","keydown"]);class Is extends Error{constructor(e,t,a,n){super(e),this.line=t,this.column=a,this.suggestion=n,this.name="QuerySyntaxError"}}class aa extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var He=(s=>(s.TODO="TODO",s.IN_PROGRESS="IN_PROGRESS",s.DONE="DONE",s.CANCELLED="CANCELLED",s.NON_TASK="NON_TASK",s.EMPTY="EMPTY",s))(He||{});const Jt=class Jt{constructor(e){E(this,"symbol");E(this,"name");E(this,"nextStatusSymbol");E(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};E(Jt,"TODO",new Jt({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),E(Jt,"DONE",new Jt({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),E(Jt,"IN_PROGRESS",new Jt({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),E(Jt,"CANCELLED",new Jt({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let rs=Jt;class Sd{static parse(e,t=new Date){const a=e.trim().toLowerCase(),n=e;if(!a)return{date:null,isValid:!1,error:"Empty date string",original:n};if(a.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const _=new Date(a);if(!isNaN(_.getTime()))return{date:_,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),a==="today")return{date:o,isValid:!0,original:n};if(a==="tomorrow"){const _=new Date(o);return _.setDate(_.getDate()+1),{date:_,isValid:!0,original:n}}if(a==="yesterday"){const _=new Date(o);return _.setDate(_.getDate()-1),{date:_,isValid:!0,original:n}}const c=a.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(c){const _=parseInt(c[1]),q=c[2],g=new Date(o);return q.startsWith("day")?g.setDate(g.getDate()+_):q.startsWith("week")?g.setDate(g.getDate()+_*7):q.startsWith("month")&&g.setMonth(g.getMonth()+_),{date:g,isValid:!0,original:n}}const l=a.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(l){const _=parseInt(l[1]),q=l[2],g=new Date(o);return q.startsWith("day")?g.setDate(g.getDate()-_):q.startsWith("week")?g.setDate(g.getDate()-_*7):q.startsWith("month")&&g.setMonth(g.getMonth()-_),{date:g,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=a.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const _=h[1],q=u.indexOf(h[2]),g=o.getDay();let p=q-g;_==="next"?p<=0&&(p+=7):p>=0&&(p-=7);const w=new Date(o);return w.setDate(w.getDate()+p),{date:w,isValid:!0,original:n}}const m=a.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(m){const _=u.indexOf(m[1]),q=o.getDay();let g=_-q;g<0&&(g+=7);const p=new Date(o);return p.setDate(p.getDate()+g),{date:p,isValid:!0,original:n}}const y=a.match(/^(this|next|last)\s+(week|month)$/);if(y){const _=y[1],q=y[2],g=new Date(o);if(q==="week"){const p=g.getDay(),w=p===0?-6:1-p;g.setDate(g.getDate()+w),_==="next"?g.setDate(g.getDate()+7):_==="last"&&g.setDate(g.getDate()-7)}else q==="month"&&(g.setDate(1),_==="next"?g.setMonth(g.getMonth()+1):_==="last"&&g.setMonth(g.getMonth()-1));return{date:g,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class Ji{constructor(){E(this,"input","");E(this,"position",0);E(this,"line",1);E(this,"column",1);E(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const a={filters:[]},n=this.input.split(`
`).map(i=>i.trim()).filter(i=>i.length>0);for(let i=0;i<n.length;i++){this.line=i+1,this.column=1;const o=n[i];if(o.startsWith("sort by "))a.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))a.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))a.limit=this.parseLimitInstruction(o);else{const c=this.parseFilterInstruction(o);c&&a.filters.push(c)}}return a}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Is?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(e.startsWith("status.type is ")){const a=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(a)}}if(e.startsWith("status.name includes ")){const a=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(a)}}if(e.startsWith("status.symbol is ")){const a=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(a)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("tag includes ")){const a=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(a)}}if(e.startsWith("tag does not include ")){const a=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(a),negate:!0}}if(e.startsWith("tags include ")){const a=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(a)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const a=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(a)}}if(e.startsWith("path does not include ")){const a=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(a),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};throw new Is(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const a of t){if(e===`has ${a} date`)return{type:"date",operator:"has",value:{field:a}};if(e===`no ${a} date`)return{type:"date",operator:"has",value:{field:a},negate:!0};const n=["before","after","on","on or before","on or after"];for(const i of n){const o=`${a} ${i} `;if(e.startsWith(o)){const c=e.substring(o.length).trim(),l=Sd.parse(c,this.referenceDate);if(!l.isValid||!l.date)throw new Is(`Invalid date value: "${c}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:i,value:{field:a,date:l.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Is(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Is(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Is(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return He.TODO;case"IN_PROGRESS":return He.IN_PROGRESS;case"DONE":return He.DONE;case"CANCELLED":return He.CANCELLED;case"NON_TASK":return He.NON_TASK;default:throw new Is(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}}class lt{}const Os=class Os{constructor(){E(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return Os.instance||(Os.instance=new Os),Os.instance}addDefaultStatuses(){this.add(rs.TODO),this.add(rs.IN_PROGRESS),this.add(rs.DONE),this.add(rs.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new rs({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:rs.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};E(Os,"instance",null);let as=Os;class Td extends lt{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=as.getInstance(),a=e.statusSymbol||" ",i=t.get(a).type===this.statusType;return this.negate?!i:i}}class Dd extends lt{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=as.getInstance(),a=e.statusSymbol||" ",i=t.get(a).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!i:i}}class Ed extends lt{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const a=(e.statusSymbol||" ")===this.symbol;return this.negate?!a:a}}class Ad extends lt{matches(e){const t=as.getInstance(),a=e.statusSymbol||" ";return t.get(a).type===He.DONE}}class xd extends lt{matches(e){const t=as.getInstance(),a=e.statusSymbol||" ";return t.get(a).type!==He.DONE}}class Cd extends lt{constructor(e,t,a){super(),this.field=e,this.comparator=t,this.targetDate=a}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const a=new Date(this.targetDate);a.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<a;case"after":return n>a;case"on":return n.getTime()===a.getTime();case"on or before":return n<=a;case"on or after":return n>=a;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class Id extends lt{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const Rr={lowest:0,low:1,medium:2,normal:2,high:3,highest:4};function qd(s){switch(s){case"low":return"low";case"normal":return"normal";case"high":return"high";case"urgent":return"highest";default:return"normal"}}class Od extends lt{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=qd(e.priority),a=Rr[t],n=Rr[this.level];switch(this.operator){case"is":return a===n;case"above":return a>n;case"below":return a<n;default:return!1}}}class Md extends lt{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],a=this.tag.toLowerCase(),n=t.some(i=>i.toLowerCase().includes(a));return this.negate?!n:n}}class Nd extends lt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class Rd extends lt{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const a=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!a:a}}class Fd extends lt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const a=e.blockedBy&&e.blockedBy.length>0;return this.negate?!a:!!a}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Bd extends lt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Pd extends lt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class zd extends lt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Ld extends lt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class jd extends lt{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class xs{group(e){const t=new Map;for(const a of e){const n=this.getGroupKey(a);this.addToGroup(t,n,a)}return t}addToGroup(e,t,a){e.has(t)||e.set(t,[]),e.get(t).push(a)}}class Kd extends xs{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const a=new Date(e.dueAt);a.setHours(0,0,0,0);const n=a.getTime()-t.getTime(),i=Math.ceil(n/(1e3*60*60*24));return i<0?"Overdue":i===0?"Today":i===1?"Tomorrow":i<=7?"This Week":"Later"}}class Ud extends xs{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const a=new Date(e.scheduledAt);a.setHours(0,0,0,0);const n=a.getTime()-t.getTime(),i=Math.ceil(n/(1e3*60*60*24));return i<0?"Past":i===0?"Today":i===1?"Tomorrow":i<=7?"This Week":"Later"}}class Hd extends xs{getGroupKey(e){const t=as.getInstance(),a=e.statusSymbol||" ";return t.get(a).type}}class Gd extends xs{getGroupKey(e){const t=as.getInstance(),a=e.statusSymbol||" ";return t.get(a).name}}class Yd extends xs{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class Vd extends xs{getGroupKey(e){return e.path||""||"No path"}}class Wd extends xs{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const a=t.lastIndexOf("/");return a===-1?"Root":t.substring(0,a)||"Root"}}class Qd extends xs{group(e){const t=new Map;for(const a of e){const n=a.tags||[];if(n.length===0)this.addToGroup(t,"No tags",a);else for(const i of n)this.addToGroup(t,i,a)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}class Xd{constructor(e){E(this,"dependencyGraph",null);this.taskIndex=e}setDependencyGraph(e){this.dependencyGraph=e}execute(e){const t=performance.now();try{let a=this.taskIndex.getAllTasks();const n=a.length;e.filters.length>0&&(a=this.applyFilters(a,e.filters)),e.sort&&(a=this.applySort(a,e.sort)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let i;e.group&&(i=this.applyGrouping(a,e.group));const c=performance.now()-t;return{tasks:a,groups:i,totalCount:n,executionTimeMs:c}}catch(a){throw new aa(`Failed to execute query: ${a instanceof Error?a.message:String(a)}`,a instanceof Error?a:void 0)}}executeString(e){const a=new Ji().parse(e);return this.execute(a)}applyFilters(e,t){let a=e;for(const n of t){const i=this.createFilter(n);a=a.filter(o=>i.matches(o))}return a}createFilter(e){switch(e.type){case"done":return e.value?new Ad:new xd;case"status":if(e.operator==="type-is")return new Td(e.value,e.negate);if(e.operator==="name-includes")return new Dd(e.value,e.negate);if(e.operator==="symbol-is")return new Ed(e.value,e.negate);throw new aa(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new Id(e.value.field,e.negate):new Cd(e.value.field,e.operator,e.value.date);case"priority":return new Od(e.operator,e.value);case"tag":return e.operator==="has"?new Nd(!e.value):new Md(e.value,e.negate);case"path":return new Rd(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new Fd(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Bd(this.dependencyGraph,!e.value);throw new aa(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Pd(!e.value);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new zd(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="OR"&&e.left&&e.right)return new Ld(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="NOT"&&e.inner)return new jd(this.createFilter(e.inner));throw new aa(`Invalid boolean operator: ${e.operator}`);default:throw new aa(`Unknown filter type: ${e.type}`)}}applySort(e,t){const a=[...e];return a.sort((n,i)=>{let o=0;switch(t.field){case"due":o=this.compareDates(n.dueAt,i.dueAt);break;case"scheduled":o=this.compareDates(n.scheduledAt,i.scheduledAt);break;case"start":o=this.compareDates(n.startAt,i.startAt);break;case"created":o=this.compareDates(n.createdAt,i.createdAt);break;case"done":o=this.compareDates(n.doneAt,i.doneAt);break;case"priority":o=this.comparePriorities(n.priority,i.priority);break;case"status.type":o=this.compareStatusTypes(n,i);break;case"description":o=(n.description||"").localeCompare(i.description||"");break;case"path":o=(n.path||"").localeCompare(i.path||"");break;default:o=n.name.localeCompare(i.name)}return t.reverse?-o:o}),a}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const a={low:1,normal:2,high:3,urgent:4},n=a[e||"normal"]||2,i=a[t||"normal"]||2;return n-i}compareStatusTypes(e,t){const a=n=>{const i=n.statusSymbol||" ";return i===" "?0:i==="/"?1:i==="x"?2:i==="-"?3:0};return a(e)-a(t)}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new Kd;case"scheduled":return new Ud;case"status.type":return new Hd;case"status.name":return new Gd;case"priority":return new Yd;case"path":return new Vd;case"folder":return new Wd;case"tags":return new Qd;default:throw new aa(`Unknown grouping field: ${e}`)}}}var Jd=A('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Zd=A('<div class="search-tab__error svelte-1yjlv38"> </div>'),$d=A('<div class="search-tab__stats svelte-1yjlv38"> </div>'),eu=A('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),tu=A('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),su=A('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),au=A('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">üîç No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),nu=A('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),ru=A(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function iu(s,e){Ke(e,!0);let t=W(""),a=W(me([])),n=W(""),i=W(0),o=W(me([])),c=W(!1),l=W(!1);const u=["not done","due today","priority high","status.type IN_PROGRESS","not done AND due before tomorrow","has tags","done after 7 days ago","not done GROUP BY priority"],h={getAllTasks:()=>e.tasks},m=new Xd(h);function y(){if(!r(t).trim()){f(a,[],!0),f(n,"");return}f(l,!0),f(n,"");try{const V=new Ji().parse(r(t)),re=m.execute(V);if(f(a,re.tasks,!0),f(i,re.executionTimeMs,!0),!r(o).includes(r(t))){f(o,[r(t),...r(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(r(o)))}catch{}}}catch(U){f(n,U instanceof Error?U.message:String(U),!0),f(a,[],!0),ee.error(`Query error: ${r(n)}`)}finally{f(l,!1)}}function _(){try{const U=localStorage.getItem("query-history");U&&f(o,JSON.parse(U),!0)}catch{}}function q(U){f(t,U,!0),y()}function g(U){f(t,U,!0),f(c,!1),y()}function p(){f(o,[],!0);try{localStorage.removeItem("query-history")}catch{}f(c,!1)}function w(U){U.key==="Enter"&&!U.shiftKey&&(U.preventDefault(),y())}dt(()=>{_()});let x=W(0),S=me([]);dt(()=>{r(x)>=r(a).length&&f(x,Math.max(0,r(a).length-1),!0)});function C(U,V){U.key==="ArrowDown"?(U.preventDefault(),f(x,Math.min(r(x)+1,r(a).length-1),!0)):U.key==="ArrowUp"?(U.preventDefault(),f(x,Math.max(r(x)-1,0),!0)):U.key==="Enter"&&e.onEdit?(U.preventDefault(),e.onEdit(r(a)[V])):U.key===" "&&e.onDone&&(U.preventDefault(),e.onDone(r(a)[V]))}var P=ru(),K=v(d(P),2),M=d(K),N=d(M);N.__keydown=w;var z=v(N,2),Y=d(z);Y.__click=y;var J=d(Y),te=v(Y,2);{var ie=U=>{var V=Jd();V.__click=()=>f(c,!r(c));var re=d(V);H(()=>L(re,`History (${r(o).length??""})`)),k(U,V)};G(te,U=>{r(o).length>0&&U(ie)})}var he=v(M,2);{var le=U=>{var V=Zd(),re=d(V);H(()=>L(re,`‚ö†Ô∏è ${r(n)??""}`)),k(U,V)};G(he,U=>{r(n)&&U(le)})}var j=v(he,2);{var D=U=>{var V=$d(),re=d(V);H(b=>L(re,`Found ${r(a).length??""} task${r(a).length!==1?"s":""} in ${b??""}ms`),[()=>r(i).toFixed(2)]),k(U,V)};G(j,U=>{r(i)>0&&!r(n)&&U(D)})}var F=v(K,2);{var Z=U=>{var V=tu(),re=d(V),b=v(d(re),2);b.__click=p;var R=v(re,2);Me(R,21,()=>r(o),ut,(X,ne)=>{var T=eu(),O=d(T);O.__click=()=>g(r(ne));var oe=d(O);H(()=>L(oe,r(ne))),k(X,T)}),k(U,V)};G(F,U=>{r(c)&&r(o).length>0&&U(Z)})}var $=v(F,2),ce=v(d($),2);Me(ce,21,()=>u,ut,(U,V)=>{var re=su();re.__click=()=>q(r(V));var b=d(re),R=d(b);H(()=>L(R,r(V))),k(U,re)});var de=v($,2),_e=d(de);{var se=U=>{var V=au();k(U,V)},ue=U=>{var V=Pe(),re=qe(V);{var b=R=>{var X=Pe(),ne=qe(X);Me(ne,19,()=>r(a),T=>T.id,(T,O,oe)=>{var ke=nu();ke.__keydown=ye=>C(ye,r(oe));var xe=d(ke);ba(xe,{get task(){return r(O)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Wt(ke,(ye,Ne)=>S[Ne]=ye,ye=>S==null?void 0:S[ye],()=>[r(oe)]),H(()=>De(ke,"tabindex",r(oe)===r(x)?0:-1)),it("focus",ke,()=>f(x,r(oe),!0)),k(T,ke)}),k(R,X)};G(re,R=>{r(a).length>0&&R(b)},!0)}k(U,V)};G(_e,U=>{r(a).length===0&&r(t).trim()&&!r(n)?U(se):U(ue,!1)})}H(()=>{Y.disabled=r(l),L(J,r(l)?"Searching...":"Search")}),Ve(N,()=>r(t),U=>f(t,U)),k(s,P),Ue()}Xe(["keydown","click"]);class Bn{static parse(e){const t=e,a=e.trim().toLowerCase();if(!a)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=a.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let i=n[1],o;const c=i.match(/^(.+?)\s+when\s+done$/),l=i.match(/^(.+?)\s+when\s+due$/);if(c?(i=c[1],o=!0):l&&(i=l[1],o=!1),i==="weekday"||i==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(i==="weekend"||i==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=i.match(/^(\d+\s+)?days?$/);if(u)return{frequency:{type:"daily",interval:u[1]?parseInt(u[1]):1,whenDone:o},raw:t,isValid:!0};const h=i.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(h){const _=h[1]?parseInt(h[1]):1,q=h[2];if(!q)return{frequency:{type:"weekly",interval:_,weekdays:[1],whenDone:o},raw:t,isValid:!0};const g=this.parseDayNames(q);return g.length===0?{frequency:{type:"weekly",interval:_,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:_,weekdays:g,whenDone:o},raw:t,isValid:!0}}const m=i.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(m){const _=m[1]?parseInt(m[1]):1,q=m[2]?parseInt(m[2]):1;return q<1||q>31?{frequency:{type:"monthly",interval:_,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:_,dayOfMonth:q,whenDone:o},raw:t,isValid:!0}}const y=i.match(/^(\d+\s+)?years?$/);return y?{frequency:{type:"yearly",interval:y[1]?parseInt(y[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=e.interval;let a;switch(e.type){case"daily":a=t===1?"every day":`every ${t} days`;break;case"weekly":{const n=t===1?"week":`${t} weeks`;if(e.weekdays.length===0)a=`every ${n}`;else{const i=e.weekdays.map(o=>this.getDayName(o)).join(", ");a=`every ${n} on ${i}`}break}case"monthly":{const n=t===1?"month":`${t} months`,i=this.getDaySuffix(e.dayOfMonth);a=`every ${n} on the ${e.dayOfMonth}${i}`;break}case"yearly":{a=`every ${t===1?"year":`${t} years`}`;break}default:a="every day"}return e.whenDone?`${a} when done`:a}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},a=e.split(",").map(i=>i.trim().toLowerCase()),n=[];for(const i of a)i in t&&n.push(t[i]);return n}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var ou=A('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),lu=A('<div class="priority-selector svelte-1w15n9q"></div>');function cu(s,e){Ke(e,!0);let t=vs(e,"value",15,"normal");const a=[{value:"urgent",label:"Urgent",emoji:"üî¥",color:"var(--b3-theme-error, #ff4444)"},{value:"high",label:"High",emoji:"üü†",color:"#ff8800"},{value:"normal",label:"Normal",emoji:"üü°",color:"#ffcc00"},{value:"low",label:"Low",emoji:"üü¢",color:"#44cc44"}];function n(o){t(o),e.onchange(o)}var i=lu();Me(i,21,()=>a,ut,(o,c)=>{var l=ou();let u;var h=d(l);h.__change=()=>n(r(c).value);var m=v(h,2),y=d(m),_=v(m,2),q=d(_);H(()=>{u=Re(l,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===r(c).value}),Vs(l,`--priority-color: ${r(c).color??""}`),Ki(h,r(c).value),la(h,t()===r(c).value),L(y,r(c).emoji),L(q,r(c).label)}),k(o,l)}),k(s,i),Ue()}Xe(["change"]);var du=A('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),uu=A('<div class="status-selector svelte-v9ezc0"></div>');function vu(s,e){Ke(e,!0);let t=vs(e,"value",15,"todo");const a=[{value:"todo",label:"Todo",icon:"‚óã",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"‚úì",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"‚úï",color:"#999"}];function n(o){t(o),e.onchange(o)}var i=uu();Me(i,21,()=>a,ut,(o,c)=>{var l=du();let u;var h=d(l);h.__change=()=>n(r(c).value);var m=v(h,2),y=d(m),_=v(m,2),q=d(_);H(()=>{u=Re(l,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===r(c).value}),Vs(l,`--status-color: ${r(c).color??""}`),Ki(h,r(c).value),la(h,t()===r(c).value),L(y,r(c).icon),L(q,r(c).label)}),k(o,l)}),k(s,i),Ue()}Xe(["change"]);var hu=A('<div class="recurrence-input__valid svelte-787fjp">‚úì Valid recurrence pattern</div>'),fu=A('<div class="recurrence-input__error svelte-787fjp"> </div>'),_u=A('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),pu=A('<li class="svelte-787fjp"> </li>'),gu=A('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),mu=A('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function yu(s,e){Ke(e,!0);let t=vs(e,"value",15,""),a=vs(e,"showPreview",3,!0);const n=Q(()=>Bn.parse(t())),i=Q(()=>r(n).isValid),o=Q(()=>r(n).error);function c(w,x=3){const S=[],C=new Date;for(let P=0;P<x;P++){const K=new Date(C);switch(w.type){case"daily":K.setDate(C.getDate()+P*w.interval);break;case"weekly":K.setDate(C.getDate()+P*w.interval*7);break;case"monthly":K.setMonth(C.getMonth()+P*w.interval);break;case"yearly":K.setFullYear(C.getFullYear()+P*w.interval);break}S.push(K.toLocaleDateString())}return S}const l=Q(()=>r(i)&&a()?c(r(n).frequency):[]);function u(w){const S=w.target.value;t(S);const C=Bn.parse(S);e.onchange(S,C.isValid?C.frequency:null,C.isValid)}var h=mu(),m=d(h);let y;m.__input=u;var _=v(m,2);{var q=w=>{var x=_u(),S=d(x);{var C=K=>{var M=hu();k(K,M)},P=K=>{var M=fu(),N=d(M);H(()=>L(N,`‚ö† ${(r(o)||"Invalid recurrence pattern")??""}`)),k(K,M)};G(S,K=>{r(i)?K(C):K(P,!1)})}k(w,x)};G(_,w=>{t().length>0&&w(q)})}var g=v(_,2);{var p=w=>{var x=gu(),S=v(d(x),2);Me(S,21,()=>r(l),ut,(C,P)=>{var K=pu(),M=d(K);H(()=>L(M,r(P))),k(C,K)}),k(w,x)};G(g,w=>{r(i)&&a()&&r(l).length>0&&w(p)})}H(()=>{y=Re(m,1,"recurrence-input__field svelte-787fjp",null,y,{valid:r(i),invalid:!r(i)&&t().length>0}),De(m,"aria-invalid",!r(i)&&t().length>0)}),Ve(m,t),k(s,h),Ue()}Xe(["input"]);var ku=A('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">‚úï</button></div>'),bu=A('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),wu=A('<span class="dependency-picker__option-check svelte-10ls0lk">‚úì</span>'),Su=A('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Tu=A('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),Du=A('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function Fr(s,e){Ke(e,!0);let t=vs(e,"selected",31,()=>me([])),a=vs(e,"label",3,"Select tasks"),n=W(""),i=W(!1);const o=Q(()=>e.repository.getAllTasks().filter(K=>K.id!==e.excludeId)),c=Q(()=>r(n).trim()?r(o).filter(K=>K.name.toLowerCase().includes(r(n).toLowerCase())):r(o)),l=Q(()=>r(o).filter(K=>t().includes(K.id)));function u(K){if(!t().includes(K)){const M=[...t(),K];t(M),e.onchange(M)}f(n,""),f(i,!1)}function h(K){const M=t().filter(N=>N!==K);t(M),e.onchange(M)}function m(){f(i,!0)}function y(){setTimeout(()=>{f(i,!1)},200)}var _=Du(),q=d(_),g=d(q),p=v(q,2);{var w=K=>{var M=bu();Me(M,21,()=>r(l),N=>N.id,(N,z)=>{var Y=ku(),J=d(Y),te=d(J),ie=v(J,2);ie.__click=()=>h(r(z).id),H(()=>{L(te,r(z).name),De(ie,"aria-label",`Remove ${r(z).name??""}`)}),k(N,Y)}),k(K,M)};G(p,K=>{r(l).length>0&&K(w)})}var x=v(p,2),S=d(x),C=v(S,2);{var P=K=>{var M=Tu();Me(M,21,()=>r(c).slice(0,10),N=>N.id,(N,z)=>{var Y=Su();let J;Y.__click=()=>u(r(z).id);var te=d(Y),ie=d(te),he=v(te,2);{var le=j=>{var D=wu();k(j,D)};G(he,j=>{t().includes(r(z).id)&&j(le)})}H((j,D)=>{J=Re(Y,1,"dependency-picker__option svelte-10ls0lk",null,J,j),Y.disabled=D,L(ie,r(z).name)},[()=>({selected:t().includes(r(z).id)}),()=>t().includes(r(z).id)]),k(N,Y)}),k(K,M)};G(C,K=>{r(i)&&r(c).length>0&&K(P)})}H(()=>L(g,a())),it("focus",S,m),it("blur",S,y),Ve(S,()=>r(n),K=>f(n,K)),k(s,_),Ue()}Xe(["click"]);var Eu=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Au=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),xu=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Cu=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Iu=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),qu=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Ou=A('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">‚úï</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">üí° Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">‚åò/Ctrl+Enter</kbd> to save</div></div></div>');function Zi(s,e){var je,Be,tt,st,_t,Ut,pt,Ot,gt,Ht,gs,At;Ke(e,!0);const t="every day",a="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",i=!e.task;let o=W(me(((je=e.task)==null?void 0:je.name)||"")),c=W(me(((Be=e.task)==null?void 0:Be.description)||"")),l=W(me(((tt=e.task)==null?void 0:tt.priority)||"normal")),u=W(me(((st=e.task)==null?void 0:st.status)||"todo")),h=W(me((_t=e.task)!=null&&_t.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),m=W(me((Ut=e.task)!=null&&Ut.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),y=W(me((pt=e.task)!=null&&pt.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),_=W(me(((Ot=e.task)==null?void 0:Ot.recurrenceText)||((gt=e.task)!=null&&gt.frequency?Bn.stringify(e.task.frequency):t))),q=W(me(((Ht=e.task)==null?void 0:Ht.frequency)||null)),g=W(!0),p=W(me(((gs=e.task)==null?void 0:gs.blockedBy)||[])),w=W(me(((At=e.task)==null?void 0:At.dependsOn)||[])),x=W(me({name:!1,dueAt:!1,recurrence:!1})),S=W(!1),C=W(null);const P=Q(()=>r(x).name&&!r(o).trim()?"Task name is required":""),K=Q(()=>r(x).dueAt?r(h)?Number.isNaN(new Date(r(h)).getTime())?"Invalid due date":"":"Due date is required":""),M=Q(()=>r(x).recurrence&&!r(g)?"Invalid recurrence pattern":""),N=Q(()=>!!(r(P)||r(K)||r(M)));cn(()=>{requestAnimationFrame(()=>{var B;(B=r(C))==null||B.focus()})});function z(B,fe,Ye){f(_,B,!0),f(q,fe,!0),f(g,Ye,!0),r(x).recurrence=!0}function Y(B){f(l,B,!0)}function J(B){f(u,B,!0)}function te(B){f(p,B,!0)}function ie(B){f(w,B,!0)}async function he(){if(f(x,{name:!0,dueAt:!0,recurrence:!0},!0),r(N)){ee.warning("Please fix validation errors");return}if(!r(q)){ee.error("Invalid recurrence pattern");return}f(S,!0);try{let B;i?B=Gi(r(o).trim(),r(q),new Date(r(h))):(B={...e.task},B.name=r(o).trim(),B.frequency=r(q),B.dueAt=new Date(r(h)).toISOString()),B.description=r(c).trim()||void 0,B.priority=r(l),B.status=r(u),B.recurrenceText=r(_),B.scheduledAt=r(m)?new Date(r(m)).toISOString():void 0,B.startAt=r(y)?new Date(r(y)).toISOString():void 0,B.blockedBy=r(p).length>0?r(p):void 0,B.dependsOn=r(w).length>0?r(w):void 0,B.updatedAt=new Date().toISOString(),r(u)==="done"&&!B.lastCompletedAt&&(B.lastCompletedAt=new Date().toISOString()),r(u)==="cancelled"&&!B.cancelledAt&&(B.cancelledAt=new Date().toISOString()),await e.repository.saveTask(B),e.onSave&&e.onSave(B),ee.success(`Task "${B.name}" ${i?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(B){ee.error(`Failed to save task: ${B}`)}finally{f(S,!1)}}function le(B){B.key==="Escape"&&e.onClose(),(B.metaKey||B.ctrlKey)&&B.key==="Enter"&&(B.preventDefault(),he())}function j(B){return B?new Date(B).toLocaleString():"‚Äî"}var D=Ou();D.__keydown=le;var F=d(D),Z=d(F),$=d(Z),ce=d($),de=v($,2);de.__click=function(...B){var fe;(fe=e.onClose)==null||fe.apply(this,B)};var _e=v(Z,2),se=d(_e),ue=v(d(se),2);ue.__input=()=>r(x).name=!0,Wt(ue,B=>f(C,B),()=>r(C));var U=v(ue,2);{var V=B=>{var fe=Eu(),Ye=d(fe);H(()=>L(Ye,r(P))),k(B,fe)};G(U,B=>{r(P)&&B(V)})}var re=v(se,2),b=v(d(re),2),R=v(re,2),X=v(d(R),2);cu(X,{get value(){return r(l)},onchange:Y});var ne=v(R,2),T=v(d(ne),2);vu(T,{get value(){return r(u)},onchange:J});var O=v(ne,2),oe=v(d(O),2);oe.__input=()=>r(x).dueAt=!0;var ke=v(oe,2);{var xe=B=>{var fe=Au(),Ye=d(fe);H(()=>L(Ye,r(K))),k(B,fe)};G(ke,B=>{r(K)&&B(xe)})}var ye=v(O,2),Ne=v(d(ye),2),Fe=v(ye,2),ft=v(d(Fe),2),qt=v(Fe,2),Je=v(d(qt),2);yu(Je,{get value(){return r(_)},onchange:z,showPreview:!0});var Qt=v(Je,2);{var Ze=B=>{var fe=xu(),Ye=d(fe);H(()=>L(Ye,r(M))),k(B,fe)};G(Qt,B=>{r(M)&&B(Ze)})}var Oe=v(qt,2),Dt=d(Oe);{let B=Q(()=>{var fe;return(fe=e.task)==null?void 0:fe.id});Fr(Dt,{get repository(){return e.repository},get selected(){return r(p)},get excludeId(){return r(B)},onchange:te,label:a})}var ze=v(Oe,2),$e=d(ze);{let B=Q(()=>{var fe;return(fe=e.task)==null?void 0:fe.id});Fr($e,{get repository(){return e.repository},get selected(){return r(w)},get excludeId(){return r(B)},onchange:ie,label:n})}var ns=v(ze,2),Xt=d(ns),Lt=v(d(Xt),2),jt=d(Lt),ae=v(Xt,2);{var pe=B=>{var fe=Cu(),Ye=v(d(fe),2),Cs=d(Ye);H(wa=>L(Cs,wa),[()=>j(e.task.lastCompletedAt)]),k(B,fe)};G(ae,B=>{var fe;(fe=e.task)!=null&&fe.lastCompletedAt&&B(pe)})}var Ae=v(ae,2);{var Le=B=>{var fe=Iu(),Ye=v(d(fe),2),Cs=d(Ye);H(wa=>L(Cs,wa),[()=>j(e.task.cancelledAt)]),k(B,fe)};G(Ae,B=>{var fe;(fe=e.task)!=null&&fe.cancelledAt&&B(Le)})}var ct=v(Ae,2);{var et=B=>{var fe=qu(),Ye=v(d(fe),2),Cs=d(Ye);H(()=>L(Cs,e.task.linkedBlockId)),k(B,fe)};G(ct,B=>{var fe;(fe=e.task)!=null&&fe.linkedBlockId&&B(et)})}var Kt=v(_e,2),Et=d(Kt);Et.__click=function(...B){var fe;(fe=e.onClose)==null||fe.apply(this,B)};var ge=v(Et,2);ge.__click=he;var Ie=d(ge);H(B=>{L(ce,i?"Create Task":"Edit Task"),De(ue,"aria-invalid",!!r(P)),De(oe,"aria-invalid",!!r(K)),L(jt,B),ge.disabled=r(S),L(Ie,r(S)?"Saving...":i?"Create Task":"Save Changes")},[()=>{var B;return j((B=e.task)==null?void 0:B.createdAt)}]),it("blur",ue,()=>r(x).name=!0),Ve(ue,()=>r(o),B=>f(o,B)),Ve(b,()=>r(c),B=>f(c,B)),it("blur",oe,()=>r(x).dueAt=!0),Ve(oe,()=>r(h),B=>f(h,B)),Ve(Ne,()=>r(m),B=>f(m,B)),Ve(ft,()=>r(y),B=>f(y,B)),k(s,D),Ue()}Xe(["keydown","click","input"]);const Mu=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];class Nu{constructor(e){E(this,"config");this.config=e}evaluate(e,t){if(!this.config.enabled||this.config.mode==="all")return!0;const a=this.config.rules.filter(o=>o.enabled);if(a.length===0)return!0;const i=a.map(o=>this.evaluateRule(o,e,t)).some(o=>o);return this.config.mode==="include"?i:!i}updateConfig(e){this.config=e}getConfig(){return this.config}evaluateRule(e,t,a){switch(e.type){case"tag":const n=this.extractTags(t),i=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${i}$`);return n.some(c=>o.test(c));case"regex":try{return new RegExp(e.pattern).test(t)}catch{return!1}case"path":return a?a.includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}extractTags(e){return e.match(/#[\w/-]+/g)||[]}}function Ru(s){if(!s.pattern||s.pattern.trim().length===0)return{valid:!1,error:"Pattern cannot be empty"};switch(s.type){case"regex":try{return new RegExp(s.pattern),{valid:!0}}catch(e){return{valid:!1,error:`Invalid regex pattern: ${e instanceof Error?e.message:String(e)}`}}case"tag":return s.pattern.startsWith("#")?{valid:!0}:{valid:!1,error:"Tag pattern should start with #"};case"path":case"marker":return{valid:!0};default:return{valid:!1,error:`Unknown rule type: ${s.type}`}}}function Fu(s,e,t){return{id:typeof crypto<"u"&&crypto.randomUUID?`rule_${crypto.randomUUID()}`:`rule_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,type:s,pattern:e,enabled:!0,description:t}}const Br={enabled:!1,mode:"all",rules:[]},Ms=class Ms{constructor(){E(this,"engine");this.engine=new Nu(Br)}static getInstance(){return Ms.instance||(Ms.instance=new Ms),Ms.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(Br)}};E(Ms,"instance",null);let Pn=Ms;var Bu=A('<p class="empty-state svelte-b8rwae">No filter rules configured</p>'),Pu=A('<span class="rule-description svelte-b8rwae"> </span>'),zu=A('<div class="rule-item svelte-b8rwae"><input type="checkbox" class="rule-checkbox svelte-b8rwae"/> <div class="rule-info svelte-b8rwae"><span class="rule-type svelte-b8rwae"> </span> <code class="rule-pattern svelte-b8rwae"> </code> <!></div> <button class="delete-btn svelte-b8rwae">Delete</button></div>'),Lu=A('<div class="rules-list svelte-b8rwae"></div>'),ju=A('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Task Filter</h3> <p class="description svelte-b8rwae">Control which checkboxes are treated as tasks</p> <div class="form-field svelte-b8rwae"><label class="settings__toggle svelte-b8rwae"><input type="checkbox" class="svelte-b8rwae"/> <span>Enable Global Filter</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Filter Mode</label> <select class="settings__input svelte-b8rwae"><option>All checkboxes are tasks (default)</option><option>Only checkboxes matching rules</option><option>All except checkboxes matching rules</option></select> <p class="hint svelte-b8rwae"><!></p></div> <div class="rules-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Filter Rules</h4> <!></div> <div class="add-rule-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Add Rule</h4> <div class="add-rule-form svelte-b8rwae"><select class="settings__input svelte-b8rwae"><option>Tag (e.g., #task)</option><option>Regex pattern</option><option>Document path (e.g., daily/)</option><option>Text marker (e.g., TODO:)</option></select> <input type="text" placeholder="Pattern" class="settings__input svelte-b8rwae"/> <input type="text" placeholder="Description (optional)" class="settings__input svelte-b8rwae"/> <button class="add-btn svelte-b8rwae">Add Rule</button></div></div> <div class="examples svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Examples</h4> <ul class="svelte-b8rwae"><li class="svelte-b8rwae"><strong>Tag:</strong> <code class="svelte-b8rwae">#task</code> - Only checkboxes with #task tag</li> <li class="svelte-b8rwae"><strong>Tag wildcard:</strong> <code class="svelte-b8rwae">#work/*</code> - Any #work subtag</li> <li class="svelte-b8rwae"><strong>Path:</strong> <code class="svelte-b8rwae">projects/</code> - Only in projects folder</li> <li class="svelte-b8rwae"><strong>Regex:</strong> <code class="svelte-b8rwae">TODO:|TASK:</code> - Checkboxes with TODO: or TASK:</li> <li class="svelte-b8rwae"><strong>Marker:</strong> <code class="svelte-b8rwae">@action</code> - Checkboxes with @action marker</li></ul></div></div>');function Ku(s,e){Ke(e,!0);let t=Pn.getInstance(),a=me(t.getConfig()),n=W("tag"),i=W(""),o=W("");function c(){if(!r(i).trim()){ee.error("Pattern cannot be empty");return}const se=Fu(r(n),r(i).trim(),r(o).trim()),ue=Ru(se);if(!ue.valid){ee.error(ue.error||"Invalid rule");return}a.rules.push(se),h(),f(i,""),f(o,""),ee.success("Filter rule added")}function l(se){a.rules=a.rules.filter(ue=>ue.id!==se),h(),ee.success("Filter rule deleted")}function u(se){const ue=a.rules.find(U=>U.id===se);ue&&(ue.enabled=!ue.enabled,h())}function h(){t.updateConfig(a)}function m(){h()}function y(){h()}var _=ju(),q=v(d(_),4),g=d(q),p=d(g);p.__change=y;var w=v(q,2),x=v(d(w),2);x.__change=m;var S=d(x);S.value=S.__value="all";var C=v(S);C.value=C.__value="include";var P=v(C);P.value=P.__value="exclude";var K=v(x,2),M=d(K);{var N=se=>{var ue=oa("All checkboxes will be treated as tasks (no filtering)");k(se,ue)},z=se=>{var ue=Pe(),U=qe(ue);{var V=b=>{var R=oa("Only checkboxes matching at least one rule will be treated as tasks");k(b,R)},re=b=>{var R=Pe(),X=qe(R);{var ne=T=>{var O=oa("Checkboxes matching any rule will be ignored");k(T,O)};G(X,T=>{a.mode==="exclude"&&T(ne)},!0)}k(b,R)};G(U,b=>{a.mode==="include"?b(V):b(re,!1)},!0)}k(se,ue)};G(M,se=>{a.mode==="all"?se(N):se(z,!1)})}var Y=v(w,2),J=v(d(Y),2);{var te=se=>{var ue=Bu();k(se,ue)},ie=se=>{var ue=Lu();Me(ue,21,()=>a.rules,ut,(U,V)=>{var re=zu(),b=d(re);b.__change=()=>u(r(V).id);var R=v(b,2),X=d(R),ne=d(X),T=v(X,2),O=d(T),oe=v(T,2);{var ke=ye=>{var Ne=Pu(),Fe=d(Ne);H(()=>L(Fe,r(V).description)),k(ye,Ne)};G(oe,ye=>{r(V).description&&ye(ke)})}var xe=v(R,2);xe.__click=()=>l(r(V).id),H(()=>{la(b,r(V).enabled),L(ne,r(V).type),L(O,r(V).pattern)}),k(U,re)}),k(se,ue)};G(J,se=>{a.rules.length===0?se(te):se(ie,!1)})}var he=v(Y,2),le=v(d(he),2),j=d(le),D=d(j);D.value=D.__value="tag";var F=v(D);F.value=F.__value="regex";var Z=v(F);Z.value=Z.__value="path";var $=v(Z);$.value=$.__value="marker";var ce=v(j,2),de=v(ce,2),_e=v(de,2);_e.__click=c,Ui(p,()=>a.enabled,se=>a.enabled=se),Mn(x,()=>a.mode,se=>a.mode=se),Mn(j,()=>r(n),se=>f(n,se)),Ve(ce,()=>r(i),se=>f(i,se)),Ve(de,()=>r(o),se=>f(o,se)),k(s,_),Ue()}Xe(["change","click"]);var Uu=A('<button class="delete-btn svelte-1qw3eru">Delete</button>'),Hu=A('<span class="default-badge svelte-1qw3eru">Default</span>'),Gu=A('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),Yu=A('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function Vu(s,e){Ke(e,!0);let t=as.getInstance(),a=W(me([])),n=W(""),i=W(""),o=W(me(He.TODO)),c=W("x");function l(){f(a,t.getAll(),!0)}function u(){if(!r(n).trim()||!r(i).trim()){ee.error("Symbol and name are required");return}if(r(n).length!==1){ee.error("Symbol must be a single character");return}const V={symbol:r(n),name:r(i),type:r(o),nextStatusSymbol:r(c)},re=new rs(V);t.register(re),l(),y(),ee.success(`Status "${r(i)}" added`)}function h(V){if([" ","x","/","-"].includes(V)){ee.error("Cannot delete default status");return}t.unregister(V),l(),ee.success("Status deleted")}function m(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),l(),ee.success("Statuses reset to defaults"))}function y(){f(n,""),f(i,""),f(o,He.TODO,!0),f(c,"x")}dt(()=>{l()});var _=Yu(),q=v(d(_),4),g=d(q),p=d(g),w=v(d(p));Me(w,21,()=>r(a),ut,(V,re)=>{var b=Gu(),R=d(b),X=d(R),ne=d(X),T=v(R),O=d(T),oe=v(T),ke=d(oe),xe=d(ke),ye=v(oe),Ne=d(ye),Fe=d(Ne),ft=v(ye),qt=d(ft),Je=d(qt),Qt=v(ft),Ze=d(Qt);{var Oe=ze=>{var $e=Uu();$e.__click=()=>h(r(re).symbol),k(ze,$e)},Dt=ze=>{var $e=Hu();k(ze,$e)};G(Ze,ze=>{[" ","x","/","-"].includes(r(re).symbol)?ze(Dt,!1):ze(Oe)})}H(()=>{L(ne,`[${r(re).symbol??""}]`),L(O,r(re).name),L(xe,r(re).type),L(Fe,`[${r(re).nextStatusSymbol??""}]`),L(Je,`- [${r(re).symbol??""}] Task example`)}),k(V,b)});var x=v(q,2),S=v(d(x),2),C=d(S),P=d(C),K=v(d(P),2),M=v(P,2),N=v(d(M),2),z=v(M,2),Y=v(d(z),2),J=d(Y),te={},ie=v(J),he={},le=v(ie),j={},D=v(le),F={},Z=v(D),$={},ce=v(z,2),de=v(d(ce),2),_e=v(ce,2),se=v(d(_e),2);se.__click=u;var ue=v(x,2),U=d(ue);U.__click=m,H(()=>{te!==(te=He.TODO)&&(J.value=(J.__value=He.TODO)??""),he!==(he=He.IN_PROGRESS)&&(ie.value=(ie.__value=He.IN_PROGRESS)??""),j!==(j=He.DONE)&&(le.value=(le.__value=He.DONE)??""),F!==(F=He.CANCELLED)&&(D.value=(D.__value=He.CANCELLED)??""),$!==($=He.NON_TASK)&&(Z.value=(Z.__value=He.NON_TASK)??"")}),Ve(K,()=>r(n),V=>f(n,V)),Ve(N,()=>r(i),V=>f(i,V)),Mn(Y,()=>r(o),V=>f(o,V)),Ve(de,()=>r(c),V=>f(c,V)),k(s,_),Ue()}Xe(["click"]);var Wu=A('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),Qu=A("<div> </div>"),Xu=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),Ju=A('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Zu=A('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),$u=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section>'),ev=A('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),tv=A('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filter</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function sv(s,e){Ke(e,!0);let t=W(me(Nn)),a=W(null),n=me({}),i=W("general");dt(()=>{f(t,e.eventService.getConfig(),!0)});async function o(){try{await e.eventService.saveConfig(r(t)),ee.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(N){ee.error("Failed to save settings: "+N)}}async function c(){f(a,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const N=await e.eventService.testConnection();n.n8n={success:N.success,message:N.success?"Test successful!":N.message||"Test failed. Check configuration."}}catch(N){n.n8n={success:!1,message:"Error: "+(N instanceof Error?N.message:String(N))}}finally{f(a,null)}}var l=tv(),u=d(l),h=v(d(u),2);{var m=N=>{var z=Wu();z.__click=function(...Y){var J;(J=e.onClose)==null||J.apply(this,Y)},k(N,z)};G(h,N=>{e.onClose&&N(m)})}var y=v(u,2),_=d(y),q=d(_);q.__click=()=>f(i,"general");var g=v(q,2);g.__click=()=>f(i,"filter");var p=v(g,2);p.__click=()=>f(i,"statuses");var w=v(p,2);w.__click=()=>f(i,"shortcuts");var x=v(_,2),S=d(x);{var C=N=>{var z=Xu(),Y=d(z),J=v(d(Y),2),te=d(J),ie=v(Y,2),he=v(d(ie),2),le=v(ie,2),j=v(d(le),2),D=v(le,2);D.__click=c;var F=d(D),Z=v(D,2);{var $=ce=>{var de=Qu(),_e=d(de);H(()=>{Re(de,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),L(_e,n.n8n.message)}),k(ce,de)};G(Z,ce=>{n.n8n&&ce($)})}H(()=>{he.disabled=!r(t).n8n.enabled,j.disabled=!r(t).n8n.enabled,D.disabled=!r(t).n8n.enabled||r(a)==="n8n",L(F,r(a)==="n8n"?"Testing...":"Test Connection")}),Ui(te,()=>r(t).n8n.enabled,ce=>r(t).n8n.enabled=ce),Ve(he,()=>r(t).n8n.webhookUrl,ce=>r(t).n8n.webhookUrl=ce),Ve(j,()=>r(t).n8n.sharedSecret,ce=>r(t).n8n.sharedSecret=ce),k(N,z)},P=N=>{var z=Pe(),Y=qe(z);{var J=ie=>{Ku(ie,{})},te=ie=>{var he=Pe(),le=qe(he);{var j=F=>{Vu(F,{})},D=F=>{var Z=Pe(),$=qe(Z);{var ce=de=>{var _e=$u(),se=v(d(_e),2);Me(se,21,()=>Mu,ut,(ue,U)=>{var V=Zu(),re=d(V),b=d(re),R=d(b),X=v(b,2),ne=d(X),T=v(X,2);{var O=xe=>{var ye=Ju(),Ne=d(ye);H(()=>L(Ne,r(U).context)),k(xe,ye)};G(T,xe=>{r(U).context&&xe(O)})}var oe=v(re,2),ke=d(oe);H(()=>{L(R,r(U).label),L(ne,r(U).description),L(ke,r(U).keys)}),k(ue,V)}),k(de,_e)};G($,de=>{r(i)==="shortcuts"&&de(ce)},!0)}k(F,Z)};G(le,F=>{r(i)==="statuses"?F(j):F(D,!1)},!0)}k(ie,he)};G(Y,ie=>{r(i)==="filter"?ie(J):ie(te,!1)},!0)}k(N,z)};G(S,N=>{r(i)==="general"?N(C):N(P,!1)})}var K=v(y,2);{var M=N=>{var z=ev(),Y=d(z);Y.__click=o,k(N,z)};G(K,N=>{r(i)==="general"&&N(M)})}H(()=>{Re(q,1,`settings__nav-btn ${r(i)==="general"?"active":""}`,"svelte-1ke3hir"),Re(g,1,`settings__nav-btn ${r(i)==="filter"?"active":""}`,"svelte-1ke3hir"),Re(p,1,`settings__nav-btn ${r(i)==="statuses"?"active":""}`,"svelte-1ke3hir"),Re(w,1,`settings__nav-btn ${r(i)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),k(s,l),Ue()}Xe(["click"]);var av=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),nv=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),rv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),iv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ov=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),lv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),cv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),dv=A('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>High Priority</button></div>'),uv=A('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">üì• Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">üìã Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">üìÖ Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">‚úÖ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">üìÅ Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">üîç Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">üìù All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),vv=A('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div></div> <!></div>');function hv(s,e){Ke(e,!0);const t=e.scheduler.getTimezoneHandler(),a=e.scheduler.getRecurrenceEngine();let n=W("today"),i=W(!1),o=W(!1),c=W(void 0),l=W(me(new Set)),u=W(me([])),h=Q(()=>$l(r(u))),m=W(!1);const y=Q(()=>["inbox","today","upcoming","done","projects","search","all"].includes(r(n))?`dashboard-tab-${r(n)}`:void 0),_=Q(()=>()=>{let b=r(u);if(r(l).has("notDone")&&(b=b.filter(R=>R.status!=="done"&&R.status!=="cancelled")),r(l).has("dueToday")){const R=new Date;R.setHours(0,0,0,0);const X=new Date(R);X.setDate(X.getDate()+1),b=b.filter(ne=>{if(!ne.dueAt)return!1;const T=new Date(ne.dueAt);return T>=R&&T<X})}if(r(l).has("overdue")){const R=new Date;R.setHours(0,0,0,0),b=b.filter(X=>!X.dueAt||X.status==="done"||X.status==="cancelled"?!1:new Date(X.dueAt)<R)}return r(l).has("inProgress")&&(b=b.filter(R=>R.status==="todo"&&R.statusSymbol&&R.statusSymbol!==" ")),r(l).has("blocked")&&(b=b.filter(R=>R.blockedBy&&R.blockedBy.length>0)),r(l).has("highPriority")&&(b=b.filter(R=>R.priority==="high"||R.priority==="urgent")),b}),q=Q(()=>r(u).filter(b=>b.status!=="done"&&b.status!=="cancelled"&&!b.dueAt&&!b.scheduledAt&&!b.startAt).length),g=Q(()=>()=>{const b=new Date;b.setHours(0,0,0,0);const R=new Date(b);return R.setDate(R.getDate()+7),r(u).filter(X=>{if(X.status==="done"||X.status==="cancelled"||!X.dueAt)return!1;const ne=new Date(X.dueAt);return ne.setHours(0,0,0,0),ne>b&&ne<=R}).length}),p=Q(()=>()=>{const b=new Date;return b.setDate(b.getDate()-30),b.setHours(0,0,0,0),r(u).filter(R=>R.status!=="done"||!R.doneAt?!1:new Date(R.doneAt)>=b).length}),w=Q(()=>r(u).filter(b=>b.status!=="done"&&b.status!=="cancelled").length);function x(b="initial"){f(m,!0),f(u,e.repository.getAllTasks().map(R=>({...R})),!0),f(m,!1),b!=="initial"&&ee.info("Task list reloaded")}x();const S=()=>x("reload");cn(()=>{window.addEventListener("recurring-task-refresh",S)}),Ll(()=>{window.removeEventListener("recurring-task-refresh",S)});async function C(b){Ge.emit("task: complete",{taskId:b.id})}async function P(b){const R=r(u),X=kn(r(u),b.id,ne=>{const T={...ne},O=new Date(T.dueAt),oe=t.tomorrow();return oe.setHours(O.getHours(),O.getMinutes(),0,0),T.dueAt=oe.toISOString(),T.snoozeCount=(T.snoozeCount||0)+1,T.updatedAt=new Date().toISOString(),T});f(u,X,!0),ee.info(`Task "${b.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",b),await e.scheduler.delayToTomorrow(b.id)}catch(ne){f(u,R,!0),ee.error("Failed to delay task:  "+ne),x("external")}}async function K(b){var X;if(!((X=b.name)!=null&&X.trim())){ee.error("Task name is required");return}if(!Hi(b.frequency)){ee.error("Invalid frequency configuration");return}const R={...b};f(u,yn(r(u),R),!0),f(i,!1),f(c,void 0),ee.success(`Task "${b.name}" saved successfully`),e.repository.saveTask(R).catch(ne=>{ee.error("Failed to save task: "+ne),x("external")})}async function M(b){const R=r(u);f(u,Mr(r(u),b.id),!0);const X=window.setTimeout(async()=>{try{await e.repository.deleteTask(b.id)}catch(ne){f(u,R,!0),ee.error("Failed to delete task: "+ne),x("external")}},5e3);Fs({message:`Task "${b.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(X),f(u,R,!0),ee.info(`Restored "${b.name}"`)},showCountdown:!0})}async function N(b){const R=b.name.endsWith(" (copy)")?`${b.name} ${new Date().toLocaleDateString()}`:`${b.name} (copy)`,X=Ql(b,{name:R});f(u,yn(r(u),X),!0),ee.success(`Duplicated "${b.name}"`),e.repository.saveTask(X).catch(ne=>{f(u,Mr(r(u),X.id),!0),ee.error("Failed to duplicate task: "+ne),x("external")})}async function z(b){const R=!b.enabled,X={...b,enabled:R},ne=kn(r(u),b.id,()=>X);f(u,ne,!0),ee.info(`Task ${R?"enabled":"disabled"}`),e.repository.saveTask(X).catch(T=>{ee.error("Failed to update task: "+T),x("external")})}async function Y(b,R){if(b.length===0)return;const X=r(u),ne=new Set(b),T=r(u).map(O=>ne.has(O.id)?{...O,enabled:R}:O);f(u,T,!0),ee.info(`${R?"Enabled":"Disabled"} ${b.length} task${b.length===1?"":"s"}`);try{const O=T.filter(oe=>ne.has(oe.id));await Promise.all(O.map(oe=>e.repository.saveTask(oe)))}catch(O){f(u,X,!0),ee.error(`Failed to ${R?"enable":"disable"} tasks: ${O}`),x("external")}}async function J(b){if(b.length===0)return;const R=r(u),X=new Set(b),ne=r(u).filter(O=>X.has(O.id));f(u,r(u).filter(O=>!X.has(O.id)),!0);const T=window.setTimeout(async()=>{try{await Promise.all(ne.map(O=>e.repository.deleteTask(O.id)))}catch(O){f(u,R,!0),ee.error("Failed to delete tasks: "+O),x("external")}},5e3);Fs({message:`${ne.length} task${ne.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(T),f(u,R,!0),ee.info("Bulk delete undone")},showCountdown:!0})}function te(b){f(c,b,!0),f(i,!0)}function ie(){f(c,void 0),f(i,!0)}function he(){f(i,!1),f(c,void 0)}function le(){f(o,!0)}function j(){f(o,!1)}async function D(b){const R=r(u),X=kn(r(u),b.id,ne=>{const T={...ne};Vi(T);const O=a.calculateNext(new Date(T.dueAt),T.frequency);return T.dueAt=O.toISOString(),T});f(u,X,!0),ee.info(`Task "${b.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",b),await e.scheduler.skipTaskOccurrence(b.id)}catch(ne){f(u,R,!0),ee.error("Failed to skip task: "+ne),x("external")}}function F(b){const R=new Set(r(l));R.has(b)?R.delete(b):R.add(b),f(l,R,!0)}async function Z(b){const R={...b,status:"todo",doneAt:void 0};f(u,yn(r(u),R),!0),ee.success(`Task "${b.name}" marked as not done`),e.repository.saveTask(R).catch(X=>{ee.error("Failed to update task: "+X),x("external")})}var $=vv(),ce=d($),de=v(d(ce),2),_e=d(de);_e.__click=()=>x("reload");var se=d(_e),ue=v(_e,2);ue.__click=le;var U=v(ce,2);{var V=b=>{var R=av(),X=d(R);sv(X,{get eventService(){return e.eventService},onClose:j}),k(b,R)},re=b=>{var R=Pe(),X=qe(R);{var ne=O=>{var oe=nv(),ke=d(oe);Zi(ke,{get task(){return r(c)},get repository(){return e.repository},onSave:K,onClose:he}),k(O,oe)},T=O=>{var oe=uv(),ke=qe(oe),xe=d(ke);xe.__click=()=>f(n,"inbox");var ye=v(d(xe));{var Ne=ge=>{var Ie=rv(),je=d(Ie);H(()=>L(je,r(q))),k(ge,Ie)};G(ye,ge=>{r(q)>0&&ge(Ne)})}var Fe=v(xe,2);Fe.__click=()=>f(n,"today");var ft=v(d(Fe));{var qt=ge=>{var Ie=iv(),je=d(Ie);H(()=>L(je,r(h).length)),k(ge,Ie)};G(ft,ge=>{r(h).length>0&&ge(qt)})}var Je=v(Fe,2);Je.__click=()=>f(n,"upcoming");var Qt=v(d(Je));{var Ze=ge=>{var Ie=ov(),je=d(Ie);H(()=>L(je,r(g))),k(ge,Ie)};G(Qt,ge=>{r(g)>0&&ge(Ze)})}var Oe=v(Je,2);Oe.__click=()=>f(n,"done");var Dt=v(d(Oe));{var ze=ge=>{var Ie=lv(),je=d(Ie);H(()=>L(je,r(p))),k(ge,Ie)};G(Dt,ge=>{r(p)>0&&ge(ze)})}var $e=v(Oe,2);$e.__click=()=>f(n,"projects");var ns=v(d($e));{var Xt=ge=>{var Ie=cv(),je=d(Ie);H(()=>L(je,r(w))),k(ge,Ie)};G(ns,ge=>{r(w)>0&&ge(Xt)})}var Lt=v($e,2);Lt.__click=()=>f(n,"search");var jt=v(Lt,2);jt.__click=()=>f(n,"all");var ae=v(d(jt)),pe=d(ae),Ae=v(ke,2);{var Le=ge=>{var Ie=dv(),je=v(d(Ie),2);je.__click=()=>F("notDone");var Be=v(je,2);Be.__click=()=>F("dueToday");var tt=v(Be,2);tt.__click=()=>F("overdue");var st=v(tt,2);st.__click=()=>F("inProgress");var _t=v(st,2);_t.__click=()=>F("blocked");var Ut=v(_t,2);Ut.__click=()=>F("highPriority"),H((pt,Ot,gt,Ht,gs,At)=>{Re(je,1,`dashboard__filter-btn ${pt??""}`,"svelte-1y1a8hs"),Re(Be,1,`dashboard__filter-btn ${Ot??""}`,"svelte-1y1a8hs"),Re(tt,1,`dashboard__filter-btn ${gt??""}`,"svelte-1y1a8hs"),Re(st,1,`dashboard__filter-btn ${Ht??""}`,"svelte-1y1a8hs"),Re(_t,1,`dashboard__filter-btn ${gs??""}`,"svelte-1y1a8hs"),Re(Ut,1,`dashboard__filter-btn ${At??""}`,"svelte-1y1a8hs")},[()=>r(l).has("notDone")?"active":"",()=>r(l).has("dueToday")?"active":"",()=>r(l).has("overdue")?"active":"",()=>r(l).has("inProgress")?"active":"",()=>r(l).has("blocked")?"active":"",()=>r(l).has("highPriority")?"active":""]),k(ge,Ie)};G(Ae,ge=>{r(n)!=="search"&&r(n)!=="timeline"&&r(n)!=="analytics"&&ge(Le)})}var ct=v(Ae,2),et=d(ct);{var Kt=ge=>{{let Ie=Q(()=>r(l).size>0?r(_):r(u));nd(ge,{get tasks(){return r(Ie)},onEdit:te,onDone:C,onDelete:M})}},Et=ge=>{var Ie=Pe(),je=qe(Ie);{var Be=st=>{{let _t=Q(()=>r(l).size>0?r(_).filter(Ut=>r(h).some(pt=>pt.id===Ut.id)):r(h));Dc(st,{get tasks(){return r(_t)},onDone:C,onDelay:P,onSkip:D,onEdit:te,get timezoneHandler(){return t}})}},tt=st=>{var _t=Pe(),Ut=qe(_t);{var pt=gt=>{{let Ht=Q(()=>r(l).size>0?r(_):r(u));cd(gt,{get tasks(){return r(Ht)},onEdit:te,onDone:C,onDelete:M})}},Ot=gt=>{var Ht=Pe(),gs=qe(Ht);{var At=fe=>{{let Ye=Q(()=>r(l).size>0?r(_):r(u));pd(fe,{get tasks(){return r(Ye)},onEdit:te,onDelete:M,onUncomplete:Z})}},B=fe=>{var Ye=Pe(),Cs=qe(Ye);{var wa=Zs=>{{let za=Q(()=>r(l).size>0?r(_):r(u));wd(Zs,{get tasks(){return r(za)},onEdit:te,onDone:C,onDelete:M})}},to=Zs=>{var za=Pe(),so=qe(za);{var ao=$s=>{iu($s,{get tasks(){return r(u)},onEdit:te,onDone:C,onDelete:M})},no=$s=>{var sr=Pe(),ro=qe(sr);{var io=ea=>{{let La=Q(()=>r(l).size>0?r(_):r(u));Nc(ea,{get tasks(){return r(La)},onEdit:te,onDelete:M,onDuplicate:N,onToggleEnabled:z,onBulkEnable:Sa=>Y(Sa,!0),onBulkDisable:Sa=>Y(Sa,!1),onBulkDelete:J,onCreate:ie})}},oo=ea=>{var La=Pe(),Sa=qe(La);{var lo=ta=>{Uc(ta,{get tasks(){return r(u)},get recurrenceEngine(){return a}})},co=ta=>{var ar=Pe(),uo=qe(ar);{var vo=un=>{ed(un,{get tasks(){return r(u)}})};G(uo,un=>{r(n)==="analytics"&&un(vo)},!0)}k(ta,ar)};G(Sa,ta=>{r(n)==="timeline"?ta(lo):ta(co,!1)},!0)}k(ea,La)};G(ro,ea=>{r(n)==="all"?ea(io):ea(oo,!1)},!0)}k($s,sr)};G(so,$s=>{r(n)==="search"?$s(ao):$s(no,!1)},!0)}k(Zs,za)};G(Cs,Zs=>{r(n)==="projects"?Zs(wa):Zs(to,!1)},!0)}k(fe,Ye)};G(gs,fe=>{r(n)==="done"?fe(At):fe(B,!1)},!0)}k(gt,Ht)};G(Ut,gt=>{r(n)==="upcoming"?gt(pt):gt(Ot,!1)},!0)}k(st,_t)};G(je,st=>{r(n)==="today"?st(Be):st(tt,!1)},!0)}k(ge,Ie)};G(et,ge=>{r(n)==="inbox"?ge(Kt):ge(Et,!1)})}H(()=>{Re(xe,1,`dashboard__tab ${r(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),De(xe,"aria-selected",r(n)==="inbox"),Re(Fe,1,`dashboard__tab ${r(n)==="today"?"active":""}`,"svelte-1y1a8hs"),De(Fe,"aria-selected",r(n)==="today"),Re(Je,1,`dashboard__tab ${r(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),De(Je,"aria-selected",r(n)==="upcoming"),Re(Oe,1,`dashboard__tab ${r(n)==="done"?"active":""}`,"svelte-1y1a8hs"),De(Oe,"aria-selected",r(n)==="done"),Re($e,1,`dashboard__tab ${r(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),De($e,"aria-selected",r(n)==="projects"),Re(Lt,1,`dashboard__tab ${r(n)==="search"?"active":""}`,"svelte-1y1a8hs"),De(Lt,"aria-selected",r(n)==="search"),Re(jt,1,`dashboard__tab ${r(n)==="all"?"active":""}`,"svelte-1y1a8hs"),De(jt,"aria-selected",r(n)==="all"),L(pe,r(u).length),De(ct,"aria-labelledby",r(y))}),k(O,oe)};G(X,O=>{r(i)?O(ne):O(T,!1)},!0)}k(b,R)};G(U,b=>{r(o)?b(V):b(re,!1)})}H(()=>{_e.disabled=r(m),L(se,r(m)?"‚ü≥":"‚Üª")}),k(s,$),Ue()}Xe(["click"]);var fv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),_v=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),pv=A('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),gv=A('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),mv=A('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function yv(s,e){var j;Ke(e,!0);let t=W(me(((j=e.prefill)==null?void 0:j.suggestedName)??"")),a=W(me(new Date().toISOString().slice(0,16))),n=W(me({name:!1,dueAt:!1})),i=W(!1),o=W(null);const c=Q(()=>r(n).name&&!r(t).trim()?"Task name is required.":""),l=Q(()=>r(n).dueAt?r(a)?Number.isNaN(new Date(r(a)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=Q(()=>!!(r(c)||r(l)));cn(()=>{var D;if((D=e.prefill)!=null&&D.suggestedTime){const F=new Date,[Z,$]=e.prefill.suggestedTime.split(":").map(Number);F.setHours(Z,$,0,0),f(a,F.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var F;(F=r(o))==null||F.focus()})});async function h(){var $,ce;if(f(n,{name:!0,dueAt:!0},!0),r(u)){ee.warning("Please fill out the required fields.");return}const D=Kl(),F=r(a).slice(11,16);if(D.time=F,!Hi(D)){ee.error("Invalid frequency configuration.");return}const Z=Gi(r(t).trim(),D,new Date(r(a)));Z.linkedBlockId=(($=e.prefill)==null?void 0:$.linkedBlockId)||void 0,Z.linkedBlockContent=((ce=e.prefill)==null?void 0:ce.linkedBlockContent)||void 0,f(i,!0);try{await e.repository.saveTask(Z),ee.success(`Task "${Z.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(de){ee.error("Failed to create task: "+de)}finally{f(i,!1)}}function m(D){D.key==="Escape"&&e.onClose(),(D.metaKey||D.ctrlKey)&&D.key==="Enter"&&(D.preventDefault(),h())}var y=mv();y.__keydown=m;var _=d(y),q=d(_),g=v(d(q),2);g.__click=function(...D){var F;(F=e.onClose)==null||F.apply(this,D)};var p=v(q,2),w=v(d(p),2);w.__input=()=>r(n).name=!0,Wt(w,D=>f(o,D),()=>r(o));var x=v(w,2);{var S=D=>{var F=fv(),Z=d(F);H(()=>L(Z,r(c))),k(D,F)};G(x,D=>{r(c)&&D(S)})}var C=v(p,2),P=v(d(C),2);P.__input=()=>r(n).dueAt=!0;var K=v(P,2);{var M=D=>{var F=_v(),Z=d(F);H(()=>L(Z,r(l))),k(D,F)};G(K,D=>{r(l)&&D(M)})}var N=v(C,2);{var z=D=>{var F=pv(),Z=v(d(F)),$=d(Z);H(()=>L($,e.prefill.linkedBlockId)),k(D,F)};G(N,D=>{var F;(F=e.prefill)!=null&&F.linkedBlockId&&D(z)})}var Y=v(N,2),J=d(Y);J.__click=function(...D){var F;(F=e.onClose)==null||F.apply(this,D)};var te=v(J,2);{var ie=D=>{var F=gv();F.__click=function(...Z){var $;($=e.onAdvanced)==null||$.apply(this,Z)},k(D,F)};G(te,D=>{e.onAdvanced&&D(ie)})}var he=v(te,2);he.__click=h;var le=d(he);H(()=>{De(w,"aria-invalid",!!r(c)),De(P,"aria-invalid",!!r(l)),he.disabled=r(i),L(le,r(i)?"Saving‚Ä¶":"Create Task")}),it("blur",w,()=>r(n).name=!0),Ve(w,()=>r(t),D=>f(t,D)),it("blur",P,()=>r(n).dueAt=!0),Ve(P,()=>r(a),D=>f(a,D)),k(s,y),Ue()}Xe(["keydown","click","input"]);class kv{constructor(e){E(this,"plugin");this.plugin=e}getCurrentVersion(){return ys}async createBackup(e,t){try{const a=await this.plugin.loadData(e);if(a){const n=new Date().toISOString().replace(/[:.]/g,"-"),i=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${i}-${n}`;return await this.plugin.saveData(o,a),ve(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(a){throw Se("Failed to create backup",a),a}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return ve("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:ys};const a=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(a.length===0)return ve("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:ys};let n=!1,i,o,c=0;for(let l=0;l<a.length;l++){const u=a[l],h=u.version||0;h<ys&&(n||(o=h,i=await this.createBackup(e,h),n=!0),a[l]=this.migrateTask(u,h),c++,ve(`Migrated task ${u.id} from v${h} to v${ys}`))}if(n){const l=Array.isArray(t)?a:{...t,tasks:a};return await this.plugin.saveData(e,l),ve(`Migration complete: ${c} tasks migrated`),{migrated:!0,tasksAffected:c,fromVersion:o,toVersion:ys,backupKey:i}}else return ve("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:ys}}catch(t){throw Se("Migration failed",t),t}}migrateTask(e,t){let a={...e};return t<1&&(a.version=1),t<2&&(a={...a,version:2,timezone:a.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:a.completionCount||0,missCount:a.missCount||0,currentStreak:a.currentStreak||0,bestStreak:a.bestStreak||0,recentCompletions:a.recentCompletions||[],priority:a.priority||"normal",tags:a.tags||[],notificationChannels:a.notificationChannels||[],snoozeCount:a.snoozeCount||0,maxSnoozes:a.maxSnoozes||3}),t<3&&(a={...a,version:3,escalationPolicy:a.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:a.linkedBlockContent||void 0,category:a.category||void 0,description:a.description||void 0}),t<4&&(a={...a,version:4,onCompletion:a.onCompletion||"keep",dependsOn:a.dependsOn||[],blockedBy:a.blockedBy||[]}),a}}class bv{constructor(e,t=50){E(this,"pendingState",null);E(this,"writeInProgress",!1);E(this,"scheduledTimer",null);E(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){Se("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return Se("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const zn={},wv=Object.freeze(Object.defineProperty({__proto__:null,default:zn},Symbol.toStringTag,{value:"Module"})),Pr=new Set;function Va(s){const e=`${s.feature}:${s.capability}:${s.message}`;Pr.has(e)||(Pr.add(e),vt(s.message,{feature:s.feature,capability:s.capability,cause:s.cause}))}class $i extends Error{constructor(t,a,n){super(n);E(this,"capability");E(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=a}}class eo extends Error{constructor(t,a,n,i){super(n);E(this,"capability");E(this,"feature");E(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=a,this.cause=i}}class Sv{constructor(e=globalThis){E(this,"supportedCapabilities");E(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,a,n;return typeof((n=(a=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:a.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,a;return this.isDataDirAvailable()?((a=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:a.dataDir)??null:null}async setBlockAttrs(e,t){const a=this.getSetBlockAttrs();try{await a(e,t)}catch(n){throw new eo("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new $i("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Tv=".tmp";class Dv{constructor(e,t){E(this,"plugin");E(this,"apiAdapter");E(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(Rs);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){Se("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),ve(`Saved ${e.tasks.length} active tasks`)}catch(t){throw Se("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(Rs,e);return}const a=this.resolveStoragePath(Rs);if(!a){await this.plugin.saveData(Rs,e);return}const n=zn.dirname(a);await t.mkdir(n,{recursive:!0});const i=`${a}${Tv}`,o=JSON.stringify(e),c=await t.open(i,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(i,a)}catch{await t.rm(a,{force:!0}),await t.rename(i,a)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>wv);return this.fsPromises=e.promises,this.fsPromises}catch(e){return vt("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),a=this.plugin.name;return!t||!a?(t||Va({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):zn.join(t,"storage",`p${a}`,`${e}.json`)}}const zr=1,Lr=1e3;class Ev{constructor(e){E(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),a=this.groupByYear(e);for(const[n,i]of a.entries())await this.appendTasksToYear(t,n,i);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const a=this.filterChunks(t.chunks,e),n=[];for(const c of a){const l=await this.loadChunk(c.key);if(l)for(const u of l.tasks)this.matchesQuery(u,e)&&n.push(u)}const i=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(i,i+o)}async loadIndex(){try{const e=await this.plugin.loadData(Ga);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??zr,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){Se("Failed to load archive index",e)}return{version:zr,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Ga,e)}catch(t){throw Se("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Ga}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){Se("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(a){throw Se("Failed to save archive chunk",{key:e,err:a}),a}}groupByYear(e){const t=new Map;for(const a of e){const n=this.getCompletionTimestamp(a),i=new Date(n).getFullYear(),o=t.get(i);o?o.push(a):t.set(i,[a])}return t}async appendTasksToYear(e,t,a){let n=[...a];for(;n.length>0;){const i=this.findOrCreateChunk(e,t),o=await this.loadChunk(i.key)||{tasks:[]},c=Lr-o.tasks.length,l=n.slice(0,c);o.tasks.push(...l),n=n.slice(l.length);const u=this.updateChunkMeta(i,l);i.count=u.count,i.start=u.start,i.end=u.end,await this.saveChunk(i.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(n&&n.count<Lr)return n;const i=n?n.sequence+1:1,o={key:this.buildChunkKey(t,i),year:t,sequence:i,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let a=e.start,n=e.end;for(const i of t){const o=this.getCompletionTimestamp(i);(!a||o<a)&&(a=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:a,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const a=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(i=>{const o=i.start?new Date(i.start).getTime():null,c=i.end?new Date(i.end).getTime():null;return!(a&&c&&c<a||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const a=this.getCompletionTimestamp(e),n=new Date(a).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Av{constructor(e,t=new Sv){E(this,"plugin");E(this,"activeTasks");E(this,"blockIndex",new Map);E(this,"taskBlockIndex",new Map);E(this,"dueIndex",new Map);E(this,"activeStore");E(this,"archiveStore");E(this,"persistence");E(this,"blockAttrSyncEnabled",!0);E(this,"blockApi");E(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Dv(e,t),this.archiveStore=new Ev(e),this.persistence=new bv(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),ve(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}async loadActiveTasks(e=1e3,t){const a=await this.activeStore.loadActive(),n=Array.from(a.values()),i=n.length;if(i===0)return[];const o=[];for(let c=0;c<i;c+=e){const l=n.slice(c,Math.min(c+e,i));o.push(...l),t&&t(o.length,i),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));ve(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);ve(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),a=this.dueIndex.get(t);a&&(a.delete(e.id),a.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),a=[];for(const[n]of this.dueIndex)n<=t&&a.push(...this.getTasksForDueKey(n));return a}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const a=[];for(const n of t){const i=this.activeTasks.get(n);if(!i){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!i.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(i.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}a.push(i)}return a}removeStaleDueIndexEntry(e,t,a){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),vt("Removed stale due index entry",{taskId:t,dateKey:e,reason:a}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),a=this.taskBlockIndex.get(e.id);a&&a!==e.linkedBlockId&&(this.blockIndex.delete(a),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),a&&a!==e.linkedBlockId&&await this.clearBlockAttrs(a)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Ir]:e.id,[qr]:e.dueAt,[Or]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Ir]:"",[qr]:"",[Or]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Va({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(a){a instanceof $i||a instanceof eo?Va({feature:a.feature,capability:a.capability,message:a.message,cause:a.cause}):Va({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:a}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(a=>new Date(a.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(a=>{const n=new Date(a.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(Rs);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(yr);if(!t)return;const a=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(a.length===0)return;await this.plugin.saveData(kr,t),ve(`Created legacy backup at ${kr}`);const n=a.filter(c=>!c.enabled&&c.lastCompletedAt),i=a.filter(c=>!n.includes(c)),o=new Map(i.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),ve("Legacy storage migration complete",{activeCount:i.length,archivedCount:n.length,legacyKey:yr,activeKey:Rs,archiveIndexKey:Ga})}}class xv{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}class Cv{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const a of e)Number.isFinite(a)&&a>=0&&a<=6&&t.add(Math.floor(a));return Array.from(t).sort((a,n)=>a-n)}normalizeDayOfMonth(e,t){const a=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(a,1),31)}normalizeMonth(e,t){const a=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(a,0),11)}calculateNext(e,t,a){const i=((a==null?void 0:a.whenDone)??t.whenDone??!1)&&(a!=null&&a.completionDate)?a.completionDate:e,{type:o,time:c}=t,l=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(i,l);break;case"weekly":u=this.calculateNextWeekly(i,l,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(i,l,this.normalizeDayOfMonth(t.dayOfMonth,i.getDate()));break;case"yearly":u=this.calculateNextYearly(i,l,this.normalizeMonth(t.month,i.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,i.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(c){const{hours:h,minutes:m}=Xi(c);if(Number.isFinite(h)&&Number.isFinite(m)){const{date:y,shifted:_}=oc(u,h,m);_&&vt("DST shift detected while applying recurrence time",{requestedTime:c,original:u.toISOString(),adjusted:y.toISOString()}),u=y}}return u}calculateNextDaily(e,t){return Ma(e,t)}calculateNextWeekly(e,t,a){if(!a||a.length===0)return Nr(e,t);const n=this.getMondayIndex(e),i=Math.min(mn,t*14);for(let o=1;o<=i;o++){if(Math.floor((n+o)/7)%t!==0)continue;const l=Ma(e,o),u=this.getMondayIndex(l);if(a.includes(u))return l}return vt("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:a}),Nr(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,a){const n=a??e.getDate(),i=e.getFullYear(),c=e.getMonth()+t,l=i+Math.floor(c/12),u=(c%12+12)%12,h=new Date(l,u+1,0).getDate(),m=Math.min(n,h),y=new Date(e);return y.setFullYear(l,u,m),y}calculateNextYearly(e,t,a,n){const i=n??e.getDate(),o=e.getFullYear()+t,c=new Date(o,a+1,0).getDate(),l=Math.min(i,c),u=new Date(e);return u.setFullYear(o,a,l),u}getOccurrencesInRange(e,t,a,n){const i=[];let o=new Date(n),c=0;for(;o<=t&&c<mn;)o>=e&&i.push(new Date(o)),o=this.calculateNext(o,a),c++;return i}getMissedOccurrences(e,t,a,n){const i=[];let o=new Date(n),c=0;for(;o<=e&&c<mn;)o=this.calculateNext(o,a),c++;let l=0;for(;o<t&&l<Ya;)i.push(new Date(o)),o=this.calculateNext(o,a),l++;return l>=Ya&&vt("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:a,firstOccurrence:n.toISOString(),cap:Ya}),i}}class Iv{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:a,minutes:n}=Xi(t);if(!Number.isFinite(a)||!Number.isFinite(n))return new Date(e);const i=new Date(e);return i.setHours(a,n,0,0),i}isSameLocalDay(e,t){const a=new Date(e),n=new Date(t);return a.getFullYear()===n.getFullYear()&&a.getMonth()===n.getMonth()&&a.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,a=e.getTime()-t.getTime(),n=Math.trunc(a/(1e3*60)),i=Math.trunc(a/(1e3*60*60)),o=Math.trunc(a/(1e3*60*60*24));return Math.abs(a)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(i)<24?i>0?`in ${i}h`:`${-i}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const a=new Date(e);return a.setDate(a.getDate()+t),a}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class qv{constructor(e){E(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return ve(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return vt(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return vt("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),ve(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return vt("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(a){return Se("Failed to execute onCompletion action",{taskId:e.id,action:t,error:a}),{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return vt("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return Se("Failed to check for nested items",{blockId:e,error:t}),!0}}}class Ov{constructor(e,t){E(this,"intervalMs");E(this,"timeoutId",null);E(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:er,a=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},a)}}class Mv{constructor(e,t=er,a){E(this,"storage");E(this,"recurrenceEngine");E(this,"onCompletionHandler");E(this,"emittedDue",new Set);E(this,"emittedMissed",new Set);E(this,"timezoneHandler");E(this,"isChecking",!1);E(this,"lastCheckStartTime",0);E(this,"plugin",null);E(this,"listeners",{"task:due":new Set,"task:overdue":new Set});E(this,"MAX_EMITTED_ENTRIES",1e3);E(this,"EMITTED_RETENTION_DAYS",30);E(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);E(this,"persistTimeoutId",null);E(this,"emittedStateReady",null);E(this,"timer");this.storage=e,this.recurrenceEngine=new Cv,this.onCompletionHandler=new qv(a),this.timezoneHandler=new Iv,this.plugin=a||null,this.timer=new Ov(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),ve("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),ve("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)vt("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const a of t){if(!this.isActive(a))continue;const n=new Date(a.dueAt),i=n<=e;if(i){const c=this.buildOccurrenceKey(a.id,n,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:a.id,dueAt:n,context:"today",task:a}),this.registerEmittedKey("due",c),ve(`Task due: ${a.name}`,{taskId:a.id,dueAt:a.dueAt}))}const o=a.lastCompletedAt?new Date(a.lastCompletedAt):null;if(i&&e.getTime()-n.getTime()>=Yl&&(!o||o<n)){const c=this.buildOccurrenceKey(a.id,n,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:a.id,dueAt:n,context:"overdue",task:a}),this.registerEmittedKey("missed",c),vt(`Task missed: ${a.name}`,{taskId:a.id,dueAt:a.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),a=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=a.set,(t.didTrim||a.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,a){const n=a.getTime(),i=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=i.filter(({time:u})=>u===null||u>=n),c=o.length!==i.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),c=!0);const l=new Set(o.map(({entry:u})=>u));return c&&ve(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${l.size}`),{set:l,didTrim:c}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const a=e.slice(t+1);if(!a)return null;const n=a.length===13?`${a}:00:00.000Z`:a,i=new Date(n);return Number.isNaN(i.getTime())?null:i.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const a=new Date;t.doneAt=a.toISOString(),Xl(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const i=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,i);if(o.success||Se(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:i,error:o.error}),o.warnings)for(const u of o.warnings)vt(u,{taskId:t.id});const c=new Date(t.dueAt),l=this.recurrenceEngine.calculateNext(c,t.frequency,{completionDate:a,whenDone:t.whenDone});t.dueAt=l.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),ve(`Task "${t.name}" completed and rescheduled to ${l.toISOString()}`)}async delayTask(e,t){const a=this.storage.getTask(e);if(!a)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(a);const n=new Date(a.dueAt),i=new Date(n.getTime()+t*60*1e3);a.dueAt=i.toISOString(),a.snoozeCount=(a.snoozeCount||0)+1,await this.storage.saveTask(a),ve(`Task "${a.name}" delayed by ${t} minutes to ${i.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const a=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(a.getHours(),a.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),ve(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Vi(t);const a=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(a,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),ve(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),ve("First run detected, no recovery needed");return}ve(`Recovering missed tasks since ${e.toISOString()}`);for(const a of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,a.frequency,new Date(a.createdAt));for(const i of n){const o=this.buildOccurrenceKey(a.id,i,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:a.id,dueAt:i,context:"overdue",task:a}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(a,t)}catch(n){Se(`Failed to recover task ${a.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),ve("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const a=new Date(e.dueAt);if(a>=t)return;let n=a,i=0;for(;n<t&&i<Ya;)n=this.recurrenceEngine.calculateNext(n,e.frequency),i++;n>a&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),ve(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Cr);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){Se("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Cr,{timestamp:e.toISOString()})}catch(t){Se("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const a=this.listeners[e];for(const n of a)try{const i=n(t);i instanceof Promise&&i.catch(o=>{Se(`Scheduler listener error for ${e}:`,o)})}catch(i){Se(`Scheduler listener error for ${e}:`,i)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Vl,a=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(a>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Sr),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],a=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(a.slice(-this.MAX_EMITTED_ENTRIES)),ve("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){Se("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Sr,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){Se("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,a){return a==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const Nv=7,Rv=2e3;class Fv{constructor(e,t){E(this,"plugin");E(this,"storageKey");E(this,"notifications",new Map);E(this,"escalations",new Map);E(this,"lastCleanup",new Date);E(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const a of t.notifications)this.notifications.set(a.taskKey,a);if(Array.isArray(t.escalations))for(const a of t.escalations)this.escalations.set(a.taskId,a);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),ve(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){Se("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Qi("Saved notification state")}catch(e){Se("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>Rv&&Array.from(this.notifications.keys()).slice(0,100).forEach(a=>this.notifications.delete(a))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const a=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:a,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,a}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const a=new Date(t);return`${e}:${a.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const a=new Date(e.getTime()-Nv*24*60*60*1e3);let n=0;for(const[i,o]of this.notifications.entries())new Date(o.notifiedAt)<a&&(this.notifications.delete(i),n++);n>0&&(ve(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function Bv(s){return{id:s.id,name:s.name,dueAt:s.dueAt,frequency:s.frequency,linkedBlockId:s.linkedBlockId,linkedBlockContent:s.linkedBlockContent,priority:s.priority,tags:s.tags,notificationChannels:s.notificationChannels,completionCount:s.completionCount,missCount:s.missCount,currentStreak:s.currentStreak,bestStreak:s.bestStreak}}const Pv=30*1e3,zv=30*60*1e3,qs=500;class Lv{constructor(e,t={}){E(this,"plugin");E(this,"config");E(this,"queue",[]);E(this,"dedupeKeys",new Set);E(this,"flushIntervalId",null);E(this,"fetcher");E(this,"notificationState");E(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...Nn},this.notificationState=t.notificationState??new Fv(this.plugin,Ul)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(br);e&&(this.config={...Nn,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(br,e)}async loadQueue(){try{const e=await this.plugin.loadData(wr);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>qs){const a=this.queue.length-qs;this.queue=this.queue.slice(-qs),console.warn(`Event queue trimmed to ${qs} entries (dropped ${a}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-gn);await this.plugin.saveData(wr,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Gl))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const a=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,a),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const a=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,a),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,a=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const i=this.buildPayload(e,t,n,1,a);await this.sendPayload(i)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(i)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:Tr,version:Dr,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return a.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${a.status}: ${a.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const a=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){a.push(n);continue}const i={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(i))this.markDelivered(i.delivery.dedupeKey),t=!0;else{const c=n.attempt+1,l=this.getRetryDelay(c);a.push({...n,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=a,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,a,n,i=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:Tr,version:Dr,occurredAt:o.toISOString(),task:Bv(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:i,channels:t.notificationChannels||[]},delivery:{dedupeKey:a,attempt:n}}}buildDedupeKey(e,t){const a=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${a}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>gn){const t=Array.from(this.dedupeKeys).slice(-gn);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=qs){const a=this.queue.length-qs+1;this.queue.splice(0,a),console.warn(`Event queue capped at ${qs}. Dropped ${a} oldest entr${a===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=Pv*Math.pow(2,e-1);return Math.min(t,zv)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const a=new TextEncoder,n=a.encode(t),i=a.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,i);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(a){return console.error("Failed to generate signature:",a),""}}async buildHeaders(e){const t=JSON.stringify(e),a=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+a,this.config.n8n.sharedSecret));const i={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":a};return n&&(i["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(i["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),i}async sendPayload(e,t=!1){try{const a=JSON.stringify(e),n=await this.buildHeaders(e),i=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:a});if(!i.ok)return console.error("n8n webhook failed:",i.statusText),!1;if(t){const o=await i.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(a){return console.error("Failed to send n8n event:",a),!1}}}const na={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:{enabled:!1,mode:"include",tagPattern:void 0,pathPattern:void 0,regex:void 0}};function jr(s){return{dates:{...na.dates,...s.dates},recurrence:{...na.recurrence,...s.recurrence},dependencies:{...na.dependencies,...s.dependencies},filenameDate:{...na.filenameDate,...s.filenameDate},globalFilter:{...na.globalFilter,...s.globalFilter}}}const bn="plugin-settings";class jv{constructor(e){E(this,"plugin");E(this,"settings");this.plugin=e,this.settings=na}async load(){try{const e=await this.plugin.loadData(bn);e&&typeof e=="object"&&(this.settings=jr(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(bn,e)}get(){return this.settings}async update(e){this.settings=jr(e),await this.plugin.saveData(bn,this.settings)}}const ks=class ks{constructor(e){E(this,"plugin");E(this,"isInitialized",!1);E(this,"storage");E(this,"repository");E(this,"scheduler");E(this,"eventService");E(this,"settingsService");this.plugin=e}static getInstance(e){if(!ks.instance){if(!e)return null;ks.instance=new ks(e)}return ks.instance}async initialize(){if(this.isInitialized){vt("TaskManager already initialized");return}ve("Initializing TaskManager"),this.settingsService=new jv(this.plugin),await this.settingsService.load(),this.storage=new Av(this.plugin),await this.storage.init(),this.repository=new xv(this.storage),this.eventService=new Lv(this.plugin),await this.eventService.init(),this.scheduler=new Mv(this.storage,er,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,ve("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:a})=>e(a)),t&&this.scheduler.on("task:overdue",({task:a})=>t(a)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),ve("TaskManager started")}async destroy(){ve("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,ks.instance=null,ve("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};E(ks,"instance",null);let Za=ks;class Kv{constructor(e,t,a){this.repository=e,this.recurrenceEngine=t,this.getSettings=a}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,a;try{const n=this.repository.getTask(e);if(!n){ee.error("Task not found");return}const i=as.getInstance(),o=n.statusSymbol||" ",c=i.getNextSymbol(o),l={...n,statusSymbol:c},u=i.getStatus(c);u.type==="DONE"?(l.status="done",(t=this.settings)!=null&&t.dates.autoAddDone&&!l.doneAt&&(l.doneAt=new Date().toISOString()),n.frequency&&this.recurrenceEngine&&await this.handleRecurrence(l)):u.type==="CANCELLED"?(l.status="cancelled",(a=this.settings)!=null&&a.dates.autoAddCancelled&&!l.cancelledAt&&(l.cancelledAt=new Date().toISOString())):u.type==="TODO"&&(l.status="todo"),await this.repository.saveTask(l),Ge.emit("task:updated",{taskId:e}),ee.success(`Task status updated to ${u.name}`)}catch(n){Se("Failed to toggle task status",n),ee.error("Failed to toggle status")}}async completeTask(e){var t;try{const a=this.repository.getTask(e);if(!a){ee.error("Task not found");return}const n={...a,status:"done"};(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),a.frequency&&this.recurrenceEngine&&await this.handleRecurrence(n),Ge.emit("task:complete",{taskId:e}),ee.success(`Task "${a.name}" completed`)}catch(a){Se("Failed to complete task",a),ee.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){ee.error("Task not found");return}const n=this.repository.getAllTasks().filter(i=>{var o,c;return((o=i.blockedBy)==null?void 0:o.includes(e))||((c=i.dependsOn)==null?void 0:c.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),Ge.emit("task:deleted",{taskId:e}),ee.success(`Task "${t.name}" deleted`)}catch(t){Se("Failed to delete task",t),ee.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){ee.error("Task not found");return}const a=new Date;a.setHours(12,0,0,0);const n={...t,scheduledAt:a.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),Ge.emit("task:updated",{taskId:e}),ee.success("Task rescheduled to today")}catch(t){Se("Failed to reschedule task",t),ee.error("Failed to reschedule task")}}async deferTask(e,t){try{const a=this.repository.getTask(e);if(!a){ee.error("Task not found");return}const n={...a,updatedAt:new Date().toISOString()};if(a.dueAt){const i=new Date(a.dueAt);i.setDate(i.getDate()+t),n.dueAt=i.toISOString()}if(a.scheduledAt){const i=new Date(a.scheduledAt);i.setDate(i.getDate()+t),n.scheduledAt=i.toISOString()}await this.repository.saveTask(n),Ge.emit("task:updated",{taskId:e}),ee.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(a){Se("Failed to defer task",a),ee.error("Failed to defer task")}}async handleRecurrence(e){if(!(!e.frequency||!this.recurrenceEngine))try{const t=this.recurrenceEngine.calculateNext(e);e.onCompletion==="delete"&&await this.repository.deleteTask(e.id),await this.repository.saveTask(t),ve(`Created next recurrence for task: ${e.name}`),ee.info("Next occurrence scheduled")}catch(t){Se("Failed to handle recurrence",t),ee.error("Failed to create next recurrence")}}}function Uv(s,e,t,a){const n=new Kv(e,t,a);s.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{Kr()}}),s.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{s.openDock()}}),s.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await Gv(e,n)}}),s.addCommand({langKey:"toggleTaskStatus",hotkey:"‚åò‚áßX",callback:async()=>{const i=await Yv();i&&await n.toggleStatus(i)}}),s.addCommand({langKey:"openTaskEditor",hotkey:"‚åò‚áßE",callback:()=>{Hv()}}),s.addCommand({langKey:"quickAddTask",hotkey:"‚åò‚áßN",callback:()=>{Kr()}}),ve("Registered slash commands and hotkeys")}function Kr(){Ge.emit("task:create",{source:"command"});const s=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(s)}function Hv(){Ge.emit("task:edit",{source:"command"});const s=new CustomEvent("recurring-task-edit",{detail:{source:"command"}});window.dispatchEvent(s)}async function Gv(s,e){try{const t=s.getTodayAndOverdueTasks();if(t.length===0){ve("No tasks due today");return}const a=t[0];await e.completeTask(a.id),ve(`Quick completing task: ${a.name}`)}catch(t){Se("Failed to quick complete task",t)}}async function Yv(){return null}function Ur(s,e){Ge.emit("task:snooze",{taskId:s,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:e}})),ve(`Snoozing task ${s} for ${e} minutes`)}function Vv(s){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const a=Fn(t),n=Math.max(0,Math.floor((a.getTime()-e.getTime())/(60*1e3)));Ge.emit("task:snooze",{taskId:s,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:n}})),ve(`Snoozing task ${s} to tomorrow`)}function Wv(s){s.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const a=t[0],n=a==null?void 0:a.getAttribute("data-node-id");if(!n)return;const i=(a==null?void 0:a.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=s.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Ge.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:i,suggestedName:Hr(i),suggestedTime:Gr(i)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:i,suggestedName:Hr(i),suggestedTime:Gr(i)}}))}});try{const u=Za.getInstance();if(u&&u.isReady()){const m=u.getRepository().getTaskByBlockId(n);if(m){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=s.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{Ge.emit("task:complete",{taskId:m.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:m.id}}))}});const y=[{label:"15 minutes",click:()=>Ur(m.id,15)},{label:"1 hour",click:()=>Ur(m.id,60)},{label:"Tomorrow",click:()=>Vv(m.id)}];e.menu.addItem({icon:"iconClock",label:((l=s.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:y})}}}catch{Qi("TaskManager not available for quick actions")}}),ve("Registered block context menu")}function Hr(s){const e=s.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function Gr(s){var a;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=s.match(e);if(t){let n=parseInt(t[1],10);const i=t[2],o=(a=t[3])==null?void 0:a.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${i}`}return null}class Qv{constructor(e,t){E(this,"plugin");E(this,"repository");E(this,"topbarElement",null);E(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),ve("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),ve("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(a=>{const n=new Date(a.dueAt);return n<new Date&&!tr(n)}).length;if(e.length>0){const a=this.topbarElement.querySelector(".b3-badge");if(a)a.textContent=e.length.toString(),a.style.display="block",t>0?a.style.backgroundColor="var(--b3-theme-error)":a.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const a=this.topbarElement.querySelector(".b3-badge");a&&a.remove()}}toggleMenu(){Ge.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Xv extends jn.Plugin{constructor(){super(...arguments);E(this,"taskManager");E(this,"repository");E(this,"scheduler");E(this,"eventService");E(this,"migrationManager");E(this,"topbarMenu");E(this,"dashboardComponent",null);E(this,"dockEl");E(this,"quickAddComponent",null);E(this,"quickAddContainer",null);E(this,"taskEditorComponent",null);E(this,"taskEditorContainer",null);E(this,"pendingCompletionTimeouts",new Map);E(this,"handleCreateTaskEvent",t=>{try{const a=t;ve("Create task event received",a.detail),this.openQuickAdd(a.detail)}catch(a){Se("Failed to handle create task event",a),ee.error("Failed to open task creator.")}});E(this,"handleSettingsEvent",t=>{try{ve("Settings event received",t.detail),this.openDock()}catch(a){Se("Failed to handle settings event",a),ee.error("Failed to open settings.")}});E(this,"handleCompleteTaskEvent",async t=>{try{const a=t,{taskId:n}=a.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(a){Se("Failed to complete task",a),ee.error("Failed to complete task.")}});E(this,"handleSnoozeTaskEvent",async t=>{try{const a=t,{taskId:n,minutes:i}=a.detail??{};if(!n||typeof i!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,i)}catch(a){Se("Failed to snooze task",a),ee.error("Failed to snooze task.")}})}async onload(){ve("Loading Recurring Tasks Plugin"),this.migrationManager=new kv(this);try{await this.migrationManager.migrate(Rs)}catch(n){Se("Migration failed, continuing with existing data",n)}const t=Za.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const a=this.taskManager.getSettingsService();try{await this.taskManager.start()}catch(n){Se("Failed to start TaskManager",n)}Uv(this,this.repository,this.scheduler.getRecurrenceEngine(),()=>a.get()),Wv(this),this.topbarMenu=new Qv(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:Hl,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),ve("Recurring Tasks Plugin loaded successfully")}async onunload(){ve("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=hn(hv,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(fn(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Ge.on("task:create",t=>{ve("Create task event received",t),this.openQuickAdd(t)}),Ge.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Ge.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Ge.on("task:settings",()=>{this.openDock()}),Ge.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){Se("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Ge.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const a=this.repository.getTask(t);if(a){if(this.pendingCompletionTimeouts.has(t)){ee.info(`Completion already pending for "${a.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(a),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),ve(`Task completed: ${a.name}`)}catch(o){Se("Failed to finalize task completion",o),ee.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const i=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),ee.info(`Undo: "${a.name}" restored`))};Fs({message:`Task "${a.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:i,showCountdown:!0})}}async handleSnoozeTask(t,a){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,a),this.topbarMenu&&this.topbarMenu.update(),ve(`Task snoozed: ${n.name} for ${a} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=hn(yv,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}closeQuickAdd(){this.quickAddComponent&&(fn(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=hn(Zi,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(fn(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=Xv;

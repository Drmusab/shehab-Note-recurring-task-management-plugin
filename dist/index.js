"use strict";var gr=Object.defineProperty;var Ca=n=>{throw TypeError(n)};var pr=(n,e,t)=>e in n?gr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var T=(n,e,t)=>pr(n,typeof e!="symbol"?e+"":e,t),Hs=(n,e,t)=>e.has(n)||Ca("Cannot "+t);var g=(n,e,t)=>(Hs(n,e,"read from private field"),t?t.call(n):e.get(n)),ie=(n,e,t)=>e.has(n)?Ca("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ae=(n,e,t,s)=>(Hs(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),Oe=(n,e,t)=>(Hs(n,e,"access private method"),t);const ma=require("siyuan"),$s=!1;var vi=Array.isArray,yr=Array.prototype.indexOf,Bs=Array.from,wr=Object.defineProperty,Ln=Object.getOwnPropertyDescriptor,br=Object.getOwnPropertyDescriptors,Tr=Object.prototype,Sr=Array.prototype,fi=Object.getPrototypeOf,xa=Object.isExtensible;function Er(n){for(var e=0;e<n.length;e++)n[e]()}function hi(){var n,e,t=new Promise((s,a)=>{n=s,e=a});return{promise:t,resolve:n,reject:e}}const Ne=2,As=4,Ns=8,_i=1<<24,Vt=16,Qt=32,Mn=64,ka=128,yt=512,Le=1024,Ye=2048,Wt=4096,ot=8192,Ut=16384,ga=32768,Vn=65536,Ia=1<<17,mi=1<<18,Jn=1<<19,Dr=1<<20,jt=1<<25,Cn=32768,ea=1<<21,pa=1<<22,dn=1<<23,ss=Symbol("$state"),Ar=Symbol("legacy props"),Cr=Symbol(""),Fn=new class extends Error{constructor(){super(...arguments);T(this,"name","StaleReactionError");T(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function ki(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function xr(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Ir(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Mr(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function qr(n){throw new Error("https://svelte.dev/e/effect_orphan")}function Or(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Rr(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function Br(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Nr(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function zr(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Fr(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const Lr=1,Pr=2,gi=4,jr=8,Kr=16,Ur=1,Hr=4,Yr=8,Vr=16,Qr=1,Wr=2,Re=Symbol(),Xr="http://www.w3.org/1999/xhtml";function Gr(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function pi(n){return n===this.v}function Jr(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function yi(n){return!Jr(n,this.v)}let Zr=!1,$e=null;function Qn(n){$e=n}function et(n,e=!1,t){$e={p:$e,i:!1,c:null,e:null,s:n,x:null,l:null}}function tt(n){var e=$e,t=e.e;if(t!==null){e.e=null;for(var s of t)Ki(s)}return e.i=!0,$e=e.p,{}}function wi(){return!0}let _n=[];function bi(){var n=_n;_n=[],Er(n)}function Zn(n){if(_n.length===0&&!as){var e=_n;queueMicrotask(()=>{e===_n&&bi()})}_n.push(n)}function $r(){for(;_n.length>0;)bi()}function Ti(n){var e=fe;if(e===null)return ne.f|=dn,n;if(e.f&ga)Wn(n,e);else{if(!(e.f&ka))throw n;e.b.error(n)}}function Wn(n,e){for(;e!==null;){if(e.f&ka)try{e.b.error(n);return}catch(t){n=t}e=e.parent}throw n}const eo=-7169;function Me(n,e){n.f=n.f&eo|e}function ya(n){n.f&yt||n.deps===null?Me(n,Le):Me(n,Wt)}function Si(n){if(n!==null)for(const e of n)!(e.f&Ne)||!(e.f&Cn)||(e.f^=Cn,Si(e.deps))}function Ei(n,e,t){n.f&Ye?e.add(n):n.f&Wt&&t.add(n),Si(n.deps),Me(n,Le)}const gs=new Set;let re=null,ys=null,Be=null,ht=[],zs=null,ta=!1,as=!1;var Pn,jn,gn,pn,us,Kn,Un,wt,na,sa,Di,Ai;const qs=class qs{constructor(){ie(this,wt);T(this,"committed",!1);T(this,"current",new Map);T(this,"previous",new Map);ie(this,Pn,new Set);ie(this,jn,new Set);ie(this,gn,0);ie(this,pn,0);ie(this,us,null);ie(this,Kn,new Set);ie(this,Un,new Set);T(this,"skipped_effects",new Set);T(this,"is_fork",!1)}is_deferred(){return this.is_fork||g(this,pn)>0}process(e){var a;ht=[],ys=null,this.apply();var t=[],s=[];for(const i of e)Oe(this,wt,na).call(this,i,t,s);this.is_fork||Oe(this,wt,Di).call(this),this.is_deferred()?(Oe(this,wt,sa).call(this,s),Oe(this,wt,sa).call(this,t)):(ys=this,re=null,Ma(s),Ma(t),ys=null,(a=g(this,us))==null||a.resolve()),Be=null}capture(e,t){t!==Re&&!this.previous.has(e)&&this.previous.set(e,t),e.f&dn||(this.current.set(e,e.v),Be==null||Be.set(e,e.v))}activate(){re=this,this.apply()}deactivate(){re===this&&(re=null,Be=null)}flush(){if(this.activate(),ht.length>0){if(Ci(),re!==null&&re!==this)return}else g(this,gn)===0&&this.process([]);this.deactivate()}discard(){for(const e of g(this,jn))e(this);g(this,jn).clear()}increment(e){ae(this,gn,g(this,gn)+1),e&&ae(this,pn,g(this,pn)+1)}decrement(e){ae(this,gn,g(this,gn)-1),e&&ae(this,pn,g(this,pn)-1),this.revive()}revive(){for(const e of g(this,Kn))g(this,Un).delete(e),Me(e,Ye),Yt(e);for(const e of g(this,Un))Me(e,Wt),Yt(e);this.flush()}oncommit(e){g(this,Pn).add(e)}ondiscard(e){g(this,jn).add(e)}settled(){return(g(this,us)??ae(this,us,hi())).promise}static ensure(){if(re===null){const e=re=new qs;gs.add(re),as||qs.enqueue(()=>{re===e&&e.flush()})}return re}static enqueue(e){Zn(e)}apply(){}};Pn=new WeakMap,jn=new WeakMap,gn=new WeakMap,pn=new WeakMap,us=new WeakMap,Kn=new WeakMap,Un=new WeakMap,wt=new WeakSet,na=function(e,t,s){e.f^=Le;for(var a=e.first,i=null;a!==null;){var o=a.f,c=(o&(Qt|Mn))!==0,l=c&&(o&Le)!==0,d=l||(o&ot)!==0||this.skipped_effects.has(a);if(!d&&a.fn!==null){c?a.f^=Le:i!==null&&o&(As|Ns|_i)?i.b.defer_effect(a):o&As?t.push(a):_s(a)&&(o&Vt&&g(this,Kn).add(a),ls(a));var v=a.first;if(v!==null){a=v;continue}}var h=a.parent;for(a=a.next;a===null&&h!==null;)h===i&&(i=null),a=h.next,h=h.parent}},sa=function(e){for(var t=0;t<e.length;t+=1)Ei(e[t],g(this,Kn),g(this,Un))},Di=function(){if(g(this,pn)===0){for(const e of g(this,Pn))e();g(this,Pn).clear()}g(this,gn)===0&&Oe(this,wt,Ai).call(this)},Ai=function(){var a;if(gs.size>1){this.previous.clear();var e=Be,t=!0;for(const i of gs){if(i===this){t=!1;continue}const o=[];for(const[l,d]of this.current){if(i.current.has(l))if(t&&d!==i.current.get(l))i.current.set(l,d);else continue;o.push(l)}if(o.length===0)continue;const c=[...i.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var s=ht;ht=[];const l=new Set,d=new Map;for(const v of o)xi(v,c,l,d);if(ht.length>0){re=i,i.apply();for(const v of ht)Oe(a=i,wt,na).call(a,v,[],[]);i.deactivate()}ht=s}}re=null,Be=e}this.committed=!0,gs.delete(this)};let Kt=qs;function to(n){var e=as;as=!0;try{for(var t;;){if($r(),ht.length===0&&(re==null||re.flush(),ht.length===0))return zs=null,t;Ci()}}finally{as=e}}function Ci(){var n=En;ta=!0;var e=null;try{var t=0;for(xs(!0);ht.length>0;){var s=Kt.ensure();if(t++>1e3){var a,i;no()}s.process(ht),un.clear()}}finally{ta=!1,xs(n),zs=null}}function no(){try{Or()}catch(n){Wn(n,zs)}}let Et=null;function Ma(n){var e=n.length;if(e!==0){for(var t=0;t<e;){var s=n[t++];if(!(s.f&(Ut|ot))&&_s(s)&&(Et=new Set,ls(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?Vi(s):s.fn=null),(Et==null?void 0:Et.size)>0)){un.clear();for(const a of Et){if(a.f&(Ut|ot))continue;const i=[a];let o=a.parent;for(;o!==null;)Et.has(o)&&(Et.delete(o),i.push(o)),o=o.parent;for(let c=i.length-1;c>=0;c--){const l=i[c];l.f&(Ut|ot)||ls(l)}}Et.clear()}}Et=null}}function xi(n,e,t,s){if(!t.has(n)&&(t.add(n),n.reactions!==null))for(const a of n.reactions){const i=a.f;i&Ne?xi(a,e,t,s):i&(pa|Vt)&&!(i&Ye)&&Ii(a,e,s)&&(Me(a,Ye),Yt(a))}}function Ii(n,e,t){const s=t.get(n);if(s!==void 0)return s;if(n.deps!==null)for(const a of n.deps){if(e.includes(a))return!0;if(a.f&Ne&&Ii(a,e,t))return t.set(a,!0),!0}return t.set(n,!1),!1}function Yt(n){for(var e=zs=n;e.parent!==null;){e=e.parent;var t=e.f;if(ta&&e===fe&&t&Vt&&!(t&mi))return;if(t&(Mn|Qt)){if(!(t&Le))return;e.f^=Le}}ht.push(e)}function so(n){let e=0,t=xn(0),s;return()=>{ba()&&(r(t),Ps(()=>(e===0&&(s=qn(()=>n(()=>is(t)))),e+=1,()=>{Zn(()=>{e-=1,e===0&&(s==null||s(),s=void 0,is(t))})})))}}var ao=Vn|Jn|ka;function io(n,e,t){new ro(n,e,t)}var vt,_a,qt,yn,Ot,ft,Xe,Rt,Pt,sn,wn,an,bn,Hn,Yn,rn,Os,Ie,oo,lo,aa,ws,bs,ia;class ro{constructor(e,t,s){ie(this,Ie);T(this,"parent");T(this,"is_pending",!1);ie(this,vt);ie(this,_a,null);ie(this,qt);ie(this,yn);ie(this,Ot);ie(this,ft,null);ie(this,Xe,null);ie(this,Rt,null);ie(this,Pt,null);ie(this,sn,null);ie(this,wn,0);ie(this,an,0);ie(this,bn,!1);ie(this,Hn,new Set);ie(this,Yn,new Set);ie(this,rn,null);ie(this,Os,so(()=>(ae(this,rn,xn(g(this,wn))),()=>{ae(this,rn,null)})));ae(this,vt,e),ae(this,qt,t),ae(this,yn,s),this.parent=fe.b,this.is_pending=!!g(this,qt).pending,ae(this,Ot,Ta(()=>{fe.b=this;{var a=Oe(this,Ie,aa).call(this);try{ae(this,ft,_t(()=>s(a)))}catch(i){this.error(i)}g(this,an)>0?Oe(this,Ie,bs).call(this):this.is_pending=!1}return()=>{var i;(i=g(this,sn))==null||i.remove()}},ao))}defer_effect(e){Ei(e,g(this,Hn),g(this,Yn))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!g(this,qt).pending}update_pending_count(e){Oe(this,Ie,ia).call(this,e),ae(this,wn,g(this,wn)+e),g(this,rn)&&Xn(g(this,rn),g(this,wn))}get_effect_pending(){return g(this,Os).call(this),r(g(this,rn))}error(e){var t=g(this,qt).onerror;let s=g(this,qt).failed;if(g(this,bn)||!t&&!s)throw e;g(this,ft)&&(Ze(g(this,ft)),ae(this,ft,null)),g(this,Xe)&&(Ze(g(this,Xe)),ae(this,Xe,null)),g(this,Rt)&&(Ze(g(this,Rt)),ae(this,Rt,null));var a=!1,i=!1;const o=()=>{if(a){Gr();return}a=!0,i&&Fr(),Kt.ensure(),ae(this,wn,0),g(this,Rt)!==null&&Sn(g(this,Rt),()=>{ae(this,Rt,null)}),this.is_pending=this.has_pending_snippet(),ae(this,ft,Oe(this,Ie,ws).call(this,()=>(ae(this,bn,!1),_t(()=>g(this,yn).call(this,g(this,vt)))))),g(this,an)>0?Oe(this,Ie,bs).call(this):this.is_pending=!1};var c=ne;try{Je(null),i=!0,t==null||t(e,o),i=!1}catch(l){Wn(l,g(this,Ot)&&g(this,Ot).parent)}finally{Je(c)}s&&Zn(()=>{ae(this,Rt,Oe(this,Ie,ws).call(this,()=>{Kt.ensure(),ae(this,bn,!0);try{return _t(()=>{s(g(this,vt),()=>e,()=>o)})}catch(l){return Wn(l,g(this,Ot).parent),null}finally{ae(this,bn,!1)}}))})}}vt=new WeakMap,_a=new WeakMap,qt=new WeakMap,yn=new WeakMap,Ot=new WeakMap,ft=new WeakMap,Xe=new WeakMap,Rt=new WeakMap,Pt=new WeakMap,sn=new WeakMap,wn=new WeakMap,an=new WeakMap,bn=new WeakMap,Hn=new WeakMap,Yn=new WeakMap,rn=new WeakMap,Os=new WeakMap,Ie=new WeakSet,oo=function(){try{ae(this,ft,_t(()=>g(this,yn).call(this,g(this,vt))))}catch(e){this.error(e)}},lo=function(){const e=g(this,qt).pending;e&&(ae(this,Xe,_t(()=>e(g(this,vt)))),Kt.enqueue(()=>{var t=Oe(this,Ie,aa).call(this);ae(this,ft,Oe(this,Ie,ws).call(this,()=>(Kt.ensure(),_t(()=>g(this,yn).call(this,t))))),g(this,an)>0?Oe(this,Ie,bs).call(this):(Sn(g(this,Xe),()=>{ae(this,Xe,null)}),this.is_pending=!1)}))},aa=function(){var e=g(this,vt);return this.is_pending&&(ae(this,sn,Ht()),g(this,vt).before(g(this,sn)),e=g(this,sn)),e},ws=function(e){var t=fe,s=ne,a=$e;zt(g(this,Ot)),Je(g(this,Ot)),Qn(g(this,Ot).ctx);try{return e()}catch(i){return Ti(i),null}finally{zt(t),Je(s),Qn(a)}},bs=function(){const e=g(this,qt).pending;g(this,ft)!==null&&(ae(this,Pt,document.createDocumentFragment()),g(this,Pt).append(g(this,sn)),Xi(g(this,ft),g(this,Pt))),g(this,Xe)===null&&ae(this,Xe,_t(()=>e(g(this,vt))))},ia=function(e){var t;if(!this.has_pending_snippet()){this.parent&&Oe(t=this.parent,Ie,ia).call(t,e);return}if(ae(this,an,g(this,an)+e),g(this,an)===0){this.is_pending=!1;for(const s of g(this,Hn))Me(s,Ye),Yt(s);for(const s of g(this,Yn))Me(s,Wt),Yt(s);g(this,Hn).clear(),g(this,Yn).clear(),g(this,Xe)&&Sn(g(this,Xe),()=>{ae(this,Xe,null)}),g(this,Pt)&&(g(this,vt).before(g(this,Pt)),ae(this,Pt,null))}};function co(n,e,t,s){const a=Fs;if(t.length===0&&n.length===0){s(e.map(a));return}var i=re,o=fe,c=uo();function l(){Promise.all(t.map(d=>vo(d))).then(d=>{c();try{s([...e.map(a),...d])}catch(v){o.f&Ut||Wn(v,o)}i==null||i.deactivate(),Cs()}).catch(d=>{Wn(d,o)})}n.length>0?Promise.all(n).then(()=>{c();try{return l()}finally{i==null||i.deactivate(),Cs()}}):l()}function uo(){var n=fe,e=ne,t=$e,s=re;return function(i=!0){zt(n),Je(e),Qn(t),i&&(s==null||s.activate())}}function Cs(){zt(null),Je(null),Qn(null)}function Fs(n){var e=Ne|Ye,t=ne!==null&&ne.f&Ne?ne:null;return fe!==null&&(fe.f|=Jn),{ctx:$e,deps:null,effects:null,equals:pi,f:e,fn:n,reactions:null,rv:0,v:Re,wv:0,parent:t??fe,ac:null}}function vo(n,e,t){let s=fe;s===null&&xr();var a=s.b,i=void 0,o=xn(Re),c=!ne,l=new Map;return To(()=>{var b;var d=hi();i=d.promise;try{Promise.resolve(n()).then(d.resolve,d.reject).then(()=>{v===re&&v.committed&&v.deactivate(),Cs()})}catch(O){d.reject(O),Cs()}var v=re;if(c){var h=a.is_rendered();a.update_pending_count(1),v.increment(h),(b=l.get(v))==null||b.reject(Fn),l.delete(v),l.set(v,d)}const _=(O,q=void 0)=>{if(v.activate(),q)q!==Fn&&(o.f|=dn,Xn(o,q));else{o.f&dn&&(o.f^=dn),Xn(o,O);for(const[p,w]of l){if(l.delete(p),p===v)break;w.reject(Fn)}}c&&(a.update_pending_count(-1),v.decrement(h))};d.promise.then(_,O=>_(null,O||"unknown"))}),ji(()=>{for(const d of l.values())d.reject(Fn)}),new Promise(d=>{function v(h){function _(){h===i?d(o):v(i)}h.then(_,_)}v(i)})}function X(n){const e=Fs(n);return Gi(e),e}function Mi(n){const e=Fs(n);return e.equals=yi,e}function qi(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)Ze(e[t])}}function fo(n){for(var e=n.parent;e!==null;){if(!(e.f&Ne))return e.f&Ut?null:e;e=e.parent}return null}function wa(n){var e,t=fe;zt(fo(n));try{n.f&=~Cn,qi(n),e=er(n)}finally{zt(t)}return e}function Oi(n){var e=wa(n);if(!n.equals(e)&&(n.wv=Zi(),(!(re!=null&&re.is_fork)||n.deps===null)&&(n.v=e,n.deps===null))){Me(n,Le);return}vn||(Be!==null?(ba()||re!=null&&re.is_fork)&&Be.set(n,e):ya(n))}let ra=new Set;const un=new Map;let Ri=!1;function xn(n,e){var t={f:0,v:n,reactions:null,equals:pi,rv:0,wv:0};return t}function H(n,e){const t=xn(n);return Gi(t),t}function ho(n,e=!1,t=!0){const s=xn(n);return e||(s.equals=yi),s}function y(n,e,t=!1){ne!==null&&(!At||ne.f&Ia)&&wi()&&ne.f&(Ne|Vt|pa|Ia)&&!(He!=null&&He.includes(n))&&zr();let s=t?me(e):e;return Xn(n,s)}function Xn(n,e){if(!n.equals(e)){var t=n.v;vn?un.set(n,e):un.set(n,t),n.v=e;var s=Kt.ensure();if(s.capture(n,t),n.f&Ne){const a=n;n.f&Ye&&wa(a),ya(a)}n.wv=Zi(),Bi(n,Ye),fe!==null&&fe.f&Le&&!(fe.f&(Qt|Mn))&&(ut===null?Eo([n]):ut.push(n)),!s.is_fork&&ra.size>0&&!Ri&&_o()}return e}function _o(){Ri=!1;var n=En;xs(!0);const e=Array.from(ra);try{for(const t of e)t.f&Le&&Me(t,Wt),_s(t)&&ls(t)}finally{xs(n)}ra.clear()}function is(n){y(n,n.v+1)}function Bi(n,e){var t=n.reactions;if(t!==null)for(var s=t.length,a=0;a<s;a++){var i=t[a],o=i.f,c=(o&Ye)===0;if(c&&Me(i,e),o&Ne){var l=i;Be==null||Be.delete(l),o&Cn||(o&yt&&(i.f|=Cn),Bi(l,Wt))}else c&&(o&Vt&&Et!==null&&Et.add(i),Yt(i))}}function me(n){if(typeof n!="object"||n===null||ss in n)return n;const e=fi(n);if(e!==Tr&&e!==Sr)return n;var t=new Map,s=vi(n),a=H(0),i=Dn,o=c=>{if(Dn===i)return c();var l=ne,d=Dn;Je(null),Ba(i);var v=c();return Je(l),Ba(d),v};return s&&t.set("length",H(n.length)),new Proxy(n,{defineProperty(c,l,d){(!("value"in d)||d.configurable===!1||d.enumerable===!1||d.writable===!1)&&Br();var v=t.get(l);return v===void 0?v=o(()=>{var h=H(d.value);return t.set(l,h),h}):y(v,d.value,!0),!0},deleteProperty(c,l){var d=t.get(l);if(d===void 0){if(l in c){const v=o(()=>H(Re));t.set(l,v),is(a)}}else y(d,Re),is(a);return!0},get(c,l,d){var b;if(l===ss)return n;var v=t.get(l),h=l in c;if(v===void 0&&(!h||(b=Ln(c,l))!=null&&b.writable)&&(v=o(()=>{var O=me(h?c[l]:Re),q=H(O);return q}),t.set(l,v)),v!==void 0){var _=r(v);return _===Re?void 0:_}return Reflect.get(c,l,d)},getOwnPropertyDescriptor(c,l){var d=Reflect.getOwnPropertyDescriptor(c,l);if(d&&"value"in d){var v=t.get(l);v&&(d.value=r(v))}else if(d===void 0){var h=t.get(l),_=h==null?void 0:h.v;if(h!==void 0&&_!==Re)return{enumerable:!0,configurable:!0,value:_,writable:!0}}return d},has(c,l){var _;if(l===ss)return!0;var d=t.get(l),v=d!==void 0&&d.v!==Re||Reflect.has(c,l);if(d!==void 0||fe!==null&&(!v||(_=Ln(c,l))!=null&&_.writable)){d===void 0&&(d=o(()=>{var b=v?me(c[l]):Re,O=H(b);return O}),t.set(l,d));var h=r(d);if(h===Re)return!1}return v},set(c,l,d,v){var C;var h=t.get(l),_=l in c;if(s&&l==="length")for(var b=d;b<h.v;b+=1){var O=t.get(b+"");O!==void 0?y(O,Re):b in c&&(O=o(()=>H(Re)),t.set(b+"",O))}if(h===void 0)(!_||(C=Ln(c,l))!=null&&C.writable)&&(h=o(()=>H(void 0)),y(h,me(d)),t.set(l,h));else{_=h.v!==Re;var q=o(()=>me(d));y(h,q)}var p=Reflect.getOwnPropertyDescriptor(c,l);if(p!=null&&p.set&&p.set.call(v,d),!_){if(s&&typeof l=="string"){var w=t.get("length"),A=Number(l);Number.isInteger(A)&&A>=w.v&&y(w,A+1)}is(a)}return!0},ownKeys(c){r(a);var l=Reflect.ownKeys(c).filter(h=>{var _=t.get(h);return _===void 0||_.v!==Re});for(var[d,v]of t)v.v!==Re&&!(d in c)&&l.push(d);return l},setPrototypeOf(){Nr()}})}var qa,Ni,zi,Fi;function mo(){if(qa===void 0){qa=window,Ni=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype,t=Text.prototype;zi=Ln(e,"firstChild").get,Fi=Ln(e,"nextSibling").get,xa(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),xa(t)&&(t.__t=void 0)}}function Ht(n=""){return document.createTextNode(n)}function on(n){return zi.call(n)}function hs(n){return Fi.call(n)}function u(n,e){return on(n)}function mt(n,e=!1){{var t=on(n);return t instanceof Comment&&t.data===""?hs(t):t}}function f(n,e=1,t=!1){let s=n;for(;e--;)s=hs(s);return s}function ko(n){n.textContent=""}function Li(){return!1}let Oa=!1;function go(){Oa||(Oa=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{var e;if(!n.defaultPrevented)for(const t of n.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Ls(n){var e=ne,t=fe;Je(null),zt(null);try{return n()}finally{Je(e),zt(t)}}function Pi(n,e,t,s=t){n.addEventListener(e,()=>Ls(t));const a=n.__on_r;a?n.__on_r=()=>{a(),s(!0)}:n.__on_r=()=>s(!0),go()}function po(n){fe===null&&(ne===null&&qr(),Mr()),vn&&Ir()}function yo(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function Xt(n,e,t){var s=fe;s!==null&&s.f&ot&&(n|=ot);var a={ctx:$e,deps:null,nodes:null,f:n|Ye|yt,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{ls(a),a.f|=ga}catch(c){throw Ze(a),c}else e!==null&&Yt(a);var i=a;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&!(i.f&Jn)&&(i=i.first,n&Vt&&n&Vn&&i!==null&&(i.f|=Vn)),i!==null&&(i.parent=s,s!==null&&yo(i,s),ne!==null&&ne.f&Ne&&!(n&Mn))){var o=ne;(o.effects??(o.effects=[])).push(i)}return a}function ba(){return ne!==null&&!At}function ji(n){const e=Xt(Ns,null,!1);return Me(e,Le),e.teardown=n,e}function ln(n){po();var e=fe.f,t=!ne&&(e&Qt)!==0&&(e&ga)===0;if(t){var s=$e;(s.e??(s.e=[])).push(n)}else return Ki(n)}function Ki(n){return Xt(As|Dr,n,!1)}function wo(n){Kt.ensure();const e=Xt(Mn|Jn,n,!0);return(t={})=>new Promise(s=>{t.outro?Sn(e,()=>{Ze(e),s(void 0)}):(Ze(e),s(void 0))})}function bo(n){return Xt(As,n,!1)}function To(n){return Xt(pa|Jn,n,!0)}function Ps(n,e=0){return Xt(Ns|e,n,!0)}function U(n,e=[],t=[],s=[]){co(s,e,t,a=>{Xt(Ns,()=>n(...a.map(r)),!0)})}function Ta(n,e=0){var t=Xt(Vt|e,n,!0);return t}function _t(n){return Xt(Qt|Jn,n,!0)}function Ui(n){var e=n.teardown;if(e!==null){const t=vn,s=ne;Ra(!0),Je(null);try{e.call(null)}finally{Ra(t),Je(s)}}}function Hi(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){const a=t.ac;a!==null&&Ls(()=>{a.abort(Fn)});var s=t.next;t.f&Mn?t.parent=null:Ze(t,e),t=s}}function So(n){for(var e=n.first;e!==null;){var t=e.next;e.f&Qt||Ze(e),e=t}}function Ze(n,e=!0){var t=!1;(e||n.f&mi)&&n.nodes!==null&&n.nodes.end!==null&&(Yi(n.nodes.start,n.nodes.end),t=!0),Hi(n,e&&!t),Is(n,0),Me(n,Ut);var s=n.nodes&&n.nodes.t;if(s!==null)for(const i of s)i.stop();Ui(n);var a=n.parent;a!==null&&a.first!==null&&Vi(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function Yi(n,e){for(;n!==null;){var t=n===e?null:hs(n);n.remove(),n=t}}function Vi(n){var e=n.parent,t=n.prev,s=n.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===n&&(e.first=s),e.last===n&&(e.last=t))}function Sn(n,e,t=!0){var s=[];Qi(n,s,!0);var a=()=>{t&&Ze(n),e&&e()},i=s.length;if(i>0){var o=()=>--i||a();for(var c of s)c.out(o)}else a()}function Qi(n,e,t){if(!(n.f&ot)){n.f^=ot;var s=n.nodes&&n.nodes.t;if(s!==null)for(const c of s)(c.is_global||t)&&e.push(c);for(var a=n.first;a!==null;){var i=a.next,o=(a.f&Vn)!==0||(a.f&Qt)!==0&&(n.f&Vt)!==0;Qi(a,e,o?t:!1),a=i}}}function Sa(n){Wi(n,!0)}function Wi(n,e){if(n.f&ot){n.f^=ot,n.f&Le||(Me(n,Ye),Yt(n));for(var t=n.first;t!==null;){var s=t.next,a=(t.f&Vn)!==0||(t.f&Qt)!==0;Wi(t,a?e:!1),t=s}var i=n.nodes&&n.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Xi(n,e){if(n.nodes)for(var t=n.nodes.start,s=n.nodes.end;t!==null;){var a=t===s?null:hs(t);e.append(t),t=a}}let En=!1;function xs(n){En=n}let vn=!1;function Ra(n){vn=n}let ne=null,At=!1;function Je(n){ne=n}let fe=null;function zt(n){fe=n}let He=null;function Gi(n){ne!==null&&(He===null?He=[n]:He.push(n))}let Ue=null,it=0,ut=null;function Eo(n){ut=n}let Ji=1,os=0,Dn=os;function Ba(n){Dn=n}function Zi(){return++Ji}function _s(n){var e=n.f;if(e&Ye)return!0;if(e&Ne&&(n.f&=~Cn),e&Wt){for(var t=n.deps,s=t.length,a=0;a<s;a++){var i=t[a];if(_s(i)&&Oi(i),i.wv>n.wv)return!0}e&yt&&Be===null&&Me(n,Le)}return!1}function $i(n,e,t=!0){var s=n.reactions;if(s!==null&&!(He!=null&&He.includes(n)))for(var a=0;a<s.length;a++){var i=s[a];i.f&Ne?$i(i,e,!1):e===i&&(t?Me(i,Ye):i.f&Le&&Me(i,Wt),Yt(i))}}function er(n){var O;var e=Ue,t=it,s=ut,a=ne,i=He,o=$e,c=At,l=Dn,d=n.f;Ue=null,it=0,ut=null,ne=d&(Qt|Mn)?null:n,He=null,Qn(n.ctx),At=!1,Dn=++os,n.ac!==null&&(Ls(()=>{n.ac.abort(Fn)}),n.ac=null);try{n.f|=ea;var v=n.fn,h=v(),_=n.deps;if(Ue!==null){var b;if(Is(n,it),_!==null&&it>0)for(_.length=it+Ue.length,b=0;b<Ue.length;b++)_[it+b]=Ue[b];else n.deps=_=Ue;if(ba()&&n.f&yt)for(b=it;b<_.length;b++)((O=_[b]).reactions??(O.reactions=[])).push(n)}else _!==null&&it<_.length&&(Is(n,it),_.length=it);if(wi()&&ut!==null&&!At&&_!==null&&!(n.f&(Ne|Wt|Ye)))for(b=0;b<ut.length;b++)$i(ut[b],n);return a!==null&&a!==n&&(os++,ut!==null&&(s===null?s=ut:s.push(...ut))),n.f&dn&&(n.f^=dn),h}catch(q){return Ti(q)}finally{n.f^=ea,Ue=e,it=t,ut=s,ne=a,He=i,Qn(o),At=c,Dn=l}}function Do(n,e){let t=e.reactions;if(t!==null){var s=yr.call(t,n);if(s!==-1){var a=t.length-1;a===0?t=e.reactions=null:(t[s]=t[a],t.pop())}}if(t===null&&e.f&Ne&&(Ue===null||!Ue.includes(e))){var i=e;i.f&yt&&(i.f^=yt,i.f&=~Cn),ya(i),qi(i),Is(i,0)}}function Is(n,e){var t=n.deps;if(t!==null)for(var s=e;s<t.length;s++)Do(n,t[s])}function ls(n){var e=n.f;if(!(e&Ut)){Me(n,Le);var t=fe,s=En;fe=n,En=!0;try{e&(Vt|_i)?So(n):Hi(n),Ui(n);var a=er(n);n.teardown=typeof a=="function"?a:null,n.wv=Ji;var i;$s&&Zr&&n.f&Ye&&n.deps}finally{En=s,fe=t}}}async function tr(){await Promise.resolve(),to()}function r(n){var e=n.f,t=(e&Ne)!==0;if(ne!==null&&!At){var s=fe!==null&&(fe.f&Ut)!==0;if(!s&&!(He!=null&&He.includes(n))){var a=ne.deps;if(ne.f&ea)n.rv<os&&(n.rv=os,Ue===null&&a!==null&&a[it]===n?it++:Ue===null?Ue=[n]:Ue.includes(n)||Ue.push(n));else{(ne.deps??(ne.deps=[])).push(n);var i=n.reactions;i===null?n.reactions=[ne]:i.includes(ne)||i.push(ne)}}}if(vn&&un.has(n))return un.get(n);if(t){var o=n;if(vn){var c=o.v;return(!(o.f&Le)&&o.reactions!==null||sr(o))&&(c=wa(o)),un.set(o,c),c}var l=(o.f&yt)===0&&!At&&ne!==null&&(En||(ne.f&yt)!==0),d=o.deps===null;_s(o)&&(l&&(o.f|=yt),Oi(o)),l&&!d&&nr(o)}if(Be!=null&&Be.has(n))return Be.get(n);if(n.f&dn)throw n.v;return n.v}function nr(n){if(n.deps!==null){n.f|=yt;for(const e of n.deps)(e.reactions??(e.reactions=[])).push(n),e.f&Ne&&!(e.f&yt)&&nr(e)}}function sr(n){if(n.v===Re)return!0;if(n.deps===null)return!1;for(const e of n.deps)if(un.has(e)||e.f&Ne&&sr(e))return!0;return!1}function qn(n){var e=At;try{return At=!0,n()}finally{At=e}}const Ao=["touchstart","touchmove"];function Co(n){return Ao.includes(n)}const ar=new Set,oa=new Set;function xo(n,e,t,s={}){function a(i){if(s.capture||ts.call(e,i),!i.cancelBubble)return Ls(()=>t==null?void 0:t.call(this,i))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Zn(()=>{e.addEventListener(n,a,s)}):e.addEventListener(n,a,s),a}function gt(n,e,t,s,a){var i={capture:s,passive:a},o=xo(n,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&ji(()=>{e.removeEventListener(n,o,i)})}function Ct(n){for(var e=0;e<n.length;e++)ar.add(n[e]);for(var t of oa)t(n)}let Na=null;function ts(n){var p;var e=this,t=e.ownerDocument,s=n.type,a=((p=n.composedPath)==null?void 0:p.call(n))||[],i=a[0]||n.target;Na=n;var o=0,c=Na===n&&n.__root;if(c){var l=a.indexOf(c);if(l!==-1&&(e===document||e===window)){n.__root=e;return}var d=a.indexOf(e);if(d===-1)return;l<=d&&(o=l)}if(i=a[o]||n.target,i!==e){wr(n,"currentTarget",{configurable:!0,get(){return i||t}});var v=ne,h=fe;Je(null),zt(null);try{for(var _,b=[];i!==null;){var O=i.assignedSlot||i.parentNode||i.host||null;try{var q=i["__"+s];q!=null&&(!i.disabled||n.target===i)&&q.call(i,n)}catch(w){_?b.push(w):_=w}if(n.cancelBubble||O===e||O===null)break;i=O}if(_){for(let w of b)queueMicrotask(()=>{throw w});throw _}}finally{n.__root=e,delete n.currentTarget,Je(v),zt(h)}}}function ir(n){var e=document.createElement("template");return e.innerHTML=n.replaceAll("<!>","<!---->"),e.content}function cs(n,e){var t=fe;t.nodes===null&&(t.nodes={start:n,end:e,a:null,t:null})}function M(n,e){var t=(e&Qr)!==0,s=(e&Wr)!==0,a,i=!n.startsWith("<!>");return()=>{a===void 0&&(a=ir(i?n:"<!>"+n),t||(a=on(a)));var o=s||Ni?document.importNode(a,!0):a.cloneNode(!0);if(t){var c=on(o),l=o.lastChild;cs(c,l)}else cs(o,o);return o}}function Ys(n=""){{var e=Ht(n+"");return cs(e,e),e}}function cn(){var n=document.createDocumentFragment(),e=document.createComment(""),t=Ht();return n.append(e,t),cs(e,t),n}function D(n,e){n!==null&&n.before(e)}function z(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=t,n.nodeValue=t+"")}function Vs(n,e){return Io(n,e)}const zn=new Map;function Io(n,{target:e,anchor:t,props:s={},events:a,context:i,intro:o=!0}){mo();var c=new Set,l=h=>{for(var _=0;_<h.length;_++){var b=h[_];if(!c.has(b)){c.add(b);var O=Co(b);e.addEventListener(b,ts,{passive:O});var q=zn.get(b);q===void 0?(document.addEventListener(b,ts,{passive:O}),zn.set(b,1)):zn.set(b,q+1)}}};l(Bs(ar)),oa.add(l);var d=void 0,v=wo(()=>{var h=t??e.appendChild(Ht());return io(h,{pending:()=>{}},_=>{if(i){et({});var b=$e;b.c=i}a&&(s.$$events=a),d=n(_,s)||{},i&&tt()}),()=>{var O;for(var _ of c){e.removeEventListener(_,ts);var b=zn.get(_);--b===0?(document.removeEventListener(_,ts),zn.delete(_)):zn.set(_,b)}oa.delete(l),h!==t&&((O=h.parentNode)==null||O.removeChild(h))}});return la.set(d,v),d}let la=new WeakMap;function Qs(n,e){const t=la.get(n);return t?(la.delete(n),t(e)):Promise.resolve()}var Dt,Bt,rt,Tn,vs,fs,Rs;class Mo{constructor(e,t=!0){T(this,"anchor");ie(this,Dt,new Map);ie(this,Bt,new Map);ie(this,rt,new Map);ie(this,Tn,new Set);ie(this,vs,!0);ie(this,fs,()=>{var e=re;if(g(this,Dt).has(e)){var t=g(this,Dt).get(e),s=g(this,Bt).get(t);if(s)Sa(s),g(this,Tn).delete(t);else{var a=g(this,rt).get(t);a&&(g(this,Bt).set(t,a.effect),g(this,rt).delete(t),a.fragment.lastChild.remove(),this.anchor.before(a.fragment),s=a.effect)}for(const[i,o]of g(this,Dt)){if(g(this,Dt).delete(i),i===e)break;const c=g(this,rt).get(o);c&&(Ze(c.effect),g(this,rt).delete(o))}for(const[i,o]of g(this,Bt)){if(i===t||g(this,Tn).has(i))continue;const c=()=>{if(Array.from(g(this,Dt).values()).includes(i)){var d=document.createDocumentFragment();Xi(o,d),d.append(Ht()),g(this,rt).set(i,{effect:o,fragment:d})}else Ze(o);g(this,Tn).delete(i),g(this,Bt).delete(i)};g(this,vs)||!s?(g(this,Tn).add(i),Sn(o,c,!1)):c()}}});ie(this,Rs,e=>{g(this,Dt).delete(e);const t=Array.from(g(this,Dt).values());for(const[s,a]of g(this,rt))t.includes(s)||(Ze(a.effect),g(this,rt).delete(s))});this.anchor=e,ae(this,vs,t)}ensure(e,t){var s=re,a=Li();if(t&&!g(this,Bt).has(e)&&!g(this,rt).has(e))if(a){var i=document.createDocumentFragment(),o=Ht();i.append(o),g(this,rt).set(e,{effect:_t(()=>t(o)),fragment:i})}else g(this,Bt).set(e,_t(()=>t(this.anchor)));if(g(this,Dt).set(s,e),a){for(const[c,l]of g(this,Bt))c===e?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[c,l]of g(this,rt))c===e?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(g(this,fs)),s.ondiscard(g(this,Rs))}else g(this,fs).call(this)}}Dt=new WeakMap,Bt=new WeakMap,rt=new WeakMap,Tn=new WeakMap,vs=new WeakMap,fs=new WeakMap,Rs=new WeakMap;function Q(n,e,t=!1){var s=new Mo(n),a=t?Vn:0;function i(o,c){s.ensure(o,c)}Ta(()=>{var o=!1;e((c,l=!0)=>{o=!0,i(l,c)}),o||i(!1,null)},a)}function Nt(n,e){return e}function qo(n,e,t){for(var s=[],a=e.length,i,o=e.length,c=0;c<a;c++){let h=e[c];Sn(h,()=>{if(i){if(i.pending.delete(h),i.done.add(h),i.pending.size===0){var _=n.outrogroups;ca(Bs(i.done)),_.delete(i),_.size===0&&(n.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=s.length===0&&t!==null;if(l){var d=t,v=d.parentNode;ko(v),v.append(d),n.items.clear()}ca(e,!l)}else i={pending:new Set(e),done:new Set},(n.outrogroups??(n.outrogroups=new Set)).add(i)}function ca(n,e=!0){for(var t=0;t<n.length;t++)Ze(n[t],e)}var za;function ze(n,e,t,s,a,i=null){var o=n,c=new Map,l=(e&gi)!==0;if(l){var d=n;o=d.appendChild(Ht())}var v=null,h=Mi(()=>{var w=t();return vi(w)?w:w==null?[]:Bs(w)}),_,b=!0;function O(){p.fallback=v,Oo(p,_,o,e,s),v!==null&&(_.length===0?v.f&jt?(v.f^=jt,ns(v,null,o)):Sa(v):Sn(v,()=>{v=null}))}var q=Ta(()=>{_=r(h);for(var w=_.length,A=new Set,C=re,I=Li(),N=0;N<w;N+=1){var F=_[N],j=s(F,N),K=b?null:c.get(j);K?(K.v&&Xn(K.v,F),K.i&&Xn(K.i,N),I&&C.skipped_effects.delete(K.e)):(K=Ro(c,b?o:za??(za=Ht()),F,j,N,a,e,t),b||(K.e.f|=jt),c.set(j,K)),A.add(j)}if(w===0&&i&&!v&&(b?v=_t(()=>i(o)):(v=_t(()=>i(za??(za=Ht()))),v.f|=jt)),!b)if(I){for(const[ee,te]of c)A.has(ee)||C.skipped_effects.add(te.e);C.oncommit(O),C.ondiscard(()=>{})}else O();r(h)}),p={effect:q,items:c,outrogroups:null,fallback:v};b=!1}function Oo(n,e,t,s,a){var te,le,Y,G,he,pe,k,m,E;var i=(s&jr)!==0,o=e.length,c=n.items,l=n.effect.first,d,v=null,h,_=[],b=[],O,q,p,w;if(i)for(w=0;w<o;w+=1)O=e[w],q=a(O,w),p=c.get(q).e,p.f&jt||((le=(te=p.nodes)==null?void 0:te.a)==null||le.measure(),(h??(h=new Set)).add(p));for(w=0;w<o;w+=1){if(O=e[w],q=a(O,w),p=c.get(q).e,n.outrogroups!==null)for(const R of n.outrogroups)R.pending.delete(p),R.done.delete(p);if(p.f&jt)if(p.f^=jt,p===l)ns(p,null,t);else{var A=v?v.next:l;p===n.effect.last&&(n.effect.last=p.prev),p.prev&&(p.prev.next=p.next),p.next&&(p.next.prev=p.prev),tn(n,v,p),tn(n,p,A),ns(p,A,t),v=p,_=[],b=[],l=v.next;continue}if(p.f&ot&&(Sa(p),i&&((G=(Y=p.nodes)==null?void 0:Y.a)==null||G.unfix(),(h??(h=new Set)).delete(p))),p!==l){if(d!==void 0&&d.has(p)){if(_.length<b.length){var C=b[0],I;v=C.prev;var N=_[0],F=_[_.length-1];for(I=0;I<_.length;I+=1)ns(_[I],C,t);for(I=0;I<b.length;I+=1)d.delete(b[I]);tn(n,N.prev,F.next),tn(n,v,N),tn(n,F,C),l=C,v=F,w-=1,_=[],b=[]}else d.delete(p),ns(p,l,t),tn(n,p.prev,p.next),tn(n,p,v===null?n.effect.first:v.next),tn(n,v,p),v=p;continue}for(_=[],b=[];l!==null&&l!==p;)(d??(d=new Set)).add(l),b.push(l),l=l.next;if(l===null)continue}p.f&jt||_.push(p),v=p,l=p.next}if(n.outrogroups!==null){for(const R of n.outrogroups)R.pending.size===0&&(ca(Bs(R.done)),(he=n.outrogroups)==null||he.delete(R));n.outrogroups.size===0&&(n.outrogroups=null)}if(l!==null||d!==void 0){var j=[];if(d!==void 0)for(p of d)p.f&ot||j.push(p);for(;l!==null;)!(l.f&ot)&&l!==n.fallback&&j.push(l),l=l.next;var K=j.length;if(K>0){var ee=s&gi&&o===0?t:null;if(i){for(w=0;w<K;w+=1)(k=(pe=j[w].nodes)==null?void 0:pe.a)==null||k.measure();for(w=0;w<K;w+=1)(E=(m=j[w].nodes)==null?void 0:m.a)==null||E.fix()}qo(n,j,ee)}}i&&Zn(()=>{var R,B;if(h!==void 0)for(p of h)(B=(R=p.nodes)==null?void 0:R.a)==null||B.apply()})}function Ro(n,e,t,s,a,i,o,c){var l=o&Lr?o&Kr?xn(t):ho(t,!1,!1):null,d=o&Pr?xn(a):null;return{v:l,i:d,e:_t(()=>(i(e,l??t,d??a,c),()=>{n.delete(s)}))}}function ns(n,e,t){if(n.nodes)for(var s=n.nodes.start,a=n.nodes.end,i=e&&!(e.f&jt)?e.nodes.start:t;s!==null;){var o=hs(s);if(i.before(s),s===a)return;s=o}}function tn(n,e,t){e===null?n.effect.first=t:e.next=t,t===null?n.effect.last=e:t.prev=e}function Bo(n,e,t=!1,s=!1,a=!1){var i=n,o="";U(()=>{var c=fe;if(o!==(o=e()??"")&&(c.nodes!==null&&(Yi(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var d=ir(l);if((t||s)&&(d=on(d)),cs(on(d),d.lastChild),t||s)for(;on(d);)i.before(on(d));else i.before(d)}})}function rr(n){var e,t,s="";if(typeof n=="string"||typeof n=="number")s+=n;else if(typeof n=="object")if(Array.isArray(n)){var a=n.length;for(e=0;e<a;e++)n[e]&&(t=rr(n[e]))&&(s&&(s+=" "),s+=t)}else for(t in n)n[t]&&(s&&(s+=" "),s+=t);return s}function No(){for(var n,e,t=0,s="",a=arguments.length;t<a;t++)(n=arguments[t])&&(e=rr(n))&&(s&&(s+=" "),s+=e);return s}function zo(n){return typeof n=="object"?No(n):n??""}const Fa=[...` 	
\r\f¬†\v\uFEFF`];function Fo(n,e,t){var s=n==null?"":""+n;if(e&&(s=s?s+" "+e:e),t){for(var a in t)if(t[a])s=s?s+" "+a:a;else if(s.length)for(var i=a.length,o=0;(o=s.indexOf(a,o))>=0;){var c=o+i;(o===0||Fa.includes(s[o-1]))&&(c===s.length||Fa.includes(s[c]))?s=(o===0?"":s.substring(0,o))+s.substring(c+1):o=c}}return s===""?null:s}function Lo(n,e){return n==null?null:String(n)}function pt(n,e,t,s,a,i){var o=n.__className;if(o!==t||o===void 0){var c=Fo(t,s,i);c==null?n.removeAttribute("class"):n.className=c,n.__className=t}else if(i&&a!==i)for(var l in i){var d=!!i[l];(a==null||d!==!!a[l])&&n.classList.toggle(l,d)}return i}function An(n,e,t,s){var a=n.__style;if(a!==e){var i=Lo(e);i==null?n.removeAttribute("style"):n.style.cssText=i,n.__style=e}return s}const Po=Symbol("is custom element"),jo=Symbol("is html");function or(n,e){var t=Ea(n);t.value===(t.value=e??void 0)||n.value===e&&(e!==0||n.nodeName!=="PROGRESS")||(n.value=e??"")}function rs(n,e){var t=Ea(n);t.checked!==(t.checked=e??void 0)&&(n.checked=e)}function xe(n,e,t,s){var a=Ea(n);a[e]!==(a[e]=t)&&(e==="loading"&&(n[Cr]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Ko(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function Ea(n){return n.__attributes??(n.__attributes={[Po]:n.nodeName.includes("-"),[jo]:n.namespaceURI===Xr})}var La=new Map;function Ko(n){var e=n.getAttribute("is")||n.nodeName,t=La.get(e);if(t)return t;La.set(e,t=[]);for(var s,a=n,i=Element.prototype;i!==a;){s=br(a);for(var o in s)s[o].set&&t.push(o);a=fi(a)}return t}function kt(n,e,t=e){var s=new WeakSet;Pi(n,"input",async a=>{var i=a?n.defaultValue:n.value;if(i=Ws(n)?Xs(i):i,t(i),re!==null&&s.add(re),await tr(),i!==(i=e())){var o=n.selectionStart,c=n.selectionEnd,l=n.value.length;if(n.value=i??"",c!==null){var d=n.value.length;o===c&&c===l&&d>l?(n.selectionStart=d,n.selectionEnd=d):(n.selectionStart=o,n.selectionEnd=Math.min(c,d))}}}),qn(e)==null&&n.value&&(t(Ws(n)?Xs(n.value):n.value),re!==null&&s.add(re)),Ps(()=>{var a=e();if(n===document.activeElement){var i=ys??re;if(s.has(i))return}Ws(n)&&a===Xs(n.value)||n.type==="date"&&!a&&!n.value||a!==n.value&&(n.value=a??"")})}function Uo(n,e,t=e){Pi(n,"change",s=>{var a=s?n.defaultChecked:n.checked;t(a)}),qn(e)==null&&t(n.checked),Ps(()=>{var s=e();n.checked=!!s})}function Ws(n){var e=n.type;return e==="number"||e==="range"}function Xs(n){return n===""?null:+n}function Pa(n,e){return n===e||(n==null?void 0:n[ss])===e}function Gn(n={},e,t,s){return bo(()=>{var a,i;return Ps(()=>{a=i,i=(s==null?void 0:s())||[],qn(()=>{n!==t(...i)&&(e(n,...i),a&&Pa(t(...a),n)&&e(null,...a))})}),()=>{Zn(()=>{i&&Pa(t(...i),n)&&e(null,...i)})}}),n}let ps=!1;function Ho(n){var e=ps;try{return ps=!1,[n(),ps]}finally{ps=e}}function In(n,e,t,s){var A;var a=(t&Yr)!==0,i=(t&Vr)!==0,o=s,c=!0,l=()=>(c&&(c=!1,o=i?qn(s):s),o),d;if(a){var v=ss in n||Ar in n;d=((A=Ln(n,e))==null?void 0:A.set)??(v&&e in n?C=>n[e]=C:void 0)}var h,_=!1;a?[h,_]=Ho(()=>n[e]):h=n[e],h===void 0&&s!==void 0&&(h=l(),d&&(Rr(),d(h)));var b;if(b=()=>{var C=n[e];return C===void 0?l():(c=!0,C)},!(t&Hr))return b;if(d){var O=n.$$legacy;return function(C,I){return arguments.length>0?((!I||O||_)&&d(I?b():C),C):b()}}var q=!1,p=(t&Ur?Fs:Mi)(()=>(q=!1,b()));a&&r(p);var w=fe;return function(C,I){if(arguments.length>0){const N=I?r(p):a?me(C):C;return y(p,N),q=!0,o!==void 0&&(o=N),C}return vn&&q||w.f&Ut?p.v:r(p)}}function js(n){$e===null&&ki(),ln(()=>{const e=qn(n);if(typeof e=="function")return e})}function Yo(n){$e===null&&ki(),js(()=>()=>qn(n))}const Vo="5";var ui;typeof window<"u"&&((ui=window.__svelte??(window.__svelte={})).v??(ui.v=new Set)).add(Vo);function Qo(){return{type:"daily",interval:1,time:"09:00"}}function lr(n){return!n||!n.type||!n.interval||n.interval<1?!1:n.type==="weekly"?Array.isArray(n.weekdays)&&n.weekdays.length>0&&n.weekdays.every(e=>e>=0&&e<=6):n.type==="monthly"?n.dayOfMonth>=1&&n.dayOfMonth<=31:n.type==="yearly"?n.month>=0&&n.month<=11&&n.dayOfMonth>=1&&n.dayOfMonth<=31:!0}const mn="recurring-tasks-active",Ts="recurring-tasks-archive",ja="recurring-tasks",Ka="recurring-tasks.json.bak",Ua="n8n-event-settings",Ha="n8n-event-queue",Wo="notification-state",Xo="recurring-tasks-dock",Ya="scheduler-emitted-occurrences",Ss=3,da={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},Da=60*1e3,Go=30*1e3,Gs=2e3,Va="shehab-note-recurring-plugin",Qa="1.0.0",Jo=60*60*1e3,Zo=3,Wa=10,Js=1e3,Es=100,Xa=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],Ga={low:"#64748b",normal:"#3b82f6",high:"#f59e0b",urgent:"#ef4444"},$o=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Ja="last-run-timestamp",Za="custom-recurring-task-id",$a="custom-recurring-task-due",ei="custom-recurring-task-enabled";function cr(n,e,t){const s=new Date().toISOString(),a=t||new Date;return{id:dr(),name:n,lastCompletedAt:void 0,dueAt:a.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:Ss,createdAt:s,updatedAt:s}}function dr(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function el(n,e={}){const t=new Date().toISOString();return{...{...n,id:dr(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function tl(n){const e=new Date().toISOString();n.completionCount=(n.completionCount||0)+1,n.currentStreak=(n.currentStreak||0)+1,n.bestStreak=Math.max(n.bestStreak||0,n.currentStreak),n.recentCompletions||(n.recentCompletions=[]),n.recentCompletions.push(e),n.recentCompletions.length>Wa&&(n.recentCompletions=n.recentCompletions.slice(-Wa)),n.snoozeCount=0,n.lastCompletedAt=e,n.updatedAt=e}function ur(n){n.missCount=(n.missCount||0)+1,n.currentStreak=0,n.updatedAt=new Date().toISOString()}function vr(n){const e=n.completionCount||0,t=n.missCount||0,s=e+t;if(s===0)return 100;let i=e/s*70;const o=n.currentStreak||0,c=Math.min(30,o*3);return i+=c,Math.round(Math.min(100,i))}function kn(n){const{message:e,type:t="info",duration:s=3e3,actionLabel:a,onAction:i,showCountdown:o=!1}=n,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let d=null;if(a&&i){const h=document.createElement("button");h.type="button";let _=Math.max(1,Math.ceil(s/1e3));h.textContent=o?`${a} (${_}s)`:a,h.className="recurring-tasks-toast__action",h.addEventListener("click",()=>{i(),d!==null&&window.clearInterval(d),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(h),o&&s>0&&(d=window.setInterval(()=>{_=Math.max(0,_-1),h.textContent=`${a} (${_}s)`,_<=0&&d!==null&&(window.clearInterval(d),d=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:nl(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const v=()=>{d!==null&&window.clearInterval(d),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};s>0&&setTimeout(()=>{v()},s)}function nl(n){switch(n){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const se={success:(n,e)=>kn({message:n,type:"success",duration:e}),error:(n,e)=>kn({message:n,type:"error",duration:e}),warning:(n,e)=>kn({message:n,type:"warning",duration:e}),info:(n,e)=>kn({message:n,type:"info",duration:e})};if(typeof document<"u"){const n=document.createElement("style");n.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(n)}class sl{constructor(){T(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(a=>a(t))}clear(){this.handlers.clear()}}const Ge=new sl;function ti(n,e){const t=n.findIndex(a=>a.id===e.id);if(t===-1)return[...n,e];const s=[...n];return s[t]=e,s}function ni(n,e){const t=n.filter(s=>s.id!==e);return t.length===n.length?n:t}function Zs(n,e,t){let s=!1;const a=n.map(i=>i.id!==e?i:(s=!0,t(i)));return s?a:n}function al(n,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),n.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const il=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function Ks(n,e,t){const s={timestamp:new Date().toISOString()},a=`[${n.toUpperCase()}] [${s.timestamp}]`;n==="error"?console.error(a,e,t||""):n==="warn"?console.warn(a,e,t||""):n==="debug"&&il?console.debug(a,e,t||""):n==="info"&&console.log(a,e,t||"")}function fr(n,e){Ks("debug",n,e)}function V(n,e){Ks("info",n,e)}function Fe(n,e){Ks("warn",n,e)}function ue(n,e){Ks("error",n,e)}async function rl(n){return new Promise(e=>{try{ma.fetchPost("/api/block/getBlockInfo",{id:n},t=>{var a,i,o;const s=((a=t==null?void 0:t.data)==null?void 0:a.content)??((i=t==null?void 0:t.data)==null?void 0:i.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){Fe("Failed to fetch block preview",t),e(null)}})}async function ol(n){return new Promise(e=>{try{ma.fetchPost("/api/block/getBlockHTML",{id:n},t=>{var a;const s=((a=t==null?void 0:t.data)==null?void 0:a.html)??null;e(s?s.trim():null)})}catch(t){Fe("Failed to fetch block embed",t),e(null)}})}function hr(n){const[e,t]=n.split(":").map(Number);return{hours:e,minutes:t}}function ll(n){const e=n.getHours().toString().padStart(2,"0"),t=n.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function cl(n){return n.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function ua(n){return n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Aa(n){const e=new Date;return n.getDate()===e.getDate()&&n.getMonth()===e.getMonth()&&n.getFullYear()===e.getFullYear()}function dl(n){return n<new Date}function ul(n){return dl(n)&&!Aa(n)}function ds(n,e){const t=new Date(n);return t.setDate(t.getDate()+e),t}function si(n,e){return ds(n,e*7)}function vl(n,e,t){const s=new Date(n);s.setHours(e,t,0,0);const a=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:a}}function va(n){const e=new Date(n);return e.setHours(0,0,0,0),e}function fl(n){const e=new Date(n);return e.setHours(23,59,59,999),e}function hl(n,e){const s=Math.abs(e.getTime()-n.getTime());return Math.floor(s/864e5)}function _l(n,e){const t=[];for(let s=0;s<e;s++)t.push(ds(n,s));return t}var ml=M('<span class="task-card__streak svelte-yjw1ud"> </span>'),kl=M('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),gl=M('<span class="task-card__relative svelte-yjw1ud"> </span>'),pl=M('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),yl=M('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),wl=M('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),bl=M('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),Tl=M('<button class="task-card__snooze-chip svelte-yjw1ud"> </button>'),Sl=M('<button class="task-card__snooze-option svelte-yjw1ud" role="menuitem"> </button>'),El=M('<div class="task-card__snooze-menu svelte-yjw1ud" role="menu" tabindex="0"></div>'),Dl=M('<div role="article"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar svelte-yjw1ud"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze svelte-yjw1ud" aria-label="Snooze task">üïí Snooze</button> <div class="task-card__snooze-quick svelte-yjw1ud"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow svelte-yjw1ud" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay svelte-yjw1ud" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip svelte-yjw1ud" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done svelte-yjw1ud" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function Al(n,e){et(e,!0);const t=X(()=>new Date(e.task.dueAt)),s=X(()=>ul(r(t))),a=X(()=>Aa(r(t))),i=X(()=>r(s)?hl(new Date(e.task.dueAt),new Date):0),o=X(()=>r(s)?"task-card--overdue":r(a)?"task-card--today":""),c=X(()=>()=>r(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+r(i)*.05)})`:""),l=X(()=>()=>r(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+r(i)*.08)})`:""),d=X(()=>e.task.priority?Ga[e.task.priority]:Ga.normal),v=X(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(r(t)):""),h=X(()=>(e.task.currentStreak||0)>0),_=X(()=>()=>"üî•"),b=X(()=>vr(e.task)),O=X(()=>r(b)>=80?"health--good":r(b)>=50?"health--fair":"health--poor");let q=H(!1),p=H(-1),w=H(me([])),A=H(!1),C=H(null),I=H(null),N=H(!1);const F=X(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),j=X(()=>()=>{if(!r(C))return"";const P=r(C).replace(/\s+/g," ").trim();return P.length>220?`${P.slice(0,220)}‚Ä¶`:P}),K=X(()=>()=>Xa.filter(P=>[15,60,120].includes(P.minutes)));ln(()=>{y(C,e.task.linkedBlockContent??null,!0),y(I,null),y(N,!1)});function ee(){e.onDone(e.task)}function te(){e.onDelay(e.task)}function le(){e.onEdit&&e.onEdit(e.task)}function Y(){e.onSkip(e.task)}async function G(){y(q,!r(q)),r(q)&&(await tr(),y(p,-1),y(w,[],!0))}function he(P){const J=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:P}});window.dispatchEvent(J),y(q,!1),y(p,-1)}function pe(P){var _e,Se,Qe,We;const J=r(K);P.key==="ArrowDown"?(P.preventDefault(),y(p,Math.min(r(p)+1,J.length-1),!0),(_e=r(w)[r(p)])==null||_e.focus()):P.key==="ArrowUp"?(P.preventDefault(),y(p,Math.max(r(p)-1,0),!0),(Se=r(w)[r(p)])==null||Se.focus()):P.key==="Escape"?(y(q,!1),y(p,-1)):P.key==="Home"?(P.preventDefault(),y(p,0),(Qe=r(w)[0])==null||Qe.focus()):P.key==="End"&&(P.preventDefault(),y(p,J.length-1),(We=r(w)[r(p)])==null||We.focus())}function k(P){if(P.key==="Escape"&&r(q)){y(q,!1);return}(P.key==="Enter"||P.key===" ")&&(P.preventDefault(),G())}async function m(){if(y(A,!0),!e.task.linkedBlockId||r(N)||r(I))return;y(N,!0);const[P,J]=await Promise.all([ol(e.task.linkedBlockId),rl(e.task.linkedBlockId)]);y(I,P,!0),y(C,J,!0),y(N,!1)}function E(){y(A,!1)}const R=X(()=>()=>`Task: ${e.task.name.replace(/[<>"&]/g,J=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[J]||J)}`);var B=Dl();B.__keydown=P=>{P.key==="Escape"&&r(q)&&y(q,!1)};var W=u(B),$=u(W),ce=u($),oe=f(ce,2),ke=u(oe),Ee=f(oe,2);{var ye=P=>{var J=ml(),_e=u(J);U(Se=>{xe(J,"title",`${e.task.currentStreak??""} day streak`),z(_e,`${Se??""} ${e.task.currentStreak??""}`)},[()=>r(_)()]),D(P,J)};Q(Ee,P=>{r(h)&&P(ye)})}var Ae=f($,2);{var De=P=>{var J=kl();J.__click=le,D(P,J)};Q(Ae,P=>{e.onEdit&&P(De)})}var be=f(W,2),nt=u(be),bt=f(u(nt),2),x=u(bt),L=f(bt,2);{var ve=P=>{var J=gl(),_e=u(J);U(Se=>z(_e,Se),[()=>r(v)()]),D(P,J)};Q(L,P=>{e.timezoneHandler&&P(ve)})}var de=f(nt,2);{var Te=P=>{var J=pl(),_e=f(u(J),2),Se=u(_e);U(Qe=>z(Se,Qe),[()=>ua(new Date(e.task.lastCompletedAt))]),D(P,J)};Q(de,P=>{e.task.lastCompletedAt&&P(Te)})}var we=f(de,2);{var qe=P=>{var J=bl(),_e=u(J),Se=u(_e),Qe=f(_e,2);{var We=It=>{var Mt=wl(),Tt=u(Mt);{var Zt=St=>{var Ke=Ys("Loading preview‚Ä¶");D(St,Ke)},On=St=>{var Ke=cn(),$t=mt(Ke);{var Rn=Ft=>{var en=yl(),Nn=u(en);Bo(Nn,()=>r(I)),D(Ft,en)},Bn=Ft=>{var en=cn(),Nn=mt(en);{var ms=Lt=>{var fn=Ys();U(()=>z(fn,r(j))),D(Lt,fn)},ks=Lt=>{var fn=Ys("No preview available.");D(Lt,fn)};Q(Nn,Lt=>{r(C)?Lt(ms):Lt(ks,!1)},!0)}D(Ft,en)};Q($t,Ft=>{r(I)?Ft(Rn):Ft(Bn,!1)},!0)}D(St,Ke)};Q(Tt,St=>{r(N)?St(Zt):St(On,!1)})}D(It,Mt)};Q(Qe,It=>{r(A)&&It(We)})}U(()=>{xe(_e,"title",`Linked block: ${e.task.linkedBlockId}`),z(Se,`üìù Block ${r(F)??""}`)}),gt("mouseenter",_e,m),gt("mouseleave",_e,E),gt("focus",_e,m),gt("blur",_e,E),D(P,J)};Q(we,P=>{e.task.linkedBlockId&&P(qe)})}var Ce=f(be,2),Ve=u(Ce),Pe=f(Ce,2),lt=u(Pe),xt=u(lt);xt.__click=G,xt.__keydown=k;var ct=f(xt,2),ge=u(ct);ze(ge,17,()=>r(K),Nt,(P,J)=>{var _e=Tl();_e.__click=()=>he(r(J).minutes);var Se=u(_e);U(()=>{xe(_e,"aria-label",`Snooze for ${r(J).label}`),z(Se,r(J).label)}),D(P,_e)});var st=f(ge,2);st.__click=te;var je=f(ct,2);{var Gt=P=>{var J=El();J.__keydown=pe,ze(J,21,()=>Xa,Nt,(_e,Se,Qe)=>{var We=Sl();We.__click=()=>he(r(Se).minutes),xe(We,"tabindex",Qe===0?0:-1);var It=u(We);Gn(We,(Mt,Tt)=>r(w)[Tt]=Mt,Mt=>{var Tt;return(Tt=r(w))==null?void 0:Tt[Mt]},()=>[Qe]),U(()=>z(It,r(Se).label)),D(_e,We)}),D(P,J)};Q(je,P=>{r(q)&&P(Gt)})}var dt=f(lt,2);dt.__click=te;var Jt=f(dt,2);Jt.__click=Y;var $n=f(Jt,2);$n.__click=ee,U((P,J)=>{pt(B,1,`task-card ${r(o)??""}`,"svelte-yjw1ud"),An(B,`--overdue-tint: ${r(c)??""}; --overdue-border: ${r(l)??""};`),xe(B,"aria-label",P),An(ce,`background-color: ${r(d)??""}`),xe(ce,"title",`Priority: ${(e.task.priority||"normal")??""}`),z(ke,e.task.name),z(x,J),pt(Ce,1,`task-card__health ${r(O)??""}`,"svelte-yjw1ud"),xe(Ce,"title",`Task health: ${r(b)??""}%`),An(Ve,`width: ${r(b)??""}%`),xe(xt,"aria-expanded",r(q))},[()=>r(R)(),()=>ua(r(t))]),D(n,B),tt()}Ct(["keydown","click"]);var Cl=M(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),xl=M('<div class="today-tab__card-wrapper svelte-u7986x"><!></div>'),Il=M('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x"><!></div></div>');function Ml(n,e){et(e,!0);const t=X(()=>[...e.tasks].sort((q,p)=>new Date(q.dueAt).getTime()-new Date(p.dueAt).getTime()));let s=H(0),a=me([]);ln(()=>{r(s)>=r(t).length&&y(s,Math.max(0,r(t).length-1),!0)});function i(q){var w;if(r(t).length===0)return;const p=Math.max(0,Math.min(q,r(t).length-1));y(s,p,!0),(w=a[p])==null||w.focus()}function o(q,p){q.key==="ArrowDown"?(q.preventDefault(),i(p+1)):q.key==="ArrowUp"?(q.preventDefault(),i(p-1)):q.key==="Home"?(q.preventDefault(),i(0)):q.key==="End"&&(q.preventDefault(),i(r(t).length-1))}var c=Il(),l=u(c),d=f(u(l),2),v=u(d),h=f(l,2),_=u(h);{var b=q=>{var p=Cl();D(q,p)},O=q=>{var p=cn(),w=mt(p);ze(w,19,()=>r(t),A=>A.id,(A,C,I)=>{var N=xl();N.__keydown=j=>o(j,r(I));var F=u(N);Al(F,{get task(){return r(C)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),Gn(N,(j,K)=>a[K]=j,j=>a==null?void 0:a[j],()=>[r(I)]),U(()=>xe(N,"tabindex",r(I)===r(s)?0:-1)),gt("focus",N,()=>y(s,r(I),!0)),D(A,N)}),D(q,p)};Q(_,q=>{r(t).length===0?q(b):q(O,!1)})}U(()=>z(v,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),D(n,c),tt()}Ct(["keydown"]);var ql=M('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Ol=M('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),Rl=M('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),Bl=M('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Nl=M('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),zl=M('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Fl=M('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Ll=M('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Pl(n,e){et(e,!0);let t=H(null),s=H(!1),a=H(""),i=H(""),o=H(me(new Set)),c=H(0),l=me([]),d=H(null);const v=X(()=>[...e.tasks].sort((x,L)=>new Date(x.dueAt).getTime()-new Date(L.dueAt).getTime())),h=X(()=>()=>{const x=r(i).trim().toLowerCase();return x?r(v).filter(L=>{var de;return[L.name,L.description,L.category,L.linkedBlockContent,(de=L.tags)==null?void 0:de.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(x)}):r(v)}),_=X(()=>r(h).map(x=>x.id)),b=X(()=>r(o).size>0),O=X(()=>r(h).length>0&&r(h).every(x=>r(o).has(x.id))),q=X(()=>r(h).some(x=>r(o).has(x.id))&&!r(O));ln(()=>{const x=new Set([...r(o)].filter(L=>e.tasks.some(ve=>ve.id===L)));x.size!==r(o).size&&y(o,x,!0)}),ln(()=>{r(d)&&(r(d).indeterminate=r(q))}),ln(()=>{r(c)>=r(h).length&&y(c,Math.max(0,r(h).length-1),!0)}),ln(()=>{const x=window.setTimeout(()=>{y(i,r(a),!0)},300);return()=>{window.clearTimeout(x)}});function p(x){y(t,x,!0)}function w(){r(t)&&(e.onDelete(r(t)),y(t,null))}function A(){y(t,null)}function C(x){const L=new Set(r(o));L.has(x)?L.delete(x):L.add(x),y(o,L,!0)}function I(){const x=new Set(r(o));r(O)?r(_).forEach(L=>x.delete(L)):r(_).forEach(L=>x.add(L)),y(o,x,!0)}function N(x){var ve;if(r(h).length===0)return;const L=Math.max(0,Math.min(x,r(h).length-1));y(c,L,!0),(ve=l[L])==null||ve.focus()}function F(x,L){x.key==="ArrowDown"?(x.preventDefault(),N(L+1)):x.key==="ArrowUp"?(x.preventDefault(),N(L-1)):x.key==="Home"?(x.preventDefault(),N(0)):x.key==="End"&&(x.preventDefault(),N(r(h).length-1))}function j(){if(r(o).size===0){y(s,!1);return}e.onBulkDelete([...r(o)]),y(o,new Set,!0),y(s,!1)}function K(){y(s,!1)}function ee(x){const{type:L,interval:ve}=x.frequency,de=L==="daily"?"day":L==="weekly"?"week":L==="monthly"?"month":"year",Te=ve===1?`Every ${de}`:`Every ${ve} ${de}s`;if(L==="weekly")return`${Te} on ${x.frequency.weekdays.map(we=>$o[we]??we).join(", ")}`;if(L==="monthly")return`${Te} on day ${x.frequency.dayOfMonth}`;if(L==="yearly"){const we=te[x.frequency.month]??`Month ${x.frequency.month+1}`;return`${Te} on ${we} ${x.frequency.dayOfMonth}`}return Te}const te=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var le=Ll(),Y=mt(le),G=u(Y),he=f(u(G),2),pe=u(he),k=f(u(pe),2),m=f(pe,2);m.__click=function(...x){var L;(L=e.onCreate)==null||L.apply(this,x)};var E=f(G,2),R=u(E),B=u(R),W=u(B),$=f(B,2),ce=u($);ce.__click=()=>e.onBulkEnable([...r(o)]);var oe=f(ce,2);oe.__click=()=>e.onBulkDisable([...r(o)]);var ke=f(oe,2);ke.__click=()=>y(s,!0);var Ee=f(R,2);{var ye=x=>{var L=ql();D(x,L)},Ae=x=>{var L=Nl(),ve=u(L);{var de=we=>{var qe=Ol(),Ce=u(qe),Ve=u(Ce);U(Pe=>z(Ve,`No tasks match "${Pe??""}".`),[()=>r(i).trim()]),D(we,qe)},Te=we=>{var qe=Bl(),Ce=u(qe),Ve=u(Ce),Pe=u(Ve),lt=u(Pe);lt.__click=I,Gn(lt,ct=>y(d,ct),()=>r(d));var xt=f(Ce);ze(xt,23,()=>r(h),ct=>ct.id,(ct,ge,st)=>{var je=Rl();je.__keydown=Ke=>F(Ke,r(st));var Gt=u(je),dt=u(Gt);dt.__click=()=>C(r(ge).id);var Jt=f(Gt),$n=u(Jt),P=f(Jt),J=u(P),_e=f(P),Se=u(_e),Qe=f(_e),We=u(Qe),It=u(We);It.__change=()=>e.onToggleEnabled(r(ge));var Mt=f(Qe),Tt=u(Mt),Zt=u(Tt);Zt.__click=()=>e.onEdit(r(ge));var On=f(Zt,2);On.__click=()=>e.onDuplicate(r(ge));var St=f(On,2);St.__click=()=>p(r(ge)),Gn(je,(Ke,$t)=>l[$t]=Ke,Ke=>l==null?void 0:l[Ke],()=>[r(st)]),U((Ke,$t,Rn,Bn)=>{pt(je,1,zo(r(ge).enabled?"":"disabled"),"svelte-i091qn"),xe(je,"tabindex",r(st)===r(c)?0:-1),xe(je,"aria-selected",Ke),xe(dt,"aria-label",`Select ${r(ge).name}`),rs(dt,$t),z($n,r(ge).name),z(J,Rn),z(Se,Bn),rs(It,r(ge).enabled)},[()=>r(o).has(r(ge).id),()=>r(o).has(r(ge).id),()=>ua(new Date(r(ge).dueAt)),()=>ee(r(ge))]),gt("focus",je,()=>y(c,r(st),!0)),D(ct,je)}),U(()=>{rs(lt,r(O)),lt.disabled=r(h).length===0}),D(we,qe)};Q(ve,we=>{r(h).length===0?we(de):we(Te,!1)})}D(x,L)};Q(Ee,x=>{r(v).length===0?x(ye):x(Ae,!1)})}var De=f(Y,2);{var be=x=>{var L=zl(),ve=u(L),de=f(u(ve),2),Te=u(de),we=f(de,2),qe=u(we);qe.__click=A;var Ce=f(qe,2);Ce.__click=w,U(()=>z(Te,`Are you sure you want to delete "${r(t).name??""}"? This action cannot be undone.`)),D(x,L)};Q(De,x=>{r(t)&&x(be)})}var nt=f(De,2);{var bt=x=>{var L=Fl(),ve=u(L),de=f(u(ve),2),Te=u(de),we=f(de,2),qe=u(we);qe.__click=K;var Ce=f(qe,2);Ce.__click=j,U(()=>z(Te,`Are you sure you want to delete ${r(o).size??""} task${r(o).size===1?"":"s"}? This action cannot be undone.`)),D(x,L)};Q(nt,x=>{r(s)&&x(bt)})}U(()=>{k.disabled=r(v).length===0,z(W,`${r(o).size??""} selected`),ce.disabled=!r(b),oe.disabled=!r(b),ke.disabled=!r(b)}),kt(k,()=>r(a),x=>y(a,x)),D(n,le),tt()}Ct(["click","keydown","change"]);var jl=M('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Kl=M('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Ul=M('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Hl=M('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Yl=M('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Vl=M('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Ql=M('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Wl=M('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Xl(n,e){et(e,!0);let t=In(e,"days",3,30);function s(w){const{frequency:A}=w;if(A.type==="weekly"){const C=[...A.weekdays].sort((I,N)=>I-N).join(",");return`weekly:${A.interval}:${A.time??""}:${C}`}return A.type==="monthly"?`monthly:${A.interval}:${A.time??""}:${A.dayOfMonth}`:A.type==="yearly"?`yearly:${A.interval}:${A.time??""}:${A.month}:${A.dayOfMonth}`:`daily:${A.interval}:${A.time??""}`}function a(w,A){const C=w.map(I=>`${I.id}:${I.enabled}:${I.dueAt}:${s(I)}`).join("|");return`${A}:${C}`}function i(w,A){const C=va(new Date),I=fl(ds(C,A-1)),N=24*60*60*1e3,j=_l(C,A).map(K=>({date:K,tasks:[]}));for(const K of w.filter(ee=>ee.enabled)){const ee=new Date(K.dueAt),te=e.recurrenceEngine.getOccurrencesInRange(C,I,K.frequency,ee);for(const le of te){const Y=va(le),G=Math.floor((Y.getTime()-C.getTime())/N);G>=0&&G<A&&j[G].tasks.push({task:K,occurrence:le})}}for(const K of j)K.tasks.sort((ee,te)=>ee.occurrence.getTime()-te.occurrence.getTime());return j}const o=(()=>{let w="",A=[];return{get(C,I){const N=a(C,I);return N===w||(w=N,A=i(C,I)),A}}})(),c=X(()=>o.get(e.tasks,t())),l=X(()=>r(c).some(w=>w.tasks.length>0));var d=Wl(),v=u(d),h=f(u(v),2),_=u(h),b=f(v,2),O=u(b);{var q=w=>{var A=jl(),C=u(A),I=u(C);U(()=>z(I,`No tasks scheduled in the next ${t()??""} days.`)),D(w,A)},p=w=>{var A=Ql();ze(A,21,()=>r(c),C=>C.date.toISOString(),(C,I)=>{var N=cn(),F=mt(N);{var j=K=>{var ee=Vl(),te=u(ee),le=u(te),Y=u(le),G=f(le,2),he=u(G),pe=f(te,2);ze(pe,21,()=>r(I).tasks,({task:k,occurrence:m})=>k.id+m.toISOString(),(k,m)=>{let E=()=>r(m).task,R=()=>r(m).occurrence;var B=Yl(),W=u(B),$=u(W),ce=f(W,2),oe=u(ce),ke=u(oe),Ee=f(oe,2),ye=u(Ee);{var Ae=x=>{var L=Kl(),ve=u(L);U(()=>z(ve,`üîó ${E().linkedBlockId??""}`)),D(x,L)};Q(ye,x=>{E().linkedBlockId&&x(Ae)})}var De=f(ye,2);{var be=x=>{var L=Ul(),ve=u(L);U(()=>z(ve,`‚ö° ${E().priority??""}`)),D(x,L)};Q(De,x=>{E().priority&&x(be)})}var nt=f(De,2);{var bt=x=>{var L=Hl(),ve=u(L);U(de=>z(ve,`üè∑Ô∏è ${de??""}`),[()=>E().tags.join(", ")]),D(x,L)};Q(nt,x=>{var L;(L=E().tags)!=null&&L.length&&x(bt)})}U(x=>{z($,x),z(ke,E().name)},[()=>ll(R())]),D(k,B)}),U((k,m)=>{z(Y,k),z(he,m)},[()=>cl(r(I).date),()=>r(I).date.toLocaleDateString(void 0,{weekday:"short"})]),D(K,ee)};Q(F,K=>{r(I).tasks.length>0&&K(j)})}D(C,N)}),D(w,A)};Q(O,w=>{r(l)?w(p,!1):w(q)})}U(()=>z(_,`Next ${t()??""} days`)),D(n,d),tt()}var Gl=M('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),Jl=M('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Zl=M('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),$l=M('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),ec=M('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),tc=M('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),nc=M('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),sc=M('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),ac=M('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),ic=M('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function rc(n,e){et(e,!0);const t=X(()=>()=>{let k=0,m=0;for(const B of e.tasks)k+=B.completionCount||0,m+=B.missCount||0;const E=k+m,R=E>0?k/E*100:100;return{totalCompletions:k,totalMisses:m,completionRate:Math.round(R)}}),s=X(()=>()=>[...e.tasks].filter(k=>(k.currentStreak||0)>0).sort((k,m)=>(m.currentStreak||0)-(k.currentStreak||0)).slice(0,10)),a=X(()=>()=>[...e.tasks].map(k=>({task:k,health:vr(k)})).sort((k,m)=>k.health-m.health)),i=X(()=>()=>r(a)().slice(-5).reverse()),o=X(()=>()=>r(a)().slice(0,5)),c=X(()=>()=>{const k=[];for(const m of e.tasks)if(m.recentCompletions&&m.recentCompletions.length>0)for(const E of m.recentCompletions)k.push({task:m,completedAt:E});return k.sort((m,E)=>new Date(E.completedAt).getTime()-new Date(m.completedAt).getTime()).slice(0,10)});function l(k){return new Date(k).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function d(k){return k>=80?"#10b981":k>=60?"#3b82f6":k>=40?"#f59e0b":"#ef4444"}var v=ic(),h=f(u(v),2),_=u(h),b=f(u(_),2),O=u(b),q=u(O),p=u(q),w=f(O,2),A=u(w),C=u(A),I=f(w,2),N=u(I),F=u(N),j=f(_,2);{var K=k=>{var m=Zl(),E=f(u(m),2);ze(E,21,()=>r(s)(),Nt,(R,B,W)=>{var $=Jl(),ce=u($);ce.textContent=`#${W+1}`;var oe=f(ce,2),ke=u(oe),Ee=f(oe,2),ye=u(Ee),Ae=f(ye);{var De=be=>{var nt=Gl();D(be,nt)};Q(Ae,be=>{r(B).bestStreak&&r(B).currentStreak===r(B).bestStreak&&be(De)})}U(()=>{z(ke,r(B).name),z(ye,`${r(B).currentStreak??""} day${r(B).currentStreak!==1?"s":""} `)}),D(R,$)}),D(k,m)};Q(j,k=>{r(s)().length>0&&k(K)})}var ee=f(j,2),te=f(u(ee),2);{var le=k=>{var m=ec(),E=f(mt(m),2);ze(E,21,()=>r(i)(),Nt,(R,B)=>{let W=()=>r(B).task,$=()=>r(B).health;var ce=$l(),oe=u(ce),ke=u(oe),Ee=f(oe,2),ye=u(Ee),Ae=f(ye,2),De=u(Ae);U(be=>{z(ke,W().name),An(ye,`width: ${$()??""}%; background-color: ${be??""}`),z(De,`${$()??""}/100`)},[()=>d($())]),D(R,ce)}),D(k,m)};Q(te,k=>{r(i)().length>0&&k(le)})}var Y=f(te,2);{var G=k=>{var m=nc(),E=f(mt(m),2);ze(E,21,()=>r(o)(),Nt,(R,B)=>{let W=()=>r(B).task,$=()=>r(B).health;var ce=tc(),oe=u(ce),ke=u(oe),Ee=f(oe,2),ye=u(Ee),Ae=f(ye,2),De=u(Ae);U(be=>{z(ke,W().name),An(ye,`width: ${$()??""}%; background-color: ${be??""}`),z(De,`${$()??""}/100`)},[()=>d($())]),D(R,ce)}),D(k,m)};Q(Y,k=>{r(o)().length>0&&r(o)()[0].health<80&&k(G)})}var he=f(ee,2);{var pe=k=>{var m=ac(),E=f(u(m),2);ze(E,21,()=>r(c)(),Nt,(R,B)=>{let W=()=>r(B).task,$=()=>r(B).completedAt;var ce=sc(),oe=f(u(ce),2),ke=u(oe),Ee=u(ke),ye=f(ke,2),Ae=u(ye);U(De=>{z(Ee,W().name),z(Ae,De)},[()=>l($())]),D(R,ce)}),D(k,m)};Q(he,k=>{r(c)().length>0&&k(pe)})}U((k,m,E)=>{z(p,k),z(C,m),z(F,`${E??""}%`)},[()=>r(t)().totalCompletions,()=>r(t)().totalMisses,()=>r(t)().completionRate]),D(n,v),tt()}class fa{static parse(e){const t=e,s=e.trim().toLowerCase();if(!s)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const a=s.match(/^every\s+(.+)$/);if(!a)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};const i=a[1];if(i==="weekday"||i==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4]},raw:t,isValid:!0};if(i==="weekend"||i==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6]},raw:t,isValid:!0};const o=i.match(/^(\d+\s+)?days?$/);if(o)return{frequency:{type:"daily",interval:o[1]?parseInt(o[1]):1},raw:t,isValid:!0};const c=i.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(c){const v=c[1]?parseInt(c[1]):1,h=c[2];if(!h)return{frequency:{type:"weekly",interval:v,weekdays:[1]},raw:t,isValid:!0};const _=this.parseDayNames(h);return _.length===0?{frequency:{type:"weekly",interval:v,weekdays:[1]},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:v,weekdays:_},raw:t,isValid:!0}}const l=i.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(l){const v=l[1]?parseInt(l[1]):1,h=l[2]?parseInt(l[2]):1;return h<1||h>31?{frequency:{type:"monthly",interval:v,dayOfMonth:1},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:v,dayOfMonth:h},raw:t,isValid:!0}}const d=i.match(/^(\d+\s+)?years?$/);return d?{frequency:{type:"yearly",interval:d[1]?parseInt(d[1]):1,month:0,dayOfMonth:1},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=e.interval;switch(e.type){case"daily":return t===1?"every day":`every ${t} days`;case"weekly":{const s=t===1?"week":`${t} weeks`;if(e.weekdays.length===0)return`every ${s}`;const a=e.weekdays.map(i=>this.getDayName(i)).join(", ");return`every ${s} on ${a}`}case"monthly":{const s=t===1?"month":`${t} months`,a=this.getDaySuffix(e.dayOfMonth);return`every ${s} on the ${e.dayOfMonth}${a}`}case"yearly":return`every ${t===1?"year":`${t} years`}`;default:return"every day"}}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},s=e.split(",").map(i=>i.trim().toLowerCase()),a=[];for(const i of s)i in t&&a.push(t[i]);return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var oc=M('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),lc=M('<div class="priority-selector svelte-1w15n9q"></div>');function cc(n,e){et(e,!0);let t=In(e,"value",15,"normal");const s=[{value:"urgent",label:"Urgent",emoji:"üî¥",color:"var(--b3-theme-error, #ff4444)"},{value:"high",label:"High",emoji:"üü†",color:"#ff8800"},{value:"normal",label:"Normal",emoji:"üü°",color:"#ffcc00"},{value:"low",label:"Low",emoji:"üü¢",color:"#44cc44"}];function a(o){t(o),e.onchange(o)}var i=lc();ze(i,21,()=>s,Nt,(o,c)=>{var l=oc();let d;var v=u(l);v.__change=()=>a(r(c).value);var h=f(v,2),_=u(h),b=f(h,2),O=u(b);U(()=>{d=pt(l,1,"priority-selector__option svelte-1w15n9q",null,d,{active:t()===r(c).value}),An(l,`--priority-color: ${r(c).color??""}`),or(v,r(c).value),rs(v,t()===r(c).value),z(_,r(c).emoji),z(O,r(c).label)}),D(o,l)}),D(n,i),tt()}Ct(["change"]);var dc=M('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),uc=M('<div class="status-selector svelte-v9ezc0"></div>');function vc(n,e){et(e,!0);let t=In(e,"value",15,"todo");const s=[{value:"todo",label:"Todo",icon:"‚óã",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"‚úì",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"‚úï",color:"#999"}];function a(o){t(o),e.onchange(o)}var i=uc();ze(i,21,()=>s,Nt,(o,c)=>{var l=dc();let d;var v=u(l);v.__change=()=>a(r(c).value);var h=f(v,2),_=u(h),b=f(h,2),O=u(b);U(()=>{d=pt(l,1,"status-selector__option svelte-v9ezc0",null,d,{active:t()===r(c).value}),An(l,`--status-color: ${r(c).color??""}`),or(v,r(c).value),rs(v,t()===r(c).value),z(_,r(c).icon),z(O,r(c).label)}),D(o,l)}),D(n,i),tt()}Ct(["change"]);var fc=M('<div class="recurrence-input__valid svelte-787fjp">‚úì Valid recurrence pattern</div>'),hc=M('<div class="recurrence-input__error svelte-787fjp"> </div>'),_c=M('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),mc=M('<li class="svelte-787fjp"> </li>'),kc=M('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),gc=M('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function pc(n,e){et(e,!0);let t=In(e,"value",15,""),s=In(e,"showPreview",3,!0);const a=X(()=>fa.parse(t())),i=X(()=>r(a).isValid),o=X(()=>r(a).error);function c(w,A=3){const C=[],I=new Date;for(let N=0;N<A;N++){const F=new Date(I);switch(w.type){case"daily":F.setDate(I.getDate()+N*w.interval);break;case"weekly":F.setDate(I.getDate()+N*w.interval*7);break;case"monthly":F.setMonth(I.getMonth()+N*w.interval);break;case"yearly":F.setFullYear(I.getFullYear()+N*w.interval);break}C.push(F.toLocaleDateString())}return C}const l=X(()=>r(i)&&s()?c(r(a).frequency):[]);function d(w){const C=w.target.value;t(C);const I=fa.parse(C);e.onchange(C,I.isValid?I.frequency:null,I.isValid)}var v=gc(),h=u(v);let _;h.__input=d;var b=f(h,2);{var O=w=>{var A=_c(),C=u(A);{var I=F=>{var j=fc();D(F,j)},N=F=>{var j=hc(),K=u(j);U(()=>z(K,`‚ö† ${(r(o)||"Invalid recurrence pattern")??""}`)),D(F,j)};Q(C,F=>{r(i)?F(I):F(N,!1)})}D(w,A)};Q(b,w=>{t().length>0&&w(O)})}var q=f(b,2);{var p=w=>{var A=kc(),C=f(u(A),2);ze(C,21,()=>r(l),Nt,(I,N)=>{var F=mc(),j=u(F);U(()=>z(j,r(N))),D(I,F)}),D(w,A)};Q(q,w=>{r(i)&&s()&&r(l).length>0&&w(p)})}U(()=>{_=pt(h,1,"recurrence-input__field svelte-787fjp",null,_,{valid:r(i),invalid:!r(i)&&t().length>0}),xe(h,"aria-invalid",!r(i)&&t().length>0)}),kt(h,t),D(n,v),tt()}Ct(["input"]);var yc=M('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">‚úï</button></div>'),wc=M('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),bc=M('<span class="dependency-picker__option-check svelte-10ls0lk">‚úì</span>'),Tc=M('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Sc=M('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),Ec=M('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function ai(n,e){et(e,!0);let t=In(e,"selected",31,()=>me([])),s=In(e,"label",3,"Select tasks"),a=H(""),i=H(!1);const o=X(()=>e.repository.getAllTasks().filter(F=>F.id!==e.excludeId)),c=X(()=>r(a).trim()?r(o).filter(F=>F.name.toLowerCase().includes(r(a).toLowerCase())):r(o)),l=X(()=>r(o).filter(F=>t().includes(F.id)));function d(F){if(!t().includes(F)){const j=[...t(),F];t(j),e.onchange(j)}y(a,""),y(i,!1)}function v(F){const j=t().filter(K=>K!==F);t(j),e.onchange(j)}function h(){y(i,!0)}function _(){setTimeout(()=>{y(i,!1)},200)}var b=Ec(),O=u(b),q=u(O),p=f(O,2);{var w=F=>{var j=wc();ze(j,21,()=>r(l),K=>K.id,(K,ee)=>{var te=yc(),le=u(te),Y=u(le),G=f(le,2);G.__click=()=>v(r(ee).id),U(()=>{z(Y,r(ee).name),xe(G,"aria-label",`Remove ${r(ee).name??""}`)}),D(K,te)}),D(F,j)};Q(p,F=>{r(l).length>0&&F(w)})}var A=f(p,2),C=u(A),I=f(C,2);{var N=F=>{var j=Sc();ze(j,21,()=>r(c).slice(0,10),K=>K.id,(K,ee)=>{var te=Tc();let le;te.__click=()=>d(r(ee).id);var Y=u(te),G=u(Y),he=f(Y,2);{var pe=k=>{var m=bc();D(k,m)};Q(he,k=>{t().includes(r(ee).id)&&k(pe)})}U((k,m)=>{le=pt(te,1,"dependency-picker__option svelte-10ls0lk",null,le,k),te.disabled=m,z(G,r(ee).name)},[()=>({selected:t().includes(r(ee).id)}),()=>t().includes(r(ee).id)]),D(K,te)}),D(F,j)};Q(I,F=>{r(i)&&r(c).length>0&&F(N)})}U(()=>z(q,s())),gt("focus",C,h),gt("blur",C,_),kt(C,()=>r(a),F=>y(a,F)),D(n,b),tt()}Ct(["click"]);var Dc=M('<div class="task-editor__error svelte-xc3qs9"> </div>'),Ac=M('<div class="task-editor__error svelte-xc3qs9"> </div>'),Cc=M('<div class="task-editor__error svelte-xc3qs9"> </div>'),xc=M('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Ic=M('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Mc=M('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),qc=M('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">‚úï</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">üí° Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">‚åò/Ctrl+Enter</kbd> to save</div></div></div>');function _r(n,e){var St,Ke,$t,Rn,Bn,Ft,en,Nn,ms,ks,Lt,fn;et(e,!0);const t="every day",s="Blocked by (tasks that must complete first)",a="Blocks (tasks that depend on this)",i=!e.task;let o=H(me(((St=e.task)==null?void 0:St.name)||"")),c=H(me(((Ke=e.task)==null?void 0:Ke.description)||"")),l=H(me((($t=e.task)==null?void 0:$t.priority)||"normal")),d=H(me(((Rn=e.task)==null?void 0:Rn.status)||"todo")),v=H(me((Bn=e.task)!=null&&Bn.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),h=H(me((Ft=e.task)!=null&&Ft.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),_=H(me((en=e.task)!=null&&en.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),b=H(me(((Nn=e.task)==null?void 0:Nn.recurrenceText)||((ms=e.task)!=null&&ms.frequency?fa.stringify(e.task.frequency):t))),O=H(me(((ks=e.task)==null?void 0:ks.frequency)||null)),q=H(!0),p=H(me(((Lt=e.task)==null?void 0:Lt.blockedBy)||[])),w=H(me(((fn=e.task)==null?void 0:fn.dependsOn)||[])),A=H(me({name:!1,dueAt:!1,recurrence:!1})),C=H(!1),I=H(null);const N=X(()=>r(A).name&&!r(o).trim()?"Task name is required":""),F=X(()=>r(A).dueAt?r(v)?Number.isNaN(new Date(r(v)).getTime())?"Invalid due date":"":"Due date is required":""),j=X(()=>r(A).recurrence&&!r(q)?"Invalid recurrence pattern":""),K=X(()=>!!(r(N)||r(F)||r(j)));js(()=>{requestAnimationFrame(()=>{var S;(S=r(I))==null||S.focus()})});function ee(S,Z,at){y(b,S,!0),y(O,Z,!0),y(q,at,!0),r(A).recurrence=!0}function te(S){y(l,S,!0)}function le(S){y(d,S,!0)}function Y(S){y(p,S,!0)}function G(S){y(w,S,!0)}async function he(){if(y(A,{name:!0,dueAt:!0,recurrence:!0},!0),r(K)){se.warning("Please fix validation errors");return}if(!r(O)){se.error("Invalid recurrence pattern");return}y(C,!0);try{let S;i?S=cr(r(o).trim(),r(O),new Date(r(v))):(S={...e.task},S.name=r(o).trim(),S.frequency=r(O),S.dueAt=new Date(r(v)).toISOString()),S.description=r(c).trim()||void 0,S.priority=r(l),S.status=r(d),S.recurrenceText=r(b),S.scheduledAt=r(h)?new Date(r(h)).toISOString():void 0,S.startAt=r(_)?new Date(r(_)).toISOString():void 0,S.blockedBy=r(p).length>0?r(p):void 0,S.dependsOn=r(w).length>0?r(w):void 0,S.updatedAt=new Date().toISOString(),r(d)==="done"&&!S.lastCompletedAt&&(S.lastCompletedAt=new Date().toISOString()),r(d)==="cancelled"&&!S.cancelledAt&&(S.cancelledAt=new Date().toISOString()),await e.repository.saveTask(S),e.onSave&&e.onSave(S),se.success(`Task "${S.name}" ${i?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(S){se.error(`Failed to save task: ${S}`)}finally{y(C,!1)}}function pe(S){S.key==="Escape"&&e.onClose(),(S.metaKey||S.ctrlKey)&&S.key==="Enter"&&(S.preventDefault(),he())}function k(S){return S?new Date(S).toLocaleString():"‚Äî"}var m=qc();m.__keydown=pe;var E=u(m),R=u(E),B=u(R),W=u(B),$=f(B,2);$.__click=function(...S){var Z;(Z=e.onClose)==null||Z.apply(this,S)};var ce=f(R,2),oe=u(ce),ke=f(u(oe),2);ke.__input=()=>r(A).name=!0,Gn(ke,S=>y(I,S),()=>r(I));var Ee=f(ke,2);{var ye=S=>{var Z=Dc(),at=u(Z);U(()=>z(at,r(N))),D(S,Z)};Q(Ee,S=>{r(N)&&S(ye)})}var Ae=f(oe,2),De=f(u(Ae),2),be=f(Ae,2),nt=f(u(be),2);cc(nt,{get value(){return r(l)},onchange:te});var bt=f(be,2),x=f(u(bt),2);vc(x,{get value(){return r(d)},onchange:le});var L=f(bt,2),ve=f(u(L),2);ve.__input=()=>r(A).dueAt=!0;var de=f(ve,2);{var Te=S=>{var Z=Ac(),at=u(Z);U(()=>z(at,r(F))),D(S,Z)};Q(de,S=>{r(F)&&S(Te)})}var we=f(L,2),qe=f(u(we),2),Ce=f(we,2),Ve=f(u(Ce),2),Pe=f(Ce,2),lt=f(u(Pe),2);pc(lt,{get value(){return r(b)},onchange:ee,showPreview:!0});var xt=f(lt,2);{var ct=S=>{var Z=Cc(),at=u(Z);U(()=>z(at,r(j))),D(S,Z)};Q(xt,S=>{r(j)&&S(ct)})}var ge=f(Pe,2),st=u(ge);{let S=X(()=>{var Z;return(Z=e.task)==null?void 0:Z.id});ai(st,{get repository(){return e.repository},get selected(){return r(p)},get excludeId(){return r(S)},onchange:Y,label:s})}var je=f(ge,2),Gt=u(je);{let S=X(()=>{var Z;return(Z=e.task)==null?void 0:Z.id});ai(Gt,{get repository(){return e.repository},get selected(){return r(w)},get excludeId(){return r(S)},onchange:G,label:a})}var dt=f(je,2),Jt=u(dt),$n=f(u(Jt),2),P=u($n),J=f(Jt,2);{var _e=S=>{var Z=xc(),at=f(u(Z),2),es=u(at);U(Us=>z(es,Us),[()=>k(e.task.lastCompletedAt)]),D(S,Z)};Q(J,S=>{var Z;(Z=e.task)!=null&&Z.lastCompletedAt&&S(_e)})}var Se=f(J,2);{var Qe=S=>{var Z=Ic(),at=f(u(Z),2),es=u(at);U(Us=>z(es,Us),[()=>k(e.task.cancelledAt)]),D(S,Z)};Q(Se,S=>{var Z;(Z=e.task)!=null&&Z.cancelledAt&&S(Qe)})}var We=f(Se,2);{var It=S=>{var Z=Mc(),at=f(u(Z),2),es=u(at);U(()=>z(es,e.task.linkedBlockId)),D(S,Z)};Q(We,S=>{var Z;(Z=e.task)!=null&&Z.linkedBlockId&&S(It)})}var Mt=f(ce,2),Tt=u(Mt);Tt.__click=function(...S){var Z;(Z=e.onClose)==null||Z.apply(this,S)};var Zt=f(Tt,2);Zt.__click=he;var On=u(Zt);U(S=>{z(W,i?"Create Task":"Edit Task"),xe(ke,"aria-invalid",!!r(N)),xe(ve,"aria-invalid",!!r(F)),z(P,S),Zt.disabled=r(C),z(On,r(C)?"Saving...":i?"Create Task":"Save Changes")},[()=>{var S;return k((S=e.task)==null?void 0:S.createdAt)}]),gt("blur",ke,()=>r(A).name=!0),kt(ke,()=>r(o),S=>y(o,S)),kt(De,()=>r(c),S=>y(c,S)),gt("blur",ve,()=>r(A).dueAt=!0),kt(ve,()=>r(v),S=>y(v,S)),kt(qe,()=>r(h),S=>y(h,S)),kt(Ve,()=>r(_),S=>y(_,S)),D(n,m),tt()}Ct(["keydown","click","input"]);const Oc=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];var Rc=M('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),Bc=M("<div> </div>"),Nc=M('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),zc=M('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),Fc=M('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">n8n Integration</h2> <!></div> <div class="settings__content svelte-1ke3hir"><section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section> <section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section></div> <div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div></div>');function Lc(n,e){et(e,!0);let t=H(me(da)),s=H(null),a=me({});ln(()=>{y(t,e.eventService.getConfig(),!0)});async function i(){try{await e.eventService.saveConfig(r(t)),se.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(Y){se.error("Failed to save settings: "+Y)}}async function o(){y(s,"n8n"),a.n8n={success:!1,message:"Testing..."};try{const Y=await e.eventService.testConnection();a.n8n={success:Y.success,message:Y.success?"Test successful!":Y.message||"Test failed. Check configuration."}}catch(Y){a.n8n={success:!1,message:"Error: "+(Y instanceof Error?Y.message:String(Y))}}finally{y(s,null)}}var c=Fc(),l=u(c),d=f(u(l),2);{var v=Y=>{var G=Rc();G.__click=function(...he){var pe;(pe=e.onClose)==null||pe.apply(this,he)},D(Y,G)};Q(d,Y=>{e.onClose&&Y(v)})}var h=f(l,2),_=u(h),b=u(_),O=f(u(b),2),q=u(O),p=f(b,2),w=f(u(p),2),A=f(p,2),C=f(u(A),2),I=f(A,2);I.__click=o;var N=u(I),F=f(I,2);{var j=Y=>{var G=Bc(),he=u(G);U(()=>{pt(G,1,`settings__test-result ${a.n8n.success?"success":"error"}`,"svelte-1ke3hir"),z(he,a.n8n.message)}),D(Y,G)};Q(F,Y=>{a.n8n&&Y(j)})}var K=f(_,2),ee=f(u(K),2);ze(ee,21,()=>Oc,Nt,(Y,G)=>{var he=zc(),pe=u(he),k=u(pe),m=u(k),E=f(k,2),R=u(E),B=f(E,2);{var W=oe=>{var ke=Nc(),Ee=u(ke);U(()=>z(Ee,r(G).context)),D(oe,ke)};Q(B,oe=>{r(G).context&&oe(W)})}var $=f(pe,2),ce=u($);U(()=>{z(m,r(G).label),z(R,r(G).description),z(ce,r(G).keys)}),D(Y,he)});var te=f(h,2),le=u(te);le.__click=i,U(()=>{w.disabled=!r(t).n8n.enabled,C.disabled=!r(t).n8n.enabled,I.disabled=!r(t).n8n.enabled||r(s)==="n8n",z(N,r(s)==="n8n"?"Testing...":"Test Connection")}),Uo(q,()=>r(t).n8n.enabled,Y=>r(t).n8n.enabled=Y),kt(w,()=>r(t).n8n.webhookUrl,Y=>r(t).n8n.webhookUrl=Y),kt(C,()=>r(t).n8n.sharedSecret,Y=>r(t).n8n.sharedSecret=Y),D(n,c),tt()}Ct(["click"]);var Pc=M('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),jc=M('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Kc=M('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Uc=M('<div class="dashboard__tabs svelte-1y1a8hs"><button>üìã Today & Overdue <!></button> <button>üìù All Tasks <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button> <button>üìÖ Timeline</button> <button>üìä Analytics</button></div> <div class="dashboard__content svelte-1y1a8hs"><!></div>',1),Hc=M('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div> <!></div>');function Yc(n,e){et(e,!0);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let a=H("today"),i=H(!1),o=H(!1),c=H(void 0),l=H(me([])),d=X(()=>al(r(l)));function v(k="initial"){y(l,e.repository.getAllTasks().map(m=>({...m})),!0),k!=="initial"&&se.info("Task list reloaded")}v();const h=()=>v("reload");js(()=>{window.addEventListener("recurring-task-refresh",h)}),Yo(()=>{window.removeEventListener("recurring-task-refresh",h)});async function _(k){Ge.emit("task:complete",{taskId:k.id})}async function b(k){const m=r(l),E=Zs(r(l),k.id,R=>{const B={...R},W=new Date(B.dueAt),$=t.tomorrow();return $.setHours(W.getHours(),W.getMinutes(),0,0),B.dueAt=$.toISOString(),B.snoozeCount=(B.snoozeCount||0)+1,B.updatedAt=new Date().toISOString(),B});y(l,E,!0),se.info(`Task "${k.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task.snoozed",k),await e.scheduler.delayToTomorrow(k.id)}catch(R){y(l,m,!0),se.error("Failed to delay task: "+R),v("external")}}async function O(k){var E;if(!((E=k.name)!=null&&E.trim())){se.error("Task name is required");return}if(!lr(k.frequency)){se.error("Invalid frequency configuration");return}const m={...k};y(l,ti(r(l),m),!0),y(i,!1),y(c,void 0),se.success(`Task "${k.name}" saved successfully`),e.repository.saveTask(m).catch(R=>{se.error("Failed to save task: "+R),v("external")})}async function q(k){const m=r(l);y(l,ni(r(l),k.id),!0);const E=window.setTimeout(async()=>{try{await e.repository.deleteTask(k.id)}catch(R){y(l,m,!0),se.error("Failed to delete task: "+R),v("external")}},5e3);kn({message:`Task "${k.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(E),y(l,m,!0),se.info(`Restored "${k.name}"`)},showCountdown:!0})}async function p(k){const m=k.name.endsWith(" (copy)")?`${k.name} ${new Date().toLocaleDateString()}`:`${k.name} (copy)`,E=el(k,{name:m});y(l,ti(r(l),E),!0),se.success(`Duplicated "${k.name}"`),e.repository.saveTask(E).catch(R=>{y(l,ni(r(l),E.id),!0),se.error("Failed to duplicate task: "+R),v("external")})}async function w(k){const m=!k.enabled,E={...k,enabled:m},R=Zs(r(l),k.id,()=>E);y(l,R,!0),se.info(`Task ${m?"enabled":"disabled"}`),e.repository.saveTask(E).catch(B=>{se.error("Failed to update task: "+B),v("external")})}async function A(k,m){if(k.length===0)return;const E=r(l),R=new Set(k),B=r(l).map(W=>R.has(W.id)?{...W,enabled:m}:W);y(l,B,!0),se.info(`${m?"Enabled":"Disabled"} ${k.length} task${k.length===1?"":"s"}`);try{const W=B.filter($=>R.has($.id));await Promise.all(W.map($=>e.repository.saveTask($)))}catch(W){y(l,E,!0),se.error(`Failed to ${m?"enable":"disable"} tasks: ${W}`),v("external")}}async function C(k){if(k.length===0)return;const m=r(l),E=new Set(k),R=r(l).filter(W=>E.has(W.id));y(l,r(l).filter(W=>!E.has(W.id)),!0);const B=window.setTimeout(async()=>{try{await Promise.all(R.map(W=>e.repository.deleteTask(W.id)))}catch(W){y(l,m,!0),se.error("Failed to delete tasks: "+W),v("external")}},5e3);kn({message:`${R.length} task${R.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(B),y(l,m,!0),se.info("Bulk delete undone")},showCountdown:!0})}function I(k){y(c,k,!0),y(i,!0)}function N(){y(c,void 0),y(i,!0)}function F(){y(i,!1),y(c,void 0)}function j(){y(o,!0)}function K(){y(o,!1)}async function ee(k){const m=r(l),E=Zs(r(l),k.id,R=>{const B={...R};ur(B);const W=s.calculateNext(new Date(B.dueAt),B.frequency);return B.dueAt=W.toISOString(),B});y(l,E,!0),se.info(`Task "${k.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",k),await e.scheduler.skipTaskOccurrence(k.id)}catch(R){y(l,m,!0),se.error("Failed to skip task: "+R),v("external")}}var te=Hc(),le=u(te),Y=f(u(le),2);Y.__click=j;var G=f(le,2);{var he=k=>{var m=Pc(),E=u(m);Lc(E,{get eventService(){return e.eventService},onClose:K}),D(k,m)},pe=k=>{var m=cn(),E=mt(m);{var R=W=>{var $=jc(),ce=u($);_r(ce,{get task(){return r(c)},get repository(){return e.repository},onSave:O,onClose:F}),D(W,$)},B=W=>{var $=Uc(),ce=mt($),oe=u(ce);oe.__click=()=>y(a,"today");var ke=f(u(oe));{var Ee=de=>{var Te=Kc(),we=u(Te);U(()=>z(we,r(d).length)),D(de,Te)};Q(ke,de=>{r(d).length>0&&de(Ee)})}var ye=f(oe,2);ye.__click=()=>y(a,"all");var Ae=f(u(ye)),De=u(Ae),be=f(ye,2);be.__click=()=>y(a,"timeline");var nt=f(be,2);nt.__click=()=>y(a,"analytics");var bt=f(ce,2),x=u(bt);{var L=de=>{Ml(de,{get tasks(){return r(d)},onDone:_,onDelay:b,onSkip:ee,onEdit:I,get timezoneHandler(){return t}})},ve=de=>{var Te=cn(),we=mt(Te);{var qe=Ve=>{Pl(Ve,{get tasks(){return r(l)},onEdit:I,onDelete:q,onDuplicate:p,onToggleEnabled:w,onBulkEnable:Pe=>A(Pe,!0),onBulkDisable:Pe=>A(Pe,!1),onBulkDelete:C,onCreate:N})},Ce=Ve=>{var Pe=cn(),lt=mt(Pe);{var xt=ge=>{{let st=X(()=>e.scheduler.getRecurrenceEngine());Xl(ge,{get tasks(){return r(l)},get recurrenceEngine(){return r(st)}})}},ct=ge=>{var st=cn(),je=mt(st);{var Gt=dt=>{rc(dt,{get tasks(){return r(l)}})};Q(je,dt=>{r(a)==="analytics"&&dt(Gt)},!0)}D(ge,st)};Q(lt,ge=>{r(a)==="timeline"?ge(xt):ge(ct,!1)},!0)}D(Ve,Pe)};Q(we,Ve=>{r(a)==="all"?Ve(qe):Ve(Ce,!1)},!0)}D(de,Te)};Q(x,de=>{r(a)==="today"?de(L):de(ve,!1)})}U(()=>{pt(oe,1,`dashboard__tab ${r(a)==="today"?"active":""}`,"svelte-1y1a8hs"),pt(ye,1,`dashboard__tab ${r(a)==="all"?"active":""}`,"svelte-1y1a8hs"),z(De,r(l).length),pt(be,1,`dashboard__tab ${r(a)==="timeline"?"active":""}`,"svelte-1y1a8hs"),pt(nt,1,`dashboard__tab ${r(a)==="analytics"?"active":""}`,"svelte-1y1a8hs")}),D(W,$)};Q(E,W=>{r(i)?W(R):W(B,!1)},!0)}D(k,m)};Q(G,k=>{r(o)?k(he):k(pe,!1)})}D(n,te),tt()}Ct(["click"]);var Vc=M('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Qc=M('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Wc=M('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),Xc=M('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),Gc=M('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function Jc(n,e){var k;et(e,!0);let t=H(me(((k=e.prefill)==null?void 0:k.suggestedName)??"")),s=H(me(new Date().toISOString().slice(0,16))),a=H(me({name:!1,dueAt:!1})),i=H(!1),o=H(null);const c=X(()=>r(a).name&&!r(t).trim()?"Task name is required.":""),l=X(()=>r(a).dueAt?r(s)?Number.isNaN(new Date(r(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),d=X(()=>!!(r(c)||r(l)));js(()=>{var m;if((m=e.prefill)!=null&&m.suggestedTime){const E=new Date,[R,B]=e.prefill.suggestedTime.split(":").map(Number);E.setHours(R,B,0,0),y(s,E.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var E;(E=r(o))==null||E.focus()})});async function v(){var B,W;if(y(a,{name:!0,dueAt:!0},!0),r(d)){se.warning("Please fill out the required fields.");return}const m=Qo(),E=r(s).slice(11,16);if(m.time=E,!lr(m)){se.error("Invalid frequency configuration.");return}const R=cr(r(t).trim(),m,new Date(r(s)));R.linkedBlockId=((B=e.prefill)==null?void 0:B.linkedBlockId)||void 0,R.linkedBlockContent=((W=e.prefill)==null?void 0:W.linkedBlockContent)||void 0,y(i,!0);try{await e.repository.saveTask(R),se.success(`Task "${R.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch($){se.error("Failed to create task: "+$)}finally{y(i,!1)}}function h(m){m.key==="Escape"&&e.onClose(),(m.metaKey||m.ctrlKey)&&m.key==="Enter"&&(m.preventDefault(),v())}var _=Gc();_.__keydown=h;var b=u(_),O=u(b),q=f(u(O),2);q.__click=function(...m){var E;(E=e.onClose)==null||E.apply(this,m)};var p=f(O,2),w=f(u(p),2);w.__input=()=>r(a).name=!0,Gn(w,m=>y(o,m),()=>r(o));var A=f(w,2);{var C=m=>{var E=Vc(),R=u(E);U(()=>z(R,r(c))),D(m,E)};Q(A,m=>{r(c)&&m(C)})}var I=f(p,2),N=f(u(I),2);N.__input=()=>r(a).dueAt=!0;var F=f(N,2);{var j=m=>{var E=Qc(),R=u(E);U(()=>z(R,r(l))),D(m,E)};Q(F,m=>{r(l)&&m(j)})}var K=f(I,2);{var ee=m=>{var E=Wc(),R=f(u(E)),B=u(R);U(()=>z(B,e.prefill.linkedBlockId)),D(m,E)};Q(K,m=>{var E;(E=e.prefill)!=null&&E.linkedBlockId&&m(ee)})}var te=f(K,2),le=u(te);le.__click=function(...m){var E;(E=e.onClose)==null||E.apply(this,m)};var Y=f(le,2);{var G=m=>{var E=Xc();E.__click=function(...R){var B;(B=e.onAdvanced)==null||B.apply(this,R)},D(m,E)};Q(Y,m=>{e.onAdvanced&&m(G)})}var he=f(Y,2);he.__click=v;var pe=u(he);U(()=>{xe(w,"aria-invalid",!!r(c)),xe(N,"aria-invalid",!!r(l)),he.disabled=r(i),z(pe,r(i)?"Saving‚Ä¶":"Create Task")}),gt("blur",w,()=>r(a).name=!0),kt(w,()=>r(t),m=>y(t,m)),gt("blur",N,()=>r(a).dueAt=!0),kt(N,()=>r(s),m=>y(s,m)),D(n,_),tt()}Ct(["keydown","click","input"]);class Zc{constructor(e){T(this,"plugin");this.plugin=e}getCurrentVersion(){return Ss}async createBackup(e){try{const t=await this.plugin.loadData(e);if(t){const s=`${e}-backup-${Date.now()}`;await this.plugin.saveData(s,t),V(`Created backup: ${s}`)}}catch(t){throw ue("Failed to create backup",t),t}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t){V("No data to migrate");return}const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0){V("No data to migrate");return}let a=!1;for(let i=0;i<s.length;i++){const o=s[i],c=o.version||0;c<Ss&&(a||(await this.createBackup(e),a=!0),s[i]=this.migrateTask(o,c),V(`Migrated task ${o.id} from v${c} to v${Ss}`))}if(a){const i=Array.isArray(t)?s:{...t,tasks:s};await this.plugin.saveData(e,i),V(`Migration complete: ${s.length} tasks processed`)}else V("No migration needed - all tasks up to date")}catch(t){throw ue("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),s}}class $c{constructor(e,t=50){T(this,"pendingState",null);T(this,"writeInProgress",!1);T(this,"scheduledTimer",null);T(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){ue("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return ue("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const ha={},ed=Object.freeze(Object.defineProperty({__proto__:null,default:ha},Symbol.toStringTag,{value:"Module"})),ii=new Set;function Ds(n){const e=`${n.feature}:${n.capability}:${n.message}`;ii.has(e)||(ii.add(e),Fe(n.message,{feature:n.feature,capability:n.capability,cause:n.cause}))}class mr extends Error{constructor(t,s,a){super(a);T(this,"capability");T(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class kr extends Error{constructor(t,s,a,i){super(a);T(this,"capability");T(this,"feature");T(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=i}}class td{constructor(e=globalThis){T(this,"supportedCapabilities");T(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,a;return typeof((a=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:a.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(a){throw new kr("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",a)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new mr("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const nd=".tmp";class sd{constructor(e,t){T(this,"plugin");T(this,"apiAdapter");T(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(mn);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){ue("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),V(`Saved ${e.tasks.length} active tasks`)}catch(t){throw ue("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(mn,e);return}const s=this.resolveStoragePath(mn);if(!s){await this.plugin.saveData(mn,e);return}const a=ha.dirname(s);await t.mkdir(a,{recursive:!0});const i=`${s}${nd}`,o=JSON.stringify(e),c=await t.open(i,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(i,s)}catch{await t.rm(s,{force:!0}),await t.rename(i,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>ed);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Fe("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Ds({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):ha.join(t,"storage",`p${s}`,`${e}.json`)}}const ri=1,oi=1e3;class ad{constructor(e){T(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[a,i]of s.entries())await this.appendTasksToYear(t,a,i);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),a=[];for(const c of s){const l=await this.loadChunk(c.key);if(l)for(const d of l.tasks)this.matchesQuery(d,e)&&a.push(d)}const i=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??a.length;return a.slice(i,i+o)}async loadIndex(){try{const e=await this.plugin.loadData(Ts);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??ri,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){ue("Failed to load archive index",e)}return{version:ri,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Ts,e)}catch(t){throw ue("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Ts}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){ue("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw ue("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const a=this.getCompletionTimestamp(s),i=new Date(a).getFullYear(),o=t.get(i);o?o.push(s):t.set(i,[s])}return t}async appendTasksToYear(e,t,s){let a=[...s];for(;a.length>0;){const i=this.findOrCreateChunk(e,t),o=await this.loadChunk(i.key)||{tasks:[]},c=oi-o.tasks.length,l=a.slice(0,c);o.tasks.push(...l),a=a.slice(l.length);const d=this.updateChunkMeta(i,l);i.count=d.count,i.start=d.start,i.end=d.end,await this.saveChunk(i.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const a=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(a&&a.count<oi)return a;const i=a?a.sequence+1:1,o={key:this.buildChunkKey(t,i),year:t,sequence:i,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,a=e.end;for(const i of t){const o=this.getCompletionTimestamp(i);(!s||o<s)&&(s=o),(!a||o>a)&&(a=o)}return{...e,count:e.count+t.length,start:s,end:a}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,a=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(i=>{const o=i.start?new Date(i.start).getTime():null,c=i.end?new Date(i.end).getTime():null;return!(s&&c&&c<s||a&&o&&o>a)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),a=new Date(s).getTime();return!(t.from&&a<new Date(t.from).getTime()||t.to&&a>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class id{constructor(e,t=new td){T(this,"plugin");T(this,"activeTasks");T(this,"blockIndex",new Map);T(this,"taskBlockIndex",new Map);T(this,"dueIndex",new Map);T(this,"activeStore");T(this,"archiveStore");T(this,"persistence");T(this,"blockAttrSyncEnabled",!0);T(this,"blockApi");T(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new sd(e,t),this.archiveStore=new ad(e),this.persistence=new $c(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),V(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));V(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);V(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[a]of this.dueIndex)a<=t&&s.push(...this.getTasksForDueKey(a));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const a of t){const i=this.activeTasks.get(a);if(!i){this.removeStaleDueIndexEntry(e,a,"missing task");continue}if(!i.enabled){this.removeStaleDueIndexEntry(e,a,"task disabled");continue}if(i.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,a,"date mismatch");continue}s.push(i)}return s}removeStaleDueIndexEntry(e,t,s){const a=this.dueIndex.get(e);a&&(a.delete(t),a.size===0&&this.dueIndex.delete(e),Fe("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),s=this.taskBlockIndex.get(e.id);s&&s!==e.linkedBlockId&&(this.blockIndex.delete(s),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),s&&s!==e.linkedBlockId&&await this.clearBlockAttrs(s)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Za]:e.id,[$a]:e.dueAt,[ei]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Za]:"",[$a]:"",[ei]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Ds({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof mr||s instanceof kr?Ds({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Ds({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const a=new Date(s.dueAt);return a>=e&&a<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(mn);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(ja);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(Ka,t),V(`Created legacy backup at ${Ka}`);const a=s.filter(c=>!c.enabled&&c.lastCompletedAt),i=s.filter(c=>!a.includes(c)),o=new Map(i.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),a.length>0&&await this.archiveStore.archiveTasks(a),V("Legacy storage migration complete",{activeCount:i.length,archivedCount:a.length,legacyKey:ja,activeKey:mn,archiveIndexKey:Ts})}}class rd{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}class od{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,a)=>s-a)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t,s){const a=s!=null&&s.whenDone&&(s!=null&&s.completionDate)?s.completionDate:e,{type:i,time:o}=t,c=this.normalizeInterval(t.interval);let l;switch(i){case"daily":l=this.calculateNextDaily(a,c);break;case"weekly":l=this.calculateNextWeekly(a,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":l=this.calculateNextMonthly(a,c,this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;case"yearly":l=this.calculateNextYearly(a,c,this.normalizeMonth(t.month,a.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;default:throw new Error(`Unknown frequency type: ${i}`)}if(o){const{hours:d,minutes:v}=hr(o);if(Number.isFinite(d)&&Number.isFinite(v)){const{date:h,shifted:_}=vl(l,d,v);_&&Fe("DST shift detected while applying recurrence time",{requestedTime:o,original:l.toISOString(),adjusted:h.toISOString()}),l=h}}return l}calculateNextDaily(e,t){return ds(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return si(e,t);const a=this.getMondayIndex(e),i=Math.min(Js,t*14);for(let o=1;o<=i;o++){if(Math.floor((a+o)/7)%t!==0)continue;const l=ds(e,o),d=this.getMondayIndex(l);if(s.includes(d))return l}return Fe("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),si(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const a=s??e.getDate(),i=e.getFullYear(),c=e.getMonth()+t,l=i+Math.floor(c/12),d=(c%12+12)%12,v=new Date(l,d+1,0).getDate(),h=Math.min(a,v),_=new Date(e);return _.setFullYear(l,d,h),_}calculateNextYearly(e,t,s,a){const i=a??e.getDate(),o=e.getFullYear()+t,c=new Date(o,s+1,0).getDate(),l=Math.min(i,c),d=new Date(e);return d.setFullYear(o,s,l),d}getOccurrencesInRange(e,t,s,a){const i=[];let o=new Date(a),c=0;for(;o<=t&&c<Js;)o>=e&&i.push(new Date(o)),o=this.calculateNext(o,s),c++;return i}getMissedOccurrences(e,t,s,a){const i=[];let o=new Date(a),c=0;for(;o<=e&&c<Js;)o=this.calculateNext(o,s),c++;let l=0;for(;o<t&&l<Es;)i.push(new Date(o)),o=this.calculateNext(o,s),l++;return l>=Es&&Fe("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:a.toISOString(),cap:Es}),i}}class ld{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:a}=hr(t);if(!Number.isFinite(s)||!Number.isFinite(a))return new Date(e);const i=new Date(e);return i.setHours(s,a,0,0),i}isSameLocalDay(e,t){const s=new Date(e),a=new Date(t);return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()&&s.getDate()===a.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),a=Math.trunc(s/(1e3*60)),i=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(a)<60?a>0?`in ${a}m`:`${-a}m ago`:Math.abs(i)<24?i>0?`in ${i}h`:`${-i}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class cd{constructor(e){T(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return V(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return Fe(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return Fe("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),V(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return Fe("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(s){return ue("Failed to execute onCompletion action",{taskId:e.id,action:t,error:s}),{success:!1,error:s instanceof Error?s.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return Fe("SiYuan API not available for nested item check"),!1;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return ue("Failed to check for nested items",{blockId:e,error:t}),!0}}}class dd{constructor(e,t){T(this,"intervalMs");T(this,"timeoutId",null);T(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:Da,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class ud{constructor(e,t=Da,s){T(this,"storage");T(this,"recurrenceEngine");T(this,"onCompletionHandler");T(this,"emittedDue",new Set);T(this,"emittedMissed",new Set);T(this,"timezoneHandler");T(this,"isChecking",!1);T(this,"lastCheckStartTime",0);T(this,"plugin",null);T(this,"listeners",{"task:due":new Set,"task:overdue":new Set});T(this,"MAX_EMITTED_ENTRIES",1e3);T(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);T(this,"persistTimeoutId",null);T(this,"emittedStateReady",null);T(this,"timer");this.storage=e,this.recurrenceEngine=new od,this.onCompletionHandler=new cd(s),this.timezoneHandler=new ld,this.plugin=s||null,this.timer=new dd(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),V("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),V("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Fe("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const a=new Date(s.dueAt),i=a<=e;if(i){const c=this.buildOccurrenceKey(s.id,a,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:s.id,dueAt:a,context:"today",task:s}),this.registerEmittedKey("due",c),V(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(i&&e.getTime()-a.getTime()>=Jo&&(!o||o<a)){const c=this.buildOccurrenceKey(s.id,a,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:a,context:"overdue",task:s}),this.registerEmittedKey("missed",c),Fe(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){let e=!1;if(this.emittedDue.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedDue);this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,V(`Cleaned up emittedDue set: ${t.length} -> ${this.emittedDue.size}`)}if(this.emittedMissed.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedMissed);this.emittedMissed=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,V(`Cleaned up emittedMissed set: ${t.length} -> ${this.emittedMissed.size}`)}e&&this.schedulePersistEmittedState()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const s=new Date;t.doneAt=s.toISOString(),tl(t);const a=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(a);const i=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,i);if(o.success||ue(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:i,error:o.error}),o.warnings)for(const d of o.warnings)Fe(d,{taskId:t.id});const c=new Date(t.dueAt),l=this.recurrenceEngine.calculateNext(c,t.frequency,{completionDate:s,whenDone:t.whenDone});t.dueAt=l.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),V(`Task "${t.name}" completed and rescheduled to ${l.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const a=new Date(s.dueAt),i=new Date(a.getTime()+t*60*1e3);s.dueAt=i.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),V(`Task "${s.name}" delayed by ${t} minutes to ${i.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),a=this.timezoneHandler.tomorrow();a.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=a.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),V(`Task "${t.name}" delayed to tomorrow: ${a.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);ur(t);const s=new Date(t.dueAt),a=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=a.toISOString(),await this.storage.saveTask(t),V(`Task "${t.name}" skipped to ${a.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),V("First run detected, no recovery needed");return}V(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const a=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const i of a){const o=this.buildOccurrenceKey(s.id,i,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:i,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(a){ue(`Failed to recover task ${s.id}:`,a)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),V("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let a=s,i=0;for(;a<t&&i<Es;)a=this.recurrenceEngine.calculateNext(a,e.frequency),i++;a>s&&(e.dueAt=a.toISOString(),await this.storage.saveTask(e),V(`Advanced task "${e.name}" to ${a.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Ja);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){ue("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Ja,{timestamp:e.toISOString()})}catch(t){ue("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const a of s)try{const i=a(t);i instanceof Promise&&i.catch(o=>{ue(`Scheduler listener error for ${e}:`,o)})}catch(i){ue(`Scheduler listener error for ${e}:`,i)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Zo,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Ya),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(a=>typeof a=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(a=>typeof a=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),V("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){ue("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Ya,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){ue("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const vd=7,fd=2e3;class hd{constructor(e,t){T(this,"plugin");T(this,"storageKey");T(this,"notifications",new Map);T(this,"escalations",new Map);T(this,"lastCleanup",new Date);T(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),V(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){ue("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,fr("Saved notification state")}catch(e){ue("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>fd&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-vd*24*60*60*1e3);let a=0;for(const[i,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(i),a++);a>0&&(V(`Cleaned up ${a} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function _d(n){return{id:n.id,name:n.name,dueAt:n.dueAt,frequency:n.frequency,linkedBlockId:n.linkedBlockId,linkedBlockContent:n.linkedBlockContent,priority:n.priority,tags:n.tags,notificationChannels:n.notificationChannels,completionCount:n.completionCount,missCount:n.missCount,currentStreak:n.currentStreak,bestStreak:n.bestStreak}}const md=30*1e3,kd=30*60*1e3,hn=500;class gd{constructor(e,t={}){T(this,"plugin");T(this,"config");T(this,"queue",[]);T(this,"dedupeKeys",new Set);T(this,"flushIntervalId",null);T(this,"fetcher");T(this,"notificationState");T(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...da},this.notificationState=t.notificationState??new hd(this.plugin,Wo)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(Ua);e&&(this.config={...da,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(Ua,e)}async loadQueue(){try{const e=await this.plugin.loadData(Ha);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>hn){const s=this.queue.length-hn;this.queue=this.queue.slice(-hn),console.warn(`Event queue trimmed to ${hn} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-Gs);await this.plugin.saveData(Ha,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Go))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const a=this.buildDedupeKey(e,t);if(this.isDuplicate(a))return;const i=this.buildPayload(e,t,a,1,s);await this.sendPayload(i)?(this.markDelivered(a),await this.persistQueue()):this.enqueue(i)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:Va,version:Qa,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const a of this.queue){if(new Date(a.nextAttemptAt).getTime()>e){s.push(a);continue}const i={...a.payload,delivery:{...a.payload.delivery,attempt:a.attempt}};if(await this.sendPayload(i))this.markDelivered(i.delivery.dedupeKey),t=!0;else{const c=a.attempt+1,l=this.getRetryDelay(c);s.push({...a,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,a,i=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:Va,version:Qa,occurredAt:o.toISOString(),task:_d(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:i,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:a}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>Gs){const t=Array.from(this.dedupeKeys).slice(-Gs);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=hn){const s=this.queue.length-hn+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${hn}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=md*Math.pow(2,e-1);return Math.min(t,kd)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,a=s.encode(t),i=s.encode(e),o=await crypto.subtle.importKey("raw",a,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,i);return Array.from(new Uint8Array(c)).map(d=>d.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let a="";this.config.n8n.sharedSecret&&(a=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const i={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return a&&(i["X-Shehab-Signature"]=a),this.config.n8n.sharedSecret&&(i["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),i}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),a=await this.buildHeaders(e),i=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:a,body:s});if(!i.ok)return console.error("n8n webhook failed:",i.statusText),!1;if(t){const o=await i.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const nn=class nn{constructor(e){T(this,"plugin");T(this,"isInitialized",!1);T(this,"storage");T(this,"repository");T(this,"scheduler");T(this,"eventService");this.plugin=e}static getInstance(e){if(!nn.instance){if(!e)return null;nn.instance=new nn(e)}return nn.instance}async initialize(){if(this.isInitialized){Fe("TaskManager already initialized");return}V("Initializing TaskManager"),this.storage=new id(this.plugin),await this.storage.init(),this.repository=new rd(this.storage),this.eventService=new gd(this.plugin),await this.eventService.init(),this.scheduler=new ud(this.storage,Da,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,V("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),V("TaskManager started")}async destroy(){V("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,nn.instance=null,V("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};T(nn,"instance",null);let Ms=nn;function pd(n,e){n.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{yd()}}),n.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{n.openDock()}}),n.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await wd(e)}}),V("Registered slash commands and hotkeys")}function yd(){Ge.emit("task:create",{source:"command"});const n=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(n)}async function wd(n){try{const e=n.getTodayAndOverdueTasks();if(e.length===0){V("No tasks due today");return}const t=e[0];Ge.emit("task:complete",{taskId:t.id});const s=new CustomEvent("recurring-task-complete",{detail:{taskId:t.id}});window.dispatchEvent(s),V(`Quick completing task: ${t.name}`)}catch(e){ue("Failed to quick complete task",e)}}function li(n,e){Ge.emit("task:snooze",{taskId:n,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:n,minutes:e}})),V(`Snoozing task ${n} for ${e} minutes`)}function bd(n){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=va(t),a=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));Ge.emit("task:snooze",{taskId:n,minutes:a}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:n,minutes:a}})),V(`Snoozing task ${n} to tomorrow`)}function Td(n){n.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],a=s==null?void 0:s.getAttribute("data-node-id");if(!a)return;const i=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=n.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Ge.emit("task:create",{source:"block-menu",linkedBlockId:a,linkedBlockContent:i,suggestedName:ci(i),suggestedTime:di(i)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:a,linkedBlockContent:i,suggestedName:ci(i),suggestedTime:di(i)}}))}});try{const d=Ms.getInstance();if(d&&d.isReady()){const h=d.getRepository().getTaskByBlockId(a);if(h){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=n.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{Ge.emit("task:complete",{taskId:h.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:h.id}}))}});const _=[{label:"15 minutes",click:()=>li(h.id,15)},{label:"1 hour",click:()=>li(h.id,60)},{label:"Tomorrow",click:()=>bd(h.id)}];e.menu.addItem({icon:"iconClock",label:((l=n.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:_})}}}catch{fr("TaskManager not available for quick actions")}}),V("Registered block context menu")}function ci(n){const e=n.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function di(n){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=n.match(e);if(t){let a=parseInt(t[1],10);const i=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&a<12?a+=12:o==="AM"&&a===12&&(a=0),`${a.toString().padStart(2,"0")}:${i}`}return null}class Sd{constructor(e,t){T(this,"plugin");T(this,"repository");T(this,"topbarElement",null);T(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),V("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),V("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const a=new Date(s.dueAt);return a<new Date&&!Aa(a)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const a=document.createElement("span");a.className="b3-badge",a.textContent=e.length.toString(),a.style.display="block",a.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(a)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){Ge.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Ed extends ma.Plugin{constructor(){super(...arguments);T(this,"taskManager");T(this,"repository");T(this,"scheduler");T(this,"eventService");T(this,"migrationManager");T(this,"topbarMenu");T(this,"dashboardComponent",null);T(this,"dockEl");T(this,"quickAddComponent",null);T(this,"quickAddContainer",null);T(this,"taskEditorComponent",null);T(this,"taskEditorContainer",null);T(this,"pendingCompletionTimeouts",new Map);T(this,"handleCreateTaskEvent",t=>{try{const s=t;V("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){ue("Failed to handle create task event",s),se.error("Failed to open task creator.")}});T(this,"handleSettingsEvent",t=>{try{V("Settings event received",t.detail),this.openDock()}catch(s){ue("Failed to handle settings event",s),se.error("Failed to open settings.")}});T(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:a}=s.detail??{};if(!a)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(a)}catch(s){ue("Failed to complete task",s),se.error("Failed to complete task.")}});T(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:a,minutes:i}=s.detail??{};if(!a||typeof i!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(a,i)}catch(s){ue("Failed to snooze task",s),se.error("Failed to snooze task.")}})}async onload(){V("Loading Recurring Tasks Plugin"),this.migrationManager=new Zc(this);try{await this.migrationManager.migrate(mn)}catch(s){ue("Migration failed, continuing with existing data",s)}const t=Ms.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();try{await this.taskManager.start()}catch(s){ue("Failed to start TaskManager",s)}pd(this,this.repository),Td(this),this.topbarMenu=new Sd(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:Xo,init:s=>{this.dockEl=s.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),V("Recurring Tasks Plugin loaded successfully")}async onunload(){V("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=Vs(Yc,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(Qs(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Ge.on("task:create",t=>{V("Create task event received",t),this.openQuickAdd(t)}),Ge.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Ge.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Ge.on("task:settings",()=>{this.openDock()}),Ge.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){ue("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Ge.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){se.info(`Completion already pending for "${s.name}".`);return}const a=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),V(`Task completed: ${s.name}`)}catch(o){ue("Failed to finalize task completion",o),se.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,a);const i=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),se.info(`Undo: "${s.name}" restored`))};kn({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:i,showCountdown:!0})}}async handleSnoozeTask(t,s){const a=this.repository.getTask(t);a&&(await this.eventService.handleTaskSnoozed(a),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),V(`Task snoozed: ${a.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=Vs(Jc,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}closeQuickAdd(){this.quickAddComponent&&(Qs(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=Vs(_r,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(Qs(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=Ed;

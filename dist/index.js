"use strict";var Vl=Object.defineProperty;var mi=s=>{throw TypeError(s)};var Ql=(s,e,t)=>e in s?Vl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var E=(s,e,t)=>Ql(s,typeof e!="symbol"?e+"":e,t),Zn=(s,e,t)=>e.has(s)||mi("Cannot "+t);var M=(s,e,t)=>(Zn(s,e,"read from private field"),t?t.call(s):e.get(s)),Ce=(s,e,t)=>e.has(s)?mi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),xe=(s,e,t,r)=>(Zn(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),dt=(s,e,t)=>(Zn(s,e,"access private method"),t);const Ya=require("siyuan"),ua=!1;var ja=Array.isArray,$l=Array.prototype.indexOf,Kn=Array.from,Xl=Object.defineProperty,Nr=Object.getOwnPropertyDescriptor,ko=Object.getOwnPropertyDescriptors,Zl=Object.prototype,Jl=Array.prototype,za=Object.getPrototypeOf,gi=Object.isExtensible;function ec(s){for(var e=0;e<s.length;e++)s[e]()}function wo(){var s,e,t=new Promise((r,n)=>{s=r,e=n});return{promise:t,resolve:s,reject:e}}function To(s,e){if(Array.isArray(s))return s;if(!(Symbol.iterator in s))return Array.from(s);const t=[];for(const r of s)if(t.push(r),t.length===e)break;return t}const mt=2,Nn=4,Wn=8,So=1<<24,Ms=16,Ns=32,kr=64,Ha=128,Jt=512,wt=1024,At=2048,Rs=4096,jt=8192,xs=16384,Ka=32768,jr=65536,_i=1<<17,Do=1<<18,Vr=1<<19,tc=1<<20,Ds=1<<25,gr=32768,da=1<<21,Wa=1<<22,$s=1<<23,As=Symbol("$state"),sc=Symbol("legacy props"),rc=Symbol(""),Or=new class extends Error{constructor(){super(...arguments);E(this,"name","StaleReactionError");E(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function Ga(s){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function nc(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function ac(s){throw new Error("https://svelte.dev/e/effect_in_teardown")}function ic(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function oc(s){throw new Error("https://svelte.dev/e/effect_orphan")}function lc(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function cc(s){throw new Error("https://svelte.dev/e/props_invalid_value")}function uc(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function dc(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function hc(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function fc(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const vc=1,pc=2,Eo=4,yc=8,mc=16,gc=1,_c=4,bc=8,kc=16,wc=1,Tc=2,ht=Symbol(),Sc="http://www.w3.org/1999/xhtml";function Dc(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Ec(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function xo(s){return s===this.v}function Ao(s,e){return s!=s?e==e:s!==e||s!==null&&typeof s=="object"||typeof s=="function"}function Co(s){return!Ao(s,this.v)}let xc=!1,nt=null;function zr(s){nt=s}function Io(s){return Mo().get(s)}function Ac(s,e){return Mo().set(s,e),e}function Ge(s,e=!1,t){nt={p:nt,i:!1,c:null,e:null,s,x:null,l:null}}function Ve(s){var e=nt,t=e.e;if(t!==null){e.e=null;for(var r of t)Xo(r)}return e.i=!0,nt=e.p,{}}function Oo(){return!0}function Mo(s){return nt===null&&Ga(),nt.c??(nt.c=new Map(Cc(nt)||void 0))}function Cc(s){let e=s.p;for(;e!==null;){const t=e.c;if(t!==null)return t;e=e.p}return null}let ar=[];function No(){var s=ar;ar=[],ec(s)}function Qr(s){if(ar.length===0&&!rn){var e=ar;queueMicrotask(()=>{e===ar&&No()})}ar.push(s)}function Ic(){for(;ar.length>0;)No()}function Ro(s){var e=Fe;if(e===null)return De.f|=$s,s;if(e.f&Ka)Hr(s,e);else{if(!(e.f&Ha))throw s;e.b.error(s)}}function Hr(s,e){for(;e!==null;){if(e.f&Ha)try{e.b.error(s);return}catch(t){s=t}e=e.parent}throw s}const Oc=-7169;function ut(s,e){s.f=s.f&Oc|e}function Va(s){s.f&Jt||s.deps===null?ut(s,wt):ut(s,Rs)}function qo(s){if(s!==null)for(const e of s)!(e.f&mt)||!(e.f&gr)||(e.f^=gr,qo(e.deps))}function Lo(s,e,t){s.f&At?e.add(s):s.f&Rs&&t.add(s),qo(s.deps),ut(s,wt)}const wn=new Set;let Te=null,sn=null,ft=null,$t=[],Gn=null,ha=!1,rn=!1;var Lr,Fr,lr,cr,fn,Pr,Ur,es,fa,va,Fo,Po;const jn=class jn{constructor(){Ce(this,es);E(this,"committed",!1);E(this,"current",new Map);E(this,"previous",new Map);Ce(this,Lr,new Set);Ce(this,Fr,new Set);Ce(this,lr,0);Ce(this,cr,0);Ce(this,fn,null);Ce(this,Pr,new Set);Ce(this,Ur,new Set);E(this,"skipped_effects",new Set);E(this,"is_fork",!1)}is_deferred(){return this.is_fork||M(this,cr)>0}process(e){var n;$t=[],sn=null,this.apply();var t=[],r=[];for(const a of e)dt(this,es,fa).call(this,a,t,r);this.is_fork||dt(this,es,Fo).call(this),this.is_deferred()?(dt(this,es,va).call(this,r),dt(this,es,va).call(this,t)):(sn=this,Te=null,bi(r),bi(t),sn=null,(n=M(this,fn))==null||n.resolve()),ft=null}capture(e,t){t!==ht&&!this.previous.has(e)&&this.previous.set(e,t),e.f&$s||(this.current.set(e,e.v),ft==null||ft.set(e,e.v))}activate(){Te=this,this.apply()}deactivate(){Te===this&&(Te=null,ft=null)}flush(){if(this.activate(),$t.length>0){if(Uo(),Te!==null&&Te!==this)return}else M(this,lr)===0&&this.process([]);this.deactivate()}discard(){for(const e of M(this,Fr))e(this);M(this,Fr).clear()}increment(e){xe(this,lr,M(this,lr)+1),e&&xe(this,cr,M(this,cr)+1)}decrement(e){xe(this,lr,M(this,lr)-1),e&&xe(this,cr,M(this,cr)-1),this.revive()}revive(){for(const e of M(this,Pr))M(this,Ur).delete(e),ut(e,At),Is(e);for(const e of M(this,Ur))ut(e,Rs),Is(e);this.flush()}oncommit(e){M(this,Lr).add(e)}ondiscard(e){M(this,Fr).add(e)}settled(){return(M(this,fn)??xe(this,fn,wo())).promise}static ensure(){if(Te===null){const e=Te=new jn;wn.add(Te),rn||jn.enqueue(()=>{Te===e&&e.flush()})}return Te}static enqueue(e){Qr(e)}apply(){}};Lr=new WeakMap,Fr=new WeakMap,lr=new WeakMap,cr=new WeakMap,fn=new WeakMap,Pr=new WeakMap,Ur=new WeakMap,es=new WeakSet,fa=function(e,t,r){e.f^=wt;for(var n=e.first,a=null;n!==null;){var o=n.f,l=(o&(Ns|kr))!==0,c=l&&(o&wt)!==0,u=c||(o&jt)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){l?n.f^=wt:a!==null&&o&(Nn|Wn|So)?a.b.defer_effect(n):o&Nn?t.push(n):gn(n)&&(o&Ms&&M(this,Pr).add(n),cn(n));var h=n.first;if(h!==null){n=h;continue}}var y=n.parent;for(n=n.next;n===null&&y!==null;)y===a&&(a=null),n=y.next,y=y.parent}},va=function(e){for(var t=0;t<e.length;t+=1)Lo(e[t],M(this,Pr),M(this,Ur))},Fo=function(){if(M(this,cr)===0){for(const e of M(this,Lr))e();M(this,Lr).clear()}M(this,lr)===0&&dt(this,es,Po).call(this)},Po=function(){var n;if(wn.size>1){this.previous.clear();var e=ft,t=!0;for(const a of wn){if(a===this){t=!1;continue}const o=[];for(const[c,u]of this.current){if(a.current.has(c))if(t&&u!==a.current.get(c))a.current.set(c,u);else continue;o.push(c)}if(o.length===0)continue;const l=[...a.current.keys()].filter(c=>!this.current.has(c));if(l.length>0){var r=$t;$t=[];const c=new Set,u=new Map;for(const h of o)Bo(h,l,c,u);if($t.length>0){Te=a,a.apply();for(const h of $t)dt(n=a,es,fa).call(n,h,[],[]);a.deactivate()}$t=r}}Te=null,ft=e}this.committed=!0,wn.delete(this)};let Es=jn;function Mc(s){var e=rn;rn=!0;try{for(var t;;){if(Ic(),$t.length===0&&(Te==null||Te.flush(),$t.length===0))return Gn=null,t;Uo()}}finally{rn=e}}function Uo(){var s=pr;ha=!0;var e=null;try{var t=0;for(qn(!0);$t.length>0;){var r=Es.ensure();if(t++>1e3){var n,a;Nc()}r.process($t),Xs.clear()}}finally{ha=!1,qn(s),Gn=null}}function Nc(){try{lc()}catch(s){Hr(s,Gn)}}let ns=null;function bi(s){var e=s.length;if(e!==0){for(var t=0;t<e;){var r=s[t++];if(!(r.f&(xs|jt))&&gn(r)&&(ns=new Set,cn(r),r.deps===null&&r.first===null&&r.nodes===null&&(r.teardown===null&&r.ac===null?tl(r):r.fn=null),(ns==null?void 0:ns.size)>0)){Xs.clear();for(const n of ns){if(n.f&(xs|jt))continue;const a=[n];let o=n.parent;for(;o!==null;)ns.has(o)&&(ns.delete(o),a.push(o)),o=o.parent;for(let l=a.length-1;l>=0;l--){const c=a[l];c.f&(xs|jt)||cn(c)}}ns.clear()}}ns=null}}function Bo(s,e,t,r){if(!t.has(s)&&(t.add(s),s.reactions!==null))for(const n of s.reactions){const a=n.f;a&mt?Bo(n,e,t,r):a&(Wa|Ms)&&!(a&At)&&Yo(n,e,r)&&(ut(n,At),Is(n))}}function Yo(s,e,t){const r=t.get(s);if(r!==void 0)return r;if(s.deps!==null)for(const n of s.deps){if(e.includes(n))return!0;if(n.f&mt&&Yo(n,e,t))return t.set(n,!0),!0}return t.set(s,!1),!1}function Is(s){for(var e=Gn=s;e.parent!==null;){e=e.parent;var t=e.f;if(ha&&e===Fe&&t&Ms&&!(t&Do))return;if(t&(kr|Ns)){if(!(t&wt))return;e.f^=wt}}$t.push(e)}function Rc(s){let e=0,t=_r(0),r;return()=>{Xa()&&(i(t),mn(()=>(e===0&&(r=Js(()=>s(()=>nn(t)))),e+=1,()=>{Qr(()=>{e-=1,e===0&&(r==null||r(),r=void 0,nn(t))})})))}}var qc=jr|Vr|Ha;function Lc(s,e,t){new Fc(s,e,t)}var Vt,Ba,hs,ur,fs,Qt,Ot,vs,Ss,Hs,dr,Ks,hr,Br,Yr,Ws,zn,ct,Pc,Uc,pa,xn,An,ya;class Fc{constructor(e,t,r){Ce(this,ct);E(this,"parent");E(this,"is_pending",!1);Ce(this,Vt);Ce(this,Ba,null);Ce(this,hs);Ce(this,ur);Ce(this,fs);Ce(this,Qt,null);Ce(this,Ot,null);Ce(this,vs,null);Ce(this,Ss,null);Ce(this,Hs,null);Ce(this,dr,0);Ce(this,Ks,0);Ce(this,hr,!1);Ce(this,Br,new Set);Ce(this,Yr,new Set);Ce(this,Ws,null);Ce(this,zn,Rc(()=>(xe(this,Ws,_r(M(this,dr))),()=>{xe(this,Ws,null)})));xe(this,Vt,e),xe(this,hs,t),xe(this,ur,r),this.parent=Fe.b,this.is_pending=!!M(this,hs).pending,xe(this,fs,ei(()=>{Fe.b=this;{var n=dt(this,ct,pa).call(this);try{xe(this,Qt,Xt(()=>r(n)))}catch(a){this.error(a)}M(this,Ks)>0?dt(this,ct,An).call(this):this.is_pending=!1}return()=>{var a;(a=M(this,Hs))==null||a.remove()}},qc))}defer_effect(e){Lo(e,M(this,Br),M(this,Yr))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!M(this,hs).pending}update_pending_count(e){dt(this,ct,ya).call(this,e),xe(this,dr,M(this,dr)+e),M(this,Ws)&&Kr(M(this,Ws),M(this,dr))}get_effect_pending(){return M(this,zn).call(this),i(M(this,Ws))}error(e){var t=M(this,hs).onerror;let r=M(this,hs).failed;if(M(this,hr)||!t&&!r)throw e;M(this,Qt)&&(Nt(M(this,Qt)),xe(this,Qt,null)),M(this,Ot)&&(Nt(M(this,Ot)),xe(this,Ot,null)),M(this,vs)&&(Nt(M(this,vs)),xe(this,vs,null));var n=!1,a=!1;const o=()=>{if(n){Ec();return}n=!0,a&&fc(),Es.ensure(),xe(this,dr,0),M(this,vs)!==null&&vr(M(this,vs),()=>{xe(this,vs,null)}),this.is_pending=this.has_pending_snippet(),xe(this,Qt,dt(this,ct,xn).call(this,()=>(xe(this,hr,!1),Xt(()=>M(this,ur).call(this,M(this,Vt)))))),M(this,Ks)>0?dt(this,ct,An).call(this):this.is_pending=!1};var l=De;try{Mt(null),a=!0,t==null||t(e,o),a=!1}catch(c){Hr(c,M(this,fs)&&M(this,fs).parent)}finally{Mt(l)}r&&Qr(()=>{xe(this,vs,dt(this,ct,xn).call(this,()=>{Es.ensure(),xe(this,hr,!0);try{return Xt(()=>{r(M(this,Vt),()=>e,()=>o)})}catch(c){return Hr(c,M(this,fs).parent),null}finally{xe(this,hr,!1)}}))})}}Vt=new WeakMap,Ba=new WeakMap,hs=new WeakMap,ur=new WeakMap,fs=new WeakMap,Qt=new WeakMap,Ot=new WeakMap,vs=new WeakMap,Ss=new WeakMap,Hs=new WeakMap,dr=new WeakMap,Ks=new WeakMap,hr=new WeakMap,Br=new WeakMap,Yr=new WeakMap,Ws=new WeakMap,zn=new WeakMap,ct=new WeakSet,Pc=function(){try{xe(this,Qt,Xt(()=>M(this,ur).call(this,M(this,Vt))))}catch(e){this.error(e)}},Uc=function(){const e=M(this,hs).pending;e&&(xe(this,Ot,Xt(()=>e(M(this,Vt)))),Es.enqueue(()=>{var t=dt(this,ct,pa).call(this);xe(this,Qt,dt(this,ct,xn).call(this,()=>(Es.ensure(),Xt(()=>M(this,ur).call(this,t))))),M(this,Ks)>0?dt(this,ct,An).call(this):(vr(M(this,Ot),()=>{xe(this,Ot,null)}),this.is_pending=!1)}))},pa=function(){var e=M(this,Vt);return this.is_pending&&(xe(this,Hs,Cs()),M(this,Vt).before(M(this,Hs)),e=M(this,Hs)),e},xn=function(e){var t=Fe,r=De,n=nt;ms(M(this,fs)),Mt(M(this,fs)),zr(M(this,fs).ctx);try{return e()}catch(a){return Ro(a),null}finally{ms(t),Mt(r),zr(n)}},An=function(){const e=M(this,hs).pending;M(this,Qt)!==null&&(xe(this,Ss,document.createDocumentFragment()),M(this,Ss).append(M(this,Hs)),nl(M(this,Qt),M(this,Ss))),M(this,Ot)===null&&xe(this,Ot,Xt(()=>e(M(this,Vt))))},ya=function(e){var t;if(!this.has_pending_snippet()){this.parent&&dt(t=this.parent,ct,ya).call(t,e);return}if(xe(this,Ks,M(this,Ks)+e),M(this,Ks)===0){this.is_pending=!1;for(const r of M(this,Br))ut(r,At),Is(r);for(const r of M(this,Yr))ut(r,Rs),Is(r);M(this,Br).clear(),M(this,Yr).clear(),M(this,Ot)&&vr(M(this,Ot),()=>{xe(this,Ot,null)}),M(this,Ss)&&(M(this,Vt).before(M(this,Ss)),xe(this,Ss,null))}};function Bc(s,e,t,r){const n=Vn;if(t.length===0&&s.length===0){r(e.map(n));return}var a=Te,o=Fe,l=Yc();function c(){Promise.all(t.map(u=>jc(u))).then(u=>{l();try{r([...e.map(n),...u])}catch(h){o.f&xs||Hr(h,o)}a==null||a.deactivate(),Rn()}).catch(u=>{Hr(u,o)})}s.length>0?Promise.all(s).then(()=>{l();try{return c()}finally{a==null||a.deactivate(),Rn()}}):c()}function Yc(){var s=Fe,e=De,t=nt,r=Te;return function(a=!0){ms(s),Mt(e),zr(t),a&&(r==null||r.activate())}}function Rn(){ms(null),Mt(null),zr(null)}function Vn(s){var e=mt|At,t=De!==null&&De.f&mt?De:null;return Fe!==null&&(Fe.f|=Vr),{ctx:nt,deps:null,effects:null,equals:xo,f:e,fn:s,reactions:null,rv:0,v:ht,wv:0,parent:t??Fe,ac:null}}function jc(s,e,t){let r=Fe;r===null&&nc();var n=r.b,a=void 0,o=_r(ht),l=!De,c=new Map;return Jc(()=>{var p;var u=wo();a=u.promise;try{Promise.resolve(s()).then(u.resolve,u.reject).then(()=>{h===Te&&h.committed&&h.deactivate(),Rn()})}catch(w){u.reject(w),Rn()}var h=Te;if(l){var y=n.is_rendered();n.update_pending_count(1),h.increment(y),(p=c.get(h))==null||p.reject(Or),c.delete(h),c.set(h,u)}const v=(w,m=void 0)=>{if(h.activate(),m)m!==Or&&(o.f|=$s,Kr(o,m));else{o.f&$s&&(o.f^=$s),Kr(o,w);for(const[g,b]of c){if(c.delete(g),g===h)break;b.reject(Or)}}l&&(n.update_pending_count(-1),h.decrement(y))};u.promise.then(v,w=>v(null,w||"unknown"))}),Za(()=>{for(const u of c.values())u.reject(Or)}),new Promise(u=>{function h(y){function v(){y===a?u(o):h(a)}y.then(v,v)}h(a)})}function Z(s){const e=Vn(s);return al(e),e}function jo(s){const e=Vn(s);return e.equals=Co,e}function zo(s){var e=s.effects;if(e!==null){s.effects=null;for(var t=0;t<e.length;t+=1)Nt(e[t])}}function zc(s){for(var e=s.parent;e!==null;){if(!(e.f&mt))return e.f&xs?null:e;e=e.parent}return null}function Qa(s){var e,t=Fe;ms(zc(s));try{s.f&=~gr,zo(s),e=cl(s)}finally{ms(t)}return e}function Ho(s){var e=Qa(s);if(!s.equals(e)&&(s.wv=ol(),(!(Te!=null&&Te.is_fork)||s.deps===null)&&(s.v=e,s.deps===null))){ut(s,wt);return}Zs||(ft!==null?(Xa()||Te!=null&&Te.is_fork)&&ft.set(s,e):Va(s))}let ma=new Set;const Xs=new Map;let Ko=!1;function _r(s,e){var t={f:0,v:s,reactions:null,equals:xo,rv:0,wv:0};return t}function V(s,e){const t=_r(s);return al(t),t}function Hc(s,e=!1,t=!0){const r=_r(s);return e||(r.equals=Co),r}function _(s,e,t=!1){De!==null&&(!os||De.f&_i)&&Oo()&&De.f&(mt|Ms|Wa|_i)&&!(xt!=null&&xt.includes(s))&&hc();let r=t?be(e):e;return Kr(s,r)}function Kr(s,e){if(!s.equals(e)){var t=s.v;Zs?Xs.set(s,e):Xs.set(s,t),s.v=e;var r=Es.ensure();if(r.capture(s,t),s.f&mt){const n=s;s.f&At&&Qa(n),Va(n)}s.wv=ol(),Wo(s,At),Fe!==null&&Fe.f&wt&&!(Fe.f&(Ns|kr))&&(Gt===null?tu([s]):Gt.push(s)),!r.is_fork&&ma.size>0&&!Ko&&Kc()}return e}function Kc(){Ko=!1;var s=pr;qn(!0);const e=Array.from(ma);try{for(const t of e)t.f&wt&&ut(t,Rs),gn(t)&&cn(t)}finally{qn(s)}ma.clear()}function ki(s,e=1){var t=i(s),r=e===1?t++:t--;return _(s,t),r}function nn(s){_(s,s.v+1)}function Wo(s,e){var t=s.reactions;if(t!==null)for(var r=t.length,n=0;n<r;n++){var a=t[n],o=a.f,l=(o&At)===0;if(l&&ut(a,e),o&mt){var c=a;ft==null||ft.delete(c),o&gr||(o&Jt&&(a.f|=gr),Wo(c,Rs))}else l&&(o&Ms&&ns!==null&&ns.add(a),Is(a))}}function be(s){if(typeof s!="object"||s===null||As in s)return s;const e=za(s);if(e!==Zl&&e!==Jl)return s;var t=new Map,r=ja(s),n=V(0),a=yr,o=l=>{if(yr===a)return l();var c=De,u=yr;Mt(null),Ei(a);var h=l();return Mt(c),Ei(u),h};return r&&t.set("length",V(s.length)),new Proxy(s,{defineProperty(l,c,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&uc();var h=t.get(c);return h===void 0?h=o(()=>{var y=V(u.value);return t.set(c,y),y}):_(h,u.value,!0),!0},deleteProperty(l,c){var u=t.get(c);if(u===void 0){if(c in l){const h=o(()=>V(ht));t.set(c,h),nn(n)}}else _(u,ht),nn(n);return!0},get(l,c,u){var p;if(c===As)return s;var h=t.get(c),y=c in l;if(h===void 0&&(!y||(p=Nr(l,c))!=null&&p.writable)&&(h=o(()=>{var w=be(y?l[c]:ht),m=V(w);return m}),t.set(c,h)),h!==void 0){var v=i(h);return v===ht?void 0:v}return Reflect.get(l,c,u)},getOwnPropertyDescriptor(l,c){var u=Reflect.getOwnPropertyDescriptor(l,c);if(u&&"value"in u){var h=t.get(c);h&&(u.value=i(h))}else if(u===void 0){var y=t.get(c),v=y==null?void 0:y.v;if(y!==void 0&&v!==ht)return{enumerable:!0,configurable:!0,value:v,writable:!0}}return u},has(l,c){var v;if(c===As)return!0;var u=t.get(c),h=u!==void 0&&u.v!==ht||Reflect.has(l,c);if(u!==void 0||Fe!==null&&(!h||(v=Nr(l,c))!=null&&v.writable)){u===void 0&&(u=o(()=>{var p=h?be(l[c]):ht,w=V(p);return w}),t.set(c,u));var y=i(u);if(y===ht)return!1}return h},set(l,c,u,h){var S;var y=t.get(c),v=c in l;if(r&&c==="length")for(var p=u;p<y.v;p+=1){var w=t.get(p+"");w!==void 0?_(w,ht):p in l&&(w=o(()=>V(ht)),t.set(p+"",w))}if(y===void 0)(!v||(S=Nr(l,c))!=null&&S.writable)&&(y=o(()=>V(void 0)),_(y,be(u)),t.set(c,y));else{v=y.v!==ht;var m=o(()=>be(u));_(y,m)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g!=null&&g.set&&g.set.call(h,u),!v){if(r&&typeof c=="string"){var b=t.get("length"),D=Number(c);Number.isInteger(D)&&D>=b.v&&_(b,D+1)}nn(n)}return!0},ownKeys(l){i(n);var c=Reflect.ownKeys(l).filter(y=>{var v=t.get(y);return v===void 0||v.v!==ht});for(var[u,h]of t)h.v!==ht&&!(u in l)&&c.push(u);return c},setPrototypeOf(){dc()}})}function wi(s){try{if(s!==null&&typeof s=="object"&&As in s)return s[As]}catch{}return s}function Wc(s,e){return Object.is(wi(s),wi(e))}var Ti,Go,Vo,Qo;function Gc(){if(Ti===void 0){Ti=window,Go=/Firefox/.test(navigator.userAgent);var s=Element.prototype,e=Node.prototype,t=Text.prototype;Vo=Nr(e,"firstChild").get,Qo=Nr(e,"nextSibling").get,gi(s)&&(s.__click=void 0,s.__className=void 0,s.__attributes=null,s.__style=void 0,s.__e=void 0),gi(t)&&(t.__t=void 0)}}function Cs(s=""){return document.createTextNode(s)}function Gs(s){return Vo.call(s)}function yn(s){return Qo.call(s)}function d(s,e){return Gs(s)}function Pe(s,e=!1){{var t=Gs(s);return t instanceof Comment&&t.data===""?yn(t):t}}function f(s,e=1,t=!1){let r=s;for(;e--;)r=yn(r);return r}function Vc(s){s.textContent=""}function $o(){return!1}let Si=!1;function Qc(){Si||(Si=!0,document.addEventListener("reset",s=>{Promise.resolve().then(()=>{var e;if(!s.defaultPrevented)for(const t of s.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Qn(s){var e=De,t=Fe;Mt(null),ms(null);try{return s()}finally{Mt(e),ms(t)}}function $a(s,e,t,r=t){s.addEventListener(e,()=>Qn(t));const n=s.__on_r;n?s.__on_r=()=>{n(),r(!0)}:s.__on_r=()=>r(!0),Qc()}function $c(s){Fe===null&&(De===null&&oc(),ic()),Zs&&ac()}function Xc(s,e){var t=e.last;t===null?e.last=e.first=s:(t.next=s,s.prev=t,e.last=s)}function qs(s,e,t){var r=Fe;r!==null&&r.f&jt&&(s|=jt);var n={ctx:nt,deps:null,nodes:null,f:s|At|Jt,first:null,fn:e,last:null,next:null,parent:r,b:r&&r.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{cn(n),n.f|=Ka}catch(l){throw Nt(n),l}else e!==null&&Is(n);var a=n;if(t&&a.deps===null&&a.teardown===null&&a.nodes===null&&a.first===a.last&&!(a.f&Vr)&&(a=a.first,s&Ms&&s&jr&&a!==null&&(a.f|=jr)),a!==null&&(a.parent=r,r!==null&&Xc(a,r),De!==null&&De.f&mt&&!(s&kr))){var o=De;(o.effects??(o.effects=[])).push(a)}return n}function Xa(){return De!==null&&!os}function Za(s){const e=qs(Wn,null,!1);return ut(e,wt),e.teardown=s,e}function vt(s){$c();var e=Fe.f,t=!De&&(e&Ns)!==0&&(e&Ka)===0;if(t){var r=nt;(r.e??(r.e=[])).push(s)}else return Xo(s)}function Xo(s){return qs(Nn|tc,s,!1)}function Zc(s){Es.ensure();const e=qs(kr|Vr,s,!0);return(t={})=>new Promise(r=>{t.outro?vr(e,()=>{Nt(e),r(void 0)}):(Nt(e),r(void 0))})}function Ja(s){return qs(Nn,s,!1)}function Jc(s){return qs(Wa|Vr,s,!0)}function mn(s,e=0){return qs(Wn|e,s,!0)}function z(s,e=[],t=[],r=[]){Bc(r,e,t,n=>{qs(Wn,()=>s(...n.map(i)),!0)})}function ei(s,e=0){var t=qs(Ms|e,s,!0);return t}function Xt(s){return qs(Ns|Vr,s,!0)}function Zo(s){var e=s.teardown;if(e!==null){const t=Zs,r=De;Di(!0),Mt(null);try{e.call(null)}finally{Di(t),Mt(r)}}}function Jo(s,e=!1){var t=s.first;for(s.first=s.last=null;t!==null;){const n=t.ac;n!==null&&Qn(()=>{n.abort(Or)});var r=t.next;t.f&kr?t.parent=null:Nt(t,e),t=r}}function eu(s){for(var e=s.first;e!==null;){var t=e.next;e.f&Ns||Nt(e),e=t}}function Nt(s,e=!0){var t=!1;(e||s.f&Do)&&s.nodes!==null&&s.nodes.end!==null&&(el(s.nodes.start,s.nodes.end),t=!0),Jo(s,e&&!t),Ln(s,0),ut(s,xs);var r=s.nodes&&s.nodes.t;if(r!==null)for(const a of r)a.stop();Zo(s);var n=s.parent;n!==null&&n.first!==null&&tl(s),s.next=s.prev=s.teardown=s.ctx=s.deps=s.fn=s.nodes=s.ac=null}function el(s,e){for(;s!==null;){var t=s===e?null:yn(s);s.remove(),s=t}}function tl(s){var e=s.parent,t=s.prev,r=s.next;t!==null&&(t.next=r),r!==null&&(r.prev=t),e!==null&&(e.first===s&&(e.first=r),e.last===s&&(e.last=t))}function vr(s,e,t=!0){var r=[];sl(s,r,!0);var n=()=>{t&&Nt(s),e&&e()},a=r.length;if(a>0){var o=()=>--a||n();for(var l of r)l.out(o)}else n()}function sl(s,e,t){if(!(s.f&jt)){s.f^=jt;var r=s.nodes&&s.nodes.t;if(r!==null)for(const l of r)(l.is_global||t)&&e.push(l);for(var n=s.first;n!==null;){var a=n.next,o=(n.f&jr)!==0||(n.f&Ns)!==0&&(s.f&Ms)!==0;sl(n,e,o?t:!1),n=a}}}function ti(s){rl(s,!0)}function rl(s,e){if(s.f&jt){s.f^=jt,s.f&wt||(ut(s,At),Is(s));for(var t=s.first;t!==null;){var r=t.next,n=(t.f&jr)!==0||(t.f&Ns)!==0;rl(t,n?e:!1),t=r}var a=s.nodes&&s.nodes.t;if(a!==null)for(const o of a)(o.is_global||e)&&o.in()}}function nl(s,e){if(s.nodes)for(var t=s.nodes.start,r=s.nodes.end;t!==null;){var n=t===r?null:yn(t);e.append(t),t=n}}let pr=!1;function qn(s){pr=s}let Zs=!1;function Di(s){Zs=s}let De=null,os=!1;function Mt(s){De=s}let Fe=null;function ms(s){Fe=s}let xt=null;function al(s){De!==null&&(xt===null?xt=[s]:xt.push(s))}let Dt=null,Ut=0,Gt=null;function tu(s){Gt=s}let il=1,ln=0,yr=ln;function Ei(s){yr=s}function ol(){return++il}function gn(s){var e=s.f;if(e&At)return!0;if(e&mt&&(s.f&=~gr),e&Rs){for(var t=s.deps,r=t.length,n=0;n<r;n++){var a=t[n];if(gn(a)&&Ho(a),a.wv>s.wv)return!0}e&Jt&&ft===null&&ut(s,wt)}return!1}function ll(s,e,t=!0){var r=s.reactions;if(r!==null&&!(xt!=null&&xt.includes(s)))for(var n=0;n<r.length;n++){var a=r[n];a.f&mt?ll(a,e,!1):e===a&&(t?ut(a,At):a.f&wt&&ut(a,Rs),Is(a))}}function cl(s){var w;var e=Dt,t=Ut,r=Gt,n=De,a=xt,o=nt,l=os,c=yr,u=s.f;Dt=null,Ut=0,Gt=null,De=u&(Ns|kr)?null:s,xt=null,zr(s.ctx),os=!1,yr=++ln,s.ac!==null&&(Qn(()=>{s.ac.abort(Or)}),s.ac=null);try{s.f|=da;var h=s.fn,y=h(),v=s.deps;if(Dt!==null){var p;if(Ln(s,Ut),v!==null&&Ut>0)for(v.length=Ut+Dt.length,p=0;p<Dt.length;p++)v[Ut+p]=Dt[p];else s.deps=v=Dt;if(Xa()&&s.f&Jt)for(p=Ut;p<v.length;p++)((w=v[p]).reactions??(w.reactions=[])).push(s)}else v!==null&&Ut<v.length&&(Ln(s,Ut),v.length=Ut);if(Oo()&&Gt!==null&&!os&&v!==null&&!(s.f&(mt|Rs|At)))for(p=0;p<Gt.length;p++)ll(Gt[p],s);return n!==null&&n!==s&&(ln++,Gt!==null&&(r===null?r=Gt:r.push(...Gt))),s.f&$s&&(s.f^=$s),y}catch(m){return Ro(m)}finally{s.f^=da,Dt=e,Ut=t,Gt=r,De=n,xt=a,zr(o),os=l,yr=c}}function su(s,e){let t=e.reactions;if(t!==null){var r=$l.call(t,s);if(r!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[r]=t[n],t.pop())}}if(t===null&&e.f&mt&&(Dt===null||!Dt.includes(e))){var a=e;a.f&Jt&&(a.f^=Jt,a.f&=~gr),Va(a),zo(a),Ln(a,0)}}function Ln(s,e){var t=s.deps;if(t!==null)for(var r=e;r<t.length;r++)su(s,t[r])}function cn(s){var e=s.f;if(!(e&xs)){ut(s,wt);var t=Fe,r=pr;Fe=s,pr=!0;try{e&(Ms|So)?eu(s):Jo(s),Zo(s);var n=cl(s);s.teardown=typeof n=="function"?n:null,s.wv=il;var a;ua&&xc&&s.f&At&&s.deps}finally{pr=r,Fe=t}}}async function ul(){await Promise.resolve(),Mc()}function i(s){var e=s.f,t=(e&mt)!==0;if(De!==null&&!os){var r=Fe!==null&&(Fe.f&xs)!==0;if(!r&&!(xt!=null&&xt.includes(s))){var n=De.deps;if(De.f&da)s.rv<ln&&(s.rv=ln,Dt===null&&n!==null&&n[Ut]===s?Ut++:Dt===null?Dt=[s]:Dt.includes(s)||Dt.push(s));else{(De.deps??(De.deps=[])).push(s);var a=s.reactions;a===null?s.reactions=[De]:a.includes(De)||a.push(De)}}}if(Zs&&Xs.has(s))return Xs.get(s);if(t){var o=s;if(Zs){var l=o.v;return(!(o.f&wt)&&o.reactions!==null||hl(o))&&(l=Qa(o)),Xs.set(o,l),l}var c=(o.f&Jt)===0&&!os&&De!==null&&(pr||(De.f&Jt)!==0),u=o.deps===null;gn(o)&&(c&&(o.f|=Jt),Ho(o)),c&&!u&&dl(o)}if(ft!=null&&ft.has(s))return ft.get(s);if(s.f&$s)throw s.v;return s.v}function dl(s){if(s.deps!==null){s.f|=Jt;for(const e of s.deps)(e.reactions??(e.reactions=[])).push(s),e.f&mt&&!(e.f&Jt)&&dl(e)}}function hl(s){if(s.v===ht)return!0;if(s.deps===null)return!1;for(const e of s.deps)if(Xs.has(e)||e.f&mt&&hl(e))return!0;return!1}function Js(s){var e=os;try{return os=!0,s()}finally{os=e}}function ru(s){if(!(typeof s!="object"||!s||s instanceof EventTarget)){if(As in s)ga(s);else if(!Array.isArray(s))for(let e in s){const t=s[e];typeof t=="object"&&t&&As in t&&ga(t)}}}function ga(s,e=new Set){if(typeof s=="object"&&s!==null&&!(s instanceof EventTarget)&&!e.has(s)){e.add(s),s instanceof Date&&s.getTime();for(let r in s)try{ga(s[r],e)}catch{}const t=za(s);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const r=ko(t);for(let n in r){const a=r[n].get;if(a)try{a.call(s)}catch{}}}}}const nu=["touchstart","touchmove"];function au(s){return nu.includes(s)}const fl=new Set,_a=new Set;function iu(s,e,t,r={}){function n(a){if(r.capture||Jr.call(e,a),!a.cancelBubble)return Qn(()=>t==null?void 0:t.call(this,a))}return s.startsWith("pointer")||s.startsWith("touch")||s==="wheel"?Qr(()=>{e.addEventListener(s,n,r)}):e.addEventListener(s,n,r),n}function pt(s,e,t,r,n){var a={capture:r,passive:n},o=iu(s,e,t,a);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Za(()=>{e.removeEventListener(s,o,a)})}function at(s){for(var e=0;e<s.length;e++)fl.add(s[e]);for(var t of _a)t(s)}let xi=null;function Jr(s){var g;var e=this,t=e.ownerDocument,r=s.type,n=((g=s.composedPath)==null?void 0:g.call(s))||[],a=n[0]||s.target;xi=s;var o=0,l=xi===s&&s.__root;if(l){var c=n.indexOf(l);if(c!==-1&&(e===document||e===window)){s.__root=e;return}var u=n.indexOf(e);if(u===-1)return;c<=u&&(o=c)}if(a=n[o]||s.target,a!==e){Xl(s,"currentTarget",{configurable:!0,get(){return a||t}});var h=De,y=Fe;Mt(null),ms(null);try{for(var v,p=[];a!==null;){var w=a.assignedSlot||a.parentNode||a.host||null;try{var m=a["__"+r];m!=null&&(!a.disabled||s.target===a)&&m.call(a,s)}catch(b){v?p.push(b):v=b}if(s.cancelBubble||w===e||w===null)break;a=w}if(v){for(let b of p)queueMicrotask(()=>{throw b});throw v}}finally{s.__root=e,delete s.currentTarget,Mt(h),ms(y)}}}function vl(s){var e=document.createElement("template");return e.innerHTML=s.replaceAll("<!>","<!---->"),e.content}function un(s,e){var t=Fe;t.nodes===null&&(t.nodes={start:s,end:e,a:null,t:null})}function I(s,e){var t=(e&wc)!==0,r=(e&Tc)!==0,n,a=!s.startsWith("<!>");return()=>{n===void 0&&(n=vl(a?s:"<!>"+s),t||(n=Gs(n)));var o=r||Go?document.importNode(n,!0):n.cloneNode(!0);if(t){var l=Gs(o),c=o.lastChild;un(l,c)}else un(o,o);return o}}function Rr(s=""){{var e=Cs(s+"");return un(e,e),e}}function He(){var s=document.createDocumentFragment(),e=document.createComment(""),t=Cs();return s.append(e,t),un(e,t),s}function T(s,e){s!==null&&s.before(e)}function B(s,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(s.__t??(s.__t=s.nodeValue))&&(s.__t=t,s.nodeValue=t+"")}function Tn(s,e){return ou(s,e)}const xr=new Map;function ou(s,{target:e,anchor:t,props:r={},events:n,context:a,intro:o=!0}){Gc();var l=new Set,c=y=>{for(var v=0;v<y.length;v++){var p=y[v];if(!l.has(p)){l.add(p);var w=au(p);e.addEventListener(p,Jr,{passive:w});var m=xr.get(p);m===void 0?(document.addEventListener(p,Jr,{passive:w}),xr.set(p,1)):xr.set(p,m+1)}}};c(Kn(fl)),_a.add(c);var u=void 0,h=Zc(()=>{var y=t??e.appendChild(Cs());return Lc(y,{pending:()=>{}},v=>{if(a){Ge({});var p=nt;p.c=a}n&&(r.$$events=n),u=s(v,r)||{},a&&Ve()}),()=>{var w;for(var v of l){e.removeEventListener(v,Jr);var p=xr.get(v);--p===0?(document.removeEventListener(v,Jr),xr.delete(v)):xr.set(v,p)}_a.delete(c),y!==t&&((w=y.parentNode)==null||w.removeChild(y))}});return ba.set(u,h),u}let ba=new WeakMap;function Sn(s,e){const t=ba.get(s);return t?(ba.delete(s),t(e)):Promise.resolve()}var as,ps,Bt,fr,vn,pn,Hn;class lu{constructor(e,t=!0){E(this,"anchor");Ce(this,as,new Map);Ce(this,ps,new Map);Ce(this,Bt,new Map);Ce(this,fr,new Set);Ce(this,vn,!0);Ce(this,pn,()=>{var e=Te;if(M(this,as).has(e)){var t=M(this,as).get(e),r=M(this,ps).get(t);if(r)ti(r),M(this,fr).delete(t);else{var n=M(this,Bt).get(t);n&&(M(this,ps).set(t,n.effect),M(this,Bt).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),r=n.effect)}for(const[a,o]of M(this,as)){if(M(this,as).delete(a),a===e)break;const l=M(this,Bt).get(o);l&&(Nt(l.effect),M(this,Bt).delete(o))}for(const[a,o]of M(this,ps)){if(a===t||M(this,fr).has(a))continue;const l=()=>{if(Array.from(M(this,as).values()).includes(a)){var u=document.createDocumentFragment();nl(o,u),u.append(Cs()),M(this,Bt).set(a,{effect:o,fragment:u})}else Nt(o);M(this,fr).delete(a),M(this,ps).delete(a)};M(this,vn)||!r?(M(this,fr).add(a),vr(o,l,!1)):l()}}});Ce(this,Hn,e=>{M(this,as).delete(e);const t=Array.from(M(this,as).values());for(const[r,n]of M(this,Bt))t.includes(r)||(Nt(n.effect),M(this,Bt).delete(r))});this.anchor=e,xe(this,vn,t)}ensure(e,t){var r=Te,n=$o();if(t&&!M(this,ps).has(e)&&!M(this,Bt).has(e))if(n){var a=document.createDocumentFragment(),o=Cs();a.append(o),M(this,Bt).set(e,{effect:Xt(()=>t(o)),fragment:a})}else M(this,ps).set(e,Xt(()=>t(this.anchor)));if(M(this,as).set(r,e),n){for(const[l,c]of M(this,ps))l===e?r.skipped_effects.delete(c):r.skipped_effects.add(c);for(const[l,c]of M(this,Bt))l===e?r.skipped_effects.delete(c.effect):r.skipped_effects.add(c.effect);r.oncommit(M(this,pn)),r.ondiscard(M(this,Hn))}else M(this,pn).call(this)}}as=new WeakMap,ps=new WeakMap,Bt=new WeakMap,fr=new WeakMap,vn=new WeakMap,pn=new WeakMap,Hn=new WeakMap;function K(s,e,t=!1){var r=new lu(s),n=t?jr:0;function a(o,l){r.ensure(o,l)}ei(()=>{var o=!1;e((l,c=!0)=>{o=!0,a(c,l)}),o||a(!1,null)},n)}function yt(s,e){return e}function cu(s,e,t){for(var r=[],n=e.length,a,o=e.length,l=0;l<n;l++){let y=e[l];vr(y,()=>{if(a){if(a.pending.delete(y),a.done.add(y),a.pending.size===0){var v=s.outrogroups;ka(Kn(a.done)),v.delete(a),v.size===0&&(s.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=r.length===0&&t!==null;if(c){var u=t,h=u.parentNode;Vc(h),h.append(u),s.items.clear()}ka(e,!c)}else a={pending:new Set(e),done:new Set},(s.outrogroups??(s.outrogroups=new Set)).add(a)}function ka(s,e=!0){for(var t=0;t<s.length;t++)Nt(s[t],e)}var Ai;function Ue(s,e,t,r,n,a=null){var o=s,l=new Map,c=(e&Eo)!==0;if(c){var u=s;o=u.appendChild(Cs())}var h=null,y=jo(()=>{var b=t();return ja(b)?b:b==null?[]:Kn(b)}),v,p=!0;function w(){g.fallback=h,uu(g,v,o,e,r),h!==null&&(v.length===0?h.f&Ds?(h.f^=Ds,en(h,null,o)):ti(h):vr(h,()=>{h=null}))}var m=ei(()=>{v=i(y);for(var b=v.length,D=new Set,S=Te,x=$o(),F=0;F<b;F+=1){var P=v[F],N=r(P,F),W=p?null:l.get(N);W?(W.v&&Kr(W.v,P),W.i&&Kr(W.i,F),x&&S.skipped_effects.delete(W.e)):(W=du(l,p?o:Ai??(Ai=Cs()),P,N,F,n,e,t),p||(W.e.f|=Ds),l.set(N,W)),D.add(N)}if(b===0&&a&&!h&&(p?h=Xt(()=>a(o)):(h=Xt(()=>a(Ai??(Ai=Cs()))),h.f|=Ds)),!p)if(x){for(const[j,ee]of l)D.has(j)||S.skipped_effects.add(ee.e);S.oncommit(w),S.ondiscard(()=>{})}else w();i(y)}),g={effect:m,items:l,outrogroups:null,fallback:h};p=!1}function uu(s,e,t,r,n){var ee,re,ae,he,me,H,q,A,Y;var a=(r&yc)!==0,o=e.length,l=s.items,c=s.effect.first,u,h=null,y,v=[],p=[],w,m,g,b;if(a)for(b=0;b<o;b+=1)w=e[b],m=n(w,b),g=l.get(m).e,g.f&Ds||((re=(ee=g.nodes)==null?void 0:ee.a)==null||re.measure(),(y??(y=new Set)).add(g));for(b=0;b<o;b+=1){if(w=e[b],m=n(w,b),g=l.get(m).e,s.outrogroups!==null)for(const se of s.outrogroups)se.pending.delete(g),se.done.delete(g);if(g.f&Ds)if(g.f^=Ds,g===c)en(g,null,t);else{var D=h?h.next:c;g===s.effect.last&&(s.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),Ys(s,h,g),Ys(s,g,D),en(g,D,t),h=g,v=[],p=[],c=h.next;continue}if(g.f&jt&&(ti(g),a&&((he=(ae=g.nodes)==null?void 0:ae.a)==null||he.unfix(),(y??(y=new Set)).delete(g))),g!==c){if(u!==void 0&&u.has(g)){if(v.length<p.length){var S=p[0],x;h=S.prev;var F=v[0],P=v[v.length-1];for(x=0;x<v.length;x+=1)en(v[x],S,t);for(x=0;x<p.length;x+=1)u.delete(p[x]);Ys(s,F.prev,P.next),Ys(s,h,F),Ys(s,P,S),c=S,h=P,b-=1,v=[],p=[]}else u.delete(g),en(g,c,t),Ys(s,g.prev,g.next),Ys(s,g,h===null?s.effect.first:h.next),Ys(s,h,g),h=g;continue}for(v=[],p=[];c!==null&&c!==g;)(u??(u=new Set)).add(c),p.push(c),c=c.next;if(c===null)continue}g.f&Ds||v.push(g),h=g,c=g.next}if(s.outrogroups!==null){for(const se of s.outrogroups)se.pending.size===0&&(ka(Kn(se.done)),(me=s.outrogroups)==null||me.delete(se));s.outrogroups.size===0&&(s.outrogroups=null)}if(c!==null||u!==void 0){var N=[];if(u!==void 0)for(g of u)g.f&jt||N.push(g);for(;c!==null;)!(c.f&jt)&&c!==s.fallback&&N.push(c),c=c.next;var W=N.length;if(W>0){var j=r&Eo&&o===0?t:null;if(a){for(b=0;b<W;b+=1)(q=(H=N[b].nodes)==null?void 0:H.a)==null||q.measure();for(b=0;b<W;b+=1)(Y=(A=N[b].nodes)==null?void 0:A.a)==null||Y.fix()}cu(s,N,j)}}a&&Qr(()=>{var se,J;if(y!==void 0)for(g of y)(J=(se=g.nodes)==null?void 0:se.a)==null||J.apply()})}function du(s,e,t,r,n,a,o,l){var c=o&vc?o&mc?_r(t):Hc(t,!1,!1):null,u=o&pc?_r(n):null;return{v:c,i:u,e:Xt(()=>(a(e,c??t,u??n,l),()=>{s.delete(r)}))}}function en(s,e,t){if(s.nodes)for(var r=s.nodes.start,n=s.nodes.end,a=e&&!(e.f&Ds)?e.nodes.start:t;r!==null;){var o=yn(r);if(a.before(r),r===n)return;r=o}}function Ys(s,e,t){e===null?s.effect.first=t:e.next=t,t===null?s.effect.last=e:t.prev=e}function hu(s,e,t=!1,r=!1,n=!1){var a=s,o="";z(()=>{var l=Fe;if(o!==(o=e()??"")&&(l.nodes!==null&&(el(l.nodes.start,l.nodes.end),l.nodes=null),o!=="")){var c=o+"";t?c=`<svg>${c}</svg>`:r&&(c=`<math>${c}</math>`);var u=vl(c);if((t||r)&&(u=Gs(u)),un(Gs(u),u.lastChild),t||r)for(;Gs(u);)a.before(Gs(u));else a.before(u)}})}function fu(s,e,t){Ja(()=>{var r=Js(()=>e(s,t==null?void 0:t())||{});if(t&&(r!=null&&r.update)){var n=!1,a={};mn(()=>{var o=t();ru(o),n&&Ao(a,o)&&(a=o,r.update(o))}),n=!0}if(r!=null&&r.destroy)return()=>r.destroy()})}function pl(s){var e,t,r="";if(typeof s=="string"||typeof s=="number")r+=s;else if(typeof s=="object")if(Array.isArray(s)){var n=s.length;for(e=0;e<n;e++)s[e]&&(t=pl(s[e]))&&(r&&(r+=" "),r+=t)}else for(t in s)s[t]&&(r&&(r+=" "),r+=t);return r}function vu(){for(var s,e,t=0,r="",n=arguments.length;t<n;t++)(s=arguments[t])&&(e=pl(s))&&(r&&(r+=" "),r+=e);return r}function pu(s){return typeof s=="object"?vu(s):s??""}const Ci=[...` 	
\r\f \v\uFEFF`];function yu(s,e,t){var r=s==null?"":""+s;if(e&&(r=r?r+" "+e:e),t){for(var n in t)if(t[n])r=r?r+" "+n:n;else if(r.length)for(var a=n.length,o=0;(o=r.indexOf(n,o))>=0;){var l=o+a;(o===0||Ci.includes(r[o-1]))&&(l===r.length||Ci.includes(r[l]))?r=(o===0?"":r.substring(0,o))+r.substring(l+1):o=l}}return r===""?null:r}function mu(s,e){return s==null?null:String(s)}function je(s,e,t,r,n,a){var o=s.__className;if(o!==t||o===void 0){var l=yu(t,r,a);l==null?s.removeAttribute("class"):s.className=l,s.__className=t}else if(a&&n!==a)for(var c in a){var u=!!a[c];(n==null||u!==!!n[c])&&s.classList.toggle(c,u)}return a}function mr(s,e,t,r){var n=s.__style;if(n!==e){var a=mu(e);a==null?s.removeAttribute("style"):s.style.cssText=a,s.__style=e}return r}function yl(s,e,t=!1){if(s.multiple){if(e==null)return;if(!ja(e))return Dc();for(var r of s.options)r.selected=e.includes(an(r));return}for(r of s.options){var n=an(r);if(Wc(n,e)){r.selected=!0;return}}(!t||e!==void 0)&&(s.selectedIndex=-1)}function gu(s){var e=new MutationObserver(()=>{yl(s,s.__value)});e.observe(s,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Za(()=>{e.disconnect()})}function wa(s,e,t=e){var r=new WeakSet,n=!0;$a(s,"change",a=>{var o=a?"[selected]":":checked",l;if(s.multiple)l=[].map.call(s.querySelectorAll(o),an);else{var c=s.querySelector(o)??s.querySelector("option:not([disabled])");l=c&&an(c)}t(l),Te!==null&&r.add(Te)}),Ja(()=>{var a=e();if(s===document.activeElement){var o=sn??Te;if(r.has(o))return}if(yl(s,a,n),n&&a===void 0){var l=s.querySelector(":checked");l!==null&&(a=an(l),t(a))}s.__value=a,n=!1}),gu(s)}function an(s){return"__value"in s?s.__value:s.value}const _u=Symbol("is custom element"),bu=Symbol("is html");function si(s,e){var t=ri(s);t.value===(t.value=e??void 0)||s.value===e&&(e!==0||s.nodeName!=="PROGRESS")||(s.value=e??"")}function qr(s,e){var t=ri(s);t.checked!==(t.checked=e??void 0)&&(s.checked=e)}function Se(s,e,t,r){var n=ri(s);n[e]!==(n[e]=t)&&(e==="loading"&&(s[rc]=t),t==null?s.removeAttribute(e):typeof t!="string"&&ku(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function ri(s){return s.__attributes??(s.__attributes={[_u]:s.nodeName.includes("-"),[bu]:s.namespaceURI===Sc})}var Ii=new Map;function ku(s){var e=s.getAttribute("is")||s.nodeName,t=Ii.get(e);if(t)return t;Ii.set(e,t=[]);for(var r,n=s,a=Element.prototype;a!==n;){r=ko(n);for(var o in r)r[o].set&&t.push(o);n=za(n)}return t}function lt(s,e,t=e){var r=new WeakSet;$a(s,"input",async n=>{var a=n?s.defaultValue:s.value;if(a=Jn(s)?ea(a):a,t(a),Te!==null&&r.add(Te),await ul(),a!==(a=e())){var o=s.selectionStart,l=s.selectionEnd,c=s.value.length;if(s.value=a??"",l!==null){var u=s.value.length;o===l&&l===c&&u>c?(s.selectionStart=u,s.selectionEnd=u):(s.selectionStart=o,s.selectionEnd=Math.min(l,u))}}}),Js(e)==null&&s.value&&(t(Jn(s)?ea(s.value):s.value),Te!==null&&r.add(Te)),mn(()=>{var n=e();if(s===document.activeElement){var a=sn??Te;if(r.has(a))return}Jn(s)&&n===ea(s.value)||s.type==="date"&&!n&&!s.value||n!==s.value&&(s.value=n??"")})}function ml(s,e,t=e){$a(s,"change",r=>{var n=r?s.defaultChecked:s.checked;t(n)}),Js(e)==null&&t(s.checked),mn(()=>{var r=e();s.checked=!!r})}function Jn(s){var e=s.type;return e==="number"||e==="range"}function ea(s){return s===""?null:+s}function Oi(s,e){return s===e||(s==null?void 0:s[As])===e}function ls(s={},e,t,r){return Ja(()=>{var n,a;return mn(()=>{n=a,a=(r==null?void 0:r())||[],Js(()=>{s!==t(...a)&&(e(s,...a),n&&Oi(t(...n),s)&&e(null,...n))})}),()=>{Qr(()=>{a&&Oi(t(...a),s)&&e(null,...a)})}}),s}let Dn=!1;function wu(s){var e=Dn;try{return Dn=!1,[s(),Dn]}finally{Dn=e}}function Os(s,e,t,r){var D;var n=(t&bc)!==0,a=(t&kc)!==0,o=r,l=!0,c=()=>(l&&(l=!1,o=a?Js(r):r),o),u;if(n){var h=As in s||sc in s;u=((D=Nr(s,e))==null?void 0:D.set)??(h&&e in s?S=>s[e]=S:void 0)}var y,v=!1;n?[y,v]=wu(()=>s[e]):y=s[e],y===void 0&&r!==void 0&&(y=c(),u&&(cc(),u(y)));var p;if(p=()=>{var S=s[e];return S===void 0?c():(l=!0,S)},!(t&_c))return p;if(u){var w=s.$$legacy;return function(S,x){return arguments.length>0?((!x||w||v)&&u(x?p():S),S):p()}}var m=!1,g=(t&gc?Vn:jo)(()=>(m=!1,p()));n&&i(g);var b=Fe;return function(S,x){if(arguments.length>0){const F=x?i(g):n?be(S):S;return _(g,F),m=!0,o!==void 0&&(o=F),S}return Zs&&m||b.f&xs?g.v:i(g)}}function _n(s){nt===null&&Ga(),vt(()=>{const e=Js(s);if(typeof e=="function")return e})}function Tu(s){nt===null&&Ga(),_n(()=>()=>Js(s))}const Su="5";var bo;typeof window<"u"&&((bo=window.__svelte??(window.__svelte={})).v??(bo.v=new Set)).add(Su);function Du(){return{type:"daily",interval:1,time:"09:00"}}function gl(s){return!s||!s.type||!s.interval||s.interval<1?!1:s.type==="weekly"?Array.isArray(s.weekdays)&&s.weekdays.length>0&&s.weekdays.every(e=>e>=0&&e<=6):s.type==="monthly"?s.dayOfMonth>=1&&s.dayOfMonth<=31:s.type==="yearly"?s.month>=0&&s.month<=11&&s.dayOfMonth>=1&&s.dayOfMonth<=31:!0}const ir="recurring-tasks-active",Cn="recurring-tasks-archive",Mi="recurring-tasks",Ni="recurring-tasks.json.bak",Ri="n8n-event-settings",qi="n8n-event-queue",Eu="notification-state",xu="recurring-tasks-dock",Li="scheduler-emitted-occurrences",js=4,Ta={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},ni=60*1e3,Au=30*1e3,ta=2e3,Fi="shehab-note-recurring-plugin",Pi="1.0.0",Cu=60*60*1e3,Iu=3,Ui=10,sa=1e3,In=100,Bi=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],Ou=[{label:"+1 day",minutes:60*24},{label:"+3 days",minutes:60*24*3},{label:"+1 week",minutes:60*24*7}],Mu={lowest:"#94a3b8",low:"#64748b",normal:"#3b82f6",medium:"#f59e0b",high:"#f97316",highest:"#ef4444"},Nu=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Yi="last-run-timestamp",ji="custom-recurring-task-id",zi="custom-recurring-task-due",Hi="custom-recurring-task-enabled",En=3,Ki=[1e3,5e3,3e4],Ru=1e4,ai={dueSoonScoreMax:100,dueSoonScoreMin:0,dueDateWeight:10,overdueBaseScore:110,overduePenaltyWeight:15,noDueDateScore:0,priorityMultipliers:{lowest:.8,low:1,normal:1.1,medium:1.2,high:1.5,highest:2},maxUrgency:200,minUrgency:0},_l=24*60*60*1e3,qu=(s,e,t)=>Math.min(t,Math.max(e,s)),Wi=s=>new Date(s.getFullYear(),s.getMonth(),s.getDate()),Lu=(s,e)=>{const t=Wi(s),r=Wi(e);return Math.round((r.getTime()-t.getTime())/_l)},Fu=(s,e)=>e.priorityMultipliers[s]??1;function ii(s,e={}){const t=e.now??new Date,r=e.settings??ai;if(!oi(s))return 0;const n=Wr(s.priority)??"normal",a=Fu(n,r);if(!s.dueAt)return ra(r.noDueDateScore*a,r);const o=new Date(s.dueAt);if(Number.isNaN(o.getTime()))return ra(r.noDueDateScore*a,r);const l=o.getTime()<t.getTime(),c=Lu(t,o),u=l?Math.max(1,Math.ceil((t.getTime()-o.getTime())/_l)):0,h=l?0:qu(r.dueSoonScoreMax-c*r.dueDateWeight,r.dueSoonScoreMin,r.dueSoonScoreMax),y=l?r.overdueBaseScore+u*r.overduePenaltyWeight:0,v=(h+y)*a;return ra(v,r)}function ra(s,e){const t=e.maxUrgency!==void 0?Math.min(e.maxUrgency,s):s;return Math.round(Math.max(e.minUrgency,t))}function bl(s,e,t){const r=new Date().toISOString(),n=t||new Date;return{id:kl(),name:s,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:js,createdAt:r,updatedAt:r}}const Pu=["lowest","low","normal","medium","high","highest"];function Wr(s){if(!s)return;const e=s.toLowerCase();if(e==="urgent")return"highest";if(e==="none")return"normal";if(Pu.includes(e))return e}function kl(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function wl(s,e={}){const t=new Date().toISOString();return{...{...s,id:kl(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Uu(s){const e=new Date().toISOString();s.completionCount=(s.completionCount||0)+1,s.currentStreak=(s.currentStreak||0)+1,s.bestStreak=Math.max(s.bestStreak||0,s.currentStreak),s.recentCompletions||(s.recentCompletions=[]),s.recentCompletions.push(e),s.recentCompletions.length>Ui&&(s.recentCompletions=s.recentCompletions.slice(-Ui)),s.snoozeCount=0,s.lastCompletedAt=e,s.updatedAt=e}function Tl(s){s.missCount=(s.missCount||0)+1,s.currentStreak=0,s.updatedAt=new Date().toISOString()}function Sl(s){const e=s.completionCount||0,t=s.missCount||0,r=e+t;if(r===0)return 100;let a=e/r*70;const o=s.currentStreak||0,l=Math.min(30,o*3);return a+=l,Math.round(Math.min(100,a))}function Bu(s,e){const t=new Set([...s.blockedBy??[],...s.dependsOn??[]]);return t.size===0?!1:e.filter(n=>t.has(n.id)).some(n=>oi(n))}function Yu(s,e){return e.some(t=>t.id===s.id||!new Set([...t.blockedBy??[],...t.dependsOn??[]]).has(s.id)?!1:oi(t))}function oi(s){return s.status?s.status==="todo":s.enabled}function or(s){const{message:e,type:t="info",duration:r=3e3,actionLabel:n,onAction:a,showCountdown:o=!1}=s,l=document.createElement("div");l.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const c=document.createElement("span");c.textContent=e,l.appendChild(c);let u=null;if(n&&a){const y=document.createElement("button");y.type="button";let v=Math.max(1,Math.ceil(r/1e3));y.textContent=o?`${n} (${v}s)`:n,y.className="recurring-tasks-toast__action",y.addEventListener("click",()=>{a(),u!==null&&window.clearInterval(u),l.parentElement&&l.parentElement.removeChild(l)}),l.appendChild(y),o&&r>0&&(u=window.setInterval(()=>{v=Math.max(0,v-1),y.textContent=`${n} (${v}s)`,v<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(l.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:ju(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(l);const h=()=>{u!==null&&window.clearInterval(u),l.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{l.parentElement&&l.parentElement.removeChild(l)},300)};r>0&&setTimeout(()=>{h()},r)}function ju(s){switch(s){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const G={success:(s,e)=>or({message:s,type:"success",duration:e}),error:(s,e)=>or({message:s,type:"error",duration:e}),warning:(s,e)=>or({message:s,type:"warning",duration:e}),info:(s,e)=>or({message:s,type:"info",duration:e})};if(typeof document<"u"){const s=document.createElement("style");s.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(s)}class zu{constructor(){E(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var r;return(r=this.handlers.get(e))==null?void 0:r.delete(t)}}emit(e,t){var r;(r=this.handlers.get(e))==null||r.forEach(n=>n(t))}clear(){this.handlers.clear()}}const Qe=new zu;function na(s,e){const t=s.findIndex(n=>n.id===e.id);if(t===-1)return[...s,e];const r=[...s];return r[t]=e,r}function Gi(s,e){const t=s.filter(r=>r.id!==e);return t.length===s.length?s:t}function aa(s,e,t){let r=!1;const n=s.map(a=>a.id!==e?a:(r=!0,t(a)));return r?n:s}function Hu(s,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),s.filter(r=>r.enabled?new Date(r.dueAt)<=t:!1)}const li=Symbol("urgency-settings"),Ku=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function $n(s,e,t){const r={timestamp:new Date().toISOString()},n=`[${s.toUpperCase()}] [${r.timestamp}]`;s==="error"?console.error(n,e,t||""):s==="warn"?console.warn(n,e,t||""):s==="debug"&&Ku?console.debug(n,e,t||""):s==="info"&&console.log(n,e,t||"")}function Dl(s,e){$n("debug",s,e)}function de(s,e){$n("info",s,e)}function Ke(s,e){$n("warn",s,e)}function ge(s,e){$n("error",s,e)}async function Wu(s){return new Promise(e=>{try{Ya.fetchPost("/api/block/getBlockInfo",{id:s},t=>{var n,a,o;const r=((n=t==null?void 0:t.data)==null?void 0:n.content)??((a=t==null?void 0:t.data)==null?void 0:a.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(r?r.trim():null)})}catch(t){Ke("Failed to fetch block preview",t),e(null)}})}async function Gu(s){return new Promise(e=>{try{Ya.fetchPost("/api/block/getBlockHTML",{id:s},t=>{var n;const r=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(r?r.trim():null)})}catch(t){Ke("Failed to fetch block embed",t),e(null)}})}function Sa(s){const[e,t]=s.split(":").map(Number);return{hours:e,minutes:t}}function Vu(s){const e=s.getHours().toString().padStart(2,"0"),t=s.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function Qu(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Da(s){return s.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function ci(s){const e=new Date;return s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()}function $u(s){return s<new Date}function Xu(s){return $u(s)&&!ci(s)}function dn(s,e){const t=new Date(s);return t.setDate(t.getDate()+e),t}function Vi(s,e){return dn(s,e*7)}function Qi(s,e,t){const r=new Date(s);r.setHours(e,t,0,0);const n=r.getHours()!==e||r.getMinutes()!==t;return{date:r,shifted:n}}function Ea(s){const e=new Date(s);return e.setHours(0,0,0,0),e}function Zu(s){const e=new Date(s);return e.setHours(23,59,59,999),e}function Ju(s,e){const r=Math.abs(e.getTime()-s.getTime());return Math.floor(r/864e5)}function ed(s,e){const t=[];for(let r=0;r<e;r++)t.push(dn(s,r));return t}var td=I('<span class="task-card__streak svelte-yjw1ud"> </span>'),sd=I('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">✏️</button>'),rd=I('<span class="task-card__relative svelte-yjw1ud"> </span>'),nd=I('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),ad=I('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),id=I('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),od=I('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),ld=I('<button class="task-card__snooze-chip"> </button>'),cd=I('<button class="task-card__snooze-option" role="menuitem"> </button>'),ud=I('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),dd=I('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <div class="task-card__urgency svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Urgency:</span> <span class="task-card__value svelte-yjw1ud"> </span></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">🕒 Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">🕒 Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">⏭️ Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">✅ Done</button></div></div>');function $r(s,e){Ge(e,!0);const t=Z(()=>new Date(e.task.dueAt)),r=Z(()=>Xu(i(t))),n=Z(()=>ci(i(t))),a=Z(()=>i(r)?Ju(new Date(e.task.dueAt),new Date):0),o=Z(()=>i(r)?"task-card--overdue":i(n)?"task-card--today":""),l=Z(()=>()=>i(r)?`rgba(244, 67, 54, ${Math.min(.45,.12+i(a)*.05)})`:""),c=Z(()=>()=>i(r)?`rgba(244, 67, 54, ${Math.min(.8,.3+i(a)*.08)})`:""),u=Z(()=>()=>{const ne=Wr(e.task.priority)||"normal";return Mu[ne]}),h=Z(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(i(t)):""),y=Z(()=>(e.task.currentStreak||0)>0),v=Z(()=>()=>"🔥"),p=Z(()=>Sl(e.task)),w=Z(()=>i(p)>=80?"health--good":i(p)>=50?"health--fair":"health--poor"),m=Io(li),g=Z(()=>ii(e.task,{settings:m}));let b=V(!1),D=V(-1),S=[],x=V(!1),F=V(null),P=V(null),N=V(!1);const W=Z(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}…`:e.task.linkedBlockId:""),j=Z(()=>()=>{if(!i(F))return"";const ne=i(F).replace(/\s+/g," ").trim();return ne.length>220?`${ne.slice(0,220)}…`:ne}),ee=Z(()=>()=>Bi.filter(ne=>[15,60,120].includes(ne.minutes))),re=Z(()=>()=>`snooze-menu-${e.task.id}`);vt(()=>{_(F,e.task.linkedBlockContent??null,!0),_(P,null),_(N,!1)});function ae(){e.onDone(e.task)}function he(){e.onDelay(e.task)}function me(){e.onEdit&&e.onEdit(e.task)}function H(){e.onSkip(e.task)}async function q(){_(b,!i(b)),i(b)&&(await ul(),_(D,-1),S=[])}function A(ne){const _e=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ne}});window.dispatchEvent(_e),_(b,!1),_(D,-1)}function Y(ne){var qe,ce,we,Le;const _e=i(ee);ne.key==="ArrowDown"?(ne.preventDefault(),_(D,Math.min(i(D)+1,_e.length-1),!0),(qe=S[i(D)])==null||qe.focus()):ne.key==="ArrowUp"?(ne.preventDefault(),_(D,Math.max(i(D)-1,0),!0),(ce=S[i(D)])==null||ce.focus()):ne.key==="Escape"?(_(b,!1),_(D,-1)):ne.key==="Home"?(ne.preventDefault(),_(D,0),(we=S[0])==null||we.focus()):ne.key==="End"&&(ne.preventDefault(),_(D,_e.length-1),(Le=S[i(D)])==null||Le.focus())}function se(ne){if(ne.key==="Escape"&&i(b)){_(b,!1);return}(ne.key==="Enter"||ne.key===" ")&&(ne.preventDefault(),q())}async function J(){if(_(x,!0),!e.task.linkedBlockId||i(N)||i(P))return;_(N,!0);const[ne,_e]=await Promise.all([Gu(e.task.linkedBlockId),Wu(e.task.linkedBlockId)]);_(P,ne,!0),_(F,_e,!0),_(N,!1)}function ye(){_(x,!1)}const ve=Z(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,_e=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[_e]||_e)}`);var fe=dd();fe.__keydown=ne=>{ne.key==="Escape"&&i(b)&&_(b,!1)};var te=d(fe),oe=d(te),Ee=d(oe),R=f(Ee,2),Q=d(R),k=f(R,2);{var L=ne=>{var _e=td(),qe=d(_e);z(ce=>{Se(_e,"title",`${e.task.currentStreak??""} day streak`),B(qe,`${ce??""} ${e.task.currentStreak??""}`)},[()=>i(v)()]),T(ne,_e)};K(k,ne=>{i(y)&&ne(L)})}var X=f(oe,2);{var ie=ne=>{var _e=sd();_e.__click=me,T(ne,_e)};K(X,ne=>{e.onEdit&&ne(ie)})}var C=f(te,2),O=d(C),le=f(d(O),2),ke=d(le),Ae=f(le,2);{var Ie=ne=>{var _e=rd(),qe=d(_e);z(ce=>B(qe,ce),[()=>i(h)()]),T(ne,_e)};K(Ae,ne=>{e.timezoneHandler&&ne(Ie)})}var Oe=f(O,2),Be=f(d(Oe),2),Ct=d(Be),Tt=f(Oe,2);{var et=ne=>{var _e=nd(),qe=f(d(_e),2),ce=d(qe);z(we=>B(ce,we),[()=>Da(new Date(e.task.lastCompletedAt))]),T(ne,_e)};K(Tt,ne=>{e.task.lastCompletedAt&&ne(et)})}var Rt=f(Tt,2);{var gt=ne=>{var _e=od(),qe=d(_e),ce=d(qe),we=f(qe,2);{var Le=We=>{var st=id(),rt=d(st);{var St=_t=>{var ss=Rr("Loading preview…");T(_t,ss)},Ht=_t=>{var ss=He(),Ft=Pe(ss);{var rs=Pt=>{var U=ad(),ue=d(U);hu(ue,()=>i(P)),T(Pt,U)},Bs=Pt=>{var U=He(),ue=Pe(U);{var Xe=Kt=>{var wr=Rr();z(()=>B(wr,i(j))),T(Kt,wr)},ks=Kt=>{var wr=Rr("No preview available.");T(Kt,wr)};K(ue,Kt=>{i(F)?Kt(Xe):Kt(ks,!1)},!0)}T(Pt,U)};K(Ft,Pt=>{i(P)?Pt(rs):Pt(Bs,!1)},!0)}T(_t,ss)};K(rt,_t=>{i(N)?_t(St):_t(Ht,!1)})}T(We,st)};K(we,We=>{i(x)&&We(Le)})}z(()=>{Se(qe,"title",`Linked block: ${e.task.linkedBlockId}`),B(ce,`📝 Block ${i(W)??""}`)}),pt("mouseenter",qe,J),pt("mouseleave",qe,ye),pt("focus",qe,J),pt("blur",qe,ye),T(ne,_e)};K(Rt,ne=>{e.task.linkedBlockId&&ne(gt)})}var Me=f(C,2),It=d(Me),ze=f(Me,2),$e=d(ze),tt=d($e);tt.__click=q,tt.__keydown=se;var qt=f(tt,2),Lt=d(qt);Ue(Lt,17,()=>i(ee),yt,(ne,_e)=>{var qe=ld();qe.__click=()=>A(i(_e).minutes);var ce=d(qe);z(()=>{Se(qe,"aria-label",`Snooze for ${i(_e).label}`),B(ce,i(_e).label)}),T(ne,qe)});var ts=f(Lt,2);ts.__click=he;var Fs=f(qt,2);{var Ps=ne=>{var _e=ud();_e.__keydown=Y,Ue(_e,21,()=>Bi,yt,(qe,ce,we)=>{var Le=cd();Le.__click=()=>A(i(ce).minutes),Se(Le,"tabindex",we===0?0:-1);var We=d(Le);ls(Le,(st,rt)=>S[rt]=st,st=>S==null?void 0:S[st],()=>[we]),z(()=>B(We,i(ce).label)),T(qe,Le)}),z(()=>Se(_e,"id",i(re))),T(ne,_e)};K(Fs,ne=>{i(b)&&ne(Ps)})}var cs=f($e,2);cs.__click=he;var bs=f(cs,2);bs.__click=H;var Us=f(bs,2);Us.__click=ae,z((ne,_e)=>{je(fe,1,`task-card ${i(o)??""}`,"svelte-yjw1ud"),mr(fe,`--overdue-tint: ${i(l)??""}; --overdue-border: ${i(c)??""};`),Se(fe,"aria-label",ne),Se(fe,"data-task-id",e.task.id),mr(Ee,`background-color: ${i(u)??""}`),Se(Ee,"title",`Priority:  ${(e.task.priority||"normal")??""}`),B(Q,e.task.name),B(ke,_e),Se(Oe,"title",`Urgency score: ${i(g)??""}`),B(Ct,i(g)),je(Me,1,`task-card__health ${i(w)??""}`,"svelte-yjw1ud"),Se(Me,"title",`Task health:  ${i(p)??""}%`),mr(It,`width: ${i(p)??""}%`),Se(tt,"aria-expanded",i(b)),Se(tt,"aria-controls",i(re))},[()=>i(ve)(),()=>Da(i(t))]),T(s,fe),Ve()}at(["keydown","click"]);var hd=I(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">🎉 No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),fd=I('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),vd=I('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function pd(s,e){Ge(e,!0);const t=Z(()=>[...e.tasks].sort((m,g)=>new Date(m.dueAt).getTime()-new Date(g.dueAt).getTime()));let r=V(0),n=be([]);vt(()=>{i(r)>=i(t).length&&_(r,Math.max(0,i(t).length-1),!0)});function a(m){var b;if(i(t).length===0)return;const g=Math.max(0,Math.min(m,i(t).length-1));_(r,g,!0),(b=n[g])==null||b.focus()}function o(m,g){m.key==="ArrowDown"?(m.preventDefault(),a(g+1)):m.key==="ArrowUp"?(m.preventDefault(),a(g-1)):m.key==="Home"?(m.preventDefault(),a(0)):m.key==="End"&&(m.preventDefault(),a(i(t).length-1))}var l=vd(),c=d(l),u=f(d(c),2),h=d(u),y=f(c,2),v=d(y);{var p=m=>{var g=hd();T(m,g)},w=m=>{var g=He(),b=Pe(g);Ue(b,19,()=>i(t),D=>D.id,(D,S,x)=>{var F=fd();F.__keydown=N=>o(N,i(x));var P=d(F);$r(P,{get task(){return i(S)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),ls(F,(N,W)=>n[W]=N,N=>n==null?void 0:n[N],()=>[i(x)]),z(()=>Se(F,"tabindex",i(x)===i(r)?0:-1)),pt("focus",F,()=>_(r,i(x),!0)),T(D,F)}),T(m,g)};K(v,m=>{i(t).length===0?m(p):m(w,!1)})}z(()=>B(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),T(s,l),Ve()}at(["keydown"]);var yd=I('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),md=I('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),gd=I('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">✏️</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">📄</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">🗑️</button></div></td></tr>'),_d=I('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),bd=I('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),kd=I('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),wd=I('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Td=I('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">🔍</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Sd(s,e){Ge(e,!0);let t=V(null),r=V(!1),n=V(""),a=V(""),o=V(be(new Set)),l=V(0),c=be([]),u=V(null);const h=Z(()=>[...e.tasks].sort((C,O)=>new Date(C.dueAt).getTime()-new Date(O.dueAt).getTime())),y=Z(()=>()=>{const C=i(a).trim().toLowerCase();return C?i(h).filter(O=>{var ke;return[O.name,O.description,O.category,O.linkedBlockContent,(ke=O.tags)==null?void 0:ke.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(C)}):i(h)}),v=Z(()=>i(y).map(C=>C.id)),p=Z(()=>i(o).size>0),w=Z(()=>i(y).length>0&&i(y).every(C=>i(o).has(C.id))),m=Z(()=>i(y).some(C=>i(o).has(C.id))&&!i(w));vt(()=>{const C=new Set([...i(o)].filter(O=>e.tasks.some(le=>le.id===O)));C.size!==i(o).size&&_(o,C,!0)}),vt(()=>{i(u)&&(i(u).indeterminate=i(m))}),vt(()=>{i(l)>=i(y).length&&_(l,Math.max(0,i(y).length-1),!0)}),vt(()=>{const C=window.setTimeout(()=>{_(a,i(n),!0)},300);return()=>{window.clearTimeout(C)}});function g(C){_(t,C,!0)}function b(){i(t)&&(e.onDelete(i(t)),_(t,null))}function D(){_(t,null)}function S(C){const O=new Set(i(o));O.has(C)?O.delete(C):O.add(C),_(o,O,!0)}function x(){const C=new Set(i(o));i(w)?i(v).forEach(O=>C.delete(O)):i(v).forEach(O=>C.add(O)),_(o,C,!0)}function F(C){var le;if(i(y).length===0)return;const O=Math.max(0,Math.min(C,i(y).length-1));_(l,O,!0),(le=c[O])==null||le.focus()}function P(C,O){C.key==="ArrowDown"?(C.preventDefault(),F(O+1)):C.key==="ArrowUp"?(C.preventDefault(),F(O-1)):C.key==="Home"?(C.preventDefault(),F(0)):C.key==="End"&&(C.preventDefault(),F(i(y).length-1))}function N(){if(i(o).size===0){_(r,!1);return}e.onBulkDelete([...i(o)]),_(o,new Set,!0),_(r,!1)}function W(){_(r,!1)}function j(C){const{type:O,interval:le}=C.frequency,ke=O==="daily"?"day":O==="weekly"?"week":O==="monthly"?"month":"year",Ae=le===1?`Every ${ke}`:`Every ${le} ${ke}s`;if(O==="weekly")return`${Ae} on ${C.frequency.weekdays.map(Ie=>Nu[Ie]??Ie).join(", ")}`;if(O==="monthly")return`${Ae} on day ${C.frequency.dayOfMonth}`;if(O==="yearly"){const Ie=ee[C.frequency.month]??`Month ${C.frequency.month+1}`;return`${Ae} on ${Ie} ${C.frequency.dayOfMonth}`}return Ae}const ee=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var re=Td(),ae=Pe(re),he=d(ae),me=f(d(he),2),H=d(me),q=f(d(H),2),A=f(H,2);A.__click=function(...C){var O;(O=e.onCreate)==null||O.apply(this,C)};var Y=f(he,2),se=d(Y),J=d(se),ye=d(J),ve=f(J,2),fe=d(ve);fe.__click=()=>e.onBulkEnable([...i(o)]);var te=f(fe,2);te.__click=()=>e.onBulkDisable([...i(o)]);var oe=f(te,2);oe.__click=()=>_(r,!0);var Ee=f(se,2);{var R=C=>{var O=yd();T(C,O)},Q=C=>{var O=bd(),le=d(O);{var ke=Ie=>{var Oe=md(),Be=d(Oe),Ct=d(Be);z(Tt=>B(Ct,`No tasks match "${Tt??""}".`),[()=>i(a).trim()]),T(Ie,Oe)},Ae=Ie=>{var Oe=_d(),Be=d(Oe),Ct=d(Be),Tt=d(Ct),et=d(Tt);et.__click=x,ls(et,gt=>_(u,gt),()=>i(u));var Rt=f(Be);Ue(Rt,23,()=>i(y),gt=>gt.id,(gt,Me,It)=>{var ze=gd();ze.__keydown=We=>P(We,i(It));var $e=d(ze),tt=d($e);tt.__click=()=>S(i(Me).id);var qt=f($e),Lt=d(qt),ts=f(qt),Fs=d(ts),Ps=f(ts),cs=d(Ps),bs=f(Ps),Us=d(bs),ne=d(Us);ne.__change=()=>e.onToggleEnabled(i(Me));var _e=f(bs),qe=d(_e),ce=d(qe);ce.__click=()=>e.onEdit(i(Me));var we=f(ce,2);we.__click=()=>e.onDuplicate(i(Me));var Le=f(we,2);Le.__click=()=>g(i(Me)),ls(ze,(We,st)=>c[st]=We,We=>c==null?void 0:c[We],()=>[i(It)]),z((We,st,rt,St)=>{je(ze,1,pu(i(Me).enabled?"":"disabled"),"svelte-i091qn"),Se(ze,"tabindex",i(It)===i(l)?0:-1),Se(ze,"aria-selected",We),Se(tt,"aria-label",`Select ${i(Me).name}`),qr(tt,st),B(Lt,i(Me).name),B(Fs,rt),B(cs,St),qr(ne,i(Me).enabled)},[()=>i(o).has(i(Me).id),()=>i(o).has(i(Me).id),()=>Da(new Date(i(Me).dueAt)),()=>j(i(Me))]),pt("focus",ze,()=>_(l,i(It),!0)),T(gt,ze)}),z(()=>{qr(et,i(w)),et.disabled=i(y).length===0}),T(Ie,Oe)};K(le,Ie=>{i(y).length===0?Ie(ke):Ie(Ae,!1)})}T(C,O)};K(Ee,C=>{i(h).length===0?C(R):C(Q,!1)})}var k=f(ae,2);{var L=C=>{var O=kd(),le=d(O),ke=f(d(le),2),Ae=d(ke),Ie=f(ke,2),Oe=d(Ie);Oe.__click=D;var Be=f(Oe,2);Be.__click=b,z(()=>B(Ae,`Are you sure you want to delete "${i(t).name??""}"? This action cannot be undone.`)),T(C,O)};K(k,C=>{i(t)&&C(L)})}var X=f(k,2);{var ie=C=>{var O=wd(),le=d(O),ke=f(d(le),2),Ae=d(ke),Ie=f(ke,2),Oe=d(Ie);Oe.__click=W;var Be=f(Oe,2);Be.__click=N,z(()=>B(Ae,`Are you sure you want to delete ${i(o).size??""} task${i(o).size===1?"":"s"}? This action cannot be undone.`)),T(C,O)};K(X,C=>{i(r)&&C(ie)})}z(()=>{q.disabled=i(h).length===0,B(ye,`${i(o).size??""} selected`),fe.disabled=!i(p),te.disabled=!i(p),oe.disabled=!i(p)}),lt(q,()=>i(n),C=>_(n,C)),T(s,re),Ve()}at(["click","keydown","change"]);var Dd=I('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Ed=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),xd=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Ad=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Cd=I('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Id=I('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Od=I('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Md=I('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Nd(s,e){Ge(e,!0);let t=Os(e,"days",3,30);function r(b){const{frequency:D}=b;if(D.type==="weekly"){const S=[...D.weekdays].sort((x,F)=>x-F).join(",");return`weekly:${D.interval}:${D.time??""}:${S}`}return D.type==="monthly"?`monthly:${D.interval}:${D.time??""}:${D.dayOfMonth}`:D.type==="yearly"?`yearly:${D.interval}:${D.time??""}:${D.month}:${D.dayOfMonth}`:`daily:${D.interval}:${D.time??""}`}function n(b,D){const S=b.map(x=>`${x.id}:${x.enabled}:${x.dueAt}:${r(x)}`).join("|");return`${D}:${S}`}function a(b,D){const S=Ea(new Date),x=Zu(dn(S,D-1)),F=24*60*60*1e3,N=ed(S,D).map(W=>({date:W,tasks:[]}));for(const W of b.filter(j=>j.enabled)){const j=new Date(W.dueAt),ee=e.recurrenceEngine.getOccurrencesInRange(S,x,W.frequency,j);for(const re of ee){const ae=Ea(re),he=Math.floor((ae.getTime()-S.getTime())/F);he>=0&&he<D&&N[he].tasks.push({task:W,occurrence:re})}}for(const W of N)W.tasks.sort((j,ee)=>j.occurrence.getTime()-ee.occurrence.getTime());return N}const o=(()=>{let b="",D=[];return{get(S,x){const F=n(S,x);return F===b||(b=F,D=a(S,x)),D}}})(),l=Z(()=>o.get(e.tasks,t())),c=Z(()=>i(l).some(b=>b.tasks.length>0));var u=Md(),h=d(u),y=f(d(h),2),v=d(y),p=f(h,2),w=d(p);{var m=b=>{var D=Dd(),S=d(D),x=d(S);z(()=>B(x,`No tasks scheduled in the next ${t()??""} days.`)),T(b,D)},g=b=>{var D=Od();Ue(D,21,()=>i(l),S=>S.date.toISOString(),(S,x)=>{var F=He(),P=Pe(F);{var N=W=>{var j=Id(),ee=d(j),re=d(ee),ae=d(re),he=f(re,2),me=d(he),H=f(ee,2);Ue(H,21,()=>i(x).tasks,({task:q,occurrence:A})=>q.id+A.toISOString(),(q,A)=>{let Y=()=>i(A).task,se=()=>i(A).occurrence;var J=Cd(),ye=d(J),ve=d(ye),fe=f(ye,2),te=d(fe),oe=d(te),Ee=f(te,2),R=d(Ee);{var Q=C=>{var O=Ed(),le=d(O);z(()=>B(le,`🔗 ${Y().linkedBlockId??""}`)),T(C,O)};K(R,C=>{Y().linkedBlockId&&C(Q)})}var k=f(R,2);{var L=C=>{var O=xd(),le=d(O);z(()=>B(le,`⚡ ${Y().priority??""}`)),T(C,O)};K(k,C=>{Y().priority&&C(L)})}var X=f(k,2);{var ie=C=>{var O=Ad(),le=d(O);z(ke=>B(le,`🏷️ ${ke??""}`),[()=>Y().tags.join(", ")]),T(C,O)};K(X,C=>{var O;(O=Y().tags)!=null&&O.length&&C(ie)})}z(C=>{B(ve,C),B(oe,Y().name)},[()=>Vu(se())]),T(q,J)}),z((q,A)=>{B(ae,q),B(me,A)},[()=>Qu(i(x).date),()=>i(x).date.toLocaleDateString(void 0,{weekday:"short"})]),T(W,j)};K(P,W=>{i(x).tasks.length>0&&W(N)})}T(S,F)}),T(b,D)};K(w,b=>{i(c)?b(g,!1):b(m)})}z(()=>B(v,`Next ${t()??""} days`)),T(s,u),Ve()}var Rd=I('<span class="leaderboard-item__badge svelte-1ptoc1q">🏆 Best</span>'),qd=I('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Ld=I('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">🔥 Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Fd=I('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Pd=I('<h4 class="subsection-title svelte-1ptoc1q">✅ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Ud=I('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Bd=I('<h4 class="subsection-title svelte-1ptoc1q">⚠️ Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Yd=I('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">✅</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),jd=I('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),zd=I('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function Hd(s,e){Ge(e,!0);const t=Z(()=>()=>{let q=0,A=0;for(const J of e.tasks)q+=J.completionCount||0,A+=J.missCount||0;const Y=q+A,se=Y>0?q/Y*100:100;return{totalCompletions:q,totalMisses:A,completionRate:Math.round(se)}}),r=Z(()=>()=>[...e.tasks].filter(q=>(q.currentStreak||0)>0).sort((q,A)=>(A.currentStreak||0)-(q.currentStreak||0)).slice(0,10)),n=Z(()=>()=>[...e.tasks].map(q=>({task:q,health:Sl(q)})).sort((q,A)=>q.health-A.health)),a=Z(()=>()=>i(n)().slice(-5).reverse()),o=Z(()=>()=>i(n)().slice(0,5)),l=Z(()=>()=>{const q=[];for(const A of e.tasks)if(A.recentCompletions&&A.recentCompletions.length>0)for(const Y of A.recentCompletions)q.push({task:A,completedAt:Y});return q.sort((A,Y)=>new Date(Y.completedAt).getTime()-new Date(A.completedAt).getTime()).slice(0,10)});function c(q){return new Date(q).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(q){return q>=80?"#10b981":q>=60?"#3b82f6":q>=40?"#f59e0b":"#ef4444"}var h=zd(),y=f(d(h),2),v=d(y),p=f(d(v),2),w=d(p),m=d(w),g=d(m),b=f(w,2),D=d(b),S=d(D),x=f(b,2),F=d(x),P=d(F),N=f(v,2);{var W=q=>{var A=Ld(),Y=f(d(A),2);Ue(Y,21,()=>i(r)(),yt,(se,J,ye)=>{var ve=qd(),fe=d(ve);fe.textContent=`#${ye+1}`;var te=f(fe,2),oe=d(te),Ee=f(te,2),R=d(Ee),Q=f(R);{var k=L=>{var X=Rd();T(L,X)};K(Q,L=>{i(J).bestStreak&&i(J).currentStreak===i(J).bestStreak&&L(k)})}z(()=>{B(oe,i(J).name),B(R,`${i(J).currentStreak??""} day${i(J).currentStreak!==1?"s":""} `)}),T(se,ve)}),T(q,A)};K(N,q=>{i(r)().length>0&&q(W)})}var j=f(N,2),ee=f(d(j),2);{var re=q=>{var A=Pd(),Y=f(Pe(A),2);Ue(Y,21,()=>i(a)(),yt,(se,J)=>{let ye=()=>i(J).task,ve=()=>i(J).health;var fe=Fd(),te=d(fe),oe=d(te),Ee=f(te,2),R=d(Ee),Q=f(R,2),k=d(Q);z(L=>{B(oe,ye().name),mr(R,`width: ${ve()??""}%; background-color: ${L??""}`),B(k,`${ve()??""}/100`)},[()=>u(ve())]),T(se,fe)}),T(q,A)};K(ee,q=>{i(a)().length>0&&q(re)})}var ae=f(ee,2);{var he=q=>{var A=Bd(),Y=f(Pe(A),2);Ue(Y,21,()=>i(o)(),yt,(se,J)=>{let ye=()=>i(J).task,ve=()=>i(J).health;var fe=Ud(),te=d(fe),oe=d(te),Ee=f(te,2),R=d(Ee),Q=f(R,2),k=d(Q);z(L=>{B(oe,ye().name),mr(R,`width: ${ve()??""}%; background-color: ${L??""}`),B(k,`${ve()??""}/100`)},[()=>u(ve())]),T(se,fe)}),T(q,A)};K(ae,q=>{i(o)().length>0&&i(o)()[0].health<80&&q(he)})}var me=f(j,2);{var H=q=>{var A=jd(),Y=f(d(A),2);Ue(Y,21,()=>i(l)(),yt,(se,J)=>{let ye=()=>i(J).task,ve=()=>i(J).completedAt;var fe=Yd(),te=f(d(fe),2),oe=d(te),Ee=d(oe),R=f(oe,2),Q=d(R);z(k=>{B(Ee,ye().name),B(Q,k)},[()=>c(ve())]),T(se,fe)}),T(q,A)};K(me,q=>{i(l)().length>0&&q(H)})}z((q,A,Y)=>{B(g,q),B(S,A),B(P,`${Y??""}%`)},[()=>i(t)().totalCompletions,()=>i(t)().totalMisses,()=>i(t)().completionRate]),T(s,h),Ve()}var Kd=I('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">📥 No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),Wd=I('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),Gd=I('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function Vd(s,e){Ge(e,!0);const t=Z(()=>e.tasks.filter(m=>m.status!=="done"&&m.status!=="cancelled"&&!m.dueAt&&!m.scheduledAt&&!m.startAt).sort((m,g)=>new Date(g.createdAt).getTime()-new Date(m.createdAt).getTime()));let r=V(0),n=be([]);vt(()=>{i(r)>=i(t).length&&_(r,Math.max(0,i(t).length-1),!0)});function a(m){var b;if(i(t).length===0)return;const g=Math.max(0,Math.min(m,i(t).length-1));_(r,g,!0),(b=n[g])==null||b.focus()}function o(m,g){m.key==="ArrowDown"?(m.preventDefault(),a(g+1)):m.key==="ArrowUp"?(m.preventDefault(),a(g-1)):m.key==="Enter"&&e.onEdit?(m.preventDefault(),e.onEdit(i(t)[g])):m.key===" "&&e.onDone&&(m.preventDefault(),e.onDone(i(t)[g]))}var l=Gd(),c=d(l),u=f(d(c),2),h=d(u),y=f(c,2),v=d(y);{var p=m=>{var g=Kd();T(m,g)},w=m=>{var g=He(),b=Pe(g);Ue(b,19,()=>i(t),D=>D.id,(D,S,x)=>{var F=Wd();F.__keydown=N=>o(N,i(x));var P=d(F);$r(P,{get task(){return i(S)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ls(F,(N,W)=>n[W]=N,N=>n==null?void 0:n[N],()=>[i(x)]),z(()=>Se(F,"tabindex",i(x)===i(r)?0:-1)),pt("focus",F,()=>_(r,i(x),!0)),T(D,F)}),T(m,g)};K(v,m=>{i(t).length===0?m(p):m(w,!1)})}z(()=>B(h,`${i(t).length??""} task${i(t).length!==1?"s":""} without dates`)),T(s,l),Ve()}at(["keydown"]);var Qd=I('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),$d=I('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),Xd=I('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),Zd=I('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function Jd(s,e){Ge(e,!0);let t=Os(e,"daysAhead",3,7);const r=new Date;r.setHours(0,0,0,0);const n=new Date(r);n.setDate(n.getDate()+t());const a=Z(()=>e.tasks.filter(S=>{if(S.status==="done"||S.status==="cancelled"||!S.dueAt)return!1;const x=new Date(S.dueAt);return x.setHours(0,0,0,0),x>r&&x<=n}).sort((S,x)=>new Date(S.dueAt).getTime()-new Date(x.dueAt).getTime())),o=Z(()=>()=>{const S=new Map;return i(a).forEach(x=>{const F=new Date(x.dueAt);F.setHours(0,0,0,0);const P=F.toISOString().split("T")[0];S.has(P)||S.set(P,[]),S.get(P).push(x)}),S});function l(S){const x=new Date(S),F=Math.floor((x.getTime()-r.getTime())/(1e3*60*60*24)),P=x.toLocaleDateString("en-US",{weekday:"long"}),N=x.toLocaleDateString("en-US",{month:"short",day:"numeric"});return F===1?`Tomorrow - ${P}, ${N}`:`${P}, ${N} (in ${F} days)`}let c=V(0),u=be([]);vt(()=>{i(c)>=i(a).length&&_(c,Math.max(0,i(a).length-1),!0)});function h(S,x){S.key==="ArrowDown"?(S.preventDefault(),_(c,Math.min(i(c)+1,i(a).length-1),!0)):S.key==="ArrowUp"?(S.preventDefault(),_(c,Math.max(i(c)-1,0),!0)):S.key==="Enter"&&e.onEdit?(S.preventDefault(),e.onEdit(i(a)[x])):S.key===" "&&e.onDone&&(S.preventDefault(),e.onDone(i(a)[x]))}var y=Zd(),v=d(y),p=f(d(v),2),w=d(p),m=f(v,2),g=d(m);{var b=S=>{var x=Qd(),F=d(x),P=d(F);z(()=>B(P,`📅 No tasks scheduled for the next ${t()??""} days`)),T(S,x)},D=S=>{var x=He(),F=Pe(x);Ue(F,17,()=>[...i(o).entries()],yt,(P,N)=>{var W=Z(()=>To(i(N),2));let j=()=>i(W)[0],ee=()=>i(W)[1];var re=Xd(),ae=d(re),he=d(ae),me=f(ae,2);Ue(me,19,ee,H=>H.id,(H,q)=>{const A=Z(()=>i(a).indexOf(i(q)));var Y=$d();Y.__keydown=J=>h(J,i(A));var se=d(Y);$r(se,{get task(){return i(q)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ls(Y,(J,ye)=>u[ye]=J,J=>u==null?void 0:u[J],()=>[i(A)]),z(()=>Se(Y,"tabindex",i(A)===i(c)?0:-1)),pt("focus",Y,()=>_(c,i(A),!0)),T(H,Y)}),z(H=>B(he,H),[()=>l(j())]),T(P,re)}),T(S,x)};K(g,S=>{i(a).length===0?S(b):S(D,!1)})}z(()=>B(w,`${i(a).length??""} task${i(a).length!==1?"s":""} in the next ${t()??""} days`)),T(s,y),Ve()}at(["keydown"]);var eh=I('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">✅ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),th=I('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),sh=I('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),rh=I('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">← Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next →</button></div>'),nh=I("<!> <!>",1),ah=I('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function ih(s,e){Ge(e,!0);let t=Os(e,"daysBack",3,30),r=V(0);const n=50,a=new Date;a.setDate(a.getDate()-t()),a.setHours(0,0,0,0);const o=Z(()=>e.tasks.filter(N=>N.status!=="done"||!N.doneAt?!1:new Date(N.doneAt)>=a).sort((N,W)=>new Date(W.doneAt).getTime()-new Date(N.doneAt).getTime())),l=Z(()=>Math.ceil(i(o).length/n)),c=Z(()=>i(o).slice(i(r)*n,(i(r)+1)*n));vt(()=>{i(r)>=i(l)&&i(l)>0&&_(r,i(l)-1)});function u(){i(r)<i(l)-1&&ki(r)}function h(){i(r)>0&&ki(r,-1)}function y(N){const W=new Date(N),j=new Date,ee=j.getTime()-W.getTime(),re=Math.floor(ee/(1e3*60*60*24));return re===0?"Today":re===1?"Yesterday":re<7?`${re} days ago`:W.toLocaleDateString("en-US",{month:"short",day:"numeric",year:W.getFullYear()!==j.getFullYear()?"numeric":void 0})}let v=V(0),p=be([]);vt(()=>{i(v)>=i(c).length&&_(v,Math.max(0,i(c).length-1),!0)});function w(N,W){N.key==="ArrowDown"?(N.preventDefault(),_(v,Math.min(i(v)+1,i(c).length-1),!0)):N.key==="ArrowUp"?(N.preventDefault(),_(v,Math.max(i(v)-1,0),!0)):N.key==="Enter"&&e.onEdit&&(N.preventDefault(),e.onEdit(i(c)[W]))}var m=ah(),g=d(m),b=f(d(g),2),D=d(b),S=f(g,2),x=d(S);{var F=N=>{var W=eh();T(N,W)},P=N=>{var W=nh(),j=Pe(W);Ue(j,19,()=>i(c),ae=>ae.id,(ae,he,me)=>{var H=sh();H.__keydown=ve=>w(ve,i(me));var q=d(H),A=d(q),Y=d(A),se=f(A,2);{var J=ve=>{var fe=th();fe.__click=()=>e.onUncomplete(i(he)),T(ve,fe)};K(se,ve=>{e.onUncomplete&&ve(J)})}var ye=f(q,2);$r(ye,{get task(){return i(he)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),ls(H,(ve,fe)=>p[fe]=ve,ve=>p==null?void 0:p[ve],()=>[i(me)]),z(ve=>{Se(H,"tabindex",i(me)===i(v)?0:-1),B(Y,`Completed ${ve??""}`)},[()=>y(i(he).doneAt)]),pt("focus",H,()=>_(v,i(me),!0)),T(ae,H)});var ee=f(j,2);{var re=ae=>{var he=rh(),me=d(he);me.__click=h;var H=f(me,2),q=d(H),A=f(H,2);A.__click=u,z(()=>{me.disabled=i(r)===0,B(q,`Page ${i(r)+1} of ${i(l)??""}`),A.disabled=i(r)>=i(l)-1}),T(ae,he)};K(ee,ae=>{i(l)>1&&ae(re)})}T(N,W)};K(x,N=>{i(o).length===0?N(F):N(P,!1)})}z(()=>B(D,`${i(o).length??""} completed task${i(o).length!==1?"s":""} in the last ${t()??""} days`)),T(s,m),Ve()}at(["keydown","click"]);var oh=I('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">📁 No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),lh=I('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),ch=I('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),uh=I('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),dh=I('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function hh(s,e){Ge(e,!0);const t=Z(()=>()=>{const j=new Map;return e.tasks.filter(re=>re.status!=="done"&&re.status!=="cancelled").forEach(re=>{const ae=re.linkedBlockPath||"Uncategorized";j.has(ae)||j.set(ae,[]),j.get(ae).push(re)}),j.forEach(re=>{re.sort((ae,he)=>!ae.dueAt&&!he.dueAt?0:ae.dueAt?he.dueAt?new Date(ae.dueAt).getTime()-new Date(he.dueAt).getTime():-1:1)}),new Map([...j.entries()].sort(([re],[ae])=>re.localeCompare(ae)))}),r=Z(()=>[...i(t).values()].reduce((j,ee)=>j+ee.length,0));let n=V(be(new Set([...i(t).keys()])));function a(j){const ee=new Set(i(n));ee.has(j)?ee.delete(j):ee.add(j),_(n,ee,!0)}function o(){_(n,new Set([...i(t).keys()]),!0)}function l(){_(n,new Set,!0)}let c=V(0),u=be([]);const h=Z(()=>()=>{const j=[];return i(t).forEach((ee,re)=>{i(n).has(re)&&j.push(...ee)}),j});vt(()=>{i(c)>=i(h).length&&_(c,Math.max(0,i(h).length-1),!0)});function y(j,ee){j.key==="ArrowDown"?(j.preventDefault(),_(c,Math.min(i(c)+1,i(h).length-1),!0)):j.key==="ArrowUp"?(j.preventDefault(),_(c,Math.max(i(c)-1,0),!0)):j.key==="Enter"&&e.onEdit?(j.preventDefault(),e.onEdit(i(h)[ee])):j.key===" "&&e.onDone&&(j.preventDefault(),e.onDone(i(h)[ee]))}function v(j){const ee=j.split("/");return ee[ee.length-1]||j}var p=dh(),w=d(p),m=d(w),g=f(d(m),2),b=d(g),D=f(m,2),S=d(D);S.__click=o;var x=f(S,2);x.__click=l;var F=f(w,2),P=d(F);{var N=j=>{var ee=oh();T(j,ee)},W=j=>{var ee=He(),re=Pe(ee);Ue(re,17,()=>[...i(t).entries()],yt,(ae,he)=>{var me=Z(()=>To(i(he),2));let H=()=>i(me)[0],q=()=>i(me)[1];var A=uh(),Y=d(A);Y.__click=()=>a(H());var se=d(Y),J=d(se),ye=f(se,2),ve=d(ye),fe=f(ye,2),te=d(fe),oe=f(Y,2);{var Ee=R=>{var Q=ch();Ue(Q,23,q,k=>k.id,(k,L)=>{const X=Z(()=>i(h).indexOf(i(L)));var ie=lh();ie.__keydown=O=>y(O,i(X));var C=d(ie);$r(C,{get task(){return i(L)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ls(ie,(O,le)=>u[le]=O,O=>u==null?void 0:u[O],()=>[i(X)]),z(()=>Se(ie,"tabindex",i(X)===i(c)?0:-1)),pt("focus",ie,()=>_(c,i(X),!0)),T(k,ie)}),z(k=>Se(Q,"aria-label",k),[()=>`Tasks for ${v(H())}`]),T(R,Q)};K(oe,R=>{i(n).has(H())&&R(Ee)})}z((R,Q)=>{B(J,R),Se(ye,"title",H()),B(ve,Q),B(te,q().length)},[()=>i(n).has(H())?"▼":"▶",()=>v(H())]),T(ae,A)}),T(j,ee)};K(P,j=>{i(t).size===0?j(N):j(W,!1)})}z(()=>B(b,`${i(r)??""} task${i(r)!==1?"s":""} in ${i(t).size??""} project${i(t).size!==1?"s":""}`)),T(s,p),Ve()}at(["click","keydown"]);class Wt extends Error{constructor(e,t,r,n){super(e),this.line=t,this.column=r,this.suggestion=n,this.name="QuerySyntaxError"}}class Ar extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var Je=(s=>(s.TODO="TODO",s.IN_PROGRESS="IN_PROGRESS",s.DONE="DONE",s.CANCELLED="CANCELLED",s.NON_TASK="NON_TASK",s.EMPTY="EMPTY",s))(Je||{});const ds=class ds{constructor(e){E(this,"symbol");E(this,"name");E(this,"nextStatusSymbol");E(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};E(ds,"TODO",new ds({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),E(ds,"DONE",new ds({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),E(ds,"IN_PROGRESS",new ds({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),E(ds,"CANCELLED",new ds({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let Ts=ds;class fh{static parse(e,t=new Date){const r=e.trim().toLowerCase(),n=e;if(!r)return{date:null,isValid:!1,error:"Empty date string",original:n};if(r.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const p=new Date(r);if(!isNaN(p.getTime()))return{date:p,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),r==="today")return{date:o,isValid:!0,original:n};if(r==="tomorrow"){const p=new Date(o);return p.setDate(p.getDate()+1),{date:p,isValid:!0,original:n}}if(r==="yesterday"){const p=new Date(o);return p.setDate(p.getDate()-1),{date:p,isValid:!0,original:n}}const l=r.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(l){const p=parseInt(l[1]),w=l[2],m=new Date(o);return w.startsWith("day")?m.setDate(m.getDate()+p):w.startsWith("week")?m.setDate(m.getDate()+p*7):w.startsWith("month")&&m.setMonth(m.getMonth()+p),{date:m,isValid:!0,original:n}}const c=r.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(c){const p=parseInt(c[1]),w=c[2],m=new Date(o);return w.startsWith("day")?m.setDate(m.getDate()-p):w.startsWith("week")?m.setDate(m.getDate()-p*7):w.startsWith("month")&&m.setMonth(m.getMonth()-p),{date:m,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=r.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const p=h[1],w=u.indexOf(h[2]),m=o.getDay();let g=w-m;p==="next"?g<=0&&(g+=7):g>=0&&(g-=7);const b=new Date(o);return b.setDate(b.getDate()+g),{date:b,isValid:!0,original:n}}const y=r.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(y){const p=u.indexOf(y[1]),w=o.getDay();let m=p-w;m<0&&(m+=7);const g=new Date(o);return g.setDate(g.getDate()+m),{date:g,isValid:!0,original:n}}const v=r.match(/^(this|next|last)\s+(week|month)$/);if(v){const p=v[1],w=v[2],m=new Date(o);if(w==="week"){const g=m.getDay(),b=g===0?-6:1-g;m.setDate(m.getDate()+b),p==="next"?m.setDate(m.getDate()+7):p==="last"&&m.setDate(m.getDate()-7)}else w==="month"&&(m.setDate(1),p==="next"?m.setMonth(m.getMonth()+1):p==="last"&&m.setMonth(m.getMonth()-1));return{date:m,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class On{constructor(){E(this,"input","");E(this,"position",0);E(this,"line",1);E(this,"column",1);E(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const r={filters:[]},n=this.input.split(`
`).map(a=>a.trim()).filter(a=>a.length>0);for(let a=0;a<n.length;a++){this.line=a+1,this.column=1;const o=n[a];if(o.startsWith("sort by "))r.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))r.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))r.limit=this.parseLimitInstruction(o);else if(/^explain$/i.test(o))r.explain=!0;else{const l=this.parseFilterInstruction(o);l&&r.filters.push(l)}}return r}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Wt?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(/\s+(and|AND)\s+/i.test(e))return this.parseAndFilter(e);if(/\s+(or|OR)\s+/i.test(e))return this.parseOrFilter(e);if(/^(not|NOT)\s+/i.test(e))return this.parseNotFilter(e);if(e.startsWith("status.type is ")){const r=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(r)}}if(e.startsWith("status.name includes ")){const r=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(r)}}if(e.startsWith("status.symbol is ")){const r=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(r)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("urgency is ")){const r=e.substring(11).trim();return{type:"urgency",operator:"is",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("urgency above ")){const r=e.substring(14).trim();return{type:"urgency",operator:"above",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("urgency below ")){const r=e.substring(14).trim();return{type:"urgency",operator:"below",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("tag includes ")){const r=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(r)}}if(e.startsWith("tag does not include ")){const r=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(r),negate:!0}}if(e.startsWith("tags include ")){const r=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(r)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const r=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(r)}}if(e.startsWith("path does not include ")){const r=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(r),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};if(e.startsWith("description includes ")){const r=e.substring(21).trim();return{type:"description",operator:"includes",value:this.unquote(r)}}if(e.startsWith("description does not include ")){const r=e.substring(29).trim();return{type:"description",operator:"does not include",value:this.unquote(r)}}if(e.startsWith("description regex ")){const r=e.substring(18).trim();return{type:"description",operator:"regex",value:this.unquote(r)}}throw new Wt(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const r of t){if(e===`has ${r} date`)return{type:"date",operator:"has",value:{field:r}};if(e===`no ${r} date`)return{type:"date",operator:"has",value:{field:r},negate:!0};const n=["before","after","on","on or before","on or after"];for(const a of n){const o=`${r} ${a} `;if(e.startsWith(o)){const l=e.substring(o.length).trim(),c=fh.parse(l,this.referenceDate);if(!c.isValid||!c.date)throw new Wt(`Invalid date value: "${l}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:a,value:{field:r,date:c.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Wt(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Wt(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Wt(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return Je.TODO;case"IN_PROGRESS":return Je.IN_PROGRESS;case"DONE":return Je.DONE;case"CANCELLED":return Je.CANCELLED;case"NON_TASK":return Je.NON_TASK;default:throw new Wt(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}parseNumericValue(e,t){const r=Number(e);if(Number.isNaN(r))throw new Wt(`Invalid ${t} value: "${e}"`,this.line,this.column,`Use a numeric ${t} value (e.g., "${t} above 75")`);return r}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}parseAndFilter(e){const r=e.split(/\s+(and|AND)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(r.length===0)throw new Wt("Empty AND expression",this.line,this.column,"AND must have filters on both sides");if(r.length===1)return r[0];let n=r[0];for(let a=1;a<r.length;a++)n={type:"boolean",operator:"AND",value:null,left:n,right:r[a]};return n}parseOrFilter(e){const r=e.split(/\s+(or|OR)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(r.length===0)throw new Wt("Empty OR expression",this.line,this.column,"OR must have filters on both sides");if(r.length===1)return r[0];let n=r[0];for(let a=1;a<r.length;a++)n={type:"boolean",operator:"OR",value:null,left:n,right:r[a]};return n}parseNotFilter(e){const t=e.replace(/^NOT\s+/i,"").trim();if(!t)throw new Wt("Empty NOT expression",this.line,this.column,"NOT must have a filter after it");const r=this.parseFilterInstruction(t);if(!r)throw new Wt("Invalid filter after NOT",this.line,this.column,"NOT must be followed by a valid filter");return{type:"boolean",operator:"NOT",value:null,inner:r}}}class it{}const rr=class rr{constructor(){E(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return rr.instance||(rr.instance=new rr),rr.instance}addDefaultStatuses(){this.add(Ts.TODO),this.add(Ts.IN_PROGRESS),this.add(Ts.DONE),this.add(Ts.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new Ts({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:Ts.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};E(rr,"instance",null);let gs=rr;class vh extends it{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=gs.getInstance(),r=e.statusSymbol||" ",a=t.get(r).type===this.statusType;return this.negate?!a:a}}class ph extends it{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=gs.getInstance(),r=e.statusSymbol||" ",a=t.get(r).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!a:a}}class yh extends it{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const r=(e.statusSymbol||" ")===this.symbol;return this.negate?!r:r}}class mh extends it{matches(e){const t=gs.getInstance(),r=e.statusSymbol||" ";return t.get(r).type===Je.DONE}}class gh extends it{matches(e){const t=gs.getInstance(),r=e.statusSymbol||" ";return t.get(r).type!==Je.DONE}}class _h extends it{constructor(e,t,r){super(),this.field=e,this.comparator=t,this.targetDate=r}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const r=new Date(this.targetDate);r.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<r;case"after":return n>r;case"on":return n.getTime()===r.getTime();case"on or before":return n<=r;case"on or after":return n>=r;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class bh extends it{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const $i={lowest:0,low:1,normal:2,medium:3,high:4,highest:5};function kh(s){return Wr(s)??"normal"}function wh(s){return s==="urgent"?"highest":s==="none"?"normal":s}class Th extends it{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=kh(e.priority),r=$i[t],n=$i[wh(this.level)];switch(this.operator){case"is":return r===n;case"above":return r>n;case"below":return r<n;default:return!1}}}class Sh extends it{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],r=this.tag.toLowerCase(),n=t.some(a=>a.toLowerCase().includes(r));return this.negate?!n:n}}class Dh extends it{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class Eh extends it{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const r=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!r:r}}class xh extends it{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const r=e.blockedBy&&e.blockedBy.length>0;return this.negate?!r:!!r}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Ah extends it{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Ch extends it{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class Ih extends it{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Oh extends it{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class Mh extends it{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class Nh extends it{constructor(e,t,r=!1){super(),this.operator=e,this.pattern=t,this.caseSensitive=r}matches(e){const t=e.name||"",r=e.description||"",n=`${t} ${r}`.trim();switch(this.operator){case"includes":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"does not include":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return!(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"regex":try{const a=this.caseSensitive?"":"i";return new RegExp(this.pattern,a).test(n)}catch{return!1}}}}class Rh extends it{constructor(e,t,r,n){super(),this.comparator=e,this.threshold=t,this.referenceDate=r,this.settings=n}matches(e){const t=ii(e,{now:this.referenceDate,settings:this.settings});switch(this.comparator){case"above":return t>this.threshold;case"below":return t<this.threshold;case"is":return t===this.threshold;default:return!1}}}class er{group(e){const t=new Map;for(const r of e){const n=this.getGroupKey(r);this.addToGroup(t,n,r)}return t}addToGroup(e,t,r){e.has(t)||e.set(t,[]),e.get(t).push(r)}}class qh extends er{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const r=new Date(e.dueAt);r.setHours(0,0,0,0);const n=r.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Overdue":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Lh extends er{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const r=new Date(e.scheduledAt);r.setHours(0,0,0,0);const n=r.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Past":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Fh extends er{getGroupKey(e){const t=gs.getInstance(),r=e.statusSymbol||" ";return t.get(r).type}}class Ph extends er{getGroupKey(e){const t=gs.getInstance(),r=e.statusSymbol||" ";return t.get(r).name}}class Uh extends er{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class Bh extends er{getGroupKey(e){return e.path||""||"No path"}}class Yh extends er{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const r=t.lastIndexOf("/");return r===-1?"Root":t.substring(0,r)||"Root"}}class jh extends er{group(e){const t=new Map;for(const r of e){const n=r.tags||[];if(n.length===0)this.addToGroup(t,"No tags",r);else for(const a of n)this.addToGroup(t,a,r)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}class zh{constructor(e,t={}){E(this,"dependencyGraph",null);E(this,"globalFilterAST",null);E(this,"urgencySettings");this.taskIndex=e,this.urgencySettings=t.urgencySettings??ai}setDependencyGraph(e){this.dependencyGraph=e}setGlobalFilter(e){if(!e){this.globalFilterAST=null;return}try{const t=new On;this.globalFilterAST=t.parse(e)}catch(t){console.error("Failed to parse global filter:",t),this.globalFilterAST=null}}execute(e){const t=performance.now(),r=new Date;try{const n=e.explain?this.generateExplanation(e):void 0;let a=this.taskIndex.getAllTasks();const o=a.length;this.globalFilterAST&&this.globalFilterAST.filters.length>0&&(a=this.applyFilters(a,this.globalFilterAST.filters,r)),e.filters.length>0&&(a=this.applyFilters(a,e.filters,r)),e.sort&&(a=this.applySort(a,e.sort,r)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let l;e.group&&(l=this.applyGrouping(a,e.group));const u=performance.now()-t;return{tasks:a,groups:l,totalCount:o,executionTimeMs:u,explanation:n}}catch(n){throw new Ar(`Failed to execute query: ${n instanceof Error?n.message:String(n)}`,n instanceof Error?n:void 0)}}executeString(e){const r=new On().parse(e);return this.execute(r)}validateQuery(e){try{return{valid:!0,parsedFilters:new On().parse(e).filters.map(n=>`${n.type}:${n.operator}`)}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}applyFilters(e,t,r){let n=e;for(const a of t){const o=this.createFilter(a,r);n=n.filter(l=>o.matches(l))}return n}createFilter(e,t){switch(e.type){case"done":return e.value?new mh:new gh;case"status":if(e.operator==="type-is")return new vh(e.value,e.negate);if(e.operator==="name-includes")return new ph(e.value,e.negate);if(e.operator==="symbol-is")return new yh(e.value,e.negate);throw new Ar(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new bh(e.value.field,e.negate):new _h(e.value.field,e.operator,e.value.date);case"priority":return new Th(e.operator,e.value);case"urgency":return new Rh(e.operator,e.value,t,this.urgencySettings);case"tag":return e.operator==="has"?new Dh(!e.value):new Sh(e.value,e.negate);case"path":return new Eh(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new xh(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Ah(this.dependencyGraph,!e.value);throw new Ar(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Ch(!e.value);case"description":return new Nh(e.operator,e.value,e.negate);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new Ih(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="OR"&&e.left&&e.right)return new Oh(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="NOT"&&e.inner)return new Mh(this.createFilter(e.inner,t));throw new Ar(`Invalid boolean operator: ${e.operator}`);default:throw new Ar(`Unknown filter type: ${e.type}`)}}applySort(e,t,r){const n=[...e];return n.sort((a,o)=>{let l=0;switch(t.field){case"due":l=this.compareDates(a.dueAt,o.dueAt);break;case"scheduled":l=this.compareDates(a.scheduledAt,o.scheduledAt);break;case"start":l=this.compareDates(a.startAt,o.startAt);break;case"created":l=this.compareDates(a.createdAt,o.createdAt);break;case"done":l=this.compareDates(a.doneAt,o.doneAt);break;case"priority":l=this.comparePriorities(a.priority,o.priority);break;case"urgency":l=this.getUrgencyScore(o,r)-this.getUrgencyScore(a,r);break;case"status.type":l=this.compareStatusTypes(a,o);break;case"description":l=(a.description||"").localeCompare(o.description||"");break;case"path":l=(a.path||"").localeCompare(o.path||"");break;default:l=a.name.localeCompare(o.name)}return t.reverse?-l:l}),n}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const r={lowest:0,low:1,normal:2,medium:3,high:4,highest:5},n=r[Wr(e)||"normal"]||2,a=r[Wr(t)||"normal"]||2;return n-a}compareStatusTypes(e,t){const r=n=>{const a=n.statusSymbol||" ";return a===" "?0:a==="/"?1:a==="x"?2:a==="-"?3:0};return r(e)-r(t)}getUrgencyScore(e,t){return ii(e,{now:t,settings:this.urgencySettings})}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new qh;case"scheduled":return new Lh;case"status.type":return new Fh;case"status.name":return new Ph;case"priority":return new Uh;case"path":return new Bh;case"folder":return new Yh;case"tags":return new jh;default:throw new Ar(`Unknown grouping field: ${e}`)}}generateExplanation(e){const t=[];if(e.filters.length>0){t.push("**Filters:**");for(const r of e.filters)t.push(`- ${this.explainFilter(r)}`)}else t.push("**Filters:** None (showing all tasks)");if(e.sort){const r=e.sort.reverse?"descending":"ascending";t.push(`
**Sort:** By ${e.sort.field} (${r})`)}return e.group&&t.push(`
**Group:** By ${e.group.field}`),e.limit!==void 0&&e.limit>0&&t.push(`
**Limit:** First ${e.limit} tasks`),t.join(`
`)}explainFilter(e){const t=e.negate?"NOT ":"";switch(e.type){case"status":return`${t}Status ${e.operator} "${e.value}"`;case"date":return`${t}${e.value.field} ${e.value.comparator} ${e.value.date}`;case"priority":return`${t}Priority ${e.operator} ${e.value}`;case"urgency":return`${t}Urgency ${e.operator} ${e.value}`;case"tag":return e.operator==="includes"?`${t}Tag includes "${e.value}"`:e.operator==="has"?`${t}Has tags`:`${t}Tag ${e.operator} "${e.value}"`;case"path":return`${t}Path ${e.operator} "${e.value}"`;case"dependency":return e.value==="blocked"?`${t}Is blocked by dependencies`:e.value==="blocking"?`${t}Is blocking other tasks`:`${t}Dependency ${e.operator}`;case"recurrence":return`${t}Is recurring`;case"boolean":if(e.left&&e.right){const r=this.explainFilter(e.left),n=this.explainFilter(e.right);return`(${r}) ${e.operator.toUpperCase()} (${n})`}return e.inner?`NOT (${this.explainFilter(e.inner)})`:`${t}Boolean ${e.operator}`;case"done":return e.value?`${t}Task is done`:`${t}Task is not done`;case"description":return`${t}Description ${e.operator} "${e.value}"`;default:return`${t}${e.type} ${e.operator} ${JSON.stringify(e.value)}`}}}var Hh=I('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Kh=I('<div class="search-tab__error svelte-1yjlv38"> </div>'),Wh=I('<div class="search-tab__stats svelte-1yjlv38"> </div>'),Gh=I('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),Vh=I('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),Qh=I('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),$h=I('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">🔍 No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),Xh=I('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),Zh=I(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function Jh(s,e){Ge(e,!0);let t=V(""),r=V(be([])),n=V(""),a=V(0),o=V(be([])),l=V(!1),c=V(!1);const u=["not done","priority is high","due before tomorrow","not done AND priority above medium","is blocked","description includes meeting","tag includes #work","is recurring","priority is high OR priority is medium","NOT is blocked","not done AND priority is high AND description includes priority","sort by priority","sort by urgency","urgency above 80","group by priority"],h={getAllTasks:()=>e.tasks},y=Io(li),v=new zh(h,{urgencySettings:y});function p(){if(!i(t).trim()){_(r,[],!0),_(n,"");return}_(c,!0),_(n,"");try{const Q=new On().parse(i(t)),k=v.execute(Q);if(_(r,k.tasks,!0),_(a,k.executionTimeMs,!0),!i(o).includes(i(t))){_(o,[i(t),...i(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(i(o)))}catch{}}}catch(R){_(n,R instanceof Error?R.message:String(R),!0),_(r,[],!0),G.error(`Query error: ${i(n)}`)}finally{_(c,!1)}}function w(){try{const R=localStorage.getItem("query-history");R&&_(o,JSON.parse(R),!0)}catch{}}function m(R){_(t,R,!0),p()}function g(R){_(t,R,!0),_(l,!1),p()}function b(){_(o,[],!0);try{localStorage.removeItem("query-history")}catch{}_(l,!1)}function D(R){R.key==="Enter"&&!R.shiftKey&&(R.preventDefault(),p())}vt(()=>{w()});let S=V(0),x=be([]);vt(()=>{i(S)>=i(r).length&&_(S,Math.max(0,i(r).length-1),!0)});function F(R,Q){R.key==="ArrowDown"?(R.preventDefault(),_(S,Math.min(i(S)+1,i(r).length-1),!0)):R.key==="ArrowUp"?(R.preventDefault(),_(S,Math.max(i(S)-1,0),!0)):R.key==="Enter"&&e.onEdit?(R.preventDefault(),e.onEdit(i(r)[Q])):R.key===" "&&e.onDone&&(R.preventDefault(),e.onDone(i(r)[Q]))}var P=Zh(),N=f(d(P),2),W=d(N),j=d(W);j.__keydown=D;var ee=f(j,2),re=d(ee);re.__click=p;var ae=d(re),he=f(re,2);{var me=R=>{var Q=Hh();Q.__click=()=>_(l,!i(l));var k=d(Q);z(()=>B(k,`History (${i(o).length??""})`)),T(R,Q)};K(he,R=>{i(o).length>0&&R(me)})}var H=f(W,2);{var q=R=>{var Q=Kh(),k=d(Q);z(()=>B(k,`⚠️ ${i(n)??""}`)),T(R,Q)};K(H,R=>{i(n)&&R(q)})}var A=f(H,2);{var Y=R=>{var Q=Wh(),k=d(Q);z(L=>B(k,`Found ${i(r).length??""} task${i(r).length!==1?"s":""} in ${L??""}ms`),[()=>i(a).toFixed(2)]),T(R,Q)};K(A,R=>{i(a)>0&&!i(n)&&R(Y)})}var se=f(N,2);{var J=R=>{var Q=Vh(),k=d(Q),L=f(d(k),2);L.__click=b;var X=f(k,2);Ue(X,21,()=>i(o),yt,(ie,C)=>{var O=Gh(),le=d(O);le.__click=()=>g(i(C));var ke=d(le);z(()=>B(ke,i(C))),T(ie,O)}),T(R,Q)};K(se,R=>{i(l)&&i(o).length>0&&R(J)})}var ye=f(se,2),ve=f(d(ye),2);Ue(ve,21,()=>u,yt,(R,Q)=>{var k=Qh();k.__click=()=>m(i(Q));var L=d(k),X=d(L);z(()=>B(X,i(Q))),T(R,k)});var fe=f(ye,2),te=d(fe);{var oe=R=>{var Q=$h();T(R,Q)},Ee=R=>{var Q=He(),k=Pe(Q);{var L=X=>{var ie=He(),C=Pe(ie);Ue(C,19,()=>i(r),O=>O.id,(O,le,ke)=>{var Ae=Xh();Ae.__keydown=Oe=>F(Oe,i(ke));var Ie=d(Ae);$r(Ie,{get task(){return i(le)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),ls(Ae,(Oe,Be)=>x[Be]=Oe,Oe=>x==null?void 0:x[Oe],()=>[i(ke)]),z(()=>Se(Ae,"tabindex",i(ke)===i(S)?0:-1)),pt("focus",Ae,()=>_(S,i(ke),!0)),T(O,Ae)}),T(X,ie)};K(k,X=>{i(r).length>0&&X(L)},!0)}T(R,Q)};K(te,R=>{i(r).length===0&&i(t).trim()&&!i(n)?R(oe):R(Ee,!1)})}z(()=>{re.disabled=i(c),B(ae,i(c)?"Searching...":"Search")}),lt(j,()=>i(t),R=>_(t,R)),T(s,P),Ve()}at(["keydown","click"]);class xa{static parse(e){const t=e,r=e.trim().toLowerCase().replace(/\s+/g," ");if(!r)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=r.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let a=n[1],o;const l=a.match(/^(.+?)\s+when\s+done$/),c=a.match(/^(.+?)\s+when\s+due$/);if(l?(a=l[1],o=!0):c&&(a=c[1],o=!1),a==="weekday"||a==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(a==="weekend"||a==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=this.parseOrdinalWeekdayPattern(a);if(u.matched)return u.error||u.ordinal===void 0||u.weekday===void 0?{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:u.error||"Invalid ordinal weekday pattern"}:{frequency:{type:"monthly",interval:1,dayOfMonth:1,whenDone:o,rruleString:this.buildOrdinalRRuleString(u.weekday,u.ordinal),naturalLanguage:t},raw:t,isValid:!0};const h=a.match(/^(\d+\s+)?days?$/);if(h)return{frequency:{type:"daily",interval:h[1]?parseInt(h[1]):1,whenDone:o},raw:t,isValid:!0};const y=a.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(y){const w=y[1]?parseInt(y[1]):1,m=y[2];if(!m)return{frequency:{type:"weekly",interval:w,weekdays:[1],whenDone:o},raw:t,isValid:!0};const g=this.parseDayNames(m);return g.length===0?{frequency:{type:"weekly",interval:w,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:w,weekdays:g,whenDone:o},raw:t,isValid:!0}}const v=a.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(v){const w=v[1]?parseInt(v[1]):1,m=v[2]?parseInt(v[2]):1;return m<1||m>31?{frequency:{type:"monthly",interval:w,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:w,dayOfMonth:m,whenDone:o},raw:t,isValid:!0}}const p=a.match(/^(\d+\s+)?years?$/);return p?{frequency:{type:"yearly",interval:p[1]?parseInt(p[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=this.stringifyOrdinalWeekday(e.rruleString);if(t)return e.whenDone?`${t} when done`:t;const r=e.interval;let n;switch(e.type){case"daily":n=r===1?"every day":`every ${r} days`;break;case"weekly":{const a=r===1?"week":`${r} weeks`;if(e.weekdays.length===0)n=`every ${a}`;else{const o=e.weekdays.map(l=>this.getDayName(l)).join(", ");n=`every ${a} on ${o}`}break}case"monthly":{const a=r===1?"month":`${r} months`,o=this.getDaySuffix(e.dayOfMonth);n=`every ${a} on the ${e.dayOfMonth}${o}`;break}case"yearly":{n=`every ${r===1?"year":`${r} years`}`;break}default:n="every day"}return e.whenDone?`${n} when done`:n}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},r=e.split(",").map(a=>a.trim().toLowerCase()),n=[];for(const a of r)a in t&&n.push(t[a]);return n}static parseOrdinalWeekdayPattern(e){const t=e.split(" ");if(t.length<2)return{matched:!1};const r=this.parseOrdinalToken(t[0]);if(!r.matched)return{matched:!1};if(r.error)return{matched:!0,error:r.error};const n=this.parseSingleDay(t[1]);return n===null?{matched:!0,error:"Invalid weekday name"}:t.length===2?{matched:!0,ordinal:r.value,weekday:n}:t.length===5&&t[2]==="of"&&t[3]==="the"&&t[4]==="month"?{matched:!0,ordinal:r.value,weekday:n}:{matched:!0,error:"Ordinal weekday pattern must be 'every <ordinal> <weekday>' optionally followed by 'of the month'"}}static parseOrdinalToken(e){const t={first:1,second:2,third:3,fourth:4,last:-1};if(e in t)return{matched:!0,value:t[e]};const r=e.match(/^(\d+)(st|nd|rd|th)$/);if(!r)return{matched:!1};const n=parseInt(r[1],10);return n>=1&&n<=4?{matched:!0,value:n}:{matched:!0,error:"Ordinal weekday must be first, second, third, fourth, or last"}}static parseSingleDay(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6};return e in t?t[e]:null}static stringifyOrdinalWeekday(e){if(!e)return null;const t=this.parseRRuleString(e);if(!t||t.FREQ!=="MONTHLY"||!t.BYDAY||!t.BYSETPOS)return null;const r=this.fromRRuleWeekday(t.BYDAY);if(r===null)return null;const n=Number.parseInt(t.BYSETPOS,10);if(!Number.isFinite(n))return null;const a=this.ordinalWord(n);return a?`every ${a} ${this.getDayName(r)}`:null}static ordinalWord(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";case 4:return"fourth";case-1:return"last";default:return null}}static buildOrdinalRRuleString(e,t){return`RRULE:FREQ=MONTHLY;BYDAY=${this.toRRuleWeekday(e)};BYSETPOS=${t}`}static toRRuleWeekday(e){return["MO","TU","WE","TH","FR","SA","SU"][e]||"MO"}static fromRRuleWeekday(e){const r=["MO","TU","WE","TH","FR","SA","SU"].indexOf(e);return r>=0?r:null}static parseRRuleString(e){const t=e.trim().toUpperCase(),r=t.startsWith("RRULE:")?t.slice(6):t;if(!r)return null;const n=r.split(";"),a={};for(const o of n){if(!o)continue;const[l,c]=o.split("=");if(!l||!c)return null;a[l]=c}return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var ef=I('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),tf=I('<div class="priority-selector svelte-1w15n9q"></div>');function sf(s,e){Ge(e,!0);let t=Os(e,"value",15,"normal");const r=[{value:"highest",label:"Highest",emoji:"🔺",color:"var(--b3-theme-error, #ef4444)"},{value:"high",label:"High",emoji:"⏫",color:"#f97316"},{value:"medium",label:"Medium",emoji:"🔼",color:"#f59e0b"},{value:"normal",label:"Normal",emoji:"🟡",color:"#eab308"},{value:"low",label:"Low",emoji:"🔽",color:"#22c55e"},{value:"lowest",label:"Lowest",emoji:"⏬",color:"#64748b"}];function n(o){t(o),e.onchange(o)}var a=tf();Ue(a,21,()=>r,yt,(o,l)=>{var c=ef();let u;var h=d(c);h.__change=()=>n(i(l).value);var y=f(h,2),v=d(y),p=f(y,2),w=d(p);z(()=>{u=je(c,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===i(l).value}),mr(c,`--priority-color: ${i(l).color??""}`),si(h,i(l).value),qr(h,t()===i(l).value),B(v,i(l).emoji),B(w,i(l).label)}),T(o,c)}),T(s,a),Ve()}at(["change"]);var rf=I('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),nf=I('<div class="status-selector svelte-v9ezc0"></div>');function af(s,e){Ge(e,!0);let t=Os(e,"value",15,"todo");const r=[{value:"todo",label:"Todo",icon:"○",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"✓",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"✕",color:"#999"}];function n(o){t(o),e.onchange(o)}var a=nf();Ue(a,21,()=>r,yt,(o,l)=>{var c=rf();let u;var h=d(c);h.__change=()=>n(i(l).value);var y=f(h,2),v=d(y),p=f(y,2),w=d(p);z(()=>{u=je(c,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===i(l).value}),mr(c,`--status-color: ${i(l).color??""}`),si(h,i(l).value),qr(h,t()===i(l).value),B(v,i(l).icon),B(w,i(l).label)}),T(o,c)}),T(s,a),Ve()}at(["change"]);var of=I('<div class="recurrence-input__valid svelte-787fjp">✓ Valid recurrence pattern</div>'),lf=I('<div class="recurrence-input__error svelte-787fjp"> </div>'),cf=I('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),uf=I('<li class="svelte-787fjp"> </li>'),df=I('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),hf=I('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function ff(s,e){Ge(e,!0);let t=Os(e,"value",15,""),r=Os(e,"showPreview",3,!0);const n=Z(()=>xa.parse(t())),a=Z(()=>i(n).isValid),o=Z(()=>i(n).error);function l(b,D=3){const S=[],x=new Date;for(let F=0;F<D;F++){const P=new Date(x);switch(b.type){case"daily":P.setDate(x.getDate()+F*b.interval);break;case"weekly":P.setDate(x.getDate()+F*b.interval*7);break;case"monthly":P.setMonth(x.getMonth()+F*b.interval);break;case"yearly":P.setFullYear(x.getFullYear()+F*b.interval);break}S.push(P.toLocaleDateString())}return S}const c=Z(()=>i(a)&&r()?l(i(n).frequency):[]);function u(b){const S=b.target.value;t(S);const x=xa.parse(S);e.onchange(S,x.isValid?x.frequency:null,x.isValid)}var h=hf(),y=d(h);let v;y.__input=u;var p=f(y,2);{var w=b=>{var D=cf(),S=d(D);{var x=P=>{var N=of();T(P,N)},F=P=>{var N=lf(),W=d(N);z(()=>B(W,`⚠ ${(i(o)||"Invalid recurrence pattern")??""}`)),T(P,N)};K(S,P=>{i(a)?P(x):P(F,!1)})}T(b,D)};K(p,b=>{t().length>0&&b(w)})}var m=f(p,2);{var g=b=>{var D=df(),S=f(d(D),2);Ue(S,21,()=>i(c),yt,(x,F)=>{var P=uf(),N=d(P);z(()=>B(N,i(F))),T(x,P)}),T(b,D)};K(m,b=>{i(a)&&r()&&i(c).length>0&&b(g)})}z(()=>{v=je(y,1,"recurrence-input__field svelte-787fjp",null,v,{valid:i(a),invalid:!i(a)&&t().length>0}),Se(y,"aria-invalid",!i(a)&&t().length>0)}),lt(y,t),T(s,h),Ve()}at(["input"]);var vf=I('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">✕</button></div>'),pf=I('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),yf=I('<span class="dependency-picker__option-check svelte-10ls0lk">✓</span>'),mf=I('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),gf=I('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),_f=I('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function Xi(s,e){Ge(e,!0);let t=Os(e,"selected",31,()=>be([])),r=Os(e,"label",3,"Select tasks"),n=V(""),a=V(!1);const o=Z(()=>e.repository.getAllTasks().filter(P=>P.id!==e.excludeId)),l=Z(()=>i(n).trim()?i(o).filter(P=>P.name.toLowerCase().includes(i(n).toLowerCase())):i(o)),c=Z(()=>i(o).filter(P=>t().includes(P.id)));function u(P){if(!t().includes(P)){const N=[...t(),P];t(N),e.onchange(N)}_(n,""),_(a,!1)}function h(P){const N=t().filter(W=>W!==P);t(N),e.onchange(N)}function y(){_(a,!0)}function v(){setTimeout(()=>{_(a,!1)},200)}var p=_f(),w=d(p),m=d(w),g=f(w,2);{var b=P=>{var N=pf();Ue(N,21,()=>i(c),W=>W.id,(W,j)=>{var ee=vf(),re=d(ee),ae=d(re),he=f(re,2);he.__click=()=>h(i(j).id),z(()=>{B(ae,i(j).name),Se(he,"aria-label",`Remove ${i(j).name??""}`)}),T(W,ee)}),T(P,N)};K(g,P=>{i(c).length>0&&P(b)})}var D=f(g,2),S=d(D),x=f(S,2);{var F=P=>{var N=gf();Ue(N,21,()=>i(l).slice(0,10),W=>W.id,(W,j)=>{var ee=mf();let re;ee.__click=()=>u(i(j).id);var ae=d(ee),he=d(ae),me=f(ae,2);{var H=q=>{var A=yf();T(q,A)};K(me,q=>{t().includes(i(j).id)&&q(H)})}z((q,A)=>{re=je(ee,1,"dependency-picker__option svelte-10ls0lk",null,re,q),ee.disabled=A,B(he,i(j).name)},[()=>({selected:t().includes(i(j).id)}),()=>t().includes(i(j).id)]),T(W,ee)}),T(P,N)};K(x,P=>{i(a)&&i(l).length>0&&P(F)})}z(()=>B(m,r())),pt("focus",S,y),pt("blur",S,v),lt(S,()=>i(n),P=>_(n,P)),T(s,p),Ve()}at(["click"]);var bf=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),kf=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),wf=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),Tf=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Sf=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Df=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Ef=I('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">✕</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">💡 Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">⌘/Ctrl+Enter</kbd> to save</div></div></div>');function El(s,e){var Le,We,st,rt,St,Ht,_t,ss,Ft,rs,Bs,Pt;Ge(e,!0);const t="every day",r="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",a=!e.task;let o=V(be(((Le=e.task)==null?void 0:Le.name)||"")),l=V(be(((We=e.task)==null?void 0:We.description)||"")),c=V(be(((st=e.task)==null?void 0:st.priority)||"normal")),u=V(be(((rt=e.task)==null?void 0:rt.status)||"todo")),h=V(be((St=e.task)!=null&&St.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),y=V(be((Ht=e.task)!=null&&Ht.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),v=V(be((_t=e.task)!=null&&_t.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),p=V(be(((ss=e.task)==null?void 0:ss.recurrenceText)||((Ft=e.task)!=null&&Ft.frequency?xa.stringify(e.task.frequency):t))),w=V(be(((rs=e.task)==null?void 0:rs.frequency)||null)),m=V(!0),g=V(be(((Bs=e.task)==null?void 0:Bs.blockedBy)||[])),b=V(be(((Pt=e.task)==null?void 0:Pt.dependsOn)||[])),D=V(be({name:!1,dueAt:!1,recurrence:!1})),S=V(!1),x=V(null);const F=Z(()=>i(D).name&&!i(o).trim()?"Task name is required":""),P=Z(()=>i(D).dueAt?i(h)?Number.isNaN(new Date(i(h)).getTime())?"Invalid due date":"":"Due date is required":""),N=Z(()=>i(D).recurrence&&!i(m)?"Invalid recurrence pattern":""),W=Z(()=>!!(i(F)||i(P)||i(N)));_n(()=>{requestAnimationFrame(()=>{var U;(U=i(x))==null||U.focus()})});function j(U,ue,Xe){_(p,U,!0),_(w,ue,!0),_(m,Xe,!0),i(D).recurrence=!0}function ee(U){_(c,U,!0)}function re(U){_(u,U,!0)}function ae(U){_(g,U,!0)}function he(U){_(b,U,!0)}async function me(){if(_(D,{name:!0,dueAt:!0,recurrence:!0},!0),i(W)){G.warning("Please fix validation errors");return}if(!i(w)){G.error("Invalid recurrence pattern");return}_(S,!0);try{let U;a?U=bl(i(o).trim(),i(w),new Date(i(h))):(U={...e.task},U.name=i(o).trim(),U.frequency=i(w),U.dueAt=new Date(i(h)).toISOString()),U.description=i(l).trim()||void 0,U.priority=i(c),U.status=i(u),U.recurrenceText=i(p),U.scheduledAt=i(y)?new Date(i(y)).toISOString():void 0,U.startAt=i(v)?new Date(i(v)).toISOString():void 0,U.blockedBy=i(g).length>0?i(g):void 0,U.dependsOn=i(b).length>0?i(b):void 0,U.updatedAt=new Date().toISOString(),i(u)==="done"&&!U.lastCompletedAt&&(U.lastCompletedAt=new Date().toISOString()),i(u)==="cancelled"&&!U.cancelledAt&&(U.cancelledAt=new Date().toISOString()),await e.repository.saveTask(U),e.onSave&&e.onSave(U),G.success(`Task "${U.name}" ${a?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(U){G.error(`Failed to save task: ${U}`)}finally{_(S,!1)}}function H(U){U.key==="Escape"&&e.onClose(),(U.metaKey||U.ctrlKey)&&U.key==="Enter"&&(U.preventDefault(),me())}function q(U){return U?new Date(U).toLocaleString():"—"}var A=Ef();A.__keydown=H;var Y=d(A),se=d(Y),J=d(se),ye=d(J),ve=f(J,2);ve.__click=function(...U){var ue;(ue=e.onClose)==null||ue.apply(this,U)};var fe=f(se,2),te=d(fe),oe=f(d(te),2);oe.__input=()=>i(D).name=!0,ls(oe,U=>_(x,U),()=>i(x));var Ee=f(oe,2);{var R=U=>{var ue=bf(),Xe=d(ue);z(()=>B(Xe,i(F))),T(U,ue)};K(Ee,U=>{i(F)&&U(R)})}var Q=f(te,2),k=f(d(Q),2),L=f(Q,2),X=f(d(L),2);sf(X,{get value(){return i(c)},onchange:ee});var ie=f(L,2),C=f(d(ie),2);af(C,{get value(){return i(u)},onchange:re});var O=f(ie,2),le=f(d(O),2);le.__input=()=>i(D).dueAt=!0;var ke=f(le,2);{var Ae=U=>{var ue=kf(),Xe=d(ue);z(()=>B(Xe,i(P))),T(U,ue)};K(ke,U=>{i(P)&&U(Ae)})}var Ie=f(O,2),Oe=f(d(Ie),2),Be=f(Ie,2),Ct=f(d(Be),2),Tt=f(Be,2),et=f(d(Tt),2);ff(et,{get value(){return i(p)},onchange:j,showPreview:!0});var Rt=f(et,2);{var gt=U=>{var ue=wf(),Xe=d(ue);z(()=>B(Xe,i(N))),T(U,ue)};K(Rt,U=>{i(N)&&U(gt)})}var Me=f(Tt,2),It=d(Me);{let U=Z(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});Xi(It,{get repository(){return e.repository},get selected(){return i(g)},get excludeId(){return i(U)},onchange:ae,label:r})}var ze=f(Me,2),$e=d(ze);{let U=Z(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});Xi($e,{get repository(){return e.repository},get selected(){return i(b)},get excludeId(){return i(U)},onchange:he,label:n})}var tt=f(ze,2),qt=d(tt),Lt=f(d(qt),2),ts=d(Lt),Fs=f(qt,2);{var Ps=U=>{var ue=Tf(),Xe=f(d(ue),2),ks=d(Xe);z(Kt=>B(ks,Kt),[()=>q(e.task.lastCompletedAt)]),T(U,ue)};K(Fs,U=>{var ue;(ue=e.task)!=null&&ue.lastCompletedAt&&U(Ps)})}var cs=f(Fs,2);{var bs=U=>{var ue=Sf(),Xe=f(d(ue),2),ks=d(Xe);z(Kt=>B(ks,Kt),[()=>q(e.task.cancelledAt)]),T(U,ue)};K(cs,U=>{var ue;(ue=e.task)!=null&&ue.cancelledAt&&U(bs)})}var Us=f(cs,2);{var ne=U=>{var ue=Df(),Xe=f(d(ue),2),ks=d(Xe);z(()=>B(ks,e.task.linkedBlockId)),T(U,ue)};K(Us,U=>{var ue;(ue=e.task)!=null&&ue.linkedBlockId&&U(ne)})}var _e=f(fe,2),qe=d(_e);qe.__click=function(...U){var ue;(ue=e.onClose)==null||ue.apply(this,U)};var ce=f(qe,2);ce.__click=me;var we=d(ce);z(U=>{B(ye,a?"Create Task":"Edit Task"),Se(oe,"aria-invalid",!!i(F)),Se(le,"aria-invalid",!!i(P)),B(ts,U),ce.disabled=i(S),B(we,i(S)?"Saving...":a?"Create Task":"Save Changes")},[()=>{var U;return q((U=e.task)==null?void 0:U.createdAt)}]),pt("blur",oe,()=>i(D).name=!0),lt(oe,()=>i(o),U=>_(o,U)),lt(k,()=>i(l),U=>_(l,U)),pt("blur",le,()=>i(D).dueAt=!0),lt(le,()=>i(h),U=>_(h,U)),lt(Oe,()=>i(y),U=>_(y,U)),lt(Ct,()=>i(v),U=>_(v,U)),T(s,A),Ve()}at(["keydown","click","input"]);class xf{constructor(e){E(this,"config");this.config=e}evaluate(e,t){if(!this.config.enabled||this.config.mode==="all")return!0;const r=this.config.rules.filter(o=>o.enabled);if(r.length===0)return!0;const a=r.map(o=>this.evaluateRule(o,e,t)).some(o=>o);return this.config.mode==="include"?a:!a}updateConfig(e){this.config=e}getConfig(){return this.config}evaluateRule(e,t,r){switch(e.type){case"tag":const n=this.extractTags(t),a=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${a}$`);return n.some(l=>o.test(l));case"regex":try{return new RegExp(e.pattern).test(t)}catch{return!1}case"path":return r?r.includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}extractTags(e){return e.match(/#[\w/-]+/g)||[]}}function Af(s){if(!s.pattern||s.pattern.trim().length===0)return{valid:!1,error:"Pattern cannot be empty"};switch(s.type){case"regex":try{return new RegExp(s.pattern),{valid:!0}}catch(e){return{valid:!1,error:`Invalid regex pattern: ${e instanceof Error?e.message:String(e)}`}}case"tag":return s.pattern.startsWith("#")?{valid:!0}:{valid:!1,error:"Tag pattern should start with #"};case"path":case"marker":return{valid:!0};default:return{valid:!1,error:`Unknown rule type: ${s.type}`}}}function Cf(s,e,t){return{id:typeof crypto<"u"&&crypto.randomUUID?`rule_${crypto.randomUUID()}`:`rule_${Date.now()}_${Math.random().toString(36).slice(2,11)}`,type:s,pattern:e,enabled:!0,description:t}}const Zi={enabled:!1,mode:"all",rules:[]},nr=class nr{constructor(){E(this,"engine");this.engine=new xf(Zi)}static getInstance(){return nr.instance||(nr.instance=new nr),nr.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(Zi)}};E(nr,"instance",null);let Aa=nr;var If=I('<p class="empty-state svelte-b8rwae">No filter rules configured</p>'),Of=I('<span class="rule-description svelte-b8rwae"> </span>'),Mf=I('<div class="rule-item svelte-b8rwae"><input type="checkbox" class="rule-checkbox svelte-b8rwae"/> <div class="rule-info svelte-b8rwae"><span class="rule-type svelte-b8rwae"> </span> <code class="rule-pattern svelte-b8rwae"> </code> <!></div> <button class="delete-btn svelte-b8rwae">Delete</button></div>'),Nf=I('<div class="rules-list svelte-b8rwae"></div>'),Rf=I('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Task Filter</h3> <p class="description svelte-b8rwae">Control which checkboxes are treated as tasks</p> <div class="form-field svelte-b8rwae"><label class="settings__toggle svelte-b8rwae"><input type="checkbox" class="svelte-b8rwae"/> <span>Enable Global Filter</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Filter Mode</label> <select class="settings__input svelte-b8rwae"><option>All checkboxes are tasks (default)</option><option>Only checkboxes matching rules</option><option>All except checkboxes matching rules</option></select> <p class="hint svelte-b8rwae"><!></p></div> <div class="rules-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Filter Rules</h4> <!></div> <div class="add-rule-section svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Add Rule</h4> <div class="add-rule-form svelte-b8rwae"><select class="settings__input svelte-b8rwae"><option>Tag (e.g., #task)</option><option>Regex pattern</option><option>Document path (e.g., daily/)</option><option>Text marker (e.g., TODO:)</option></select> <input type="text" placeholder="Pattern" class="settings__input svelte-b8rwae"/> <input type="text" placeholder="Description (optional)" class="settings__input svelte-b8rwae"/> <button class="add-btn svelte-b8rwae">Add Rule</button></div></div> <div class="examples svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Examples</h4> <ul class="svelte-b8rwae"><li class="svelte-b8rwae"><strong>Tag:</strong> <code class="svelte-b8rwae">#task</code> - Only checkboxes with #task tag</li> <li class="svelte-b8rwae"><strong>Tag wildcard:</strong> <code class="svelte-b8rwae">#work/*</code> - Any #work subtag</li> <li class="svelte-b8rwae"><strong>Path:</strong> <code class="svelte-b8rwae">projects/</code> - Only in projects folder</li> <li class="svelte-b8rwae"><strong>Regex:</strong> <code class="svelte-b8rwae">TODO:|TASK:</code> - Checkboxes with TODO: or TASK:</li> <li class="svelte-b8rwae"><strong>Marker:</strong> <code class="svelte-b8rwae">@action</code> - Checkboxes with @action marker</li></ul></div></div>');function qf(s,e){Ge(e,!0);let t=Aa.getInstance(),r=be(t.getConfig()),n=V("tag"),a=V(""),o=V("");function l(){if(!i(a).trim()){G.error("Pattern cannot be empty");return}const te=Cf(i(n),i(a).trim(),i(o).trim()),oe=Af(te);if(!oe.valid){G.error(oe.error||"Invalid rule");return}r.rules.push(te),h(),_(a,""),_(o,""),G.success("Filter rule added")}function c(te){r.rules=r.rules.filter(oe=>oe.id!==te),h(),G.success("Filter rule deleted")}function u(te){const oe=r.rules.find(Ee=>Ee.id===te);oe&&(oe.enabled=!oe.enabled,h())}function h(){t.updateConfig(r)}function y(){h()}function v(){h()}var p=Rf(),w=f(d(p),4),m=d(w),g=d(m);g.__change=v;var b=f(w,2),D=f(d(b),2);D.__change=y;var S=d(D);S.value=S.__value="all";var x=f(S);x.value=x.__value="include";var F=f(x);F.value=F.__value="exclude";var P=f(D,2),N=d(P);{var W=te=>{var oe=Rr("All checkboxes will be treated as tasks (no filtering)");T(te,oe)},j=te=>{var oe=He(),Ee=Pe(oe);{var R=k=>{var L=Rr("Only checkboxes matching at least one rule will be treated as tasks");T(k,L)},Q=k=>{var L=He(),X=Pe(L);{var ie=C=>{var O=Rr("Checkboxes matching any rule will be ignored");T(C,O)};K(X,C=>{r.mode==="exclude"&&C(ie)},!0)}T(k,L)};K(Ee,k=>{r.mode==="include"?k(R):k(Q,!1)},!0)}T(te,oe)};K(N,te=>{r.mode==="all"?te(W):te(j,!1)})}var ee=f(b,2),re=f(d(ee),2);{var ae=te=>{var oe=If();T(te,oe)},he=te=>{var oe=Nf();Ue(oe,21,()=>r.rules,yt,(Ee,R)=>{var Q=Mf(),k=d(Q);k.__change=()=>u(i(R).id);var L=f(k,2),X=d(L),ie=d(X),C=f(X,2),O=d(C),le=f(C,2);{var ke=Ie=>{var Oe=Of(),Be=d(Oe);z(()=>B(Be,i(R).description)),T(Ie,Oe)};K(le,Ie=>{i(R).description&&Ie(ke)})}var Ae=f(L,2);Ae.__click=()=>c(i(R).id),z(()=>{qr(k,i(R).enabled),B(ie,i(R).type),B(O,i(R).pattern)}),T(Ee,Q)}),T(te,oe)};K(re,te=>{r.rules.length===0?te(ae):te(he,!1)})}var me=f(ee,2),H=f(d(me),2),q=d(H),A=d(q);A.value=A.__value="tag";var Y=f(A);Y.value=Y.__value="regex";var se=f(Y);se.value=se.__value="path";var J=f(se);J.value=J.__value="marker";var ye=f(q,2),ve=f(ye,2),fe=f(ve,2);fe.__click=l,ml(g,()=>r.enabled,te=>r.enabled=te),wa(D,()=>r.mode,te=>r.mode=te),wa(q,()=>i(n),te=>_(n,te)),lt(ye,()=>i(a),te=>_(a,te)),lt(ve,()=>i(o),te=>_(o,te)),T(s,p),Ve()}at(["change","click"]);var Lf=I('<button class="delete-btn svelte-1qw3eru">Delete</button>'),Ff=I('<span class="default-badge svelte-1qw3eru">Default</span>'),Pf=I('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),Uf=I('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function Bf(s,e){Ge(e,!0);let t=gs.getInstance(),r=V(be([])),n=V(""),a=V(""),o=V(be(Je.TODO)),l=V("x");function c(){_(r,t.getAll(),!0)}function u(){if(!i(n).trim()||!i(a).trim()){G.error("Symbol and name are required");return}if(i(n).length!==1){G.error("Symbol must be a single character");return}const R={symbol:i(n),name:i(a),type:i(o),nextStatusSymbol:i(l)},Q=new Ts(R);t.register(Q),c(),v(),G.success(`Status "${i(a)}" added`)}function h(R){if([" ","x","/","-"].includes(R)){G.error("Cannot delete default status");return}t.unregister(R),c(),G.success("Status deleted")}function y(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),c(),G.success("Statuses reset to defaults"))}function v(){_(n,""),_(a,""),_(o,Je.TODO,!0),_(l,"x")}vt(()=>{c()});var p=Uf(),w=f(d(p),4),m=d(w),g=d(m),b=f(d(g));Ue(b,21,()=>i(r),yt,(R,Q)=>{var k=Pf(),L=d(k),X=d(L),ie=d(X),C=f(L),O=d(C),le=f(C),ke=d(le),Ae=d(ke),Ie=f(le),Oe=d(Ie),Be=d(Oe),Ct=f(Ie),Tt=d(Ct),et=d(Tt),Rt=f(Ct),gt=d(Rt);{var Me=ze=>{var $e=Lf();$e.__click=()=>h(i(Q).symbol),T(ze,$e)},It=ze=>{var $e=Ff();T(ze,$e)};K(gt,ze=>{[" ","x","/","-"].includes(i(Q).symbol)?ze(It,!1):ze(Me)})}z(()=>{B(ie,`[${i(Q).symbol??""}]`),B(O,i(Q).name),B(Ae,i(Q).type),B(Be,`[${i(Q).nextStatusSymbol??""}]`),B(et,`- [${i(Q).symbol??""}] Task example`)}),T(R,k)});var D=f(w,2),S=f(d(D),2),x=d(S),F=d(x),P=f(d(F),2),N=f(F,2),W=f(d(N),2),j=f(N,2),ee=f(d(j),2),re=d(ee),ae={},he=f(re),me={},H=f(he),q={},A=f(H),Y={},se=f(A),J={},ye=f(j,2),ve=f(d(ye),2),fe=f(ye,2),te=f(d(fe),2);te.__click=u;var oe=f(D,2),Ee=d(oe);Ee.__click=y,z(()=>{ae!==(ae=Je.TODO)&&(re.value=(re.__value=Je.TODO)??""),me!==(me=Je.IN_PROGRESS)&&(he.value=(he.__value=Je.IN_PROGRESS)??""),q!==(q=Je.DONE)&&(H.value=(H.__value=Je.DONE)??""),Y!==(Y=Je.CANCELLED)&&(A.value=(A.__value=Je.CANCELLED)??""),J!==(J=Je.NON_TASK)&&(se.value=(se.__value=Je.NON_TASK)??"")}),lt(P,()=>i(n),R=>_(n,R)),lt(W,()=>i(a),R=>_(a,R)),wa(ee,()=>i(o),R=>_(o,R)),lt(ve,()=>i(l),R=>_(l,R)),T(s,p),Ve()}at(["click"]);var Yf=I('<button class="settings__close-btn svelte-1ke3hir">✕</button>'),jf=I("<div> </div>"),zf=I('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),Hf=I('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Kf=I('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"><input class="settings__shortcut-input svelte-1ke3hir" type="text" placeholder="Unassigned"/> <div class="settings__shortcut-actions svelte-1ke3hir"><button class="settings__shortcut-btn svelte-1ke3hir" type="button">Save</button> <button class="settings__shortcut-btn settings__shortcut-btn--ghost svelte-1ke3hir" type="button">Reset</button></div> <div class="settings__shortcut-default svelte-1ke3hir"> </div></div></div>'),Wf=I(`<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div> <button class="settings__shortcut-reset-all svelte-1ke3hir" type="button">Reset all shortcuts</button> <p class="settings__shortcut-note svelte-1ke3hir">Tip: You can also customize these in SiYuan's native shortcut settings.</p></section>`),Gf=I('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),Vf=I('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filter</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function Qf(s,e){Ge(e,!0);let t=V(be(Ta)),r=V(null),n=be({}),a=V("general"),o=V(be([])),l=V(be({}));function c(){if(!e.shortcutManager){_(o,[],!0),_(l,{},!0);return}_(o,e.shortcutManager.getShortcutDisplay(),!0),_(l,i(o).reduce((H,q)=>(H[q.id]=q.currentHotkey||"",H),{}),!0)}function u(H,q){_(l,{...i(l),[H]:q},!0)}async function h(H){if(!e.shortcutManager)return;const q=await e.shortcutManager.updateShortcut(H,i(l)[H]??"");if(!q.success){G.error(q.message||"Failed to update shortcut.");return}G.success("Shortcut updated."),c()}async function y(H){e.shortcutManager&&(await e.shortcutManager.resetShortcut(H),G.success("Shortcut reset."),c())}async function v(){e.shortcutManager&&(await e.shortcutManager.resetAllShortcuts(),G.success("Shortcuts reset to defaults."),c())}vt(()=>{_(t,e.eventService.getConfig(),!0)}),vt(()=>{c()});async function p(){try{await e.eventService.saveConfig(i(t)),G.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(H){G.error("Failed to save settings: "+H)}}async function w(){_(r,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const H=await e.eventService.testConnection();n.n8n={success:H.success,message:H.success?"Test successful!":H.message||"Test failed. Check configuration."}}catch(H){n.n8n={success:!1,message:"Error: "+(H instanceof Error?H.message:String(H))}}finally{_(r,null)}}var m=Vf(),g=d(m),b=f(d(g),2);{var D=H=>{var q=Yf();q.__click=function(...A){var Y;(Y=e.onClose)==null||Y.apply(this,A)},T(H,q)};K(b,H=>{e.onClose&&H(D)})}var S=f(g,2),x=d(S),F=d(x);F.__click=()=>_(a,"general");var P=f(F,2);P.__click=()=>_(a,"filter");var N=f(P,2);N.__click=()=>_(a,"statuses");var W=f(N,2);W.__click=()=>_(a,"shortcuts");var j=f(x,2),ee=d(j);{var re=H=>{var q=zf(),A=d(q),Y=f(d(A),2),se=d(Y),J=f(A,2),ye=f(d(J),2),ve=f(J,2),fe=f(d(ve),2),te=f(ve,2);te.__click=w;var oe=d(te),Ee=f(te,2);{var R=Q=>{var k=jf(),L=d(k);z(()=>{je(k,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),B(L,n.n8n.message)}),T(Q,k)};K(Ee,Q=>{n.n8n&&Q(R)})}z(()=>{ye.disabled=!i(t).n8n.enabled,fe.disabled=!i(t).n8n.enabled,te.disabled=!i(t).n8n.enabled||i(r)==="n8n",B(oe,i(r)==="n8n"?"Testing...":"Test Connection")}),ml(se,()=>i(t).n8n.enabled,Q=>i(t).n8n.enabled=Q),lt(ye,()=>i(t).n8n.webhookUrl,Q=>i(t).n8n.webhookUrl=Q),lt(fe,()=>i(t).n8n.sharedSecret,Q=>i(t).n8n.sharedSecret=Q),T(H,q)},ae=H=>{var q=He(),A=Pe(q);{var Y=J=>{qf(J,{})},se=J=>{var ye=He(),ve=Pe(ye);{var fe=oe=>{Bf(oe,{})},te=oe=>{var Ee=He(),R=Pe(Ee);{var Q=k=>{var L=Wf(),X=f(d(L),2);Ue(X,21,()=>i(o),yt,(C,O)=>{var le=Kf(),ke=d(le),Ae=d(ke),Ie=d(Ae),Oe=f(Ae,2),Be=d(Oe),Ct=f(Oe,2);{var Tt=tt=>{var qt=Hf(),Lt=d(qt);z(()=>B(Lt,i(O).context)),T(tt,qt)};K(Ct,tt=>{i(O).context&&tt(Tt)})}var et=f(ke,2),Rt=d(et);Rt.__input=tt=>u(i(O).id,tt.currentTarget.value);var gt=f(Rt,2),Me=d(gt);Me.__click=()=>h(i(O).id);var It=f(Me,2);It.__click=()=>y(i(O).id);var ze=f(gt,2),$e=d(ze);z(()=>{B(Ie,i(O).label),B(Be,i(O).description),si(Rt,i(l)[i(O).id]??""),B($e,`Default: ${(i(O).defaultHotkey||"Unassigned")??""}`)}),T(C,le)});var ie=f(X,2);ie.__click=v,T(k,L)};K(R,k=>{i(a)==="shortcuts"&&k(Q)},!0)}T(oe,Ee)};K(ve,oe=>{i(a)==="statuses"?oe(fe):oe(te,!1)},!0)}T(J,ye)};K(A,J=>{i(a)==="filter"?J(Y):J(se,!1)},!0)}T(H,q)};K(ee,H=>{i(a)==="general"?H(re):H(ae,!1)})}var he=f(S,2);{var me=H=>{var q=Gf(),A=d(q);A.__click=p,T(H,q)};K(he,H=>{i(a)==="general"&&H(me)})}z(()=>{je(F,1,`settings__nav-btn ${i(a)==="general"?"active":""}`,"svelte-1ke3hir"),je(P,1,`settings__nav-btn ${i(a)==="filter"?"active":""}`,"svelte-1ke3hir"),je(N,1,`settings__nav-btn ${i(a)==="statuses"?"active":""}`,"svelte-1ke3hir"),je(W,1,`settings__nav-btn ${i(a)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),T(s,m),Ve()}at(["click","input"]);var $f=I('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Xf=I('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Zf=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Jf=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),ev=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),tv=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),sv=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),rv=I('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>Blocking</button> <button>High Priority</button></div>'),nv=I('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">📥 Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">📋 Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">📅 Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">✅ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">📁 Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">🔍 Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">📝 All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),av=I('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">⚙️ Settings</button></div></div> <!></div>');function iv(s,e){Ge(e,!0),Ac(li,e.settingsService.get().urgency);const t=e.scheduler.getTimezoneHandler(),r=e.scheduler.getRecurrenceEngine();let n=V("today"),a=V(!1),o=V(!1),l=V(void 0),c=V(be(new Set)),u=V(be([])),h=Z(()=>Hu(i(u))),y=V(!1);const v=Z(()=>["inbox","today","upcoming","done","projects","search","all"].includes(i(n))?`dashboard-tab-${i(n)}`:void 0),p=Z(()=>()=>{let k=i(u);if(i(c).has("notDone")&&(k=k.filter(L=>L.status!=="done"&&L.status!=="cancelled")),i(c).has("dueToday")){const L=new Date;L.setHours(0,0,0,0);const X=new Date(L);X.setDate(X.getDate()+1),k=k.filter(ie=>{if(!ie.dueAt)return!1;const C=new Date(ie.dueAt);return C>=L&&C<X})}if(i(c).has("overdue")){const L=new Date;L.setHours(0,0,0,0),k=k.filter(X=>!X.dueAt||X.status==="done"||X.status==="cancelled"?!1:new Date(X.dueAt)<L)}return i(c).has("inProgress")&&(k=k.filter(L=>L.status==="todo"&&L.statusSymbol&&L.statusSymbol!==" ")),i(c).has("blocked")&&(k=k.filter(L=>Bu(L,i(u)))),i(c).has("blocking")&&(k=k.filter(L=>Yu(L,i(u)))),i(c).has("highPriority")&&(k=k.filter(L=>{const X=Wr(L.priority)||"normal";return X==="high"||X==="highest"})),k}),w=Z(()=>i(u).filter(k=>k.status!=="done"&&k.status!=="cancelled"&&!k.dueAt&&!k.scheduledAt&&!k.startAt).length),m=Z(()=>()=>{const k=new Date;k.setHours(0,0,0,0);const L=new Date(k);return L.setDate(L.getDate()+7),i(u).filter(X=>{if(X.status==="done"||X.status==="cancelled"||!X.dueAt)return!1;const ie=new Date(X.dueAt);return ie.setHours(0,0,0,0),ie>k&&ie<=L}).length}),g=Z(()=>()=>{const k=new Date;return k.setDate(k.getDate()-30),k.setHours(0,0,0,0),i(u).filter(L=>L.status!=="done"||!L.doneAt?!1:new Date(L.doneAt)>=k).length}),b=Z(()=>i(u).filter(k=>k.status!=="done"&&k.status!=="cancelled").length);function D(k="initial"){_(y,!0),_(u,e.repository.getAllTasks().map(L=>({...L})),!0),_(y,!1),k!=="initial"&&G.info("Task list reloaded")}D();const S=()=>D("reload");_n(()=>{window.addEventListener("recurring-task-refresh",S)}),Tu(()=>{window.removeEventListener("recurring-task-refresh",S)});async function x(k){Qe.emit("task: complete",{taskId:k.id})}async function F(k){const L=i(u),X=aa(i(u),k.id,ie=>{const C={...ie},O=new Date(C.dueAt),le=t.tomorrow();return le.setHours(O.getHours(),O.getMinutes(),0,0),C.dueAt=le.toISOString(),C.snoozeCount=(C.snoozeCount||0)+1,C.updatedAt=new Date().toISOString(),C});_(u,X,!0),G.info(`Task "${k.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",k),await e.scheduler.delayToTomorrow(k.id)}catch(ie){_(u,L,!0),G.error("Failed to delay task:  "+ie),D("external")}}async function P(k){var X;if(!((X=k.name)!=null&&X.trim())){G.error("Task name is required");return}if(!gl(k.frequency)){G.error("Invalid frequency configuration");return}const L={...k};_(u,na(i(u),L),!0),_(a,!1),_(l,void 0),G.success(`Task "${k.name}" saved successfully`),e.repository.saveTask(L).catch(ie=>{G.error("Failed to save task: "+ie),D("external")})}async function N(k){const L=i(u);_(u,Gi(i(u),k.id),!0);const X=window.setTimeout(async()=>{try{await e.repository.deleteTask(k.id)}catch(ie){_(u,L,!0),G.error("Failed to delete task: "+ie),D("external")}},5e3);or({message:`Task "${k.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(X),_(u,L,!0),G.info(`Restored "${k.name}"`)},showCountdown:!0})}async function W(k){const L=k.name.endsWith(" (copy)")?`${k.name} ${new Date().toLocaleDateString()}`:`${k.name} (copy)`,X=wl(k,{name:L});_(u,na(i(u),X),!0),G.success(`Duplicated "${k.name}"`),e.repository.saveTask(X).catch(ie=>{_(u,Gi(i(u),X.id),!0),G.error("Failed to duplicate task: "+ie),D("external")})}async function j(k){const L=!k.enabled,X={...k,enabled:L},ie=aa(i(u),k.id,()=>X);_(u,ie,!0),G.info(`Task ${L?"enabled":"disabled"}`),e.repository.saveTask(X).catch(C=>{G.error("Failed to update task: "+C),D("external")})}async function ee(k,L){if(k.length===0)return;const X=i(u),ie=new Set(k),C=i(u).map(O=>ie.has(O.id)?{...O,enabled:L}:O);_(u,C,!0),G.info(`${L?"Enabled":"Disabled"} ${k.length} task${k.length===1?"":"s"}`);try{const O=C.filter(le=>ie.has(le.id));await Promise.all(O.map(le=>e.repository.saveTask(le)))}catch(O){_(u,X,!0),G.error(`Failed to ${L?"enable":"disable"} tasks: ${O}`),D("external")}}async function re(k){if(k.length===0)return;const L=i(u),X=new Set(k),ie=i(u).filter(O=>X.has(O.id));_(u,i(u).filter(O=>!X.has(O.id)),!0);const C=window.setTimeout(async()=>{try{await Promise.all(ie.map(O=>e.repository.deleteTask(O.id)))}catch(O){_(u,L,!0),G.error("Failed to delete tasks: "+O),D("external")}},5e3);or({message:`${ie.length} task${ie.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(C),_(u,L,!0),G.info("Bulk delete undone")},showCountdown:!0})}function ae(k){_(l,k,!0),_(a,!0)}function he(){_(l,void 0),_(a,!0)}function me(){_(a,!1),_(l,void 0)}function H(){_(o,!0)}function q(){_(o,!1)}async function A(k){const L=i(u),X=aa(i(u),k.id,ie=>{const C={...ie};Tl(C);const O=r.calculateNext(new Date(C.dueAt),C.frequency);return C.dueAt=O.toISOString(),C});_(u,X,!0),G.info(`Task "${k.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",k),await e.scheduler.skipTaskOccurrence(k.id)}catch(ie){_(u,L,!0),G.error("Failed to skip task: "+ie),D("external")}}function Y(k){const L=new Set(i(c));L.has(k)?L.delete(k):L.add(k),_(c,L,!0)}async function se(k){const L={...k,status:"todo",doneAt:void 0};_(u,na(i(u),L),!0),G.success(`Task "${k.name}" marked as not done`),e.repository.saveTask(L).catch(X=>{G.error("Failed to update task: "+X),D("external")})}var J=av(),ye=d(J),ve=f(d(ye),2),fe=d(ve);fe.__click=()=>D("reload");var te=d(fe),oe=f(fe,2);oe.__click=H;var Ee=f(ye,2);{var R=k=>{var L=$f(),X=d(L);Qf(X,{get eventService(){return e.eventService},get shortcutManager(){return e.shortcutManager},onClose:q}),T(k,L)},Q=k=>{var L=He(),X=Pe(L);{var ie=O=>{var le=Xf(),ke=d(le);El(ke,{get task(){return i(l)},get repository(){return e.repository},onSave:P,onClose:me}),T(O,le)},C=O=>{var le=nv(),ke=Pe(le),Ae=d(ke);Ae.__click=()=>_(n,"inbox");var Ie=f(d(Ae));{var Oe=ce=>{var we=Zf(),Le=d(we);z(()=>B(Le,i(w))),T(ce,we)};K(Ie,ce=>{i(w)>0&&ce(Oe)})}var Be=f(Ae,2);Be.__click=()=>_(n,"today");var Ct=f(d(Be));{var Tt=ce=>{var we=Jf(),Le=d(we);z(()=>B(Le,i(h).length)),T(ce,we)};K(Ct,ce=>{i(h).length>0&&ce(Tt)})}var et=f(Be,2);et.__click=()=>_(n,"upcoming");var Rt=f(d(et));{var gt=ce=>{var we=ev(),Le=d(we);z(()=>B(Le,i(m))),T(ce,we)};K(Rt,ce=>{i(m)>0&&ce(gt)})}var Me=f(et,2);Me.__click=()=>_(n,"done");var It=f(d(Me));{var ze=ce=>{var we=tv(),Le=d(we);z(()=>B(Le,i(g))),T(ce,we)};K(It,ce=>{i(g)>0&&ce(ze)})}var $e=f(Me,2);$e.__click=()=>_(n,"projects");var tt=f(d($e));{var qt=ce=>{var we=sv(),Le=d(we);z(()=>B(Le,i(b))),T(ce,we)};K(tt,ce=>{i(b)>0&&ce(qt)})}var Lt=f($e,2);Lt.__click=()=>_(n,"search");var ts=f(Lt,2);ts.__click=()=>_(n,"all");var Fs=f(d(ts)),Ps=d(Fs),cs=f(ke,2);{var bs=ce=>{var we=rv(),Le=f(d(we),2);Le.__click=()=>Y("notDone");var We=f(Le,2);We.__click=()=>Y("dueToday");var st=f(We,2);st.__click=()=>Y("overdue");var rt=f(st,2);rt.__click=()=>Y("inProgress");var St=f(rt,2);St.__click=()=>Y("blocked");var Ht=f(St,2);Ht.__click=()=>Y("blocking");var _t=f(Ht,2);_t.__click=()=>Y("highPriority"),z((ss,Ft,rs,Bs,Pt,U,ue)=>{je(Le,1,`dashboard__filter-btn ${ss??""}`,"svelte-1y1a8hs"),je(We,1,`dashboard__filter-btn ${Ft??""}`,"svelte-1y1a8hs"),je(st,1,`dashboard__filter-btn ${rs??""}`,"svelte-1y1a8hs"),je(rt,1,`dashboard__filter-btn ${Bs??""}`,"svelte-1y1a8hs"),je(St,1,`dashboard__filter-btn ${Pt??""}`,"svelte-1y1a8hs"),je(Ht,1,`dashboard__filter-btn ${U??""}`,"svelte-1y1a8hs"),je(_t,1,`dashboard__filter-btn ${ue??""}`,"svelte-1y1a8hs")},[()=>i(c).has("notDone")?"active":"",()=>i(c).has("dueToday")?"active":"",()=>i(c).has("overdue")?"active":"",()=>i(c).has("inProgress")?"active":"",()=>i(c).has("blocked")?"active":"",()=>i(c).has("blocking")?"active":"",()=>i(c).has("highPriority")?"active":""]),T(ce,we)};K(cs,ce=>{i(n)!=="search"&&i(n)!=="timeline"&&i(n)!=="analytics"&&ce(bs)})}var Us=f(cs,2),ne=d(Us);{var _e=ce=>{{let we=Z(()=>i(c).size>0?i(p):i(u));Vd(ce,{get tasks(){return i(we)},onEdit:ae,onDone:x,onDelete:N})}},qe=ce=>{var we=He(),Le=Pe(we);{var We=rt=>{{let St=Z(()=>i(c).size>0?i(p).filter(Ht=>i(h).some(_t=>_t.id===Ht.id)):i(h));pd(rt,{get tasks(){return i(St)},onDone:x,onDelay:F,onSkip:A,onEdit:ae,get timezoneHandler(){return t}})}},st=rt=>{var St=He(),Ht=Pe(St);{var _t=Ft=>{{let rs=Z(()=>i(c).size>0?i(p):i(u));Jd(Ft,{get tasks(){return i(rs)},onEdit:ae,onDone:x,onDelete:N})}},ss=Ft=>{var rs=He(),Bs=Pe(rs);{var Pt=ue=>{{let Xe=Z(()=>i(c).size>0?i(p):i(u));ih(ue,{get tasks(){return i(Xe)},onEdit:ae,onDelete:N,onUncomplete:se})}},U=ue=>{var Xe=He(),ks=Pe(Xe);{var Kt=Tr=>{{let bn=Z(()=>i(c).size>0?i(p):i(u));hh(Tr,{get tasks(){return i(bn)},onEdit:ae,onDone:x,onDelete:N})}},wr=Tr=>{var bn=He(),Pl=Pe(bn);{var Ul=Sr=>{Jh(Sr,{get tasks(){return i(u)},onEdit:ae,onDone:x,onDelete:N})},Bl=Sr=>{var pi=He(),Yl=Pe(pi);{var jl=Dr=>{{let kn=Z(()=>i(c).size>0?i(p):i(u));Sd(Dr,{get tasks(){return i(kn)},onEdit:ae,onDelete:N,onDuplicate:W,onToggleEnabled:j,onBulkEnable:Zr=>ee(Zr,!0),onBulkDisable:Zr=>ee(Zr,!1),onBulkDelete:re,onCreate:he})}},zl=Dr=>{var kn=He(),Zr=Pe(kn);{var Hl=Er=>{Nd(Er,{get tasks(){return i(u)},get recurrenceEngine(){return r}})},Kl=Er=>{var yi=He(),Wl=Pe(yi);{var Gl=Xn=>{Hd(Xn,{get tasks(){return i(u)}})};K(Wl,Xn=>{i(n)==="analytics"&&Xn(Gl)},!0)}T(Er,yi)};K(Zr,Er=>{i(n)==="timeline"?Er(Hl):Er(Kl,!1)},!0)}T(Dr,kn)};K(Yl,Dr=>{i(n)==="all"?Dr(jl):Dr(zl,!1)},!0)}T(Sr,pi)};K(Pl,Sr=>{i(n)==="search"?Sr(Ul):Sr(Bl,!1)},!0)}T(Tr,bn)};K(ks,Tr=>{i(n)==="projects"?Tr(Kt):Tr(wr,!1)},!0)}T(ue,Xe)};K(Bs,ue=>{i(n)==="done"?ue(Pt):ue(U,!1)},!0)}T(Ft,rs)};K(Ht,Ft=>{i(n)==="upcoming"?Ft(_t):Ft(ss,!1)},!0)}T(rt,St)};K(Le,rt=>{i(n)==="today"?rt(We):rt(st,!1)},!0)}T(ce,we)};K(ne,ce=>{i(n)==="inbox"?ce(_e):ce(qe,!1)})}z(()=>{je(Ae,1,`dashboard__tab ${i(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),Se(Ae,"aria-selected",i(n)==="inbox"),je(Be,1,`dashboard__tab ${i(n)==="today"?"active":""}`,"svelte-1y1a8hs"),Se(Be,"aria-selected",i(n)==="today"),je(et,1,`dashboard__tab ${i(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),Se(et,"aria-selected",i(n)==="upcoming"),je(Me,1,`dashboard__tab ${i(n)==="done"?"active":""}`,"svelte-1y1a8hs"),Se(Me,"aria-selected",i(n)==="done"),je($e,1,`dashboard__tab ${i(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),Se($e,"aria-selected",i(n)==="projects"),je(Lt,1,`dashboard__tab ${i(n)==="search"?"active":""}`,"svelte-1y1a8hs"),Se(Lt,"aria-selected",i(n)==="search"),je(ts,1,`dashboard__tab ${i(n)==="all"?"active":""}`,"svelte-1y1a8hs"),Se(ts,"aria-selected",i(n)==="all"),B(Ps,i(u).length),Se(Us,"aria-labelledby",i(v))}),T(O,le)};K(X,O=>{i(a)?O(ie):O(C,!1)},!0)}T(k,L)};K(Ee,k=>{i(o)?k(R):k(Q,!1)})}z(()=>{fe.disabled=i(y),B(te,i(y)?"⟳":"↻")}),T(s,J),Ve()}at(["click"]);var ov=I('<div class="quick-add-card__error svelte-1q3w22"> </div>'),lv=I('<div class="quick-add-card__error svelte-1q3w22"> </div>'),cv=I('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),uv=I('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),dv=I('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">✕</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ⌘/Ctrl + Enter to save.</p></div></div>');function hv(s,e){var q;Ge(e,!0);let t=V(be(((q=e.prefill)==null?void 0:q.suggestedName)??"")),r=V(be(new Date().toISOString().slice(0,16))),n=V(be({name:!1,dueAt:!1})),a=V(!1),o=V(null);const l=Z(()=>i(n).name&&!i(t).trim()?"Task name is required.":""),c=Z(()=>i(n).dueAt?i(r)?Number.isNaN(new Date(i(r)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=Z(()=>!!(i(l)||i(c)));_n(()=>{var A;if((A=e.prefill)!=null&&A.suggestedTime){const Y=new Date,[se,J]=e.prefill.suggestedTime.split(":").map(Number);Y.setHours(se,J,0,0),_(r,Y.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var Y;(Y=i(o))==null||Y.focus()})});async function h(){var J,ye;if(_(n,{name:!0,dueAt:!0},!0),i(u)){G.warning("Please fill out the required fields.");return}const A=Du(),Y=i(r).slice(11,16);if(A.time=Y,!gl(A)){G.error("Invalid frequency configuration.");return}const se=bl(i(t).trim(),A,new Date(i(r)));se.linkedBlockId=((J=e.prefill)==null?void 0:J.linkedBlockId)||void 0,se.linkedBlockContent=((ye=e.prefill)==null?void 0:ye.linkedBlockContent)||void 0,_(a,!0);try{await e.repository.saveTask(se),G.success(`Task "${se.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(ve){G.error("Failed to create task: "+ve)}finally{_(a,!1)}}function y(A){A.key==="Escape"&&e.onClose(),(A.metaKey||A.ctrlKey)&&A.key==="Enter"&&(A.preventDefault(),h())}var v=dv();v.__keydown=y;var p=d(v),w=d(p),m=f(d(w),2);m.__click=function(...A){var Y;(Y=e.onClose)==null||Y.apply(this,A)};var g=f(w,2),b=f(d(g),2);b.__input=()=>i(n).name=!0,ls(b,A=>_(o,A),()=>i(o));var D=f(b,2);{var S=A=>{var Y=ov(),se=d(Y);z(()=>B(se,i(l))),T(A,Y)};K(D,A=>{i(l)&&A(S)})}var x=f(g,2),F=f(d(x),2);F.__input=()=>i(n).dueAt=!0;var P=f(F,2);{var N=A=>{var Y=lv(),se=d(Y);z(()=>B(se,i(c))),T(A,Y)};K(P,A=>{i(c)&&A(N)})}var W=f(x,2);{var j=A=>{var Y=cv(),se=f(d(Y)),J=d(se);z(()=>B(J,e.prefill.linkedBlockId)),T(A,Y)};K(W,A=>{var Y;(Y=e.prefill)!=null&&Y.linkedBlockId&&A(j)})}var ee=f(W,2),re=d(ee);re.__click=function(...A){var Y;(Y=e.onClose)==null||Y.apply(this,A)};var ae=f(re,2);{var he=A=>{var Y=uv();Y.__click=function(...se){var J;(J=e.onAdvanced)==null||J.apply(this,se)},T(A,Y)};K(ae,A=>{e.onAdvanced&&A(he)})}var me=f(ae,2);me.__click=h;var H=d(me);z(()=>{Se(b,"aria-invalid",!!i(l)),Se(F,"aria-invalid",!!i(c)),me.disabled=i(a),B(H,i(a)?"Saving…":"Create Task")}),pt("blur",b,()=>i(n).name=!0),lt(b,()=>i(t),A=>_(t,A)),pt("blur",F,()=>i(n).dueAt=!0),lt(F,()=>i(r),A=>_(r,A)),T(s,v),Ve()}at(["keydown","click","input"]);var fv=I('<button class="postpone-card__option svelte-tkdeu6" type="button" role="listitem"> </button>'),vv=I('<div class="postpone-overlay svelte-tkdeu6" role="dialog" aria-modal="true" aria-labelledby="postpone-title"><div class="postpone-card svelte-tkdeu6" role="document"><div class="postpone-card__header svelte-tkdeu6"><h2 id="postpone-title" class="svelte-tkdeu6">Postpone task</h2> <button class="postpone-card__close svelte-tkdeu6" type="button" aria-label="Close">✕</button></div> <p class="postpone-card__summary svelte-tkdeu6">Choose a new due offset for <strong> </strong>.</p> <div class="postpone-card__options svelte-tkdeu6" role="list"></div> <div class="postpone-card__actions svelte-tkdeu6"><button class="postpone-card__cancel svelte-tkdeu6" type="button">Cancel</button></div></div></div>');function pv(s,e){Ge(e,!0);let t=V(null);function r(m,g){g&&_(t,m,!0)}_n(()=>{requestAnimationFrame(()=>{var m;(m=i(t))==null||m.focus()})});function n(m){m.key==="Escape"&&e.onClose()}var a=vv();a.__keydown=n;var o=d(a),l=d(o),c=f(d(l),2);c.__click=function(...m){var g;(g=e.onClose)==null||g.apply(this,m)};var u=f(l,2),h=f(d(u)),y=d(h),v=f(u,2);Ue(v,21,()=>Ou,yt,(m,g,b)=>{var D=fv();D.__click=()=>e.onSelect(i(g).minutes);var S=d(D);fu(D,(x,F)=>r==null?void 0:r(x,F),()=>b===0),z(()=>B(S,i(g).label)),T(m,D)});var p=f(v,2),w=d(p);w.__click=function(...m){var g;(g=e.onClose)==null||g.apply(this,m)},z(()=>B(y,e.taskName)),T(s,a),Ve()}at(["keydown","click"]);class yv{constructor(e){E(this,"plugin");this.plugin=e}getCurrentVersion(){return js}async createBackup(e,t){try{const r=await this.plugin.loadData(e);if(r){const n=new Date().toISOString().replace(/[:.]/g,"-"),a=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${a}-${n}`;return await this.plugin.saveData(o,r),de(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(r){throw ge("Failed to create backup",r),r}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return de("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:js};const r=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(r.length===0)return de("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:js};let n=!1,a,o,l=0;for(let c=0;c<r.length;c++){const u=r[c],h=u.version||0;h<js&&(n||(o=h,a=await this.createBackup(e,h),n=!0),r[c]=this.migrateTask(u,h),l++,de(`Migrated task ${u.id} from v${h} to v${js}`))}if(n){const c=Array.isArray(t)?r:{...t,tasks:r};return await this.plugin.saveData(e,c),de(`Migration complete: ${l} tasks migrated`),{migrated:!0,tasksAffected:l,fromVersion:o,toVersion:js,backupKey:a}}else return de("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:js}}catch(t){throw ge("Migration failed",t),t}}migrateTask(e,t){let r={...e};return t<1&&(r.version=1),t<2&&(r={...r,version:2,timezone:r.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:r.completionCount||0,missCount:r.missCount||0,currentStreak:r.currentStreak||0,bestStreak:r.bestStreak||0,recentCompletions:r.recentCompletions||[],priority:r.priority||"normal",tags:r.tags||[],notificationChannels:r.notificationChannels||[],snoozeCount:r.snoozeCount||0,maxSnoozes:r.maxSnoozes||3}),t<3&&(r={...r,version:3,escalationPolicy:r.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:r.linkedBlockContent||void 0,category:r.category||void 0,description:r.description||void 0}),t<4&&(r={...r,version:4,onCompletion:r.onCompletion||"keep",dependsOn:r.dependsOn||[],blockedBy:r.blockedBy||[]}),r}}class mv{constructor(e,t=50){E(this,"pendingState",null);E(this,"writeInProgress",!1);E(this,"scheduledTimer",null);E(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){ge("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return ge("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const Ca={},gv=Object.freeze(Object.defineProperty({__proto__:null,default:Ca},Symbol.toStringTag,{value:"Module"})),Ji=new Set;function Mn(s){const e=`${s.feature}:${s.capability}:${s.message}`;Ji.has(e)||(Ji.add(e),Ke(s.message,{feature:s.feature,capability:s.capability,cause:s.cause}))}class xl extends Error{constructor(t,r,n){super(n);E(this,"capability");E(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=r}}class Al extends Error{constructor(t,r,n,a){super(n);E(this,"capability");E(this,"feature");E(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=r,this.cause=a}}class _v{constructor(e=globalThis){E(this,"supportedCapabilities");E(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,r,n;return typeof((n=(r=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:r.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,r;return this.isDataDirAvailable()?((r=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:r.dataDir)??null:null}async setBlockAttrs(e,t){const r=this.getSetBlockAttrs();try{await r(e,t)}catch(n){throw new Al("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new xl("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const bv=".tmp";class kv{constructor(e,t){E(this,"plugin");E(this,"apiAdapter");E(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(ir);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){ge("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),de(`Saved ${e.tasks.length} active tasks`)}catch(t){throw ge("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(ir,e);return}const r=this.resolveStoragePath(ir);if(!r){await this.plugin.saveData(ir,e);return}const n=Ca.dirname(r);await t.mkdir(n,{recursive:!0});const a=`${r}${bv}`,o=JSON.stringify(e),l=await t.open(a,"w");try{await l.writeFile(o,"utf8"),await l.sync()}finally{await l.close()}try{await t.rename(a,r)}catch{await t.rm(r,{force:!0}),await t.rename(a,r)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>gv);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Ke("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),r=this.plugin.name;return!t||!r?(t||Mn({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):Ca.join(t,"storage",`p${r}`,`${e}.json`)}}const eo=1,to=1e3;class wv{constructor(e){E(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),r=this.groupByYear(e);for(const[n,a]of r.entries())await this.appendTasksToYear(t,n,a);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const r=this.filterChunks(t.chunks,e),n=[];for(const l of r){const c=await this.loadChunk(l.key);if(c)for(const u of c.tasks)this.matchesQuery(u,e)&&n.push(u)}const a=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(a,a+o)}async loadIndex(){try{const e=await this.plugin.loadData(Cn);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??eo,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){ge("Failed to load archive index",e)}return{version:eo,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Cn,e)}catch(t){throw ge("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Cn}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){ge("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(r){throw ge("Failed to save archive chunk",{key:e,err:r}),r}}groupByYear(e){const t=new Map;for(const r of e){const n=this.getCompletionTimestamp(r),a=new Date(n).getFullYear(),o=t.get(a);o?o.push(r):t.set(a,[r])}return t}async appendTasksToYear(e,t,r){let n=[...r];for(;n.length>0;){const a=this.findOrCreateChunk(e,t),o=await this.loadChunk(a.key)||{tasks:[]},l=to-o.tasks.length,c=n.slice(0,l);o.tasks.push(...c),n=n.slice(c.length);const u=this.updateChunkMeta(a,c);a.count=u.count,a.start=u.start,a.end=u.end,await this.saveChunk(a.key,o),e.totalCount+=c.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(l=>l.year===t).sort((l,c)=>l.sequence-c.sequence).at(-1);if(n&&n.count<to)return n;const a=n?n.sequence+1:1,o={key:this.buildChunkKey(t,a),year:t,sequence:a,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let r=e.start,n=e.end;for(const a of t){const o=this.getCompletionTimestamp(a);(!r||o<r)&&(r=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:r,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const r=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(a=>{const o=a.start?new Date(a.start).getTime():null,l=a.end?new Date(a.end).getTime():null;return!(r&&l&&l<r||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const r=this.getCompletionTimestamp(e),n=new Date(r).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Tv{constructor(e,t=new _v){E(this,"plugin");E(this,"activeTasks");E(this,"blockIndex",new Map);E(this,"taskBlockIndex",new Map);E(this,"dueIndex",new Map);E(this,"activeStore");E(this,"archiveStore");E(this,"persistence");E(this,"blockAttrSyncEnabled",!0);E(this,"blockApi");E(this,"apiAdapter");E(this,"syncRetryQueue",new Map);E(this,"retryProcessorInterval");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new kv(e,t),this.archiveStore=new wv(e),this.persistence=new mv(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),de(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex(),this.startSyncRetryProcessor()}async loadActiveTasks(e=1e3,t){const r=await this.activeStore.loadActive(),n=Array.from(r.values()),a=n.length;if(a===0)return[];const o=[];for(let l=0;l<a;l+=e){const c=n.slice(l,Math.min(l+e,a));o.push(...c),t&&t(o.length,a),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));de(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);de(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),r=this.dueIndex.get(t);r&&(r.delete(e.id),r.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),r=[];for(const[n]of this.dueIndex)n<=t&&r.push(...this.getTasksForDueKey(n));return r}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const r=[];for(const n of t){const a=this.activeTasks.get(n);if(!a){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!a.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(a.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}r.push(a)}return r}removeStaleDueIndexEntry(e,t,r){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),Ke("Removed stale due index entry",{taskId:t,dateKey:e,reason:r}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id);if(t&&e.version!==void 0&&t.version!==void 0&&e.version<t.version)throw new Error(`Concurrent modification detected for task "${e.name}". Please refresh and try again.`);e.version=(e.version??0)+1;const r=this.activeTasks.get(e.id),n=this.taskBlockIndex.get(e.id);n&&n!==e.linkedBlockId&&(this.blockIndex.delete(n),this.taskBlockIndex.delete(e.id)),r&&r.enabled&&(r.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(r),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrsWithRetry(e),n&&n!==e.linkedBlockId&&await this.clearBlockAttrs(n)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[ji]:e.id,[zi]:e.dueAt,[Hi]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[ji]:"",[zi]:"",[Hi]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Mn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(r){r instanceof xl||r instanceof Al?Mn({feature:r.feature,capability:r.capability,message:r.message,cause:r.cause}):Mn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:r}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(r=>new Date(r.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(r=>{const n=new Date(r.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(ir);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(Mi);if(!t)return;const r=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(r.length===0)return;await this.plugin.saveData(Ni,t),de(`Created legacy backup at ${Ni}`);const n=r.filter(l=>!l.enabled&&l.lastCompletedAt),a=r.filter(l=>!n.includes(l)),o=new Map(a.map(l=>[l.id,l]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),de("Legacy storage migration complete",{activeCount:a.length,archivedCount:n.length,legacyKey:Mi,activeKey:ir,archiveIndexKey:Cn})}async syncTaskToBlockAttrsWithRetry(e){try{await this.syncTaskToBlockAttrs(e),this.syncRetryQueue.delete(e.id)}catch(t){const r=this.syncRetryQueue.get(e.id)||{task:e,attempts:0,nextRetry:Date.now()};r.attempts<En?(r.attempts++,r.nextRetry=Date.now()+Ki[r.attempts-1],r.task=e,this.syncRetryQueue.set(e.id,r),Ke(`Block sync failed for task ${e.id}, added to retry queue`,{taskId:e.id,attempts:r.attempts,nextRetry:new Date(r.nextRetry).toISOString(),error:t instanceof Error?t.message:String(t)})):(ge(`Block sync failed for task ${e.id} after ${En} attempts`,{taskId:e.id,error:t instanceof Error?t.message:String(t)}),this.syncRetryQueue.delete(e.id))}}startSyncRetryProcessor(){this.retryProcessorInterval&&clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=setInterval(async()=>{const e=Date.now(),t=[];for(const[r,n]of this.syncRetryQueue.entries())n.nextRetry<=e&&t.push({id:r,entry:n});for(const{id:r,entry:n}of t)try{await this.syncTaskToBlockAttrs(n.task),this.syncRetryQueue.delete(r),de(`Block sync retry succeeded for task ${r}`,{taskId:r,attempts:n.attempts})}catch(a){n.attempts<En?(n.attempts++,n.nextRetry=Date.now()+Ki[n.attempts-1],this.syncRetryQueue.set(r,n),Ke(`Block sync retry failed for task ${r}`,{taskId:r,attempts:n.attempts,nextRetry:new Date(n.nextRetry).toISOString(),error:a instanceof Error?a.message:String(a)})):(ge(`Block sync retry exhausted for task ${r} after ${En} attempts`,{taskId:r,error:a instanceof Error?a.message:String(a)}),this.syncRetryQueue.delete(r))}},Ru)}stopSyncRetryProcessor(){this.retryProcessorInterval&&(clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=void 0)}}class Sv{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}var Ia=["MO","TU","WE","TH","FR","SA","SU"],Et=function(){function s(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return s.fromStr=function(e){return new s(Ia.indexOf(e))},s.prototype.nth=function(e){return this.n===e?this:new s(this.weekday,e)},s.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},s.prototype.toString=function(){var e=Ia[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},s.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},s}(),Ze=function(s){return s!=null},us=function(s){return typeof s=="number"},so=function(s){return typeof s=="string"&&Ia.includes(s)},Yt=Array.isArray,_s=function(s,e){e===void 0&&(e=s),arguments.length===1&&(e=s,s=0);for(var t=[],r=s;r<e;r++)t.push(r);return t},Ne=function(s,e){var t=0,r=[];if(Yt(s))for(;t<e;t++)r[t]=[].concat(s);else for(;t<e;t++)r[t]=s;return r},Dv=function(s){return Yt(s)?s:[s]};function Cr(s,e,t){t===void 0&&(t=" ");var r=String(s);return e=e>>0,r.length>e?String(r):(e=e-r.length,e>t.length&&(t+=Ne(t,e/t.length)),t.slice(0,e)+String(r))}var Ev=function(s,e,t){var r=s.split(e);return t?r.slice(0,t).concat([r.slice(t).join(e)]):r},Zt=function(s,e){var t=s%e;return t*e<0?t+e:t},ia=function(s,e){return{div:Math.floor(s/e),mod:Zt(s,e)}},ys=function(s){return!Ze(s)||s.length===0},ot=function(s){return!ys(s)},Ye=function(s,e){return ot(s)&&s.indexOf(e)!==-1},br=function(s,e,t,r,n,a){return r===void 0&&(r=0),n===void 0&&(n=0),a===void 0&&(a=0),new Date(Date.UTC(s,e-1,t,r,n,a))},xv=[31,28,31,30,31,30,31,31,30,31,30,31],Cl=1e3*60*60*24,Il=9999,Ol=br(1970,1,1),Av=[6,0,1,2,3,4,5],on=function(s){return s%4===0&&s%100!==0||s%400===0},Ml=function(s){return s instanceof Date},tn=function(s){return Ml(s)&&!isNaN(s.getTime())},Cv=function(s,e){var t=s.getTime(),r=e.getTime(),n=t-r;return Math.round(n/Cl)},Oa=function(s){return Cv(s,Ol)},Nl=function(s){return new Date(Ol.getTime()+s*Cl)},Iv=function(s){var e=s.getUTCMonth();return e===1&&on(s.getUTCFullYear())?29:xv[e]},Gr=function(s){return Av[s.getUTCDay()]},ro=function(s,e){var t=br(s,e+1,1);return[Gr(t),Iv(t)]},Rl=function(s,e){return e=e||s,new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Ma=function(s){var e=new Date(s.getTime());return e},no=function(s){for(var e=[],t=0;t<s.length;t++)e.push(Ma(s[t]));return e},hn=function(s){s.sort(function(e,t){return e.getTime()-t.getTime()})},ui=function(s,e){e===void 0&&(e=!0);var t=new Date(s);return[Cr(t.getUTCFullYear().toString(),4,"0"),Cr(t.getUTCMonth()+1,2,"0"),Cr(t.getUTCDate(),2,"0"),"T",Cr(t.getUTCHours(),2,"0"),Cr(t.getUTCMinutes(),2,"0"),Cr(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},di=function(s){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(s);if(!t)throw new Error("Invalid UNTIL value: ".concat(s));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},ao=function(s,e){var t=s.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},Ov=function(s,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,r=new Date(ao(s,t)),n=new Date(ao(s,e??"UTC")),a=n.getTime()-r.getTime();return new Date(s.getTime()-a)},Mr=function(){function s(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return s.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,r=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(r)return!1}else if(this.method==="before"){if(r)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},s.prototype.add=function(e){return this._result.push(e),!0},s.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},s.prototype.clone=function(){return new s(this.method,this.args)},s}(),Na=function(s,e){return Na=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])},Na(s,e)};function hi(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Na(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var zt=function(){return zt=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},zt.apply(this,arguments)};function $(s,e,t){if(t||arguments.length===2)for(var r=0,n=e.length,a;r<n;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return s.concat(a||Array.prototype.slice.call(e))}var io=function(s){hi(e,s);function e(t,r,n){var a=s.call(this,t,r)||this;return a.iterator=n,a}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Mr),Fn={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},oo=function(s,e){return s.indexOf(e)!==-1},Mv=function(s){return s.toString()},Nv=function(s,e,t){return"".concat(e," ").concat(t,", ").concat(s)},Ls=function(){function s(e,t,r,n){if(t===void 0&&(t=Mv),r===void 0&&(r=Fn),n===void 0&&(n=Nv),this.text=[],this.language=r||Fn,this.gettext=t,this.dateFormatter=n,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var a=[].concat(this.options.bymonthday),o=[].concat(this.options.bynmonthday);a.sort(function(h,y){return h-y}),o.sort(function(h,y){return y-h}),this.bymonthday=a.concat(o),this.bymonthday.length||(this.bymonthday=null)}if(Ze(this.origOptions.byweekday)){var l=Yt(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],c=String(l);this.byweekday={allWeeks:l.filter(function(h){return!h.n}),someWeeks:l.filter(function(h){return!!h.n}),isWeekdays:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")===-1&&c.indexOf("SU")===-1,isEveryDay:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")!==-1&&c.indexOf("SU")!==-1};var u=function(h,y){return h.weekday-y.weekday};this.byweekday.allWeeks.sort(u),this.byweekday.someWeeks.sort(u),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return s.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in s.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var r in e.origOptions){if(oo(["dtstart","tzid","wkst","freq"],r))return!0;if(!oo(s.IMPLEMENTED[e.options.freq],r))return!1}return t},s.prototype.isFullyConvertible=function(){return s.isFullyConvertible(this.rrule)},s.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in s.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[pe.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},s.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},s.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},s.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},s.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},s.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},s.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},s.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},s.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},s.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},s.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},s.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,r=this.gettext;if(e===-1)return r("last");var n=Math.abs(e);switch(n){case 1:case 21:case 31:t=n+r("st");break;case 2:case 22:t=n+r("nd");break;case 3:case 23:t=n+r("rd");break;default:t=n+r("th")}return e<0?t+" "+r("last"):t},s.prototype.monthtext=function(e){return this.language.monthNames[e-1]},s.prototype.weekdaytext=function(e){var t=us(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},s.prototype.plural=function(e){return e%100!==1},s.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},s.prototype.list=function(e,t,r,n){var a=this;n===void 0&&(n=","),Yt(e)||(e=[e]);var o=function(c,u,h){for(var y="",v=0;v<c.length;v++)v!==0&&(v===c.length-1?y+=" "+h+" ":y+=u+" "),y+=c[v];return y};t=t||function(c){return c.toString()};var l=function(c){return t&&t.call(a,c)};return r?o(e.map(l),n,r):e.map(l).join(n+" ")},s}(),Rv=function(){function s(e){this.done=!0,this.rules=e}return s.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},s.prototype.isDone=function(){return this.done&&this.symbol===null},s.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var r=void 0;e=null;for(var n in this.rules){r=this.rules[n];var a=r.exec(this.text);a&&(e===null||a[0].length>e[0].length)&&(e=a,t=n)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},s.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},s.prototype.acceptNumber=function(){return this.accept("number")},s.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},s}();function ql(s,e){e===void 0&&(e=Fn);var t={},r=new Rv(e.tokens);if(!r.start(s))return null;return n(),t;function n(){r.expect("every");var v=r.acceptNumber();if(v&&(t.interval=parseInt(v[0],10)),r.isDone())throw new Error("Unexpected end");switch(r.symbol){case"day(s)":t.freq=pe.DAILY,r.nextSymbol()&&(o(),y());break;case"weekday(s)":t.freq=pe.WEEKLY,t.byweekday=[pe.MO,pe.TU,pe.WE,pe.TH,pe.FR],r.nextSymbol(),o(),y();break;case"week(s)":t.freq=pe.WEEKLY,r.nextSymbol()&&(a(),o(),y());break;case"hour(s)":t.freq=pe.HOURLY,r.nextSymbol()&&(a(),y());break;case"minute(s)":t.freq=pe.MINUTELY,r.nextSymbol()&&(a(),y());break;case"month(s)":t.freq=pe.MONTHLY,r.nextSymbol()&&(a(),y());break;case"year(s)":t.freq=pe.YEARLY,r.nextSymbol()&&(a(),y());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=pe.WEEKLY;var p=r.symbol.substr(0,2).toUpperCase();if(t.byweekday=[pe[p]],!r.nextSymbol())return;for(;r.accept("comma");){if(r.isDone())throw new Error("Unexpected end");var w=c();if(!w)throw new Error("Unexpected symbol "+r.symbol+", expected weekday");t.byweekday.push(pe[w]),r.nextSymbol()}o(),h(),y();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=pe.YEARLY,t.bymonth=[l()],!r.nextSymbol())return;for(;r.accept("comma");){if(r.isDone())throw new Error("Unexpected end");var m=l();if(!m)throw new Error("Unexpected symbol "+r.symbol+", expected month");t.bymonth.push(m),r.nextSymbol()}a(),y();break;default:throw new Error("Unknown symbol")}}function a(){var v=r.accept("on"),p=r.accept("the");if(v||p)do{var w=u(),m=c(),g=l();if(w)m?(r.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(pe[m].nth(w))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(w),r.accept("day(s)"));else if(m)r.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(pe[m]);else if(r.symbol==="weekday(s)")r.nextSymbol(),t.byweekday||(t.byweekday=[pe.MO,pe.TU,pe.WE,pe.TH,pe.FR]);else if(r.symbol==="week(s)"){r.nextSymbol();var b=r.acceptNumber();if(!b)throw new Error("Unexpected symbol "+r.symbol+", expected week number");for(t.byweekno=[parseInt(b[0],10)];r.accept("comma");){if(b=r.acceptNumber(),!b)throw new Error("Unexpected symbol "+r.symbol+"; expected monthday");t.byweekno.push(parseInt(b[0],10))}}else if(g)r.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(g);else return}while(r.accept("comma")||r.accept("the")||r.accept("on"))}function o(){var v=r.accept("at");if(v)do{var p=r.acceptNumber();if(!p)throw new Error("Unexpected symbol "+r.symbol+", expected hour");for(t.byhour=[parseInt(p[0],10)];r.accept("comma");){if(p=r.acceptNumber(),!p)throw new Error("Unexpected symbol "+r.symbol+"; expected hour");t.byhour.push(parseInt(p[0],10))}}while(r.accept("comma")||r.accept("at"))}function l(){switch(r.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function c(){switch(r.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return r.symbol.substr(0,2).toUpperCase();default:return!1}}function u(){switch(r.symbol){case"last":return r.nextSymbol(),-1;case"first":return r.nextSymbol(),1;case"second":return r.nextSymbol(),r.accept("last")?-2:2;case"third":return r.nextSymbol(),r.accept("last")?-3:3;case"nth":var v=parseInt(r.value[1],10);if(v<-366||v>366)throw new Error("Nth out of range: "+v);return r.nextSymbol(),r.accept("last")?-v:v;default:return!1}}function h(){r.accept("on"),r.accept("the");var v=u();if(v)for(t.bymonthday=[v],r.nextSymbol();r.accept("comma");){if(v=u(),!v)throw new Error("Unexpected symbol "+r.symbol+"; expected monthday");t.bymonthday.push(v),r.nextSymbol()}}function y(){if(r.symbol==="until"){var v=Date.parse(r.text);if(!v)throw new Error("Cannot parse until date:"+r.text);t.until=new Date(v)}else r.accept("for")&&(t.count=parseInt(r.value[0],10),r.expect("number"))}}var Re;(function(s){s[s.YEARLY=0]="YEARLY",s[s.MONTHLY=1]="MONTHLY",s[s.WEEKLY=2]="WEEKLY",s[s.DAILY=3]="DAILY",s[s.HOURLY=4]="HOURLY",s[s.MINUTELY=5]="MINUTELY",s[s.SECONDLY=6]="SECONDLY"})(Re||(Re={}));function fi(s){return s<Re.HOURLY}var qv=function(s,e){return e===void 0&&(e=Fn),new pe(ql(s,e)||void 0)},Xr=["count","until","interval","byweekday","bymonthday","bymonth"];Ls.IMPLEMENTED=[];Ls.IMPLEMENTED[Re.HOURLY]=Xr;Ls.IMPLEMENTED[Re.MINUTELY]=Xr;Ls.IMPLEMENTED[Re.DAILY]=["byhour"].concat(Xr);Ls.IMPLEMENTED[Re.WEEKLY]=Xr;Ls.IMPLEMENTED[Re.MONTHLY]=Xr;Ls.IMPLEMENTED[Re.YEARLY]=["byweekno","byyearday"].concat(Xr);var Lv=function(s,e,t,r){return new Ls(s,e,t,r).toString()},Fv=Ls.isFullyConvertible,Pn=function(){function s(e,t,r,n){this.hour=e,this.minute=t,this.second=r,this.millisecond=n||0}return s.prototype.getHours=function(){return this.hour},s.prototype.getMinutes=function(){return this.minute},s.prototype.getSeconds=function(){return this.second},s.prototype.getMilliseconds=function(){return this.millisecond},s.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},s}(),Pv=function(s){hi(e,s);function e(t,r,n,a,o,l,c){var u=s.call(this,a,o,l,c)||this;return u.year=t,u.month=r,u.day=n,u}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return Gr(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var r=Math.floor(this.month/12),n=Zt(this.month,12);this.month=n,this.year+=r,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,r){r>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-r))+t*7:this.day+=-(this.getWeekday()-r)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,r,n){for(r&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var a=ia(this.hour,24),o=a.div,l=a.mod;if(o&&(this.hour=l,this.addDaily(o)),ys(n)||Ye(n,this.hour))break}},e.prototype.addMinutes=function(t,r,n,a){for(r&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var o=ia(this.minute,60),l=o.div,c=o.mod;if(l&&(this.minute=c,this.addHours(l,!1,n)),(ys(n)||Ye(n,this.hour))&&(ys(a)||Ye(a,this.minute)))break}},e.prototype.addSeconds=function(t,r,n,a,o){for(r&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var l=ia(this.second,60),c=l.div,u=l.mod;if(c&&(this.second=u,this.addMinutes(c,!1,n,a)),(ys(n)||Ye(n,this.hour))&&(ys(a)||Ye(a,this.minute))&&(ys(o)||Ye(o,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=ro(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>Il))return;t=ro(this.year,this.month-1)[1]}}},e.prototype.add=function(t,r){var n=t.freq,a=t.interval,o=t.wkst,l=t.byhour,c=t.byminute,u=t.bysecond;switch(n){case Re.YEARLY:return this.addYears(a);case Re.MONTHLY:return this.addMonths(a);case Re.WEEKLY:return this.addWeekly(a,o);case Re.DAILY:return this.addDaily(a);case Re.HOURLY:return this.addHours(a,r,l);case Re.MINUTELY:return this.addMinutes(a,r,l,c);case Re.SECONDLY:return this.addSeconds(a,r,l,c,u)}},e}(Pn);function Ll(s){for(var e=[],t=Object.keys(s),r=0,n=t;r<n.length;r++){var a=n[r];Ye(vp,a)||e.push(a),Ml(s[a])&&!tn(s[a])&&e.push(a)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return zt({},s)}function Uv(s){var e=zt(zt({},vi),Ll(s));if(Ze(e.byeaster)&&(e.freq=pe.YEARLY),!(Ze(e.freq)&&pe.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(s.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),Ze(e.wkst)?us(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=pe.MO.weekday,Ze(e.bysetpos)){us(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var r=e.bysetpos[t];if(r===0||!(r>=-366&&r<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||ot(e.byweekno)||ot(e.byyearday)||e.bymonthday||ot(e.bymonthday)||Ze(e.byweekday)||Ze(e.byeaster)))switch(e.freq){case pe.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case pe.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case pe.WEEKLY:e.byweekday=[Gr(e.dtstart)];break}if(Ze(e.bymonth)&&!Yt(e.bymonth)&&(e.bymonth=[e.bymonth]),Ze(e.byyearday)&&!Yt(e.byyearday)&&us(e.byyearday)&&(e.byyearday=[e.byyearday]),!Ze(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(Yt(e.bymonthday)){for(var n=[],a=[],t=0;t<e.bymonthday.length;t++){var r=e.bymonthday[t];r>0?n.push(r):r<0&&a.push(r)}e.bymonthday=n,e.bynmonthday=a}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(Ze(e.byweekno)&&!Yt(e.byweekno)&&(e.byweekno=[e.byweekno]),!Ze(e.byweekday))e.bynweekday=null;else if(us(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(so(e.byweekday))e.byweekday=[Et.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof Et)!e.byweekday.n||e.freq>pe.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var o=[],l=[],t=0;t<e.byweekday.length;t++){var c=e.byweekday[t];if(us(c)){o.push(c);continue}else if(so(c)){o.push(Et.fromStr(c).weekday);continue}!c.n||e.freq>pe.MONTHLY?o.push(c.weekday):l.push([c.weekday,c.n])}e.byweekday=ot(o)?o:null,e.bynweekday=ot(l)?l:null}return Ze(e.byhour)?us(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<pe.HOURLY?[e.dtstart.getUTCHours()]:null,Ze(e.byminute)?us(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<pe.MINUTELY?[e.dtstart.getUTCMinutes()]:null,Ze(e.bysecond)?us(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<pe.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function Bv(s){var e=s.dtstart.getTime()%1e3;if(!fi(s.freq))return[];var t=[];return s.byhour.forEach(function(r){s.byminute.forEach(function(n){s.bysecond.forEach(function(a){t.push(new Pn(r,n,a,e))})})}),t}function Ra(s){var e=s.split(`
`).map(Yv).filter(function(t){return t!==null});return zt(zt({},e[0]),e[1])}function Un(s){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(s);if(!t)return e;var r=t[1],n=t[2];return r&&(e.tzid=r),e.dtstart=di(n),e}function Yv(s){if(s=s.replace(/^\s+|\s+$/,""),!s.length)return null;var e=/^([A-Z]+?)[:;]/.exec(s.toUpperCase());if(!e)return lo(s);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return lo(s);case"DTSTART":return Un(s);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(s))}}function lo(s){var e=s.replace(/^RRULE:/i,""),t=Un(e),r=s.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return r.forEach(function(n){var a=n.split("="),o=a[0],l=a[1];switch(o.toUpperCase()){case"FREQ":t.freq=Re[l.toUpperCase()];break;case"WKST":t.wkst=is[l.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var c=jv(l),u=o.toLowerCase();t[u]=c;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=zv(l);break;case"DTSTART":case"TZID":var h=Un(s);t.tzid=h.tzid,t.dtstart=h.dtstart;break;case"UNTIL":t.until=di(l);break;case"BYEASTER":t.byeaster=Number(l);break;default:throw new Error("Unknown RRULE property '"+o+"'")}}),t}function jv(s){if(s.indexOf(",")!==-1){var e=s.split(",");return e.map(co)}return co(s)}function co(s){return/^[+-]?\d+$/.test(s)?Number(s):s}function zv(s){var e=s.split(",");return e.map(function(t){if(t.length===2)return is[t];var r=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!r||r.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var n=Number(r[1]),a=r[2],o=is[a].weekday;return new Et(o,n)})}var Bn=function(){function s(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(s.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),s.prototype.toString=function(){var e=ui(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},s.prototype.getTime=function(){return this.date.getTime()},s.prototype.rezonedDate=function(){return this.isUTC?this.date:Ov(this.date,this.tzid)},s}();function qa(s){for(var e=[],t="",r=Object.keys(s),n=Object.keys(vi),a=0;a<r.length;a++)if(r[a]!=="tzid"&&Ye(n,r[a])){var o=r[a].toUpperCase(),l=s[r[a]],c="";if(!(!Ze(l)||Yt(l)&&!l.length)){switch(o){case"FREQ":c=pe.FREQUENCIES[s.freq];break;case"WKST":us(l)?c=new Et(l).toString():c=l.toString();break;case"BYWEEKDAY":o="BYDAY",c=Dv(l).map(function(p){return p instanceof Et?p:Yt(p)?new Et(p[0],p[1]):new Et(p)}).toString();break;case"DTSTART":t=Hv(l,s.tzid);break;case"UNTIL":c=ui(l,!s.tzid);break;default:if(Yt(l)){for(var u=[],h=0;h<l.length;h++)u[h]=String(l[h]);c=u.toString()}else c=String(l)}c&&e.push([o,c])}}var y=e.map(function(p){var w=p[0],m=p[1];return"".concat(w,"=").concat(m.toString())}).join(";"),v="";return y!==""&&(v="RRULE:".concat(y)),[t,v].filter(function(p){return!!p}).join(`
`)}function Hv(s,e){return s?"DTSTART"+new Bn(new Date(s),e).toString():""}function Kv(s,e){return Array.isArray(s)?!Array.isArray(e)||s.length!==e.length?!1:s.every(function(t,r){return t.getTime()===e[r].getTime()}):s instanceof Date?e instanceof Date&&s.getTime()===e.getTime():s===e}var Wv=function(){function s(){this.all=!1,this.before=[],this.after=[],this.between=[]}return s.prototype._cacheAdd=function(e,t,r){t&&(t=t instanceof Date?Ma(t):no(t)),e==="all"?this.all=t:(r._value=t,this[e].push(r))},s.prototype._cacheGet=function(e,t){var r=!1,n=t?Object.keys(t):[],a=function(h){for(var y=0;y<n.length;y++){var v=n[y];if(!Kv(t[v],h[v]))return!0}return!1},o=this[e];if(e==="all")r=this.all;else if(Yt(o))for(var l=0;l<o.length;l++){var c=o[l];if(!(n.length&&a(c))){r=c._value;break}}if(!r&&this.all){for(var u=new Mr(e,t),l=0;l<this.all.length&&u.accept(this.all[l]);l++);r=u.getValue(),this._cacheAdd(e,r,t)}return Yt(r)?no(r):r instanceof Date?Ma(r):r},s}(),Gv=$($($($($($($($($($($($($([],Ne(1,31),!0),Ne(2,28),!0),Ne(3,31),!0),Ne(4,30),!0),Ne(5,31),!0),Ne(6,30),!0),Ne(7,31),!0),Ne(8,31),!0),Ne(9,30),!0),Ne(10,31),!0),Ne(11,30),!0),Ne(12,31),!0),Ne(1,7),!0),Vv=$($($($($($($($($($($($($([],Ne(1,31),!0),Ne(2,29),!0),Ne(3,31),!0),Ne(4,30),!0),Ne(5,31),!0),Ne(6,30),!0),Ne(7,31),!0),Ne(8,31),!0),Ne(9,30),!0),Ne(10,31),!0),Ne(11,30),!0),Ne(12,31),!0),Ne(1,7),!0),Qv=_s(1,29),$v=_s(1,30),Vs=_s(1,31),bt=_s(1,32),Xv=$($($($($($($($($($($($($([],bt,!0),$v,!0),bt,!0),Vs,!0),bt,!0),Vs,!0),bt,!0),bt,!0),Vs,!0),bt,!0),Vs,!0),bt,!0),bt.slice(0,7),!0),Zv=$($($($($($($($($($($($($([],bt,!0),Qv,!0),bt,!0),Vs,!0),bt,!0),Vs,!0),bt,!0),bt,!0),Vs,!0),bt,!0),Vs,!0),bt,!0),bt.slice(0,7),!0),Jv=_s(-28,0),ep=_s(-29,0),Qs=_s(-30,0),kt=_s(-31,0),tp=$($($($($($($($($($($($($([],kt,!0),ep,!0),kt,!0),Qs,!0),kt,!0),Qs,!0),kt,!0),kt,!0),Qs,!0),kt,!0),Qs,!0),kt,!0),kt.slice(0,7),!0),sp=$($($($($($($($($($($($($([],kt,!0),Jv,!0),kt,!0),Qs,!0),kt,!0),Qs,!0),kt,!0),kt,!0),Qs,!0),kt,!0),Qs,!0),kt,!0),kt.slice(0,7),!0),rp=[0,31,60,91,121,152,182,213,244,274,305,335,366],np=[0,31,59,90,120,151,181,212,243,273,304,334,365],uo=function(){for(var s=[],e=0;e<55;e++)s=s.concat(_s(7));return s}();function ap(s,e){var t=br(s,1,1),r=on(s)?366:365,n=on(s+1)?366:365,a=Oa(t),o=Gr(t),l=zt(zt({yearlen:r,nextyearlen:n,yearordinal:a,yearweekday:o},ip(s)),{wnomask:null});if(ys(e.byweekno))return l;l.wnomask=Ne(0,r+7);var c,u,h=c=Zt(7-o+e.wkst,7);h>=4?(h=0,u=l.yearlen+Zt(o-e.wkst,7)):u=r-h;for(var y=Math.floor(u/7),v=Zt(u,7),p=Math.floor(y+v/4),w=0;w<e.byweekno.length;w++){var m=e.byweekno[w];if(m<0&&(m+=p+1),m>0&&m<=p){var g=void 0;m>1?(g=h+(m-1)*7,h!==c&&(g-=7-c)):g=h;for(var b=0;b<7&&(l.wnomask[g]=1,g++,l.wdaymask[g]!==e.wkst);b++);}}if(Ye(e.byweekno,1)){var g=h+p*7;if(h!==c&&(g-=7-c),g<r)for(var w=0;w<7&&(l.wnomask[g]=1,g+=1,l.wdaymask[g]!==e.wkst);w++);}if(h){var D=void 0;if(Ye(e.byweekno,-1))D=-1;else{var S=Gr(br(s-1,1,1)),x=Zt(7-S.valueOf()+e.wkst,7),F=on(s-1)?366:365,P=void 0;x>=4?(x=0,P=F+Zt(S-e.wkst,7)):P=r-h,D=Math.floor(52+Zt(P,7)/4)}if(Ye(e.byweekno,D))for(var g=0;g<h;g++)l.wnomask[g]=1}return l}function ip(s){var e=on(s)?366:365,t=br(s,1,1),r=Gr(t);return e===365?{mmask:Gv,mdaymask:Zv,nmdaymask:sp,wdaymask:uo.slice(r),mrange:np}:{mmask:Vv,mdaymask:Xv,nmdaymask:tp,wdaymask:uo.slice(r),mrange:rp}}function op(s,e,t,r,n,a){var o={lastyear:s,lastmonth:e,nwdaymask:[]},l=[];if(a.freq===pe.YEARLY)if(ys(a.bymonth))l=[[0,t]];else for(var c=0;c<a.bymonth.length;c++)e=a.bymonth[c],l.push(r.slice(e-1,e+1));else a.freq===pe.MONTHLY&&(l=[r.slice(e-1,e+1)]);if(ys(l))return o;o.nwdaymask=Ne(0,t);for(var c=0;c<l.length;c++)for(var u=l[c],h=u[0],y=u[1]-1,v=0;v<a.bynweekday.length;v++){var p=void 0,w=a.bynweekday[v],m=w[0],g=w[1];g<0?(p=y+(g+1)*7,p-=Zt(n[p]-m,7)):(p=h+(g-1)*7,p+=Zt(7-n[p]+m,7)),h<=p&&p<=y&&(o.nwdaymask[p]=1)}return o}function lp(s,e){e===void 0&&(e=0);var t=s%19,r=Math.floor(s/100),n=s%100,a=Math.floor(r/4),o=r%4,l=Math.floor((r+8)/25),c=Math.floor((r-l+1)/3),u=Math.floor(19*t+r-a-c+15)%30,h=Math.floor(n/4),y=n%4,v=Math.floor(32+2*o+2*h-u-y)%7,p=Math.floor((t+11*u+22*v)/451),w=Math.floor((u+v-7*p+114)/31),m=(u+v-7*p+114)%31+1,g=Date.UTC(s,w-1,m+e),b=Date.UTC(s,0,1);return[Math.ceil((g-b)/(1e3*60*60*24))]}var cp=function(){function s(e){this.options=e}return s.prototype.rebuild=function(e,t){var r=this.options;if(e!==this.lastyear&&(this.yearinfo=ap(e,r)),ot(r.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var n=this.yearinfo,a=n.yearlen,o=n.mrange,l=n.wdaymask;this.monthinfo=op(e,t,a,o,l,r)}Ze(r.byeaster)&&(this.eastermask=lp(e,r.byeaster))},Object.defineProperty(s.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),s.prototype.ydayset=function(){return[_s(this.yearlen),0,this.yearlen]},s.prototype.mdayset=function(e,t){for(var r=this.mrange[t-1],n=this.mrange[t],a=Ne(null,this.yearlen),o=r;o<n;o++)a[o]=o;return[a,r,n]},s.prototype.wdayset=function(e,t,r){for(var n=Ne(null,this.yearlen+7),a=Oa(br(e,t,r))-this.yearordinal,o=a,l=0;l<7&&(n[a]=a,++a,this.wdaymask[a]!==this.options.wkst);l++);return[n,o,a]},s.prototype.ddayset=function(e,t,r){var n=Ne(null,this.yearlen),a=Oa(br(e,t,r))-this.yearordinal;return n[a]=a,[n,a,a+1]},s.prototype.htimeset=function(e,t,r,n){var a=this,o=[];return this.options.byminute.forEach(function(l){o=o.concat(a.mtimeset(e,l,r,n))}),hn(o),o},s.prototype.mtimeset=function(e,t,r,n){var a=this.options.bysecond.map(function(o){return new Pn(e,t,o,n)});return hn(a),a},s.prototype.stimeset=function(e,t,r,n){return[new Pn(e,t,r,n)]},s.prototype.getdayset=function(e){switch(e){case Re.YEARLY:return this.ydayset.bind(this);case Re.MONTHLY:return this.mdayset.bind(this);case Re.WEEKLY:return this.wdayset.bind(this);case Re.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},s.prototype.gettimeset=function(e){switch(e){case Re.HOURLY:return this.htimeset.bind(this);case Re.MINUTELY:return this.mtimeset.bind(this);case Re.SECONDLY:return this.stimeset.bind(this)}},s}();function up(s,e,t,r,n,a){for(var o=[],l=0;l<s.length;l++){var c=void 0,u=void 0,h=s[l];h<0?(c=Math.floor(h/e.length),u=Zt(h,e.length)):(c=Math.floor((h-1)/e.length),u=Zt(h-1,e.length));for(var y=[],v=t;v<r;v++){var p=a[v];Ze(p)&&y.push(p)}var w=void 0;c<0?w=y.slice(c)[0]:w=y[c];var m=e[u],g=Nl(n.yearordinal+w),b=Rl(g,m);Ye(o,b)||o.push(b)}return hn(o),o}function Fl(s,e){var t=e.dtstart,r=e.freq,n=e.interval,a=e.until,o=e.bysetpos,l=e.count;if(l===0||n===0)return ws(s);var c=Pv.fromDate(t),u=new cp(e);u.rebuild(c.year,c.month);for(var h=fp(u,c,e);;){var y=u.getdayset(r)(c.year,c.month,c.day),v=y[0],p=y[1],w=y[2],m=hp(v,p,w,u,e);if(ot(o))for(var g=up(o,h,p,w,u,v),b=0;b<g.length;b++){var D=g[b];if(a&&D>a)return ws(s);if(D>=t){var S=ho(D,e);if(!s.accept(S)||l&&(--l,!l))return ws(s)}}else for(var b=p;b<w;b++){var x=v[b];if(Ze(x))for(var F=Nl(u.yearordinal+x),P=0;P<h.length;P++){var N=h[P],D=Rl(F,N);if(a&&D>a)return ws(s);if(D>=t){var S=ho(D,e);if(!s.accept(S)||l&&(--l,!l))return ws(s)}}}if(e.interval===0||(c.add(e,m),c.year>Il))return ws(s);fi(r)||(h=u.gettimeset(r)(c.hour,c.minute,c.second,0)),u.rebuild(c.year,c.month)}}function dp(s,e,t){var r=t.bymonth,n=t.byweekno,a=t.byweekday,o=t.byeaster,l=t.bymonthday,c=t.bynmonthday,u=t.byyearday;return ot(r)&&!Ye(r,s.mmask[e])||ot(n)&&!s.wnomask[e]||ot(a)&&!Ye(a,s.wdaymask[e])||ot(s.nwdaymask)&&!s.nwdaymask[e]||o!==null&&!Ye(s.eastermask,e)||(ot(l)||ot(c))&&!Ye(l,s.mdaymask[e])&&!Ye(c,s.nmdaymask[e])||ot(u)&&(e<s.yearlen&&!Ye(u,e+1)&&!Ye(u,-s.yearlen+e)||e>=s.yearlen&&!Ye(u,e+1-s.yearlen)&&!Ye(u,-s.nextyearlen+e-s.yearlen))}function ho(s,e){return new Bn(s,e.tzid).rezonedDate()}function ws(s){return s.getValue()}function hp(s,e,t,r,n){for(var a=!1,o=e;o<t;o++){var l=s[o];a=dp(r,l,n),a&&(s[l]=null)}return a}function fp(s,e,t){var r=t.freq,n=t.byhour,a=t.byminute,o=t.bysecond;return fi(r)?Bv(t):r>=pe.HOURLY&&ot(n)&&!Ye(n,e.hour)||r>=pe.MINUTELY&&ot(a)&&!Ye(a,e.minute)||r>=pe.SECONDLY&&ot(o)&&!Ye(o,e.second)?[]:s.gettimeset(r)(e.hour,e.minute,e.second,e.millisecond)}var is={MO:new Et(0),TU:new Et(1),WE:new Et(2),TH:new Et(3),FR:new Et(4),SA:new Et(5),SU:new Et(6)},vi={freq:Re.YEARLY,dtstart:null,interval:1,wkst:is.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},vp=Object.keys(vi),pe=function(){function s(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new Wv,this.origOptions=Ll(e);var r=Uv(e).parsedOptions;this.options=r}return s.parseText=function(e,t){return ql(e,t)},s.fromText=function(e,t){return qv(e,t)},s.fromString=function(e){return new s(s.parseString(e)||void 0)},s.prototype._iter=function(e){return Fl(e,this.options)},s.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},s.prototype._cacheAdd=function(e,t,r){if(this._cache)return this._cache._cacheAdd(e,t,r)},s.prototype.all=function(e){if(e)return this._iter(new io("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Mr("all",{})),this._cacheAdd("all",t)),t},s.prototype.between=function(e,t,r,n){if(r===void 0&&(r=!1),!tn(e)||!tn(t))throw new Error("Invalid date passed in to RRule.between");var a={before:t,after:e,inc:r};if(n)return this._iter(new io("between",a,n));var o=this._cacheGet("between",a);return o===!1&&(o=this._iter(new Mr("between",a)),this._cacheAdd("between",o,a)),o},s.prototype.before=function(e,t){if(t===void 0&&(t=!1),!tn(e))throw new Error("Invalid date passed in to RRule.before");var r={dt:e,inc:t},n=this._cacheGet("before",r);return n===!1&&(n=this._iter(new Mr("before",r)),this._cacheAdd("before",n,r)),n},s.prototype.after=function(e,t){if(t===void 0&&(t=!1),!tn(e))throw new Error("Invalid date passed in to RRule.after");var r={dt:e,inc:t},n=this._cacheGet("after",r);return n===!1&&(n=this._iter(new Mr("after",r)),this._cacheAdd("after",n,r)),n},s.prototype.count=function(){return this.all().length},s.prototype.toString=function(){return qa(this.origOptions)},s.prototype.toText=function(e,t,r){return Lv(this,e,t,r)},s.prototype.isFullyConvertibleToText=function(){return Fv(this)},s.prototype.clone=function(){return new s(this.origOptions)},s.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],s.YEARLY=Re.YEARLY,s.MONTHLY=Re.MONTHLY,s.WEEKLY=Re.WEEKLY,s.DAILY=Re.DAILY,s.HOURLY=Re.HOURLY,s.MINUTELY=Re.MINUTELY,s.SECONDLY=Re.SECONDLY,s.MO=is.MO,s.TU=is.TU,s.WE=is.WE,s.TH=is.TH,s.FR=is.FR,s.SA=is.SA,s.SU=is.SU,s.parseString=Ra,s.optionsToString=qa,s}();function pp(s,e,t,r,n,a){var o={},l=s.accept;function c(v,p){t.forEach(function(w){w.between(v,p,!0).forEach(function(m){o[Number(m)]=!0})})}n.forEach(function(v){var p=new Bn(v,a).rezonedDate();o[Number(p)]=!0}),s.accept=function(v){var p=Number(v);return isNaN(p)?l.call(this,v):!o[p]&&(c(new Date(p-1),new Date(p+1)),!o[p])?(o[p]=!0,l.call(this,v)):!0},s.method==="between"&&(c(s.args.after,s.args.before),s.accept=function(v){var p=Number(v);return o[p]?!0:(o[p]=!0,l.call(this,v))});for(var u=0;u<r.length;u++){var h=new Bn(r[u],a).rezonedDate();if(!s.accept(new Date(h.getTime())))break}e.forEach(function(v){Fl(s,v.options)});var y=s._result;switch(hn(y),s.method){case"all":case"between":return y;case"before":return y.length&&y[y.length-1]||null;case"after":default:return y.length&&y[0]||null}}var fo={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function yp(s,e){var t=[],r=[],n=[],a=[],o=Un(s),l=o.dtstart,c=o.tzid,u=kp(s,e.unfold);return u.forEach(function(h){var y;if(h){var v=bp(h),p=v.name,w=v.parms,m=v.value;switch(p.toUpperCase()){case"RRULE":if(w.length)throw new Error("unsupported RRULE parm: ".concat(w.join(",")));t.push(Ra(h));break;case"RDATE":var g=(y=/RDATE(?:;TZID=([^:=]+))?/i.exec(h))!==null&&y!==void 0?y:[],b=g[1];b&&!c&&(c=b),r=r.concat(vo(m,w));break;case"EXRULE":if(w.length)throw new Error("unsupported EXRULE parm: ".concat(w.join(",")));n.push(Ra(m));break;case"EXDATE":a=a.concat(vo(m,w));break;case"DTSTART":break;default:throw new Error("unsupported property: "+p)}}}),{dtstart:l,tzid:c,rrulevals:t,rdatevals:r,exrulevals:n,exdatevals:a}}function mp(s,e){var t=yp(s,e),r=t.rrulevals,n=t.rdatevals,a=t.exrulevals,o=t.exdatevals,l=t.dtstart,c=t.tzid,u=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||r.length>1||n.length||a.length||o.length){var h=new Tp(u);return h.dtstart(l),h.tzid(c||void 0),r.forEach(function(v){h.rrule(new pe(oa(v,l,c),u))}),n.forEach(function(v){h.rdate(v)}),a.forEach(function(v){h.exrule(new pe(oa(v,l,c),u))}),o.forEach(function(v){h.exdate(v)}),e.compatible&&e.dtstart&&h.rdate(l),h}var y=r[0]||{};return new pe(oa(y,y.dtstart||e.dtstart||l,y.tzid||e.tzid||c),u)}function La(s,e){return e===void 0&&(e={}),mp(s,gp(e))}function oa(s,e,t){return zt(zt({},s),{dtstart:e,tzid:t})}function gp(s){var e=[],t=Object.keys(s),r=Object.keys(fo);if(t.forEach(function(n){Ye(r,n)||e.push(n)}),e.length)throw new Error("Invalid options: "+e.join(", "));return zt(zt({},fo),s)}function _p(s){if(s.indexOf(":")===-1)return{name:"RRULE",value:s};var e=Ev(s,":",1),t=e[0],r=e[1];return{name:t,value:r}}function bp(s){var e=_p(s),t=e.name,r=e.value,n=t.split(";");if(!n)throw new Error("empty property name");return{name:n[0].toUpperCase(),parms:n.slice(1),value:r}}function kp(s,e){if(e===void 0&&(e=!1),s=s&&s.trim(),!s)throw new Error("Invalid empty string");if(!e)return s.split(/\s/);for(var t=s.split(`
`),r=0;r<t.length;){var n=t[r]=t[r].replace(/\s+$/g,"");n?r>0&&n[0]===" "?(t[r-1]+=n.slice(1),t.splice(r,1)):r+=1:t.splice(r,1)}return t}function wp(s){s.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function vo(s,e){return wp(e),s.split(",").map(function(t){return di(t)})}function po(s){var e=this;return function(t){if(t!==void 0&&(e["_".concat(s)]=t),e["_".concat(s)]!==void 0)return e["_".concat(s)];for(var r=0;r<e._rrule.length;r++){var n=e._rrule[r].origOptions[s];if(n)return n}}}var Tp=function(s){hi(e,s);function e(t){t===void 0&&(t=!1);var r=s.call(this,{},t)||this;return r.dtstart=po.apply(r,["dtstart"]),r.tzid=po.apply(r,["tzid"]),r._rrule=[],r._rdate=[],r._exrule=[],r._exdate=[],r}return e.prototype._iter=function(t){return pp(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){yo(t,this._rrule)},e.prototype.exrule=function(t){yo(t,this._exrule)},e.prototype.rdate=function(t){mo(t,this._rdate)},e.prototype.exdate=function(t){mo(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return La(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return La(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(qa({dtstart:this._dtstart}))),this._rrule.forEach(function(r){t=t.concat(r.toString().split(`
`))}),this._exrule.forEach(function(r){t=t.concat(r.toString().split(`
`).map(function(n){return n.replace(/^RRULE:/,"EXRULE:")}).filter(function(n){return!/^DTSTART/.test(n)}))}),this._rdate.length&&t.push(go("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(go("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(r){return t.rrule(r.clone())}),this._exrule.forEach(function(r){return t.exrule(r.clone())}),this._rdate.forEach(function(r){return t.rdate(new Date(r.getTime()))}),this._exdate.forEach(function(r){return t.exdate(new Date(r.getTime()))}),t},e}(pe);function yo(s,e){if(!(s instanceof pe))throw new TypeError(String(s)+" is not RRule instance");Ye(e.map(String),String(s))||e.push(s)}function mo(s,e){if(!(s instanceof Date))throw new TypeError(String(s)+" is not Date instance");Ye(e.map(Number),Number(s))||(e.push(s),hn(e))}function go(s,e,t){var r=!t||t.toUpperCase()==="UTC",n=r?"".concat(s,":"):"".concat(s,";TZID=").concat(t,":"),a=e.map(function(o){return ui(o.valueOf(),r)}).join(",");return"".concat(n).concat(a)}function Sp(){return Intl.DateTimeFormat().resolvedOptions().timeZone}class Dp{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const r of e)Number.isFinite(r)&&r>=0&&r<=6&&t.add(Math.floor(r));return Array.from(t).sort((r,n)=>r-n)}normalizeDayOfMonth(e,t){const r=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(r,1),31)}normalizeMonth(e,t){const r=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(r,0),11)}calculateNext(e,t,r){if(r!=null&&r.timezone||Sp(),t.rruleString)return this.calculateNextWithRRule(e,t,r);const a=((r==null?void 0:r.whenDone)??t.whenDone??!1)&&(r!=null&&r.completionDate)?r.completionDate:e,{type:o,time:l}=t,c=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(a,c);break;case"weekly":u=this.calculateNextWeekly(a,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(a,c,this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;case"yearly":u=this.calculateNextYearly(a,c,this.normalizeMonth(t.month,a.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(l){const{hours:h,minutes:y}=Sa(l);if(Number.isFinite(h)&&Number.isFinite(y)){const{date:v,shifted:p}=Qi(u,h,y);p&&Ke("DST shift detected while applying recurrence time",{requestedTime:l,original:u.toISOString(),adjusted:v.toISOString()}),u=v}}return u}calculateNextWithRRule(e,t,r){try{const a=((r==null?void 0:r.whenDone)??t.whenDone??!1)&&(r!=null&&r.completionDate)?r.completionDate:e,l=La(t.rruleString).after(a,!1);if(!l){Ke("RRule returned no next occurrence, falling back to legacy logic",{rruleString:t.rruleString,baseDate:a.toISOString()});const{rruleString:u,naturalLanguage:h,...y}=t;return this.calculateNext(a,y,r)}let c=l;if(t.time){const{hours:u,minutes:h}=Sa(t.time);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:y,shifted:v}=Qi(c,u,h);v&&Ke("DST shift detected while applying recurrence time",{requestedTime:t.time,original:c.toISOString(),adjusted:y.toISOString()}),c=y}}return c}catch(n){ge("Failed to parse rrule, falling back to legacy logic",{error:n instanceof Error?n.message:String(n),rruleString:t.rruleString});const{rruleString:a,naturalLanguage:o,...l}=t;return this.calculateNext(e,l,r)}}calculateNextDaily(e,t){return dn(e,t)}calculateNextWeekly(e,t,r){if(!r||r.length===0)return Vi(e,t);const n=this.getMondayIndex(e),a=Math.min(sa,t*14);for(let o=1;o<=a;o++){if(Math.floor((n+o)/7)%t!==0)continue;const c=dn(e,o),u=this.getMondayIndex(c);if(r.includes(u))return c}return Ke("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:r}),Vi(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,r){const n=r??e.getDate(),a=e.getFullYear(),l=e.getMonth()+t,c=a+Math.floor(l/12),u=(l%12+12)%12,h=new Date(c,u+1,0).getDate(),y=Math.min(n,h),v=new Date(e);return v.setFullYear(c,u,y),v}calculateNextYearly(e,t,r,n){const a=n??e.getDate(),o=e.getFullYear()+t,l=new Date(o,r+1,0).getDate(),c=Math.min(a,l),u=new Date(e);return u.setFullYear(o,r,c),u}getOccurrencesInRange(e,t,r,n){const a=[];let o=new Date(n),l=0;for(;o<=t&&l<sa;)o>=e&&a.push(new Date(o)),o=this.calculateNext(o,r),l++;return a}getMissedOccurrences(e,t,r,n){const a=[];let o=new Date(n),l=0;for(;o<=e&&l<sa;)o=this.calculateNext(o,r),l++;let c=0;for(;o<t&&c<In;)a.push(new Date(o)),o=this.calculateNext(o,r),c++;return c>=In&&Ke("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:r,firstOccurrence:n.toISOString(),cap:In}),a}}class Ep{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:r,minutes:n}=Sa(t);if(!Number.isFinite(r)||!Number.isFinite(n))return new Date(e);const a=new Date(e);return a.setHours(r,n,0,0),a}isSameLocalDay(e,t){const r=new Date(e),n=new Date(t);return r.getFullYear()===n.getFullYear()&&r.getMonth()===n.getMonth()&&r.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,r=e.getTime()-t.getTime(),n=Math.trunc(r/(1e3*60)),a=Math.trunc(r/(1e3*60*60)),o=Math.trunc(r/(1e3*60*60*24));return Math.abs(r)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(a)<24?a>0?`in ${a}h`:`${-a}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const r=new Date(e);return r.setDate(r.getDate()+t),r}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class xp{constructor(e){E(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return de(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return Ke(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return Ke("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),de(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return Ke("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(r){return ge("Failed to execute onCompletion action",{taskId:e.id,action:t,error:r}),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return Ke("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return ge("Failed to check for nested items",{blockId:e,error:t}),!0}}}class Ap{constructor(e,t){E(this,"intervalMs");E(this,"timeoutId",null);E(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:ni,r=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},r)}}class Cp{constructor(e,t=ni,r){E(this,"storage");E(this,"recurrenceEngine");E(this,"onCompletionHandler");E(this,"emittedDue",new Set);E(this,"emittedMissed",new Set);E(this,"timezoneHandler");E(this,"isChecking",!1);E(this,"lastCheckStartTime",0);E(this,"plugin",null);E(this,"listeners",{"task:due":new Set,"task:overdue":new Set});E(this,"MAX_EMITTED_ENTRIES",1e3);E(this,"EMITTED_RETENTION_DAYS",30);E(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);E(this,"persistTimeoutId",null);E(this,"emittedStateReady",null);E(this,"timer");this.storage=e,this.recurrenceEngine=new Dp,this.onCompletionHandler=new xp(r),this.timezoneHandler=new Ep,this.plugin=r||null,this.timer=new Ap(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),de("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),de("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Ke("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const r of t){if(!this.isActive(r))continue;const n=new Date(r.dueAt),a=n<=e;if(a){const l=this.buildOccurrenceKey(r.id,n,"hour");this.emittedDue.has(l)||(this.emitEvent("task:due",{taskId:r.id,dueAt:n,context:"today",task:r}),this.registerEmittedKey("due",l),de(`Task due: ${r.name}`,{taskId:r.id,dueAt:r.dueAt}))}const o=r.lastCompletedAt?new Date(r.lastCompletedAt):null;if(a&&e.getTime()-n.getTime()>=Cu&&(!o||o<n)){const l=this.buildOccurrenceKey(r.id,n,"hour");this.emittedMissed.has(l)||(this.emitEvent("task:overdue",{taskId:r.id,dueAt:n,context:"overdue",task:r}),this.registerEmittedKey("missed",l),Ke(`Task missed: ${r.name}`,{taskId:r.id,dueAt:r.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),r=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=r.set,(t.didTrim||r.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,r){const n=r.getTime(),a=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=a.filter(({time:u})=>u===null||u>=n),l=o.length!==a.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),l=!0);const c=new Set(o.map(({entry:u})=>u));return l&&de(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${c.size}`),{set:c,didTrim:l}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const r=e.slice(t+1);if(!r)return null;const n=r.length===13?`${r}:00:00.000Z`:r,a=new Date(n);return Number.isNaN(a.getTime())?null:a.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const r=new Date;t.doneAt=r.toISOString(),Uu(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const a=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,a);if(o.success||ge(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:a,error:o.error}),o.warnings)for(const u of o.warnings)Ke(u,{taskId:t.id});const l=new Date(t.dueAt),c=this.recurrenceEngine.calculateNext(l,t.frequency,{completionDate:r,whenDone:t.whenDone});t.dueAt=c.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),de(`Task "${t.name}" completed and rescheduled to ${c.toISOString()}`)}async delayTask(e,t){const r=this.storage.getTask(e);if(!r)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(r);const n=new Date(r.dueAt),a=new Date(n.getTime()+t*60*1e3);r.dueAt=a.toISOString(),r.snoozeCount=(r.snoozeCount||0)+1,await this.storage.saveTask(r),de(`Task "${r.name}" delayed by ${t} minutes to ${a.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const r=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(r.getHours(),r.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),de(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Tl(t);const r=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(r,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),de(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),de("First run detected, no recovery needed");return}de(`Recovering missed tasks since ${e.toISOString()}`);for(const r of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,r.frequency,new Date(r.createdAt));for(const a of n){const o=this.buildOccurrenceKey(r.id,a,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:r.id,dueAt:a,context:"overdue",task:r}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(r,t)}catch(n){ge(`Failed to recover task ${r.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),de("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const r=new Date(e.dueAt);if(r>=t)return;let n=r,a=0;for(;n<t&&a<In;)n=this.recurrenceEngine.calculateNext(n,e.frequency),a++;n>r&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),de(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Yi);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){ge("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Yi,{timestamp:e.toISOString()})}catch(t){ge("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const r=this.listeners[e];for(const n of r)try{const a=n(t);a instanceof Promise&&a.catch(o=>{ge(`Scheduler listener error for ${e}:`,o)})}catch(a){ge(`Scheduler listener error for ${e}:`,a)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Iu,r=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(r>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Li),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],r=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(r.slice(-this.MAX_EMITTED_ENTRIES)),de("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){ge("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Li,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){ge("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,r){return r==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const Ip=7,Op=2e3;class Mp{constructor(e,t){E(this,"plugin");E(this,"storageKey");E(this,"notifications",new Map);E(this,"escalations",new Map);E(this,"lastCleanup",new Date);E(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const r of t.notifications)this.notifications.set(r.taskKey,r);if(Array.isArray(t.escalations))for(const r of t.escalations)this.escalations.set(r.taskId,r);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),de(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){ge("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Dl("Saved notification state")}catch(e){ge("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>Op&&Array.from(this.notifications.keys()).slice(0,100).forEach(r=>this.notifications.delete(r))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const r=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:r,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,r}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const r=new Date(t);return`${e}:${r.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const r=new Date(e.getTime()-Ip*24*60*60*1e3);let n=0;for(const[a,o]of this.notifications.entries())new Date(o.notifiedAt)<r&&(this.notifications.delete(a),n++);n>0&&(de(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function Np(s){return{id:s.id,name:s.name,dueAt:s.dueAt,frequency:s.frequency,linkedBlockId:s.linkedBlockId,linkedBlockContent:s.linkedBlockContent,priority:s.priority,tags:s.tags,notificationChannels:s.notificationChannels,completionCount:s.completionCount,missCount:s.missCount,currentStreak:s.currentStreak,bestStreak:s.bestStreak}}const Rp=30*1e3,qp=30*60*1e3,tr=500;class Lp{constructor(e,t={}){E(this,"plugin");E(this,"config");E(this,"queue",[]);E(this,"dedupeKeys",new Set);E(this,"flushIntervalId",null);E(this,"fetcher");E(this,"notificationState");E(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...Ta},this.notificationState=t.notificationState??new Mp(this.plugin,Eu)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(Ri);e&&(this.config={...Ta,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(Ri,e)}async loadQueue(){try{const e=await this.plugin.loadData(qi);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>tr){const r=this.queue.length-tr;this.queue=this.queue.slice(-tr),console.warn(`Event queue trimmed to ${tr} entries (dropped ${r}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-ta);await this.plugin.saveData(qi,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Au))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const r=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,r),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const r=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,r),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,r=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const a=this.buildPayload(e,t,n,1,r);await this.sendPayload(a)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(a)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:Fi,version:Pi,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},r=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return r.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${r.status}: ${r.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const r=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){r.push(n);continue}const a={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(a))this.markDelivered(a.delivery.dedupeKey),t=!0;else{const l=n.attempt+1,c=this.getRetryDelay(l);r.push({...n,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}t&&(this.queue=r,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,r,n,a=0){const o=new Date,l=new Date(t.dueAt),c=o.getTime()-l.getTime();return{event:e,source:Fi,version:Pi,occurredAt:o.toISOString(),task:Np(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:c>0?c:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:a,channels:t.notificationChannels||[]},delivery:{dedupeKey:r,attempt:n}}}buildDedupeKey(e,t){const r=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${r}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>ta){const t=Array.from(this.dedupeKeys).slice(-ta);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=tr){const r=this.queue.length-tr+1;this.queue.splice(0,r),console.warn(`Event queue capped at ${tr}. Dropped ${r} oldest entr${r===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=Rp*Math.pow(2,e-1);return Math.min(t,qp)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const r=new TextEncoder,n=r.encode(t),a=r.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),l=await crypto.subtle.sign("HMAC",o,a);return Array.from(new Uint8Array(l)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(r){return console.error("Failed to generate signature:",r),""}}async buildHeaders(e){const t=JSON.stringify(e),r=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+r,this.config.n8n.sharedSecret));const a={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":r};return n&&(a["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(a["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),a}async sendPayload(e,t=!1){try{const r=JSON.stringify(e),n=await this.buildHeaders(e),a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:r});if(!a.ok)return console.error("n8n webhook failed:",a.statusText),!1;if(t){const o=await a.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(r){return console.error("Failed to send n8n event:",r),!1}}}const sr={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:{enabled:!1,mode:"include",tagPattern:void 0,pathPattern:void 0,regex:void 0},urgency:ai};function _o(s){return{dates:{...sr.dates,...s.dates},recurrence:{...sr.recurrence,...s.recurrence},dependencies:{...sr.dependencies,...s.dependencies},filenameDate:{...sr.filenameDate,...s.filenameDate},globalFilter:{...sr.globalFilter,...s.globalFilter},urgency:{...sr.urgency,...s.urgency}}}const la="plugin-settings";class Fp{constructor(e){E(this,"plugin");E(this,"settings");this.plugin=e,this.settings=sr}async load(){try{const e=await this.plugin.loadData(la);e&&typeof e=="object"&&(this.settings=_o(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(la,e)}get(){return this.settings}async update(e){this.settings=_o(e),await this.plugin.saveData(la,this.settings)}}const zs=class zs{constructor(e){E(this,"plugin");E(this,"isInitialized",!1);E(this,"storage");E(this,"repository");E(this,"scheduler");E(this,"eventService");E(this,"settingsService");this.plugin=e}static getInstance(e){if(!zs.instance){if(!e)return null;zs.instance=new zs(e)}return zs.instance}async initialize(){if(this.isInitialized){Ke("TaskManager already initialized");return}de("Initializing TaskManager"),this.settingsService=new Fp(this.plugin),await this.settingsService.load(),this.storage=new Tv(this.plugin),await this.storage.init(),this.repository=new Sv(this.storage),this.eventService=new Lp(this.plugin),await this.eventService.init(),this.scheduler=new Cp(this.storage,ni,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,de("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:r})=>e(r)),t&&this.scheduler.on("task:overdue",({task:r})=>t(r)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),de("TaskManager started")}async destroy(){de("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,zs.instance=null,de("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};E(zs,"instance",null);let Yn=zs;function Pp(s){let t=`- [${s.status==="done"?"x":" "}] ${s.name}`;if(s.dueAt){const r=new Date(s.dueAt);t+=` 📅 ${r.toISOString().split("T")[0]}`}return s.frequency&&(t+=` 🔁 every ${s.frequency.interval} ${s.frequency.type}${s.frequency.interval>1?"s":""}`),t}class Up{constructor(e,t,r,n){this.storage=e,this.recurrenceEngine=t,this.settings=r,this.siyuanApi=n}async onComplete(e,t){try{const r=[],n=this.addCompletionDate(e,t);let a;return e.frequency&&(a=await this.generateNextInstance(n,t),a&&(await this.placeNextInstance(n,a)||r.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(a))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(Ke("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(n),r.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(n),{success:!0,nextTask:a,warnings:r.length>0?r:void 0}}catch(r){return ge("Failed to handle task completion",{taskId:e.id,error:r}),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}addCompletionDate(e,t){const r={...e},n=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(r.doneAt=n,r.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(r.cancelledAt=n,r.doneAt=void 0),r}async generateNextInstance(e,t){if(e.frequency)try{const r=new Date(e.dueAt),n=this.recurrenceEngine.calculateNext(r,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),a=wl(e,{dueAt:n.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(a.scheduledAt=void 0),a}catch(r){ge("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:r});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return Ke("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return Ke("SiYuan API not available, cannot place next instance"),!1;const r=this.settings.recurrence.newTaskPosition,n=Pp(t);try{let a;return r==="above"&&this.siyuanApi.insertBlockAbove?a=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,n):r==="below"&&this.siyuanApi.insertBlockBelow&&(a=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,n)),a!=null&&a.id?(t.linkedBlockId=a.id,t.linkedBlockContent=n,!0):!1}catch(a){return ge("Failed to place next instance in document",{taskId:e.id,placement:r,error:a}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const r=await this.siyuanApi.getChildBlocks({id:e});return r&&r.length>0}catch(r){return ge("Failed to check for nested items",{blockId:e,error:r}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),de("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(r){ge("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:r})}else de("Task deleted from storage only (no linked block)",{taskId:e.id})}}class Bp{constructor(e,t,r,n){E(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=r,this.siyuanApi=n,t&&r&&(this.completionHandler=new Up(e,t,r(),n))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,r;try{const n=this.repository.getTask(e);if(!n){G.error("Task not found");return}const a=gs.getInstance(),o=n.statusSymbol||" ",l=a.getNextSymbol(o),c={...n,statusSymbol:l},u=a.getStatus(l);if(u.type==="DONE"){if(c.status="done",n.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(c,new Date);h.success?(h.nextTask?(de("Next recurrence created",{taskId:c.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),G.success("Task completed - next occurrence scheduled")):G.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(y=>G.warning(y))):G.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!c.doneAt&&(c.doneAt=new Date().toISOString()),await this.repository.saveTask(c),G.success(`Task status updated to ${u.name}`);Qe.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(c.status="cancelled",(r=this.settings)!=null&&r.dates.autoAddCancelled&&!c.cancelledAt&&(c.cancelledAt=new Date().toISOString()),await this.repository.saveTask(c),Qe.emit("task:updated",{taskId:e}),G.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(c.status="todo",await this.repository.saveTask(c),Qe.emit("task:updated",{taskId:e}),G.success(`Task status updated to ${u.name}`))}catch(n){ge("Failed to toggle task status",n),G.error("Failed to toggle status")}}async completeTask(e){var t;try{const r=this.repository.getTask(e);if(!r){G.error("Task not found");return}const n={...r,status:"done"};if(r.frequency&&this.completionHandler){const a=await this.completionHandler.onComplete(n,new Date);a.success?(a.nextTask?(de("Next recurrence created",{taskId:n.id,nextTaskId:a.nextTask.id,nextDue:a.nextTask.dueAt}),G.success(`Task "${r.name}" completed - next occurrence scheduled`)):G.success(`Task "${r.name}" completed`),a.warnings&&a.warnings.forEach(o=>G.warning(o))):G.error(`Failed to complete task: ${a.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),G.success(`Task "${r.name}" completed`);Qe.emit("task:complete",{taskId:e})}catch(r){ge("Failed to complete task",r),G.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){G.error("Task not found");return}const n=this.repository.getAllTasks().filter(a=>{var o,l;return((o=a.blockedBy)==null?void 0:o.includes(e))||((l=a.dependsOn)==null?void 0:l.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),Qe.emit("task:deleted",{taskId:e}),G.success(`Task "${t.name}" deleted`)}catch(t){ge("Failed to delete task",t),G.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){G.error("Task not found");return}const r=new Date;r.setHours(12,0,0,0);const n={...t,scheduledAt:r.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),Qe.emit("task:updated",{taskId:e}),G.success("Task rescheduled to today")}catch(t){ge("Failed to reschedule task",t),G.error("Failed to reschedule task")}}async deferTask(e,t){try{const r=this.repository.getTask(e);if(!r){G.error("Task not found");return}const n={...r,updatedAt:new Date().toISOString()};if(r.dueAt){const a=new Date(r.dueAt);a.setDate(a.getDate()+t),n.dueAt=a.toISOString()}if(r.scheduledAt){const a=new Date(r.scheduledAt);a.setDate(a.getDate()+t),n.scheduledAt=a.toISOString()}await this.repository.saveTask(n),Qe.emit("task:updated",{taskId:e}),G.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(r){ge("Failed to defer task",r),G.error("Failed to defer task")}}}class Yp{constructor(e,t,r){E(this,"plugin");E(this,"storageKey");E(this,"settings");E(this,"defaults");this.plugin=e,this.storageKey=t,this.defaults={...r},this.settings={...r}}async load(){try{const e=await this.plugin.loadData(this.storageKey);e&&(this.settings={...this.defaults,...e})}catch(e){console.error(`Failed to load settings from ${this.storageKey}:`,e),this.settings={...this.defaults}}return this.settings}async save(e){e&&(this.settings=e);try{await this.plugin.saveData(this.storageKey,this.settings)}catch(t){throw console.error(`Failed to save settings to ${this.storageKey}:`,t),t}}get(){return{...this.settings}}async set(e,t){this.settings[e]=t,await this.save()}async reset(){this.settings={...this.defaults},await this.save()}has(e){return e in this.settings}getValue(e){return this.settings[e]}}const Ir=[{id:"quickAddTask",langKey:"quickAddTask",label:"Quick add recurring task",description:"Open the quick add dialog with focus on the task title.",defaultHotkey:"Ctrl+Shift+T",context:"Global / Editor"},{id:"markTaskDone",langKey:"markTaskDone",label:"Mark task as done",description:"Complete the focused task and trigger recurrence.",defaultHotkey:"Ctrl+Enter",context:"Task focus / Task block"},{id:"postponeTask",langKey:"postponeTask",label:"Postpone task",description:"Open the snooze selector for the focused task.",defaultHotkey:"Ctrl+Shift+P",context:"Task focus"},{id:"openRecurringTasksDock",langKey:"openRecurringTasksDock",label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",defaultHotkey:"Ctrl+Shift+O",context:"Global"},{id:"createRecurringTask",langKey:"createRecurringTask",label:"Create recurring task from selection",description:"Create a recurring task based on the current editor block.",defaultHotkey:"Ctrl+Shift+R",context:"Editor"},{id:"quickCompleteNextTask",langKey:"quickCompleteNextTask",label:"Quick complete next task",description:"Marks the most overdue task as complete.",defaultHotkey:"Ctrl+Shift+D",context:"Global"},{id:"toggleTaskStatus",langKey:"toggleTaskStatus",label:"Toggle task status",description:"Cycle the status of the focused task.",defaultHotkey:"Ctrl+Shift+X",context:"Task focus"},{id:"openTaskEditor",langKey:"openTaskEditor",label:"Open task editor",description:"Open the full task editor modal.",defaultHotkey:"Ctrl+Shift+E",context:"Global"}],ca=Ir.reduce((s,e)=>(s[e.id]=e.defaultHotkey,s),{});function Fa(s,e){Qe.emit("task:snooze",{taskId:s,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:e}})),de(`Snoozing task ${s} for ${e} minutes`)}function jp(s){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const r=Ea(t),n=Math.max(0,Math.floor((r.getTime()-e.getTime())/(60*1e3)));Qe.emit("task:snooze",{taskId:s,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:n}})),de(`Snoozing task ${s} to tomorrow`)}function zp(s){s.eventBus.on("click-blockicon",({detail:e})=>{var o,l,c;const t=e.blockElements;if(!t||t.length===0)return;const r=t[0],n=r==null?void 0:r.getAttribute("data-node-id");if(!n)return;const a=(r==null?void 0:r.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=s.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Qe.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Pa(a),suggestedTime:Ua(a)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Pa(a),suggestedTime:Ua(a)}}))}});try{const u=Yn.getInstance();if(u&&u.isReady()){const y=u.getRepository().getTaskByBlockId(n);if(y){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((l=s.i18n)==null?void 0:l.completeTask)||"Complete Task",click:()=>{Qe.emit("task:complete",{taskId:y.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:y.id}}))}});const v=[{label:"15 minutes",click:()=>Fa(y.id,15)},{label:"1 hour",click:()=>Fa(y.id,60)},{label:"Tomorrow",click:()=>jp(y.id)}];e.menu.addItem({icon:"iconClock",label:((c=s.i18n)==null?void 0:c.snoozeTask)||"Snooze Task",submenu:v})}}}catch{Dl("TaskManager not available for quick actions")}}),de("Registered block context menu")}function Pa(s){const e=s.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function Ua(s){var r;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=s.match(e);if(t){let n=parseInt(t[1],10);const a=t[2],o=(r=t[3])==null?void 0:r.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${a}`}return null}const Hp="recurring-task-shortcuts",Kp=350;class Wp{constructor(e,t,r,n,a){E(this,"settingsStore");E(this,"settings",{...ca});E(this,"taskCommands");E(this,"cooldownTimers",new Map);this.plugin=e,this.repository=t,this.handlers=a,this.settingsStore=new Yp(e,Hp,ca),this.taskCommands=new Bp(t,r,n,void 0)}async initialize(){this.settings=await this.settingsStore.load()}registerShortcuts(){Ir.forEach(e=>{const t=this.settings[e.id]||e.defaultHotkey;this.plugin.addCommand({langKey:e.langKey,hotkey:t,callback:()=>{this.handleShortcut(e.id)}})}),de("Registered shortcut commands",{shortcuts:Ir.map(e=>({id:e.id,hotkey:this.settings[e.id]}))})}getShortcutDisplay(){return Ir.map(e=>({id:e.id,label:e.label,description:e.description,context:e.context,currentHotkey:this.settings[e.id]||"",defaultHotkey:e.defaultHotkey}))}async updateShortcut(e,t){const r=t.trim(),n=this.findDuplicateHotkey(e,r);return n?{success:!1,message:`Hotkey already assigned to "${n.label}".`}:(this.settings={...this.settings,[e]:r},await this.settingsStore.save(this.settings),this.registerShortcuts(),{success:!0})}async resetShortcut(e){const t=this.getDefinition(e);t&&(this.settings={...this.settings,[e]:t.defaultHotkey},await this.settingsStore.save(this.settings),this.registerShortcuts())}async resetAllShortcuts(){this.settings={...ca},await this.settingsStore.save(this.settings),this.registerShortcuts()}destroy(){this.cooldownTimers.forEach(e=>globalThis.clearTimeout(e)),this.cooldownTimers.clear()}async handleShortcut(e){if(!this.shouldIgnoreShortcut(e))switch(e){case"quickAddTask":this.guardCooldown(e,Kp,()=>{this.handlers.createTask(this.buildCreatePayload("shortcut"))});break;case"createRecurringTask":this.handlers.createTask(this.buildCreatePayload("shortcut"));break;case"openRecurringTasksDock":this.handlers.openDock();break;case"markTaskDone":{const t=this.resolveTaskId();if(!t)return;await this.handlers.completeTask(t);break}case"postponeTask":{const t=this.resolveTaskId();if(!t)return;this.handlers.postponeTask(t);break}case"quickCompleteNextTask":await this.quickCompleteNextTask();break;case"toggleTaskStatus":{const t=this.resolveTaskId();if(!t)return;await this.taskCommands.toggleStatus(t);break}case"openTaskEditor":this.handlers.openTaskEditor();break}}guardCooldown(e,t,r){if(this.cooldownTimers.has(e))return;r();const n=globalThis.setTimeout(()=>{this.cooldownTimers.delete(e)},t);this.cooldownTimers.set(e,n)}shouldIgnoreShortcut(e){const t=document.activeElement;if(!t)return!1;const r=t.tagName.toLowerCase();return["input","textarea","select"].includes(r)?!0:t.isContentEditable?!this.isEditorAllowedShortcut(e):!1}isEditorAllowedShortcut(e){return e==="quickAddTask"||e==="createRecurringTask"}resolveTaskId(){const e=this.getFocusedTaskId();if(e)return e;const t=this.getSelectedBlockContext();if(!t)return null;const r=this.repository.getTaskByBlockId(t.blockId);return(r==null?void 0:r.id)??null}getFocusedTaskId(){const e=document.activeElement;if(!e)return null;const t=e.closest("[data-task-id]");return(t==null?void 0:t.dataset.taskId)??null}getSelectedBlockContext(){const e=window.getSelection(),t=e==null?void 0:e.anchorNode;if(!t)return null;const r=t instanceof HTMLElement?t:t.parentElement;if(!r)return null;const n=r.closest("[data-node-id]");if(!n)return null;const a=n.getAttribute("data-node-id");return a?{blockId:a,blockContent:n.textContent||""}:null}buildCreatePayload(e){const t=this.getSelectedBlockContext();return t?{source:e,linkedBlockId:t.blockId,linkedBlockContent:t.blockContent,suggestedName:Pa(t.blockContent),suggestedTime:Ua(t.blockContent)}:{source:e}}async quickCompleteNextTask(){try{const e=this.repository.getTodayAndOverdueTasks();if(e.length===0)return;const t=e[0];await this.taskCommands.completeTask(t.id)}catch(e){ge("Failed to quick complete task",e),G.error("Failed to complete task")}}getDefinition(e){return Ir.find(t=>t.id===e)}findDuplicateHotkey(e,t){if(!t)return null;const r=t.toLowerCase(),n=Ir.find(a=>a.id===e?!1:(this.settings[a.id]||"").toLowerCase()===r);return n?{id:n.id,label:n.label,description:n.description,context:n.context,currentHotkey:this.settings[n.id],defaultHotkey:n.defaultHotkey}:null}}async function Gp(s,e,t,r,n){const a=new Wp(s,e,r,n,t);return await a.initialize(),a.registerShortcuts(),a}class Vp{constructor(e,t){E(this,"plugin");E(this,"repository");E(this,"topbarElement",null);E(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),de("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),de("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(r=>{const n=new Date(r.dueAt);return n<new Date&&!ci(n)}).length;if(e.length>0){const r=this.topbarElement.querySelector(".b3-badge");if(r)r.textContent=e.length.toString(),r.style.display="block",t>0?r.style.backgroundColor="var(--b3-theme-error)":r.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const r=this.topbarElement.querySelector(".b3-badge");r&&r.remove()}}toggleMenu(){Qe.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Qp extends Ya.Plugin{constructor(){super(...arguments);E(this,"taskManager");E(this,"repository");E(this,"scheduler");E(this,"eventService");E(this,"migrationManager");E(this,"topbarMenu");E(this,"settingsService");E(this,"dashboardComponent",null);E(this,"dockEl");E(this,"quickAddComponent",null);E(this,"quickAddContainer",null);E(this,"taskEditorComponent",null);E(this,"taskEditorContainer",null);E(this,"postponeComponent",null);E(this,"postponeContainer",null);E(this,"pendingCompletionTimeouts",new Map);E(this,"shortcutManager",null);E(this,"handleCreateTaskEvent",t=>{try{const r=t;de("Create task event received",r.detail),this.openQuickAdd(r.detail)}catch(r){ge("Failed to handle create task event",r),G.error("Failed to open task creator.")}});E(this,"handleSettingsEvent",t=>{try{de("Settings event received",t.detail),this.openDock()}catch(r){ge("Failed to handle settings event",r),G.error("Failed to open settings.")}});E(this,"handleCompleteTaskEvent",async t=>{try{const r=t,{taskId:n}=r.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(r){ge("Failed to complete task",r),G.error("Failed to complete task.")}});E(this,"handleSnoozeTaskEvent",async t=>{try{const r=t,{taskId:n,minutes:a}=r.detail??{};if(!n||typeof a!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,a)}catch(r){ge("Failed to snooze task",r),G.error("Failed to snooze task.")}})}async onload(){de("Loading Recurring Tasks Plugin"),this.migrationManager=new yv(this);try{await this.migrationManager.migrate(ir)}catch(n){ge("Migration failed, continuing with existing data",n)}const t=Yn.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const r=this.taskManager.getSettingsService();this.settingsService=r;try{await this.taskManager.start()}catch(n){ge("Failed to start TaskManager",n)}this.shortcutManager=await Gp(this,this.repository,{createTask:n=>this.dispatchCreateTask(n),completeTask:n=>Qe.emit("task:complete",{taskId:n}),postponeTask:n=>this.openPostponePicker(n),openDock:()=>this.openDock(),openTaskEditor:()=>this.openTaskEditor()},this.scheduler.getRecurrenceEngine(),()=>r.get()),zp(this),this.topbarMenu=new Vp(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:xu,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),de("Recurring Tasks Plugin loaded successfully")}async onunload(){de("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.closePostponePicker(),this.removeEventListeners(),this.shortcutManager&&(this.shortcutManager.destroy(),this.shortcutManager=null)}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=Tn(iv,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService,shortcutManager:this.shortcutManager,settingsService:this.settingsService}}))}destroyDashboard(){this.dashboardComponent&&(Sn(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Qe.on("task:create",t=>{de("Create task event received",t),this.openQuickAdd(t)}),Qe.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Qe.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Qe.on("task:settings",()=>{this.openDock()}),Qe.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){ge("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Qe.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const r=this.repository.getTask(t);if(r){if(this.pendingCompletionTimeouts.has(t)){G.info(`Completion already pending for "${r.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(r),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),de(`Task completed: ${r.name}`)}catch(o){ge("Failed to finalize task completion",o),G.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const a=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),G.info(`Undo: "${r.name}" restored`))};or({message:`Task "${r.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:a,showCountdown:!0})}}async handleSnoozeTask(t,r){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,r),this.topbarMenu&&this.topbarMenu.update(),de(`Task snoozed: ${n.name} for ${r} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=Tn(hv,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}openPostponePicker(t){const r=this.repository.getTask(t);if(!r){G.error("Task not found");return}this.postponeComponent&&this.closePostponePicker(),this.postponeContainer=document.createElement("div"),document.body.appendChild(this.postponeContainer),this.postponeComponent=Tn(pv,{target:this.postponeContainer,props:{taskName:r.name,onClose:()=>this.closePostponePicker(),onSelect:n=>{Fa(t,n),this.closePostponePicker()}}})}closePostponePicker(){this.postponeComponent&&(Sn(this.postponeComponent),this.postponeComponent=null),this.postponeContainer&&(this.postponeContainer.remove(),this.postponeContainer=null)}dispatchCreateTask(t){Qe.emit("task:create",t),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:t}))}closeQuickAdd(){this.quickAddComponent&&(Sn(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=Tn(El,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(Sn(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=Qp;
